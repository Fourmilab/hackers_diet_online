\newcommand{\NWtarget}[2]{#2}
\newcommand{\NWlink}[2]{#2}
\newcommand{\NWtxtMacroDefBy}{Fragment defined by}
\newcommand{\NWtxtMacroRefIn}{Fragment referenced in}
\newcommand{\NWtxtMacroNoRef}{Fragment never referenced}
\newcommand{\NWtxtDefBy}{Defined by}
\newcommand{\NWtxtRefIn}{Referenced in}
\newcommand{\NWtxtNoRef}{Not referenced}
\newcommand{\NWtxtFileDefBy}{File defined by}
\newcommand{\NWtxtIdentsUsed}{Uses:}
\newcommand{\NWtxtIdentsNotUsed}{Never used}
\newcommand{\NWtxtIdentsDefed}{Defines:}
\newcommand{\NWsep}{${\diamond}$}
\newcommand{\NWnotglobal}{(not defined globally)}
\newcommand{\NWuseHyperlinks}{}
\documentclass{report}

%    ****** TURN OFF HARDWARE TABS BEFORE EDITING THIS DOCUMENT ******
%
%   Should you ignore this admonition, tabs in the program code will
%   not be respected in the LaTeX-generated program document.
%   If that should occur, simply pass this file through
%   expand to replace the tabs with sequences of spaces.

%\usepackage{html}

%   This program is written using the Nuweb Literate Programming
%   tool:
%
%           http://sourceforge.net/projects/nuweb/
%
%   For information about Literate Programming, please visit the
%   site:   http://www.literateprogramming.com/

\setlength{\oddsidemargin}{0in}
\setlength{\evensidemargin}{0in}
\setlength{\topmargin}{0in}
\addtolength{\topmargin}{-\headheight}
\addtolength{\topmargin}{-\headsep}
\setlength{\textheight}{8.9in}
\setlength{\textwidth}{6.5in}
\setlength{\marginparwidth}{0.5in}
\setcounter{tocdepth}{6}
\setcounter{secnumdepth}{6}
\def\UNIX/{{\sc UNIX}}
\newcommand{\dense}{\setlength{\itemsep}{-1ex}}

\usepackage[unicode=true,pdftitle={The Hacker's Diet Online},pdfauthor={John Walker},colorlinks=true,linkcolor=blue,urlcolor=blue]{hyperref}

\title{{\bf The Hacker's Diet {\em Online}} \\
{\em Web-Based Computer Tools}}
\date{August 2007}
\author{by
\href{http://www.fourmilab.ch/}{
John Walker
}
}

\begin{document}

\pagenumbering{roman}
\maketitle
\tableofcontents

\chapter{Introduction}
\pagenumbering{arabic}

\href{http://www.fourmilab.ch/hackdiet/online/}{
{\bf The Hacker's Diet {\em Online}}
}
is an interactive Web application
implemented as a Common Gateway Interface (CGI) application in Perl.
Interactivity is enhanced by a JavaScript component which provides
error-checking and real-time data entry feedback, but JavaScript is
not required to use the application.  The program is 100\%
``Unicode clean''---any Unicode character may be used in any
text field.

No back-end database is required.  All user data are stored in the
Unix file system in flat ASCII files.  Charts are generated
directly from Perl using the {\tt GD} module.

This program is in the public domain.  It may be used by any
person in any manner without any restrictions whatsoever.

\section{Development Environment}

This program was developed using the
\href{http://www.literateprogramming.com/}{
Literate Programming
}
methodology with the
\href{http://sourceforge.net/projects/nuweb/}{
Nuweb
}
programming tool.  To build this program, you will need to
download and install that utility on your system.

The server-side application requires a recent version of Perl with
full Unicode support; this version has been developed and tested on
Perl 5.8.5.

The program build process is automated using GNU/Linux
{\tt make}, using a {\tt Makefile} defined within this program.

To view the documentation, you will need a \LaTeX\ system
with the {\tt xdvi} utility.  To update the PDF documentation,
you must also have the {\tt pdftex} system; most modern
\TeX\ distributions, such as
\href{http://www.tug.org/texlive/}{
\TeX\ Live,
}
include these components.

The latest version of this program is always available
from:
\begin{center}
\href{http://www.fourmilab.ch/hackdiet/online/}{
{\tt http://www.fourmilab.ch/hackdiet/online/}
}
\end{center}

\vbox{
\section{Application Module Structure}

In addition to the {\tt HackDiet.pl} main application, the following
modules are defined in this program.  All are kept in a {\tt HDiet}
subdirectory, along with other material needed by the application

\begin{quote}
\begin{tabular}{lp{40em}}
     {\tt Aggregator} & Cross-account data aggregation (Chapter \ref{Aggregator.pm}). \\
     {\tt Cluster} &   Cluster file system support (Chapter \ref{Cluster.pm}). \\
     {\tt cookie} &    Utilities for managing persistent
                            logins (Chapter \ref{cookie.pm}).\\
     {\tt hdCSV} &     Utilities for encoding and parsing our
                            Unicode-extended CSV files (Chapter \ref{hdCSV.pm}).\\
     {\tt history} &   Generation of historical charts and trend
                            analyses (Chapter \ref{history.pm}).\\
     {\tt html} &      Facilities for generating XHTML files
                            (Chapter \ref{html.pm}).\\
     {\tt Julian} &    Julian date utilities
                            (Chapter \ref{Julian.pm}).\\
     {\tt monthlog} &  Monthly log object: represents one month's
                            log for a user (Chapter \ref{monthlog.pm}).\\
     {\tt pubname} &   Object which manages the pseudonyms assigned
                            to users who grant public access to
                            their records (Chapter \ref{pubname.pm}).\\
     {\tt session} &   Session object: represents an open session
                            by a user (Chapter \ref{session.pm}).\\
     {\tt trendfit} &  Object which manages the fitting of linear
                            trends to data (Chapter \ref{trendfit.pm}).\\
     {\tt user} &      User object: represents the account and settings
                            for a user account (Chapter \ref{user.pm}).\\
     {\tt xml} &       Utilities for generating and parsing XML files
                            (Chapter \ref{xml.pm}).\\
\end{tabular}
\end{quote}
}

\section{Perl Library Module Requirements}

The following Perl modules are required by this program.  If
they are not present in the Perl configuration on your server,
you can download and install them from
\href{http://www.cpan.org/}{
CPAN.
}

\begin{itemize}
     \dense
     \item{
\href{http://search.cpan.org/~lds/Crypt-CBC-2.22/CBC.pm}{
        {\tt Crypt::CBC}
}
    }
     \item{
\href{http://search.cpan.org/~ttar/Crypt-OpenSSL-AES-0.01/lib/Crypt/OpenSSL/AES.pm}{
        {\tt Crypt::OpenSSL::AES}
}
    }
     \item{
\href{http://search.cpan.org/~ilyam/Data-Dumper-2.121/Dumper.pm}{
        {\tt Data::Dumper}
}
    }
     \item{
\href{http://search.cpan.org/~gaas/Digest-SHA1-2.11/SHA1.pm}{
        {\tt Digest::SHA1}
}
    }
     \item{
\href{http://search.cpan.org/~dankogai/Encode-2.23/Encode.pm}{
        {\tt Encode}
}
    }
     \item{
\href{http://search.cpan.org/~nwclark/perl-5.8.8/ext/Fcntl/Fcntl.pm}{
        {\tt Fcntl}
}
    }
     \item{
\href{http://search.cpan.org/~tjenness/File-Temp-0.18/Temp.pm}{
        {\tt File::Temp}
}
    }
   \item{
\href{http://search.cpan.org/~lds/GD-2.35/GD.pm}{
        {\tt GD}
}
    }
   \item{
\href{http://search.cpan.org/~jv/Getopt-Long-2.36/lib/Getopt/Long.pm}{
        {\tt Getopt::Long}
}
    }
   \item{
\href{http://search.cpan.org/~nwclark/perl-5.8.8/ext/Socket/Socket.pm}{
        {\tt Socket}
}
    }
   \item{
\href{http://search.cpan.org/~saper/Sys-Syslog-0.18/Syslog.pm}{
        {\tt Sys::Syslog}
}
    }
    \item{
\href{http://search.cpan.org/~jhi/Time-HiRes-1.9707/HiRes.pm}{
        {\tt Time::HiRes}
}
    }
  \item{
\href{http://search.cpan.org/~drolsky/Time-Local-1.17/lib/Time/Local.pm}{
        {\tt Time::Local}
}
    }
   \item{
\href{http://search.cpan.org/~pajas/XML-LibXML-1.63/LibXML.pod}{
        {\tt XML::LibXML}
}
    }
   \item{
\href{http://search.cpan.org/~phish/XML-LibXML-Common-0.13/Common.pm}{
        {\tt XML::LibXML::Common}
}
    }
\end{itemize}

\section{Local Library Modules}

The following Perl library modules are included in the source
distribution but not defined within this program.  They are
\href{http://www.cpan.org/}{
CPAN.
}
library modules which have either been specially modified for
use in this application, or are included to avoid the need to
install them on the Web server which runs this program.  If
the server's library includes the standard versions of one
or more of these modules, no harm will be done---the local
copies will be used in all cases.

\begin{itemize}
     \dense
     \item{
\href{http://search.cpan.org/~lds/CGI.pm-3.29/CGI.pm}{
        {\tt CGI}
}
    }
     \item{
\href{http://search.cpan.org/~fays/Digest-Crc32-0.01/Crc32.pm}{
        {\tt Digest::Crc32}
}
    }
     \item{
\href{http://search.cpan.org/~roburban/IDNA-Punycode-0.03/lib/IDNA/Punycode.pm}{
        {\tt IDNA::Punycode}
}
    }
     \item{
\href{http://search.cpan.org/~alancitt/Text-CSV-0.01/CSV.pm}{
        {\tt Text::CSV}
}
    }
\end{itemize}

\clearpage
\chapter{System Environment Parameters}

Set the following parameters to correspond to the system on
which you're installing the software.

\section{Program Version}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap1}\raggedright\small
\NWtarget{nuweb3a}{} $\langle\,${\itshape Version}\nobreak\ {\footnotesize {3a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@1.0@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb389a}{389a}\NWlink{nuweb404}{, 404}\NWlink{nuweb455}{, 455}\NWlink{nuweb549}{, 549}\NWlink{nuweb550}{, 550}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
\section{Release Date}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap2}\raggedright\small
\NWtarget{nuweb3b}{} $\langle\,${\itshape Release Date}\nobreak\ {\footnotesize {3b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@August 2007@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb389a}{389a}\NWlink{nuweb404}{, 404}\NWlink{nuweb455}{, 455}\NWlink{nuweb544}{, 544}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
\section{Build Number}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap3}\raggedright\small
\NWtarget{nuweb3c}{} $\langle\,${\itshape Build Number}\nobreak\ {\footnotesize {3c}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@5258@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb195}{195}\NWlink{nuweb371}{, 371}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
\section{Build Time}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap4}\raggedright\small
\NWtarget{nuweb3d}{} $\langle\,${\itshape Build Time}\nobreak\ {\footnotesize {3d}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@2022-04-05 19:18 UTC@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb195}{195}\NWlink{nuweb371}{, 371}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
\section{Configuration Parameters}

\subsection{Beta Test Mode}

If ``Beta test'' is set to 1, beta testing features, including
the creation of new user accounts only by invitation, will be
enabled.  If set to 0, the system will be open to the general
public and special test features will be disabled.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap5}\raggedright\small
\NWtarget{nuweb4a}{} $\langle\,${\itshape Beta test}\nobreak\ {\footnotesize {4a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@0@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb126}{126}\NWlink{nuweb127}{, 127}\NWlink{nuweb181}{, 181}\NWlink{nuweb190}{, 190}\NWlink{nuweb194}{, 194}\NWlink{nuweb195}{, 195}\NWlink{nuweb306b}{, 306b}\NWlink{nuweb307a}{, 307a}\NWlink{nuweb322}{, 322}\NWlink{nuweb323}{, 323}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
\subsection{Beta Test Invitation Backdoor}

The following magic word serves to bypass the need for a beta test
invitation.  It is intended purely for developer use in creating
test accounts without using up invitations.  It should be disabled
(by being set to the null string) for production.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap6}\raggedright\small
\NWtarget{nuweb4b}{} $\langle\,${\itshape Beta test backdoor}\nobreak\ {\footnotesize {4b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@'Beta luck next time'@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb306b}{306b}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
\subsection{CSV Format Version}

This value is included in the second line of all CSV monthly
logs we export.  This allows us to provide upward compatibility with
logs written by earlier versions of the applications should the
need arise to change the format.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap7}\raggedright\small
\NWtarget{nuweb4c}{} $\langle\,${\itshape CSV Format version}\nobreak\ {\footnotesize {4c}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@1.0@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb64}{64}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
\subsection{Confirmation signature encoding suffix}

We require the user to enter a randomly-generated confirmation
signature to confirm dangerous and destructive operations.  The
user's entry is passed to the execution transaction as a CGI
argument, and the SHA1 signature of the correct confirmation code
as another.  To avoid its being obvious that we're passing the
signature, and to deter possible attacks by signature collision,
we ``salt'' the confirmation code by appending the following
string before computing the signature for encoding and
verification.  You should change this suffix to a secret
value which you do not disclose to users of your server.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap8}\raggedright\small
\NWtarget{nuweb4d}{} $\langle\,${\itshape Confirmation signature encoding suffix}\nobreak\ {\footnotesize {4d}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@"Sodium Chloride"@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb157c}{157c}\NWlink{nuweb161}{, 161}\NWlink{nuweb376}{, 376}\NWlink{nuweb377}{, 377}\NWlink{nuweb382}{, 382}\NWlink{nuweb418}{, 418}\NWlink{nuweb425}{, 425}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
\subsection{Master encryption key}

The master encryption key is used to encrypt turn-around documents
such as the opaque user name identities used in badge generation.
This key is 512 bits in length and generated with Fourmilab's
\href{http://www.fourmilab.ch/hotbits/}{
HotBits
}
radioactive random number generator.  This key is replaced with
the actual value used at Fourmilab suting the installation
process---be sure to insert
your own randomly-generated key here and guard it against those
who would compromise your site.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap9}\raggedright\small
\NWtarget{nuweb5a}{} $\langle\,${\itshape Master encryption key}\nobreak\ {\footnotesize {5a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@"Super duper top secret!"@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb143}{143}\NWlink{nuweb144}{, 144}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
\subsection{Monthly log weight range}

Monthly logs must be scaled to a range wider than that of the
weight and trend data which appears in them to permit addition
of new entries outside the extrema.  The following definitions
specify the {\em minimum} monthly log weight ranges for logs in
kilograms and pounds, respectively.  This is the range which
will be used for a log in which the minimum and maximum of
existing entries are equal.  The range will be expanded by the
difference between the minimum and maximum of existing entries.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap10}\raggedright\small
\NWtarget{nuweb5b}{} $\langle\,${\itshape Monthly Log Weight Range in Kilograms}\nobreak\ {\footnotesize {5b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@1@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb5c}{5c}\NWlink{nuweb50}{, 50}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap11}\raggedright\small
\NWtarget{nuweb5c}{} $\langle\,${\itshape Monthly Log Weight Range in Pounds}\nobreak\ {\footnotesize {5c}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@(@\hbox{$\langle\,${\itshape Monthly Log Weight Range in Kilograms}\nobreak\ {\footnotesize \NWlink{nuweb5b}{5b}}$\,\rangle$}\verb@ * 2)@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb50}{50}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
\section{Public Web Addresses}

The following definitions specify the URLs through which the public
accesses the application.  They are used where we need fully-qualified
cross-links.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap12}\raggedright\small
\NWtarget{nuweb5d}{} $\langle\,${\itshape Web Document Home}\nobreak\ {\footnotesize {5d}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@/hackdiet/online@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb173}{173}\NWlink{nuweb208}{, 208}\NWlink{nuweb246}{, 246}\NWlink{nuweb467b}{, 467b}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
Web URL of the static documents for the application.

\section{Web Installation Directories}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap13}\raggedright\small
\NWtarget{nuweb5e}{} $\langle\,${\itshape Book Directory}\nobreak\ {\footnotesize {5e}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@DEVELOPMENT@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb6a}{6a}\NWlink{nuweb6c}{c}\NWlink{nuweb7b}{, 7b}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap14}\raggedright\small
\NWtarget{nuweb5f}{} $\langle\,${\itshape Production Book Directory}\nobreak\ {\footnotesize {5f}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@PRODUCTION@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb6b}{6b}\NWlink{nuweb6d}{d}\NWlink{nuweb7c}{, 7c}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
This is the Web home directory for {\em The Hacker's Diet} book.
All static documents belonging to this application are placed
within the ``Web Directory'' defined below, which is usually a
subdirectory of the Book Directory.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap15}\raggedright\small
\NWtarget{nuweb6a}{} $\langle\,${\itshape Web Directory}\nobreak\ {\footnotesize {6a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\hbox{$\langle\,${\itshape Book Directory}\nobreak\ {\footnotesize \NWlink{nuweb5e}{5e}}$\,\rangle$}\verb@/Web@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb546}{546}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap16}\raggedright\small
\NWtarget{nuweb6b}{} $\langle\,${\itshape Production Web Directory}\nobreak\ {\footnotesize {6b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\hbox{$\langle\,${\itshape Production Book Directory}\nobreak\ {\footnotesize \NWlink{nuweb5f}{5f}}$\,\rangle$}\verb@/Web@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb546}{546}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
This is the Web directory into which the static Web documents
for the application (help files, JavaScript, style sheets,
images, etc.) are placed.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap17}\raggedright\small
\NWtarget{nuweb6c}{} $\langle\,${\itshape CGI Installation Directory}\nobreak\ {\footnotesize {6c}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\hbox{$\langle\,${\itshape Book Directory}\nobreak\ {\footnotesize \NWlink{nuweb5e}{5e}}$\,\rangle$}\verb@/Cgi@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb546}{546}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap18}\raggedright\small
\NWtarget{nuweb6d}{} $\langle\,${\itshape Production CGI Installation Directory}\nobreak\ {\footnotesize {6d}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\hbox{$\langle\,${\itshape Production Book Directory}\nobreak\ {\footnotesize \NWlink{nuweb5f}{5f}}$\,\rangle$}\verb@/Cgi@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb546}{546}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
The Perl application is installed in the Web server's CGI programs
directory as defined above.  This is the installation destination
as seen from the development system on which this program is built
which may not (for example, in the case of a server farm with a
deployment machine or NFS mounting of the directories on a server)
necessarily be the same as the directory from which the Web server
executes the program.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap19}\raggedright\small
\NWtarget{nuweb6e}{} $\langle\,${\itshape CGI Execution Directory}\nobreak\ {\footnotesize {6e}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@/server/bin/httpd/cgi-bin@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb6f}{6f}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
This is the directory from which the HTTP server executes CGI
programs, as seen from the server itself.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap20}\raggedright\small
\NWtarget{nuweb6f}{} $\langle\,${\itshape CGI Support Directory}\nobreak\ {\footnotesize {6f}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\hbox{$\langle\,${\itshape CGI Execution Directory}\nobreak\ {\footnotesize \NWlink{nuweb6e}{6e}}$\,\rangle$}\verb@/HDiet@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb6g}{6g}\NWlink{nuweb7a}{, 7a}\NWlink{nuweb387a}{, 387a}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
This directory, normally a subdirectory of the main ``CGI Execution
Directory'' is where static support files used by the application
(for example, Perl modules, fonts, etc.) are placed.  This is
independent of the database directory defined below.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap21}\raggedright\small
\NWtarget{nuweb6g}{} $\langle\,${\itshape TrueType Font Directory}\nobreak\ {\footnotesize {6g}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\hbox{$\langle\,${\itshape CGI Support Directory}\nobreak\ {\footnotesize \NWlink{nuweb6f}{6f}}$\,\rangle$}\verb@/Fonts@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb90}{90}\NWlink{nuweb409}{, 409}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
This directory contains TrueType font definitions used in
plotting charts.  Each font is expected to have an extension
of ``{\tt .ttf}''.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap22}\raggedright\small
\NWtarget{nuweb7a}{} $\langle\,${\itshape Image and Icon Directory}\nobreak\ {\footnotesize {7a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\hbox{$\langle\,${\itshape CGI Support Directory}\nobreak\ {\footnotesize \NWlink{nuweb6f}{6f}}$\,\rangle$}\verb@/Images@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb101b}{101b}\NWlink{nuweb459}{, 459}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
This directory contains PNG images and icons incorporated in
images we generate.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap23}\raggedright\small
\NWtarget{nuweb7b}{} $\langle\,${\itshape Executable Installation Directory}\nobreak\ {\footnotesize {7b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\hbox{$\langle\,${\itshape Book Directory}\nobreak\ {\footnotesize \NWlink{nuweb5e}{5e}}$\,\rangle$}\verb@/Exe@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb546}{546}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap24}\raggedright\small
\NWtarget{nuweb7c}{} $\langle\,${\itshape Production Executable Installation Directory}\nobreak\ {\footnotesize {7c}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\hbox{$\langle\,${\itshape Production Book Directory}\nobreak\ {\footnotesize \NWlink{nuweb5f}{5f}}$\,\rangle$}\verb@/Exe@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb546}{546}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap25}\raggedright\small
\NWtarget{nuweb7d}{} $\langle\,${\itshape Database Directory}\nobreak\ {\footnotesize {7d}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@/server/pub/hackdiet@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb7e}{7e}\NWlink{nuweb7f}{f}\NWlink{nuweb7g}{g}\NWlink{nuweb8a}{, 8a}\NWlink{nuweb8b}{b}\NWlink{nuweb8c}{c}\NWlink{nuweb13d}{, 13d}\NWlink{nuweb173}{, 173}\NWlink{nuweb425}{, 425}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
All of the application's data are kept in this directory and
its subdirectories.  This directory may be located anywhere on
the Web server, but must be readable and writeable by the user ID
under which CGI programs run.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap26}\raggedright\small
\NWtarget{nuweb7e}{} $\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize {7e}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\hbox{$\langle\,${\itshape Database Directory}\nobreak\ {\footnotesize \NWlink{nuweb7d}{7d}}$\,\rangle$}\verb@/Sessions@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb186c}{186c}\NWlink{nuweb187}{, 187}\NWlink{nuweb204}{, 204}\NWlink{nuweb205}{, 205}\NWlink{nuweb248a}{, 248a}\NWlink{nuweb320}{, 320}\NWlink{nuweb330}{, 330}\NWlink{nuweb337}{, 337}\NWlink{nuweb338}{, 338}\NWlink{nuweb339}{, 339}\NWlink{nuweb342}{, 342}\NWlink{nuweb382}{, 382}\NWlink{nuweb400}{, 400}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
Active sessions are denoted by files in this directory.  This is usually
placed beneath the Database Directory, but needn't be if you wish to
be eccentric.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap27}\raggedright\small
\NWtarget{nuweb7f}{} $\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize {7f}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\hbox{$\langle\,${\itshape Database Directory}\nobreak\ {\footnotesize \NWlink{nuweb7d}{7d}}$\,\rangle$}\verb@/Users@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb85}{85}\NWlink{nuweb110}{, 110}\NWlink{nuweb112}{, 112}\NWlink{nuweb113a}{, 113a}\NWlink{nuweb116}{, 116}\NWlink{nuweb117}{, 117}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb183}{, 183}\NWlink{nuweb184}{, 184}\NWlink{nuweb186c}{, 186c}\NWlink{nuweb187}{, 187}\NWlink{nuweb188a}{, 188a}\NWlink{nuweb199}{, 199}\NWlink{nuweb204}{, 204}\NWlink{nuweb206}{, 206}\NWlink{nuweb210}{, 210}\NWlink{nuweb214}{, 214}\NWlink{nuweb220a}{, 220a}\NWlink{nuweb220b}{b}\NWlink{nuweb236}{, 236}\NWlink{nuweb240a}{, 240a}\NWlink{nuweb244}{, 244}\NWlink{nuweb254}{, 254}\NWlink{nuweb255}{, 255}\NWlink{nuweb256}{, 256}\NWlink{nuweb257}{, 257}\NWlink{nuweb262}{, 262}\NWlink{nuweb306a}{, 306a}\NWlink{nuweb307b}{, 307b}\NWlink{nuweb309}{, 309}\NWlink{nuweb319}{, 319}\NWlink{nuweb327}{, 327}\NWlink{nuweb329}{, 329}\NWlink{nuweb330}{, 330}\NWlink{nuweb333}{, 333}\NWlink{nuweb335}{, 335}\NWlink{nuweb368}{, 368}\NWlink{nuweb377}{, 377}\NWlink{nuweb382}{, 382}\NWlink{nuweb392}{, 392}\NWlink{nuweb393b}{, 393b}\NWlink{nuweb394}{, 394}\NWlink{nuweb395b}{, 395b}\NWlink{nuweb397}{, 397}\NWlink{nuweb398}{, 398}\NWlink{nuweb399a}{, 399a}\NWlink{nuweb400}{, 400}\NWlink{nuweb459}{, 459}\NWlink{nuweb461}{, 461}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
User accounts are stored as subdirectories with the encoded user's
name within this directory.  This is usually a subdirectory of the
Database Directory, but need not be.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap28}\raggedright\small
\NWtarget{nuweb7g}{} $\langle\,${\itshape Public Name Directory}\nobreak\ {\footnotesize {7g}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\hbox{$\langle\,${\itshape Database Directory}\nobreak\ {\footnotesize \NWlink{nuweb7d}{7d}}$\,\rangle$}\verb@/Pubname@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb165}{165}\NWlink{nuweb166}{, 166}\NWlink{nuweb167}{, 167}\NWlink{nuweb168}{, 168}\NWlink{nuweb169b}{, 169b}\NWlink{nuweb318}{, 318}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
Public names are generated and managed using files in this directory.
This is usually a subdirectory of the Database Directory, but need not
be.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap29}\raggedright\small
\NWtarget{nuweb8a}{} $\langle\,${\itshape Beta Test Invitations Directory}\nobreak\ {\footnotesize {8a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\hbox{$\langle\,${\itshape Database Directory}\nobreak\ {\footnotesize \NWlink{nuweb7d}{7d}}$\,\rangle$}\verb@/Invitations@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb306b}{306b}\NWlink{nuweb307a}{, 307a}\NWlink{nuweb324}{, 324}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
Beta test invitations are stored as files in this directory.  When one
is used to successfully create a new user account, it is deleted.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap30}\raggedright\small
\NWtarget{nuweb8b}{} $\langle\,${\itshape Backups Directory}\nobreak\ {\footnotesize {8b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\hbox{$\langle\,${\itshape Database Directory}\nobreak\ {\footnotesize \NWlink{nuweb7d}{7d}}$\,\rangle$}\verb@/Backups@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb379a}{379a}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
Backups of user directories before destructive operations are performed
are saved in this directory.  If ``Backups Directory'' is the null
string, no backups will be made.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap31}\raggedright\small
\NWtarget{nuweb8c}{} $\langle\,${\itshape Cluster Transaction Directory}\nobreak\ {\footnotesize {8c}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\hbox{$\langle\,${\itshape Database Directory}\nobreak\ {\footnotesize \NWlink{nuweb7d}{7d}}$\,\rangle$}\verb@/ClusterSync@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb416}{416}\NWlink{nuweb417}{, 417}\NWlink{nuweb418}{, 418}\NWlink{nuweb424}{, 424}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
If clustering is configured (see ``Cluster Member Hosts'' below), this directory
will be used to store the pending cluster synchronisation transactions
generated by this host.  If this is the null string or no cluster member
hosts are listed, or the named directory does not exist, clustering will
be disabled.

\section{Host System Properties}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap32}\raggedright\small
\NWtarget{nuweb8d}{} $\langle\,${\itshape Perl directory}\nobreak\ {\footnotesize {8d}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@/usr/bin/perl@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb15}{15}\NWlink{nuweb18}{, 18}\NWlink{nuweb23}{, 23}\NWlink{nuweb75}{, 75}\NWlink{nuweb114}{, 114}\NWlink{nuweb118}{, 118}\NWlink{nuweb148}{, 148}\NWlink{nuweb154}{, 154}\NWlink{nuweb163}{, 163}\NWlink{nuweb173}{, 173}\NWlink{nuweb415}{, 415}\NWlink{nuweb421a}{, 421a}\NWlink{nuweb431}{, 431}\NWlink{nuweb440}{, 440}\NWlink{nuweb445}{, 445}\NWlink{nuweb459}{, 459}\NWlink{nuweb461}{, 461}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
This is the absolute path to the directory in which Perl is installed.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap33}\raggedright\small
\NWtarget{nuweb8e}{} $\langle\,${\itshape Maximum File Length}\nobreak\ {\footnotesize {8e}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@255@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb145}{145}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
This specification defines the maximum number of characters in
a file name (independent of any other possible restriction in
length of a complete path name).  This is used to restrict the length
of file names we generate based on user names.  If the encoded user
name exceeds this length, it is limited to this length by truncation
to this length less 40 characters, then appending the SHA1 hash of
the  of the full name before truncation.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap34}\raggedright\small
\NWtarget{nuweb8f}{} $\langle\,${\itshape Cluster Member Hosts}\nobreak\ {\footnotesize {8f}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb415}{415}\NWlink{nuweb421a}{, 421a}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
To enable cluster replication, list the space-separated fully qualified
domain names of the cluster members above.  These names {\em must} agree with
those passed to CGI programs via the \verb+SERVER_NAME+ environment
variable, and must function as destination addresses in the {\tt scp} and
{\tt ssh} commands.  If the list is null, clustering will be disabled.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap35}\raggedright\small
\NWtarget{nuweb9a}{} $\langle\,${\itshape Cluster Synchronisation Time Interval}\nobreak\ {\footnotesize {9a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@30@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb421a}{421a}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
Usually cluster synchronisation is triggered by the receipt of a
{\tt SIGUSR1} signal sent by the process which enqueues the transaction.
In case one of these signals is not received, or if a synchronisation
operation fails, a periodic sweep of the queued transactions will be
performed at the interval in seconds given above.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap36}\raggedright\small
\NWtarget{nuweb9b}{} $\langle\,${\itshape Cluster Transaction Retry Time Interval}\nobreak\ {\footnotesize {9b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@45@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb428}{428}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
If a cluster synchronisation transaction fails, the destination host
is placed in a list of failed hosts.  Transactions for that host will
be queued until the above timeout in seconds has elapsed, after which
they will be retried.  This interval should be a multiple of the
synchronisation time interval given above.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap37}\raggedright\small
\NWtarget{nuweb9c}{} $\langle\,${\itshape Cluster Failed Transaction Retry Interval}\nobreak\ {\footnotesize {9c}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
$60${\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb426}{426}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
Cluster synchronisation transactions which fail due to race
conditions or other transient causes will be retried
opportunistically as other transactions arrive at the
interval in seconds specified above.  Note that if the
transaction rate is low, the actual retry time will be that
of the Cluster Synchronisation Time Interval should no other
transactions arrive.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap38}\raggedright\small
\NWtarget{nuweb9d}{} $\langle\,${\itshape Cluster Failed Transaction Maximum Retries}\nobreak\ {\footnotesize {9d}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
$5${\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb426}{426}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
A failed cluster synchronisation transaction will be retried this
number of times (at the Cluster Failed Transaction Retry Interval or
greater), after which the transaction will be abandoned as hopeless
and deleted from the transaction directory.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap39}\raggedright\small
\NWtarget{nuweb9e}{} $\langle\,${\itshape Cluster Synchronisation Signal}\nobreak\ {\footnotesize {9e}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@USR1@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb418}{418}\NWlink{nuweb421a}{, 421a}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
When a transaction is placed on the cluster synchronisation queue, the
following signal will be sent to the synchronisation process to inform
it that work is available.  This is usually {\tt SIGUSR1}, but you
can change it if necessary.  The signal is specified as the Perl
symbolic key for the \verb+%SIG+ hash.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap40}\raggedright\small
\NWtarget{nuweb9f}{} $\langle\,${\itshape Cluster Synchronisation Process ID File}\nobreak\ {\footnotesize {9f}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@/server/run/ClusterSync/ClusterSync.pid@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb418}{418}\NWlink{nuweb421a}{, 421a}\NWlink{nuweb422b}{, 422b}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
The process ID of the cluster synchronisation process will be written to
the file named above to allow transaction processors to send signals to
alert it that work for it has been queued.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap41}\raggedright\small
\NWtarget{nuweb10a}{} $\langle\,${\itshape Cluster Synchronisation Log File}\nobreak\ {\footnotesize {10a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@/server/log/hackdiet/ClusterSync.log@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb423a}{423a}\NWlink{nuweb423b}{b}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
The cluster synchronisation process will write its log to the file
specified above.  To disable logging, define this as the null string.
The log file will be closed and re-opened when the cluster synchronisation
process receives a {\tt HUP} signal, permitting cycling of the log.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap42}\raggedright\small
\NWtarget{nuweb10b}{} $\langle\,${\itshape Cluster Synchronisation User ID}\nobreak\ {\footnotesize {10b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@apache@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb422a}{422a}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap43}\raggedright\small
\NWtarget{nuweb10c}{} $\langle\,${\itshape Cluster Synchronisation Group ID}\nobreak\ {\footnotesize {10c}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@apache@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb422a}{422a}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
If initially started as the super-user (for example, from an {\tt init}
script), the cluster synchronisation process will assume the group and
user identity (both effective and real) given above and perform all
operations as that user.  This should usually be set to the identity
under which your Web server runs CGI programs.  If the null string is
specified, no identity change will be performed, nor will the
change be attempted unless the synchronisation process is initially
running as super-user.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap44}\raggedright\small
\NWtarget{nuweb10d}{} $\langle\,${\itshape Characters Permissible in File Names}\nobreak\ {\footnotesize {10d}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@[\w\x{c0}-\x{d6}\x{d8}-\x{dd}\x{df}\x{e0}-\x{f6}\x{f8}-\x{fd}\x{ff}]@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb145}{145}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
This is a regular expression which matches ISO 8859-1 characters which
are permissible in system file names.  All characters which are not matched
by this expression (and all Unicode character with code points
of U+0100 and above) will be encoded for appearance in file names by
expressing the code point in hexadecimal and enclosing the value
in the delimiters defined below, which {\em must not} be included
in the permissible characters defined above.

If you include space among the permissible characters, file names
containing spaces will be generated.  If space is not permitted,
it is encoded as:

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap45}\raggedright\small
\NWtarget{nuweb10e}{} $\langle\,${\itshape Encoding for Space in File Name Characters}\nobreak\ {\footnotesize {10e}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@+@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb145}{145}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
which, of course, must not be a permissible character.

If the underlying system, like most modern server file systems,
permits almost any characters in file names, the setting of
the variable above is a trade-off between closer correspondence
between the name the user types to log in and the name of the
directory containing their file on the one hand, and potential
difficulty in entering such file names on the part of the system
administrator on the other.  On the gripping hand, in most cases
you can cut and paste file name characters from directory listings or
wild-card problematic characters, so difficulty in entering them from
the keyboard isn't such a big thing.  Restricting the permissible characters
to pure ASCII alphanumerics is tempting, but it means that names with
ISO accented characters will turn into ugly file names.

One crucial issue is that if the underlying file system does not
distinguish upper and lower case characters (the technical name
for such a file system is a ``pile of crap''), then you {\em must}
restrict the permissible characters to one letter case (usually
lower, as they're more common in typical user names), and force
the other to be encoded.  Otherwise, you'll encounter name
collisions between names which differ only in the case of
one or more letters.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap46}\raggedright\small
\NWtarget{nuweb11a}{} $\langle\,${\itshape Left Delimiter for Quoted File Name Characters}\nobreak\ {\footnotesize {11a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@{@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb145}{145}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap47}\raggedright\small
\NWtarget{nuweb11b}{} $\langle\,${\itshape Right Delimiter for Quoted File Name Characters}\nobreak\ {\footnotesize {11b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@}@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb145}{145}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap48}\raggedright\small
\NWtarget{nuweb11c}{} $\langle\,${\itshape Maximum Text Input Field Length}\nobreak\ {\footnotesize {11c}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@4096@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb40a}{40a}\NWlink{nuweb126}{, 126}\NWlink{nuweb129a}{, 129a}\NWlink{nuweb129b}{b}\NWlink{nuweb130}{, 130}\NWlink{nuweb131a}{, 131a}\NWlink{nuweb131b}{b}\NWlink{nuweb198}{, 198}\NWlink{nuweb328}{, 328}\NWlink{nuweb336}{, 336}\NWlink{nuweb343}{, 343}\NWlink{nuweb376}{, 376}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
The following defines the absolute path used to invoke the
Sendmail mail transfer agent on the system.  This is used by
the {\tt user::sendMail} method to send electronic mail
to a user's configured address.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap49}\raggedright\small
\NWtarget{nuweb11d}{} $\langle\,${\itshape Path to Invoke Sendmail}\nobreak\ {\footnotesize {11d}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@/usr/lib/sendmail@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb136}{136}\NWlink{nuweb371}{, 371}\NWlink{nuweb372}{, 372}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
Mail sent to users will contain the following ``From'' address by
default.  It is usually configured to a bit-bucket address which
discards inadvertent replies.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap50}\raggedright\small
\NWtarget{nuweb11e}{} $\langle\,${\itshape From address for mail sent to users}\nobreak\ {\footnotesize {11e}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@noreply\@{\tt @}\verb@fourmilab.ch@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb136}{136}\NWlink{nuweb371}{, 371}\NWlink{nuweb372}{, 372}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
When a user requests a password reset, a new password will be
assigned whose length is as specified below.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap51}\raggedright\small
\NWtarget{nuweb11f}{} $\langle\,${\itshape Address for feedback E-mail}\nobreak\ {\footnotesize {11f}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@bitbucket@{\tt @}\verb@fourmilab.ch@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb371}{371}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
Feedback E-mail is sent to the above address.  This is generally a
``wave through'' address which bypasses junk mail filters.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap52}\raggedright\small
\NWtarget{nuweb11g}{} $\langle\,${\itshape Maximum line length in feedback E-mail messages}\nobreak\ {\footnotesize {11g}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@64@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb368}{368}\NWlink{nuweb373}{, 373}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
Message body lines in feedback E-mail messages will be
wrapped (if possible, only breaking lines at white
space) so as not to exceed the above line length.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap53}\raggedright\small
\NWtarget{nuweb12a}{} $\langle\,${\itshape Categories of feedback messages}\nobreak\ {\footnotesize {12a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    '(Not specified)',@\\
\mbox{}\verb@    'Problem report',@\\
\mbox{}\verb@    'Recommendation for change',@\\
\mbox{}\verb@    'Suggestion for new feature',@\\
\mbox{}\verb@    'How do I...?',@\\
\mbox{}\verb@    'Documentation or usage question',@\\
\mbox{}\verb@    'General comment'@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb388b}{388b}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
The above categories are presented to the user when
sending a feedback message.  You are free to add categories
or change the order, as long as the ``(Not specified)'' item
remains first in the list.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap54}\raggedright\small
\NWtarget{nuweb12b}{} $\langle\,${\itshape Command to check spelling}\nobreak\ {\footnotesize {12b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@'aspell list --encoding=utf-8 --mode=none | sort -u'@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb368}{368}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
This command will be used to check the spelling of feedback
messages (including the subject line) when the user opts to
preview them.  The command must accept and emit UTF-8 encoded
data, but there is no requirement that the output be formatted in any
particular way; it is just taken as a list of words split
arbitrarily across lines.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap55}\raggedright\small
\NWtarget{nuweb12c}{} $\langle\,${\itshape Length of automatically generated passwords}\nobreak\ {\footnotesize {12c}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@8@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb199}{199}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
When the user performs a password reset, a new password of this length will
be generated.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap56}\raggedright\small
\NWtarget{nuweb12d}{} $\langle\,${\itshape Cookie name}\nobreak\ {\footnotesize {12d}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@'HDiet'@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb159}{159}\NWlink{nuweb182}{, 182}\NWlink{nuweb189}{, 189}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
Cookies for persistent logins will be generated with the name above.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap57}\raggedright\small
\NWtarget{nuweb12e}{} $\langle\,${\itshape Default cookie retention time}\nobreak\ {\footnotesize {12e}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@(90 * 24 * 60 * 60)@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb155}{155}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
This value is the default retention time for login cookies,
in seconds.  The standard value is 90 days, which remembers the
login token for about three months.  Note that a new cookie is
assigned at each login, so this only affects how long a
``remember me'' is effective when the user has not logged
in from the browser in which the cookie has been set.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap58}\raggedright\small
\NWtarget{nuweb13a}{} $\langle\,${\itshape Domain for cookies}\nobreak\ {\footnotesize {13a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@.fourmilab.ch@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb158a}{158a}\NWlink{nuweb158b}{b}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap59}\raggedright\small
\NWtarget{nuweb13b}{} $\langle\,${\itshape Path for cookies}\nobreak\ {\footnotesize {13b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@/cgi-bin/HackDiet@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb158a}{158a}\NWlink{nuweb158b}{b}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
The path and domain above is used to tag cookies set by the ``remember me''
facility.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap60}\raggedright\small
\NWtarget{nuweb13c}{} $\langle\,${\itshape Set cookies with JavaScript}\nobreak\ {\footnotesize {13c}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@1@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb189}{189}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
We originally set the ``remember me'' cookie with a
``\verb+Set-Cookie+'' in the document header, specified via
the ``\verb+meta http-equiv+'' mechanism.  The pointy heads
who develop some browsers have decided, for whatever pointy head
reasons (which they declined to share with mere developers of
Web applications), to deprecate this feature and force everybody
to use JavaScript (or else have the server set the cookie in the
HTTP header, which a Web application cannot cause to happen).
They simply ignore the ``\verb+meta http-equiv+'', which breaks
persistent logins.  Note that this application has been
painstakingly designed, at great cost in development and
testing time, to provide 100% functionality if JavaScript is
turned off.  It pains me to include code which requires JavaScript,
but there is no practical alternative.  So now, if JavaScript
is disabled, ``remember me'' will not work.  But this is
better than having it never work on pointy-head browsers.
If set to 0, the original means of setting the cookie is
used.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap61}\raggedright\small
\NWtarget{nuweb13d}{} $\langle\,${\itshape Remember Me Directory}\nobreak\ {\footnotesize {13d}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\hbox{$\langle\,${\itshape Database Directory}\nobreak\ {\footnotesize \NWlink{nuweb7d}{7d}}$\,\rangle$}\verb@/RememberMe@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb159}{159}\NWlink{nuweb160}{, 160}\NWlink{nuweb316}{, 316}\NWlink{nuweb344}{, 344}\NWlink{nuweb346}{, 346}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
Directory in which cookies for persistent logins are
stored.

\section{Web URL Addresses}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap62}\raggedright\small
\NWtarget{nuweb13e}{} $\langle\,${\itshape Site home URL}\nobreak\ {\footnotesize {13e}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@http://www.fourmilab.ch@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb13f}{13f}\NWlink{nuweb202}{, 202}\NWlink{nuweb246}{, 246}\NWlink{nuweb434}{, 434}\NWlink{nuweb455}{, 455}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
This is the absolute URL of the hosting site, which is used for
the link on the site logo.  This should be an absolute URL
and specify the HTTP protocol.  Otherwise, if the user is running
the application over HTTPS and goes to the home page, the
connection will remain secure, which is unnecessary and needlessly
burdens the server.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap63}\raggedright\small
\NWtarget{nuweb13f}{} $\langle\,${\itshape Book home URL}\nobreak\ {\footnotesize {13f}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\hbox{$\langle\,${\itshape Site home URL}\nobreak\ {\footnotesize \NWlink{nuweb13e}{13e}}$\,\rangle$}\verb@/hackdiet@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb14a}{14a}\NWlink{nuweb434}{, 434}\NWlink{nuweb455}{, 455}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
This is the home directory of {\em The Hacker's Diet} book.
It is usually based upon the site home, and for the reasons
given above should also specify the HTTP protocol.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap64}\raggedright\small
\NWtarget{nuweb14a}{} $\langle\,${\itshape Application documentation URL}\nobreak\ {\footnotesize {14a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\hbox{$\langle\,${\itshape Book home URL}\nobreak\ {\footnotesize \NWlink{nuweb13f}{13f}}$\,\rangle$}\verb@/online/hdo.html@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb434}{434}.
\item \NWtxtIdentsUsed\nobreak\  \verb@html@\nobreak\ \NWlink{nuweb431}{431}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
This is {\em The Hacker's Diet Online} application documentation.

The URL (either relative or absolute) used to invoke the CGI
program is specified below:

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap65}\raggedright\small
\NWtarget{nuweb14b}{} $\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize {14b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@/cgi-bin/HackDiet@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb14c}{14c}\NWlink{nuweb126}{, 126}\NWlink{nuweb190}{, 190}\NWlink{nuweb191b}{, 191b}\NWlink{nuweb192}{, 192}\NWlink{nuweb193}{, 193}\NWlink{nuweb194}{, 194}\NWlink{nuweb200}{, 200}\NWlink{nuweb201}{, 201}\NWlink{nuweb202}{, 202}\NWlink{nuweb207}{, 207}\NWlink{nuweb208}{, 208}\NWlink{nuweb211}{, 211}\NWlink{nuweb222}{, 222}\NWlink{nuweb224}{, 224}\NWlink{nuweb225}{, 225}\NWlink{nuweb226a}{, 226a}\NWlink{nuweb246}{, 246}\NWlink{nuweb247}{, 247}\NWlink{nuweb252}{, 252}\NWlink{nuweb262}{, 262}\NWlink{nuweb264}{, 264}\NWlink{nuweb297}{, 297}\NWlink{nuweb313}{, 313}\NWlink{nuweb315}{, 315}\NWlink{nuweb320}{, 320}\NWlink{nuweb321}{, 321}\NWlink{nuweb330}{, 330}\NWlink{nuweb331}{, 331}\NWlink{nuweb332}{, 332}\NWlink{nuweb333}{, 333}\NWlink{nuweb334}{, 334}\NWlink{nuweb335}{, 335}\NWlink{nuweb340}{, 340}\NWlink{nuweb341}{, 341}\NWlink{nuweb342}{, 342}\NWlink{nuweb347}{, 347}\NWlink{nuweb370}{, 370}\NWlink{nuweb377}{, 377}\NWlink{nuweb378a}{, 378a}\NWlink{nuweb378b}{b}\NWlink{nuweb379b}{, 379b}\NWlink{nuweb381a}{, 381a}\NWlink{nuweb382}{, 382}\NWlink{nuweb383a}{, 383a}\NWlink{nuweb383b}{b}\NWlink{nuweb384a}{, 384a}\NWlink{nuweb385a}{, 385a}\NWlink{nuweb435}{, 435}\NWlink{nuweb483b}{, 483b}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
The following {\tt method} and {\tt action} will be used to
submit forms for processing.  The {\tt action} must name the
path to the CGI program which responds to requests.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap66}\raggedright\small
\NWtarget{nuweb14c}{} $\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize {14c}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@method="post" action="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@"@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb125}{125}\NWlink{nuweb192}{, 192}\NWlink{nuweb193}{, 193}\NWlink{nuweb194}{, 194}\NWlink{nuweb196}{, 196}\NWlink{nuweb198}{, 198}\NWlink{nuweb203}{, 203}\NWlink{nuweb208}{, 208}\NWlink{nuweb223}{, 223}\NWlink{nuweb227}{, 227}\NWlink{nuweb241}{, 241}\NWlink{nuweb250}{, 250}\NWlink{nuweb258}{, 258}\NWlink{nuweb270}{, 270}\NWlink{nuweb274}{, 274}\NWlink{nuweb295}{, 295}\NWlink{nuweb304a}{, 304a}\NWlink{nuweb310}{, 310}\NWlink{nuweb311}{, 311}\NWlink{nuweb315}{, 315}\NWlink{nuweb317}{, 317}\NWlink{nuweb322}{, 322}\NWlink{nuweb323}{, 323}\NWlink{nuweb325}{, 325}\NWlink{nuweb336}{, 336}\NWlink{nuweb343}{, 343}\NWlink{nuweb348}{, 348}\NWlink{nuweb358}{, 358}\NWlink{nuweb366}{, 366}\NWlink{nuweb374}{, 374}\NWlink{nuweb375b}{, 375b}\NWlink{nuweb380}{, 380}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
%    _         _  ____ ______     __
%   | |__   __| |/ ___/ ___\ \   / /
%   | '_ \ / _` | |   \___ \\ \ / /
%   | | | | (_| | |___ ___) |\ V /
%   |_| |_|\__,_|\____|____/  \_/


\clearpage
\vbox{
\chapter{{\tt hdCSV.pm} Extended CSV File Parser}
\label{hdCSV.pm}

We import and export database files in an extended dialect of
``comma-separated value'' almost-flat files.  Fields in these
files need not be quoted unless they:

\begin{itemize}
\item   Have leading or trailing spaces.
\item   Contain a comma or quote (\verb+"+) character.
\item   Include a character not in the ISO-8859-1
        graphic character set.
\end{itemize}

If one or more of these conditions applies, the field will be
enclosed in ASCII quote characters, with any embedded quotes expanded
to two consecutive quotes.  Non-graphic characters and Unicode
characters above U+00FF are encoded as in a Perl string: as
\verb+\x{+{\em hexval}\verb+}+; backslashes are escaped as two
consecutive backslashes.

}

\vbox{
\section{Package plumbing}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap67}\raggedright\small
\NWtarget{nuweb15}{} \verb@"HDiet/hdCSV.pm"@\nobreak\ {\footnotesize {15}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@#! @\hbox{$\langle\,${\itshape Perl directory}\nobreak\ {\footnotesize \NWlink{nuweb8d}{8d}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Perl language modes}\nobreak\ {\footnotesize \NWlink{nuweb387b}{387b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    package HDiet::hdCSV;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    require Exporter;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    our @{\tt @}\verb@ISA = qw(Exporter);@\\
\mbox{}\verb@    our @{\tt @}\verb@EXPORT = qw(parseCSV encodeCSV);@\\
\mbox{}\verb@    1;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb15}{15}\NWlink{nuweb16}{, 16}\NWlink{nuweb17}{, 17}.
\item \NWtxtIdentsUsed\nobreak\  \verb@encodeCSV@\nobreak\ \NWlink{nuweb17}{17}, \verb@parseCSV@\nobreak\ \NWlink{nuweb16}{16}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{ParseCSV}

The {\tt parseCSV} function is called with a CSV record (which may
contain trailing white space, including an end of line sequence).
Fields from the record are parsed and stored into an array, which is
returned in list context.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap68}\raggedright\small
\NWtarget{nuweb16}{} \verb@"HDiet/hdCSV.pm"@\nobreak\ {\footnotesize {16}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub parseCSV {@\\
\mbox{}\verb@        my ($s) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my @{\tt @}\verb@fields;@\\
\mbox{}\verb@        my $f;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $s =~ s/\s+$//;@\\
\mbox{}\verb@        $s =~ s/,$/,""/;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        while ($s ne '') {@\\
\mbox{}\verb@            if ($s =~ s/^\s*"((?:""|[^"])*)"\s*,?//) {@\\
\mbox{}\verb@@\\
\mbox{}\verb@                $f = $1;@\\
\mbox{}\verb@                $f =~ s/""/"/g;@\\
\mbox{}\verb@                my $uf = '';@\\
\mbox{}\verb@                while ($f =~ s/^(.)//) {@\\
\mbox{}\verb@                    my $c = $1;@\\
\mbox{}\verb@                    if ($c eq "\\") {@\\
\mbox{}\verb@                        if ($f =~ s/\\//) {@\\
\mbox{}\verb@                            $uf .= "\\";@\\
\mbox{}\verb@                        } elsif ($f =~ s/x\{([0-7a-fA-F]+)\}//) {@\\
\mbox{}\verb@                            $uf .= chr(hex($1));@\\
\mbox{}\verb@                        } else {@\\
\mbox{}\verb@                            print(STDERR "Undefined backslash escape \\$f in CSV record.\n");@\\
\mbox{}\verb@                        }@\\
\mbox{}\verb@                    } else {@\\
\mbox{}\verb@                        $uf .= $1;@\\
\mbox{}\verb@                    }@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@                $f = $uf;@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                $s =~ s/^\s*([^,]*),?//;@\\
\mbox{}\verb@                $f = $1;@\\
\mbox{}\verb@                $f =~ s/\s+$//@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@@\\
\mbox{}\verb@            push(@{\tt @}\verb@fields, $f);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return @{\tt @}\verb@fields;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb15}{15}\NWlink{nuweb16}{, 16}\NWlink{nuweb17}{, 17}.
\item \NWtxtIdentsDefed\nobreak\  \verb@parseCSV@\nobreak\ \NWlink{nuweb15}{15}\NWlink{nuweb63}{, 63}.\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{EncodeCSV}

The {\tt encodeCSV} is called with a list of fields to be encoded
into a CSV file, which may either be a sequence of arguments or an
array argument.  The single-line CSV record is returned, with no
end of line sequence appended.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap69}\raggedright\small
\NWtarget{nuweb17}{} \verb@"HDiet/hdCSV.pm"@\nobreak\ {\footnotesize {17}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub encodeCSV {@\\
\mbox{}\verb@        my $f;@\\
\mbox{}\verb@        my $s = '';@\\
\mbox{}\verb@@\\
\mbox{}\verb@        while (defined($f = shift)) {@\\
\mbox{}\verb@@\\
\mbox{}\verb@            #   Encode any non-ISO-8859-1 graphic characters@\\
\mbox{}\verb@            #   (including wide characters) as hexadecimal escape@\\
\mbox{}\verb@            #   sequences and force any backslashes in the@\\
\mbox{}\verb@            #   string.@\\
\mbox{}\verb@@\\
\mbox{}\verb@            my $ef = '';@\\
\mbox{}\verb@            my $forced = 0;@\\
\mbox{}\verb@            while ($f =~ s/^(.)//) {@\\
\mbox{}\verb@                my $o = ord($1);@\\
\mbox{}\verb@                if (($o < 32) ||@\\
\mbox{}\verb@                    (($o >= 127) && ($o < 161)) ||@\\
\mbox{}\verb@                    ($o > 255)) {@\\
\mbox{}\verb@                    $ef .= sprintf("\\x{%lx}", $o);@\\
\mbox{}\verb@                    $forced = 1;@\\
\mbox{}\verb@                } elsif ($1 eq "\\") {@\\
\mbox{}\verb@                    $ef .= "\\\\";@\\
\mbox{}\verb@                    $forced = 1;@\\
\mbox{}\verb@                } else {@\\
\mbox{}\verb@                    $ef .= $1;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@@\\
\mbox{}\verb@            #   If the field contains leading or trailing white@\\
\mbox{}\verb@            #   space, an embedded comma, quote, or an escaped character,@\\
\mbox{}\verb@            #   force quotes within it and enclose in quotes.@\\
\mbox{}\verb@@\\
\mbox{}\verb@            if (($ef =~ m/^\s/) || ($ef =~ m/\s$/) ||@\\
\mbox{}\verb@                ($ef =~ m/,/) || ($ef =~ m/"/) || $forced) {@\\
\mbox{}\verb@                $ef =~ s/"/""/g;@\\
\mbox{}\verb@                $ef = '"' . $ef . '"';@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@@\\
\mbox{}\verb@            $s .= $ef . ',';@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $s =~ s/,$//;@\\
\mbox{}\verb@        return $s;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb15}{15}\NWlink{nuweb16}{, 16}\NWlink{nuweb17}{, 17}.
\item \NWtxtIdentsDefed\nobreak\  \verb@encodeCSV@\nobreak\ \NWlink{nuweb15}{15}\NWlink{nuweb64}{, 64}\NWlink{nuweb255}{, 255}.\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

%    _                      _  __ _ _
%   | |_ _ __ ___ _ __   __| |/ _(_) |_
%   | __| '__/ _ \ '_ \ / _` | |_| | __|
%   | |_| | |  __/ | | | (_| |  _| | |_
%    \__|_|  \___|_| |_|\__,_|_| |_|\__|
%

\clearpage
\vbox{
\chapter{{\tt trendfit.pm}: Trend Fitter Object}
\label{trendfit.pm}

The {\tt trendfit} object fits a linear trend to a sequence
of values via linear regression with the least squares
method.

}

\vbox{
\section{Package plumbing}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap70}\raggedright\small
\NWtarget{nuweb18}{} \verb@"HDiet/trendfit.pm"@\nobreak\ {\footnotesize {18}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@#! @\hbox{$\langle\,${\itshape Perl directory}\nobreak\ {\footnotesize \NWlink{nuweb8d}{8d}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Perl language modes}\nobreak\ {\footnotesize \NWlink{nuweb387b}{387b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    package HDiet::trendfit;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    require Exporter;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    our @{\tt @}\verb@ISA = qw(Exporter);@\\
\mbox{}\verb@    our @{\tt @}\verb@EXPORT = qw(new start addPoint fitSlope);@\\
\mbox{}\verb@    1;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb18}{18}\NWlink{nuweb19a}{, 19a}\NWlink{nuweb19b}{b}\NWlink{nuweb20a}{, 20a}\NWlink{nuweb20b}{b}\NWlink{nuweb21}{, 21}.
\item \NWtxtIdentsUsed\nobreak\  \verb@addPoint@\nobreak\ \NWlink{nuweb20a}{20a}, \verb@fitSlope@\nobreak\ \NWlink{nuweb20b}{20b}\NWlink{nuweb488a}{, 488a}, \verb@start@\nobreak\ \NWlink{nuweb19b}{19b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Constructor}

A new {\tt trendfit} object is created by calling the
{\tt new} constructor.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap71}\raggedright\small
\NWtarget{nuweb19a}{} \verb@"HDiet/trendfit.pm"@\nobreak\ {\footnotesize {19a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub new {@\\
\mbox{}\verb@        my $self = {};@\\
\mbox{}\verb@        my ($invocant) = @{\tt @}\verb@_;@\\
\mbox{}\verb@        my $class = ref($invocant) || $invocant;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        bless($self, $class);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $self->start();@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $self;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb18}{18}\NWlink{nuweb19a}{, 19a}\NWlink{nuweb19b}{b}\NWlink{nuweb20a}{, 20a}\NWlink{nuweb20b}{b}\NWlink{nuweb21}{, 21}.
\item \NWtxtIdentsUsed\nobreak\  \verb@start@\nobreak\ \NWlink{nuweb19b}{19b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Start}

The {\tt start} method resets the {\tt trendfit} object to compute a
new trend.  This is called by the constructor, so you needn't explicitly
call this method unless you've already added some points and wish to
start over.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap72}\raggedright\small
\NWtarget{nuweb19b}{} \verb@"HDiet/trendfit.pm"@\nobreak\ {\footnotesize {19b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub start {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $self->{n} = 0;@\\
\mbox{}\verb@        $self->{s1} = $self->{s2} = $self->{s3} = $self->{s4} = 0;@\\
\mbox{}\verb@        $self->{min} = 1E308;@\\
\mbox{}\verb@        $self->{max} = -1E308;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb18}{18}\NWlink{nuweb19a}{, 19a}\NWlink{nuweb19b}{b}\NWlink{nuweb20a}{, 20a}\NWlink{nuweb20b}{b}\NWlink{nuweb21}{, 21}.
\item \NWtxtIdentsDefed\nobreak\  \verb@start@\nobreak\ \NWlink{nuweb18}{18}\NWlink{nuweb19a}{, 19a}\NWlink{nuweb52}{, 52}\NWlink{nuweb80}{, 80}\NWlink{nuweb84}{, 84}\NWlink{nuweb86}{, 86}\NWlink{nuweb139}{, 139}\NWlink{nuweb260}{, 260}\NWlink{nuweb266}{, 266}\NWlink{nuweb275}{, 275}\NWlink{nuweb277b}{, 277b}\NWlink{nuweb292}{, 292}\NWlink{nuweb297}{, 297}\NWlink{nuweb303}{, 303}\NWlink{nuweb408}{, 408}\NWlink{nuweb497}{, 497}\NWlink{nuweb514b}{, 514b}\NWlink{nuweb534}{, 534}\NWlink{nuweb540}{, 540}.\item \NWtxtIdentsUsed\nobreak\  \verb@max@\nobreak\ \NWlink{nuweb405}{405}, \verb@min@\nobreak\ \NWlink{nuweb405}{405}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Add Point}

The {\tt addPoint} method adds one or more point values specified
by the argument to the trend we're fitting.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap73}\raggedright\small
\NWtarget{nuweb20a}{} \verb@"HDiet/trendfit.pm"@\nobreak\ {\footnotesize {20a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub addPoint {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $v;@\\
\mbox{}\verb@        foreach $v (@{\tt @}\verb@_) {@\\
\mbox{}\verb@            $self->{s1} += ($self->{n} + 1) * $v;@\\
\mbox{}\verb@            $self->{s2} += ($self->{n} + 1);@\\
\mbox{}\verb@            $self->{s3} += $v;@\\
\mbox{}\verb@            $self->{s4} += ($self->{n} + 1) ** 2;@\\
\mbox{}\verb@            $self->{n}++;@\\
\mbox{}\verb@            $self->{min} = ::min($self->{min}, $v);@\\
\mbox{}\verb@            $self->{max} = ::max($self->{max}, $v);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb18}{18}\NWlink{nuweb19a}{, 19a}\NWlink{nuweb19b}{b}\NWlink{nuweb20a}{, 20a}\NWlink{nuweb20b}{b}\NWlink{nuweb21}{, 21}.
\item \NWtxtIdentsDefed\nobreak\  \verb@addPoint@\nobreak\ \NWlink{nuweb18}{18}\NWlink{nuweb28}{, 28}\NWlink{nuweb77}{, 77}\NWlink{nuweb81}{, 81}\NWlink{nuweb351}{, 351}\NWlink{nuweb356}{, 356}.\item \NWtxtIdentsUsed\nobreak\  \verb@max@\nobreak\ \NWlink{nuweb405}{405}, \verb@min@\nobreak\ \NWlink{nuweb405}{405}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Fit Slope}

The {\tt fitSlope} method fits a linear trend to the points
supplied so far and returns its slope.  You are free to continue
adding points after returning the trend.  If too few points have
been specified to fit a linear trend, we return a slope of zero.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap74}\raggedright\small
\NWtarget{nuweb20b}{} \verb@"HDiet/trendfit.pm"@\nobreak\ {\footnotesize {20b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub fitSlope {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $denom = (($self->{s4} * $self->{n}) - ($self->{s2} ** 2));@\\
\mbox{}\verb@        return 0 if $denom == 0;@\\
\mbox{}\verb@        return (($self->{s1} * $self->{n}) - ($self->{s2} * $self->{s3})) /@\\
\mbox{}\verb@                $denom;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb18}{18}\NWlink{nuweb19a}{, 19a}\NWlink{nuweb19b}{b}\NWlink{nuweb20a}{, 20a}\NWlink{nuweb20b}{b}\NWlink{nuweb21}{, 21}.
\item \NWtxtIdentsDefed\nobreak\  \verb@fitSlope@\nobreak\ \NWlink{nuweb18}{18}\NWlink{nuweb28}{, 28}\NWlink{nuweb79}{, 79}\NWlink{nuweb351}{, 351}\NWlink{nuweb357}{, 357}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb500}{, 500}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Minimum, Maximum, and Mean}

The {\tt minMaxMean} method returns a list containing the minimum,
maximum, and mean values of the points added so far.  This may be
called at any point and does not disturb the computation of
subsequently added points.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap75}\raggedright\small
\NWtarget{nuweb21}{} \verb@"HDiet/trendfit.pm"@\nobreak\ {\footnotesize {21}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub minMaxMean {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return ($self->{min}, $self->{max}, ($self->{s3} / $self->{n}));@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb18}{18}\NWlink{nuweb19a}{, 19a}\NWlink{nuweb19b}{b}\NWlink{nuweb20a}{, 20a}\NWlink{nuweb20b}{b}\NWlink{nuweb21}{, 21}.
\item \NWtxtIdentsDefed\nobreak\  \verb@minMaxMean@\nobreak\ \NWlink{nuweb79}{79}.\item \NWtxtIdentsUsed\nobreak\  \verb@max@\nobreak\ \NWlink{nuweb405}{405}, \verb@min@\nobreak\ \NWlink{nuweb405}{405}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

%                          _   _     _
%    _ __ ___   ___  _ __ | |_| |__ | | ___   __ _
%   | '_ ` _ \ / _ \| '_ \| __| '_ \| |/ _ \ / _` |
%   | | | | | | (_) | | | | |_| | | | | (_) | (_| |
%   |_| |_| |_|\___/|_| |_|\__|_| |_|_|\___/ \__, |
%                                            |___/

\clearpage
\vbox{
\chapter{{\tt monthlog.pm}: Monthly Log Object}
\label{monthlog.pm}

The {\tt monthlog} object encapsulates almost all of the
mechanics of processing monthly weight and exercise logs.

}

\vbox{
\section{Package plumbing}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap76}\raggedright\small
\NWtarget{nuweb23}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {23}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@#! @\hbox{$\langle\,${\itshape Perl directory}\nobreak\ {\footnotesize \NWlink{nuweb8d}{8d}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Perl language modes}\nobreak\ {\footnotesize \NWlink{nuweb387b}{387b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use HDiet::trendfit;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    package HDiet::monthlog;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use HDiet::hdCSV;@\\
\mbox{}\verb@    use HDiet::Julian qw(WEEKDAY_NAMES :DEFAULT);@\\
\mbox{}\verb@    use HDiet::html;@\\
\mbox{}\verb@    use HDiet::xml;@\\
\mbox{}\verb@    use GD;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    require Exporter;@\\
\mbox{}\verb@    our @{\tt @}\verb@ISA = qw(Exporter);@\\
\mbox{}\verb@    our @{\tt @}\verb@EXPORT = qw(@\\
\mbox{}\verb@                      WEIGHT_KILOGRAM WEIGHT_POUND WEIGHT_STONE@\\
\mbox{}\verb@                      ENERGY_CALORIE ENERGY_KILOJOULE@\\
\mbox{}\verb@                      WEIGHT_CONVERSION ENERGY_CONVERSION@\\
\mbox{}\verb@                      CALORIES_PER_WEIGHT_UNIT@\\
\mbox{}\verb@                      );@\\
\mbox{}\verb@    our %EXPORT_TAGS = (@\\
\mbox{}\verb@                            units => [ qw(WEIGHT_KILOGRAM WEIGHT_POUND WEIGHT_STONE@\\
\mbox{}\verb@                                          ENERGY_CALORIE ENERGY_KILOJOULE) ]@\\
\mbox{}\verb@                       );@\\
\mbox{}\verb@    1;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Constants and conversion tables}\nobreak\ {\footnotesize \NWlink{nuweb24}{24}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Minimum, Maximum, and Sign functions}\nobreak\ {\footnotesize \NWlink{nuweb405}{405}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsUsed\nobreak\  \verb@CALORIES_PER_WEIGHT_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@ENERGY_CALORIE@\nobreak\ \NWlink{nuweb24}{24}, \verb@ENERGY_CONVERSION@\nobreak\ \NWlink{nuweb24}{24}, \verb@ENERGY_KILOJOULE@\nobreak\ \NWlink{nuweb24}{24}, \verb@html@\nobreak\ \NWlink{nuweb431}{431}, \verb@Julian@\nobreak\ \NWlink{nuweb445}{445}, \verb@WEEKDAY_NAMES@\nobreak\ \NWlink{nuweb445}{445}, \verb@WEIGHT_KILOGRAM@\nobreak\ \NWlink{nuweb24}{24}, \verb@WEIGHT_POUND@\nobreak\ \NWlink{nuweb24}{24}, \verb@WEIGHT_STONE@\nobreak\ \NWlink{nuweb24}{24}, \verb@xml@\nobreak\ \NWlink{nuweb440}{440}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Constants and conversion tables}

We define the following symbolic constants for quantities used in
the monthly log object.  Conversion tables between the various
weight and energy units are also defined as constants.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap77}\raggedright\small
\NWtarget{nuweb24}{} $\langle\,${\itshape Constants and conversion tables}\nobreak\ {\footnotesize {24}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    use constant FILE_VERSION => 1;@\\
\mbox{}\verb@    use constant WEIGHT_KILOGRAM => 0;@\\
\mbox{}\verb@    use constant WEIGHT_POUND => 1;@\\
\mbox{}\verb@    use constant WEIGHT_STONE => 2;@\\
\mbox{}\verb@    use constant WEIGHT_UNITS => [ "kilogram", "pound", "stone" ];@\\
\mbox{}\verb@    use constant DELTA_WEIGHT_UNITS => [ "kilogram", "pound", "pound" ];@\\
\mbox{}\verb@    use constant DELTA_WEIGHT_ABBREVIATIONS => [ "kg", "lb", "lb" ];@\\
\mbox{}\verb@    use constant WEIGHT_ABBREVIATIONS => [ "kg", "lb", "st" ];@\\
\mbox{}\verb@    use constant CALORIES_PER_WEIGHT_UNIT => [ 7716, 3500, 3500 ];@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use constant WEIGHT_CONVERSION => [@\\
\mbox{}\verb@    #   Entries for pounds and stones are identical because@\\
\mbox{}\verb@    #   even if stones are selected, entries in log items are@\\
\mbox{}\verb@    #   always kept in pounds.@\\
\mbox{}\verb@    #@\\
\mbox{}\verb@    #  To:         kg               lb             st@\\
\mbox{}\verb@    #                                                             From@\\
\mbox{}\verb@              [ 1.0,            2.2046226,     2.2046226    ],  #   kg@\\
\mbox{}\verb@              [ 0.45359237,     1.0,           1.0          ],  #   lb@\\
\mbox{}\verb@              [ 0.45359237,     1.0,           1.0          ]   #   st@\\
\mbox{}\verb@    ];@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use constant ENERGY_CALORIE => 0;@\\
\mbox{}\verb@    use constant ENERGY_KILOJOULE => 1;@\\
\mbox{}\verb@    use constant ENERGY_UNITS => [ "calorie", "kilojoule" ];@\\
\mbox{}\verb@    use constant ENERGY_ABBREVIATIONS => [ "cal", "kJ" ];@\\
\mbox{}\verb@    use constant CALORIES_PER_ENERGY_UNIT => [ 1, 0.239045 ];@\\
\mbox{}\verb@    use constant ENERGY_CONVERSION => [@\\
\mbox{}\verb@    #@\\
\mbox{}\verb@    #   To:         cal         kJ                 From@\\
\mbox{}\verb@                [   1.0,        4.18331  ],     #   cal@\\
\mbox{}\verb@                [   0.239045,   1.0      ]      #   kJ@\\
\mbox{}\verb@    ];@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use constant RUNG_MAX => 48;@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb23}{23}.
\item \NWtxtIdentsDefed\nobreak\  \verb@CALORIES_PER_ENERGY_UNIT@\nobreak\ \NWlink{nuweb100}{100}\NWlink{nuweb102b}{, 102b}\NWlink{nuweb215}{, 215}\NWlink{nuweb268}{, 268}\NWlink{nuweb351}{, 351}\NWlink{nuweb352}{, 352}\NWlink{nuweb481}{, 481}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}, \verb@CALORIES_PER_WEIGHT_UNIT@\nobreak\ \NWlink{nuweb23}{23}\NWlink{nuweb100}{, 100}\NWlink{nuweb102b}{, 102b}\NWlink{nuweb142}{, 142}\NWlink{nuweb215}{, 215}\NWlink{nuweb268}{, 268}\NWlink{nuweb284}{, 284}\NWlink{nuweb290a}{, 290a}\NWlink{nuweb290b}{b}\NWlink{nuweb291a}{, 291a}\NWlink{nuweb292}{, 292}\NWlink{nuweb351}{, 351}\NWlink{nuweb352}{, 352}\NWlink{nuweb481}{, 481}\NWlink{nuweb500}{, 500}\NWlink{nuweb507}{, 507}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb514b}{, 514b}, \verb@ENERGY_CALORIE@\nobreak\ \NWlink{nuweb23}{23}\NWlink{nuweb120}{, 120}\NWlink{nuweb275}{, 275}\NWlink{nuweb284}{, 284}\NWlink{nuweb290a}{, 290a}\NWlink{nuweb292}{, 292}\NWlink{nuweb293}{, 293}, \verb@ENERGY_CONVERSION@\nobreak\ \NWlink{nuweb23}{23}\NWlink{nuweb275}{, 275}\NWlink{nuweb284}{, 284}\NWlink{nuweb287a}{, 287a}\NWlink{nuweb290a}{, 290a}\NWlink{nuweb292}{, 292}\NWlink{nuweb293}{, 293}\NWlink{nuweb481}{, 481}\NWlink{nuweb509b}{, 509b}, \verb@ENERGY_KILOJOULE@\nobreak\ \NWlink{nuweb23}{23}, \verb@ENERGY_UNITS@\nobreak\ \NWlink{nuweb100}{100}\NWlink{nuweb122}{, 122}\NWlink{nuweb138}{, 138}\NWlink{nuweb215}{, 215}\NWlink{nuweb255}{, 255}\NWlink{nuweb267}{, 267}, \verb@RUNG_MAX@\nobreak\ \NWlink{nuweb45}{45}\NWlink{nuweb49}{, 49}\NWlink{nuweb60}{, 60}\NWlink{nuweb83}{, 83}, \verb@WEIGHT_KILOGRAM@\nobreak\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb29}{, 29}\NWlink{nuweb50}{, 50}\NWlink{nuweb52}{, 52}\NWlink{nuweb85}{, 85}\NWlink{nuweb86}{, 86}\NWlink{nuweb120}{, 120}\NWlink{nuweb142}{, 142}\NWlink{nuweb230}{, 230}\NWlink{nuweb234}{, 234}\NWlink{nuweb238}{, 238}\NWlink{nuweb275}{, 275}\NWlink{nuweb293}{, 293}\NWlink{nuweb481}{, 481}\NWlink{nuweb501}{, 501}, \verb@WEIGHT_POUND@\nobreak\ \NWlink{nuweb23}{23}\NWlink{nuweb103b}{, 103b}\NWlink{nuweb230}{, 230}\NWlink{nuweb234}{, 234}, \verb@WEIGHT_STONE@\nobreak\ \NWlink{nuweb23}{23}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb48a}{, 48a}\NWlink{nuweb51}{, 51}\NWlink{nuweb57}{, 57}\NWlink{nuweb58}{, 58}\NWlink{nuweb87b}{, 87b}\NWlink{nuweb103b}{, 103b}\NWlink{nuweb230}{, 230}\NWlink{nuweb234}{, 234}\NWlink{nuweb238}{, 238}\NWlink{nuweb285}{, 285}\NWlink{nuweb293}{, 293}\NWlink{nuweb401}{, 401}\NWlink{nuweb481}{, 481}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb488b}{, 488b}, \verb@WEIGHT_UNITS@\nobreak\ \NWlink{nuweb27}{27}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb122}{, 122}\NWlink{nuweb138}{, 138}\NWlink{nuweb255}{, 255}.\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Constructor}

A new {\tt monthlog} object is created by calling the
{\tt new} constructor.  The following arguments may be
supplied, all of which are optional; omitted arguments are
filled in with zeroes or blanks as appropriate.

\begin{center}
\begin{tabular}{|l|l|}
\hline
login\_name                 &   User login name \\
year                        &   Gregorian year  \\
month                       &   Month number (1--12)    \\
log\_unit                   &   Weight unit \\
trend\_carry\_forward       &   Trend at start of month \\
last\_modification\_time    &   \UNIX/ time of last modification    \\
\hline
\end{tabular}
\end{center}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap78}\raggedright\small
\NWtarget{nuweb25}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {25}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub new {@\\
\mbox{}\verb@        my $self = {};@\\
\mbox{}\verb@        my ($invocant, $login_name, $year, $month, $log_unit,@\\
\mbox{}\verb@            $trend_carry_forward, $last_modification_time) = @{\tt @}\verb@_;@\\
\mbox{}\verb@        my $class = ref($invocant) || $invocant;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $login_name = '' if !defined($login_name);@\\
\mbox{}\verb@        $year = 0 if !defined($year);@\\
\mbox{}\verb@        $month = 0 if !defined($month);@\\
\mbox{}\verb@        $log_unit = WEIGHT_KILOGRAM if !defined($log_unit);@\\
\mbox{}\verb@        $trend_carry_forward = 0 if !defined($trend_carry_forward);@\\
\mbox{}\verb@        $last_modification_time = 0 if !defined($last_modification_time);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        bless($self, $class);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $self->{version} = FILE_VERSION;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   Initialise instance variables from constructor arguments@\\
\mbox{}\verb@        $self->{login_name} = $login_name;@\\
\mbox{}\verb@        $self->{year} = $year;@\\
\mbox{}\verb@        $self->{month} = $month;@\\
\mbox{}\verb@        $self->{log_unit} = $log_unit;@\\
\mbox{}\verb@        $self->{trend_carry_forward} = $trend_carry_forward;@\\
\mbox{}\verb@        $self->{last_modification_time} = $last_modification_time;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $self->{weight} = [];                   # Create empty weight array@\\
\mbox{}\verb@        $self->{rung} = [];                     # Create empty exercise rung array@\\
\mbox{}\verb@        $self->{flag} = [];                     # Create empty flag array@\\
\mbox{}\verb@        $self->{comment} = [];                  # Create empty comment array@\\
\mbox{}\verb@        $self->{trend} = [];                    # Create empty trend array@\\
\mbox{}\verb@        $self->{verbose} = 0;                   # Default to non-verbose mode@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $self;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsUsed\nobreak\  \verb@verbose@\nobreak\ \NWlink{nuweb71}{71}, \verb@WEIGHT_KILOGRAM@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Destructor}

The destructor cleans up when an object is deallocated.  Actually,
regular reference count garbage collection handles everything just
fine without a destructor, but I've provided for one in case we
do something fancy with the database which may eventually require one.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap79}\raggedright\small
\NWtarget{nuweb26}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {26}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub DESTROY {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($self->{verbose}) {@\\
\mbox{}\verb@            print("monthlog: Destructor invoked\n");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        undef($self->{weight});@\\
\mbox{}\verb@        undef($self->{rung});@\\
\mbox{}\verb@        undef($self->{flag});@\\
\mbox{}\verb@        undef($self->{comment});@\\
\mbox{}\verb@        undef($self->{trend});@\\
\mbox{}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsUsed\nobreak\  \verb@verbose@\nobreak\ \NWlink{nuweb71}{71}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Describe}

The {\tt describe} method prints a primate-readable description
of the monthly log on the file handle (default {\tt STDOUT})
given by the argument.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap80}\raggedright\small
\NWtarget{nuweb27}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {27}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub describe {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($outfile) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (!(defined $outfile)) {@\\
\mbox{}\verb@            $outfile = \*STDOUT;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print($outfile "MONTHLOG Version: $self->{version}\n");@\\
\mbox{}\verb@        print($outfile "  Login: '$self->{login_name}'  Year: $self->{year}  " .@\\
\mbox{}\verb@            "Month: $self->{month}  " .@\\
\mbox{}\verb@            "Log unit: " . WEIGHT_UNITS->[$self->{log_unit}] ."\n");@\\
\mbox{}\verb@        print($outfile "  Trend carry-forward: $self->{trend_carry_forward}\n" .@\\
\mbox{}\verb@            "  Last modification time: " . localtime($self->{last_modification_time}) .@\\
\mbox{}\verb@            "\n");@\\
\mbox{}\verb@        print($outfile "  Days in month: " . $self->monthdays() . "\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@        for (my $i = 1; $i <= $self->monthdays(); $i++) {@\\
\mbox{}\verb@            my $dw = defined($self->{weight}[$i]) ? sprintf("%6.2f", $self->{weight}[$i]) : "      ";@\\
\mbox{}\verb@            my $dt = defined($self->{trend}[$i]) ? sprintf("%6.2f", $self->{trend}[$i]) : "      ";@\\
\mbox{}\verb@            my $dr = defined($self->{rung}[$i]) ? sprintf("%2d", $self->{rung}[$i]) : "  ";@\\
\mbox{}\verb@            my $df = defined($self->{flag}[$i]) ? sprintf("%1d", $self->{flag}[$i]) : " ";@\\
\mbox{}\verb@            my $dc = defined($self->{comment}[$i]) ? "  $self->{comment}[$i]" : "";@\\
\mbox{}\verb@@\\
\mbox{}\verb@            printf($outfile "   %2d  $dw  $dt  $dr  $df$dc\n", $i);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@describe@\nobreak\ \NWlink{nuweb105}{105}\NWlink{nuweb122}{, 122}\NWlink{nuweb150}{, 150}\NWlink{nuweb156a}{, 156a}\NWlink{nuweb170a}{, 170a}\NWlink{nuweb218}{, 218}\NWlink{nuweb316}{, 316}\NWlink{nuweb461}{, 461}.\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}, \verb@WEIGHT_UNITS@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{ComputeTrend}

The {\tt computeTrend} method calculates the exponentially smoothed
moving average trend for days in the month, starting with the trend
carried forward from the previous month (or the first entry in this
log, is no trend carry forward is specified).  The slope of a linear
regression fit to the trend (truncated at the last specified data in
the month) is returned.

If there are insufficient data points in the log from which to
extrapolate a trend, a slope of zero is returned.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap81}\raggedright\small
\NWtarget{nuweb28}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {28}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub computeTrend {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $t = $self->{trend_carry_forward};@\\
\mbox{}\verb@        my $n = $self->monthdays();@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($t == 0) {@\\
\mbox{}\verb@            for (my $i = 1; $i <= $n; $i++) {@\\
\mbox{}\verb@                if (defined($self->{weight}[$i]) && ($self->{weight}[$i] > 0)) {@\\
\mbox{}\verb@                    $t = $self->{weight}[$i];@\\
\mbox{}\verb@                    last;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($t > 0) {@\\
\mbox{}\verb@            for (my $i = 1; $i <= $n; $i++) {@\\
\mbox{}\verb@                if (defined($self->{weight}[$i]) && ($self->{weight}[$i] > 0)) {@\\
\mbox{}\verb@                    $t = $t + (($self->{weight}[$i] - $t) / 10);@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@                $self->{trend}[$i] = $t;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $nd = $n;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        while (($nd >= 0) && (!defined($self->{weight}[$nd]))) {@\\
\mbox{}\verb@            $nd--;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($nd <= 1) {@\\
\mbox{}\verb@            return 0;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $fitter = HDiet::trendfit->new();@\\
\mbox{}\verb@        for (my $i = 1; $i <= $nd; $i++) {@\\
\mbox{}\verb@            $fitter->addPoint($self->{trend}[$i]);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return $fitter->fitSlope();@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@computeTrend@\nobreak\ \NWlink{nuweb33b}{33b}\NWlink{nuweb215}{, 215}\NWlink{nuweb394}{, 394}.\item \NWtxtIdentsUsed\nobreak\  \verb@addPoint@\nobreak\ \NWlink{nuweb20a}{20a}, \verb@fitSlope@\nobreak\ \NWlink{nuweb20b}{20b}\NWlink{nuweb488a}{, 488a}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{BodyMassIndex}

This method computes the Body Mass Index (BMI), which is defined as
$w/h^2$ where $w$ is the weight in kilograms and $h$ the height in
metres.  The first argument specifies the user's height in centimetres,
which is how we store it in the {\tt user} object.

If called with no second argument, the {\tt bodyMassIndex} method computes
the mean body mass index for the month.  If called with a second argument,
it returns the body mass index for that day.  If no weight entry exists
for that day (or for the entire month, if the mean is requested), or the
user has not specified their height, zero is returned.  If called with a
negative second argument, the body mass index for the last day of the month
for which a weight entry is present will be returned (or zero if the log
is entirely empty).

Note that the body mass index is always computed from the {\em trend}, not
the unsmoothed weight; this makes it more stable and consistent.  The
standard interpretation of body mass index numbers for adults is as follows:

\begin{center}
\begin{tabular}{|c|c|}
\hline
{\bf BMI}       &   {\bf Weight Status}     \\
\hline
$<18.5$         &   Underweight             \\
18.5--24.9      &   Normal                  \\
25.0--29.9      &   Overweight              \\
$\geq30.0$      &   Obese                   \\
\hline
\end{tabular}
\end{center}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap82}\raggedright\small
\NWtarget{nuweb29}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {29}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub bodyMassIndex {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($height, $day) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $day = 0 if !defined($day);@\\
\mbox{}\verb@        return 0 if $height == 0;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $n = $self->monthdays();@\\
\mbox{}\verb@        my $weight = 0;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($day <= 0) {@\\
\mbox{}\verb@            my $nd = 0;@\\
\mbox{}\verb@            for (my $i = 1; $i <= $n; $i++) {@\\
\mbox{}\verb@                if (defined($self->{weight}[$i]) && ($self->{weight}[$i])) {@\\
\mbox{}\verb@                    if ($day < 0) {@\\
\mbox{}\verb@                        $weight = $self->{trend}[$i];@\\
\mbox{}\verb@                        $nd = 1;@\\
\mbox{}\verb@                   } else {@\\
\mbox{}\verb@                        $weight += $self->{trend}[$i];@\\
\mbox{}\verb@                        $nd++;@\\
\mbox{}\verb@                    }@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            $weight /= $nd if $nd > 0;@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $weight = $self->{weight}[$day] if defined($self->{weight}[$day]);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $weight *= WEIGHT_CONVERSION->[$self->{log_unit}][WEIGHT_KILOGRAM];@\\
\mbox{}\verb@        return sprintf("%.1f", $weight / ($height / 100) ** 2);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@bodyMassIndex@\nobreak\ \NWlink{nuweb212a}{212a}.\item \NWtxtIdentsUsed\nobreak\  \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}, \verb@WEIGHT_KILOGRAM@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{FractionFlagged}

The {\tt fractionFlagged} method returns the fraction (between 0 and 1)
of the days in the log whose flag field are checked,

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap83}\raggedright\small
\NWtarget{nuweb30}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {30}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub fractionFlagged {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $n = $self->monthdays();@\\
\mbox{}\verb@        my $nf = 0;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        for (my $i = 1; $i <= $n; $i++) {@\\
\mbox{}\verb@            if ($self->{flag}[$i]) {@\\
\mbox{}\verb@                $nf++;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $nf / $n;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@fractionFlagged@\nobreak\ \NWlink{nuweb212a}{212a}.\item \NWtxtIdentsUsed\nobreak\  \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Save}

The {\tt save} method writes the log item to the already-open file handle
passed as the argument.  All archival information in the log is preserved
by a {\tt save} followed by a {\tt load}.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap84}\raggedright\small
\NWtarget{nuweb31}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {31}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub save {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($outfile) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   File format version number@\\
\mbox{}\verb@        print($outfile "$self->{version}\n");@\\
\mbox{}\verb@        #   Year, Month, Log unit@\\
\mbox{}\verb@        print($outfile "$self->{year},$self->{month},$self->{log_unit}\n");@\\
\mbox{}\verb@        #   Trend carry-forward, Last modification time@\\
\mbox{}\verb@        print($outfile "$self->{trend_carry_forward},$self->{last_modification_time}\n");@\\
\mbox{}\verb@        my $md = $self->monthdays();@\\
\mbox{}\verb@        #   Weight array@\\
\mbox{}\verb@        for (my $i = 1; $i <= $md; $i++) {@\\
\mbox{}\verb@            print($outfile (dnz($self->{weight}[$i]) ? $self->{weight}[$i] : ''));@\\
\mbox{}\verb@            print($outfile (($i < $md) ? ',' : "\n"));@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        #   Rung array@\\
\mbox{}\verb@        for (my $i = 1; $i <= $md; $i++) {@\\
\mbox{}\verb@            print($outfile (dnz($self->{rung}[$i]) ? $self->{rung}[$i] : ''));@\\
\mbox{}\verb@            print($outfile (($i < $md) ? ',' : "\n"));@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        #   Flag array@\\
\mbox{}\verb@        for (my $i = 1; $i <= $md; $i++) {@\\
\mbox{}\verb@            print($outfile (dnz($self->{flag}[$i]) ? $self->{flag}[$i] : ''));@\\
\mbox{}\verb@            print($outfile (($i < $md) ? ',' : "\n"));@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   Comments@\\
\mbox{}\verb@        print($outfile $self->encodeComments() . "\n");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@save@\nobreak\ \NWlink{nuweb113a}{113a}\NWlink{nuweb123}{, 123}\NWlink{nuweb151}{, 151}\NWlink{nuweb156b}{, 156b}\NWlink{nuweb159}{, 159}\NWlink{nuweb167}{, 167}\NWlink{nuweb170b}{, 170b}\NWlink{nuweb187}{, 187}\NWlink{nuweb220a}{, 220a}\NWlink{nuweb240a}{, 240a}\NWlink{nuweb248a}{, 248a}\NWlink{nuweb309}{, 309}\NWlink{nuweb320}{, 320}\NWlink{nuweb330}{, 330}\NWlink{nuweb395b}{, 395b}\NWlink{nuweb484b}{, 484b}.\item \NWtxtIdentsUsed\nobreak\  \verb@dnz@\nobreak\ \NWlink{nuweb42b}{42b}, \verb@encodeComments@\nobreak\ \NWlink{nuweb72}{72}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Load}

The {\tt load} reads a file from the argument file handle
in the format produced by {\tt save} and stores the values into
the monthly log object, which is assumed to be a new void object.  It
does not, for example, undefine existing values in the weight
array when those values are unspecified in the file being
loaded.  We start by validating the file version.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap85}\raggedright\small
\NWtarget{nuweb32a}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {32a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub load {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($infile) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $s = in($infile);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($s != FILE_VERSION) {@\\
\mbox{}\verb@            die("monthlog::load: Incompatible file version $s");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@load@\nobreak\ \NWlink{nuweb32b}{32b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb85}{, 85}\NWlink{nuweb101b}{, 101b}\NWlink{nuweb110}{, 110}\NWlink{nuweb112}{, 112}\NWlink{nuweb117}{, 117}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}\NWlink{nuweb160}{, 160}\NWlink{nuweb168}{, 168}\NWlink{nuweb171a}{, 171a}\NWlink{nuweb183}{, 183}\NWlink{nuweb184}{, 184}\NWlink{nuweb199}{, 199}\NWlink{nuweb205}{, 205}\NWlink{nuweb206}{, 206}\NWlink{nuweb210}{, 210}\NWlink{nuweb214}{, 214}\NWlink{nuweb236}{, 236}\NWlink{nuweb254}{, 254}\NWlink{nuweb255}{, 255}\NWlink{nuweb256}{, 256}\NWlink{nuweb257}{, 257}\NWlink{nuweb318}{, 318}\NWlink{nuweb319}{, 319}\NWlink{nuweb327}{, 327}\NWlink{nuweb329}{, 329}\NWlink{nuweb333}{, 333}\NWlink{nuweb335}{, 335}\NWlink{nuweb337}{, 337}\NWlink{nuweb338}{, 338}\NWlink{nuweb344}{, 344}\NWlink{nuweb393b}{, 393b}\NWlink{nuweb394}{, 394}\NWlink{nuweb461}{, 461}.\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}


\vbox{
\subsection{Parse year, month, and log unit}

The second record in the file gives the year and month this log
represents and the weight unit used within.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap86}\raggedright\small
\NWtarget{nuweb32b}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {32b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@        $s = in($infile);@\\
\mbox{}\verb@        $s =~ m/^(\d+),(\d+),(\d+)$/ || die("monthlog::load: Error parsing year, month, log unit");@\\
\mbox{}\verb@        $self->{year} = $1;@\\
\mbox{}\verb@        $self->{month} = $2;@\\
\mbox{}\verb@        $self->{log_unit} = $3;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Parse trend carry forward and last modification time}

The third record contains the trend value carried forward from the
previous log item (or zero if this is the first log in the
user database), and the \UNIX/ {\tt time} of the last modification
to the log.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap87}\raggedright\small
\NWtarget{nuweb33a}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {33a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@        $s = in($infile);@\\
\mbox{}\verb@        $s =~ m/^([\d\.]+),(\d+)$/ || die("monthlog::load: Error parsing trend carry forward, last modification time");@\\
\mbox{}\verb@        $self->{trend_carry_forward} = $1;@\\
\mbox{}\verb@        $self->{last_modification_time} = $2;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Parse daily weight array}

The fourth record contains the daily weight entries in the unit
given by the second record.  Weight entries are decimal numbers
separated by commas.  Unspecified entries are void.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap88}\raggedright\small
\NWtarget{nuweb33b}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {33b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@        my $md = $self->monthdays();@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $s = in($infile);@\\
\mbox{}\verb@        for (my $i = 1; $i <= $md; $i++) {@\\
\mbox{}\verb@            $s =~ s/^([\d\.]*),?// || die("monthlog::load: Error parsing weight for day $i");@\\
\mbox{}\verb@            if ($1 ne '') {@\\
\mbox{}\verb@                $self->{weight}[$i] = $1;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if ($s ne '') {@\\
\mbox{}\verb@            die("monthlog::load: Residual characters ($s) after parsing weights");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $self->computeTrend();      # Fill in daily trend now that weights are known@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsUsed\nobreak\  \verb@computeTrend@\nobreak\ \NWlink{nuweb28}{28}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Parse exercise rung array}

The fifth record gives the exercise rung for each day of the month, specified
as a number from 1 to \verb+RUNG_MAX+, separated by commas.  Blank entries are void.

It waw previously possible for a craftily coded CSV import to create a rung
value with one or more leading blanks, which would cause our strict parser to
fail.  To avoid application crashes from this, we ignore any blanks in the
rung record.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap89}\raggedright\small
\NWtarget{nuweb34a}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {34a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@        $s = in($infile);@\\
\mbox{}\verb@        $s =~ s/\s//g;@\\
\mbox{}\verb@        for (my $i = 1; $i <= $md; $i++) {@\\
\mbox{}\verb@            $s =~ s/^(\d*),?// || die("monthlog::load: Error parsing rung for day $i");@\\
\mbox{}\verb@            if ($1 ne '') {@\\
\mbox{}\verb@                $self->{rung}[$i] = $1;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if ($s ne '') {@\\
\mbox{}\verb@            die("monthlog::load: Residual characters ($s) after parsing rungs");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Parse flag array}

The sixth record specifies the general purpose flag items, which are the number
1 if the day is flagged and a void entry otherwise.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap90}\raggedright\small
\NWtarget{nuweb34b}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {34b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@        $s = in($infile);@\\
\mbox{}\verb@        for (my $i = 1; $i <= $md; $i++) {@\\
\mbox{}\verb@            $s =~ s/^(\d*),?// || die("monthlog::load: Error parsing flag for day $i");@\\
\mbox{}\verb@            if ($1 ne '') {@\\
\mbox{}\verb@                $self->{flag}[$i] = $1;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if ($s ne '') {@\\
\mbox{}\verb@            die("monthlog::load: Residual characters ($s) after parsing flags");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Parse comments}

Finally, the seventh record specifies the comments for days in the
month, if any, in the format created by {\tt encodeComments}.  This
format is optimised for the common case of identical comments for
multiple days in the month.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap91}\raggedright\small
\NWtarget{nuweb35a}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {35a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@        $s = in($infile);@\\
\mbox{}\verb@        $self->decodeComments($s);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Read line from persistent object file}\nobreak\ ({\footnotesize 35b\label{scrap92}
 }\mbox{}\verb@monthlog@ ) {\footnotesize \NWlink{nuweb413b}{413b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{ToHTML}

The {\tt toHTML} method generates an HTML table containing the data in the
current monthly log.  The first argument is the file handle to which the table
should be written.  The second and third arguments specify the range of days
which should be rendered as editable form fields rather than static data.
If an all-static table is desired, these arguments may be omitted or set
to zero.  If \verb+$browse_public+ is true, a completely static table
will be generated and no comments will be shown.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap93}\raggedright\small
\NWtarget{nuweb36}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {36}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub toHTML {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($fh, $efirst, $elast, $display_unit,@\\
\mbox{}\verb@            $decimal_character, $browse_public,@\\
\mbox{}\verb@            $printFriendly, $monochrome) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $efirst = 0 if !defined($efirst) || $printFriendly;@\\
\mbox{}\verb@        $elast = 0 if !defined($elast) || $printFriendly;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $printfix = ($printFriendly ? 'pr_' : '') . ($monochrome ? 'mo_' : '');@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $n = $self->monthdays();@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $logToDisplayUnit = WEIGHT_CONVERSION->[$self->{log_unit}][$display_unit];@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Write HTML table header}\nobreak\ {\footnotesize \NWlink{nuweb37a}{37a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $lastweight;@\\
\mbox{}\verb@        for ($lastweight = $n; $lastweight >= 1; $lastweight--) {@\\
\mbox{}\verb@            if (znd($self->{weight}[$lastweight])) {@\\
\mbox{}\verb@                last;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $wday = jd_to_weekday(gregorian_to_jd($self->{year}, $self->{month}, 1));@\\
\mbox{}\verb@        for (my $i = 1; $i <= $n; $i++) {@\\
\mbox{}\verb@            my $edit = (!$browse_public) && ($i >= $efirst) && ($i <= $elast);@\\
\mbox{}\verb@@\\
\mbox{}\verb@            print($fh "<tr>\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Generate date column}\nobreak\ {\footnotesize \NWlink{nuweb37b}{37b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Generate weight, trend, and variance columns}\nobreak\ {\footnotesize \NWlink{nuweb38}{38}}$\,\rangle$}\verb@@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Generate exercise rung column}\nobreak\ {\footnotesize \NWlink{nuweb39a}{39a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Generate flag column}\nobreak\ {\footnotesize \NWlink{nuweb39b}{39b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@            if (!$browse_public) {@\\
\mbox{}\verb@                @\hbox{$\langle\,${\itshape Generate comment column}\nobreak\ {\footnotesize \NWlink{nuweb40a}{40a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@@\\
\mbox{}\verb@            print($fh "</tr>\n");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Write HTML table footer}\nobreak\ {\footnotesize \NWlink{nuweb40b}{40b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@toHTML@\nobreak\ \NWlink{nuweb208}{208}.\item \NWtxtIdentsUsed\nobreak\  \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}, \verb@jd_to_weekday@\nobreak\ \NWlink{nuweb449a}{449a}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}, \verb@znd@\nobreak\ \NWlink{nuweb43b}{43b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Write HTML table header}

The HTML table header is written, along with the column
headings.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap94}\raggedright\small
\NWtarget{nuweb37a}{} $\langle\,${\itshape Write HTML table header}\nobreak\ {\footnotesize {37a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<table border="border" class="${printfix}mlog">@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@<th colspan="2">Date</th>@\\
\mbox{}\verb@<th>Weight</th>@\\
\mbox{}\verb@<th>Trend</th>@\\
\mbox{}\verb@<th>Var.</th>@\\
\mbox{}\verb@<th>Rung</th>@\\
\mbox{}\verb@<th>Flag</th>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (!$browse_public) {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<th>Comments</th>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb36}{36}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Generate date column}

The date (day within month and weekday abbreviation) is written
as the first column in the table.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap95}\raggedright\small
\NWtarget{nuweb37b}{} $\langle\,${\itshape Generate date column}\nobreak\ {\footnotesize {37b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print($fh "<th>$i</th>\n");     # Day@\\
\mbox{}\verb@    print($fh "<td>" . substr(WEEKDAY_NAMES->[$wday], 0, 3) . "</td>\n"); # Weekday@\\
\mbox{}\verb@    $wday = ($wday + 1) % 7;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb36}{36}.
\item \NWtxtIdentsUsed\nobreak\  \verb@WEEKDAY_NAMES@\nobreak\ \NWlink{nuweb445}{445}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Generate weight, trend, and variance columns}

The next three columns give that day's weight, the trend value, and
the colour-coded variance between the weight and trend.  The trend
is left blank for days between the last weight entry and the end
of the log, and the variance is displayed only for days with a
weight entered.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap96}\raggedright\small
\NWtarget{nuweb38}{} $\langle\,${\itshape Generate weight, trend, and variance columns}\nobreak\ {\footnotesize {38}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    # Weight@\\
\mbox{}\verb@    print($fh "<td>");@\\
\mbox{}\verb@    if ($edit) {@\\
\mbox{}\verb@        print($fh "<input type=\"text\" name=\"w$i\"  id=\"w$i\" size=\"6\" value=\"" .@\\
\mbox{}\verb@            wgt(znd($self->{weight}[$i]) * $logToDisplayUnit,@\\
\mbox{}\verb@                $display_unit, $decimal_character) .@\\
\mbox{}\verb@            "\" onchange=\"changeWeight($i);\" />" .@\\
\mbox{}\verb@        "<input type=\"hidden\" id=\"W$i\" value=\"" .@\\
\mbox{}\verb@        (znd($self->{weight}[$i]) ? fixo(znd($self->{weight}[$i]) * $logToDisplayUnit, 4)@\\
\mbox{}\verb@                                  : '') . "\" />");@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        print($fh wgt(znd($self->{weight}[$i]) * $logToDisplayUnit,@\\
\mbox{}\verb@            $display_unit, $decimal_character));@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    print($fh "</td>\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    # Trend@\\
\mbox{}\verb@    print($fh "<td id=\"t$i\">" .@\\
\mbox{}\verb@        wgt(($i > $lastweight) ? undef :@\\
\mbox{}\verb@            (znd($self->{trend}[$i]) * $logToDisplayUnit), $display_unit, $decimal_character, 1) .@\\
\mbox{}\verb@            "<input type=\"hidden\" id=\"T$i\" value=\"" . fixo(znd($self->{trend}[$i]) *@\\
\mbox{}\verb@            $logToDisplayUnit, 4) . "\" />" .@\\
\mbox{}\verb@        "</td>\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@     # Variance@\\
\mbox{}\verb@    my $var = (defined($self->{weight}[$i]) && defined($self->{trend}[$i]) &&@\\
\mbox{}\verb@                ($self->{weight}[$i] > 0) && ($self->{trend}[$i] > 0)) ?@\\
\mbox{}\verb@                    (($self->{weight}[$i] - $self->{trend}[$i]) * $logToDisplayUnit) : undef;@\\
\mbox{}\verb@    print($fh "<td class=\"r\"><span id=\"v$i\" class=\"" . $printfix .@\\
\mbox{}\verb@                 ((defined($var) && (sprintf("%.1f", $var) !~ m/^\-?0\.0$/)) ?@\\
\mbox{}\verb@                    (($var < 0) ? "g" : "r") : "bk") . "\">" .@\\
\mbox{}\verb@                    var($var, $decimal_character) . "</span></td>\n");@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb36}{36}.
\item \NWtxtIdentsUsed\nobreak\  \verb@changeWeight@\nobreak\ \NWlink{nuweb493a}{493a}, \verb@fixo@\nobreak\ \NWlink{nuweb43c}{43c}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}, \verb@wgt@\nobreak\ \NWlink{nuweb44a}{44a}, \verb@znd@\nobreak\ \NWlink{nuweb43b}{43b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Generate exercise rung column}

Next comes the exercise rung, a number between 1 and \verb+RUNG_MAX+, or blank
if no exercise was done that day.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap97}\raggedright\small
\NWtarget{nuweb39a}{} $\langle\,${\itshape Generate exercise rung column}\nobreak\ {\footnotesize {39a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print($fh "<td>");@\\
\mbox{}\verb@    if ($edit) {@\\
\mbox{}\verb@        print($fh "<input type=\"text\" name=\"r$i\" id=\"r$i\" size=\"3\" value=\"" .@\\
\mbox{}\verb@            bnd($self->{rung}[$i]) . "\" onchange=\"changeRung($i);\" />");@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        print($fh bnd($self->{rung}[$i]));@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    print($fh "</td>\n");@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb36}{36}.
\item \NWtxtIdentsUsed\nobreak\  \verb@bnd@\nobreak\ \NWlink{nuweb43a}{43a}, \verb@changeRung@\nobreak\ \NWlink{nuweb502}{502}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Generate flag column}

Following the exercise rung is the utility flag column, which is
shown as a check mark or blank.  All we do with the flag is show
the percentage of flagged days in the month.  If we're generating
a non-editable ``Printer friendly'' form, encode checked flags
in {\tt hidden} input fields so we don't lose them when the user
clicks the ``Update'' button.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap98}\raggedright\small
\NWtarget{nuweb39b}{} $\langle\,${\itshape Generate flag column}\nobreak\ {\footnotesize {39b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print($fh "<td>");@\\
\mbox{}\verb@    if ($edit) {@\\
\mbox{}\verb@        print($fh "<input type=\"checkbox\" name=\"f$i\" id=\"f$i\" onclick=\"updateFlag($i);\"" .@\\
\mbox{}\verb@            ($self->{flag}[$i] ? " checked=\"checked\"" : "") . " />");@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        if ($self->{flag}[$i]) {@\\
\mbox{}\verb@            print($fh "<input type=\"hidden\" name=\"f$i\" id=\"f$i\" value=\"checked\" />");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        print($fh $self->{flag}[$i] ? "&#10004;" : "");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    print($fh "</td>\n");@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb36}{36}.
\item \NWtxtIdentsUsed\nobreak\  \verb@updateFlag@\nobreak\ \NWlink{nuweb524b}{524b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Generate comment column}

Finally, we come to the comment, which is simply arbitrary text.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap99}\raggedright\small
\NWtarget{nuweb40a}{} $\langle\,${\itshape Generate comment column}\nobreak\ {\footnotesize {40a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print($fh "<td>");@\\
\mbox{}\verb@    my $cmt = quoteHTML(defined($self->{comment}[$i]) ? $self->{comment}[$i] : "");@\\
\mbox{}\verb@    if ($edit) {@\\
\mbox{}\verb@        print($fh "<input type=\"text\" name=\"c$i\" id=\"c$i\" size=\"60\" " .@\\
\mbox{}\verb@                  "maxlength=\"@\hbox{$\langle\,${\itshape Maximum Text Input Field Length}\nobreak\ {\footnotesize \NWlink{nuweb11c}{11c}}$\,\rangle$}\verb@\" " .@\\
\mbox{}\verb@                  "value=\"$cmt\" onchange=\"changeComment($i);\" />");@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        print($fh $cmt);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    print($fh "</td>\n");@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb36}{36}.
\item \NWtxtIdentsUsed\nobreak\  \verb@changeComment@\nobreak\ \NWlink{nuweb504}{504}, \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Write HTML table footer}

Close the current HTML table.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap100}\raggedright\small
\NWtarget{nuweb40b}{} $\langle\,${\itshape Write HTML table footer}\nobreak\ {\footnotesize {40b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@</table>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb36}{36}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Format weight to display unit}

The {\tt editWeight} function returns a string with its first weight
argument formatted appropriate for the display unit specified by
the second argument.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap101}\raggedright\small
\NWtarget{nuweb41a}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {41a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub editWeight {@\\
\mbox{}\verb@        my ($weight, $unit, $dchar) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $dchar = '.' if !defined($dchar);@\\
\mbox{}\verb@        my $sgn = ($weight < 0) ? "-" : "";@\\
\mbox{}\verb@        my $w = abs($weight);@\\
\mbox{}\verb@        my $sw;@\\
\mbox{}\verb@        if ($unit == WEIGHT_STONE) {@\\
\mbox{}\verb@            $sw = sprintf("%s%d %2.1f", $sgn, int($w / 14), $w - (int($w / 14) * 14));@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $sw = sprintf("%s%.1f", $sgn, $w);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $sw =~ s/\./$dchar/;@\\
\mbox{}\verb@        return $sw;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@editWeight@\nobreak\ \NWlink{nuweb44a}{44a}\NWlink{nuweb55}{, 55}\NWlink{nuweb93}{, 93}\NWlink{nuweb103b}{, 103b}\NWlink{nuweb268}{, 268}\NWlink{nuweb274}{, 274}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb488b}{, 488b}\NWlink{nuweb489}{, 489}\NWlink{nuweb497}{, 497}\NWlink{nuweb498}{, 498}\NWlink{nuweb507}{, 507}.\item \NWtxtIdentsUsed\nobreak\  \verb@sgn@\nobreak\ \NWlink{nuweb405}{405}, \verb@WEIGHT_STONE@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Convert weight from one unit to another}

The {\tt convertWeight} function converts the
\verb+$weight+ argument in the \verb+$from+ unit to a weight
in the \verb+$to+ units.  If is perfectly valid to call this
function with the same from and to units; this has the salutary
effect of converting the value into canonical form.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap102}\raggedright\small
\NWtarget{nuweb41b}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {41b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub convertWeight {@\\
\mbox{}\verb@        my ($weight, $from, $to) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $weight = canonicalWeight($weight * WEIGHT_CONVERSION->[$from][$to]);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $weight;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@convertWeight@\nobreak\ \NWlink{nuweb57}{57}.\item \NWtxtIdentsUsed\nobreak\  \verb@canonicalWeight@\nobreak\ \NWlink{nuweb42a}{42a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Express weight in canonical form}

The {\tt canonicalWeight} function expresses a weight quantity
in our canonical form of at most two decimal places, with trailing
zero decimal places removed, and no decimal if the value is integral.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap103}\raggedright\small
\NWtarget{nuweb42a}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {42a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub canonicalWeight {@\\
\mbox{}\verb@        my ($weight) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $weight = sprintf("%.2f", $weight);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $weight =~ s/(\.[^0]*)0+$/$1/;@\\
\mbox{}\verb@        $weight =~ s/\.$//;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $weight;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@canonicalWeight@\nobreak\ \NWlink{nuweb41b}{41b}\NWlink{nuweb396}{, 396}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{HTML generation utility functions}

The following little functions simplify generating
HTML from fields in the log.
}

\vbox{
\subsubsection{Test if defined and nonzero}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap104}\raggedright\small
\NWtarget{nuweb42b}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {42b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub dnz {@\\
\mbox{}\verb@        my ($s) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return defined($s) && ($s > 0);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@dnz@\nobreak\ \NWlink{nuweb31}{31}\NWlink{nuweb46}{, 46}\NWlink{nuweb49}{, 49}\NWlink{nuweb50}{, 50}\NWlink{nuweb54}{, 54}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Return null string if not defined or zero}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap105}\raggedright\small
\NWtarget{nuweb43a}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {43a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub bnd {@\\
\mbox{}\verb@        my ($s) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return (defined($s) && ($s > 0)) ? $s : '';@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@bnd@\nobreak\ \NWlink{nuweb39a}{39a}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Return zero if not defined}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap106}\raggedright\small
\NWtarget{nuweb43b}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {43b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub znd {@\\
\mbox{}\verb@        my ($s) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return (defined($s) && ($s > 0)) ? $s : 0;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@znd@\nobreak\ \NWlink{nuweb36}{36}\NWlink{nuweb38}{, 38}\NWlink{nuweb57}{, 57}\NWlink{nuweb60}{, 60}\NWlink{nuweb61}{, 61}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb67}{, 67}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Format as fixed point decimal}

The first argument is formatted as a fixed point quantity
with the number of decimal places given by the second.
Trailing zeroes in the decimal part are discarded, as
well as trailing decimal points on integral quantities.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap107}\raggedright\small
\NWtarget{nuweb43c}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {43c}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub fixo {@\\
\mbox{}\verb@        my ($v, $places) = @{\tt @}\verb@_;@\\
\mbox{}\verb@        my $s = sprintf("%.${places}f", $v);@\\
\mbox{}\verb@        $s =~ s/0+$//;@\\
\mbox{}\verb@        $s =~ s/\.$//;@\\
\mbox{}\verb@        return $s;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@fixo@\nobreak\ \NWlink{nuweb38}{38}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Format as weight}

The first argument is formatted as a weight in the unit given by the
second or blank if not defined.  The third argument specifies the user's
preferred decimal separator character.  If the fourth argument is nonzero,
``\verb+&nbsp;+'' will be generated as a place-holder if the field is
void.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap108}\raggedright\small
\NWtarget{nuweb44a}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {44a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub wgt {@\\
\mbox{}\verb@        my ($s, $dunit, $dchar, $nbsp) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return (defined($s) && ($s > 0)) ? editWeight($s, $dunit, $dchar) :@\\
\mbox{}\verb@            ($nbsp ? '&nbsp;' : '');@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@wgt@\nobreak\ \NWlink{nuweb38}{38}.\item \NWtxtIdentsUsed\nobreak\  \verb@editWeight@\nobreak\ \NWlink{nuweb41a}{41a}\NWlink{nuweb485a}{, 485a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Format as variance}

The argument is formatted as a signed weight variance, or
blank if not defined.  Zeroes are output without a sign.  Note
that the HTML ``\verb+&minus;+'' sign is used for negative
quantities, and consequently these numbers cannot be directly
parsed by Perl.  The second argument specifies the user's
preferred decimal separator character,

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap109}\raggedright\small
\NWtarget{nuweb44b}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {44b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub var {@\\
\mbox{}\verb@        my ($s, $dchar) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $v;@\\
\mbox{}\verb@        if (defined($s)) {@\\
\mbox{}\verb@            $v =  (($s < 0) ? "&minus;" : "+") . sprintf("%.1f", abs($s));@\\
\mbox{}\verb@            $v = '0.0' if $v =~ m/\D0\.0$/;@\\
\mbox{}\verb@            $v =~ s/\./$dchar/;@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $v = '&nbsp;';@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return $v;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@var@\nobreak\ \NWlink{nuweb38}{38}\NWlink{nuweb430b}{, 430b}\NWlink{nuweb481}{, 481}\NWlink{nuweb482}{, 482}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb488b}{, 488b}\NWlink{nuweb489}{, 489}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb493b}{b}\NWlink{nuweb494}{, 494}\NWlink{nuweb495}{, 495}\NWlink{nuweb496}{, 496}\NWlink{nuweb497}{, 497}\NWlink{nuweb498}{, 498}\NWlink{nuweb499}{, 499}\NWlink{nuweb500}{, 500}\NWlink{nuweb501}{, 501}\NWlink{nuweb502}{, 502}\NWlink{nuweb503}{, 503}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb508}{, 508}\NWlink{nuweb509b}{, 509b}\NWlink{nuweb510b}{, 510b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb517}{, 517}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb527}{, 527}\NWlink{nuweb528}{, 528}\NWlink{nuweb529b}{, 529b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{computeChartScale}

The {\tt computeChartScale} method is used to obtain the $X$ and $Y$ scale
factors for the chart embedded in a monthly log document.  These are used
by the JavaScript code to plot entries made in log on the chart.  The
method re-uses the code of the actual chart plotter ({\tt plotChart}, below)
to auto-scale the plot, and then simply returns a string with the
relevant scale factors suitable for embedding in a hidden form field
of the chart document.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap110}\raggedright\small
\NWtarget{nuweb45}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {45}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub computeChartScale {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($width, $height, $display_unit, $dietcalc) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $width = 640 if !defined($width);@\\
\mbox{}\verb@        $height = 480 if !defined($height);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $logToDisplayUnit = WEIGHT_CONVERSION->[$self->{log_unit}][$display_unit];@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Define chart geometry}\nobreak\ {\footnotesize \NWlink{nuweb48a}{48a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Determine scale for weight and trend plot}\nobreak\ {\footnotesize \NWlink{nuweb50}{50}, \ldots\ }$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $bX . ',' .@\\
\mbox{}\verb@               sprintf("%.4f", $pixelsPerDay) . ',' .@\\
\mbox{}\verb@               $bY . ',' .@\\
\mbox{}\verb@               $weightMin . ',' .@\\
\mbox{}\verb@               ($extentY - ($bottomMargin + $topMargin)) . ',' .@\\
\mbox{}\verb@               sprintf("%.4f", $weightMax - $weightMin) . ',' .@\\
\mbox{}\verb@               RUNG_MAX;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@computeChartScale@\nobreak\ \NWlink{nuweb212a}{212a}.\item \NWtxtIdentsUsed\nobreak\  \verb@RUNG_MAX@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{plotChart}

The {\tt plotChart} method writes a PNG chart for the data in the month
on the file handle specified by the first argument.  The second and third
arguments specify the width and height of the chart.  The output file
defaults to {\tt STDOUT}, and the width and height default to 640 by 480
pixels if omitted.  The chart is scaled and labeled with the
\verb+$display_unit+ given by the argument.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap111}\raggedright\small
\NWtarget{nuweb46}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {46}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub plotChart {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($outfile, $width, $height, $display_unit, $dchar,@\\
\mbox{}\verb@            $dietcalc, $printFriendly, $monochrome) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (!(defined $outfile)) {@\\
\mbox{}\verb@            $outfile = \*STDOUT;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $width = 640 if !defined($width);@\\
\mbox{}\verb@        $height = 480 if !defined($height);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $logToDisplayUnit = WEIGHT_CONVERSION->[$self->{log_unit}][$display_unit];@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Define chart geometry}\nobreak\ {\footnotesize \NWlink{nuweb48a}{48a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $img = new GD::Image($width, $height);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $img->interlaced('true');@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Allocate colours for chart}\nobreak\ {\footnotesize \NWlink{nuweb47}{47}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $img->filledRectangle($leftMargin + (-$axisOffset) + 1, $topMargin,@\\
\mbox{}\verb@                        $leftMargin + ($pixelsPerDay * ($self->monthdays() - 1)),@\\
\mbox{}\verb@                            $topMargin + ($extentY - ($topMargin + $bottomMargin)) + ($axisOffset + 1), $grey);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $lday = 0;@\\
\mbox{}\verb@        for (my $i = $self->monthdays(); $i >= 1; $i--) {@\\
\mbox{}\verb@            if (dnz($self->{weight}[$i])) {@\\
\mbox{}\verb@                $lday = $i;@\\
\mbox{}\verb@                last;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Draw axes for chart and label date axis}\nobreak\ {\footnotesize \NWlink{nuweb48b}{48b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Plot exercise rung information}\nobreak\ {\footnotesize \NWlink{nuweb49}{49}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Determine scale for weight and trend plot}\nobreak\ {\footnotesize \NWlink{nuweb50}{50}, \ldots\ }$\,\rangle$}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Plot the diet plan if defined and requested}\nobreak\ {\footnotesize \NWlink{nuweb53a}{53a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        if ($lday > 0) {@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Plot weight trend line on chart}\nobreak\ {\footnotesize \NWlink{nuweb53b}{53b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Plot weight entries as floats and sinkers}\nobreak\ {\footnotesize \NWlink{nuweb54}{54}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Label weight axis}\nobreak\ {\footnotesize \NWlink{nuweb55}{55}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print($outfile $img->png());@\\
\mbox{}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@plotChart@\nobreak\ \NWlink{nuweb263a}{263a}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}.\item \NWtxtIdentsUsed\nobreak\  \verb@dnz@\nobreak\ \NWlink{nuweb42b}{42b}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\subsection{Plotting sparse data}

\label{Plotting sparse data}
The weight and exercise rung data we plot in charts may be
arbitrarily sparse---the user may have failed to record the
weight, the date may be in the future or before the user
began logging, and the user may have skipped exercise one
or more days.  All of the items we plot are discrete quantities:
they have meaning only at the time they were measured, so
plotting them on a line graph is simply a convenience which
makes them easier to visualise.  Here are the conventions we use
to plot lines through potentially sparse data points.

\begin{enumerate}
    \item   Today's point is defined.\\
            Call its co-ordinates $(cx, cy)$.

        \begin{enumerate}
            \item   Yesterday's point is defined ($ly\neq -1$).\\
                    Plot a line from its co-ordinates $(lx,ly)$ to
                    $(cx,cy)$. Set $(lx, ly)=(cx, cy)$.
            \item   Yesterday's point is not defined ($ly=-1$).
                \begin{enumerate}
                    \item   This is the last day in the chart.\\
                            Let $lx$ be the $X$ co-ordinate of the
                            next to last day in the chart.  Plot a
                            line from $(lx,cy)$ to $(cx,cy)$.
                    \item   This is not the last day in the chart.\\
                            Set $(lx, ly)=(cx, cy)$.
                 \end{enumerate}
        \end{enumerate}

    \item   Today's point is absent.\\
            Call its $X$ co-ordinate $cx$.
        \begin{enumerate}
            \item   Yesterday's point is defined ($ly\neq -1$).\\
                    Plot a line from $(lx,ly$) to $(cx,$ly).
                    Set $(lx,ly)=(-1,-1)$.
            \item   Yesterday's point is not defined ($ly=-1$).\\
                    Do nothing.
        \end{enumerate}
\end{enumerate}

\vbox{
\subsection{Allocate colours for chart}

We use an indexed-palette image format for the charts.  Here we
allocate the colours we're going to use, noting that the first
one we allocate automatically becomes the background colour
for the image.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap112}\raggedright\small
\NWtarget{nuweb47}{} $\langle\,${\itshape Allocate colours for chart}\nobreak\ {\footnotesize {47}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    #   First colour allocated is background@\\
\mbox{}\verb@    my $white =  $img->colorAllocate(255, 255, 255);@\\
\mbox{}\verb@    my $grey = ($printFriendly || $monochrome) ?@\\
\mbox{}\verb@                    $white :@\\
\mbox{}\verb@                    $img->colorAllocate(160, 160, 160);@\\
\mbox{}\verb@    my $black =  $img->colorAllocate(  0,   0,   0);@\\
\mbox{}\verb@    my $red =    $monochrome ? $black : $img->colorAllocate(255,   0,   0);@\\
\mbox{}\verb@    my $green =  $monochrome ? $black : $img->colorAllocate(  0, 255,   0);@\\
\mbox{}\verb@    my $yellow = $monochrome ? $black : ($printFriendly ?@\\
\mbox{}\verb@        $img->colorAllocate(192, 192,   0) : $img->colorAllocate(255, 255,   0));@\\
\mbox{}\verb@    my $blue =   $monochrome ? $black : $img->colorAllocate(  0,   0, 255);@\\
\mbox{}\verb@    my $dkgrey = $img->colorAllocate(128, 128, 128);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb46}{46}\NWlink{nuweb82}{, 82}\NWlink{nuweb101b}{, 101b}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Define chart geometry}

The following variables specify the layout of items within the
chart.  They are basically twiddle knobs which are adjusted in
the interest of appearance.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap113}\raggedright\small
\NWtarget{nuweb48a}{} $\langle\,${\itshape Define chart geometry}\nobreak\ {\footnotesize {48a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my ($fontLineHeight, $fontCharHeight) = (20, 10);@\\
\mbox{}\verb@    my ($leftMargin, $rightMargin, $topMargin, $bottomMargin) =@\\
\mbox{}\verb@        ($fontCharHeight * (($display_unit == WEIGHT_STONE) ? 6 : 5),@\\
\mbox{}\verb@        $fontCharHeight * 3, 10, $fontCharHeight * 3);@\\
\mbox{}\verb@    my ($axisOffset, $tickSize, $sinkerSize) = (3, 5, 4);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my ($topLeftX, $topLeftY) = (0, 0);@\\
\mbox{}\verb@    my ($extentX, $extentY) = ($width, $height);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $pixelsPerDay = ($extentX - ($leftMargin + $rightMargin)) / ($self->monthdays() - 1);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my ($bX, $bY) = ($topLeftX + $leftMargin, (($topLeftY + $extentY) - $bottomMargin));@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb45}{45}\NWlink{nuweb46}{, 46}.
\item \NWtxtIdentsUsed\nobreak\  \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}, \verb@WEIGHT_STONE@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Draw axes for chart and label date axis}


\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap114}\raggedright\small
\NWtarget{nuweb48b}{} $\langle\,${\itshape Draw axes for chart and label date axis}\nobreak\ {\footnotesize {48b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    #   X axis@\\
\mbox{}\verb@    $img->line($bX - $axisOffset, $bY + $axisOffset + 1,@\\
\mbox{}\verb@               $bX + ($pixelsPerDay * ($self->monthdays() - 1)), $bY + $axisOffset + 1, $black);@\\
\mbox{}\verb@    #   Y axis@\\
\mbox{}\verb@    $img->line($bX - $axisOffset, $bY + $axisOffset + 1,@\\
\mbox{}\verb@               $bX - $axisOffset, $bY - ($extentY - (($topMargin + $bottomMargin))), $black);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   Date axis labels@\\
\mbox{}\verb@    for (my $i = 0; $i < $self->monthdays(); $i += 3) {@\\
\mbox{}\verb@        main::drawText($img, $i + 1, 'Times', 12, 0,@\\
\mbox{}\verb@            $topLeftX + $leftMargin + ($pixelsPerDay * $i),@\\
\mbox{}\verb@            (($topLeftY + $extentY) - ($bottomMargin - $topMargin)), 'c', 't', $black);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   Ticks on date axis@\\
\mbox{}\verb@    for (my $i = 1; $i < $self->monthdays(); $i++) {@\\
\mbox{}\verb@        $img->line($bX + ($pixelsPerDay * $i), $bY + $axisOffset,@\\
\mbox{}\verb@                   $bX + ($pixelsPerDay * $i), ($bY + $axisOffset) - $tickSize, $black);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb46}{46}.
\item \NWtxtIdentsUsed\nobreak\  \verb@drawText@\nobreak\ \NWlink{nuweb409}{409}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Plot exercise rung information}

If the log contains any exercise rung entries, plot the rung information
for the month and draw the rung scale at the right of the chart.  This
code uses the algorithm for plotting sparse data described in
section \ref{Plotting sparse data} above.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap115}\raggedright\small
\NWtarget{nuweb49}{} $\langle\,${\itshape Plot exercise rung information}\nobreak\ {\footnotesize {49}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $lrung;@\\
\mbox{}\verb@    my ($lx, $ly) = (-1, -1);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $i = 1; $i <= $self->monthdays(); $i++) {@\\
\mbox{}\verb@        if (dnz($self->{rung}[$i])) {@\\
\mbox{}\verb@            my $rt = $self->{rung}[$i];@\\
\mbox{}\verb@            $lrung = $rt;@\\
\mbox{}\verb@@\\
\mbox{}\verb@            my ($cx, $cy) = ($bX + ($pixelsPerDay * ($i - 1)),@\\
\mbox{}\verb@                ($bY - int((($rt - 1) * ($extentY - ($bottomMargin + $topMargin))) / RUNG_MAX)));@\\
\mbox{}\verb@@\\
\mbox{}\verb@            if ($ly >= 0) {@\\
\mbox{}\verb@                 $img->line($lx, $ly, $cx, $cy, $blue);@\\
\mbox{}\verb@                 ($lx, $ly) = ($cx, $cy);@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                if ($i == $self->monthdays()) {@\\
\mbox{}\verb@                    $lx = $bX + ($pixelsPerDay * ($i - 2));@\\
\mbox{}\verb@                    $img->line($lx, $cy, $cx, $cy, $blue);@\\
\mbox{}\verb@                } else {@\\
\mbox{}\verb@                    ($lx, $ly) = ($cx, $cy);@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            if ($ly >= 0) {@\\
\mbox{}\verb@                my $cx = $bX + ($pixelsPerDay * ($i - 1));@\\
\mbox{}\verb@                $img->line($lx, $ly, $cx, $ly, $blue);@\\
\mbox{}\verb@                ($lx, $ly) = (-1, -1);@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   Draw labels for exercise rung scale@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($lrung) {@\\
\mbox{}\verb@        $img->line($bX + ($pixelsPerDay * ($self->monthdays() - 1)),@\\
\mbox{}\verb@                   $bY + $axisOffset + 1,@\\
\mbox{}\verb@                   $bX + ($pixelsPerDay * ($self->monthdays() - 1)),@\\
\mbox{}\verb@                   $bY - ($extentY - (($topMargin + $bottomMargin))), $black);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        for (my $i = 1; $i <= RUNG_MAX; $i = (int($i / 6) * 6) + 6) {@\\
\mbox{}\verb@            main::drawText($img, $i, 'Times', 12, 0,@\\
\mbox{}\verb@                $bX + ($pixelsPerDay * ($self->monthdays() - 1)) + 8,@\\
\mbox{}\verb@                $bY - (int((($i - 1) * ($extentY - ($bottomMargin + $topMargin))) / RUNG_MAX)), 'l', 'c', $black);@\\
\mbox{}\verb@            if ($i > 1) {@\\
\mbox{}\verb@                $img->line($bX + ($pixelsPerDay * ($self->monthdays() - 1)) - $tickSize,@\\
\mbox{}\verb@                           $bY - int((($i - 1) * ($extentY - ($bottomMargin + $topMargin))) / RUNG_MAX),@\\
\mbox{}\verb@                           $bX + ($pixelsPerDay * ($self->monthdays() - 1)),@\\
\mbox{}\verb@                           $bY - int((($i - 1) * ($extentY - ($bottomMargin + $topMargin))) / RUNG_MAX), $black);@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb46}{46}.
\item \NWtxtIdentsUsed\nobreak\  \verb@dnz@\nobreak\ \NWlink{nuweb42b}{42b}, \verb@drawText@\nobreak\ \NWlink{nuweb409}{409}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}, \verb@RUNG_MAX@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Determine scale for weight and trend plot}

Scan the weight and trend entries for the month and determine
extrema.  These are then used to automatically scale the
weight and trend plot to fit on the chart.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap116}\raggedright\small
\NWtarget{nuweb50}{} $\langle\,${\itshape Determine scale for weight and trend plot}\nobreak\ {\footnotesize {50}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my ($weightMin, $weightMax) = (1e308, 0);@\\
\mbox{}\verb@    my ($trendMin, $trendMax) = (1e308, 0);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $i = 1; $i <= $self->monthdays(); $i++) {@\\
\mbox{}\verb@         if (dnz($self->{weight}[$i])) {@\\
\mbox{}\verb@            $weightMax = max($weightMax, $self->{weight}[$i] * $logToDisplayUnit);@\\
\mbox{}\verb@            $weightMin = min($weightMin, $self->{weight}[$i] * $logToDisplayUnit);@\\
\mbox{}\verb@            $trendMax = max($trendMax, $self->{trend}[$i] * $logToDisplayUnit);@\\
\mbox{}\verb@            $trendMin = min($trendMin, $self->{trend}[$i] * $logToDisplayUnit);@\\
\mbox{}\verb@         }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $weightMin = min($weightMin, $trendMin);@\\
\mbox{}\verb@    $weightMax = max($weightMax, $trendMax);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($self->{trend_carry_forward} > 0) {@\\
\mbox{}\verb@        $weightMin = min($weightMin, $self->{trend_carry_forward} * $logToDisplayUnit);@\\
\mbox{}\verb@        $weightMax = max($weightMax, $self->{trend_carry_forward} * $logToDisplayUnit);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Compute diet plan extrema on chart}\nobreak\ {\footnotesize \NWlink{nuweb52}{52}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    if ($plan_start_day > 0) {@\\
\mbox{}\verb@        $weightMin = min($weightMin, min($plan_start_weight, $plan_end_weight));@\\
\mbox{}\verb@        $weightMax = max($weightMax, max($plan_start_weight, $plan_end_weight));@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   If no weights at all have been specified, scale the chart to encompass@\\
\mbox{}\verb@    #   the union of the 5% to 95% percentile points of adult males and females@\\
\mbox{}\verb@    #   as published at:    http://www.halls.md/chart/height-weight.htm@\\
\mbox{}\verb@    if ($weightMin > $weightMax) {@\\
\mbox{}\verb@        if ($display_unit == WEIGHT_KILOGRAM) {@\\
\mbox{}\verb@            $weightMin = 40;@\\
\mbox{}\verb@            $weightMax = 120;@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $weightMin = 100;@\\
\mbox{}\verb@            $weightMax = 265;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        #   Provide a buffer zone around extrema for new entries@\\
\mbox{}\verb@        $weightMax += (($display_unit == WEIGHT_KILOGRAM) ?@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Monthly Log Weight Range in Kilograms}\nobreak\ {\footnotesize \NWlink{nuweb5b}{5b}}$\,\rangle$}\verb@ :@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Monthly Log Weight Range in Pounds}\nobreak\ {\footnotesize \NWlink{nuweb5c}{5c}}$\,\rangle$}\verb@) / 2;@\\
\mbox{}\verb@        $weightMin -= (($display_unit == WEIGHT_KILOGRAM) ?@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Monthly Log Weight Range in Kilograms}\nobreak\ {\footnotesize \NWlink{nuweb5b}{5b}}$\,\rangle$}\verb@ :@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Monthly Log Weight Range in Pounds}\nobreak\ {\footnotesize \NWlink{nuweb5c}{5c}}$\,\rangle$}\verb@) / 2;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $maxLabelRows = int(($extentY - ($topMargin + $bottomMargin)) / $fontLineHeight);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb50}{50}\NWlink{nuweb51}{, 51}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb45}{45}\NWlink{nuweb46}{, 46}.
\item \NWtxtIdentsUsed\nobreak\  \verb@dnz@\nobreak\ \NWlink{nuweb42b}{42b}, \verb@max@\nobreak\ \NWlink{nuweb405}{405}, \verb@min@\nobreak\ \NWlink{nuweb405}{405}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}, \verb@WEIGHT_KILOGRAM@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{

Find a display scale power and factor which permits
a suitable number of labels on the weight axis.  We do
this using units like a vintage Tektronix oscilloscope:
increasing powers of 1, 2, and 5.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap117}\raggedright\small
\NWtarget{nuweb51}{} $\langle\,${\itshape Determine scale for weight and trend plot}\nobreak\ {\footnotesize {51}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $factor = 0;@\\
\mbox{}\verb@    my $vunit = 1;@\\
\mbox{}\verb@    my $power = 1;@\\
\mbox{}\verb@    my @{\tt @}\verb@factors = (1, 2, 5);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $weightMin *= 10;@\\
\mbox{}\verb@    $weightMax *= 10;@\\
\mbox{}\verb@    $weightMin = int($weightMin);@\\
\mbox{}\verb@    $weightMax = int($weightMax);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    while (int(($weightMax - ($weightMin - ($weightMin % $vunit))) / ($factors[$factor] * $power)) > $maxLabelRows) {@\\
\mbox{}\verb@        $factor++;@\\
\mbox{}\verb@        if ($factor > 2) {@\\
\mbox{}\verb@            $factor = 0;@\\
\mbox{}\verb@            $power *= 10;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $vunit = $factors[$factor] * $power;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   There's no point using a finer-grained unit than we@\\
\mbox{}\verb@    #   plot decimal places for weight.@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (($vunit < 10) && ($self->{log_unit} == WEIGHT_STONE)) {@\\
\mbox{}\verb@        $vunit = 10;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    if (($vunit < 100) && ($self->{log_unit} == WEIGHT_STONE)) {@\\
\mbox{}\verb@        $vunit = 100;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   Round weight unit minimum to even unit multiple@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $weightMin -= $weightMin % $vunit;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   Offset by one unit at top and bottom to avoid collision@\\
\mbox{}\verb@    #   with axes.@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $weightMin -= $vunit;@\\
\mbox{}\verb@    $weightMax += $vunit;@\\
\mbox{}\verb@    $weightMin /= 10;@\\
\mbox{}\verb@    $weightMax /= 10;@\\
\mbox{}\verb@    $vunit /= 10;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb50}{50}\NWlink{nuweb51}{, 51}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb45}{45}\NWlink{nuweb46}{, 46}.
\item \NWtxtIdentsUsed\nobreak\  \verb@Round@\nobreak\ \NWlink{nuweb405}{405}, \verb@WEIGHT_STONE@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Compute diet plan extrema on chart}

If the user has established a diet plan and requested that it be plotted
in charts, determine the segment of the plan which falls within this
chart.  There are three possibilities.  If the plan starts after the end
of this chart, we plot nothing.  If the plan begins during the period
of this chart, we plot from the beginning of the plan to the end of
the month.  If the plan ends within this month, we plot a flat line
from the date of the end of the plan to the end of the month, on the
assumption that the user intends to maintain the goal weight of the
plan after its accomplishment.

Note that the start and goal weight for the diet plan are always
kept in kilograms in the {\tt user} object, so we convert them to
the display weight unit being used in the chart here.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap118}\raggedright\small
\NWtarget{nuweb52}{} $\langle\,${\itshape Compute diet plan extrema on chart}\nobreak\ {\footnotesize {52}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    #   Julian day of start and end of month@\\
\mbox{}\verb@    my ($mjdstart, $mjdend) = (gregorian_to_jd($self->{year}, $self->{month}, 1),@\\
\mbox{}\verb@        gregorian_to_jd($self->{year}, $self->{month}, $self->monthdays()));@\\
\mbox{}\verb@    my ($pjdstart, $pjdend) = (max($mjdstart, $$dietcalc[0]), min($mjdend, $$dietcalc[2]));@\\
\mbox{}\verb@    my ($plan_start_day, $plan_start_weight,@\\
\mbox{}\verb@        $plan_end_day, $plan_end_weight) = (-1) x 4;@\\
\mbox{}\verb@    if (defined($$dietcalc[0])) {@\\
\mbox{}\verb@        #   If plan starts before the end of the month, we shall plot it@\\
\mbox{}\verb@        if ($pjdstart <= $mjdend) {@\\
\mbox{}\verb@            if ($$dietcalc[2] <= $mjdstart) {@\\
\mbox{}\verb@                #   Plan ends before start of month; plot flat line at end weight@\\
\mbox{}\verb@                $plan_start_day = 1;@\\
\mbox{}\verb@                $plan_end_day = $self->monthdays();@\\
\mbox{}\verb@                $plan_start_weight = $plan_end_weight = $$dietcalc[3] *@\\
\mbox{}\verb@                    WEIGHT_CONVERSION->[WEIGHT_KILOGRAM][$display_unit];@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                (undef, undef, $plan_start_day) = jd_to_gregorian($pjdstart);@\\
\mbox{}\verb@                (undef, undef, $plan_end_day) = jd_to_gregorian($pjdend);@\\
\mbox{}\verb@                $plan_start_weight = $$dietcalc[1] + (($$dietcalc[3] - $$dietcalc[1]) *@\\
\mbox{}\verb@                    (($pjdstart - $$dietcalc[0]) / ($$dietcalc[2] - $$dietcalc[0])));@\\
\mbox{}\verb@                $plan_end_weight = $$dietcalc[1] + (($$dietcalc[3] - $$dietcalc[1]) *@\\
\mbox{}\verb@                    (($pjdend - $$dietcalc[0]) / ($$dietcalc[2] - $$dietcalc[0])));@\\
\mbox{}\verb@                $plan_start_weight *= WEIGHT_CONVERSION->[WEIGHT_KILOGRAM][$display_unit];@\\
\mbox{}\verb@                $plan_end_weight *= WEIGHT_CONVERSION->[WEIGHT_KILOGRAM][$display_unit];@\\
\mbox{}\verb@@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb50}{50}.
\item \NWtxtIdentsUsed\nobreak\  \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}, \verb@jd_to_gregorian@\nobreak\ \NWlink{nuweb448}{448}, \verb@Julian@\nobreak\ \NWlink{nuweb445}{445}, \verb@max@\nobreak\ \NWlink{nuweb405}{405}, \verb@min@\nobreak\ \NWlink{nuweb405}{405}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}, \verb@start@\nobreak\ \NWlink{nuweb19b}{19b}, \verb@WEIGHT_KILOGRAM@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Plot the diet plan if defined and requested}

If a segment of the diet plan appears within this chart, plot
it.  If the plan ends within this month, draw a flat line at the
goal weight from the end of the plan to the last day in the month.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap119}\raggedright\small
\NWtarget{nuweb53a}{} $\langle\,${\itshape Plot the diet plan if defined and requested}\nobreak\ {\footnotesize {53a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($plan_start_day > 0) {@\\
\mbox{}\verb@        my $sy = int((($plan_start_weight - $weightMin) *@\\
\mbox{}\verb@            ($extentY - ($bottomMargin + $topMargin))) / ($weightMax - $weightMin));@\\
\mbox{}\verb@        my $ey = int((($plan_end_weight - $weightMin) *@\\
\mbox{}\verb@            ($extentY - ($bottomMargin + $topMargin))) / ($weightMax - $weightMin));@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $img->setStyle($yellow, $yellow, $yellow, $yellow,@\\
\mbox{}\verb@                       gdTransparent, gdTransparent, gdTransparent, gdTransparent);@\\
\mbox{}\verb@        $img->line($bX + ($pixelsPerDay * ($plan_start_day - 1)), $bY - $sy,@\\
\mbox{}\verb@                   $bX + ($pixelsPerDay * ($plan_end_day - 1)), $bY - $ey, gdStyled);@\\
\mbox{}\verb@        if ($plan_end_day < $self->monthdays()) {@\\
\mbox{}\verb@            $img->line($bX + ($pixelsPerDay * ($plan_end_day - 1)), $bY - $ey,@\\
\mbox{}\verb@                       $bX + ($pixelsPerDay * ($self->monthdays() - 1)), $bY - $ey, gdStyled);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb46}{46}.
\item \NWtxtIdentsUsed\nobreak\  \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Plot weight trend line on chart}

The weight trend is plotted as a solid red line.

%% FIXME  --  DO NOT PLOT TREND IF BEFORE START OR PAST END OF
%% DATA IN DATABASE.


\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap120}\raggedright\small
\NWtarget{nuweb53b}{} $\langle\,${\itshape Plot weight trend line on chart}\nobreak\ {\footnotesize {53b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $i = 1; $i < $lday; $i++) {@\\
\mbox{}\verb@        my $oy = int(((($self->{trend}[$i] * $logToDisplayUnit) - $weightMin) *@\\
\mbox{}\verb@            ($extentY - ($bottomMargin + $topMargin))) / ($weightMax - $weightMin));@\\
\mbox{}\verb@        my $ny = int(((($self->{trend}[$i + 1] * $logToDisplayUnit) - $weightMin) *@\\
\mbox{}\verb@            ($extentY - ($bottomMargin + $topMargin))) / ($weightMax - $weightMin));@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $img->line($bX + ($pixelsPerDay * ($i - 1)), $bY - $oy,@\\
\mbox{}\verb@                   $bX + ($pixelsPerDay * $i), $bY - $ny, $red);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb46}{46}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Plot weight entries as floats and sinkers}

Individual weight log entries are plotted as blue diamonds, filled with
yellow if the date is flagged and white otherwise.  If the weight
is above or below the trend line for that day, a green line is drawn
to connect it to the trend and indicate whether the day's weight
is a ``float'' pulling the trend up or a ``sinker'' dragging it down.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap121}\raggedright\small
\NWtarget{nuweb54}{} $\langle\,${\itshape Plot weight entries as floats and sinkers}\nobreak\ {\footnotesize {54}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $i = 1; $i <= $self->monthdays(); $i++) {@\\
\mbox{}\verb@         if (dnz($self->{weight}[$i])) {@\\
\mbox{}\verb@            my $px = $pixelsPerDay * ($i - 1);@\\
\mbox{}\verb@            my $ty = int(((($self->{trend}[$i] * $logToDisplayUnit) - $weightMin) *@\\
\mbox{}\verb@                        ($extentY - ($bottomMargin + $topMargin))) / ($weightMax - $weightMin));@\\
\mbox{}\verb@            my $wy = int(((($self->{weight}[$i] * $logToDisplayUnit) - $weightMin) *@\\
\mbox{}\verb@                        ($extentY - ($bottomMargin + $topMargin))) / ($weightMax - $weightMin));@\\
\mbox{}\verb@            my $offset = $wy - $ty;@\\
\mbox{}\verb@@\\
\mbox{}\verb@            if (($offset < -$sinkerSize) || ($offset > $sinkerSize)) {@\\
\mbox{}\verb@                 my $dy = sgn($offset);@\\
\mbox{}\verb@@\\
\mbox{}\verb@                $img->line($bX + $px, $bY - ($ty + $dy),@\\
\mbox{}\verb@                           $bX + $px, $bY - ($wy + (($offset > 0) ? -$sinkerSize : $sinkerSize)), $green);@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@@\\
\mbox{}\verb@            #   Fill float/sinker with white or yellow, if it's flagged.@\\
\mbox{}\verb@@\\
\mbox{}\verb@            for (my $j = -$sinkerSize; $j <= $sinkerSize; $j++) {@\\
\mbox{}\verb@                my $dx = abs($j) - $sinkerSize;@\\
\mbox{}\verb@@\\
\mbox{}\verb@                $img->line($bX + $px - $dx, $bY - ($wy + $j),@\\
\mbox{}\verb@                           $bX + $px + $dx, $bY - ($wy + $j),@\\
\mbox{}\verb@                           $self->{flag}[$i] ? $yellow : $white);@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@@\\
\mbox{}\verb@            #   Trace the outline of the float/sinker in blue@\\
\mbox{}\verb@@\\
\mbox{}\verb@            $img->line($bX + $px - $sinkerSize, $bY - $wy,@\\
\mbox{}\verb@                       $bX + $px, $bY - ($wy - $sinkerSize), $blue);@\\
\mbox{}\verb@            $img->line($bX + $px, $bY - ($wy - $sinkerSize),@\\
\mbox{}\verb@                       $bX + $px + $sinkerSize, $bY - $wy, $blue);@\\
\mbox{}\verb@            $img->line($bX + $px + $sinkerSize, $bY - $wy,@\\
\mbox{}\verb@                       $bX + $px, $bY - ($wy + $sinkerSize), $blue);@\\
\mbox{}\verb@            $img->line($bX + $px, $bY - ($wy + $sinkerSize),@\\
\mbox{}\verb@                       $bX + $px - $sinkerSize, $bY - $wy, $blue);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb46}{46}.
\item \NWtxtIdentsUsed\nobreak\  \verb@dnz@\nobreak\ \NWlink{nuweb42b}{42b}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}, \verb@sgn@\nobreak\ \NWlink{nuweb405}{405}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Label weight axis}

Draw the labels for the weight axis, according to the scale
determined above.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap122}\raggedright\small
\NWtarget{nuweb55}{} $\langle\,${\itshape Label weight axis}\nobreak\ {\footnotesize {55}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $plotw = $weightMin; int($plotw * 10 + 0.5) <= int($weightMax * 10 + 0.5); $plotw += $vunit) {@\\
\mbox{}\verb@        my $wy = int((($plotw - $weightMin) *@\\
\mbox{}\verb@                    ($extentY - ($bottomMargin + $topMargin))) / ($weightMax - $weightMin));@\\
\mbox{}\verb@        main::drawText($img, editWeight($plotw, $display_unit, $dchar), 'Times', 12, 0,@\\
\mbox{}\verb@            $leftMargin - 8, $bY - $wy, 'r', 'c', $black);@\\
\mbox{}\verb@        if ($plotw > $weightMin) {@\\
\mbox{}\verb@            $img->line($bX - $axisOffset, $bY - $wy,@\\
\mbox{}\verb@                       $bX + (-$axisOffset + $tickSize), $bY - $wy, $black);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@#print("$plotw $wy\n");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb46}{46}.
\item \NWtxtIdentsUsed\nobreak\  \verb@drawText@\nobreak\ \NWlink{nuweb409}{409}, \verb@editWeight@\nobreak\ \NWlink{nuweb41a}{41a}\NWlink{nuweb485a}{, 485a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{updateFromCGI}

The {\tt updateFromCGI} method is called with a reference to a hash
containing the arguments submitted via a CGI request containing a
monthly log table generated by {\tt toHTML}.  The fields in the hash
are examined and any changes from the current state of the log are
applied.  A list is returned containing, as the first element, the
total number of changes made, followed by the number of changes to
weights, runs, flags, and comments respectively.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap123}\raggedright\small
\NWtarget{nuweb56}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {56}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub updateFromCGI {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($h) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($change_weight, $change_rung, $change_flag, $change_comment) = (0, 0, 0, 0);@\\
\mbox{}\verb@        my $days = $self->monthdays();@\\
\mbox{}\verb@@\\
\mbox{}\verb@        for (my $d = 1; $d <= $days; $d++) {@\\
\mbox{}\verb@            my $k;@\\
\mbox{}\verb@@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Apply changes to weight}\nobreak\ {\footnotesize \NWlink{nuweb57}{57}}$\,\rangle$}\verb@@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Apply changes to exercise rung}\nobreak\ {\footnotesize \NWlink{nuweb60}{60}}$\,\rangle$}\verb@@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Apply changes to flag}\nobreak\ {\footnotesize \NWlink{nuweb61}{61}}$\,\rangle$}\verb@@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Apply changes to comment}\nobreak\ {\footnotesize \NWlink{nuweb62}{62}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $changes = $change_weight + $change_rung + $change_flag + $change_comment;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return ($changes, $change_weight, $change_rung, $change_flag, $change_comment);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@updateFromCGI@\nobreak\ \NWlink{nuweb219}{219}.\item \NWtxtIdentsUsed\nobreak\  \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Apply changes to weight}

The following code applies any changes the user has made to
items in the weight column.  It must cope with the user's having
specified weights in stones and pounds (while entries in the
weight array are pounds, even when the unit it set to stones),
and differences in the display and log units for weight.  We
determine the display unit for this log from the hidden
``{\tt du}'' field placed in the update form submitted by the
user.  We allow either the period or comma as a decimal character.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap124}\raggedright\small
\NWtarget{nuweb57}{} $\langle\,${\itshape Apply changes to weight}\nobreak\ {\footnotesize {57}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    $k = "w$d";@\\
\mbox{}\verb@    if (defined($$h{$k})) {@\\
\mbox{}\verb@        my $w = $$h{$k};@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $w =~ s/,/./g;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Expand weight entry if abbreviated}\nobreak\ {\footnotesize \NWlink{nuweb58}{58}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $w =~ s/[^\d\s\.]//g;@\\
\mbox{}\verb@        $w =~ s/^\s+//;@\\
\mbox{}\verb@        $w =~ s/\s+$//;@\\
\mbox{}\verb@        #   If specification is stones and pounds, convert to pounds@\\
\mbox{}\verb@        if (($w ne '') && ($$h{du} == WEIGHT_STONE)) {@\\
\mbox{}\verb@            if ($w =~ m/\s*(\d+)\s+([\d\.]+)/) {@\\
\mbox{}\verb@                $w = ($1 * 14) + $2;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($w ne '') {@\\
\mbox{}\verb@            $w = convertWeight($w, $$h{du}, $self->{log_unit});@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (($w eq '') && (znd($self->{weight}[$d]) != 0)) {@\\
\mbox{}\verb@            undef($self->{weight}[$d]);@\\
\mbox{}\verb@            $change_weight++;@\\
\mbox{}\verb@        } elsif (($w ne '') && ($w ne znd($self->{weight}[$d]))) {@\\
\mbox{}\verb@            $self->{weight}[$d] = $w;@\\
\mbox{}\verb@            $change_weight++;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb56}{56}.
\item \NWtxtIdentsUsed\nobreak\  \verb@convertWeight@\nobreak\ \NWlink{nuweb41b}{41b}, \verb@WEIGHT_STONE@\nobreak\ \NWlink{nuweb24}{24}, \verb@znd@\nobreak\ \NWlink{nuweb43b}{43b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Expand weight entry if abbreviated}

The user may abbreviate a weight entry in a variety of forms,
ranging from a single period which copies the most recent
entry, replacing the decimal place or last digit and decimal
place, to Byzantine complexity of abbreviated entries in stones
and pounds described in section \ref{Abbreviated stones} below.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap125}\raggedright\small
\NWtarget{nuweb58}{} $\langle\,${\itshape Expand weight entry if abbreviated}\nobreak\ {\footnotesize {58}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $wa = $w;@\\
\mbox{}\verb@    $wa =~ s/^\s+//;@\\
\mbox{}\verb@    $wa =~ s/\s+$//;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (($$h{du} == WEIGHT_STONE) && ($wa !~ m/\d*\.\d*/)) {@\\
\mbox{}\verb@        $wa = '';@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (($wa eq '.') || ($wa =~ m/^\.\d+$/) ||@\\
\mbox{}\verb@            ($wa =~ m/^\d(\.\d*)?$/) ||@\\
\mbox{}\verb@            (($$h{du} == WEIGHT_STONE) && ($wa =~ m/^\d\d\.\d*$/))) {@\\
\mbox{}\verb@        my $p = 0;@\\
\mbox{}\verb@        my $lw;@\\
\mbox{}\verb@        for (my $j = $d - 1; $j >= 1; $j--) {@\\
\mbox{}\verb@            if (defined($$h{"w$j"}) && ($$h{"w$j"} =~ m/^\d/)) {@\\
\mbox{}\verb@                $lw = $$h{"w$j"};@\\
\mbox{}\verb@                $lw =~ s/,/./g;@\\
\mbox{}\verb@                $p = 1;@\\
\mbox{}\verb@                last;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($p) {@\\
\mbox{}\verb@            if ($wa eq '.') {@\\
\mbox{}\verb@                $w = $lw;@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                if ($$h{du} == WEIGHT_STONE) {@\\
\mbox{}\verb@                    @\hbox{$\langle\,${\itshape Expand weight entry in stones and pounds}\nobreak\ {\footnotesize \NWlink{nuweb59}{59}}$\,\rangle$}\verb@@\\
\mbox{}\verb@                } else {@\\
\mbox{}\verb@                    if ($wa =~ m/^\.\d+$/) {@\\
\mbox{}\verb@                        $w = int($lw) + $wa;@\\
\mbox{}\verb@                    } elsif ($wa =~ m/^\d(\.\d*)?$/) {@\\
\mbox{}\verb@                        $w = (int($lw / 10) * 10) + $wa;@\\
\mbox{}\verb@                    }@\\
\mbox{}\verb@                    $$h{$k} = $w;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb57}{57}.
\item \NWtxtIdentsUsed\nobreak\  \verb@WEIGHT_STONE@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Expand weight entry in stones and pounds}

\label{Abbreviated stones}
When the weight unit is set to stones an abbreviation may be used to
change the pounds and decimal place of the previous stone and pound
display just as when the units are pounds. In addition, when the
display unit is set to stones, if the previous entry has a pounds
field between 10 and 13 and the user enters a single digit, decimal
character, and optional decimal digit, the action taken depends on the
units digit entered.  If it's between 0 and 3, it replaces the last
digit of the pounds in the last entry, but if the digit is 4 or
greater (which is invalid in a stones and pounds display), that digit
replaces the two digit pounds field in the previous entry.  This
reduces the scribbling required when the weight happens to fluctuate
around {\em X} stones 10.  In addition, when the display unit is
stones, the user can enter two digits followed by the decimal
character and an optional decimal digit to replace the pounds field of
the last stones and pounds entry; the decimal character must be
entered to distinguish the entry from one denoting an even number of
stones.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap126}\raggedright\small
\NWtarget{nuweb59}{} $\langle\,${\itshape Expand weight entry in stones and pounds}\nobreak\ {\footnotesize {59}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    $lw =~ m/^(\d+)\s+(\d*\.?\d*)$/;@\\
\mbox{}\verb@    my ($stones, $pounds) = ($1, $2);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($pounds >= 10) {@\\
\mbox{}\verb@        if ($wa < 4) {@\\
\mbox{}\verb@            if ($wa =~ m/^\.\d+$/) {@\\
\mbox{}\verb@                $pounds = int($pounds) + $wa;@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                $pounds = ((int($pounds  / 10)) * 10) + $wa;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $pounds = $wa;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        if ($wa =~ m/^\.\d+$/) {@\\
\mbox{}\verb@            $pounds = int($pounds) + $wa;@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $pounds = $wa;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    $w = "$stones $pounds";@\\
\mbox{}\verb@    $$h{$k} = $w;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb58}{58}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Apply changes to exercise rung}

Apply any changes the user has made in the exercise rung column
to the rung array.  Rung numbers are constrained to the range
1--\verb+RUNG_MAX+, with blank indicating no entry for the day.

A single period for the rung causes the most recent non-blank rung
to be copied into the field; if none exists, the period is discarded
and the rung left blank.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap127}\raggedright\small
\NWtarget{nuweb60}{} $\langle\,${\itshape Apply changes to exercise rung}\nobreak\ {\footnotesize {60}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    $k = $$h{"r$d"};@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (defined($k) && ($k =~ m/^\s*([\.,\+\-])\s*$/)) {@\\
\mbox{}\verb@        my $cop = $1;@\\
\mbox{}\verb@        for (my $j = $d - 1; $j >= 1; $j--) {@\\
\mbox{}\verb@            if (defined($$h{"r$j"}) && ($$h{"r$j"} ne '')) {@\\
\mbox{}\verb@                $k = $$h{"r$j"};@\\
\mbox{}\verb@                $k++ if $cop eq '+';@\\
\mbox{}\verb@                $k-- if $cop eq '-';@\\
\mbox{}\verb@                last;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (defined($k)) {@\\
\mbox{}\verb@        $k =~ s/\D//g;          #   Delete non-digit characters@\\
\mbox{}\verb@        if ($k =~ m/^\d/) {@\\
\mbox{}\verb@            $k = 1 if $k < 1;@\\
\mbox{}\verb@            $k = RUNG_MAX if $k > RUNG_MAX;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $$h{"r$d"} = $k;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (($k eq '') && (znd($self->{rung}[$d]) != 0)) {@\\
\mbox{}\verb@            undef($self->{rung}[$d]);@\\
\mbox{}\verb@            $change_rung++;@\\
\mbox{}\verb@        } elsif (($k ne '') && ($k ne znd($self->{rung}[$d]))) {@\\
\mbox{}\verb@            $self->{rung}[$d] = $k;@\\
\mbox{}\verb@            $change_rung++;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb56}{56}.
\item \NWtxtIdentsUsed\nobreak\  \verb@RUNG_MAX@\nobreak\ \NWlink{nuweb24}{24}, \verb@znd@\nobreak\ \NWlink{nuweb43b}{43b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Apply changes to flag}

If the state of the utility flag for the day has changed,
update the item in the flag array.  Because flags are checkboxes,
and browsers to not usually send unchecked values, we
have to handle the case where the user has unchecked a flag
which was previously set in the database.  For each undefined
flag, we test if the flag for the corresponding day is set
and, if so, clear it.  We also include a test for notional
eccentric browsers which send unchecked boxes with a blank
value field, just in case.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap128}\raggedright\small
\NWtarget{nuweb61}{} $\langle\,${\itshape Apply changes to flag}\nobreak\ {\footnotesize {61}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (defined($$h{"f$d"})) {@\\
\mbox{}\verb@        $k = $$h{"f$d"};@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (($k eq '') && (znd($self->{flag}[$d]) != 0)) {@\\
\mbox{}\verb@            undef($self->{flag}[$d]);@\\
\mbox{}\verb@            $change_flag++;@\\
\mbox{}\verb@        } elsif (($k ne '') && (znd($self->{flag}[$d]) == 0)) {@\\
\mbox{}\verb@            $self->{flag}[$d] = 1;@\\
\mbox{}\verb@            $change_flag++;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        if (znd($self->{flag}[$d]) != 0) {@\\
\mbox{}\verb@            undef($self->{flag}[$d]);@\\
\mbox{}\verb@            $change_flag++;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb56}{56}.
\item \NWtxtIdentsUsed\nobreak\  \verb@znd@\nobreak\ \NWlink{nuweb43b}{43b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Apply changes to comment}

Apply any changes the user has made in the comment column.
Anything goes as a comment, except that trailing white space
is automatically deleted unless the comment consists of just a
period followed by white space.  To keep this from being confused with
a ditto in a static update, this case is canonicalised as a
period followed by a single space.

A field with a single period causes the most recent non-blank comment
to be copied into this field.  If there is no previous item, the
period is simply left in place, and may serve to ditto a
comment for a previous day when it is entered.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap129}\raggedright\small
\NWtarget{nuweb62}{} $\langle\,${\itshape Apply changes to comment}\nobreak\ {\footnotesize {62}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (defined($$h{"c$d"})) {@\\
\mbox{}\verb@        $k = $$h{"c$d"};@\\
\mbox{}\verb@        if (($k eq '.') || ($k eq ',')) {@\\
\mbox{}\verb@            for (my $j = $d - 1; $j >= 1; $j--) {@\\
\mbox{}\verb@                if (defined($$h{"c$j"}) && ($$h{"c$j"} ne '')) {@\\
\mbox{}\verb@                    $k = $$h{"c$j"};@\\
\mbox{}\verb@                    $$h{"c$d"} = $k;@\\
\mbox{}\verb@                    last;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if ($k =~ m/^\.\s+$/) {@\\
\mbox{}\verb@            $k = '. ';@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $k =~ s/\s+$//;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if (($k eq '') && defined($self->{comment}[$d])) {@\\
\mbox{}\verb@            undef($self->{comment}[$d]);@\\
\mbox{}\verb@            $change_comment++;@\\
\mbox{}\verb@        } elsif (($k ne '') &&@\\
\mbox{}\verb@            ((!defined($self->{comment}[$d])) || ($k ne $self->{comment}[$d]))) {@\\
\mbox{}\verb@            $self->{comment}[$d] = $k;@\\
\mbox{}\verb@            $change_comment++;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb56}{56}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{ImportCSV}

The {\tt importCSV} method extracts fields from a strictly compliant
extended CSV file of the form created by our {\tt hdCSV} module and
inserts them into the object arrays for the specified day, first
verifying that the month and year specified in the record actually
agree with those for this log.  Non-CSV records (defined as those
which do not contain an ISO-8601 YYYY-MM-DD date) are ignored. The
return value is 0 if the record was ignored, 1 if it was inserted into
the log.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap130}\raggedright\small
\NWtarget{nuweb63}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {63}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub importCSV {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $s = shift;@\\
\mbox{}\verb@        my ($date, $weight, $rung, $flag, $comment) = parseCSV($s);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   Ignore any line without a strictly compliant date@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($date =~ m/^(\d\d\d\d)\-(\d\d)\-(\d\d)$/) {@\\
\mbox{}\verb@            my ($yy, $mm, $dd) = ($1, $2, $3);@\\
\mbox{}\verb@            if (($yy != $self->{year}) ||@\\
\mbox{}\verb@                ($mm != $self->{month}) ||@\\
\mbox{}\verb@                ($dd < 1) || ($dd > $self->monthdays())) {@\\
\mbox{}\verb@                die("Bogus CSV import date for $self->{year}-$self->{month}: $date");@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            $weight =~ s/\s//g;@\\
\mbox{}\verb@            $self->{weight}[$dd] = $weight if ($weight ne '');@\\
\mbox{}\verb@            $rung =~ s/\s//g;@\\
\mbox{}\verb@            $self->{rung}[$dd] = $rung if ($rung ne '');@\\
\mbox{}\verb@            $flag =~ s/\s//g;@\\
\mbox{}\verb@            $self->{flag}[$dd] = $flag if ($flag ne '');@\\
\mbox{}\verb@            $self->{comment}[$dd] = $comment if ($comment ne '');@\\
\mbox{}\verb@            return 1;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return 0;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@importCSV@\nobreak\ \NWlink{nuweb239}{239}.\item \NWtxtIdentsUsed\nobreak\  \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}, \verb@parseCSV@\nobreak\ \NWlink{nuweb16}{16}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{ExportCSV}

The {\tt exportCSV} method writes the monthly log to a CSV
file on the file handle given by the first argument ({\tt STDOUT}
if it is omitted) in a format strongly reminiscent of that used
by {\tt hdread}, but extended to handle Unicode and non-graphic
characters as defined in our {\tt hdCSV} package.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap131}\raggedright\small
\NWtarget{nuweb64}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {64}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub exportCSV {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($fh) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@Date,Weight,Rung,Flag,Comment\r@\\
\mbox{}\verb@StartTrend,$self->{trend_carry_forward},$self->{log_unit},$self->{last_modification_time},$self->{last_modification_time},@\hbox{$\langle\,${\itshape CSV Format version}\nobreak\ {\footnotesize \NWlink{nuweb4c}{4c}}$\,\rangle$}\verb@\r@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@        for (my $i = 1; $i <= $self->monthdays(); $i++) {@\\
\mbox{}\verb@            my $csv = encodeCSV(sprintf("%04d-%02d-%02d", $self->{year}, $self->{month}, $i),@\\
\mbox{}\verb@                                bnd($self->{weight}[$i]),@\\
\mbox{}\verb@                                bnd($self->{rung}[$i]),@\\
\mbox{}\verb@                                znd($self->{flag}[$i]),@\\
\mbox{}\verb@                                (defined($self->{comment}[$i]) ? $self->{comment}[$i] : ''));@\\
\mbox{}\verb@            print($fh "$csv\r\n");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@exportCSV@\nobreak\ \NWlink{nuweb248b}{248b}\NWlink{nuweb255}{, 255}.\item \NWtxtIdentsUsed\nobreak\  \verb@bnd@\nobreak\ \NWlink{nuweb43a}{43a}, \verb@encodeCSV@\nobreak\ \NWlink{nuweb17}{17}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}, \verb@znd@\nobreak\ \NWlink{nuweb43b}{43b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{ExportHDReadCSV}

The {\tt ExportHDReadCSV} method exports a monthly log to the file handle
argument in the format used by the Palm Eat Watch desktop utility
{\tt hdread}.  This is very similar to our own native format, but it
does not support Unicode characters and uses Excel-style quoting and
escaping of string fields.

macros.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap132}\raggedright\small
\NWtarget{nuweb65}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {65}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub exportHDReadCSV {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($fh) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $tcf = sprintf("%.4f", znd($self->{trend_carry_forward}));@\\
\mbox{}\verb@        my $wu = ucfirst(WEIGHT_UNITS->[$self->{log_unit}]) . 's';@\\
\mbox{}\verb@        my $mon = $::monthNames[$self->{month}];@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@Date,Weight,Rung,Flag,Comment@\\
\mbox{}\verb@StartTrend,$tcf,$self->{log_unit},$self->{last_modification_time},$self->{last_modification_time}@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        for (my $i = 1; $i <= $self->monthdays(); $i++) {@\\
\mbox{}\verb@            my $cmt = '';@\\
\mbox{}\verb@            if (defined($self->{comment}[$i])) {@\\
\mbox{}\verb@                $cmt = $self->{comment}[$i];@\\
\mbox{}\verb@                $cmt =~  s/([\x{00}-\x{1F}-\x{80}-\x{9F}\x{100}-\x{FFFF}])/sprintf("&#x%x;", ord($1))/eg;@\\
\mbox{}\verb@                $cmt =~ s/"/""/g;@\\
\mbox{}\verb@                if ($cmt =~ m/[\s",]/) {@\\
\mbox{}\verb@                    $cmt = '"' . $cmt . '"';@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            print($fh sprintf("%04d-%02d-%02d", $self->{year}, $self->{month}, $i) . ',' .@\\
\mbox{}\verb@                      bnd($self->{weight}[$i]) . ',' .@\\
\mbox{}\verb@                      bnd($self->{rung}[$i]) . ',' .@\\
\mbox{}\verb@                      znd($self->{flag}[$i]) . ',' .@\\
\mbox{}\verb@                      $cmt . "\n");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@exportHDReadCSV@\nobreak\ \NWlink{nuweb256}{256}.\item \NWtxtIdentsUsed\nobreak\  \verb@bnd@\nobreak\ \NWlink{nuweb43a}{43a}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}, \verb@WEIGHT_UNITS@\nobreak\ \NWlink{nuweb24}{24}, \verb@znd@\nobreak\ \NWlink{nuweb43b}{43b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{ExportExcelCSV}

The {\tt ExportExcelCSV} method writes the monthly log to a CSV
file on the file handle given by the first argument ({\tt STDOUT}
if it is omitted) in a format compatible (via cut and paste into a
pre-created yearly log template) with the legacy Excel Eat Watch
macros.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap133}\raggedright\small
\NWtarget{nuweb66}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {66}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub exportExcelCSV {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($fh) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Obtain trend carry-forward for Excel CSV}\nobreak\ {\footnotesize \NWlink{nuweb67}{67}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $wu = ucfirst(WEIGHT_UNITS->[$self->{log_unit}]) . 's';@\\
\mbox{}\verb@        my $mon = $::monthNames[$self->{month}];@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@Date,,Weight,Trend,Variance,,Rung,Flag\r@\\
\mbox{}\verb@,,,,,,,\r@\\
\mbox{}\verb@,,$wu,,$mon $self->{year},,,\r@\\
\mbox{}\verb@Trend carry forward:,,,$tcf,,,,\r@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $wd = jd_to_weekday(gregorian_to_jd($self->{year}, $self->{month}, 1));@\\
\mbox{}\verb@@\\
\mbox{}\verb@        for (my $i = 1; $i <= $self->monthdays(); $i++) {@\\
\mbox{}\verb@            my $cmt = '';@\\
\mbox{}\verb@            if (defined($self->{comment}[$i])) {@\\
\mbox{}\verb@                $cmt = $self->{comment}[$i];@\\
\mbox{}\verb@                $cmt =~  s/([\x{00}-\x{1F}-\x{80}-\x{9F}\x{100}-\x{FFFF}])/sprintf("&#x%x;", ord($1))/eg;@\\
\mbox{}\verb@                $cmt =~ s/"/""/g;@\\
\mbox{}\verb@                $cmt = '"' . $cmt . '"';@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@@\\
\mbox{}\verb@            print($fh sprintf("%d/%d/%02d", $self->{month}, $i, $self->{year} % 100) . ',' .@\\
\mbox{}\verb@                WEEKDAY_NAMES->[$wd] . ',' .@\\
\mbox{}\verb@                ((bnd($self->{weight}[$i]) eq '') ? (($cmt eq '') ? '---' : $cmt) : sprintf("%.1f", $self->{weight}[$i])) . ',' .@\\
\mbox{}\verb@                ((bnd($self->{trend}[$i]) eq '') ? '' : sprintf("%.1f", $self->{trend}[$i])) . ',' .@\\
\mbox{}\verb@                sprintf("%.2f", znd($self->{weight}[$i]) - znd($self->{trend}[$i])) . ',' .@\\
\mbox{}\verb@                sprintf("%.1f", $tcf) . ',' .@\\
\mbox{}\verb@                bnd($self->{rung}[$i]) . ',' .@\\
\mbox{}\verb@                (znd($self->{flag}[$i]) ? '1' : ''). "\r\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@            $wd = ($wd + 1) % 7;@\\
\mbox{}\verb@            if (znd($self->{trend}[$i])) {@\\
\mbox{}\verb@                $tcf = $self->{trend}[$i];@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@exportExcelCSV@\nobreak\ \NWlink{nuweb257}{257}.\item \NWtxtIdentsUsed\nobreak\  \verb@bnd@\nobreak\ \NWlink{nuweb43a}{43a}, \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}, \verb@jd_to_weekday@\nobreak\ \NWlink{nuweb449a}{449a}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}, \verb@WEEKDAY_NAMES@\nobreak\ \NWlink{nuweb445}{445}, \verb@WEIGHT_UNITS@\nobreak\ \NWlink{nuweb24}{24}, \verb@znd@\nobreak\ \NWlink{nuweb43b}{43b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Obtain trend carry-forward for Excel CSV}

CSV format doesn't understand our convention of zero
denoting no trend carryforward.  We fill in an unspecified
trend carryforward with the first specified weight in
the month.  The trend cary-forward is rounded to two decimal
places.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap134}\raggedright\small
\NWtarget{nuweb67}{} $\langle\,${\itshape Obtain trend carry-forward for Excel CSV}\nobreak\ {\footnotesize {67}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $tcf = $self->{trend_carry_forward};@\\
\mbox{}\verb@    if ($tcf == 0) {@\\
\mbox{}\verb@        for (my $i = 1; $i <= $self->monthdays(); $i++) {@\\
\mbox{}\verb@            if (znd($self->{weight}[$i])) {@\\
\mbox{}\verb@                $tcf = $self->{weight}[$i];@\\
\mbox{}\verb@                last;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    $tcf = sprintf("%.2f", $tcf);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb66}{66}.
\item \NWtxtIdentsUsed\nobreak\  \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}, \verb@znd@\nobreak\ \NWlink{nuweb43b}{43b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{ExportXML}

The {\tt exportXML} method writes the monthly log as an XML {\tt
monthlog} element on the file handle given by the first argument ({\tt
STDOUT}. The character encoding of the XML is UTF-8, and it is the
responsibility of the caller to ensure that the file handle has that
output discipline in effect.  The caller is assumed to have already
established the structure of the XML file to which the log will be
appended.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap135}\raggedright\small
\NWtarget{nuweb68}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {68}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub exportXML {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($fh, $safe) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $wu = WEIGHT_UNITS->[$self->{log_unit}];@\\
\mbox{}\verb@        my $lm = timeXML($self->{last_modification_time});@\\
\mbox{}\verb@        my $nd = $self->monthdays();@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@    <monthlog version="1.0">@\\
\mbox{}\verb@        <properties>@\\
\mbox{}\verb@            <year>$self->{year}</year>@\\
\mbox{}\verb@            <month>$self->{month}</month>@\\
\mbox{}\verb@            <weight-unit>$wu</weight-unit>@\\
\mbox{}\verb@            <trend-carry-forward>$self->{trend_carry_forward}</trend-carry-forward>@\\
\mbox{}\verb@            <last-modified>$lm</last-modified>@\\
\mbox{}\verb@        </properties>@\\
\mbox{}\verb@        <days ndays="$nd">@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@        for (my $i = 1; $i <= $self->monthdays(); $i++) {@\\
\mbox{}\verb@            my $sweight = textXML('weight', bnd($self->{weight}[$i]), $safe);@\\
\mbox{}\verb@            my $srung = textXML('rung', bnd($self->{rung}[$i]), $safe);@\\
\mbox{}\verb@            my $sflag = textXML('flag', bnd($self->{flag}[$i]), $safe);@\\
\mbox{}\verb@            my $scomment = textXML('comment', (defined($self->{comment}[$i]) ? $self->{comment}[$i] : ''), $safe);@\\
\mbox{}\verb@@\\
\mbox{}\verb@            print $fh <<"EOD";@\\
\mbox{}\verb@            <day>@\\
\mbox{}\verb@                <date>$i</date>@\\
\mbox{}\verb@                $sweight@\\
\mbox{}\verb@                $srung@\\
\mbox{}\verb@                $sflag@\\
\mbox{}\verb@                $scomment@\\
\mbox{}\verb@            </day>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@        </days>@\\
\mbox{}\verb@    </monthlog>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@exportXML@\nobreak\ \NWlink{nuweb249}{249}\NWlink{nuweb254}{, 254}.\item \NWtxtIdentsUsed\nobreak\  \verb@bnd@\nobreak\ \NWlink{nuweb43a}{43a}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}, \verb@textXML@\nobreak\ \NWlink{nuweb442b}{442b}, \verb@timeXML@\nobreak\ \NWlink{nuweb443}{443}, \verb@WEIGHT_UNITS@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Monthdays}

The utility {\tt monthdays} returns the number of days in the
month represented by this log.  It is mostly intended for internal
use, but it is exported so users of logs may call it if required.
It can also be called as a function independent of a {\tt monthlog}
object by passing two arguments giving the year and month.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap136}\raggedright\small
\NWtarget{nuweb69}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {69}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub monthdays {@\\
\mbox{}\verb@        my ($year, $month);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($#_ == 0) {@\\
\mbox{}\verb@            my $self = shift;@\\
\mbox{}\verb@            ($year, $month) = ($self->{year}, $self->{month});@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            ($year, $month) = @{\tt @}\verb@_;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($year == 0) {@\\
\mbox{}\verb@            return 0;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   Thirty days hath September, ...@\\
\mbox{}\verb@        my @{\tt @}\verb@monthdays = ( 0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31 );@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($month == 2) {@\\
\mbox{}\verb@            if ((($year % 4) != 0) ||@\\
\mbox{}\verb@                ((($year % 100) == 0) && ($year % 400) != 0)) {@\\
\mbox{}\verb@                return 28;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            return 29;@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            return $monthdays[$month];@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@monthdays@\nobreak\ \NWlink{nuweb27}{27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb33b}{, 33b}\NWlink{nuweb36}{, 36}\NWlink{nuweb46}{, 46}\NWlink{nuweb48a}{, 48a}\NWlink{nuweb48b}{b}\NWlink{nuweb49}{, 49}\NWlink{nuweb50}{, 50}\NWlink{nuweb52}{, 52}\NWlink{nuweb53a}{, 53a}\NWlink{nuweb54}{, 54}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb67}{, 67}\NWlink{nuweb68}{, 68}\NWlink{nuweb72}{, 72}\NWlink{nuweb85}{, 85}\NWlink{nuweb108}{, 108}\NWlink{nuweb109a}{, 109a}\NWlink{nuweb111}{, 111}\NWlink{nuweb117}{, 117}\NWlink{nuweb212a}{, 212a}\NWlink{nuweb214}{, 214}\NWlink{nuweb261}{, 261}\NWlink{nuweb393b}{, 393b}\NWlink{nuweb394}{, 394}\NWlink{nuweb396}{, 396}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Previous and next month}

The {\tt previousMonth} and {\tt nextMonth} methods return the year and month
of the previous and next months respectively as a list of two numbers.  Note
that this does not imply that said month is present in the user database from
which this month originated; that's up for the caller to determine.  These functions
may also called directly from the package with two arguments giving the month and
year for which the previous or next month is required.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap137}\raggedright\small
\NWtarget{nuweb70}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {70}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub previousMonth {@\\
\mbox{}\verb@        my ($year, $month);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($#_ == 0) {@\\
\mbox{}\verb@            my $self = shift;@\\
\mbox{}\verb@            ($year, $month) = ($self->{year}, $self->{month});@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            ($year, $month) = @{\tt @}\verb@_;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $month--;@\\
\mbox{}\verb@        if ($month < 1) {@\\
\mbox{}\verb@            $year--;@\\
\mbox{}\verb@            $month = 12;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return ($year, $month);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    sub nextMonth {@\\
\mbox{}\verb@        my ($year, $month);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($#_ == 0) {@\\
\mbox{}\verb@            my $self = shift;@\\
\mbox{}\verb@            ($year, $month) = ($self->{year}, $self->{month});@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            ($year, $month) = @{\tt @}\verb@_;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $month++;@\\
\mbox{}\verb@        if ($month > 12) {@\\
\mbox{}\verb@            $year++;@\\
\mbox{}\verb@            $month = 1;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return ($year, $month);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@nextMonth@\nobreak\ \NWlink{nuweb85}{85}\NWlink{nuweb112}{, 112}\NWlink{nuweb211}{, 211}, \verb@previousMonth@\nobreak\ \NWlink{nuweb111}{111}\NWlink{nuweb211}{, 211}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Verbose}

If called with an argument {\tt verbose} method sets
the verbosity switch on (for an argument of 1) or off
(argument 0).  If called with no argument, the current
setting is returned.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap138}\raggedright\small
\NWtarget{nuweb71}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {71}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub verbose {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $v;@\\
\mbox{}\verb@        if ($v = shift) {@\\
\mbox{}\verb@            $self->{verbose} = $v;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if ($self->{verbose}) {@\\
\mbox{}\verb@            print("monthlog: Verbose = $self->{verbose}\n");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return $self->{verbose};@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@verbose@\nobreak\ \NWlink{nuweb25}{25}\NWlink{nuweb26}{, 26}\NWlink{nuweb388b}{, 388b}\NWlink{nuweb389a}{, 389a}\NWlink{nuweb404}{, 404}\NWlink{nuweb406a}{, 406a}\NWlink{nuweb421a}{, 421a}\NWlink{nuweb423b}{, 423b}\NWlink{nuweb425}{, 425}\NWlink{nuweb426}{, 426}\NWlink{nuweb429b}{, 429b}\NWlink{nuweb457a}{, 457a}\NWlink{nuweb552a}{, 552a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{EncodeComments}

Since many logs contain duplicate comment fields, we compress
the comments in the database to a string containing a list of
days on which a given comment appears and the quoted comment
string.  Quotes within comments are expanded to two consecutive
quotes.  The {\tt encodeComments} method takes no argument and returns
the string containing the compressed comments for the month.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap139}\raggedright\small
\NWtarget{nuweb72}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {72}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub encodeComments {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $mdays = $self->monthdays();@\\
\mbox{}\verb@        my $enc = '';@\\
\mbox{}\verb@        my @{\tt @}\verb@cmt = @{\tt @}\verb@{$self->{comment}};@\\
\mbox{}\verb@@\\
\mbox{}\verb@        for (my $i = 1; $i <= $mdays; $i++) {@\\
\mbox{}\verb@            if (defined($cmt[$i]) &&@\\
\mbox{}\verb@                ($cmt[$i] ne '')) {@\\
\mbox{}\verb@                $enc .= $i;                 # Comment appears on this day first@\\
\mbox{}\verb@                for (my $j = $i + 1; $j <= $mdays; $j++) {@\\
\mbox{}\verb@                    if (defined($cmt[$j]) &&@\\
\mbox{}\verb@                        ($cmt[$i] eq $cmt[$j])) {@\\
\mbox{}\verb@                        $enc .= ",$j";      # Comment also appears on this day@\\
\mbox{}\verb@                        $cmt[$j] = '';      # Wipe it out since it's been handled as a duplicate@\\
\mbox{}\verb@                    }@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@                my $ct = $cmt[$i];@\\
\mbox{}\verb@                $ct =~ s/"/""/g;@\\
\mbox{}\verb@                $enc .= "\"$ct\"";@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return $enc;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@encodeComments@\nobreak\ \NWlink{nuweb31}{31}.\item \NWtxtIdentsUsed\nobreak\  \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{DecodeComments}

The {\tt decodeComments} method takes a string argument containing
comments compressed by {\tt encodeComments}, extracts them, and
stores their values in the {\tt comment} array of the log.  Any
existing comments for days in the encoded comments (but not for
other days) are overwritten.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap140}\raggedright\small
\NWtarget{nuweb73}{} \verb@"HDiet/monthlog.pm"@\nobreak\ {\footnotesize {73}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub decodeComments {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $ecom = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        while ($ecom =~ s/^([\d,]+)"((?:[^"]|"")+)"//) {@\\
\mbox{}\verb@#print("Days: $1  Comment: ($2)\n");@\\
\mbox{}\verb@            my ($days, $comment) = ($1, $2);@\\
\mbox{}\verb@@\\
\mbox{}\verb@            $comment =~ s/""/"/g;@\\
\mbox{}\verb@            while ($days =~ s/(\d+),?//) {@\\
\mbox{}\verb@                $self->{comment}[$1] = $comment;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
\item \NWtxtIdentsDefed\nobreak\  \verb@decodeComments@\nobreak\ \NWlink{nuweb35a}{35a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

%    _     _     _
%   | |__ (_)___| |_ ___  _ __ _   _
%   | '_ \| / __| __/ _ \| '__| | | |
%   | | | | \__ \ || (_) | |  | |_| |
%   |_| |_|_|___/\__\___/|_|   \__, |
%                              |___/

\clearpage
\vbox{
\chapter{{\tt history.pm}: Historical Analysis Object}
\label{history.pm}

The {\tt history} object performs historical analysis of data
for a user, including generation of historical charts and
long-term trend analyses.

}

\vbox{
\section{Package plumbing}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap141}\raggedright\small
\NWtarget{nuweb75}{} \verb@"HDiet/history.pm"@\nobreak\ {\footnotesize {75}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@#! @\hbox{$\langle\,${\itshape Perl directory}\nobreak\ {\footnotesize \NWlink{nuweb8d}{8d}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Perl language modes}\nobreak\ {\footnotesize \NWlink{nuweb387b}{387b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use HDiet::monthlog qw(:units);@\\
\mbox{}\verb@    use HDiet::trendfit;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    package HDiet::history;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use HDiet::Julian qw(WEEKDAY_NAMES :DEFAULT);@\\
\mbox{}\verb@    use HDiet::Cluster;@\\
\mbox{}\verb@    use GD;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    require Exporter;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use constant MIN_VALUE => -1E100;@\\
\mbox{}\verb@    use constant MAX_VALUE => 1E100;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Minimum, Maximum, and Sign functions}\nobreak\ {\footnotesize \NWlink{nuweb405}{405}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    our @{\tt @}\verb@ISA = qw(Exporter);@\\
\mbox{}\verb@    our @{\tt @}\verb@EXPORT = ( );@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my ($width, $height, $leftMargin, $rightMargin, $topMargin, $bottomMargin,@\\
\mbox{}\verb@        $xAxisLength);@\\
\mbox{}\verb@    my ($start_jd, $end_jd);@\\
\mbox{}\verb@    my ($wgt_min, $wgt_max);@\\
\mbox{}\verb@    my ($img);@\\
\mbox{}\verb@    my %logs;                   # Monthly log cache@\\
\mbox{}\verb@    my @{\tt @}\verb@years;                 # List of years in the user database@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $fitter;@\\
\mbox{}\verb@    my $lastFitDay;@\\
\mbox{}\verb@    my ($nDays, $tFlags);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    1;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb75}{75}\NWlink{nuweb76}{, 76}\NWlink{nuweb77}{, 77}\NWlink{nuweb78}{, 78}\NWlink{nuweb79}{, 79}\NWlink{nuweb82}{, 82}\NWlink{nuweb83}{, 83}\NWlink{nuweb101a}{, 101a}\NWlink{nuweb101b}{b}\NWlink{nuweb102a}{, 102a}\NWlink{nuweb102b}{b}\NWlink{nuweb103a}{, 103a}\NWlink{nuweb103b}{b}\NWlink{nuweb104}{, 104}\NWlink{nuweb105}{, 105}\NWlink{nuweb108}{, 108}\NWlink{nuweb109a}{, 109a}\NWlink{nuweb111}{, 111}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@Julian@\nobreak\ \NWlink{nuweb445}{445}, \verb@WEEKDAY_NAMES@\nobreak\ \NWlink{nuweb445}{445}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Constructor}

A new {\tt history} object is created by calling the
{\tt new} constructor.  It is called with the user object whose
history is to be analysed and the name of the directory in which
that user's history is kept.  (We actually could determine the
latter from the former, but since all callers have already done
this, there's no reason not to just supply it as a constructor
argument.)

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap142}\raggedright\small
\NWtarget{nuweb76}{} \verb@"HDiet/history.pm"@\nobreak\ {\footnotesize {76}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub new {@\\
\mbox{}\verb@        my $self = {};@\\
\mbox{}\verb@        my ($invocant, $user, $user_file_name) = @{\tt @}\verb@_;@\\
\mbox{}\verb@        my $class = ref($invocant) || $invocant;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        bless($self, $class);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   Initialise instance variables from constructor arguments@\\
\mbox{}\verb@        $self->{user} = $user;@\\
\mbox{}\verb@        $self->{user_file_name} = $user_file_name;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $self;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb75}{75}\NWlink{nuweb76}{, 76}\NWlink{nuweb77}{, 77}\NWlink{nuweb78}{, 78}\NWlink{nuweb79}{, 79}\NWlink{nuweb82}{, 82}\NWlink{nuweb83}{, 83}\NWlink{nuweb101a}{, 101a}\NWlink{nuweb101b}{b}\NWlink{nuweb102a}{, 102a}\NWlink{nuweb102b}{b}\NWlink{nuweb103a}{, 103a}\NWlink{nuweb103b}{b}\NWlink{nuweb104}{, 104}\NWlink{nuweb105}{, 105}\NWlink{nuweb108}{, 108}\NWlink{nuweb109a}{, 109a}\NWlink{nuweb111}{, 111}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Get log data for range of days}

Obtain weight, trend, and rung for a given range of days, if
available,  When returning data for more than one day, the arithmetic
mean of days for which entries are present is returned.  The weight
and trend results are expressed in the current \verb+display_unit+ in
the user preferences.  This function may only be called after the
monthly logs for all dates in the requested range have been loaded
into the \verb+%logs+ cache.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap143}\raggedright\small
\NWtarget{nuweb77}{} \verb@"HDiet/history.pm"@\nobreak\ {\footnotesize {77}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub getDays {@\\
\mbox{}\verb@        my ($jdstart, $ndays, $ui) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($wsum, $tsum, $rsum, $flgc, $wtd, $rd) = (0, 0, 0, 0, 0, 0);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        for (my $i = 0; $i < $ndays; $i++) {@\\
\mbox{}\verb@            my ($yy, $mm, $dd) = jd_to_gregorian($jdstart);@\\
\mbox{}\verb@            my $m = $logs{sprintf("%04d-%02d", $yy, $mm)};@\\
\mbox{}\verb@@\\
\mbox{}\verb@            if ($m) {@\\
\mbox{}\verb@                if ($m->{weight}[$dd]) {@\\
\mbox{}\verb@                    $wsum += $m->{weight}[$dd] * HDiet::monthlog::WEIGHT_CONVERSION->[$m->{log_unit}][$ui->{display_unit}];@\\
\mbox{}\verb@                    my $dtrend = $m->{trend}[$dd] * HDiet::monthlog::WEIGHT_CONVERSION->[$m->{log_unit}][$ui->{display_unit}];@\\
\mbox{}\verb@                    $tsum += $dtrend;@\\
\mbox{}\verb@                    $wtd++;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@@\\
\mbox{}\verb@                if ($m->{trend}[$dd]) {@\\
\mbox{}\verb@                    if ($jdstart > $lastFitDay) {@\\
\mbox{}\verb@                        $fitter->addPoint($m->{trend}[$dd] *@\\
\mbox{}\verb@                            HDiet::monthlog::WEIGHT_CONVERSION->[$m->{log_unit}][$ui->{display_unit}]);@\\
\mbox{}\verb@                    }@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@@\\
\mbox{}\verb@                if ($m->{rung}[$dd]) {@\\
\mbox{}\verb@                    $rsum += $m->{rung}[$dd];@\\
\mbox{}\verb@                    $rd++;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@@\\
\mbox{}\verb@                if ($m->{flag}[$dd]) {@\\
\mbox{}\verb@                    $flgc++;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@                if ($jdstart > $lastFitDay) {@\\
\mbox{}\verb@                    $nDays++;@\\
\mbox{}\verb@                    $tFlags++ if $m->{flag}[$dd];@\\
\mbox{}\verb@                    $lastFitDay = $jdstart;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            $jdstart++;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb75}{75}\NWlink{nuweb76}{, 76}\NWlink{nuweb77}{, 77}\NWlink{nuweb78}{, 78}\NWlink{nuweb79}{, 79}\NWlink{nuweb82}{, 82}\NWlink{nuweb83}{, 83}\NWlink{nuweb101a}{, 101a}\NWlink{nuweb101b}{b}\NWlink{nuweb102a}{, 102a}\NWlink{nuweb102b}{b}\NWlink{nuweb103a}{, 103a}\NWlink{nuweb103b}{b}\NWlink{nuweb104}{, 104}\NWlink{nuweb105}{, 105}\NWlink{nuweb108}{, 108}\NWlink{nuweb109a}{, 109a}\NWlink{nuweb111}{, 111}.
\item \NWtxtIdentsDefed\nobreak\  \verb@getDays@\nobreak\ \NWlink{nuweb81}{81}\NWlink{nuweb96}{, 96}\NWlink{nuweb98}{, 98}.\item \NWtxtIdentsUsed\nobreak\  \verb@addPoint@\nobreak\ \NWlink{nuweb20a}{20a}, \verb@jd_to_gregorian@\nobreak\ \NWlink{nuweb448}{448}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{

If one or more days were present in the range, compute the mean weight,
trend, and rung and return to the caller.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap144}\raggedright\small
\NWtarget{nuweb78}{} \verb@"HDiet/history.pm"@\nobreak\ {\footnotesize {78}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@        if ($wtd > 0) {@\\
\mbox{}\verb@            $wsum /= $wtd;@\\
\mbox{}\verb@            $tsum /= $wtd;@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $wsum = undef;@\\
\mbox{}\verb@            $tsum = undef;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if ($rd > 0) {@\\
\mbox{}\verb@            $rsum /= $rd;@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $rsum = undef;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return ($wsum, $tsum, $rsum, $flgc);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb75}{75}\NWlink{nuweb76}{, 76}\NWlink{nuweb77}{, 77}\NWlink{nuweb78}{, 78}\NWlink{nuweb79}{, 79}\NWlink{nuweb82}{, 82}\NWlink{nuweb83}{, 83}\NWlink{nuweb101a}{, 101a}\NWlink{nuweb101b}{b}\NWlink{nuweb102a}{, 102a}\NWlink{nuweb102b}{b}\NWlink{nuweb103a}{, 103a}\NWlink{nuweb103b}{b}\NWlink{nuweb104}{, 104}\NWlink{nuweb105}{, 105}\NWlink{nuweb108}{, 108}\NWlink{nuweb109a}{, 109a}\NWlink{nuweb111}{, 111}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Analyse Trend}

The {\tt analyseTrend} method computes the slope of the linear
regression best fit to one or more date intervals specified by a list
passed as an argument which contains the start and end dates for each
interval required.  The result is returned as a list of sequences of
four items: slope, minimum, maximum, and mean values for the trend
over the time intervals requested.  If no log entries exist within one
or more requested ranges, {\tt undef} will be returned as the slope
for that interval.

The trend slopes for all date ranges requested are computed in a single
pass over a date range inclusive of all, but computation is not optimised
for widely-saparated disjoint intervals.  In fact, almost all callers of
this method use it to compute nested intervals (last week, last month, last
quarter, etc.), so it's probably not worth the bother of adding the
complexity it would require to skip dates in gaps.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap145}\raggedright\small
\NWtarget{nuweb79}{} \verb@"HDiet/history.pm"@\nobreak\ {\footnotesize {79}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub analyseTrend {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my (@{\tt @}\verb@intervals) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($ui, $user_file_name) = ($self->{user}, $self->{user_file_name});@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($start_date, $end_date) = ('9999-99-99', '0000-00-00');@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Build table of intervals and compute date span of union}\nobreak\ {\footnotesize \NWlink{nuweb80}{80}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Determine the number of days in the historical interval}\nobreak\ {\footnotesize \NWlink{nuweb84}{84}}$\,\rangle$}\verb@@\\
\mbox{}\verb@#print("Inclusive interval: $start_date - $end_date  $start_jd - $end_jd  $dayspan days\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Fill cache with monthly logs in the date range}\nobreak\ {\footnotesize \NWlink{nuweb112}{112}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@#use Data::Dumper;@\\
\mbox{}\verb@#print(Dumper(\@{\tt @}\verb@interval));@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   Instantiate a fitter for each interval we're watching@\\
\mbox{}\verb@        my @{\tt @}\verb@fitter;@\\
\mbox{}\verb@        for (my $i = 0; $i <= $#interval; $i++) {@\\
\mbox{}\verb@            $fitter[$i] = HDiet::trendfit->new();@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $fitter = HDiet::trendfit->new();@\\
\mbox{}\verb@        $lastFitDay = 0;@\\
\mbox{}\verb@        ($nDays, $tFlags) = (0, 0);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Examine dates, fitting those within intervals}\nobreak\ {\footnotesize \NWlink{nuweb81}{81}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@#print(Dumper(\@{\tt @}\verb@fitter));@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my @{\tt @}\verb@slopes;@\\
\mbox{}\verb@        for (my $i = 0; $i <= $#fitter; $i++) {@\\
\mbox{}\verb@            push(@{\tt @}\verb@slopes, $fitter[$i]->fitSlope());@\\
\mbox{}\verb@            push(@{\tt @}\verb@slopes, $fitter[$i]->minMaxMean());@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@#print(Dumper(\@{\tt @}\verb@slopes));@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return @{\tt @}\verb@slopes;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb75}{75}\NWlink{nuweb76}{, 76}\NWlink{nuweb77}{, 77}\NWlink{nuweb78}{, 78}\NWlink{nuweb79}{, 79}\NWlink{nuweb82}{, 82}\NWlink{nuweb83}{, 83}\NWlink{nuweb101a}{, 101a}\NWlink{nuweb101b}{b}\NWlink{nuweb102a}{, 102a}\NWlink{nuweb102b}{b}\NWlink{nuweb103a}{, 103a}\NWlink{nuweb103b}{b}\NWlink{nuweb104}{, 104}\NWlink{nuweb105}{, 105}\NWlink{nuweb108}{, 108}\NWlink{nuweb109a}{, 109a}\NWlink{nuweb111}{, 111}.
\item \NWtxtIdentsDefed\nobreak\  \verb@analyseTrend@\nobreak\ \NWlink{nuweb80}{80}\NWlink{nuweb100}{, 100}\NWlink{nuweb102b}{, 102b}\NWlink{nuweb215}{, 215}\NWlink{nuweb267}{, 267}.\item \NWtxtIdentsUsed\nobreak\  \verb@fitSlope@\nobreak\ \NWlink{nuweb20b}{20b}\NWlink{nuweb488a}{, 488a}, \verb@minMaxMean@\nobreak\ \NWlink{nuweb21}{21}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Build table of intervals and compute date span of union}

Walk through the argument pairs and build the \verb+@interval+ table,
each entry of which is an array of two Julian day numbers giving the start
and end of the interval.  As we're doing this, we keep track of the first
and last dates in the union of the intervals, which we'll use to determine
the portion of the database we need to scan.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap146}\raggedright\small
\NWtarget{nuweb80}{} $\langle\,${\itshape Build table of intervals and compute date span of union}\nobreak\ {\footnotesize {80}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@interval;@\\
\mbox{}\verb@    for (my $i = 0; $i <= $#intervals; $i += 2) {@\\
\mbox{}\verb@        die("history::analyseTrend: Interval[$i] ($intervals[$i] - $intervals[$i + 1]) out of order")@\\
\mbox{}\verb@            if $intervals[$i] gt $intervals[$i + 1];@\\
\mbox{}\verb@        $start_date = $intervals[$i] if $intervals[$i]  lt $start_date;@\\
\mbox{}\verb@        $end_date = $intervals[$i + 1] if $intervals[$i + 1] gt $end_date;@\\
\mbox{}\verb@        $intervals[$i] =~ m/^(\d+)(?:\-(\d+))?(?:\-(\d+))?$/ ||@\\
\mbox{}\verb@            die("history::analyseTrend: invalid intervals[$i] start date intervals[$i]");@\\
\mbox{}\verb@        my $int_start_jd = gregorian_to_jd($1, $2, $3);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $intervals[$i + 1] =~ m/^(\d+)(?:\-(\d+))?(?:\-(\d+))?$/ ||@\\
\mbox{}\verb@            die("history::drawChart: history::analyseTrend: invalid intervals[$i + 1] start date intervals[$i + 1]");@\\
\mbox{}\verb@        my $int_end_jd = gregorian_to_jd($1, $2, $3);@\\
\mbox{}\verb@        push(@{\tt @}\verb@interval, [$int_start_jd, $int_end_jd]);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb79}{79}.
\item \NWtxtIdentsUsed\nobreak\  \verb@analyseTrend@\nobreak\ \NWlink{nuweb79}{79}, \verb@drawChart@\nobreak\ \NWlink{nuweb82}{82}, \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}, \verb@start@\nobreak\ \NWlink{nuweb19b}{19b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Examine dates, fitting those within intervals}

Iterate over all dates in the union of the requested intervals.
For each which has a trend value available, include it in the
regression fit for each interval within which the interval
falls.

One subtlety is how we handle missing trend values.  Until we've seen
a date with a valid trend, we ignore days entirely; this handles
requests which begin before the first log entry in the database.
Afterward, missing trend values, which usually result when an
entire month has no log entries, are faked by filling in the
last valid trend value we saw before the gap.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap147}\raggedright\small
\NWtarget{nuweb81}{} $\langle\,${\itshape Examine dates, fitting those within intervals}\nobreak\ {\footnotesize {81}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $lastTrend = 0;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $cdate = $start_jd; $cdate <= $end_jd; $cdate++) {@\\
\mbox{}\verb@        my ($weight, $trend) = getDays($cdate, 1, $ui);@\\
\mbox{}\verb@        $trend = $lastTrend if (!$trend) && $lastTrend;@\\
\mbox{}\verb@        if ($trend) {@\\
\mbox{}\verb@            for (my $i = 0; $i <= $#interval; $i++) {@\\
\mbox{}\verb@                if (($cdate >= $interval[$i][0]) && ($cdate <= $interval[$i][1])) {@\\
\mbox{}\verb@                    $fitter[$i]->addPoint($trend);@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            $lastTrend = $trend;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb79}{79}.
\item \NWtxtIdentsUsed\nobreak\  \verb@addPoint@\nobreak\ \NWlink{nuweb20a}{20a}, \verb@getDays@\nobreak\ \NWlink{nuweb77}{77}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Draw Chart}

The {\tt drawChart} method plots an historical chart with the span
specified by the arguments.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap148}\raggedright\small
\NWtarget{nuweb82}{} \verb@"HDiet/history.pm"@\nobreak\ {\footnotesize {82}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub drawChart {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($outfile, $start_date, $end_date, $ww, $hh, $dietcalc,@\\
\mbox{}\verb@            $printFriendly, $monochrome) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($ui, $user_file_name) = ($self->{user}, $self->{user_file_name});@\\
\mbox{}\verb@@\\
\mbox{}\verb@        ($width, $height) = ($ww, $hh);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (!(defined $outfile)) {@\\
\mbox{}\verb@            $outfile = \*STDOUT;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $fitter = HDiet::trendfit->new();@\\
\mbox{}\verb@        $lastFitDay = 0;@\\
\mbox{}\verb@        ($nDays, $tFlags) = (0, 0);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Determine the number of days in the historical interval}\nobreak\ {\footnotesize \NWlink{nuweb84}{84}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Find weight and trend extrema in log entries to be plotted}\nobreak\ {\footnotesize \NWlink{nuweb85}{85}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Find diet plan extrema on historical chart}\nobreak\ {\footnotesize \NWlink{nuweb86}{86}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Define historical chart geometry}\nobreak\ {\footnotesize \NWlink{nuweb87b}{87b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $img = new GD::Image($width, $height);@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Allocate colours for chart}\nobreak\ {\footnotesize \NWlink{nuweb47}{47}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        $img->interlaced('true');@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $xAxisLength = $width - ($leftMargin + $rightMargin);@\\
\mbox{}\verb@        $img->filledRectangle($leftMargin + (-$axisOffset) + 1, $topMargin,@\\
\mbox{}\verb@                              $leftMargin + $xAxisLength + $axisOffset,@\\
\mbox{}\verb@                              $topMargin + $height - ($topMargin + $bottomMargin) + ($axisOffset - 1), $grey);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Draw axes for historical chart}\nobreak\ {\footnotesize \NWlink{nuweb89b}{89b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Determine vertical weight scaling based on extrema}\nobreak\ {\footnotesize \NWlink{nuweb88a}{88a}, \ldots\ }$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Plot weight and rung data on historical chart}\nobreak\ {\footnotesize \NWlink{nuweb95}{95}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Plot the diet plan on historical chart}\nobreak\ {\footnotesize \NWlink{nuweb87a}{87a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Empty monthly log cache}\nobreak\ {\footnotesize \NWlink{nuweb113b}{113b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print($outfile $img->png());@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb75}{75}\NWlink{nuweb76}{, 76}\NWlink{nuweb77}{, 77}\NWlink{nuweb78}{, 78}\NWlink{nuweb79}{, 79}\NWlink{nuweb82}{, 82}\NWlink{nuweb83}{, 83}\NWlink{nuweb101a}{, 101a}\NWlink{nuweb101b}{b}\NWlink{nuweb102a}{, 102a}\NWlink{nuweb102b}{b}\NWlink{nuweb103a}{, 103a}\NWlink{nuweb103b}{b}\NWlink{nuweb104}{, 104}\NWlink{nuweb105}{, 105}\NWlink{nuweb108}{, 108}\NWlink{nuweb109a}{, 109a}\NWlink{nuweb111}{, 111}.
\item \NWtxtIdentsDefed\nobreak\  \verb@drawChart@\nobreak\ \NWlink{nuweb80}{80}\NWlink{nuweb84}{, 84}\NWlink{nuweb303}{, 303}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Scaling and line drawing functions}

The following utility functions are used in the {\tt drawChart} method
above to scale weight and exercise rung quantities to the dimensions
of the chart and draw lines within the plot area.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap149}\raggedright\small
\NWtarget{nuweb83}{} \verb@"HDiet/history.pm"@\nobreak\ {\footnotesize {83}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub WeightToY {             # Map weight to vertical pixel position@\\
\mbox{}\verb@        my ($w) = @{\tt @}\verb@_;@\\
\mbox{}\verb@        return int((($w - $wgt_min) * ($height - ($bottomMargin + $topMargin))) / ($wgt_max - $wgt_min));@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    sub RungToY {               # Map exercise rung to vertical pixel position@\\
\mbox{}\verb@        my ($r) = @{\tt @}\verb@_;@\\
\mbox{}\verb@        return int((($r - 1) * ($height - ($bottomMargin + $topMargin))) / HDiet::monthlog::RUNG_MAX);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    sub PlotScaleLine {         # Transform plot area co-ordinates into absolute@\\
\mbox{}\verb@        my ($x1, $y1, $x2, $y2) = @{\tt @}\verb@_;@\\
\mbox{}\verb@        return ($leftMargin + $x1, ($height - $bottomMargin) - $y1,@\\
\mbox{}\verb@                $leftMargin + $x2, ($height - $bottomMargin) - $y2);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    sub PlotLine {              # Plot a line given plot area co-ordinates and colour@\\
\mbox{}\verb@        my ($rx1, $ry1, $rx2, $ry2, $colour) = @{\tt @}\verb@_;@\\
\mbox{}\verb@        die("Colour missing from call to PlotLine") if !defined($colour);@\\
\mbox{}\verb@        my ($x1, $y1, $x2, $y2) = PlotScaleLine($rx1, $ry1, $rx2, $ry2);@\\
\mbox{}\verb@        $img->line($x1, $y1, $x2, $y2, $colour);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb75}{75}\NWlink{nuweb76}{, 76}\NWlink{nuweb77}{, 77}\NWlink{nuweb78}{, 78}\NWlink{nuweb79}{, 79}\NWlink{nuweb82}{, 82}\NWlink{nuweb83}{, 83}\NWlink{nuweb101a}{, 101a}\NWlink{nuweb101b}{b}\NWlink{nuweb102a}{, 102a}\NWlink{nuweb102b}{b}\NWlink{nuweb103a}{, 103a}\NWlink{nuweb103b}{b}\NWlink{nuweb104}{, 104}\NWlink{nuweb105}{, 105}\NWlink{nuweb108}{, 108}\NWlink{nuweb109a}{, 109a}\NWlink{nuweb111}{, 111}.
\item \NWtxtIdentsUsed\nobreak\  \verb@RUNG_MAX@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Determine the number of days in the historical interval}

The horizontal scale of the chart is determined by the number of
days it spans.  Parse the start and ending date arguments,
filling in defaults for omitted fields, and determine the days
spanned by the chart by taking the difference of their Julian
day numbers.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap150}\raggedright\small
\NWtarget{nuweb84}{} $\langle\,${\itshape Determine the number of days in the historical interval}\nobreak\ {\footnotesize {84}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    $start_date =~ m/^(\d+)(?:\-(\d+))?(?:\-(\d+))?$/ || die("history::drawChart: invalid start date $start_date");@\\
\mbox{}\verb@    my ($start_y, $start_m, $start_d) = ($1, $2, $3);@\\
\mbox{}\verb@    $start_m = 1 if !defined($start_m);@\\
\mbox{}\verb@    $start_d = 1 if !defined($start_d);@\\
\mbox{}\verb@    $start_jd = gregorian_to_jd($start_y, $start_m, $start_d);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $end_date =~ m/^(\d+)(?:\-(\d+))?(?:\-(\d+))?$/ || die("history::drawChart: invalid end date $end_date");@\\
\mbox{}\verb@    my ($end_y, $end_m, $end_d) = ($1, $2, $3);@\\
\mbox{}\verb@    $end_m = 12 if !defined($end_m);@\\
\mbox{}\verb@    if (!defined($end_d)) {@\\
\mbox{}\verb@        $end_jd = gregorian_to_jd($end_y, $end_m + 1, 1) - 1;@\\
\mbox{}\verb@        $end_d  = (jd_to_gregorian($end_jd))[2];@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    $end_jd = gregorian_to_jd($end_y, $end_m, $end_d);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $dayspan = (($end_jd + 1) - $start_jd);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb79}{79}\NWlink{nuweb82}{, 82}\NWlink{nuweb105}{, 105}.
\item \NWtxtIdentsUsed\nobreak\  \verb@drawChart@\nobreak\ \NWlink{nuweb82}{82}, \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}, \verb@jd_to_gregorian@\nobreak\ \NWlink{nuweb448}{448}, \verb@start@\nobreak\ \NWlink{nuweb19b}{19b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Find weight and trend extrema in log entries to be plotted}

Scan the logs present in the database between the start and end
dates and determine the extrema of trend and weight.  These are used
to establish the vertical scale for the chart.  In the process,
a hash named \verb+%logs+ is created with keys of the year and
month and values of the log objects for those months.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap151}\raggedright\small
\NWtarget{nuweb85}{} $\langle\,${\itshape Find weight and trend extrema in log entries to be plotted}\nobreak\ {\footnotesize {85}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my ($cur_y, $cur_m) = ($start_y, $start_m);@\\
\mbox{}\verb@    my ($first_day, $last_day) = ($start_d, 31);@\\
\mbox{}\verb@    my ($weight_min, $weight_max, $trend_min, $trend_max, $rung_min, $rung_max) =@\\
\mbox{}\verb@            (MAX_VALUE, MIN_VALUE, MAX_VALUE, MIN_VALUE, MAX_VALUE, MIN_VALUE);@\\
\mbox{}\verb@    my ($trend_mean, $trend_last, $trend_ndays) = (0, 0, 0);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $monkey = sprintf("%04d-%02d", $start_y, $start_m);@\\
\mbox{}\verb@         $monkey le sprintf("%04d-%02d", $end_y, $end_m);@\\
\mbox{}\verb@         $monkey = sprintf("%04d-%02d", $cur_y, $cur_m)) {@\\
\mbox{}\verb@        if (-f "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$monkey.hdb") {@\\
\mbox{}\verb@            open(FL, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$monkey.hdb") ||@\\
\mbox{}\verb@                die("Cannot open monthly log file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$monkey.hdb");@\\
\mbox{}\verb@            my $mlog = HDiet::monthlog->new();@\\
\mbox{}\verb@            $logs{$monkey} = $mlog;@\\
\mbox{}\verb@            $mlog->load(\*FL);@\\
\mbox{}\verb@            close(FL);@\\
\mbox{}\verb@@\\
\mbox{}\verb@            if (($cur_y == $end_y) && ($cur_m == $end_m)) {@\\
\mbox{}\verb@                $last_day = $end_d;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@@\\
\mbox{}\verb@            my $logToDisplayUnit = HDiet::monthlog::WEIGHT_CONVERSION->[$mlog->{log_unit}][$ui->{display_unit}];@\\
\mbox{}\verb@            for (my $i = $first_day; $i <= min($mlog->monthdays(), $last_day); $i++) {@\\
\mbox{}\verb@                if (defined($mlog->{weight}[$i])) {@\\
\mbox{}\verb@                    $weight_min = min($mlog->{weight}[$i] * $logToDisplayUnit, $weight_min);@\\
\mbox{}\verb@                    $weight_max = max($mlog->{weight}[$i] * $logToDisplayUnit, $weight_max);@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@                if (defined($mlog->{trend}[$i])) {@\\
\mbox{}\verb@                    $trend_min = min($mlog->{trend}[$i] * $logToDisplayUnit, $trend_min);@\\
\mbox{}\verb@                    $trend_max = max($mlog->{trend}[$i] * $logToDisplayUnit, $trend_max);@\\
\mbox{}\verb@                    $trend_last = $mlog->{trend}[$i] *@\\
\mbox{}\verb@                        HDiet::monthlog::WEIGHT_CONVERSION->[$mlog->{log_unit}][HDiet::monthlog::WEIGHT_KILOGRAM];@\\
\mbox{}\verb@                    $trend_mean += $trend_last;@\\
\mbox{}\verb@                    $trend_ndays++;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@                if (defined($mlog->{rung}[$i])) {@\\
\mbox{}\verb@                    $rung_min = min($mlog->{rung}[$i] * $logToDisplayUnit, $rung_min);@\\
\mbox{}\verb@                    $rung_max = max($mlog->{rung}[$i] * $logToDisplayUnit, $rung_max);@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@@\\
\mbox{}\verb@            if ($mlog->{trend_carry_forward} > 0) {@\\
\mbox{}\verb@                $trend_min = min($trend_min, $mlog->{trend_carry_forward} * $logToDisplayUnit);@\\
\mbox{}\verb@                $trend_max = max($trend_max, $mlog->{trend_carry_forward} * $logToDisplayUnit);@\\
\mbox{}\verb@             }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        ($cur_y, $cur_m) = HDiet::monthlog::nextMonth($cur_y, $cur_m);@\\
\mbox{}\verb@        $first_day = 1;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    ($wgt_min, $wgt_max) = (min($weight_min, $trend_min), max($weight_max, $trend_max));@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb82}{82}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}, \verb@max@\nobreak\ \NWlink{nuweb405}{405}, \verb@min@\nobreak\ \NWlink{nuweb405}{405}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}, \verb@nextMonth@\nobreak\ \NWlink{nuweb70}{70}, \verb@WEIGHT_KILOGRAM@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Find diet plan extrema on historical chart}

If the user has established a diet plan and requested that it be plotted
in charts, determine the segment of the plan which falls within this
chart.  There are three possibilities.  If the plan starts after the end
of this chart, we plot nothing.  If the plan begins during the period
of this chart, we plot from the beginning of the plan to the end of
the month.  If the plan ends within this month, we plot a flat line
from the date of the end of the plan to the end of the month, on the
assumption that the user intends to maintain the goal weight of the
plan after its accomplishment.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap152}\raggedright\small
\NWtarget{nuweb86}{} $\langle\,${\itshape Find diet plan extrema on historical chart}\nobreak\ {\footnotesize {86}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my ($pjdstart, $pjdend) = (max($start_jd, $$dietcalc[0]), min($end_jd, $$dietcalc[2]));@\\
\mbox{}\verb@    my ($plan_start_day, $plan_start_weight,@\\
\mbox{}\verb@        $plan_end_day, $plan_end_weight) = (-1) x 4;@\\
\mbox{}\verb@    if (defined($$dietcalc[0])) {@\\
\mbox{}\verb@        #   If plan starts before the end of the month, we shall plot it@\\
\mbox{}\verb@        if ($pjdstart <= $end_jd) {@\\
\mbox{}\verb@            if ($$dietcalc[2] <= $start_jd) {@\\
\mbox{}\verb@                #   Plan ends before start of chart; plot flat line at end weight@\\
\mbox{}\verb@                $plan_start_day = $start_jd;@\\
\mbox{}\verb@                $plan_end_day = $end_jd;@\\
\mbox{}\verb@                $plan_start_weight = $plan_end_weight = $$dietcalc[3];@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                $plan_start_day = $pjdstart;@\\
\mbox{}\verb@                $plan_end_day = $pjdend;@\\
\mbox{}\verb@                $plan_start_weight = $$dietcalc[1] + (($$dietcalc[3] - $$dietcalc[1]) *@\\
\mbox{}\verb@                    (($pjdstart - $$dietcalc[0]) / ($$dietcalc[2] - $$dietcalc[0])));@\\
\mbox{}\verb@                $plan_end_weight = $$dietcalc[1] + (($$dietcalc[3] - $$dietcalc[1]) *@\\
\mbox{}\verb@                    (($pjdend - $$dietcalc[0]) / ($$dietcalc[2] - $$dietcalc[0])));@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $plan_start_weight *= HDiet::monthlog::WEIGHT_CONVERSION->[HDiet::monthlog::WEIGHT_KILOGRAM][$ui->{display_unit}];@\\
\mbox{}\verb@        $plan_end_weight *= HDiet::monthlog::WEIGHT_CONVERSION->[HDiet::monthlog::WEIGHT_KILOGRAM][$ui->{display_unit}];@\\
\mbox{}\verb@        if (min($plan_start_weight, $plan_end_weight) > 0) {@\\
\mbox{}\verb@            $wgt_min = min($wgt_min, min($plan_start_weight, $plan_end_weight));@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if (max($plan_start_weight, $plan_end_weight) > 0) {@\\
\mbox{}\verb@            $wgt_max = max($wgt_max, max($plan_start_weight, $plan_end_weight));@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb82}{82}.
\item \NWtxtIdentsUsed\nobreak\  \verb@max@\nobreak\ \NWlink{nuweb405}{405}, \verb@min@\nobreak\ \NWlink{nuweb405}{405}, \verb@start@\nobreak\ \NWlink{nuweb19b}{19b}, \verb@WEIGHT_KILOGRAM@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Plot the diet plan on historical chart}

If a segment of the diet plan appears within this chart, plot
it.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap153}\raggedright\small
\NWtarget{nuweb87a}{} $\langle\,${\itshape Plot the diet plan on historical chart}\nobreak\ {\footnotesize {87a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($plan_start_day > 0) {@\\
\mbox{}\verb@        my $sx = int(($xAxisLength * ($plan_start_day - $start_jd)) / ($end_jd - $start_jd));@\\
\mbox{}\verb@        my $sy = WeightToY($plan_start_weight);@\\
\mbox{}\verb@        my $ex = int(($xAxisLength * ($plan_end_day - $start_jd)) / ($end_jd - $start_jd));@\\
\mbox{}\verb@        my $ey = WeightToY($plan_end_weight);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $img->setStyle($yellow, $yellow, $yellow, $yellow,@\\
\mbox{}\verb@                       gdTransparent, gdTransparent, gdTransparent, gdTransparent);@\\
\mbox{}\verb@        PlotLine($sx, $sy, $ex, $ey, gdStyled);@\\
\mbox{}\verb@        if ($plan_end_day < $end_jd) {@\\
\mbox{}\verb@            PlotLine($ex, $ey, $xAxisLength, $ey, gdStyled);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb82}{82}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Define historical chart geometry}

The following variables specify the layout of items within the
chart.  They are basically twiddle knobs which are adjusted in
the interest of appearance.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap154}\raggedright\small
\NWtarget{nuweb87b}{} $\langle\,${\itshape Define historical chart geometry}\nobreak\ {\footnotesize {87b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    $width = 640 if !defined($width);@\\
\mbox{}\verb@    $height = 480 if !defined($height);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my ($fontLineHeight, $fontCharHeight) = (20, 10);@\\
\mbox{}\verb@    my $fontCharWidth = 8;@\\
\mbox{}\verb@    ($leftMargin, $rightMargin, $topMargin, $bottomMargin) =@\\
\mbox{}\verb@        ($fontCharHeight * (($ui->{display_unit} == HDiet::monthlog::WEIGHT_STONE) ? 6 : 5),@\\
\mbox{}\verb@        $fontCharHeight * 3, $fontCharHeight * 2, int($fontCharHeight * 6));@\\
\mbox{}\verb@    my ($axisOffset, $tickSize, $sinkerSize) = (3, 5, 4);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my ($topLeftX, $topLeftY) = (0, 0);@\\
\mbox{}\verb@    my ($extentX, $extentY) = ($width, $height);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $pixelsPerDay = int(($extentX - ($leftMargin + $rightMargin)) / ($dayspan - 1));@\\
\mbox{}\verb@    my $daysPerPixel = int(($dayspan - 1) / ($extentX - ($leftMargin + $rightMargin)));@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my ($bX, $bY) = ($topLeftX + $leftMargin, (($topLeftY + $extentY) - $bottomMargin));@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb82}{82}.
\item \NWtxtIdentsUsed\nobreak\  \verb@WEIGHT_STONE@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Determine vertical weight scaling based on extrema}

Based on the weight and trend extrema we've found in the log items
for the requested date range, scale the vertical axis to include
the extrema with an easy to read scale based on factors of 1, 2, or 5,
whichever best fits the data and the chart height.

If there's only one day's worth of data or all the entries in the log
are identical (it {\em can} happen), it's possible for \verb+$wgt_min+
and \verb+$wgt_max+ to be identical, which will result in division by
zero in the autoscaling and plotting code.  If this is the case, we
arbitrarily expand the extrema by one tenth of a weight unit to plot
the data centred on the chart.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap155}\raggedright\small
\NWtarget{nuweb88a}{} $\langle\,${\itshape Determine vertical weight scaling based on extrema}\nobreak\ {\footnotesize {88a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@     if ($wgt_min == $wgt_max) {@\\
\mbox{}\verb@            $wgt_min -= 10;@\\
\mbox{}\verb@            $wgt_max += 10;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $maxLabelRows = ($height - ($topMargin + $bottomMargin)) / $fontLineHeight;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb88a}{88a}\NWlink{nuweb88b}{b}\NWlink{nuweb89a}{, 89a}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb82}{82}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
Find a display scale power and factor which permits a suitable number
of labels on the weight axis.  We do this using units like a vintage
Tektronix oscilloscope: increasing powers of 1, 2, and 5.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap156}\raggedright\small
\NWtarget{nuweb88b}{} $\langle\,${\itshape Determine vertical weight scaling based on extrema}\nobreak\ {\footnotesize {88b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    $wgt_max = int($wgt_max * 100);@\\
\mbox{}\verb@    $wgt_min = int($wgt_min * 100);@\\
\mbox{}\verb@    my $factor = 0;@\\
\mbox{}\verb@    my $vunit = 1;@\\
\mbox{}\verb@    my $power = 1;@\\
\mbox{}\verb@    my @{\tt @}\verb@factors = (1, 2, 5);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    while ((($wgt_max - ($wgt_min - ($wgt_min % $vunit))) / ($factors[$factor] * $power)) > $maxLabelRows) {@\\
\mbox{}\verb@        $factor++;@\\
\mbox{}\verb@        if ($factor > 2) {@\\
\mbox{}\verb@            $factor = 0;@\\
\mbox{}\verb@            $power *= 10;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $vunit = $factors[$factor] * $power;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb88a}{88a}\NWlink{nuweb88b}{b}\NWlink{nuweb89a}{, 89a}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb82}{82}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
There's no point in using a finer-grained weight unit than the one we
use to plot weights.  Adjust the weight unit if it's smaller than the
label increment.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap157}\raggedright\small
\NWtarget{nuweb89a}{} $\langle\,${\itshape Determine vertical weight scaling based on extrema}\nobreak\ {\footnotesize {89a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($vunit < 100) {@\\
\mbox{}\verb@        $vunit = 100;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    $vunit /= 100;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $wgt_min -= $wgt_min % $vunit;@\\
\mbox{}\verb@    $wgt_max = $wgt_max / 100;@\\
\mbox{}\verb@    $wgt_min = $wgt_min / 100;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb88a}{88a}\NWlink{nuweb88b}{b}\NWlink{nuweb89a}{, 89a}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb82}{82}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Draw axes for historical chart}

The $X$ and $Y$ axes are drawn to the full extent of the left and
bottom edges of the plot area.  Date labels are plotted on the $X$ axis in a
variety of styles depending upon the relationship between the interval
being plotted and the size of the chart.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap158}\raggedright\small
\NWtarget{nuweb89b}{} $\langle\,${\itshape Draw axes for historical chart}\nobreak\ {\footnotesize {89b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    #   Y axis@\\
\mbox{}\verb@    PlotLine(-$axisOffset, -$axisOffset, -$axisOffset, $height - ($topMargin + $bottomMargin), $black);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   X axis@\\
\mbox{}\verb@    PlotLine(-$axisOffset, -$axisOffset, $xAxisLength + $axisOffset, -$axisOffset, $black);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Label date axis at the bottom}\nobreak\ {\footnotesize \NWlink{nuweb90}{90}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb82}{82}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Label date axis at the bottom}

Label the bottom of the plot with the dates spanned.  We have
a variety of formats for this, ranging from showing individual weeks
all the way to just two digits for a year, with sufficient years
between labels so as to avoid overlaps.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap159}\raggedright\small
\NWtarget{nuweb90}{} $\langle\,${\itshape Label date axis at the bottom}\nobreak\ {\footnotesize {90}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@ext;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $font = 'Times';@\\
\mbox{}\verb@    my $fontFile = "@\hbox{$\langle\,${\itshape TrueType Font Directory}\nobreak\ {\footnotesize \NWlink{nuweb6g}{6g}}$\,\rangle$}\verb@/$font.ttf";@\\
\mbox{}\verb@    @{\tt @}\verb@ext =  GD::Image->stringFT($black, $fontFile, 12, 0, 20, 20, "Mar ");@\\
\mbox{}\verb@    my $cw = $ext[2] - $ext[0];@\\
\mbox{}\verb@    @{\tt @}\verb@ext =  GD::Image->stringFT($black, $fontFile, 12, 0, 20, 20, "M ");@\\
\mbox{}\verb@    my $scw = $ext[2] - $ext[0];@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $single = 0;@\\
\mbox{}\verb@    my $flblinc = ((int(($end_jd - $start_jd) / 30) * $cw) + ($xAxisLength - 1)) / $xAxisLength;@\\
\mbox{}\verb@    my $lblinc = int($flblinc);@\\
\mbox{}\verb@    $lblinc = 1 if $lblinc < 1;@\\
\mbox{}\verb@    if ($lblinc > 1) {@\\
\mbox{}\verb@        $lblinc = int(((int(($end_jd - $start_jd) / 30) * $scw) + ($xAxisLength - 1)) / $xAxisLength);@\\
\mbox{}\verb@        $lblinc = 1 if $lblinc < 1;@\\
\mbox{}\verb@        $single = 1;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my ($dt_y, $dt_m, $dt_d) = ($start_y, $start_m, $start_d);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $cjd = gregorian_to_jd($dt_y, $dt_m, $dt_d);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($flblinc < 3) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Label date axis with years, months, and possibly weeks}\nobreak\ {\footnotesize \NWlink{nuweb91}{91}}$\,\rangle$}\verb@@\\
\mbox{}\verb@     } else {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Label date axis with year numbers only}\nobreak\ {\footnotesize \NWlink{nuweb92}{92}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb89b}{89b}.
\item \NWtxtIdentsUsed\nobreak\  \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Label date axis with years, months, and possibly weeks}

The horizontal size of the plot is such that we can fit at least
labels for months in the plot.  First we determine whether the months
should be expressed as single- or three-letter abbreviations. If
single-letter abbreviations are required, the year numbers shown in
lieu of January are shown as two digits; otherwise the full year
number is plotted.  If the plot spans less than a single month, we
label day numbers at week boundaries.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap160}\raggedright\small
\NWtarget{nuweb91}{} $\langle\,${\itshape Label date axis with years, months, and possibly weeks}\nobreak\ {\footnotesize {91}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@   while ($cjd <= $end_jd) {@\\
\mbox{}\verb@        my $yearStart = $dt_m == 1;@\\
\mbox{}\verb@        my $monster;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($yearStart) {@\\
\mbox{}\verb@            $monster = $single ? sprintf("%02d", $dt_y % 100) : $dt_y;@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $monster = substr($::monthNames[$dt_m], 0, $single ? 1 : 3);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $pix = $leftMargin + int(($xAxisLength * ($cjd - $start_jd)) / ($end_jd - $start_jd));@\\
\mbox{}\verb@        ::drawText($img, $monster, 'Times', 12, 0,@\\
\mbox{}\verb@            $pix, ($height - $bottomMargin) + 8, 'c', 't', $black);@\\
\mbox{}\verb@        $img->line($pix, ($height - $bottomMargin) - $tickSize, $pix,@\\
\mbox{}\verb@                         ($height - $bottomMargin) + $axisOffset, $black);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (($end_jd - $start_jd) < 32) {@\\
\mbox{}\verb@            my ($nt_y, $nt_m) = ($dt_y, $dt_m + 1);@\\
\mbox{}\verb@            if ($nt_m > 12) {@\\
\mbox{}\verb@                $nt_m = 1;@\\
\mbox{}\verb@                $nt_y++;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            my $eom_jd = gregorian_to_jd($nt_y, $nt_m, 1);@\\
\mbox{}\verb@@\\
\mbox{}\verb@            my $md = (int((($dt_d) - 1) / 7) * 7) + 7;@\\
\mbox{}\verb@            for (my $d = gregorian_to_jd($dt_y, $dt_m, $md);@\\
\mbox{}\verb@                 $d < ::min($end_jd, $eom_jd); $d += 7, $md+= 7) {@\\
\mbox{}\verb@                $pix = $leftMargin + int(($xAxisLength * ($d - $start_jd)) / ($end_jd - $start_jd));@\\
\mbox{}\verb@                ::drawText($img, $md, 'Times', 12, 0,@\\
\mbox{}\verb@                    $pix, ($height - $bottomMargin) + 8, 'c', 't', $black);@\\
\mbox{}\verb@                $img->line($pix, ($height - $bottomMargin) - $tickSize,@\\
\mbox{}\verb@                           $pix, ($height - $bottomMargin) + $axisOffset, $black);@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $dt_m++;@\\
\mbox{}\verb@        $dt_d = 1;@\\
\mbox{}\verb@        if ($dt_m > 12) {@\\
\mbox{}\verb@            $dt_y++;@\\
\mbox{}\verb@            $dt_m = 1;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $cjd = gregorian_to_jd($dt_y, $dt_m, $dt_d);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb90}{90}.
\item \NWtxtIdentsUsed\nobreak\  \verb@drawText@\nobreak\ \NWlink{nuweb409}{409}, \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}, \verb@min@\nobreak\ \NWlink{nuweb405}{405}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Label date axis with year numbers only}

There is insufficient room on the date axis to plot months.
Plot year numbers skipping sufficient years between years plotted
so they don't overlap one another.  If four digit year labels would
require more than one year per label, we fall back on two digit labels.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap161}\raggedright\small
\NWtarget{nuweb92}{} $\langle\,${\itshape Label date axis with year numbers only}\nobreak\ {\footnotesize {92}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @{\tt @}\verb@ext =  GD::Image->stringFT($black, $fontFile, 12, 0, 20, 20, "2999 ");@\\
\mbox{}\verb@    $cw = $ext[2] - $ext[0];@\\
\mbox{}\verb@    $lblinc = int(((int(($end_jd - $start_jd) / 365) * $cw) + ($xAxisLength - 1)) / $xAxisLength);@\\
\mbox{}\verb@    $lblinc = 1 if $lblinc < 1;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $single = 0;@\\
\mbox{}\verb@    if ($lblinc > 1) {@\\
\mbox{}\verb@        @{\tt @}\verb@ext =  GD::Image->stringFT($black, $fontFile, 12, 0, 20, 20, "99 ");@\\
\mbox{}\verb@        $cw = $ext[2] - $ext[0];@\\
\mbox{}\verb@        $lblinc = int(((int(($end_jd - $start_jd) / 365) * $cw) + ($xAxisLength - 1)) / $xAxisLength);@\\
\mbox{}\verb@        $lblinc = 1 if $lblinc < 1;@\\
\mbox{}\verb@        $single = 1;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $cjd = $start_jd;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (($start_m != 1) || ($start_d != 1)) {@\\
\mbox{}\verb@        $dt_m = $dt_d = 1;@\\
\mbox{}\verb@        $dt_y++;@\\
\mbox{}\verb@        $cjd = gregorian_to_jd($dt_y, $dt_m, $dt_d);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    while ($cjd < $end_jd) {@\\
\mbox{}\verb@        my $label_x = $leftMargin + int(($xAxisLength * ($cjd - $start_jd)) / ($end_jd - $start_jd));@\\
\mbox{}\verb@        ::drawText($img, $single ? sprintf("%02d", $dt_y % 100) : $dt_y, 'Times', 12, 0,@\\
\mbox{}\verb@            $label_x, ($height - $bottomMargin) + $tickSize, 'c', 't', $black);@\\
\mbox{}\verb@        $img->line($label_x, ($height - $bottomMargin) - $tickSize, $label_x, ($height - $bottomMargin) + $axisOffset, $black);@\\
\mbox{}\verb@        $dt_y += $lblinc;@\\
\mbox{}\verb@        ($dt_m, $dt_d) = (1, 1);@\\
\mbox{}\verb@        $cjd = gregorian_to_jd($dt_y, $dt_m, $dt_d);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb90}{90}.
\item \NWtxtIdentsUsed\nobreak\  \verb@drawText@\nobreak\ \NWlink{nuweb409}{409}, \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Label weight axis at the left}

Draw labels and ticks for the vertical weight axis at the left.  The scale
has already been computed in \verb+$vunit+, so all we need to do here
is the actual drawing.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap162}\raggedright\small
\NWtarget{nuweb93}{} $\langle\,${\itshape Label weight axis at the left}\nobreak\ {\footnotesize {93}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $plotw = $wgt_min; $plotw <= $wgt_max; $plotw += $vunit) {@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $ws = HDiet::monthlog::editWeight($plotw, $ui->{display_unit}, $ui->{decimal_character});@\\
\mbox{}\verb@        my $wy = WeightToY($plotw);@\\
\mbox{}\verb@        main::drawText($img, $ws, 'Times', 12, 0,@\\
\mbox{}\verb@            $leftMargin - 8, ($height - $bottomMargin) - $wy, 'r', 'c', $black);@\\
\mbox{}\verb@        PlotLine(-$axisOffset, $wy, $tickSize - $axisOffset, $wy, $black);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb95}{95}.
\item \NWtxtIdentsUsed\nobreak\  \verb@drawText@\nobreak\ \NWlink{nuweb409}{409}, \verb@editWeight@\nobreak\ \NWlink{nuweb41a}{41a}\NWlink{nuweb485a}{, 485a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Label exercise rung axis if any plotted}

If we've plotted any day with an exercise rung, include the rung scale at
the right of the chart.  We always plot the value of the last rung in the month,
with the rest of the scale adjusted to skip any value which would overwrite
the most recent rung.  In the most common case where the rung does not change during
the month, this provides a precise identification of the run without the need to
interpolate between labels.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap163}\raggedright\small
\NWtarget{nuweb94}{} $\langle\,${\itshape Label exercise rung axis if any plotted}\nobreak\ {\footnotesize {94}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($lrung) {@\\
\mbox{}\verb@        #   Rung axis@\\
\mbox{}\verb@        PlotLine($xAxisLength + $axisOffset, -$axisOffset, $xAxisLength + $axisOffset, $height - ($topMargin + $bottomMargin), $black);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $RUNG_EXCLUSION_ZONE = 6;    # How many rungs to exclude around last rung in monthly log@\\
\mbox{}\verb@                                        # (Should really be calculated from font metrics and window@\\
\mbox{}\verb@                                        #  geometry).@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $ry = RungToY($lrung);@\\
\mbox{}\verb@        main::drawText($img, $lrung, 'Times', 12, 0,@\\
\mbox{}\verb@            ($width - $rightMargin) + 8, ($height - $bottomMargin) - $ry, 'o', 'c', $black);@\\
\mbox{}\verb@        PlotLine($xAxisLength + $axisOffset, $ry, ($xAxisLength + $axisOffset) - $tickSize, $ry, $black);@\\
\mbox{}\verb@@\\
\mbox{}\verb@       for (my $i = 1; $i <= 48; $i = (int($i / 6) * 6) + 6) {@\\
\mbox{}\verb@            if (abs($lrung - $i) >= $RUNG_EXCLUSION_ZONE) {@\\
\mbox{}\verb@                $ry = RungToY($i);@\\
\mbox{}\verb@                main::drawText($img, $i, 'Times', 12, 0,@\\
\mbox{}\verb@                    ($width - $rightMargin) + 8, ($height - $bottomMargin) - $ry, 'o', 'c', $black);@\\
\mbox{}\verb@                PlotLine($xAxisLength + $axisOffset, $ry, ($xAxisLength + $axisOffset) - $tickSize, $ry, $black);@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb95}{95}.
\item \NWtxtIdentsUsed\nobreak\  \verb@drawText@\nobreak\ \NWlink{nuweb409}{409}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Plot weight and rung data on historical chart}

With the scale having been determined and the axes drawn and labeled,
we are finally ready to actually draw the weight and exercise run
lines on the chart.  There are two cases: if we're plotting a
short interval with respect to the width of the chart, there
will be multiple horizontal pixels per day's data and we must
draw lines to connect the days.  If the interval is sufficiently
long, we'll have multiple days' data represented by a single
pixel, in which case we plot the arithmetic mean of the values
in days the pixel encompasses.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap164}\raggedright\small
\NWtarget{nuweb95}{} $\langle\,${\itshape Plot weight and rung data on historical chart}\nobreak\ {\footnotesize {95}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($wgt_max > 0) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Label weight axis at the left}\nobreak\ {\footnotesize \NWlink{nuweb93}{93}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        my $lrung = 0;@\\
\mbox{}\verb@        my $nFlagged = 0;@\\
\mbox{}\verb@        if ($pixelsPerDay > 1) {@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Plot multiple pixels per day}\nobreak\ {\footnotesize \NWlink{nuweb96}{96}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Plot multiple days per pixel}\nobreak\ {\footnotesize \NWlink{nuweb98}{98}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Label exercise rung axis if any plotted}\nobreak\ {\footnotesize \NWlink{nuweb94}{94}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Draw caption with trend summary}\nobreak\ {\footnotesize \NWlink{nuweb100}{100}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Draw title with date range}\nobreak\ {\footnotesize \NWlink{nuweb99}{99}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        $img->string(gdMediumBoldFont, $leftMargin + 40, $topMargin + int(($height - ($topMargin + $bottomMargin)) / 2),@\\
\mbox{}\verb@            "There are no weight log entries in this date range.", $red);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb82}{82}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}


\vbox{
\subsubsection{Plot multiple pixels per day}

The interval being plotted is sufficiently short that when
scaled to the width of the plot each day occupies more than one
pixel.  Iterate over the days and draw line segments for each day.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap165}\raggedright\small
\NWtarget{nuweb96}{} $\langle\,${\itshape Plot multiple pixels per day}\nobreak\ {\footnotesize {96}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my ($pix, $opix);@\\
\mbox{}\verb@    my ($lrg, $ltrend);@\\
\mbox{}\verb@    my ($ow, $owy) = (0, 0);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $cdate = $start_jd; $cdate <= $end_jd; $cdate++) {@\\
\mbox{}\verb@        my $pix = int(($xAxisLength * ($cdate - $start_jd)) / ($end_jd - $start_jd));@\\
\mbox{}\verb@        my ($weight, $trend, $rung, $flags) = getDays($cdate, 1, $ui);@\\
\mbox{}\verb@        $nFlagged += $flags;@\\
\mbox{}\verb@        $weight = 0 if !defined($weight);@\\
\mbox{}\verb@        $trend = 0 if !defined($trend);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   Plot weight@\\
\mbox{}\verb@        if ($weight > 0) {@\\
\mbox{}\verb@            if ($pixelsPerDay > int($sinkerSize * 1.5)) {@\\
\mbox{}\verb@                @\hbox{$\langle\,${\itshape Plot weight entry as float or sinker}\nobreak\ {\footnotesize \NWlink{nuweb97}{97}}$\,\rangle$}\verb@@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                my $nwy = WeightToY($weight);@\\
\mbox{}\verb@                if (($ow > 0) && ($weight > 0)) {@\\
\mbox{}\verb@                    PlotLine($opix, $owy, $pix, $nwy, $dkgrey);@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@                $ow = $weight;@\\
\mbox{}\verb@                $owy = $nwy;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   Plot trend@\\
\mbox{}\verb@        my $ny = WeightToY($trend);@\\
\mbox{}\verb@        if ($ltrend) {@\\
\mbox{}\verb@            if ($trend) {@\\
\mbox{}\verb@                PlotLine($opix, $ltrend, $pix, $ny, $red);@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                PlotLine($opix, $ltrend, $pix, $ltrend, $red);@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $ltrend = $ny if $trend;@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($lrg) {@\\
\mbox{}\verb@            my $rt = $lrg;@\\
\mbox{}\verb@            $lrung = $lrg;@\\
\mbox{}\verb@            if ($rung) {@\\
\mbox{}\verb@                $rt = $rung;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            PlotLine($opix, RungToY($lrg), $pix, RungToY($rt), $blue);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $lrg = $rung;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $opix = $pix;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb95}{95}.
\item \NWtxtIdentsUsed\nobreak\  \verb@getDays@\nobreak\ \NWlink{nuweb77}{77}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Plot weight entry as float or sinker}

If there is sufficient room between the days on the chart, we plot
individual weight entries along with the trend.

Individual weight log entries are plotted as blue diamonds, filled with
yellow if the date is flagged and white otherwise.  If the weight
is above or below the trend line for that day, a green line is drawn
to connect it to the trend and indicate whether the day's weight
is a ``float'' pulling the trend up or a ``sinker'' dragging it down.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap166}\raggedright\small
\NWtarget{nuweb97}{} $\langle\,${\itshape Plot weight entry as float or sinker}\nobreak\ {\footnotesize {97}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@        my $ty = WeightToY($trend);@\\
\mbox{}\verb@        my $wy = WeightToY($weight);@\\
\mbox{}\verb@        my $offset = $wy - $ty;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (($offset < -$sinkerSize) || ($offset > $sinkerSize)) {@\\
\mbox{}\verb@            my $dy = sgn($offset);@\\
\mbox{}\verb@@\\
\mbox{}\verb@            PlotLine($pix, $ty + $dy, $pix, $wy + (($offset > 0) ? -$sinkerSize : $sinkerSize), $green);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   Fill float/sinker with white or yellow, if it's flagged.@\\
\mbox{}\verb@@\\
\mbox{}\verb@        for (my $j = -$sinkerSize; $j <= $sinkerSize; $j++) {@\\
\mbox{}\verb@            my $dx = abs($j) - $sinkerSize;@\\
\mbox{}\verb@@\\
\mbox{}\verb@            PlotLine($pix - $dx, ($wy + $j),@\\
\mbox{}\verb@                     $pix + $dx, ($wy + $j),@\\
\mbox{}\verb@                     $flags ? $yellow : $white);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   Trace the outline of the float/sinker in blue@\\
\mbox{}\verb@@\\
\mbox{}\verb@        PlotLine($pix - $sinkerSize, $wy,@\\
\mbox{}\verb@                 $pix, $wy - $sinkerSize, $blue);@\\
\mbox{}\verb@        PlotLine($pix, $wy - $sinkerSize,@\\
\mbox{}\verb@                 $pix + $sinkerSize, $wy, $blue);@\\
\mbox{}\verb@        PlotLine($pix + $sinkerSize, $wy,@\\
\mbox{}\verb@                 $pix, $wy + $sinkerSize, $blue);@\\
\mbox{}\verb@        PlotLine($pix, $wy + $sinkerSize,@\\
\mbox{}\verb@                 $pix - $sinkerSize, $wy, $blue);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb96}{96}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@sgn@\nobreak\ \NWlink{nuweb405}{405}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Plot multiple days per pixel}

The interval being plotted is sufficiently long with respect
to the width of the plot that we're plotting more than one day's
data per pixel in the chart.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap167}\raggedright\small
\NWtarget{nuweb98}{} $\langle\,${\itshape Plot multiple days per pixel}\nobreak\ {\footnotesize {98}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $w;@\\
\mbox{}\verb@    my $ot = 0;@\\
\mbox{}\verb@    my $t;@\\
\mbox{}\verb@    my $rg;@\\
\mbox{}\verb@    my $oty;@\\
\mbox{}\verb@    my ($ow, $owy) = (0, 0);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $i = 0; $i < $xAxisLength; $i++) {@\\
\mbox{}\verb@        my $sDate = $start_jd + ((($end_jd - $start_jd) * $i) / $xAxisLength);@\\
\mbox{}\verb@        my $eDate = $start_jd + ((($end_jd - $start_jd) * ($i + 1)) / $xAxisLength);@\\
\mbox{}\verb@        my $nd = int($eDate - $sDate);@\\
\mbox{}\verb@        $nd = 1 if ($nd == 0);@\\
\mbox{}\verb@        my ($weight, $trend, $rung, $flags) = getDays($sDate, $nd, $ui);@\\
\mbox{}\verb@        $nFlagged += $flags;@\\
\mbox{}\verb@@\\
\mbox{}\verb@#####   FIXME -- OPTION TO PLOT WEIGHT AS FLOAT/SINKER BAND ABOVE/BELOW TREND@\\
\mbox{}\verb@        #   Plot weight@\\
\mbox{}\verb@        $weight = 0 if !defined($weight);@\\
\mbox{}\verb@        my $nwy = WeightToY($weight);@\\
\mbox{}\verb@        if (($ow > 0) && ($weight > 0)) {@\\
\mbox{}\verb@            PlotLine($i - 1, $owy, $i, $nwy, $dkgrey);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $ow = $weight;@\\
\mbox{}\verb@        $owy = $nwy;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   Plot trend@\\
\mbox{}\verb@        $trend = 0 if !defined($trend);@\\
\mbox{}\verb@        my $nty = WeightToY($trend);@\\
\mbox{}\verb@        if (($ot > 0) && ($trend > 0)) {@\\
\mbox{}\verb@            PlotLine($i - 1, $oty, $i, $nty, $red);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $ot = $trend;@\\
\mbox{}\verb@        $oty = $nty;@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($rung) {@\\
\mbox{}\verb@            my $ry = RungToY($rung);@\\
\mbox{}\verb@            if ($lrung) {@\\
\mbox{}\verb@                PlotLine($i - 1, RungToY($lrung), $i, $ry, $blue);@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            $lrung = $rung;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb95}{95}.
\item \NWtxtIdentsUsed\nobreak\  \verb@getDays@\nobreak\ \NWlink{nuweb77}{77}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Draw title with date range}

We place a title at the top of the chart to indicate the range
of dates it contains.  This is the requested range (which corresponds
with the date axis), and is not adjusted for absent data at the start
and end of the plot.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap168}\raggedright\small
\NWtarget{nuweb99}{} $\langle\,${\itshape Draw title with date range}\nobreak\ {\footnotesize {99}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $title = sprintf("%04d-%02d-%02d &#8211; %04d-%02d-%02d",@\\
\mbox{}\verb@        $start_y, $start_m, $start_d, $end_y, $end_m, $end_d);@\\
\mbox{}\verb@    main::drawText($img, $title, 'Times', 12, 0,@\\
\mbox{}\verb@        int($width / 2), $topMargin - 4, 'c', 'b', $black);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb95}{95}.
\item \NWtxtIdentsUsed\nobreak\  \verb@drawText@\nobreak\ \NWlink{nuweb409}{409}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Draw caption with trend summary}

Add a caption to the chart with the weight and calorie balance
determined by the linear regression fit to the trend line over
the period charted.  We call {\tt analyseTrend} to perform the analysis,
since when we're plotting multiple days per pixel we want to compute
the trend based on the underlying data, not the values processed
by {\tt getDays}, which on small-scale plots may not examine every
day in the interval.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap169}\raggedright\small
\NWtarget{nuweb100}{} $\langle\,${\itshape Draw caption with trend summary}\nobreak\ {\footnotesize {100}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my (@{\tt @}\verb@intervals, @{\tt @}\verb@slopes);@\\
\mbox{}\verb@    push(@{\tt @}\verb@intervals, sprintf("%04d-%02d-%02d", $start_y, $start_m, $start_d),@\\
\mbox{}\verb@                      sprintf("%04d-%02d-%02d", $end_y, $end_m, $end_d));@\\
\mbox{}\verb@    @{\tt @}\verb@slopes = $self->analyseTrend(@{\tt @}\verb@intervals);@\\
\mbox{}\verb@    my $tslope = $slopes[0];@\\
\mbox{}\verb@    my $fracf = $tFlags / $nDays;@\\
\mbox{}\verb@    my $sweekly = $self->{user}->localiseDecimal(sprintf("%.2f", abs($tslope) * 7));@\\
\mbox{}\verb@    my $caption;@\\
\mbox{}\verb@    if ($width < 480) {@\\
\mbox{}\verb@#print(STDERR "Narrow $width:  N = $fitter->{n}  Tslope = $tslope  Fracf = $fracf  Sweekly = $sweekly\n");@\\
\mbox{}\verb@        $caption = (($tslope > 0) ? "Gain" : "Loss") .@\\
\mbox{}\verb@                " $sweekly " .@\\
\mbox{}\verb@                HDiet::monthlog::DELTA_WEIGHT_ABBREVIATIONS->[$ui->{display_unit}] .@\\
\mbox{}\verb@                "/wk.  " .@\\
\mbox{}\verb@                (($tslope > 0) ? "Excess" : "Deficit") .@\\
\mbox{}\verb@                sprintf(": %.0f ", abs($tslope) *@\\
\mbox{}\verb@                    (HDiet::monthlog::CALORIES_PER_WEIGHT_UNIT->[$ui->{display_unit}] /@\\
\mbox{}\verb@                     HDiet::monthlog::CALORIES_PER_ENERGY_UNIT->[$ui->{energy_unit}])) .@\\
\mbox{}\verb@                HDiet::monthlog::ENERGY_ABBREVIATIONS->[$ui->{energy_unit}] . "/day" .@\\
\mbox{}\verb@                "." .@\\
\mbox{}\verb@                (($fracf > 0) ? sprintf("  %.0f%% flag.", $fracf * 100) : '');@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@#print(STDERR "Wide $width:  N = $fitter->{n}  Tslope = $tslope  Fracf = $fracf  Sweekly = $sweekly\n");@\\
\mbox{}\verb@        $caption = 'Weekly ' .@\\
\mbox{}\verb@                (($tslope > 0) ? "gain" : "loss") .@\\
\mbox{}\verb@                " $sweekly " .@\\
\mbox{}\verb@                HDiet::monthlog::DELTA_WEIGHT_UNITS->[$ui->{display_unit}] .@\\
\mbox{}\verb@                "s.  Daily " .@\\
\mbox{}\verb@                (($tslope > 0) ? "excess" : "deficit") .@\\
\mbox{}\verb@                sprintf(": %.0f ", abs($tslope) *@\\
\mbox{}\verb@                    (HDiet::monthlog::CALORIES_PER_WEIGHT_UNIT->[$ui->{display_unit}] /@\\
\mbox{}\verb@                     HDiet::monthlog::CALORIES_PER_ENERGY_UNIT->[$ui->{energy_unit}])) .@\\
\mbox{}\verb@                HDiet::monthlog::ENERGY_UNITS->[$ui->{energy_unit}] . "s" .@\\
\mbox{}\verb@                "." .@\\
\mbox{}\verb@                (($fracf > 0) ? sprintf("  %.0f%% flagged.", $fracf * 100) : '');@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    main::drawText($img, $caption, 'Times', 12, 0,@\\
\mbox{}\verb@        int($width / 2), $height - 20, 'c', 'b', $black);@\\
\mbox{}\verb@    if (($ui->{height} > 0) && ($trend_ndays > 0) && ($trend_last > 0)) {@\\
\mbox{}\verb@        $trend_mean /= $trend_ndays;@\\
\mbox{}\verb@        $caption = "Body mass index: mean " .@\\
\mbox{}\verb@            $self->{user}->localiseDecimal(sprintf("%.1f", $trend_mean / ($ui->{height} / 100) ** 2)) .@\\
\mbox{}\verb@            ", most recent " .@\\
\mbox{}\verb@            $self->{user}->localiseDecimal(sprintf("%.1f", $trend_last / ($ui->{height} / 100) ** 2)) . ".";@\\
\mbox{}\verb@        main::drawText($img, $caption, 'Times', 12, 0,@\\
\mbox{}\verb@            int($width / 2), $height - 4, 'c', 'b', $black);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb95}{95}.
\item \NWtxtIdentsUsed\nobreak\  \verb@analyseTrend@\nobreak\ \NWlink{nuweb79}{79}, \verb@CALORIES_PER_ENERGY_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@CALORIES_PER_WEIGHT_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@drawText@\nobreak\ \NWlink{nuweb409}{409}, \verb@ENERGY_UNITS@\nobreak\ \NWlink{nuweb24}{24}, \verb@localiseDecimal@\nobreak\ \NWlink{nuweb146b}{146b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Draw Badge Image}

The {\tt drawBadgeImage} method creates a ``badge'' image suitable for
inclusion on a Web page which shows, as of the user's most recent
log entry, the current weight, energy balance, and rate of weight
gain or loss.  The PNG image is written to the file handle given by
the first argument, or {\tt STDOUT} if it is not defined.  The
second argument specifies the interval over which the trend
should be computed: positive for a number of days, negative for
a number of months.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap170}\raggedright\small
\NWtarget{nuweb101a}{} \verb@"HDiet/history.pm"@\nobreak\ {\footnotesize {101a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub drawBadgeImage {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($outfile, $trendDays) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($ui, $user_file_name) = ($self->{user}, $self->{user_file_name});@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (!(defined $outfile)) {@\\
\mbox{}\verb@            $outfile = \*STDOUT;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb75}{75}\NWlink{nuweb76}{, 76}\NWlink{nuweb77}{, 77}\NWlink{nuweb78}{, 78}\NWlink{nuweb79}{, 79}\NWlink{nuweb82}{, 82}\NWlink{nuweb83}{, 83}\NWlink{nuweb101a}{, 101a}\NWlink{nuweb101b}{b}\NWlink{nuweb102a}{, 102a}\NWlink{nuweb102b}{b}\NWlink{nuweb103a}{, 103a}\NWlink{nuweb103b}{b}\NWlink{nuweb104}{, 104}\NWlink{nuweb105}{, 105}\NWlink{nuweb108}{, 108}\NWlink{nuweb109a}{, 109a}\NWlink{nuweb111}{, 111}.
\item \NWtxtIdentsDefed\nobreak\  \verb@drawBadgeImage@\nobreak\ \NWlink{nuweb113a}{113a}\NWlink{nuweb220b}{, 220b}\NWlink{nuweb392}{, 392}\NWlink{nuweb461}{, 461}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\noindent
Create the image and initialise it from the badge template image
file.  A full colour image is generated, as the antialiasing
of the logo and text fonts, combined with our colour coding
the trend-derived information, exceeds the 256 colours
available in a palette-mapped image.  The image is
interlaced so as to load more gracefully on a Web page.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap171}\raggedright\small
\NWtarget{nuweb101b}{} \verb@"HDiet/history.pm"@\nobreak\ {\footnotesize {101b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@        ($width, $height) = (200, 78);  # Badge image size@\\
\mbox{}\verb@        my ($printFriendly, $monochrome) = (0, 0);@\\
\mbox{}\verb@        $img = GD::Image->newFromPng("@\hbox{$\langle\,${\itshape Image and Icon Directory}\nobreak\ {\footnotesize \NWlink{nuweb7a}{7a}}$\,\rangle$}\verb@/badgeback.png", 1);@\\
\mbox{}\verb@        die("Cannot load image template @\hbox{$\langle\,${\itshape Image and Icon Directory}\nobreak\ {\footnotesize \NWlink{nuweb7a}{7a}}$\,\rangle$}\verb@/badgeback.png") if !$img;@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Allocate colours for chart}\nobreak\ {\footnotesize \NWlink{nuweb47}{47}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        my $dkgreen =  $img->colorAllocate(  0, 160,   0);@\\
\mbox{}\verb@        $img->interlaced('true');@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb75}{75}\NWlink{nuweb76}{, 76}\NWlink{nuweb77}{, 77}\NWlink{nuweb78}{, 78}\NWlink{nuweb79}{, 79}\NWlink{nuweb82}{, 82}\NWlink{nuweb83}{, 83}\NWlink{nuweb101a}{, 101a}\NWlink{nuweb101b}{b}\NWlink{nuweb102a}{, 102a}\NWlink{nuweb102b}{b}\NWlink{nuweb103a}{, 103a}\NWlink{nuweb103b}{b}\NWlink{nuweb104}{, 104}\NWlink{nuweb105}{, 105}\NWlink{nuweb108}{, 108}\NWlink{nuweb109a}{, 109a}\NWlink{nuweb111}{, 111}.
\item \NWtxtIdentsUsed\nobreak\  \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\noindent
Determine the dates of the first and last log entries in the user's
database.  If there are no log entries at all, we generate a
badge with the legend ``No Log Entries'' in large bold type.
Otherwise, we proceed to determine the interval from the most recently
logged weight and the start of the requested trend computation
interval.  If the requested interval exceeds the length of data
in the database, the interval is reduced to begin with the first
log entry present.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap172}\raggedright\small
\NWtarget{nuweb102a}{} \verb@"HDiet/history.pm"@\nobreak\ {\footnotesize {102a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@        my ($ly, $lm, $ld, $ldu, $lw, $lt) = $self->lastDay();@\\
\mbox{}\verb@        my $l_jd = gregorian_to_jd($ly, $lm, $ld);@\\
\mbox{}\verb@        my ($s_y, $s_m, $s_d) = $self->firstDay();@\\
\mbox{}\verb@        my $s_jd = gregorian_to_jd($s_y, $s_m, $s_d);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($cx, $cy) = (132, 3);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (defined($lw)) {@\\
\mbox{}\verb@@\\
\mbox{}\verb@            my (@{\tt @}\verb@intervals, @{\tt @}\verb@slopes, $tslope, $deltaW, $deltaE);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb75}{75}\NWlink{nuweb76}{, 76}\NWlink{nuweb77}{, 77}\NWlink{nuweb78}{, 78}\NWlink{nuweb79}{, 79}\NWlink{nuweb82}{, 82}\NWlink{nuweb83}{, 83}\NWlink{nuweb101a}{, 101a}\NWlink{nuweb101b}{b}\NWlink{nuweb102a}{, 102a}\NWlink{nuweb102b}{b}\NWlink{nuweb103a}{, 103a}\NWlink{nuweb103b}{b}\NWlink{nuweb104}{, 104}\NWlink{nuweb105}{, 105}\NWlink{nuweb108}{, 108}\NWlink{nuweb109a}{, 109a}\NWlink{nuweb111}{, 111}.
\item \NWtxtIdentsUsed\nobreak\  \verb@firstDay@\nobreak\ \NWlink{nuweb109a}{109a}, \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}, \verb@lastDay@\nobreak\ \NWlink{nuweb108}{108}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\noindent
If more than one day's log entry is present, fit a trend to the
data in the interval and compute the energy balance and
rate of gain or loss from its slope.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap173}\raggedright\small
\NWtarget{nuweb102b}{} \verb@"HDiet/history.pm"@\nobreak\ {\footnotesize {102b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@            if (($l_jd - $s_jd) > 1) {@\\
\mbox{}\verb@                my ($f_y, $f_m, $f_d) = $self->firstDayOfInterval($ly, $lm, $ld, $trendDays);@\\
\mbox{}\verb@                my $f_jd = gregorian_to_jd($f_y, $f_m, $f_d);@\\
\mbox{}\verb@                push(@{\tt @}\verb@intervals, sprintf("%04d-%02d-%02d", $f_y, $f_m, $f_d),@\\
\mbox{}\verb@                                  sprintf("%04d-%02d-%02d", $ly, $lm, $ld));@\\
\mbox{}\verb@                @{\tt @}\verb@slopes = $self->analyseTrend(@{\tt @}\verb@intervals);@\\
\mbox{}\verb@                $tslope = $slopes[0];@\\
\mbox{}\verb@                $deltaW = sprintf("%.2f", abs($tslope) * 7);@\\
\mbox{}\verb@                $deltaW =~ s/\./$ui->{decimal_character}/;@\\
\mbox{}\verb@                $deltaE = sprintf("%.0f", abs($tslope) *@\\
\mbox{}\verb@                    (HDiet::monthlog::CALORIES_PER_WEIGHT_UNIT->[$ui->{display_unit}] /@\\
\mbox{}\verb@                     HDiet::monthlog::CALORIES_PER_ENERGY_UNIT->[$ui->{energy_unit}]));@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb75}{75}\NWlink{nuweb76}{, 76}\NWlink{nuweb77}{, 77}\NWlink{nuweb78}{, 78}\NWlink{nuweb79}{, 79}\NWlink{nuweb82}{, 82}\NWlink{nuweb83}{, 83}\NWlink{nuweb101a}{, 101a}\NWlink{nuweb101b}{b}\NWlink{nuweb102a}{, 102a}\NWlink{nuweb102b}{b}\NWlink{nuweb103a}{, 103a}\NWlink{nuweb103b}{b}\NWlink{nuweb104}{, 104}\NWlink{nuweb105}{, 105}\NWlink{nuweb108}{, 108}\NWlink{nuweb109a}{, 109a}\NWlink{nuweb111}{, 111}.
\item \NWtxtIdentsUsed\nobreak\  \verb@analyseTrend@\nobreak\ \NWlink{nuweb79}{79}, \verb@CALORIES_PER_ENERGY_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@CALORIES_PER_WEIGHT_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@firstDayOfInterval@\nobreak\ \NWlink{nuweb111}{111}, \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\noindent
Title the badge with the date of the most recent log entry.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap174}\raggedright\small
\NWtarget{nuweb103a}{} \verb@"HDiet/history.pm"@\nobreak\ {\footnotesize {103a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@            main::drawText($img, sprintf("%04d-%02d-%02d", $ly, $lm, $ld),@\\
\mbox{}\verb@                'DejaVuLGCSans-Bold', 10, 0, $cx, $cy, 'c', 't', $black);@\\
\mbox{}\verb@                $cy += 13;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb75}{75}\NWlink{nuweb76}{, 76}\NWlink{nuweb77}{, 77}\NWlink{nuweb78}{, 78}\NWlink{nuweb79}{, 79}\NWlink{nuweb82}{, 82}\NWlink{nuweb83}{, 83}\NWlink{nuweb101a}{, 101a}\NWlink{nuweb101b}{b}\NWlink{nuweb102a}{, 102a}\NWlink{nuweb102b}{b}\NWlink{nuweb103a}{, 103a}\NWlink{nuweb103b}{b}\NWlink{nuweb104}{, 104}\NWlink{nuweb105}{, 105}\NWlink{nuweb108}{, 108}\NWlink{nuweb109a}{, 109a}\NWlink{nuweb111}{, 111}.
\item \NWtxtIdentsUsed\nobreak\  \verb@drawText@\nobreak\ \NWlink{nuweb409}{409}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\noindent
The most recent weight is drawn below the date in a large, bold
font.  The weight unit follows the weight entry, for example
``{\sf 75.2~kg}'', except when stones and pounds are used,
in which case the weight will be given like ``{\sf 11~st~11.8~lb}''.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap175}\raggedright\small
\NWtarget{nuweb103b}{} \verb@"HDiet/history.pm"@\nobreak\ {\footnotesize {103b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@            my $ws = HDiet::monthlog::editWeight($lw *@\\
\mbox{}\verb@                HDiet::monthlog::WEIGHT_CONVERSION->[$ldu][$ui->{display_unit}],@\\
\mbox{}\verb@                $ui->{display_unit}, $ui->{decimal_character});@\\
\mbox{}\verb@            my ($wu, $eu) = (HDiet::monthlog::WEIGHT_ABBREVIATIONS->[$ui->{display_unit}],@\\
\mbox{}\verb@                             HDiet::monthlog::ENERGY_ABBREVIATIONS->[$ui->{energy_unit}]);@\\
\mbox{}\verb@            if ($ui->{display_unit} =~ HDiet::monthlog::WEIGHT_STONE) {@\\
\mbox{}\verb@                $ws =~ s/\s/" $wu "/e;@\\
\mbox{}\verb@                $wu = HDiet::monthlog::WEIGHT_ABBREVIATIONS->[HDiet::monthlog::WEIGHT_POUND];@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            $ws .= " $wu";@\\
\mbox{}\verb@            main::drawText($img, $ws,@\\
\mbox{}\verb@                'DejaVuLGCSans-Bold', 12, 0, $cx, $cy, 'c', 't', $black);@\\
\mbox{}\verb@            $cy += 16;@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb75}{75}\NWlink{nuweb76}{, 76}\NWlink{nuweb77}{, 77}\NWlink{nuweb78}{, 78}\NWlink{nuweb79}{, 79}\NWlink{nuweb82}{, 82}\NWlink{nuweb83}{, 83}\NWlink{nuweb101a}{, 101a}\NWlink{nuweb101b}{b}\NWlink{nuweb102a}{, 102a}\NWlink{nuweb102b}{b}\NWlink{nuweb103a}{, 103a}\NWlink{nuweb103b}{b}\NWlink{nuweb104}{, 104}\NWlink{nuweb105}{, 105}\NWlink{nuweb108}{, 108}\NWlink{nuweb109a}{, 109a}\NWlink{nuweb111}{, 111}.
\item \NWtxtIdentsUsed\nobreak\  \verb@drawText@\nobreak\ \NWlink{nuweb409}{409}, \verb@editWeight@\nobreak\ \NWlink{nuweb41a}{41a}\NWlink{nuweb485a}{, 485a}, \verb@WEIGHT_POUND@\nobreak\ \NWlink{nuweb24}{24}, \verb@WEIGHT_STONE@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\noindent
If we were able to compute a trend slope, append lines giving the
length of the trend computation period, the daily energy balance, and
the weekly weight gain or loss.  If no trend is defined due to
insufficient data, show a message to that effect.  Finally, write the
completed badge image to the output file in PNG format.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap176}\raggedright\small
\NWtarget{nuweb104}{} \verb@"HDiet/history.pm"@\nobreak\ {\footnotesize {104}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@            if (defined($deltaW)) {@\\
\mbox{}\verb@                #   Trend label@\\
\mbox{}\verb@                main::drawText($img,@\\
\mbox{}\verb@                    abs($trendDays) . ' ' . (($trendDays > 0) ? 'Day' : 'Month') . 'Trend',@\\
\mbox{}\verb@                    'DejaVuLGCSans', 10, 0, $cx, $cy, 'c', 't', $black);@\\
\mbox{}\verb@                $cy += 14;@\\
\mbox{}\verb@@\\
\mbox{}\verb@                #   Energy balance@\\
\mbox{}\verb@                main::drawText($img,@\\
\mbox{}\verb@                    (($tslope <= 0) ? 'Deficit' : 'Excess') . " $deltaE $eu/day",@\\
\mbox{}\verb@                    'DejaVuLGCSans', 10, 0, $cx, $cy, 'c', 't',@\\
\mbox{}\verb@                    (($tslope <= 0) ? $dkgreen : $red));@\\
\mbox{}\verb@                $cy += 14;@\\
\mbox{}\verb@@\\
\mbox{}\verb@                #   Weekly weight change@\\
\mbox{}\verb@                main::drawText($img, (($tslope <= 0) ? 'Loss' : 'Gain') . " $deltaW $wu/week",@\\
\mbox{}\verb@                    'DejaVuLGCSans', 10, 0, $cx, $cy, 'c', 't',@\\
\mbox{}\verb@                    (($tslope <= 0) ? $dkgreen : $red));@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                $cy += 18;@\\
\mbox{}\verb@                main::drawText($img, "Trend not defined.",@\\
\mbox{}\verb@                    'DejaVuLGCSans', 10, 0, $cx, $cy, 'c', 't', $black);@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $cy += int($height / 2) - 12;@\\
\mbox{}\verb@            main::drawText($img, 'No Log',@\\
\mbox{}\verb@                'DejaVuLGCSans-Bold', 12, 0, $cx, $cy, 'c', 'c', $black);@\\
\mbox{}\verb@                $cy += 18;@\\
\mbox{}\verb@            main::drawText($img, 'Entries',@\\
\mbox{}\verb@                'DejaVuLGCSans-Bold', 12, 0, $cx, $cy, 'c', 'c', $black);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print($outfile $img->png());@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb75}{75}\NWlink{nuweb76}{, 76}\NWlink{nuweb77}{, 77}\NWlink{nuweb78}{, 78}\NWlink{nuweb79}{, 79}\NWlink{nuweb82}{, 82}\NWlink{nuweb83}{, 83}\NWlink{nuweb101a}{, 101a}\NWlink{nuweb101b}{b}\NWlink{nuweb102a}{, 102a}\NWlink{nuweb102b}{b}\NWlink{nuweb103a}{, 103a}\NWlink{nuweb103b}{b}\NWlink{nuweb104}{, 104}\NWlink{nuweb105}{, 105}\NWlink{nuweb108}{, 108}\NWlink{nuweb109a}{, 109a}\NWlink{nuweb111}{, 111}.
\item \NWtxtIdentsUsed\nobreak\  \verb@drawText@\nobreak\ \NWlink{nuweb409}{409}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Generate synthetic data}

The {\tt syntheticData} method fills the selected field
for the given date range with data generated according to
its arguments.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap177}\raggedright\small
\NWtarget{nuweb105}{} \verb@"HDiet/history.pm"@\nobreak\ {\footnotesize {105}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub syntheticData {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($start_date,                    # Start date: YYYY-MM-DD@\\
\mbox{}\verb@            $end_date,                      # End date:   YYYY-MM-DD@\\
\mbox{}\verb@            $field_name,                    # Name of field to be filled@\\
\mbox{}\verb@            $fill_fraction,                 # Fraction of days to fill@\\
\mbox{}\verb@            $start_value,                   # Start value@\\
\mbox{}\verb@            $end_value,                     # End value@\\
\mbox{}\verb@            $format,                        # Format for rounding numbers@\\
\mbox{}\verb@            ) = splice(@{\tt @}\verb@_, 0, 7);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($ui, $user_file_name) = ($self->{user}, $self->{user_file_name});@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Determine the number of days in the historical interval}\nobreak\ {\footnotesize \NWlink{nuweb84}{84}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Fill cache with monthly logs in the date range}\nobreak\ {\footnotesize \NWlink{nuweb112}{112}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($ngen, $nskip) = (0, 0);@\\
\mbox{}\verb@        for (my $j = $start_jd; $j <= $end_jd; $j++) {@\\
\mbox{}\verb@            if (rand() <= $fill_fraction) {@\\
\mbox{}\verb@                my ($cd_y, $cd_m, $cd_d) = jd_to_gregorian($j);@\\
\mbox{}\verb@                my $v = $start_value + ($end_value - $start_value) * (($j - $start_jd) / ($end_jd - $start_jd));@\\
\mbox{}\verb@@\\
\mbox{}\verb@                @\hbox{$\langle\,${\itshape Apply perturbation functions to value}\nobreak\ {\footnotesize \NWlink{nuweb107}{107}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@                $v = sprintf($format, $v);@\\
\mbox{}\verb@#print("    $j  $v<br />\n");@\\
\mbox{}\verb@                my $monkey = sprintf("%04d-%02d", $cd_y, $cd_m);@\\
\mbox{}\verb@                if (!defined($logs{$monkey})) {@\\
\mbox{}\verb@                    @\hbox{$\langle\,${\itshape Create new month for synthetic data}\nobreak\ {\footnotesize \NWlink{nuweb106}{106}}$\,\rangle$}\verb@@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@                $logs{$monkey}->{$field_name}[$cd_d] = $v;@\\
\mbox{}\verb@                $ngen++;@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@#print("    $j<br />\n");@\\
\mbox{}\verb@                $nskip++;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Write back all items in the cache}\nobreak\ {\footnotesize \NWlink{nuweb113a}{113a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@if (0) {@\\
\mbox{}\verb@print("<pre>\n");@\\
\mbox{}\verb@for my $l (sort(keys(%logs))) {@\\
\mbox{}\verb@    $logs{$l} ->describe();@\\
\mbox{}\verb@}@\\
\mbox{}\verb@print("</pre>\n");@\\
\mbox{}\verb@}@\\
\mbox{}\verb@        print("<h3>$ngen days generated, $nskip days skipped.</h3>\n");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb75}{75}\NWlink{nuweb76}{, 76}\NWlink{nuweb77}{, 77}\NWlink{nuweb78}{, 78}\NWlink{nuweb79}{, 79}\NWlink{nuweb82}{, 82}\NWlink{nuweb83}{, 83}\NWlink{nuweb101a}{, 101a}\NWlink{nuweb101b}{b}\NWlink{nuweb102a}{, 102a}\NWlink{nuweb102b}{b}\NWlink{nuweb103a}{, 103a}\NWlink{nuweb103b}{b}\NWlink{nuweb104}{, 104}\NWlink{nuweb105}{, 105}\NWlink{nuweb108}{, 108}\NWlink{nuweb109a}{, 109a}\NWlink{nuweb111}{, 111}.
\item \NWtxtIdentsDefed\nobreak\  \verb@syntheticData@\nobreak\ \NWlink{nuweb107}{107}\NWlink{nuweb359}{, 359}.\item \NWtxtIdentsUsed\nobreak\  \verb@describe@\nobreak\ \NWlink{nuweb27}{27}\NWlink{nuweb122}{, 122}\NWlink{nuweb150}{, 150}\NWlink{nuweb156a}{, 156a}, \verb@jd_to_gregorian@\nobreak\ \NWlink{nuweb448}{448}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Create new month for synthetic data}

The month for which we're generating data does not appear in the
database.  Create a blank monthly log into which the data will be
generated.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap178}\raggedright\small
\NWtarget{nuweb106}{} $\langle\,${\itshape Create new month for synthetic data}\nobreak\ {\footnotesize {106}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $mlog = HDiet::monthlog->new();@\\
\mbox{}\verb@    $logs{$monkey} = $mlog;@\\
\mbox{}\verb@    $mlog->{login_name} = $ui->{login_name};@\\
\mbox{}\verb@    $mlog->{year} = $cd_y;@\\
\mbox{}\verb@    $mlog->{month} = $cd_m;@\\
\mbox{}\verb@    $mlog->{log_unit} = $ui->{log_unit};@\\
\mbox{}\verb@    $mlog->{last_modification_time} = 0;@\\
\mbox{}\verb@    $mlog->{trend_carry_forward} = 0;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb105}{105}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Apply perturbation functions to value}

The list of perturbation functions specified by the balance of
the argument list are applied to the current value.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap179}\raggedright\small
\NWtarget{nuweb107}{} $\langle\,${\itshape Apply perturbation functions to value}\nobreak\ {\footnotesize {107}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $n = 0; $n <= $#_; $n++) {@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   'uniform', <range>@\\
\mbox{}\verb@        if ($_[$n] eq 'uniform') {@\\
\mbox{}\verb@            $n++;@\\
\mbox{}\verb@            $v += rand($_[$n] * 2) - $_[$n];@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   'gaussian', <range>@\\
\mbox{}\verb@        } elsif ($_[$n] eq 'gaussian') {@\\
\mbox{}\verb@            $n++;@\\
\mbox{}\verb@            my $g = 0;@\\
\mbox{}\verb@            for (my $i = 0; $i < 8; $i++) {@\\
\mbox{}\verb@                $g += rand();@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            $g /= 8;@\\
\mbox{}\verb@            $v += ($_[$n] * 2 * $g) - $_[$n];@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   'sine', <factor>, <period>, <phase>@\\
\mbox{}\verb@        } elsif ($_[$n] eq 'sine') {@\\
\mbox{}\verb@            my $factor = $_[++$n];@\\
\mbox{}\verb@            my $period = $_[++$n];@\\
\mbox{}\verb@            my $phase  = $_[++$n];@\\
\mbox{}\verb@            $period = 31 if $period eq '';@\\
\mbox{}\verb@            $phase = 0 if $phase eq '';@\\
\mbox{}\verb@            my $pi = 4 * atan2(1, 1);@\\
\mbox{}\verb@            $v += $factor * sin((2 * $pi) * ((($j + $phase) - $start_jd) / $period));@\\
\mbox{}\verb@@\\
\mbox{}\verb@        } elsif ($_[$n] ne '') {@\\
\mbox{}\verb@            die("history::syntheticData: Invalid perturbation function $_[$n]");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb105}{105}.
\item \NWtxtIdentsUsed\nobreak\  \verb@syntheticData@\nobreak\ \NWlink{nuweb105}{105}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Utility historical queries}

The following methods, which are primarily intended to be used internally,
may also be called by any possessor of a {\tt history} object.

}

\vbox{
\subsection{Last day in database}

The last day with a weight entry in the database is returned as a list
of (year, month, day, display\_unit, weight, trend). If the database
contains no weight entries at all, {\tt undef} is returned.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap180}\raggedright\small
\NWtarget{nuweb108}{} \verb@"HDiet/history.pm"@\nobreak\ {\footnotesize {108}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub lastDay {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Obtain list of years}\nobreak\ {\footnotesize \NWlink{nuweb109b}{109b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        for (my $y = $#years; $y >= 0; $y--) {@\\
\mbox{}\verb@            my @{\tt @}\verb@months = $self->{user}->enumerateMonths($years[$y]);@\\
\mbox{}\verb@            for (my $m = $#months; $m >= 0; $m--) {@\\
\mbox{}\verb@                @\hbox{$\langle\,${\itshape Ensure month is in cache}\nobreak\ {\footnotesize \NWlink{nuweb110}{110}}$\,\rangle$}\verb@@\\
\mbox{}\verb@                for (my $d = $logs{$months[$m]}->monthdays(); $d >= 1;  $d--) {@\\
\mbox{}\verb@                    if ($logs{$months[$m]}->{weight}[$d]) {@\\
\mbox{}\verb@                        return ($logs{$months[$m]}->{year}, $logs{$months[$m]}->{month}, $d,@\\
\mbox{}\verb@                                $logs{$months[$m]}->{log_unit},@\\
\mbox{}\verb@                                $logs{$months[$m]}->{weight}[$d],@\\
\mbox{}\verb@                                $logs{$months[$m]}->{trend}[$d]);@\\
\mbox{}\verb@                    }@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return undef;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb75}{75}\NWlink{nuweb76}{, 76}\NWlink{nuweb77}{, 77}\NWlink{nuweb78}{, 78}\NWlink{nuweb79}{, 79}\NWlink{nuweb82}{, 82}\NWlink{nuweb83}{, 83}\NWlink{nuweb101a}{, 101a}\NWlink{nuweb101b}{b}\NWlink{nuweb102a}{, 102a}\NWlink{nuweb102b}{b}\NWlink{nuweb103a}{, 103a}\NWlink{nuweb103b}{b}\NWlink{nuweb104}{, 104}\NWlink{nuweb105}{, 105}\NWlink{nuweb108}{, 108}\NWlink{nuweb109a}{, 109a}\NWlink{nuweb111}{, 111}.
\item \NWtxtIdentsDefed\nobreak\  \verb@lastDay@\nobreak\ \NWlink{nuweb102a}{102a}\NWlink{nuweb215}{, 215}\NWlink{nuweb253}{, 253}\NWlink{nuweb275}{, 275}.\item \NWtxtIdentsUsed\nobreak\  \verb@enumerateMonths@\nobreak\ \NWlink{nuweb140}{140}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{First day in database}

The first day with a weight entry in the database is returned as a
list of (year, month, day).  If the database contains no weight entries
at all, {\tt undef} is returned.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap181}\raggedright\small
\NWtarget{nuweb109a}{} \verb@"HDiet/history.pm"@\nobreak\ {\footnotesize {109a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub firstDay {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Obtain list of years}\nobreak\ {\footnotesize \NWlink{nuweb109b}{109b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        for (my $y = 0; $y <= $#years; $y++) {@\\
\mbox{}\verb@            my @{\tt @}\verb@months = $self->{user}->enumerateMonths($years[$y]);@\\
\mbox{}\verb@            for (my $m = 0; $m <= $#months; $m++) {@\\
\mbox{}\verb@                @\hbox{$\langle\,${\itshape Ensure month is in cache}\nobreak\ {\footnotesize \NWlink{nuweb110}{110}}$\,\rangle$}\verb@@\\
\mbox{}\verb@                for (my $d = 1; $d <= $logs{$months[$m]}->monthdays();  $d++) {@\\
\mbox{}\verb@                    if ($logs{$months[$m]}->{weight}[$d]) {@\\
\mbox{}\verb@                        return ($logs{$months[$m]}->{year}, $logs{$months[$m]}->{month}, $d);@\\
\mbox{}\verb@                    }@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return undef;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb75}{75}\NWlink{nuweb76}{, 76}\NWlink{nuweb77}{, 77}\NWlink{nuweb78}{, 78}\NWlink{nuweb79}{, 79}\NWlink{nuweb82}{, 82}\NWlink{nuweb83}{, 83}\NWlink{nuweb101a}{, 101a}\NWlink{nuweb101b}{b}\NWlink{nuweb102a}{, 102a}\NWlink{nuweb102b}{b}\NWlink{nuweb103a}{, 103a}\NWlink{nuweb103b}{b}\NWlink{nuweb104}{, 104}\NWlink{nuweb105}{, 105}\NWlink{nuweb108}{, 108}\NWlink{nuweb109a}{, 109a}\NWlink{nuweb111}{, 111}.
\item \NWtxtIdentsDefed\nobreak\  \verb@firstDay@\nobreak\ \NWlink{nuweb102a}{102a}\NWlink{nuweb215}{, 215}\NWlink{nuweb253}{, 253}.\item \NWtxtIdentsUsed\nobreak\  \verb@enumerateMonths@\nobreak\ \NWlink{nuweb140}{140}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Obtain list of years}

If it hasn't previously been done, obtain a list of years for which
logs are present for this user.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap182}\raggedright\small
\NWtarget{nuweb109b}{} $\langle\,${\itshape Obtain list of years}\nobreak\ {\footnotesize {109b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($#years < 0) {@\\
\mbox{}\verb@        @{\tt @}\verb@years = $self->{user}->enumerateYears();@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb108}{108}\NWlink{nuweb109a}{, 109a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@enumerateYears@\nobreak\ \NWlink{nuweb141}{141}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Ensure month is in cache}

Test whether the present month's log is in the cache.  If not,
bring it in.  We are guaranteed at this point that the log for
this month is actually in the database.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap183}\raggedright\small
\NWtarget{nuweb110}{} $\langle\,${\itshape Ensure month is in cache}\nobreak\ {\footnotesize {110}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (!$logs{$months[$m]}) {@\\
\mbox{}\verb@        open(FL, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$self->{user_file_name}/$months[$m].hdb") ||@\\
\mbox{}\verb@            die("Cannot open monthly log file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$self->{user_file_name}/$months[$m].hdb");@\\
\mbox{}\verb@        my $mlog = HDiet::monthlog->new();@\\
\mbox{}\verb@        $logs{$months[$m]} = $mlog;@\\
\mbox{}\verb@        $mlog->load(\*FL);@\\
\mbox{}\verb@        close(FL);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb108}{108}\NWlink{nuweb109a}{, 109a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{First day of interval}

Given the date of the last day in an interval specified by a
number of days (week, fortnight) or months (month, quarter,
year), return the date of the first day in the specified interval.
Intervals defined in days are specified by positive arguments, while
negative arguments specify spans of months.  When backing up by a
given number of months leaves us at a day number greater than
the days in the starting month, we adjust the date to the last
day of that month.

This function may be called either as a method of a history object or
directly without reference to an object; it references nothing in the
object in any case.  There is no check as to whether the computed
start of interval is before or after the first day in the database.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap184}\raggedright\small
\NWtarget{nuweb111}{} \verb@"HDiet/history.pm"@\nobreak\ {\footnotesize {111}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub firstDayOfInterval {@\\
\mbox{}\verb@        if ($#_ > 3) {@\\
\mbox{}\verb@            my $self = shift;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        my ($year, $month, $day, $interval) = @{\tt @}\verb@_;@\\
\mbox{}\verb@#print("Fdoi E($interval): $year-$month-$day\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($interval >= 0) {@\\
\mbox{}\verb@            my $jdEnd = gregorian_to_jd($year, $month, $day);@\\
\mbox{}\verb@            ($year, $month, $day) = jd_to_gregorian($jdEnd - $interval);@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            while ($interval < 0) {@\\
\mbox{}\verb@                ($year, $month) = HDiet::monthlog::previousMonth($year, $month);@\\
\mbox{}\verb@                $interval++;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            if ($day > HDiet::monthlog::monthdays($year, $month)) {@\\
\mbox{}\verb@                $day = HDiet::monthlog::monthdays($year, $month);@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@#print("Fdoi X($interval): $year-$month-$day\n");@\\
\mbox{}\verb@        return ($year, $month, $day);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb75}{75}\NWlink{nuweb76}{, 76}\NWlink{nuweb77}{, 77}\NWlink{nuweb78}{, 78}\NWlink{nuweb79}{, 79}\NWlink{nuweb82}{, 82}\NWlink{nuweb83}{, 83}\NWlink{nuweb101a}{, 101a}\NWlink{nuweb101b}{b}\NWlink{nuweb102a}{, 102a}\NWlink{nuweb102b}{b}\NWlink{nuweb103a}{, 103a}\NWlink{nuweb103b}{b}\NWlink{nuweb104}{, 104}\NWlink{nuweb105}{, 105}\NWlink{nuweb108}{, 108}\NWlink{nuweb109a}{, 109a}\NWlink{nuweb111}{, 111}.
\item \NWtxtIdentsDefed\nobreak\  \verb@firstDayOfInterval@\nobreak\ \NWlink{nuweb102b}{102b}\NWlink{nuweb215}{, 215}\NWlink{nuweb265b}{, 265b}\NWlink{nuweb269}{, 269}\NWlink{nuweb298}{, 298}.\item \NWtxtIdentsUsed\nobreak\  \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}, \verb@jd_to_gregorian@\nobreak\ \NWlink{nuweb448}{448}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}, \verb@previousMonth@\nobreak\ \NWlink{nuweb70}{70}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Monthly log cache utilities}

To avoid repeated loading and decoding of monthly logs, we maintain
a cache in the hash \verb+%logs+ which is keyed by the year and month
in ISO-8601 format, for example ``{\tt 2004-09}''.  The following
macros perform various operations on the cache.
}

\vbox{
\subsection{Fill cache with monthly logs in the date range}

For each month in the range of dates between \verb+$start_date+ and
\verb+$end_date+ we load its monthly log, if extant in the database
and not already in the cache, into the \verb+%logs+ cache.  Note that
missing logs within the range will not be present in the cache; it's
the responsibility of the code which accesses the cache to handle this
appropriately.  You must have determined the date span in the request
(which precomputes several variables needed here) before invoking this
code.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap185}\raggedright\small
\NWtarget{nuweb112}{} $\langle\,${\itshape Fill cache with monthly logs in the date range}\nobreak\ {\footnotesize {112}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my ($cur_y, $cur_m) = ($start_y, $start_m);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $monkey = sprintf("%04d-%02d", $start_y, $start_m); $monkey le sprintf("%04d-%02d", $end_y, $end_m); $monkey = sprintf("%04d-%02d", $cur_y, $cur_m)) {@\\
\mbox{}\verb@        if (!$logs{$monkey}) {@\\
\mbox{}\verb@            if (-f "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$monkey.hdb") {@\\
\mbox{}\verb@                open(FL, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$monkey.hdb") ||@\\
\mbox{}\verb@                    die("Cannot open monthly log file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$monkey.hdb");@\\
\mbox{}\verb@                my $mlog = HDiet::monthlog->new();@\\
\mbox{}\verb@                $logs{$monkey} = $mlog;@\\
\mbox{}\verb@                $mlog->load(\*FL);@\\
\mbox{}\verb@                close(FL);@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        ($cur_y, $cur_m) = HDiet::monthlog::nextMonth($cur_y, $cur_m);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb79}{79}\NWlink{nuweb105}{, 105}.
\item \NWtxtIdentsUsed\nobreak\  \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}, \verb@nextMonth@\nobreak\ \NWlink{nuweb70}{70}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Write back all items in the cache}

All monthly logs in the cache are written back to the database.
This is unconditional---there is no ``dirty'' flag---because the
only circumstance in which we presently do this is after generation
of synthetic data and in that case we know that every month in the
cache has been changed (except for the odd case of a low probability
of filling days which causes us to miss a month entirely).  If
some future development modifies a sparse set of months in the
cache, it may make sense to add a dirty flag and be more selective.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap186}\raggedright\small
\NWtarget{nuweb113a}{} $\langle\,${\itshape Write back all items in the cache}\nobreak\ {\footnotesize {113a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    for my $k (keys(%logs)) {@\\
\mbox{}\verb@        my $mlog = $logs{$k};@\\
\mbox{}\verb@        $mlog->{last_modification_time} = time();@\\
\mbox{}\verb@        open(FL, ">:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$k.hdb") ||@\\
\mbox{}\verb@            die("Cannot update monthly log file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$k.hdb");@\\
\mbox{}\verb@        $mlog->save(\*FL);@\\
\mbox{}\verb@        close(FL);@\\
\mbox{}\verb@        clusterCopy("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$k.hdb");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (scalar(keys(%logs)) > 0) {@\\
\mbox{}\verb@        if ($self->{user}->{badge_trend} != 0) {@\\
\mbox{}\verb@            open(FB, ">@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/BadgeImageNew.png") ||@\\
\mbox{}\verb@                die("Cannot update monthly log file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/BadgeImageNew.png");@\\
\mbox{}\verb@            $self->drawBadgeImage(\*FB, $self->{user}->{badge_trend});@\\
\mbox{}\verb@            close(FB);@\\
\mbox{}\verb@            ::do_command("mv @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/BadgeImageNew.png @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/BadgeImage.png");@\\
\mbox{}\verb@            clusterCopy("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/BadgeImage.png");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb105}{105}.
\item \NWtxtIdentsUsed\nobreak\  \verb@do_command@\nobreak\ \NWlink{nuweb406a}{406a}, \verb@drawBadgeImage@\nobreak\ \NWlink{nuweb101a}{101a}, \verb@save@\nobreak\ \NWlink{nuweb31}{31}\NWlink{nuweb123}{, 123}\NWlink{nuweb151}{, 151}\NWlink{nuweb156b}{, 156b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Empty monthly log cache}

The monthly log cache is emptied.  We count on Perl's reference counts
to delete all of the associated memory.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap187}\raggedright\small
\NWtarget{nuweb113b}{} $\langle\,${\itshape Empty monthly log cache}\nobreak\ {\footnotesize {113b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    %logs = ();@\\
\mbox{}\verb@    @{\tt @}\verb@years = ();@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb82}{82}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

%       _                                    _
%      / \   __ _  __ _ _ __ ___  __ _  __ _| |_ ___  _ __
%     / _ \ / _` |/ _` | '__/ _ \/ _` |/ _` | __/ _ \| '__|
%    / ___ \ (_| | (_| | | |  __/ (_| | (_| | || (_) | |
%   /_/   \_\__, |\__, |_|  \___|\__, |\__,_|\__\___/|_|
%           |___/ |___/          |___/

\clearpage
\vbox{
\chapter{{\tt Aggregator.pm}: Data Aggregator Object}
\label{Aggregator.pm}

The {\tt Aggregator} object provides access to data belonging
to a specified set of user accounts for the purpose of
analysis of aggregate data.

}

\vbox{
\section{Package plumbing}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap188}\raggedright\small
\NWtarget{nuweb114}{} \verb@"HDiet/Aggregator.pm"@\nobreak\ {\footnotesize {114}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@#! @\hbox{$\langle\,${\itshape Perl directory}\nobreak\ {\footnotesize \NWlink{nuweb8d}{8d}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Perl language modes}\nobreak\ {\footnotesize \NWlink{nuweb387b}{387b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use HDiet::monthlog;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    package HDiet::Aggregator;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use HDiet::Julian;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    require Exporter;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    our @{\tt @}\verb@ISA = qw(Exporter);@\\
\mbox{}\verb@    our @{\tt @}\verb@EXPORT = ( );@\\
\mbox{}\verb@@\\
\mbox{}\verb@    1;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb114}{114}\NWlink{nuweb115}{, 115}\NWlink{nuweb116}{, 116}.
\item \NWtxtIdentsUsed\nobreak\  \verb@Julian@\nobreak\ \NWlink{nuweb445}{445}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Constructor}

A new {\tt Aggregator} object is created by calling the
{\tt new} constructor.  The constructor is called with the
function which will receive the log records returned
and the weight unit in which the requester wishes to receive
weight and trend values.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap189}\raggedright\small
\NWtarget{nuweb115}{} \verb@"HDiet/Aggregator.pm"@\nobreak\ {\footnotesize {115}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub new {@\\
\mbox{}\verb@        my $self = {};@\\
\mbox{}\verb@        my ($invocant, $receiver, $weight_unit) = @{\tt @}\verb@_;@\\
\mbox{}\verb@        my $class = ref($invocant) || $invocant;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        bless($self, $class);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   Initialise instance variables from constructor arguments@\\
\mbox{}\verb@        $self->{receiver} = $receiver;@\\
\mbox{}\verb@        $self->{weight_unit} = $weight_unit;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $self;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb114}{114}\NWlink{nuweb115}{, 115}\NWlink{nuweb116}{, 116}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Retrieve}

The {\tt retrieve} method returns log records within the specified date
range for the set of users defined by the following arguments.
The \verb+$start_jd+ and \verb+$end_jd+ arguments specify the
inclusive date range to be returned as Julian dates.  If
\verb+$public_only+ is true, only public accounts will be included
in the aggregation.  If the optional \verb+$user_list+ is supplied,
only the user names listed in the array reference argument will
be included in the aggregation (and only those which are public
if \verb+$public_only+ is set).

The method returns a list of the total number of account and the
number of public accounts.  Note that these totals may be larger than
the number of distinct accounts in the data returned to the {\tt
receiver} function, since accounts which have no log items within the
requested date range will never be passed to the receiver.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap190}\raggedright\small
\NWtarget{nuweb116}{} \verb@"HDiet/Aggregator.pm"@\nobreak\ {\footnotesize {116}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub retrieve {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($start_jd, $end_jd, $public_only, $user_list) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $receive = $self->{receiver};@\\
\mbox{}\verb@        my ($from_y, $from_m, $from_d) = jd_to_gregorian($start_jd);@\\
\mbox{}\verb@        my ($to_y, $to_m, $to_d) = jd_to_gregorian($end_jd);@\\
\mbox{}\verb@        my $sdate = sprintf("%04d-%02d-%02d", $from_y, $from_m, $from_d);@\\
\mbox{}\verb@        my $edate = sprintf("%04d-%02d-%02d", $to_y, $to_m, $to_d);@\\
\mbox{}\verb@        my ($naccts, $npaccts) = (0, 0);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (defined($user_list)) {@\\
\mbox{}\verb@            my @{\tt @}\verb@users = @{\tt @}\verb@$user_list;@\\
\mbox{}\verb@            for my $u (@{\tt @}\verb@users) {@\\
\mbox{}\verb@                my $user_file_name = HDiet::user::quoteUserName($u);@\\
\mbox{}\verb@                @\hbox{$\langle\,${\itshape Return log items for aggregation from this user}\nobreak\ {\footnotesize \NWlink{nuweb117}{117}}$\,\rangle$}\verb@@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            opendir(CD, "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@") ||@\\
\mbox{}\verb@                die("Cannot open directory @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@");@\\
\mbox{}\verb@            for my $user_file_name (grep(!/\.\.?\z/, readdir(CD))) {@\\
\mbox{}\verb@                @\hbox{$\langle\,${\itshape Return log items for aggregation from this user}\nobreak\ {\footnotesize \NWlink{nuweb117}{117}}$\,\rangle$}\verb@@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            closedir(CD);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return ($naccts, $npaccts);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb114}{114}\NWlink{nuweb115}{, 115}\NWlink{nuweb116}{, 116}.
\item \NWtxtIdentsDefed\nobreak\  \verb@retrieve@\nobreak\ \NWlink{nuweb349}{349}.\item \NWtxtIdentsUsed\nobreak\  \verb@jd_to_gregorian@\nobreak\ \NWlink{nuweb448}{448}, \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Return log items for aggregation from this user}

Load the {\tt user} object for this account, verify that it is public
if the requester wishes only to see public accounts, and then load
successive {\tt monthlog} objects within the requested date range
and return log items within them.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap191}\raggedright\small
\NWtarget{nuweb117}{} $\langle\,${\itshape Return log items for aggregation from this user}\nobreak\ {\footnotesize {117}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@#my $recret = 0;@\\
\mbox{}\verb@    open(FU, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/UserAccount.hdu") ||@\\
\mbox{}\verb@        die("Cannot open user account directory @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/UserAccount.hdu");@\\
\mbox{}\verb@    my $ui = HDiet::user->new();@\\
\mbox{}\verb@    $ui->load(\*FU);@\\
\mbox{}\verb@    close(FU);@\\
\mbox{}\verb@    $naccts++;@\\
\mbox{}\verb@    $npaccts++ if $ui->{public};@\\
\mbox{}\verb@    if ((!$public_only) || $ui->{public}) {@\\
\mbox{}\verb@        my ($cur_y, $cur_m, $cur_d) = ($from_y, $from_m, $from_d);@\\
\mbox{}\verb@        for (my $j = $start_jd; $j <= $end_jd; ) {@\\
\mbox{}\verb@            my $monkey = sprintf("%04d-%02d", $cur_y, $cur_m);@\\
\mbox{}\verb@            if (-f "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$monkey.hdb") {@\\
\mbox{}\verb@                open(FL, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$monkey.hdb") ||@\\
\mbox{}\verb@                    die("Cannot open monthly log file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$monkey.hdb");@\\
\mbox{}\verb@                my $mlog = HDiet::monthlog->new();@\\
\mbox{}\verb@                $mlog->load(\*FL);@\\
\mbox{}\verb@                close(FL);@\\
\mbox{}\verb@                for (my $dd = $cur_d; $dd <= $mlog->monthdays(); $dd++) {@\\
\mbox{}\verb@                    my ($rw, $rt) = ($mlog->{weight}[$dd], $mlog->{trend}[$dd]);@\\
\mbox{}\verb@                    $rw *= HDiet::monthlog::WEIGHT_CONVERSION->[$mlog->{log_unit}][$self->{weight_unit}]@\\
\mbox{}\verb@                        if defined($rw);@\\
\mbox{}\verb@                    $rt *= HDiet::monthlog::WEIGHT_CONVERSION->[$mlog->{log_unit}][$self->{weight_unit}]@\\
\mbox{}\verb@                        if defined($rt);@\\
\mbox{}\verb@                    &$receive($ui, $j,@\\
\mbox{}\verb@                         $rw,@\\
\mbox{}\verb@                         $rt,@\\
\mbox{}\verb@                         $mlog->{rung}[$dd],@\\
\mbox{}\verb@                         $mlog->{flag}[$dd],@\\
\mbox{}\verb@                         $mlog->{comment}[$dd]);@\\
\mbox{}\verb@                    $j++;@\\
\mbox{}\verb@                    if ($j > $end_jd) {@\\
\mbox{}\verb@                        last;@\\
\mbox{}\verb@                    }@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            $cur_m++;@\\
\mbox{}\verb@            $cur_d = 1;@\\
\mbox{}\verb@            if ($cur_m > 12) {@\\
\mbox{}\verb@                $cur_y++;@\\
\mbox{}\verb@                $cur_m = 1;@\\
\mbox{}\verb@                $j = gregorian_to_jd($cur_y, $cur_m, $cur_d);@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb116}{116}.
\item \NWtxtIdentsUsed\nobreak\  \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}, \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

%    _   _ ___  ___ _ __
%   | | | / __|/ _ \ '__|
%   | |_| \__ \  __/ |
%    \__,_|___/\___|_|
%

\clearpage
\vbox{
\chapter{{\tt user.pm}: User Object}
\label{user.pm}

The {\tt user} object represents a user account.  All
information associated with the user is stored and all
account management operations are implemented as methods.

}

\vbox{
\section{Package plumbing}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap192}\raggedright\small
\NWtarget{nuweb118}{} \verb@"HDiet/user.pm"@\nobreak\ {\footnotesize {118}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@#! @\hbox{$\langle\,${\itshape Perl directory}\nobreak\ {\footnotesize \NWlink{nuweb8d}{8d}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Perl language modes}\nobreak\ {\footnotesize \NWlink{nuweb387b}{387b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use HDiet::monthlog qw();@\\
\mbox{}\verb@@\\
\mbox{}\verb@    package HDiet::user;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use Encode qw(encode_utf8);@\\
\mbox{}\verb@    use Digest::SHA1  qw(sha1_hex);@\\
\mbox{}\verb@    use Crypt::OpenSSL::AES;@\\
\mbox{}\verb@    use Crypt::CBC;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use HDiet::html;@\\
\mbox{}\verb@    use HDiet::xml;@\\
\mbox{}\verb@    use HDiet::Julian;@\\
\mbox{}\verb@    use HDiet::Digest::Crc32;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    require Exporter;@\\
\mbox{}\verb@    our @{\tt @}\verb@ISA = qw(Exporter);@\\
\mbox{}\verb@    our @{\tt @}\verb@EXPORT = qw( quoteUserName );@\\
\mbox{}\verb@    1;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use constant FILE_VERSION => 1;@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb118}{118}\NWlink{nuweb120}{, 120}\NWlink{nuweb121}{, 121}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb125}{, 125}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb135a}{, 135a}\NWlink{nuweb135b}{b}\NWlink{nuweb136}{, 136}\NWlink{nuweb137}{, 137}\NWlink{nuweb138}{, 138}\NWlink{nuweb139}{, 139}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb142}{, 142}\NWlink{nuweb143}{, 143}\NWlink{nuweb145}{, 145}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb146b}{b}\NWlink{nuweb147}{, 147}.
\item \NWtxtIdentsUsed\nobreak\  \verb@html@\nobreak\ \NWlink{nuweb431}{431}, \verb@Julian@\nobreak\ \NWlink{nuweb445}{445}, \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}, \verb@xml@\nobreak\ \NWlink{nuweb440}{440}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

%\vbox{
\section{Constructor}

A new {\tt user} object is created by calling the
{\tt new} constructor.

\begin{center}
\begin{tabular}{|l|l|}
\hline
login\_name                 &   User login name \\
password                    &   Password \\
account\_created            &   Date and time account created \\
first\_name                 &   First name \\
last\_name                  &   Last name \\
middle\_name                &   Middle name \\
e\_mail                     &   E-mail address \\
log\_unit                   &   Log weight unit \\
display\_unit               &   Display weight unit \\
energy\_unit                &   Energy unit \\
height                      &   Height in centimetres (for BMI) \\
calc\_calorie\_balance      &   Calorie balance (calculator) \\
calc\_start\_weight         &   Start weight (calculator) \\
calc\_goal\_weight          &   Goal weight (calculator) \\
calc\_start\_date           &   Start date (calculator) \\
plot\_diet\_plan            &   Show diet plan in charts? \\
current\_rung               &   Current exercise rung \\
public                      &   Make database publicly visible? \\
public\_name                &   Name shown to the public \\
public\_since               &   When account made public \\
administrator               &   Does user have administrator privileges? \\
read\_only                  &   Allow read-only access without password? \\
last\_modification\_time    &   \UNIX/ time of last modification  \\
decimal\_character          &   Decimal character (``{\tt .}'' or ``{\tt ,}'') \\
badge\_trend                &   Badge trend interval, 0 for no badge \\
\hline
\end{tabular}
\end{center}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap193}\raggedright\small
\NWtarget{nuweb120}{} \verb@"HDiet/user.pm"@\nobreak\ {\footnotesize {120}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub new {@\\
\mbox{}\verb@        my $self = {};@\\
\mbox{}\verb@        my ($invocant, $login_name) = @{\tt @}\verb@_;@\\
\mbox{}\verb@        my $class = ref($invocant) || $invocant;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $login_name = '' if !defined($login_name);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        bless($self, $class);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $self->{version} = FILE_VERSION;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   Initialise instance variables@\\
\mbox{}\verb@        $self->{login_name} = $login_name;@\\
\mbox{}\verb@        $self->{password} = '';@\\
\mbox{}\verb@        $self->{password_expires} = 0;@\\
\mbox{}\verb@        $self->{account_created} = 0;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $self->{first_name} = '';@\\
\mbox{}\verb@        $self->{last_name} = '';@\\
\mbox{}\verb@        $self->{middle_name} = '';@\\
\mbox{}\verb@        $self->{e_mail} = '';@\\
\mbox{}\verb@        $self->{log_unit} = HDiet::monthlog::WEIGHT_KILOGRAM;@\\
\mbox{}\verb@        $self->{display_unit} = HDiet::monthlog::WEIGHT_KILOGRAM;@\\
\mbox{}\verb@        $self->{energy_unit} = HDiet::monthlog::ENERGY_CALORIE;@\\
\mbox{}\verb@        $self->{height} = 0;@\\
\mbox{}\verb@        $self->{calc_calorie_balance} = -500;@\\
\mbox{}\verb@        $self->{calc_start_weight} = 0;@\\
\mbox{}\verb@        $self->{calc_goal_weight} = 0;@\\
\mbox{}\verb@        $self->{calc_start_date} = 0;@\\
\mbox{}\verb@        $self->{plot_diet_plan} = 0;@\\
\mbox{}\verb@        $self->{current_rung} = 0;@\\
\mbox{}\verb@        $self->{public} = 0;@\\
\mbox{}\verb@        $self->{public_name} = '';@\\
\mbox{}\verb@        $self->{public_since} = 0;@\\
\mbox{}\verb@        $self->{administrator} = 0;@\\
\mbox{}\verb@        $self->{read_only} = 0;@\\
\mbox{}\verb@        $self->{last_modification_time} = 0;@\\
\mbox{}\verb@        $self->{decimal_character} = '.';@\\
\mbox{}\verb@        $self->{badge_trend} = 0;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $self;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb118}{118}\NWlink{nuweb120}{, 120}\NWlink{nuweb121}{, 121}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb125}{, 125}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb135a}{, 135a}\NWlink{nuweb135b}{b}\NWlink{nuweb136}{, 136}\NWlink{nuweb137}{, 137}\NWlink{nuweb138}{, 138}\NWlink{nuweb139}{, 139}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb142}{, 142}\NWlink{nuweb143}{, 143}\NWlink{nuweb145}{, 145}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb146b}{b}\NWlink{nuweb147}{, 147}.
\item \NWtxtIdentsUsed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_goal_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@ENERGY_CALORIE@\nobreak\ \NWlink{nuweb24}{24}, \verb@WEIGHT_KILOGRAM@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
%}

\vbox{
\section{Login}

A new {\tt user} object can also be created by calling the
{\tt login} method with the user name and password.  The user
record is looked up in the User Directory, and if the password
is correct, a new {\tt user} object is constructed and
initialised with the user's settings from the record.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap194}\raggedright\small
\NWtarget{nuweb121}{} \verb@"HDiet/user.pm"@\nobreak\ {\footnotesize {121}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub login {@\\
\mbox{}\verb@        my $self = {};@\\
\mbox{}\verb@        my ($invocant, $login_name, $password) = @{\tt @}\verb@_;@\\
\mbox{}\verb@        my $class = ref($invocant) || $invocant;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        bless($self, $class);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $self;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb118}{118}\NWlink{nuweb120}{, 120}\NWlink{nuweb121}{, 121}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb125}{, 125}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb135a}{, 135a}\NWlink{nuweb135b}{b}\NWlink{nuweb136}{, 136}\NWlink{nuweb137}{, 137}\NWlink{nuweb138}{, 138}\NWlink{nuweb139}{, 139}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb142}{, 142}\NWlink{nuweb143}{, 143}\NWlink{nuweb145}{, 145}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb146b}{b}\NWlink{nuweb147}{, 147}.
\item \NWtxtIdentsDefed\nobreak\  \verb@login@\nobreak\ \NWlink{nuweb122}{122}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb137}{, 137}\NWlink{nuweb150}{, 150}\NWlink{nuweb151}{, 151}\NWlink{nuweb153b}{, 153b}\NWlink{nuweb159}{, 159}\NWlink{nuweb162}{, 162}\NWlink{nuweb170a}{, 170a}\NWlink{nuweb180a}{, 180a}\NWlink{nuweb183}{, 183}\NWlink{nuweb188a}{, 188a}\NWlink{nuweb198}{, 198}\NWlink{nuweb199}{, 199}\NWlink{nuweb200}{, 200}\NWlink{nuweb201}{, 201}\NWlink{nuweb203}{, 203}\NWlink{nuweb204}{, 204}\NWlink{nuweb278a}{, 278a}\NWlink{nuweb304a}{, 304a}\NWlink{nuweb307b}{, 307b}\NWlink{nuweb310}{, 310}\NWlink{nuweb344}{, 344}\NWlink{nuweb347}{, 347}\NWlink{nuweb376}{, 376}\NWlink{nuweb473b}{, 473b}\NWlink{nuweb480}{, 480}\NWlink{nuweb532}{, 532}\NWlink{nuweb538b}{, 538b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Describe}

The {\tt describe} method prints a primate-readable description
of the user on the file handle (default {\tt STDOUT})
given by the argument.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap195}\raggedright\small
\NWtarget{nuweb122}{} \verb@"HDiet/user.pm"@\nobreak\ {\footnotesize {122}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub describe {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($outfile) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (!(defined $outfile)) {@\\
\mbox{}\verb@            $outfile = \*STDOUT;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print($outfile "USER Version: $self->{version}\n");@\\
\mbox{}\verb@        print($outfile "  Login: '$self->{login_name}'  Password: $self->{password}  " ."\n");@\\
\mbox{}\verb@        print($outfile "  Password expires: " . (($self->{password_expires} == 0) ? "Never" :@\\
\mbox{}\verb@            localtime($self->{password_expires})) . "\n");@\\
\mbox{}\verb@        print($outfile "  First login: " . localtime($self->{account_created}) . "\n");@\\
\mbox{}\verb@        print($outfile "  Name:  First '$self->{first_name}'  " .@\\
\mbox{}\verb@                       "Middle '$self->{middle_name}'  " .@\\
\mbox{}\verb@                       "Last '$self->{last_name}'\n");@\\
\mbox{}\verb@        print($outfile "  E-mail: $self->{e_mail}\n");@\\
\mbox{}\verb@        print($outfile "  Log unit: " . HDiet::monthlog::WEIGHT_UNITS->[$self->{log_unit}] .@\\
\mbox{}\verb@                       "  Display unit: " . HDiet::monthlog::WEIGHT_UNITS->[$self->{display_unit}] .@\\
\mbox{}\verb@                       "  Energy unit: " . HDiet::monthlog::ENERGY_UNITS->[$self->{energy_unit}] . "\n");@\\
\mbox{}\verb@        print($outfile "  Height: $self->{height}  " .@\\
\mbox{}\verb@                       "Log public: " . ($self->{public} ? "Yes" : "No") .@\\
\mbox{}\verb@                       "  Administrator: " . ($self->{administrator} ? "Yes" : "No") .@\\
\mbox{}\verb@                       "  Read only: " . ($self->{read_only} ? "Yes" : "No") . "\n");@\\
\mbox{}\verb@        if ($self->{public}) {@\\
\mbox{}\verb@            print($outfile "  Public name: '$self->{public_name}'  Since: " .@\\
\mbox{}\verb@                localtime($self->{public_since}) . "\n");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        print($outfile "  Calculator:  Balance: " . $self->{calc_calorie_balance} .@\\
\mbox{}\verb@                       "  Start weight: " . $self->{calc_start_weight} .@\\
\mbox{}\verb@                       "  Goal weight: " . $self->{calc_goal_weight} . "\n" .@\\
\mbox{}\verb@                       "               Plot plan: " . ($self->{plot_diet_plan} ? "Yes" : "No") .@\\
\mbox{}\verb@                       "  Start date: " . localtime($self->{calc_start_date}) . "\n");@\\
\mbox{}\verb@        print($outfile "  Last modification time: " .@\\
\mbox{}\verb@                       localtime($self->{last_modification_time}) . "\n");@\\
\mbox{}\verb@        print($outfile "  Decimal character: " . $self->{decimal_character} . "\n");@\\
\mbox{}\verb@        print($outfile "  Badge trend interval: $self->{badge_trend}\n");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb118}{118}\NWlink{nuweb120}{, 120}\NWlink{nuweb121}{, 121}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb125}{, 125}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb135a}{, 135a}\NWlink{nuweb135b}{b}\NWlink{nuweb136}{, 136}\NWlink{nuweb137}{, 137}\NWlink{nuweb138}{, 138}\NWlink{nuweb139}{, 139}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb142}{, 142}\NWlink{nuweb143}{, 143}\NWlink{nuweb145}{, 145}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb146b}{b}\NWlink{nuweb147}{, 147}.
\item \NWtxtIdentsDefed\nobreak\  \verb@describe@\nobreak\ \NWlink{nuweb27}{27}\NWlink{nuweb105}{, 105}\NWlink{nuweb150}{, 150}\NWlink{nuweb156a}{, 156a}\NWlink{nuweb170a}{, 170a}\NWlink{nuweb218}{, 218}\NWlink{nuweb316}{, 316}\NWlink{nuweb461}{, 461}.\item \NWtxtIdentsUsed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_goal_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@ENERGY_UNITS@\nobreak\ \NWlink{nuweb24}{24}, \verb@login@\nobreak\ \NWlink{nuweb121}{121}, \verb@WEIGHT_UNITS@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Save}

The {\tt save} method writes the user item to the already-open file handle
passed as the argument.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap196}\raggedright\small
\NWtarget{nuweb123}{} \verb@"HDiet/user.pm"@\nobreak\ {\footnotesize {123}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub save {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($outfile) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $outfile <<"EOD";@\\
\mbox{}\verb@$self->{version}@\\
\mbox{}\verb@$self->{login_name}@\\
\mbox{}\verb@$self->{password}@\\
\mbox{}\verb@$self->{password_expires}@\\
\mbox{}\verb@$self->{account_created}@\\
\mbox{}\verb@$self->{first_name}@\\
\mbox{}\verb@$self->{last_name}@\\
\mbox{}\verb@$self->{middle_name}@\\
\mbox{}\verb@$self->{e_mail}@\\
\mbox{}\verb@$self->{log_unit}@\\
\mbox{}\verb@$self->{display_unit}@\\
\mbox{}\verb@$self->{energy_unit}@\\
\mbox{}\verb@$self->{height}@\\
\mbox{}\verb@$self->{calc_calorie_balance}@\\
\mbox{}\verb@$self->{calc_start_weight}@\\
\mbox{}\verb@$self->{calc_goal_weight}@\\
\mbox{}\verb@$self->{calc_start_date}@\\
\mbox{}\verb@$self->{plot_diet_plan}@\\
\mbox{}\verb@$self->{current_rung}@\\
\mbox{}\verb@$self->{public}@\\
\mbox{}\verb@$self->{public_name}@\\
\mbox{}\verb@$self->{public_since}@\\
\mbox{}\verb@$self->{administrator}@\\
\mbox{}\verb@$self->{read_only}@\\
\mbox{}\verb@$self->{last_modification_time}@\\
\mbox{}\verb@$self->{decimal_character}@\\
\mbox{}\verb@$self->{badge_trend}@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb118}{118}\NWlink{nuweb120}{, 120}\NWlink{nuweb121}{, 121}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb125}{, 125}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb135a}{, 135a}\NWlink{nuweb135b}{b}\NWlink{nuweb136}{, 136}\NWlink{nuweb137}{, 137}\NWlink{nuweb138}{, 138}\NWlink{nuweb139}{, 139}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb142}{, 142}\NWlink{nuweb143}{, 143}\NWlink{nuweb145}{, 145}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb146b}{b}\NWlink{nuweb147}{, 147}.
\item \NWtxtIdentsDefed\nobreak\  \verb@save@\nobreak\ \NWlink{nuweb31}{31}\NWlink{nuweb113a}{, 113a}\NWlink{nuweb151}{, 151}\NWlink{nuweb156b}{, 156b}\NWlink{nuweb159}{, 159}\NWlink{nuweb167}{, 167}\NWlink{nuweb170b}{, 170b}\NWlink{nuweb187}{, 187}\NWlink{nuweb220a}{, 220a}\NWlink{nuweb240a}{, 240a}\NWlink{nuweb248a}{, 248a}\NWlink{nuweb309}{, 309}\NWlink{nuweb320}{, 320}\NWlink{nuweb330}{, 330}\NWlink{nuweb395b}{, 395b}\NWlink{nuweb484b}{, 484b}.\item \NWtxtIdentsUsed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_goal_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_weight@\nobreak\ \NWlink{nuweb505}{505}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Load}

The {\tt load} method reads a user file from the argument file handle
in the format produced by {\tt save}.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap197}\raggedright\small
\NWtarget{nuweb124a}{} \verb@"HDiet/user.pm"@\nobreak\ {\footnotesize {124a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub load {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($infile) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $s = in($infile);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($s != FILE_VERSION) {@\\
\mbox{}\verb@            die("user::load: Incompatible file version $s");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $self->{login_name} = in($infile);@\\
\mbox{}\verb@        $self->{password} = in($infile);@\\
\mbox{}\verb@        $self->{password_expires} = in($infile);@\\
\mbox{}\verb@        $self->{account_created} = in($infile);@\\
\mbox{}\verb@        $self->{first_name} = in($infile);@\\
\mbox{}\verb@        $self->{last_name} = in($infile);@\\
\mbox{}\verb@        $self->{middle_name} = in($infile);@\\
\mbox{}\verb@        $self->{e_mail} = in($infile);@\\
\mbox{}\verb@        $self->{log_unit} = in($infile);@\\
\mbox{}\verb@        $self->{display_unit} = in($infile);@\\
\mbox{}\verb@        $self->{energy_unit} = in($infile);@\\
\mbox{}\verb@        $self->{height} = in($infile);@\\
\mbox{}\verb@        $self->{calc_calorie_balance} = in($infile);@\\
\mbox{}\verb@        $self->{calc_start_weight} = in($infile);@\\
\mbox{}\verb@        $self->{calc_goal_weight} = in($infile);@\\
\mbox{}\verb@        $self->{calc_start_date} = in($infile);@\\
\mbox{}\verb@        $self->{plot_diet_plan} = in($infile);@\\
\mbox{}\verb@        $self->{current_rung} = in($infile);@\\
\mbox{}\verb@        $self->{public} = in($infile);@\\
\mbox{}\verb@        $self->{public_name} = in($infile);;@\\
\mbox{}\verb@        $self->{public_since} = in($infile);;@\\
\mbox{}\verb@        $self->{administrator} = in($infile);@\\
\mbox{}\verb@        $self->{read_only} = in($infile);@\\
\mbox{}\verb@        $self->{last_modification_time} = in($infile);@\\
\mbox{}\verb@        $self->{decimal_character} = in($infile, '.');@\\
\mbox{}\verb@        $self->{badge_trend} = in($infile, 0);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Read line from persistent object file}\nobreak\ ({\footnotesize 124b\label{scrap198}
 }\mbox{}\verb@user@ ) {\footnotesize \NWlink{nuweb413b}{413b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb118}{118}\NWlink{nuweb120}{, 120}\NWlink{nuweb121}{, 121}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb125}{, 125}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb135a}{, 135a}\NWlink{nuweb135b}{b}\NWlink{nuweb136}{, 136}\NWlink{nuweb137}{, 137}\NWlink{nuweb138}{, 138}\NWlink{nuweb139}{, 139}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb142}{, 142}\NWlink{nuweb143}{, 143}\NWlink{nuweb145}{, 145}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb146b}{b}\NWlink{nuweb147}{, 147}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Login Form}

The {\tt login\_form} method writes the HTML form presented to a
user who wishes to log in.  The form is written to the file handle argument,
which defaults to {\tt STDOUT} if not specified.  The user name and password
fields are initialised to the values in the parent object.  These will
usually be blank for a new login, but may be preset should arcane circumstances
require them to be so.  The third argument specifies the login is from a
handheld device.  The handheld checkbox is preset, and the login form is customised
for a small screen.  The optional fourth argument specifies whether the
``remember me'' checkbox should be checked.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap199}\raggedright\small
\NWtarget{nuweb125}{} \verb@"HDiet/user.pm"@\nobreak\ {\footnotesize {125}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub login_form {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($fh, $tzOff, $handheld, $remember) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (!(defined $fh)) {@\\
\mbox{}\verb@            $fh = \*STDOUT;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($login_name, $password) = (@\\
\mbox{}\verb@                        quoteHTML($self->{login_name}),@\\
\mbox{}\verb@                        quoteHTML($self->{password})@\\
\mbox{}\verb@                     );@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $ckhandheld = $handheld ? ' checked="checked"' : '';@\\
\mbox{}\verb@        my $ckremember = $remember ? ' checked="checked"' : '';@\\
\mbox{}\verb@        my $arghandheld = $handheld ? '&amp;HDiet_handheld=y' : '';@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<form id="Hdiet_login" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb118}{118}\NWlink{nuweb120}{, 120}\NWlink{nuweb121}{, 121}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb125}{, 125}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb135a}{, 135a}\NWlink{nuweb135b}{b}\NWlink{nuweb136}{, 136}\NWlink{nuweb137}{, 137}\NWlink{nuweb138}{, 138}\NWlink{nuweb139}{, 139}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb142}{, 142}\NWlink{nuweb143}{, 143}\NWlink{nuweb145}{, 145}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb146b}{b}\NWlink{nuweb147}{, 147}.
\item \NWtxtIdentsDefed\nobreak\  \verb@login_form@\nobreak\ \NWlink{nuweb182}{182}\NWlink{nuweb185a}{, 185a}\NWlink{nuweb186a}{, 186a}\NWlink{nuweb197}{, 197}.\item \NWtxtIdentsUsed\nobreak\  \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{

The user name and password fields are enclosed in a table.  Below this are
the checkboxes for ``Handheld'' and ``Remember me'' mode.  A link for password
recovery and a button to create a new account.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap200}\raggedright\small
\NWtarget{nuweb126}{} \verb@"HDiet/user.pm"@\nobreak\ {\footnotesize {126}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@<table border="border" class="login">@\\
\mbox{}\verb@<tr><th><label for="HDiet_username"><span class="accesskey">U</span>ser Name:</label></th>@\\
\mbox{}\verb@    <td><input accesskey="u" type="text" name="HDiet_username" id="HDiet_username" size="60"@\\
\mbox{}\verb@               tabindex="1" maxlength="@\hbox{$\langle\,${\itshape Maximum Text Input Field Length}\nobreak\ {\footnotesize \NWlink{nuweb11c}{11c}}$\,\rangle$}\verb@" value="$login_name" /></td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@<tr><th><label for="HDiet_password"><span class="accesskey">P</span>assword:</label></th>@\\
\mbox{}\verb@    <td><input accesskey="p" type="password" name="HDiet_password" id="HDiet_password" size="60"@\\
\mbox{}\verb@               tabindex="2" maxlength="@\hbox{$\langle\,${\itshape Maximum Text Input Field Length}\nobreak\ {\footnotesize \NWlink{nuweb11c}{11c}}$\,\rangle$}\verb@" value="$password" /></td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@</table>@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<input type="hidden" name="q" value="validate_user" />@\\
\mbox{}\verb@<input type="submit" tabindex="3" name="login" value=" Sign In " />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="reset" value=" Reset " />@\\
\mbox{}\verb@<br />@\\
\mbox{}\verb@<input type="checkbox" name="HDiet_handheld" id="HDiet_handheld"@\\
\mbox{}\verb@       value="y"$ckhandheld />&nbsp;<label for="HDiet_handheld">Handheld&nbsp;device</label>@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="checkbox" name="HDiet_remember" id="HDiet_remember"@\\
\mbox{}\verb@       value="y"$ckremember />&nbsp;<label for="HDiet_remember">Remember&nbsp;me</label>@\\
\mbox{}\verb@<br />@\\
\mbox{}\verb@<a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=pwreset$arghandheld$tzOff">Forgotten@\\
\mbox{}\verb@    your password?</a>@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<input type="submit" name="new" value=" Create a New Account " />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ((!$handheld) && (@\hbox{$\langle\,${\itshape Beta test}\nobreak\ {\footnotesize \NWlink{nuweb4a}{4a}}$\,\rangle$}\verb@)) {@\\
\mbox{}\verb@            print $fh <<"EOD";@\\
\mbox{}\verb@<h3 class="centred">Development log now online at:<br />@\\
\mbox{}\verb@<a href="http://hdonline-dev.blogspot.com/"@\\
\mbox{}\verb@   rel="Target:Fourmilab_Hdonline_Devlog">http://hdonline-dev.blogspot.com/</a>@\\
\mbox{}\verb@</h3>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb118}{118}\NWlink{nuweb120}{, 120}\NWlink{nuweb121}{, 121}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb125}{, 125}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb135a}{, 135a}\NWlink{nuweb135b}{b}\NWlink{nuweb136}{, 136}\NWlink{nuweb137}{, 137}\NWlink{nuweb138}{, 138}\NWlink{nuweb139}{, 139}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb142}{, 142}\NWlink{nuweb143}{, 143}\NWlink{nuweb145}{, 145}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb146b}{b}\NWlink{nuweb147}{, 147}.
\item \NWtxtIdentsUsed\nobreak\  \verb@login@\nobreak\ \NWlink{nuweb121}{121}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{New Account Form}

The {\tt new\_account\_form} method writes an HTML form to
define a new user account on the file handle (default {\tt STDOUT})
given by the argument.  The fields in the form are initialised to
the values in the user object.  A form suitable for editing an
existing account can be generated by calling this method with a
second nonzero argument.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap201}\raggedright\small
\NWtarget{nuweb127}{} \verb@"HDiet/user.pm"@\nobreak\ {\footnotesize {127}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub new_account_form {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($fh, $edit_mode) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (!(defined $fh)) {@\\
\mbox{}\verb@            $fh = \*STDOUT;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Encode preset values for use in HTML}\nobreak\ {\footnotesize \NWlink{nuweb128}{128}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<table border="border" class="login">@\\
\mbox{}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape User login name text field}\nobreak\ {\footnotesize \NWlink{nuweb129a}{129a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (@\hbox{$\langle\,${\itshape Beta test}\nobreak\ {\footnotesize \NWlink{nuweb4a}{4a}}$\,\rangle$}\verb@) {@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Beta test invitation field}\nobreak\ {\footnotesize \NWlink{nuweb129b}{129b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $ch_logunit = $edit_mode ? '' : ' onclick="set_logunit(this);"';@\\
\mbox{}\verb@        my $ch_dispunit = $edit_mode ? '' : ' onclick="set_dispunit(this);"';@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Password and password confirmation fields}\nobreak\ {\footnotesize \NWlink{nuweb130}{130}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape E-mail address text field}\nobreak\ {\footnotesize \NWlink{nuweb131a}{131a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape User's full name optional text fields}\nobreak\ {\footnotesize \NWlink{nuweb131b}{131b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Height (for body mass index)}\nobreak\ {\footnotesize \NWlink{nuweb132}{132}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Weight and energy unit radio buttons}\nobreak\ {\footnotesize \NWlink{nuweb133}{133}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Decimal character selection}\nobreak\ {\footnotesize \NWlink{nuweb134a}{134a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Public name settings}\nobreak\ {\footnotesize \NWlink{nuweb134b}{134b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@</table>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb118}{118}\NWlink{nuweb120}{, 120}\NWlink{nuweb121}{, 121}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb125}{, 125}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb135a}{, 135a}\NWlink{nuweb135b}{b}\NWlink{nuweb136}{, 136}\NWlink{nuweb137}{, 137}\NWlink{nuweb138}{, 138}\NWlink{nuweb139}{, 139}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb142}{, 142}\NWlink{nuweb143}{, 143}\NWlink{nuweb145}{, 145}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb146b}{b}\NWlink{nuweb147}{, 147}.
\item \NWtxtIdentsDefed\nobreak\  \verb@new_account_form@\nobreak\ \NWlink{nuweb304a}{304a}\NWlink{nuweb310}{, 310}\NWlink{nuweb311}{, 311}\NWlink{nuweb315}{, 315}.\item \NWtxtIdentsUsed\nobreak\  \verb@login@\nobreak\ \NWlink{nuweb121}{121}, \verb@set_dispunit@\nobreak\ \NWlink{nuweb522}{522}, \verb@set_logunit@\nobreak\ \NWlink{nuweb522}{522}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Encode preset values for use in HTML}

Convert the preset values from the user object to HTML encoding
to be used in the form.  This allows preserving values specified
by the user when the form is re-issued due to an error.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap202}\raggedright\small
\NWtarget{nuweb128}{} $\langle\,${\itshape Encode preset values for use in HTML}\nobreak\ {\footnotesize {128}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my ($login_name, $first_name, $last_name, $middle_name,@\\
\mbox{}\verb@        $e_mail) = (@\\
\mbox{}\verb@                    quoteHTML($self->{login_name}),@\\
\mbox{}\verb@                    quoteHTML($self->{first_name}),@\\
\mbox{}\verb@                    quoteHTML($self->{last_name}),@\\
\mbox{}\verb@                    quoteHTML($self->{middle_name}),@\\
\mbox{}\verb@                    quoteHTML($self->{e_mail})@\\
\mbox{}\verb@                 );@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my %wunit = (0, '', 1, '', 2, '');@\\
\mbox{}\verb@    $wunit{$self->{log_unit}} = 'checked="checked"';@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my %dunit = (0, '', 1, '', 2, '');@\\
\mbox{}\verb@    $dunit{$self->{display_unit}} = 'checked="checked"';@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my %eunit = (0, '', 1, '');@\\
\mbox{}\verb@    $eunit{$self->{energy_unit}} = 'checked="checked"';@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my %dchar = ('.', '', ',', '');@\\
\mbox{}\verb@    $dchar{$self->{decimal_character}} = 'checked="checked"';@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my ($height_cm, $height_ft, $height_in) = ('', '', '');@\\
\mbox{}\verb@    if ($self->{height} > 0) {@\\
\mbox{}\verb@        $height_cm = $self->localiseNumber($self->{height}, 1);@\\
\mbox{}\verb@        $height_in = canonicalNumber($self->{height}, 1) / 2.54;@\\
\mbox{}\verb@        $height_ft = int($height_in / 12);@\\
\mbox{}\verb@        $height_in = $self->localiseNumber($height_in - ($height_ft * 12), 1);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb127}{127}.
\item \NWtxtIdentsUsed\nobreak\  \verb@canonicalNumber@\nobreak\ \NWlink{nuweb146a}{146a}\NWlink{nuweb519a}{, 519a}, \verb@localiseNumber@\nobreak\ \NWlink{nuweb147}{147}, \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{User login name text field}

The user login or account name must be unique system-wide.  We derive
the directory name in which all files for this user are kept from
the login name.  The login name can be any Unicode character string up to
the maximum input field length; quoting and digests are used to deal with
system file name character set and length restrictions.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap203}\raggedright\small
\NWtarget{nuweb129a}{} $\langle\,${\itshape User login name text field}\nobreak\ {\footnotesize {129a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($edit_mode) {@\\
\mbox{}\verb@        my $llg = $login_name;@\\
\mbox{}\verb@        if ($self->{administrator}) {@\\
\mbox{}\verb@            $llg .= ' <span class="administrator">(Administrator)</span>';@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<tr><th>User Name:</th>@\\
\mbox{}\verb@    <td><b>$llg</b></td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<tr><th><span class="required">*</span> <label@\\
\mbox{}\verb@        for="HDiet_username"><span class="accesskey">U</span>ser Name:</label></th>@\\
\mbox{}\verb@    <td><input accesskey="u" type="text" name="HDiet_username" id="HDiet_username" size="60" tabindex="1"@\\
\mbox{}\verb@               maxlength="@\hbox{$\langle\,${\itshape Maximum Text Input Field Length}\nobreak\ {\footnotesize \NWlink{nuweb11c}{11c}}$\,\rangle$}\verb@" value="$login_name" /></td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb127}{127}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Beta test invitation field}

During the beta test period, new account creation requires the user to enter an
invitation code.  These codes are generated by the administrator and given out
to the chosen few deemed sufficiently resilient to brave this software in its
pre-release form.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap204}\raggedright\small
\NWtarget{nuweb129b}{} $\langle\,${\itshape Beta test invitation field}\nobreak\ {\footnotesize {129b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (!$edit_mode) {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<tr><th><span class="required">*</span> <label for="HDiet_invitation"><span@\\
\mbox{}\verb@        class="accesskey">B</span>eta test invitation:</label></th>@\\
\mbox{}\verb@    <td><input accesskey="B" type="text" name="HDiet_invitation" id="HDiet_invitation" size="12"  tabindex="2"@\\
\mbox{}\verb@               maxlength="@\hbox{$\langle\,${\itshape Maximum Text Input Field Length}\nobreak\ {\footnotesize \NWlink{nuweb11c}{11c}}$\,\rangle$}\verb@" value="" /></td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb127}{127}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Password and password confirmation fields}

Two ``password'' type input fields are used to specify the password
for the account.  Because input typed in the field is hidden, the user
is required to enter the password twice to guarantee it is the
intended value.  (Personally, I think the idea of hiding a password
the user is entering for a new account or in a password change
request is idiotic; many people type poorly, and even with confirmation
there's no feedback to tell the user they didn't for example, accidentally
transpose two characters, rendering the new account inaccessible.  Still,
the hidden field and confirmation scheme is what people have come to
expect, and it's next to certain that if I don't follow this dumb
convention, some moron will slam the process for being ``insecure''.
My feeling is that somebody who is unable to arrange things so
that nobody is looking over their shoulder when they create a
new account [as opposed to a routine login]) is probably too stupid
to use a computer for any confidential data whatsoever.)

There is, however, one advantage of designating a field a password.
Most browsers will not remember the value of such fields and re-enter
them if the user presses the ``Back'' button.  This is a genuine improvement
in security and another reason to bow to convention here.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap205}\raggedright\small
\NWtarget{nuweb130}{} $\langle\,${\itshape Password and password confirmation fields}\nobreak\ {\footnotesize {130}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@<tr><th><span class="required">*</span> <label for="HDiet_password"><span@\\
\mbox{}\verb@        class="accesskey">P</span>assword:</label></th>@\\
\mbox{}\verb@    <td><input accesskey="p" type="password" name="HDiet_password"@\\
\mbox{}\verb@               id="HDiet_password" size="48"  tabindex="2"@\\
\mbox{}\verb@               onkeyup="showPasswordStrength(); checkPasswordMatch();"@\\
\mbox{}\verb@               onchange="showPasswordStrength(); checkPasswordMatch();"@\\
\mbox{}\verb@               maxlength="@\hbox{$\langle\,${\itshape Maximum Text Input Field Length}\nobreak\ {\footnotesize \NWlink{nuweb11c}{11c}}$\,\rangle$}\verb@" value="" />@\\
\mbox{}\verb@               Strength:&nbsp;<input type="text" name="HDiet_password_strength" size="2"@\\
\mbox{}\verb@               maxlength="3" readonly="readonly" tabindex="0" value="0" /></td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<tr><th><span class="required">*</span> <label for="HDiet_rpassword"><span@\\
\mbox{}\verb@        class="accesskey">R</span>etype password:</label></th>@\\
\mbox{}\verb@    <td><input accesskey="r" type="password" name="HDiet_rpassword"@\\
\mbox{}\verb@               id="HDiet_rpassword" size="48"  tabindex="3"@\\
\mbox{}\verb@               onkeyup="checkPasswordMatch();"@\\
\mbox{}\verb@               onchange="checkPasswordMatch();"@\\
\mbox{}\verb@               maxlength="@\hbox{$\langle\,${\itshape Maximum Text Input Field Length}\nobreak\ {\footnotesize \NWlink{nuweb11c}{11c}}$\,\rangle$}\verb@" value="" />@\\
\mbox{}\verb@               Match?&nbsp;<input type="checkbox" name="HDiet_password_match"@\\
\mbox{}\verb@               readonly="readonly" tabindex="0" checked="checked" /></td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb127}{127}.
\item \NWtxtIdentsUsed\nobreak\  \verb@checkPasswordMatch@\nobreak\ \NWlink{nuweb528}{528}, \verb@showPasswordStrength@\nobreak\ \NWlink{nuweb525}{525}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{E-mail address text field}

We require the user to enter an E-mail address when creating the
account.  This address is primarily to facilitate password recovery.
If the user loses their password, we can either E-mail the existing
password to the designated address or else generate a new password
and send that.  We may also eventually require the user to receive
and respond to a URL in an E-mail send to this address in order to
activate the new account.  This will verify that the E-mail address
is valid and prevent attacks which create large numbers of bogus accounts
with invalid E-mail addresses, or sign up unwitting third parties with
E-mail addresses collected from junk mail databases.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap206}\raggedright\small
\NWtarget{nuweb131a}{} $\langle\,${\itshape E-mail address text field}\nobreak\ {\footnotesize {131a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@<tr><th><span class="required">*</span> <label for="HDiet_email"><span@\\
\mbox{}\verb@    class="accesskey">E</span>-mail address:@\\
\mbox{}\verb@     (for lost <br /> password recovery)</label></th>@\\
\mbox{}\verb@    <td><input accesskey="e" type="text" name="HDiet_email" id="HDiet_email" size="60" tabindex="4"@\\
\mbox{}\verb@               maxlength="@\hbox{$\langle\,${\itshape Maximum Text Input Field Length}\nobreak\ {\footnotesize \NWlink{nuweb11c}{11c}}$\,\rangle$}\verb@" value="$e_mail" /></td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb127}{127}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{User's full name optional text fields}

The following fields, all of which are optional, allow the user
to specify their first, last, and middle name.  Since these are used
simply to label output, their interpretation is entirely up to the
user, who may specify them in whichever order they prefer their
name to be written.  These fields may contain any arbitrary Unicode
characters.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap207}\raggedright\small
\NWtarget{nuweb131b}{} $\langle\,${\itshape User's full name optional text fields}\nobreak\ {\footnotesize {131b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@<tr><th><label for="HDiet_namef">First name:</label></th>@\\
\mbox{}\verb@    <td><input type="text" name="HDiet_namef" id="HDiet_namef" size="60" tabindex="5"@\\
\mbox{}\verb@               maxlength="@\hbox{$\langle\,${\itshape Maximum Text Input Field Length}\nobreak\ {\footnotesize \NWlink{nuweb11c}{11c}}$\,\rangle$}\verb@" value="$first_name" /></td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<tr><th><label for="HDiet_namel">Last name:</label></th>@\\
\mbox{}\verb@    <td><input type="text" name="HDiet_namel" id="HDiet_namel" size="60" tabindex="6"@\\
\mbox{}\verb@               maxlength="@\hbox{$\langle\,${\itshape Maximum Text Input Field Length}\nobreak\ {\footnotesize \NWlink{nuweb11c}{11c}}$\,\rangle$}\verb@" value="$last_name" /></td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<tr><th><label for="HDiet_namem">Middle name or initial:</label></th>@\\
\mbox{}\verb@    <td><input type="text" name="HDiet_namem" id="HDiet_namem" size="60" tabindex="7"@\\
\mbox{}\verb@               maxlength="@\hbox{$\langle\,${\itshape Maximum Text Input Field Length}\nobreak\ {\footnotesize \NWlink{nuweb11c}{11c}}$\,\rangle$}\verb@" value="$middle_name" /></td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb127}{127}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Height (for body mass index)}

If the user wishes to have their body mass index (BMI) displayed, they
must specify their stature.  We allow this to be specified in either
centimetres or in feet and inches, although we always store the value
internally in centimetres.  When an entry is made in one unit field, a
little JavaScript glue updates the other unit accordingly.  This is purely
for the user's convenience; no harm will be done if JavaScript is disabled.

Note that this field is optional.  If not specified, the {\tt height}
value in the object will be zero, and no body mass index will be
displayed.  The BMI has a rather high coefficient of bogosity, and
while some people find it useful, we don't want to go so far as to
endorse it by requiring the user to disclose their height purely
in order to compute it.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap208}\raggedright\small
\NWtarget{nuweb132}{} $\langle\,${\itshape Height (for body mass index)}\nobreak\ {\footnotesize {132}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@<tr><th>Height:</th>@\\
\mbox{}\verb@    <td>@\\
\mbox{}\verb@        <input type="text" name="HDiet_height_cm" id="HDiet_height_cm" size="5" tabindex="8"@\\
\mbox{}\verb@            maxlength="6" value="$height_cm" onchange="height_changed_cm();" />@\\
\mbox{}\verb@                <label for="HDiet_height_cm">centimetres</label>@\\
\mbox{}\verb@        &nbsp; &nbsp; <b>or</b> &nbsp; &nbsp;@\\
\mbox{}\verb@        <input type="text" name="HDiet_height_ft" id="HDiet_height_ft" size="2" tabindex="9"@\\
\mbox{}\verb@            maxlength="2" value="$height_ft" onchange="height_changed_ft();" />@\\
\mbox{}\verb@                <label for="HDiet_height_ft">feet</label>@\\
\mbox{}\verb@        <input type="text" name="HDiet_height_in" id="HDiet_height_in" size="4" tabindex="10"@\\
\mbox{}\verb@            maxlength="4" value="$height_in" onchange="height_changed_in();" />@\\
\mbox{}\verb@                <label for="HDiet_height_in">inches</label>@\\
\mbox{}\verb@    </td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb127}{127}.
\item \NWtxtIdentsUsed\nobreak\  \verb@height_changed_cm@\nobreak\ \NWlink{nuweb519b}{519b}, \verb@height_changed_ft@\nobreak\ \NWlink{nuweb520}{520}, \verb@height_changed_in@\nobreak\ \NWlink{nuweb521}{521}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Weight and energy unit radio buttons}

Radio buttons are used to specify the weight and energy
units the user prefers.  These are preset based on the
setting in the parent object.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap209}\raggedright\small
\NWtarget{nuweb133}{} $\langle\,${\itshape Weight and energy unit radio buttons}\nobreak\ {\footnotesize {133}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@<tr><th>Weight unit:</th>@\\
\mbox{}\verb@    <td>@\\
\mbox{}\verb@    <table>@\\
\mbox{}\verb@    <tr><td>@\\
\mbox{}\verb@    <b>Log:</b></td><td>@\\
\mbox{}\verb@    <input type="radio" name="HDiet_wunit" id="HDiet_wunit_kg" value="0"$wunit{0}@\\
\mbox{}\verb@        tabindex="11"$ch_logunit />&nbsp;<label for="HDiet_wunit_kg">kilogram</label>@\\
\mbox{}\verb@    <input type="radio" name="HDiet_wunit" id="HDiet_wunit_lb" value="1"$wunit{1}@\\
\mbox{}\verb@        tabindex="12"$ch_logunit />&nbsp;<label for="HDiet_wunit_lb">pound</label>@\\
\mbox{}\verb@    <input type="radio" name="HDiet_wunit" id="HDiet_wunit_st" value="2"$wunit{2}@\\
\mbox{}\verb@        tabindex="13"$ch_logunit />&nbsp;<label for="HDiet_wunit_st">stone</label>@\\
\mbox{}\verb@    </td></tr>@\\
\mbox{}\verb@    <tr><td>@\\
\mbox{}\verb@    <b>Display:</b></td><td>@\\
\mbox{}\verb@    <input type="radio" name="HDiet_dunit" id="HDiet_dunit_kg" value="0"$dunit{0}@\\
\mbox{}\verb@        tabindex="14"$ch_dispunit />&nbsp;<label for="HDiet_dunit_kg">kilogram</label>@\\
\mbox{}\verb@    <input type="radio" name="HDiet_dunit" id="HDiet_dunit_lb" value="1"$dunit{1}@\\
\mbox{}\verb@        tabindex="15"$ch_dispunit />&nbsp;<label for="HDiet_dunit_lb">pound</label>@\\
\mbox{}\verb@    <input type="radio" name="HDiet_dunit" id="HDiet_dunit_st" value="2"$dunit{2}@\\
\mbox{}\verb@        tabindex="16"$ch_dispunit />&nbsp;<label for="HDiet_dunit_st">stone</label>@\\
\mbox{}\verb@    </td></tr>@\\
\mbox{}\verb@    </table>@\\
\mbox{}\verb@    </td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<tr><th>Energy unit:</th>@\\
\mbox{}\verb@    <td>@\\
\mbox{}\verb@    <input type="radio" name="HDiet_eunit" id="HDiet_eunit_cal" value="0"$eunit{0}@\\
\mbox{}\verb@        tabindex="17" />&nbsp;<label for="HDiet_eunit_cal">calorie</label>@\\
\mbox{}\verb@    <input type="radio" name="HDiet_eunit" id="HDiet_eunit_kj" value="1"$eunit{1}@\\
\mbox{}\verb@        tabindex="18" />&nbsp;<label for="HDiet_eunit_kj">kilojoule</label>@\\
\mbox{}\verb@    </td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb127}{127}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Decimal character selection}

Radio buttons are used to select whether a period or comma
is used as the decimal character in numbers.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap210}\raggedright\small
\NWtarget{nuweb134a}{} $\langle\,${\itshape Decimal character selection}\nobreak\ {\footnotesize {134a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@<tr><th>Decimal character:</th>@\\
\mbox{}\verb@    <td>@\\
\mbox{}\verb@    <input type="radio" name="HDiet_dchar" id="HDiet_dchar_period" value="."$dchar{'.'}@\\
\mbox{}\verb@        tabindex="19" />&nbsp;<label for="HDiet_dchar_period">123.4</label>@\\
\mbox{}\verb@    <input type="radio" name="HDiet_dchar" id="HDiet_dchar_comma" value=","$dchar{','}@\\
\mbox{}\verb@        tabindex="20" />&nbsp;<label for="HDiet_dchar_comma">123,4</label>@\\
\mbox{}\verb@    </td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb127}{127}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Public name settings}

Radio buttons are used to specify the weight and energy
units the user prefers.  These are preset based on the
setting in the parent object.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap211}\raggedright\small
\NWtarget{nuweb134b}{} $\langle\,${\itshape Public name settings}\nobreak\ {\footnotesize {134b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<tr><th>Public name:</th>@\\
\mbox{}\verb@    <td>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        if ($self->{public}) {@\\
\mbox{}\verb@            my $pub_name = quoteHTML($self->{public_name});@\\
\mbox{}\verb@            print $fh <<"EOD";@\\
\mbox{}\verb@<input type="checkbox" name="HDiet_public" checked="checked" tabindex="21" />@\\
\mbox{}\verb@<b>Pseudonym:</b> $pub_name &nbsp; &nbsp;@\\
\mbox{}\verb@<input type="checkbox" name="HDiet_pubnew" id="HDiet_pubnew"@\\
\mbox{}\verb@    tabindex="22" />&nbsp;<label for="HDiet_pubnew">Assign new pseudonym?</label>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            print $fh <<"EOD";@\\
\mbox{}\verb@<input type="checkbox" name="HDiet_public" id="HDiet_public"@\\
\mbox{}\verb@tabindex="21" /> <label for="HDiet_public">Check to make your@\\
\mbox{}\verb@    logs visible to the public under a pseudonym.</label>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@    </td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb127}{127}.
\item \NWtxtIdentsUsed\nobreak\  \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{resetPassword}

The {\tt resetPassword} method generates a random password of the
length given by the first argument with {\tt generatePassword} and
places it in the {\tt password} field of the user object.  The new
password is returned to the caller. Note that this method does not
alter the expiration date of the password; if you wish to do that,
you'll have to change the {\tt password\_expires} field yourself.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap212}\raggedright\small
\NWtarget{nuweb135a}{} \verb@"HDiet/user.pm"@\nobreak\ {\footnotesize {135a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub resetPassword {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($nchars) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $npw = $self->generatePassword($nchars);@\\
\mbox{}\verb@        $self->{password} = $npw;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $npw;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb118}{118}\NWlink{nuweb120}{, 120}\NWlink{nuweb121}{, 121}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb125}{, 125}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb135a}{, 135a}\NWlink{nuweb135b}{b}\NWlink{nuweb136}{, 136}\NWlink{nuweb137}{, 137}\NWlink{nuweb138}{, 138}\NWlink{nuweb139}{, 139}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb142}{, 142}\NWlink{nuweb143}{, 143}\NWlink{nuweb145}{, 145}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb146b}{b}\NWlink{nuweb147}{, 147}.
\item \NWtxtIdentsDefed\nobreak\  \verb@resetPassword@\nobreak\ \NWlink{nuweb199}{199}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{generatePassword}

The {\tt generatePassword} method generates a random password of the
length given by the first argument and returns it to the caller.  You
can optionally pass a second string argument which specifies the set
of characters of which the password will be composed.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap213}\raggedright\small
\NWtarget{nuweb135b}{} \verb@"HDiet/user.pm"@\nobreak\ {\footnotesize {135b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub generatePassword {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($nchars, $pwchars) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $pwchars = ("ABCDEFGHIJKLMNPQRSTUVWXYZ" .@\\
\mbox{}\verb@                    "abcdefghjkmnopqrstuvwxyz" .@\\
\mbox{}\verb@                    "23456789" .@\\
\mbox{}\verb@                    "-.") if !$pwchars;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $npw = '';@\\
\mbox{}\verb@        for (my $i = 0; $i < $nchars; $i++) {@\\
\mbox{}\verb@            $npw .= substr($pwchars, int(rand(length($pwchars))), 1);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return $npw;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb118}{118}\NWlink{nuweb120}{, 120}\NWlink{nuweb121}{, 121}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb125}{, 125}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb135a}{, 135a}\NWlink{nuweb135b}{b}\NWlink{nuweb136}{, 136}\NWlink{nuweb137}{, 137}\NWlink{nuweb138}{, 138}\NWlink{nuweb139}{, 139}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb142}{, 142}\NWlink{nuweb143}{, 143}\NWlink{nuweb145}{, 145}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb146b}{b}\NWlink{nuweb147}{, 147}.
\item \NWtxtIdentsDefed\nobreak\  \verb@resetPassword@\nobreak\ \NWlink{nuweb135a}{135a}\NWlink{nuweb199}{, 199}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{SendMail}

The {\tt sendMail} method sends an E-mail message to the designated
address of the user with the subject given by the first argument and
the message body passed as the second.  It's up to the caller to
ensure that the message body doesn't contain any lines consisting
only of a single period, which would cause message truncation.
(We could quote them here, but since this method is used to send
standard messages over which we have formatting control, there's
no reason to bother.)

Mail is sent using the system's {\tt Sendmail} program, setting the
``From'' address to that configured (usually a no-reply bit bucket), which
may be overridden by the optional third argument).  Note that if you
set the ``From'' address to one different than the user under which
the program is executing, the mail sent will contain an
``{\tt X-Authentication-Warning}'' header unless the original user
account is listed among the ``{\tt trusted-users}'' configured for
Sendmail.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap214}\raggedright\small
\NWtarget{nuweb136}{} \verb@"HDiet/user.pm"@\nobreak\ {\footnotesize {136}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub sendMail {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($subject, $message, $from) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $from = "@\hbox{$\langle\,${\itshape From address for mail sent to users}\nobreak\ {\footnotesize \NWlink{nuweb11e}{11e}}$\,\rangle$}\verb@" if !defined($from);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        open(MAIL, "|-:utf8", "@\hbox{$\langle\,${\itshape Path to Invoke Sendmail}\nobreak\ {\footnotesize \NWlink{nuweb11d}{11d}}$\,\rangle$}\verb@",@\\
\mbox{}\verb@                "-f$from",@\\
\mbox{}\verb@                $self->{e_mail}) ||@\\
\mbox{}\verb@            die("Cannot create pipe to @\hbox{$\langle\,${\itshape Path to Invoke Sendmail}\nobreak\ {\footnotesize \NWlink{nuweb11d}{11d}}$\,\rangle$}\verb@");@\\
\mbox{}\verb@        print MAIL <<"EOD";@\\
\mbox{}\verb@From $from\r@\\
\mbox{}\verb@To: $self->{e_mail}\r@\\
\mbox{}\verb@Subject: [The Hacker's Diet Online] $subject\r@\\
\mbox{}\verb@Content-type: text/plain; charset=utf-8\r@\\
\mbox{}\verb@\r@\\
\mbox{}\verb@$message@\\
\mbox{}\verb@.\r@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        close(MAIL);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb118}{118}\NWlink{nuweb120}{, 120}\NWlink{nuweb121}{, 121}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb125}{, 125}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb135a}{, 135a}\NWlink{nuweb135b}{b}\NWlink{nuweb136}{, 136}\NWlink{nuweb137}{, 137}\NWlink{nuweb138}{, 138}\NWlink{nuweb139}{, 139}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb142}{, 142}\NWlink{nuweb143}{, 143}\NWlink{nuweb145}{, 145}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb146b}{b}\NWlink{nuweb147}{, 147}.
\item \NWtxtIdentsDefed\nobreak\  \verb@sendMail@\nobreak\ \NWlink{nuweb202}{202}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Export user information as XML}

The {\tt exportPreferencesXML} method writes the {\tt user}
XML element which specifies user identity information.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap215}\raggedright\small
\NWtarget{nuweb137}{} \verb@"HDiet/user.pm"@\nobreak\ {\footnotesize {137}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub exportUserInformationXML {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($fh) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $li = quoteXML($self->{login_name}, 1);@\\
\mbox{}\verb@        my $fn = quoteXML($self->{first_name}, 1);@\\
\mbox{}\verb@        my $mn = quoteXML($self->{middle_name}, 1);@\\
\mbox{}\verb@        my $ln = quoteXML($self->{last_name}, 1);@\\
\mbox{}\verb@        my $em = quoteXML($self->{e_mail}, 1);@\\
\mbox{}\verb@        my $ac = timeXML($self->{account_created});@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@        <user version="1.0">@\\
\mbox{}\verb@            <login-name>$li</login-name>@\\
\mbox{}\verb@            <first-name>$fn</first-name>@\\
\mbox{}\verb@            <middle-name>$mn</middle-name>@\\
\mbox{}\verb@            <last-name>$ln</last-name>@\\
\mbox{}\verb@            <e-mail>$em</e-mail>@\\
\mbox{}\verb@            <height>$self->{height}</height>@\\
\mbox{}\verb@            <account-created>$ac</account-created>@\\
\mbox{}\verb@        </user>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb118}{118}\NWlink{nuweb120}{, 120}\NWlink{nuweb121}{, 121}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb125}{, 125}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb135a}{, 135a}\NWlink{nuweb135b}{b}\NWlink{nuweb136}{, 136}\NWlink{nuweb137}{, 137}\NWlink{nuweb138}{, 138}\NWlink{nuweb139}{, 139}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb142}{, 142}\NWlink{nuweb143}{, 143}\NWlink{nuweb145}{, 145}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb146b}{b}\NWlink{nuweb147}{, 147}.
\item \NWtxtIdentsDefed\nobreak\  \verb@exportUserInformationXML@\nobreak\ \NWlink{nuweb254}{254}.\item \NWtxtIdentsUsed\nobreak\  \verb@login@\nobreak\ \NWlink{nuweb121}{121}, \verb@quoteXML@\nobreak\ \NWlink{nuweb442a}{442a}, \verb@timeXML@\nobreak\ \NWlink{nuweb443}{443}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Export preferences as XML}

The {\tt exportPreferencesXML} method writes the {\tt preferences}
XML element defining user preferences to the file handle passed as
the argument.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap216}\raggedright\small
\NWtarget{nuweb138}{} \verb@"HDiet/user.pm"@\nobreak\ {\footnotesize {138}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub exportPreferencesXML {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($fh) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $lu = HDiet::monthlog::WEIGHT_UNITS->[$self->{log_unit}];@\\
\mbox{}\verb@        my $du = HDiet::monthlog::WEIGHT_UNITS->[$self->{display_unit}];@\\
\mbox{}\verb@        my $eu = HDiet::monthlog::ENERGY_UNITS->[$self->{energy_unit}];@\\
\mbox{}\verb@        my $cr = $self->{current_rung};@\\
\mbox{}\verb@        my $dc = quoteXML($self->{decimal_character});@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@        <preferences version="1.0">@\\
\mbox{}\verb@            <log-unit>$lu</log-unit>@\\
\mbox{}\verb@            <display-unit>$du</display-unit>@\\
\mbox{}\verb@            <energy-unit>$eu</energy-unit>@\\
\mbox{}\verb@            <current-rung>$cr</current-rung>@\\
\mbox{}\verb@            <decimal-character>$dc</decimal-character>@\\
\mbox{}\verb@        </preferences>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb118}{118}\NWlink{nuweb120}{, 120}\NWlink{nuweb121}{, 121}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb125}{, 125}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb135a}{, 135a}\NWlink{nuweb135b}{b}\NWlink{nuweb136}{, 136}\NWlink{nuweb137}{, 137}\NWlink{nuweb138}{, 138}\NWlink{nuweb139}{, 139}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb142}{, 142}\NWlink{nuweb143}{, 143}\NWlink{nuweb145}{, 145}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb146b}{b}\NWlink{nuweb147}{, 147}.
\item \NWtxtIdentsDefed\nobreak\  \verb@exportPreferencesXML@\nobreak\ \NWlink{nuweb254}{254}.\item \NWtxtIdentsUsed\nobreak\  \verb@ENERGY_UNITS@\nobreak\ \NWlink{nuweb24}{24}, \verb@quoteXML@\nobreak\ \NWlink{nuweb442a}{442a}, \verb@WEIGHT_UNITS@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Export diet plan as XML}

The {\tt exportDietPlanXML} method writes the {\tt diet-plan}
XML element which contains the current diet plan from the
diet calculator.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap217}\raggedright\small
\NWtarget{nuweb139}{} \verb@"HDiet/user.pm"@\nobreak\ {\footnotesize {139}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub exportDietPlanXML {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($fh) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $ac = timeXML($self->{calc_start_date});@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@        <diet-plan version="1.0">@\\
\mbox{}\verb@            <calorie-balance>$self->{calc_calorie_balance}</calorie-balance>@\\
\mbox{}\verb@            <start-weight>$self->{calc_start_weight}</start-weight>@\\
\mbox{}\verb@            <goal-weight>$self->{calc_goal_weight}</goal-weight>@\\
\mbox{}\verb@            <start-date>$ac</start-date>@\\
\mbox{}\verb@            <show-plan>$self->{plot_diet_plan}</show-plan>@\\
\mbox{}\verb@        </diet-plan>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb118}{118}\NWlink{nuweb120}{, 120}\NWlink{nuweb121}{, 121}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb125}{, 125}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb135a}{, 135a}\NWlink{nuweb135b}{b}\NWlink{nuweb136}{, 136}\NWlink{nuweb137}{, 137}\NWlink{nuweb138}{, 138}\NWlink{nuweb139}{, 139}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb142}{, 142}\NWlink{nuweb143}{, 143}\NWlink{nuweb145}{, 145}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb146b}{b}\NWlink{nuweb147}{, 147}.
\item \NWtxtIdentsDefed\nobreak\  \verb@exportDietPlanXML@\nobreak\ \NWlink{nuweb254}{254}.\item \NWtxtIdentsUsed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_goal_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@start@\nobreak\ \NWlink{nuweb19b}{19b}, \verb@timeXML@\nobreak\ \NWlink{nuweb443}{443}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{enumerateMonths}

The {\tt enumerateMonths} method returns a list, sorted in chronological
order, of all months in the database (in the form ``{\em YYYY}{\tt -}{\em MM}'')
if called with no argument, or just for the given year if called with the
desired year as the argument.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap218}\raggedright\small
\NWtarget{nuweb140}{} \verb@"HDiet/user.pm"@\nobreak\ {\footnotesize {140}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub enumerateMonths {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($year) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $user_file_name = quoteUserName($self->{login_name});@\\
\mbox{}\verb@        my $selpat = $year ? $year : '\d+';@\\
\mbox{}\verb@@\\
\mbox{}\verb@        opendir(CD, "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name") ||@\\
\mbox{}\verb@            die("Cannot open directory @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name");@\\
\mbox{}\verb@        my @{\tt @}\verb@logs;@\\
\mbox{}\verb@        my $f;@\\
\mbox{}\verb@        foreach $f (sort(grep(/^$selpat\-\d\d\.hdb/, readdir(CD)))) {@\\
\mbox{}\verb@            $f =~ s/\.\w*$//;@\\
\mbox{}\verb@            push(@{\tt @}\verb@logs, $f);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        closedir(CD);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return @{\tt @}\verb@logs;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb118}{118}\NWlink{nuweb120}{, 120}\NWlink{nuweb121}{, 121}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb125}{, 125}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb135a}{, 135a}\NWlink{nuweb135b}{b}\NWlink{nuweb136}{, 136}\NWlink{nuweb137}{, 137}\NWlink{nuweb138}{, 138}\NWlink{nuweb139}{, 139}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb142}{, 142}\NWlink{nuweb143}{, 143}\NWlink{nuweb145}{, 145}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb146b}{b}\NWlink{nuweb147}{, 147}.
\item \NWtxtIdentsDefed\nobreak\  \verb@enumerateMonths@\nobreak\ \NWlink{nuweb108}{108}\NWlink{nuweb109a}{, 109a}\NWlink{nuweb214}{, 214}\NWlink{nuweb222}{, 222}\NWlink{nuweb251a}{, 251a}\NWlink{nuweb254}{, 254}\NWlink{nuweb255}{, 255}\NWlink{nuweb256}{, 256}\NWlink{nuweb257}{, 257}\NWlink{nuweb271a}{, 271a}\NWlink{nuweb319}{, 319}\NWlink{nuweb327}{, 327}\NWlink{nuweb333}{, 333}\NWlink{nuweb335}{, 335}\NWlink{nuweb374}{, 374}\NWlink{nuweb377}{, 377}\NWlink{nuweb380}{, 380}\NWlink{nuweb382}{, 382}\NWlink{nuweb392}{, 392}.\item \NWtxtIdentsUsed\nobreak\  \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{enumerateYears}

The {\tt enumerateYears} method returns a list, sorted in chronological
order, of all years with one or more month entries in the database.  The
years are returned as numbers.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap219}\raggedright\small
\NWtarget{nuweb141}{} \verb@"HDiet/user.pm"@\nobreak\ {\footnotesize {141}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub enumerateYears {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $user_file_name = quoteUserName($self->{login_name});@\\
\mbox{}\verb@        my $lyear = '';@\\
\mbox{}\verb@        my @{\tt @}\verb@years;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        opendir(CD, "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name") ||@\\
\mbox{}\verb@            die("Cannot open directory @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name");@\\
\mbox{}\verb@        my $m;@\\
\mbox{}\verb@        foreach $m (sort(grep(/^\d+\-\d\d\.hdb/, readdir(CD)))) {@\\
\mbox{}\verb@            $m =~ m/^(\d+)\-/;@\\
\mbox{}\verb@            if ($1 ne $lyear) {@\\
\mbox{}\verb@                $lyear = $1;@\\
\mbox{}\verb@                push(@{\tt @}\verb@years, $lyear);@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        closedir(CD);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return @{\tt @}\verb@years;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb118}{118}\NWlink{nuweb120}{, 120}\NWlink{nuweb121}{, 121}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb125}{, 125}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb135a}{, 135a}\NWlink{nuweb135b}{b}\NWlink{nuweb136}{, 136}\NWlink{nuweb137}{, 137}\NWlink{nuweb138}{, 138}\NWlink{nuweb139}{, 139}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb142}{, 142}\NWlink{nuweb143}{, 143}\NWlink{nuweb145}{, 145}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb146b}{b}\NWlink{nuweb147}{, 147}.
\item \NWtxtIdentsDefed\nobreak\  \verb@enumerateYears@\nobreak\ \NWlink{nuweb109b}{109b}\NWlink{nuweb221}{, 221}\NWlink{nuweb250}{, 250}\NWlink{nuweb264}{, 264}\NWlink{nuweb277a}{, 277a}\NWlink{nuweb294}{, 294}.\item \NWtxtIdentsUsed\nobreak\  \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{dietPlanLimits}

The {\tt dietPlanLimits} method returns a list giving the start Julian
day, start weight, end Julian day, and goal weight of the current diet
plan.  If no diet plan is defined, or the diet plan makes no sense
(energy balance is opposite from the goal versus start weight) {\tt
undef} is returned.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap220}\raggedright\small
\NWtarget{nuweb142}{} \verb@"HDiet/user.pm"@\nobreak\ {\footnotesize {142}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub dietPlanLimits {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (($self->{calc_start_weight} == 0) ||@\\
\mbox{}\verb@            ($self->{calc_goal_weight} == 0) ||@\\
\mbox{}\verb@            ($self->{calc_start_date} == 0) ||@\\
\mbox{}\verb@            (::sgn($self->{calc_calorie_balance}) != ::sgn($self->{calc_goal_weight} - $self->{calc_start_weight}))) {@\\
\mbox{}\verb@            return undef;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        my $jdstart = unix_time_to_jd($self->{calc_start_date});@\\
\mbox{}\verb@        my $jdend = $jdstart +@\\
\mbox{}\verb@               (($self->{calc_calorie_balance} != 0) ? ((($self->{calc_goal_weight} - $self->{calc_start_weight}) /@\\
\mbox{}\verb@                ($self->{calc_calorie_balance} /@\\
\mbox{}\verb@                   HDiet::monthlog::CALORIES_PER_WEIGHT_UNIT->[HDiet::monthlog::WEIGHT_KILOGRAM]))) : 1);@\\
\mbox{}\verb@        return ($jdstart, $self->{calc_start_weight}, $jdend, $self->{calc_goal_weight});@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb118}{118}\NWlink{nuweb120}{, 120}\NWlink{nuweb121}{, 121}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb125}{, 125}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb135a}{, 135a}\NWlink{nuweb135b}{b}\NWlink{nuweb136}{, 136}\NWlink{nuweb137}{, 137}\NWlink{nuweb138}{, 138}\NWlink{nuweb139}{, 139}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb142}{, 142}\NWlink{nuweb143}{, 143}\NWlink{nuweb145}{, 145}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb146b}{b}\NWlink{nuweb147}{, 147}.
\item \NWtxtIdentsDefed\nobreak\  \verb@dietPlanLimits@\nobreak\ \NWlink{nuweb212a}{212a}\NWlink{nuweb263a}{, 263a}\NWlink{nuweb303}{, 303}.\item \NWtxtIdentsUsed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_goal_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@CALORIES_PER_WEIGHT_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@sgn@\nobreak\ \NWlink{nuweb405}{405}, \verb@unix_time_to_jd@\nobreak\ \NWlink{nuweb450b}{450b}, \verb@WEIGHT_KILOGRAM@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{generateEncryptedUserID}

The {\tt generateEncryptedUserID} method generates an opaque string
encrypted with the master encryption key which we (but not others who
lack the key) can decode to obtain the user file name. The encrypted
user ID includes random data and internal consistency checks to thwart
attempts to reverse engineer or probe for the key.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap221}\raggedright\small
\NWtarget{nuweb143}{} \verb@"HDiet/user.pm"@\nobreak\ {\footnotesize {143}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub generateEncryptedUserID {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $plain = '';@\\
\mbox{}\verb@        for (my $i = 0; $i < 13; $i++) {@\\
\mbox{}\verb@            $plain .= chr(int(rand(95)) + 32);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $plain .= quoteUserName($self->{login_name});@\\
\mbox{}\verb@        for (my $i = 0; $i < 11; $i++) {@\\
\mbox{}\verb@            $plain .= chr(int(rand(95)) + 32);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        my $crc = new HDiet::Digest::Crc32();@\\
\mbox{}\verb@        $plain .= sprintf("%08x", $crc->strcrc32($plain));@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $crypto = Crypt::CBC->new(@\\
\mbox{}\verb@                -key => @\hbox{$\langle\,${\itshape Master encryption key}\nobreak\ {\footnotesize \NWlink{nuweb5a}{5a}}$\,\rangle$}\verb@,@\\
\mbox{}\verb@                -cipher => "Crypt::OpenSSL::AES"@\\
\mbox{}\verb@                                    );@\\
\mbox{}\verb@        my $encrypted = $crypto->encrypt($plain);@\\
\mbox{}\verb@        my $ecrc = sprintf("%08x", $crc->strcrc32($encrypted));@\\
\mbox{}\verb@        my $huid = unpack("H*", $encrypted);@\\
\mbox{}\verb@        my $euid = substr($huid, 0, 17) . $ecrc . substr($huid, 17);@\\
\mbox{}\verb@        $euid =~ tr/a-f/FGJKQW/;@\\
\mbox{}\verb@        return $euid;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb118}{118}\NWlink{nuweb120}{, 120}\NWlink{nuweb121}{, 121}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb125}{, 125}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb135a}{, 135a}\NWlink{nuweb135b}{b}\NWlink{nuweb136}{, 136}\NWlink{nuweb137}{, 137}\NWlink{nuweb138}{, 138}\NWlink{nuweb139}{, 139}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb142}{, 142}\NWlink{nuweb143}{, 143}\NWlink{nuweb145}{, 145}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb146b}{b}\NWlink{nuweb147}{, 147}.
\item \NWtxtIdentsDefed\nobreak\  \verb@generateEncryptedUserID@\nobreak\ \NWlink{nuweb245}{245}\NWlink{nuweb461}{, 461}.\item \NWtxtIdentsUsed\nobreak\  \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{decodeEncryptedUserID}

The {\tt decodeEncryptedUserID} function extracts the user file name from an
opaque user identity string encoded with {\tt generateEncryptedUserID}
above.  It validates both the external and internal CRCs and returns
the user name if all validation tests pass; otherwise {\tt undef}
is returned.  Note that this function is {\em not} a part
of the {\tt user} module---it is a macro which is included in the
{\tt HackDietBadge} lightweight program which retrieves and returns
the current badge for a user.  We define the macro here because
it's easier to read the function in conjunction with
{\tt generateEncryptedUserID} above.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap222}\raggedright\small
\NWtarget{nuweb144}{} $\langle\,${\itshape Decode encrypted user ID}\nobreak\ {\footnotesize {144}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub decodeEncryptedUserID {@\\
\mbox{}\verb@        my ($crypt) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $crypt =~ tr/FGJKQW/a-f/;@\\
\mbox{}\verb@        my $cryptoSig = substr($crypt, 17, 8, "");@\\
\mbox{}\verb@        $crypt = pack("H*", $crypt);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $crc = new HDiet::Digest::Crc32();@\\
\mbox{}\verb@        my $outerSig = sprintf("%08x", $crc->strcrc32($crypt));@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($cryptoSig ne $outerSig) {@\\
\mbox{}\verb@print(STDERR "user::decodeEncryptedUserID: Outer CRC bad: $cryptoSig $outerSig\n");@\\
\mbox{}\verb@            return undef;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $crypto = Crypt::CBC->new(@\\
\mbox{}\verb@                -key => @\hbox{$\langle\,${\itshape Master encryption key}\nobreak\ {\footnotesize \NWlink{nuweb5a}{5a}}$\,\rangle$}\verb@,@\\
\mbox{}\verb@                -cipher => "Crypt::OpenSSL::AES"@\\
\mbox{}\verb@                                    );@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $decrypted = $crypto->decrypt($crypt);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $rcrc = substr($decrypted, -8, 8, "");@\\
\mbox{}\verb@        my $icrc = sprintf("%08x", $crc->strcrc32($decrypted));@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($rcrc ne $icrc) {@\\
\mbox{}\verb@print(STDERR "user::decodeEncryptedUserID: Inner CRC bad:  RCRC = $rcrc  ICRC = $icrc\n");@\\
\mbox{}\verb@            return undef;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return substr($decrypted, 13, -11);@\\
\mbox{}\verb@     }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb459}{459}\NWlink{nuweb461}{, 461}.
\item \NWtxtIdentsDefed\nobreak\  \verb@decodeEncryptedUserID@\nobreak\ \NWlink{nuweb459}{459}\NWlink{nuweb461}{, 461}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{QuoteUserName}

The {\tt quoteUserName} function takes an arbitrary UTF-8 string argument
and returns an ASCII string suitable for use as a Unix file name.  ASCII
alphanumerics and underscores are left unchanged, spaces are replaced
with plus signs, and all other characters are replaced with their hexadecimal
codes enclosed in braces.  If the quoted user name exceeds the system's
maximum file name length, it is truncated to 40 characters less than that
length and the 40 character hexadecimal SHA1 digest of the entire name is
appended.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap223}\raggedright\small
\NWtarget{nuweb145}{} \verb@"HDiet/user.pm"@\nobreak\ {\footnotesize {145}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub quoteUserName {@\\
\mbox{}\verb@        my ($s) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $os = '';@\\
\mbox{}\verb@@\\
\mbox{}\verb@        while ($s =~ s/^(.)//) {@\\
\mbox{}\verb@            my $c = $1;@\\
\mbox{}\verb@@\\
\mbox{}\verb@            if ((ord($c) < 256) && ($c =~ m/@\hbox{$\langle\,${\itshape Characters Permissible in File Names}\nobreak\ {\footnotesize \NWlink{nuweb10d}{10d}}$\,\rangle$}\verb@/)) {@\\
\mbox{}\verb@                $os .= $c;@\\
\mbox{}\verb@            } elsif ($c eq ' ') {@\\
\mbox{}\verb@                $os .= '@\hbox{$\langle\,${\itshape Encoding for Space in File Name Characters}\nobreak\ {\footnotesize \NWlink{nuweb10e}{10e}}$\,\rangle$}\verb@';@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                $os .= sprintf('@\hbox{$\langle\,${\itshape Left Delimiter for Quoted File Name Characters}\nobreak\ {\footnotesize \NWlink{nuweb11a}{11a}}$\,\rangle$}\verb@' .@\\
\mbox{}\verb@                               '%X' .@\\
\mbox{}\verb@                               '@\hbox{$\langle\,${\itshape Right Delimiter for Quoted File Name Characters}\nobreak\ {\footnotesize \NWlink{nuweb11b}{11b}}$\,\rangle$}\verb@', ord($c));@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (length($os) > @\hbox{$\langle\,${\itshape Maximum File Length}\nobreak\ {\footnotesize \NWlink{nuweb8e}{8e}}$\,\rangle$}\verb@) {@\\
\mbox{}\verb@            $os = substr($os, 0, @\hbox{$\langle\,${\itshape Maximum File Length}\nobreak\ {\footnotesize \NWlink{nuweb8e}{8e}}$\,\rangle$}\verb@ - 40) .@\\
\mbox{}\verb@                    sha1_hex(encode_utf8($os));@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $os;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb118}{118}\NWlink{nuweb120}{, 120}\NWlink{nuweb121}{, 121}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb125}{, 125}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb135a}{, 135a}\NWlink{nuweb135b}{b}\NWlink{nuweb136}{, 136}\NWlink{nuweb137}{, 137}\NWlink{nuweb138}{, 138}\NWlink{nuweb139}{, 139}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb142}{, 142}\NWlink{nuweb143}{, 143}\NWlink{nuweb145}{, 145}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb146b}{b}\NWlink{nuweb147}{, 147}.
\item \NWtxtIdentsDefed\nobreak\  \verb@quoteUserName@\nobreak\ \NWlink{nuweb116}{116}\NWlink{nuweb118}{, 118}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb143}{, 143}\NWlink{nuweb166}{, 166}\NWlink{nuweb167}{, 167}\NWlink{nuweb168}{, 168}\NWlink{nuweb169b}{, 169b}\NWlink{nuweb183}{, 183}\NWlink{nuweb184}{, 184}\NWlink{nuweb199}{, 199}\NWlink{nuweb205}{, 205}\NWlink{nuweb206}{, 206}\NWlink{nuweb306a}{, 306a}\NWlink{nuweb317}{, 317}\NWlink{nuweb319}{, 319}\NWlink{nuweb320}{, 320}\NWlink{nuweb330}{, 330}\NWlink{nuweb333}{, 333}\NWlink{nuweb335}{, 335}\NWlink{nuweb339}{, 339}\NWlink{nuweb346}{, 346}\NWlink{nuweb392}{, 392}\NWlink{nuweb400}{, 400}\NWlink{nuweb461}{, 461}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Express number in canonical form}

The {\tt canonicalNumber} function converts a number to canonical form by
rounding the number passed as the first argument to the number of decimal
places given by the second, then eliding any trailing zeroes and the decimal
point if the number is an integer.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap224}\raggedright\small
\NWtarget{nuweb146a}{} \verb@"HDiet/user.pm"@\nobreak\ {\footnotesize {146a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub canonicalNumber {@\\
\mbox{}\verb@        my ($value, $places) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $value = sprintf("%.${places}f", $value);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $value =~ s/(\.[^0]*)0+$/$1/;@\\
\mbox{}\verb@        $value =~ s/\.$//;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $value;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb118}{118}\NWlink{nuweb120}{, 120}\NWlink{nuweb121}{, 121}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb125}{, 125}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb135a}{, 135a}\NWlink{nuweb135b}{b}\NWlink{nuweb136}{, 136}\NWlink{nuweb137}{, 137}\NWlink{nuweb138}{, 138}\NWlink{nuweb139}{, 139}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb142}{, 142}\NWlink{nuweb143}{, 143}\NWlink{nuweb145}{, 145}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb146b}{b}\NWlink{nuweb147}{, 147}.
\item \NWtxtIdentsDefed\nobreak\  \verb@canonicalNumber@\nobreak\ \NWlink{nuweb128}{128}\NWlink{nuweb147}{, 147}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Convert decimal number to localised form}

The {\tt localiseDecimal}function  converts its argument, assumed to
be a number with decimal places, to use the user's specified
\verb+decimal_character+.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap225}\raggedright\small
\NWtarget{nuweb146b}{} \verb@"HDiet/user.pm"@\nobreak\ {\footnotesize {146b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub localiseDecimal {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($value) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $value =~ s/\./$self->{decimal_character}/;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $value;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb118}{118}\NWlink{nuweb120}{, 120}\NWlink{nuweb121}{, 121}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb125}{, 125}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb135a}{, 135a}\NWlink{nuweb135b}{b}\NWlink{nuweb136}{, 136}\NWlink{nuweb137}{, 137}\NWlink{nuweb138}{, 138}\NWlink{nuweb139}{, 139}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb142}{, 142}\NWlink{nuweb143}{, 143}\NWlink{nuweb145}{, 145}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb146b}{b}\NWlink{nuweb147}{, 147}.
\item \NWtxtIdentsDefed\nobreak\  \verb@localiseDecimal@\nobreak\ \NWlink{nuweb100}{100}\NWlink{nuweb147}{, 147}\NWlink{nuweb215}{, 215}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Express number in localised form}

The {\tt localiseNumber} method converts a number to canonical form by
rounding the number passed as the first argument to the number of decimal
places given by the second, then eliding any trailing zeroes and the decimal
point if the number is an integer.  If a decimal point remains in the
value, the user's specified \verb+decimal_character+ separates the
unit and decimal digits.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap226}\raggedright\small
\NWtarget{nuweb147}{} \verb@"HDiet/user.pm"@\nobreak\ {\footnotesize {147}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub localiseNumber {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($value, $places) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $self->localiseDecimal(canonicalNumber($value, $places));@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb118}{118}\NWlink{nuweb120}{, 120}\NWlink{nuweb121}{, 121}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb125}{, 125}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb135a}{, 135a}\NWlink{nuweb135b}{b}\NWlink{nuweb136}{, 136}\NWlink{nuweb137}{, 137}\NWlink{nuweb138}{, 138}\NWlink{nuweb139}{, 139}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb142}{, 142}\NWlink{nuweb143}{, 143}\NWlink{nuweb145}{, 145}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb146b}{b}\NWlink{nuweb147}{, 147}.
\item \NWtxtIdentsDefed\nobreak\  \verb@localiseNumber@\nobreak\ \NWlink{nuweb128}{128}.\item \NWtxtIdentsUsed\nobreak\  \verb@canonicalNumber@\nobreak\ \NWlink{nuweb146a}{146a}\NWlink{nuweb519a}{, 519a}, \verb@localiseDecimal@\nobreak\ \NWlink{nuweb146b}{146b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

%                      _
%    ___  ___  ___ ___(_) ___  _ __
%   / __|/ _ \/ __/ __| |/ _ \| '_ \
%   \__ \  __/\__ \__ \ | (_) | | | |
%   |___/\___||___/___/_|\___/|_| |_|
%

\clearpage
\vbox{
\chapter{{\tt session.pm}: Session Object}
\label{session.pm}

The {\tt session} object represents an open session.

}

\vbox{
\section{Package plumbing}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap227}\raggedright\small
\NWtarget{nuweb148}{} \verb@"HDiet/session.pm"@\nobreak\ {\footnotesize {148}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@#! @\hbox{$\langle\,${\itshape Perl directory}\nobreak\ {\footnotesize \NWlink{nuweb8d}{8d}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Perl language modes}\nobreak\ {\footnotesize \NWlink{nuweb387b}{387b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    package HDiet::session;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use Encode qw(encode_utf8);@\\
\mbox{}\verb@    use Digest::SHA1  qw(sha1_hex);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    require Exporter;@\\
\mbox{}\verb@    our @{\tt @}\verb@ISA = qw(Exporter);@\\
\mbox{}\verb@    our @{\tt @}\verb@EXPORT = qw( load_active_session );@\\
\mbox{}\verb@    1;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use constant FILE_VERSION => 1;@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb148}{148}\NWlink{nuweb149}{, 149}\NWlink{nuweb150}{, 150}\NWlink{nuweb151}{, 151}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb152c}{c}\NWlink{nuweb153a}{, 153a}\NWlink{nuweb153b}{b}.
\item \NWtxtIdentsUsed\nobreak\  \verb@load_active_session@\nobreak\ \NWlink{nuweb153a}{153a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Constructor}

A new {\tt session} object is created by calling the
{\tt new} constructor.  The constructor has two optional
arguments: the user login name and the \UNIX/ date and
time of the login.  If omitted, the user name is set to
blank and the login time to the current time.

\begin{center}
\begin{tabular}{|l|l|}
\hline
login\_name                 &   User login name \\
session\_id                 &   Session identifier \\
login\_time                 &   Date and time of login \\
effective\_name             &   Effective login name for administrator access \\
browse\_name                &   Browse name for user accessing public accounts \\
read\_only                  &   Is session read-only ? \\
handheld                    &   Is session on handheld device ? \\
cookie                      &   Was session login via a cookie ? \\
\hline
\end{tabular}
\end{center}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap228}\raggedright\small
\NWtarget{nuweb149}{} \verb@"HDiet/session.pm"@\nobreak\ {\footnotesize {149}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub new {@\\
\mbox{}\verb@        my $self = {};@\\
\mbox{}\verb@        my ($invocant, $login_name, $login_time) = @{\tt @}\verb@_;@\\
\mbox{}\verb@        my $class = ref($invocant) || $invocant;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $login_name = '' if !defined($login_name);@\\
\mbox{}\verb@        $login_time = time() if !defined($login_time);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        bless($self, $class);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $self->{version} = FILE_VERSION;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   Initialise instance variables@\\
\mbox{}\verb@        $self->{login_name} = $login_name;@\\
\mbox{}\verb@        if ($login_name ne '') {@\\
\mbox{}\verb@            $self->{session_id} = generateSessionID($login_name);@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $self->{session_id} = '';@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $self->{login_time} = $login_time;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $self->{effective_name} = $self->{browse_name} = '';@\\
\mbox{}\verb@        $self->{read_only} = 0;@\\
\mbox{}\verb@        $self->{handheld} = 0;@\\
\mbox{}\verb@        $self->{cookie} = 0;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $self;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb148}{148}\NWlink{nuweb149}{, 149}\NWlink{nuweb150}{, 150}\NWlink{nuweb151}{, 151}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb152c}{c}\NWlink{nuweb153a}{, 153a}\NWlink{nuweb153b}{b}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generateSessionID@\nobreak\ \NWlink{nuweb153b}{153b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Describe}

The {\tt describe} method prints a primate-readable description
of the session on the file handle (default {\tt STDOUT})
given by the argument.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap229}\raggedright\small
\NWtarget{nuweb150}{} \verb@"HDiet/session.pm"@\nobreak\ {\footnotesize {150}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub describe {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($outfile) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (!(defined $outfile)) {@\\
\mbox{}\verb@            $outfile = \*STDOUT;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print($outfile "SESSION Version: $self->{version}\n");@\\
\mbox{}\verb@        print($outfile "  User name:      '$self->{login_name}'\n");@\\
\mbox{}\verb@        print($outfile "  Session ID:     '$self->{session_id}'\n");@\\
\mbox{}\verb@        print($outfile "  Login time:      " . localtime($self->{login_time}) . "\n");@\\
\mbox{}\verb@        print($outfile "  Effective name: '$self->{effective_name}'\n");@\\
\mbox{}\verb@        print($outfile "  Browse name:    '$self->{browse_name}'\n");@\\
\mbox{}\verb@        print($outfile "  Read only:      '$self->{read_only}'\n");@\\
\mbox{}\verb@        print($outfile "  Handheld:       '$self->{handheld}'\n");@\\
\mbox{}\verb@        print($outfile "  Cookie login:   '$self->{cookie}'\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb148}{148}\NWlink{nuweb149}{, 149}\NWlink{nuweb150}{, 150}\NWlink{nuweb151}{, 151}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb152c}{c}\NWlink{nuweb153a}{, 153a}\NWlink{nuweb153b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@describe@\nobreak\ \NWlink{nuweb27}{27}\NWlink{nuweb105}{, 105}\NWlink{nuweb122}{, 122}\NWlink{nuweb156a}{, 156a}\NWlink{nuweb170a}{, 170a}\NWlink{nuweb218}{, 218}\NWlink{nuweb316}{, 316}\NWlink{nuweb461}{, 461}.\item \NWtxtIdentsUsed\nobreak\  \verb@login@\nobreak\ \NWlink{nuweb121}{121}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Save}

The {\tt save} method writes the session item to the already-open file handle
passed as the argument.  Note that it's up to you to update the
{\tt last\_access} time (if appropriate) to before saving the session.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap230}\raggedright\small
\NWtarget{nuweb151}{} \verb@"HDiet/session.pm"@\nobreak\ {\footnotesize {151}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub save {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($outfile) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   File format version number@\\
\mbox{}\verb@        print($outfile "$self->{version}\n");@\\
\mbox{}\verb@        #   Login name@\\
\mbox{}\verb@        print($outfile "$self->{login_name}\n");@\\
\mbox{}\verb@        #   Session ID@\\
\mbox{}\verb@        print($outfile "$self->{session_id}\n");@\\
\mbox{}\verb@        #   Login time@\\
\mbox{}\verb@        print($outfile "$self->{login_time}\n");@\\
\mbox{}\verb@        #   Effective name@\\
\mbox{}\verb@        print($outfile "$self->{effective_name}\n");@\\
\mbox{}\verb@        #   Browse name@\\
\mbox{}\verb@        print($outfile "$self->{browse_name}\n");@\\
\mbox{}\verb@        #   Read only@\\
\mbox{}\verb@        print($outfile "$self->{read_only}\n");@\\
\mbox{}\verb@        #   Handheld device@\\
\mbox{}\verb@        print($outfile "$self->{handheld}\n");@\\
\mbox{}\verb@        #   Cookie login@\\
\mbox{}\verb@        print($outfile "$self->{cookie}\n");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb148}{148}\NWlink{nuweb149}{, 149}\NWlink{nuweb150}{, 150}\NWlink{nuweb151}{, 151}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb152c}{c}\NWlink{nuweb153a}{, 153a}\NWlink{nuweb153b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@save@\nobreak\ \NWlink{nuweb31}{31}\NWlink{nuweb113a}{, 113a}\NWlink{nuweb123}{, 123}\NWlink{nuweb156b}{, 156b}\NWlink{nuweb159}{, 159}\NWlink{nuweb167}{, 167}\NWlink{nuweb170b}{, 170b}\NWlink{nuweb187}{, 187}\NWlink{nuweb220a}{, 220a}\NWlink{nuweb240a}{, 240a}\NWlink{nuweb248a}{, 248a}\NWlink{nuweb309}{, 309}\NWlink{nuweb320}{, 320}\NWlink{nuweb330}{, 330}\NWlink{nuweb395b}{, 395b}\NWlink{nuweb484b}{, 484b}.\item \NWtxtIdentsUsed\nobreak\  \verb@login@\nobreak\ \NWlink{nuweb121}{121}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Load}

The {\tt load} method reads a session file from the argument file handle
in the format produced by {\tt save}.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap231}\raggedright\small
\NWtarget{nuweb152a}{} \verb@"HDiet/session.pm"@\nobreak\ {\footnotesize {152a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub load {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($infile) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $s = in($infile);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($s != FILE_VERSION) {@\\
\mbox{}\verb@            die("session::load: Incompatible file version $s");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $self->{login_name} = in($infile);@\\
\mbox{}\verb@        $self->{session_id} = in($infile);@\\
\mbox{}\verb@        $self->{login_time} = in($infile);@\\
\mbox{}\verb@        $self->{effective_name} = in($infile);@\\
\mbox{}\verb@        $self->{browse_name} = in($infile);@\\
\mbox{}\verb@        $self->{read_only} = in($infile);@\\
\mbox{}\verb@        $self->{handheld} = in($infile, 0);@\\
\mbox{}\verb@        $self->{cookie} = in($infile, 0);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Read line from persistent object file}\nobreak\ ({\footnotesize 152b\label{scrap232}
 }\mbox{}\verb@session@ ) {\footnotesize \NWlink{nuweb413b}{413b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb148}{148}\NWlink{nuweb149}{, 149}\NWlink{nuweb150}{, 150}\NWlink{nuweb151}{, 151}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb152c}{c}\NWlink{nuweb153a}{, 153a}\NWlink{nuweb153b}{b}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Save Active Session}

The {\tt save\_active\_session} method writes the active session file,
stored in the user directory, which provides a link to the currently
open session for the user.  The file simply contains a version number
(same as the session file) and the session ID.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap233}\raggedright\small
\NWtarget{nuweb152c}{} \verb@"HDiet/session.pm"@\nobreak\ {\footnotesize {152c}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub save_active_session {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($outfile) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   File format version number@\\
\mbox{}\verb@        print($outfile "$self->{version}\n");@\\
\mbox{}\verb@        #   Session ID@\\
\mbox{}\verb@        print($outfile "$self->{session_id}\n");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb148}{148}\NWlink{nuweb149}{, 149}\NWlink{nuweb150}{, 150}\NWlink{nuweb151}{, 151}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb152c}{c}\NWlink{nuweb153a}{, 153a}\NWlink{nuweb153b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@save_active_session@\nobreak\ \NWlink{nuweb187}{187}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Load Active Session}

The {\tt load\_active\_session} method reads an active session file
from the argument file handle in the format produced by {\tt
save\_active\_session}.  The session ID is returned, or the null
string in case of error.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap234}\raggedright\small
\NWtarget{nuweb153a}{} \verb@"HDiet/session.pm"@\nobreak\ {\footnotesize {153a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub load_active_session {@\\
\mbox{}\verb@        my ($infile) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $s = in($infile);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($s != FILE_VERSION) {@\\
\mbox{}\verb@            die("session::load_active_session: Incompatible file version $s");@\\
\mbox{}\verb@            return '';@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return in($infile);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb148}{148}\NWlink{nuweb149}{, 149}\NWlink{nuweb150}{, 150}\NWlink{nuweb151}{, 151}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb152c}{c}\NWlink{nuweb153a}{, 153a}\NWlink{nuweb153b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@load_active_session@\nobreak\ \NWlink{nuweb148}{148}\NWlink{nuweb186c}{, 186c}\NWlink{nuweb400}{, 400}.\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{GenerateSessionID}

The {\tt generateSessionID} function generates a pseudorandom session
ID by hashing the login name and a pseudorandom sequence into a SHA1
hexadecimal signature.  The session name is a unique ``handle'' used
to identify the session in documents sent back and forth to the user
as the session progresses.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap235}\raggedright\small
\NWtarget{nuweb153b}{} \verb@"HDiet/session.pm"@\nobreak\ {\footnotesize {153b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub generateSessionID {@\\
\mbox{}\verb@        my ($login) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $login = encode_utf8($login);@\\
\mbox{}\verb@        for (my $i = 0; $i < 16; $i++) {@\\
\mbox{}\verb@            $login .= chr(int(rand(256)));@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        my $si = sha1_hex($login);@\\
\mbox{}\verb@        $si =~ tr/a-f/FGJKQW/;@\\
\mbox{}\verb@        return $si;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb148}{148}\NWlink{nuweb149}{, 149}\NWlink{nuweb150}{, 150}\NWlink{nuweb151}{, 151}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb152c}{c}\NWlink{nuweb153a}{, 153a}\NWlink{nuweb153b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@generateSessionID@\nobreak\ \NWlink{nuweb149}{149}.\item \NWtxtIdentsUsed\nobreak\  \verb@login@\nobreak\ \NWlink{nuweb121}{121}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

%                    _    _
%     ___ ___   ___ | | _(_) ___
%    / __/ _ \ / _ \| |/ / |/ _ \
%   | (_| (_) | (_) |   <| |  __/
%    \___\___/ \___/|_|\_\_|\___|

\clearpage
\vbox{
\chapter{{\tt cookie.pm}: Cookie Object} \label{cookie.pm}

The {\tt cookie} object represents a ``cookie''---a token stored in
the user's browser which allows automatic login to a designated
account without a password.
}

\vbox{
\section{Package plumbing}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap236}\raggedright\small
\NWtarget{nuweb154}{} \verb@"HDiet/cookie.pm"@\nobreak\ {\footnotesize {154}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@#! @\hbox{$\langle\,${\itshape Perl directory}\nobreak\ {\footnotesize \NWlink{nuweb8d}{8d}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Perl language modes}\nobreak\ {\footnotesize \NWlink{nuweb387b}{387b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    package HDiet::cookie;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use Encode qw(encode_utf8);@\\
\mbox{}\verb@    use Digest::SHA1  qw(sha1_hex);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use HDiet::Cluster;@\\
\mbox{}\verb@    use HDiet::Julian;@\\
\mbox{}\verb@    use HDiet::Digest::Crc32;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    require Exporter;@\\
\mbox{}\verb@    our @{\tt @}\verb@ISA = qw(Exporter);@\\
\mbox{}\verb@    our @{\tt @}\verb@EXPORT = qw( checkCookieSignature storeCookie testCookiePresent );@\\
\mbox{}\verb@    1;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use constant FILE_VERSION => 1;@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb154}{154}\NWlink{nuweb155}{, 155}\NWlink{nuweb156a}{, 156a}\NWlink{nuweb156b}{b}\NWlink{nuweb157a}{, 157a}\NWlink{nuweb157c}{c}\NWlink{nuweb158a}{, 158a}\NWlink{nuweb158b}{b}\NWlink{nuweb159}{, 159}\NWlink{nuweb160}{, 160}\NWlink{nuweb161}{, 161}\NWlink{nuweb162}{, 162}.
\item \NWtxtIdentsUsed\nobreak\  \verb@checkCookieSignature@\nobreak\ \NWlink{nuweb161}{161}, \verb@Julian@\nobreak\ \NWlink{nuweb445}{445}, \verb@storeCookie@\nobreak\ \NWlink{nuweb159}{159}, \verb@testCookiePresent@\nobreak\ \NWlink{nuweb160}{160}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Constructor}

A new {\tt cookie} object is created by calling the
{\tt new} constructor.  The constructor has three optional
arguments: the user login name, the \UNIX/ date and
time of the login, and the date and time the cookie
will expire.  If omitted, the user name is set to blank,
the login time is set to the current time, and the
expiration is set to that time plus the default cookie
retention time.

\begin{center}
\begin{tabular}{|l|l|}
\hline
login\_name                 &   User login name \\
login\_time                 &   Date and time of login (cookie creation) \\
expiry\_time                &   Date and time cookie expires \\
cookie\_id                  &   Cookie ID \\
\hline
\end{tabular}
\end{center}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap237}\raggedright\small
\NWtarget{nuweb155}{} \verb@"HDiet/cookie.pm"@\nobreak\ {\footnotesize {155}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub new {@\\
\mbox{}\verb@        my $self = {};@\\
\mbox{}\verb@        my ($invocant, $login_name, $login_time, $expiry_time) = @{\tt @}\verb@_;@\\
\mbox{}\verb@        my $class = ref($invocant) || $invocant;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $login_name = '' if !defined($login_name);@\\
\mbox{}\verb@        $login_time = time() if !defined($login_time);@\\
\mbox{}\verb@        $expiry_time = $login_time + @\hbox{$\langle\,${\itshape Default cookie retention time}\nobreak\ {\footnotesize \NWlink{nuweb12e}{12e}}$\,\rangle$}\verb@ if !defined($expiry_time);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        bless($self, $class);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $self->{version} = FILE_VERSION;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   Initialise instance variables@\\
\mbox{}\verb@        $self->{login_name} = $login_name;@\\
\mbox{}\verb@        if ($login_name ne '') {@\\
\mbox{}\verb@            $self->{cookie_id} = generateCookieID($login_name);@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $self->{cookie_id} = '';@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $self->{login_time} = $login_time;@\\
\mbox{}\verb@        $self->{expiry_time} = $expiry_time;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $self;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb154}{154}\NWlink{nuweb155}{, 155}\NWlink{nuweb156a}{, 156a}\NWlink{nuweb156b}{b}\NWlink{nuweb157a}{, 157a}\NWlink{nuweb157c}{c}\NWlink{nuweb158a}{, 158a}\NWlink{nuweb158b}{b}\NWlink{nuweb159}{, 159}\NWlink{nuweb160}{, 160}\NWlink{nuweb161}{, 161}\NWlink{nuweb162}{, 162}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generateCookieID@\nobreak\ \NWlink{nuweb162}{162}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Describe}

The {\tt describe} method prints a primate-readable description
of the cookie on the file handle (default {\tt STDOUT})
given by the argument.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap238}\raggedright\small
\NWtarget{nuweb156a}{} \verb@"HDiet/cookie.pm"@\nobreak\ {\footnotesize {156a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub describe {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($outfile) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (!(defined $outfile)) {@\\
\mbox{}\verb@            $outfile = \*STDOUT;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print($outfile "COOKIE Version: $self->{version}\n");@\\
\mbox{}\verb@        print($outfile "  User name:      '$self->{login_name}'\n");@\\
\mbox{}\verb@        print($outfile "  Cookie  ID:     '$self->{cookie_id}'\n");@\\
\mbox{}\verb@        print($outfile "  Creation time:   " . localtime($self->{login_time}) . "\n");@\\
\mbox{}\verb@        print($outfile "  Expiration time: " . localtime($self->{expiry_time}) . "\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb154}{154}\NWlink{nuweb155}{, 155}\NWlink{nuweb156a}{, 156a}\NWlink{nuweb156b}{b}\NWlink{nuweb157a}{, 157a}\NWlink{nuweb157c}{c}\NWlink{nuweb158a}{, 158a}\NWlink{nuweb158b}{b}\NWlink{nuweb159}{, 159}\NWlink{nuweb160}{, 160}\NWlink{nuweb161}{, 161}\NWlink{nuweb162}{, 162}.
\item \NWtxtIdentsDefed\nobreak\  \verb@describe@\nobreak\ \NWlink{nuweb27}{27}\NWlink{nuweb105}{, 105}\NWlink{nuweb122}{, 122}\NWlink{nuweb150}{, 150}\NWlink{nuweb170a}{, 170a}\NWlink{nuweb218}{, 218}\NWlink{nuweb316}{, 316}\NWlink{nuweb461}{, 461}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Save}

The {\tt save} method writes the cookie item to the already-open file handle
passed as the argument.
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap239}\raggedright\small
\NWtarget{nuweb156b}{} \verb@"HDiet/cookie.pm"@\nobreak\ {\footnotesize {156b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub save {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($outfile) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   File format version number@\\
\mbox{}\verb@        print($outfile "$self->{version}\n");@\\
\mbox{}\verb@        #   Login name@\\
\mbox{}\verb@        print($outfile "$self->{login_name}\n");@\\
\mbox{}\verb@        #   Cookie ID@\\
\mbox{}\verb@        print($outfile "$self->{cookie_id}\n");@\\
\mbox{}\verb@        #   Creation time@\\
\mbox{}\verb@        print($outfile "$self->{login_time}\n");@\\
\mbox{}\verb@        #   Expiration time@\\
\mbox{}\verb@        print($outfile "$self->{expiry_time}\n");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb154}{154}\NWlink{nuweb155}{, 155}\NWlink{nuweb156a}{, 156a}\NWlink{nuweb156b}{b}\NWlink{nuweb157a}{, 157a}\NWlink{nuweb157c}{c}\NWlink{nuweb158a}{, 158a}\NWlink{nuweb158b}{b}\NWlink{nuweb159}{, 159}\NWlink{nuweb160}{, 160}\NWlink{nuweb161}{, 161}\NWlink{nuweb162}{, 162}.
\item \NWtxtIdentsDefed\nobreak\  \verb@save@\nobreak\ \NWlink{nuweb31}{31}\NWlink{nuweb113a}{, 113a}\NWlink{nuweb123}{, 123}\NWlink{nuweb151}{, 151}\NWlink{nuweb159}{, 159}\NWlink{nuweb167}{, 167}\NWlink{nuweb170b}{, 170b}\NWlink{nuweb187}{, 187}\NWlink{nuweb220a}{, 220a}\NWlink{nuweb240a}{, 240a}\NWlink{nuweb248a}{, 248a}\NWlink{nuweb309}{, 309}\NWlink{nuweb320}{, 320}\NWlink{nuweb330}{, 330}\NWlink{nuweb395b}{, 395b}\NWlink{nuweb484b}{, 484b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Load}

The {\tt load} method reads a cookie file from the argument file handle
in the format produced by {\tt save}.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap240}\raggedright\small
\NWtarget{nuweb157a}{} \verb@"HDiet/cookie.pm"@\nobreak\ {\footnotesize {157a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub load {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($infile) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $s = in($infile);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($s != FILE_VERSION) {@\\
\mbox{}\verb@            die("cookie::load: Incompatible file version $s");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $self->{login_name} = in($infile);@\\
\mbox{}\verb@        $self->{cookie_id} = in($infile);@\\
\mbox{}\verb@        $self->{login_time} = in($infile);@\\
\mbox{}\verb@        $self->{expiry_time} = in($infile);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Read line from persistent object file}\nobreak\ ({\footnotesize 157b\label{scrap241}
 }\mbox{}\verb@cookie@ ) {\footnotesize \NWlink{nuweb413b}{413b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb154}{154}\NWlink{nuweb155}{, 155}\NWlink{nuweb156a}{, 156a}\NWlink{nuweb156b}{b}\NWlink{nuweb157a}{, 157a}\NWlink{nuweb157c}{c}\NWlink{nuweb158a}{, 158a}\NWlink{nuweb158b}{b}\NWlink{nuweb159}{, 159}\NWlink{nuweb160}{, 160}\NWlink{nuweb161}{, 161}\NWlink{nuweb162}{, 162}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{signCookie}

The {\tt signCookie} method returns the cookie ID with a
salted CRC-32 signature appended, encoded as the hexadecimal
cookie ID is.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap242}\raggedright\small
\NWtarget{nuweb157c}{} \verb@"HDiet/cookie.pm"@\nobreak\ {\footnotesize {157c}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub signCookie {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $crc = new HDiet::Digest::Crc32();@\\
\mbox{}\verb@        my $cookSig = sprintf("%08x", $crc->strcrc32(@\hbox{$\langle\,${\itshape Confirmation signature encoding suffix}\nobreak\ {\footnotesize \NWlink{nuweb4d}{4d}}$\,\rangle$}\verb@ .@\\
\mbox{}\verb@            $self->{cookie_id}));@\\
\mbox{}\verb@        $cookSig =~ tr/a-f/FGJKQW/;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return substr($self->{cookie_id}, 0, 23) . $cookSig . substr($self->{cookie_id}, 23);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb154}{154}\NWlink{nuweb155}{, 155}\NWlink{nuweb156a}{, 156a}\NWlink{nuweb156b}{b}\NWlink{nuweb157a}{, 157a}\NWlink{nuweb157c}{c}\NWlink{nuweb158a}{, 158a}\NWlink{nuweb158b}{b}\NWlink{nuweb159}{, 159}\NWlink{nuweb160}{, 160}\NWlink{nuweb161}{, 161}\NWlink{nuweb162}{, 162}.
\item \NWtxtIdentsDefed\nobreak\  \verb@signCookie@\nobreak\ \NWlink{nuweb158a}{158a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{generateCookie}

The {\tt generateCookie} method returns the HTTP cookie definition
as used in the ``{\tt Set-Cookie}'' header item.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap243}\raggedright\small
\NWtarget{nuweb158a}{} \verb@"HDiet/cookie.pm"@\nobreak\ {\footnotesize {158a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub generateCookie {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($name) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return "$name=" . $self->signCookie() . "; " .@\\
\mbox{}\verb@               "Domain=@\hbox{$\langle\,${\itshape Domain for cookies}\nobreak\ {\footnotesize \NWlink{nuweb13a}{13a}}$\,\rangle$}\verb@; " .@\\
\mbox{}\verb@               "Path=@\hbox{$\langle\,${\itshape Path for cookies}\nobreak\ {\footnotesize \NWlink{nuweb13b}{13b}}$\,\rangle$}\verb@; " .@\\
\mbox{}\verb@               "Expires=" .@\\
\mbox{}\verb@                jd_to_old_cookie_date(unix_time_to_jd($self->{expiry_time}));@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb154}{154}\NWlink{nuweb155}{, 155}\NWlink{nuweb156a}{, 156a}\NWlink{nuweb156b}{b}\NWlink{nuweb157a}{, 157a}\NWlink{nuweb157c}{c}\NWlink{nuweb158a}{, 158a}\NWlink{nuweb158b}{b}\NWlink{nuweb159}{, 159}\NWlink{nuweb160}{, 160}\NWlink{nuweb161}{, 161}\NWlink{nuweb162}{, 162}.
\item \NWtxtIdentsDefed\nobreak\  \verb@generateCookie@\nobreak\ \NWlink{nuweb159}{159}.\item \NWtxtIdentsUsed\nobreak\  \verb@jd_to_old_cookie_date@\nobreak\ \NWlink{nuweb453}{453}, \verb@signCookie@\nobreak\ \NWlink{nuweb157c}{157c}, \verb@unix_time_to_jd@\nobreak\ \NWlink{nuweb450b}{450b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{expireCookie}

The {\tt expireCookie} method returns an HTTP cookie definition
which marks the cookie as expired.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap244}\raggedright\small
\NWtarget{nuweb158b}{} \verb@"HDiet/cookie.pm"@\nobreak\ {\footnotesize {158b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub expireCookie {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($name) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return "$name=EXPIRED; " .@\\
\mbox{}\verb@               "Domain=@\hbox{$\langle\,${\itshape Domain for cookies}\nobreak\ {\footnotesize \NWlink{nuweb13a}{13a}}$\,\rangle$}\verb@; " .@\\
\mbox{}\verb@               "Path=@\hbox{$\langle\,${\itshape Path for cookies}\nobreak\ {\footnotesize \NWlink{nuweb13b}{13b}}$\,\rangle$}\verb@; " .@\\
\mbox{}\verb@               "Expires=" .@\\
\mbox{}\verb@                jd_to_old_cookie_date(gregorian_to_jd(1990, 1, 1));@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb154}{154}\NWlink{nuweb155}{, 155}\NWlink{nuweb156a}{, 156a}\NWlink{nuweb156b}{b}\NWlink{nuweb157a}{, 157a}\NWlink{nuweb157c}{c}\NWlink{nuweb158a}{, 158a}\NWlink{nuweb158b}{b}\NWlink{nuweb159}{, 159}\NWlink{nuweb160}{, 160}\NWlink{nuweb161}{, 161}\NWlink{nuweb162}{, 162}.
\item \NWtxtIdentsDefed\nobreak\  \verb@expireCookie@\nobreak\ \NWlink{nuweb189}{189}.\item \NWtxtIdentsUsed\nobreak\  \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}, \verb@jd_to_old_cookie_date@\nobreak\ \NWlink{nuweb453}{453}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}


\vbox{
\section{storeCookie}

The {\tt storeCookie} function is called with the {\tt user} object
for which the cookie is being created.  It creates a cookie with the
default expiration time, saves it in the ``Remember me'' directory,
and returns the body of the cookie to be included in the HTTP
header.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap245}\raggedright\small
\NWtarget{nuweb159}{} \verb@"HDiet/cookie.pm"@\nobreak\ {\footnotesize {159}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub storeCookie {@\\
\mbox{}\verb@        my ($ui) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $cook = HDiet::cookie->new($ui->{login_name}, time());@\\
\mbox{}\verb@         open(CO, ">:utf8", "@\hbox{$\langle\,${\itshape Remember Me Directory}\nobreak\ {\footnotesize \NWlink{nuweb13d}{13d}}$\,\rangle$}\verb@/$cook->{cookie_id}.hdr") ||@\\
\mbox{}\verb@            die("Cannot create persistent login file @\hbox{$\langle\,${\itshape Remember Me Directory}\nobreak\ {\footnotesize \NWlink{nuweb13d}{13d}}$\,\rangle$}\verb@/$cook->{cookie_id}.hdr");@\\
\mbox{}\verb@        $cook->save(\*CO);@\\
\mbox{}\verb@        close(CO);@\\
\mbox{}\verb@        clusterCopy("@\hbox{$\langle\,${\itshape Remember Me Directory}\nobreak\ {\footnotesize \NWlink{nuweb13d}{13d}}$\,\rangle$}\verb@/$cook->{cookie_id}.hdr");@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $cook->generateCookie(@\hbox{$\langle\,${\itshape Cookie name}\nobreak\ {\footnotesize \NWlink{nuweb12d}{12d}}$\,\rangle$}\verb@);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb154}{154}\NWlink{nuweb155}{, 155}\NWlink{nuweb156a}{, 156a}\NWlink{nuweb156b}{b}\NWlink{nuweb157a}{, 157a}\NWlink{nuweb157c}{c}\NWlink{nuweb158a}{, 158a}\NWlink{nuweb158b}{b}\NWlink{nuweb159}{, 159}\NWlink{nuweb160}{, 160}\NWlink{nuweb161}{, 161}\NWlink{nuweb162}{, 162}.
\item \NWtxtIdentsDefed\nobreak\  \verb@storeCookie@\nobreak\ \NWlink{nuweb154}{154}\NWlink{nuweb189}{, 189}.\item \NWtxtIdentsUsed\nobreak\  \verb@generateCookie@\nobreak\ \NWlink{nuweb158a}{158a}, \verb@login@\nobreak\ \NWlink{nuweb121}{121}, \verb@save@\nobreak\ \NWlink{nuweb31}{31}\NWlink{nuweb123}{, 123}\NWlink{nuweb151}{, 151}\NWlink{nuweb156b}{, 156b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{testCookiePresent}

The {\tt testCookiePresent} function checks the environment for the
presence of a cookie with the name given by the argument.  If
present (and not expired), the signature is checked and, if
valid, the cookie is looked up in the ``{\tt RememberMe}'' directory.
If the cookie is found in the directory, it is loaded
into memory and the expiration time checked.  If the cookie
has not expired, it is deleted from the directory and
and the user name returned to proceed with the login.
If the cookie is absent, invalid, or expired, {\tt undef} is returned.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap246}\raggedright\small
\NWtarget{nuweb160}{} \verb@"HDiet/cookie.pm"@\nobreak\ {\footnotesize {160}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub testCookiePresent {@\\
\mbox{}\verb@        my ($name) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $cuser;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (defined($ENV{HTTP_COOKIE}) &&@\\
\mbox{}\verb@            ($ENV{HTTP_COOKIE} =~ m/$name=([0-9FGJKQW]{48})/)) {@\\
\mbox{}\verb@            my $csig = $1;@\\
\mbox{}\verb@            my $cid = checkCookieSignature($csig);@\\
\mbox{}\verb@            if (defined($cid)) {@\\
\mbox{}\verb@                if (-f "@\hbox{$\langle\,${\itshape Remember Me Directory}\nobreak\ {\footnotesize \NWlink{nuweb13d}{13d}}$\,\rangle$}\verb@/$cid.hdr") {@\\
\mbox{}\verb@                    if (open(CI, "<:utf8", "@\hbox{$\langle\,${\itshape Remember Me Directory}\nobreak\ {\footnotesize \NWlink{nuweb13d}{13d}}$\,\rangle$}\verb@/$cid.hdr")) {@\\
\mbox{}\verb@                        my $cook = HDiet::cookie->new();@\\
\mbox{}\verb@                        $cook->load(\*CI);@\\
\mbox{}\verb@                        close(CI);@\\
\mbox{}\verb@                        if (($cook->{cookie_id} eq $cid) &&@\\
\mbox{}\verb@                            ($cook->{expiry_time} >= time())) {@\\
\mbox{}\verb@                            $cuser = $cook->{login_name};@\\
\mbox{}\verb@                        }@\\
\mbox{}\verb@                    }@\\
\mbox{}\verb@                    unlink("@\hbox{$\langle\,${\itshape Remember Me Directory}\nobreak\ {\footnotesize \NWlink{nuweb13d}{13d}}$\,\rangle$}\verb@/$cid.hdr");@\\
\mbox{}\verb@                    clusterDelete("@\hbox{$\langle\,${\itshape Remember Me Directory}\nobreak\ {\footnotesize \NWlink{nuweb13d}{13d}}$\,\rangle$}\verb@/$cid.hdr");@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return $cuser;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb154}{154}\NWlink{nuweb155}{, 155}\NWlink{nuweb156a}{, 156a}\NWlink{nuweb156b}{b}\NWlink{nuweb157a}{, 157a}\NWlink{nuweb157c}{c}\NWlink{nuweb158a}{, 158a}\NWlink{nuweb158b}{b}\NWlink{nuweb159}{, 159}\NWlink{nuweb160}{, 160}\NWlink{nuweb161}{, 161}\NWlink{nuweb162}{, 162}.
\item \NWtxtIdentsDefed\nobreak\  \verb@testCookiePresent@\nobreak\ \NWlink{nuweb154}{154}\NWlink{nuweb182}{, 182}\NWlink{nuweb189}{, 189}.\item \NWtxtIdentsUsed\nobreak\  \verb@checkCookieSignature@\nobreak\ \NWlink{nuweb161}{161}, \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{checkCookieSignature}

The {\tt checkCookieSignature} function is called with the opaque
signed cookie received from a client.  We validate the signature
and, if valid, return the cookie ID.  If the syntax of the signed
cookie is invalid or the signature fails to validate, {\tt undef}
is returned.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap247}\raggedright\small
\NWtarget{nuweb161}{} \verb@"HDiet/cookie.pm"@\nobreak\ {\footnotesize {161}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub checkCookieSignature {@\\
\mbox{}\verb@        my ($signedCookie) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($signedCookie !~ m/^[0-9FGJKQW]{48}$/) {@\\
\mbox{}\verb@#print("Cookie syntax bad signedCookie ($signedCookie)\n");@\\
\mbox{}\verb@            return undef;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $crc = new HDiet::Digest::Crc32();@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $cookieSig = substr($signedCookie, 23, 8, "");@\\
\mbox{}\verb@        $cookieSig =~ tr/FGJKQW/a-f/;@\\
\mbox{}\verb@        my $cookSig = sprintf("%08x", $crc->strcrc32(@\hbox{$\langle\,${\itshape Confirmation signature encoding suffix}\nobreak\ {\footnotesize \NWlink{nuweb4d}{4d}}$\,\rangle$}\verb@ .@\\
\mbox{}\verb@            $signedCookie));@\\
\mbox{}\verb@#print("cookSig ($cookSig)  cookieSig ($cookieSig)  signedCookie ($signedCookie)\n");@\\
\mbox{}\verb@        if ($cookSig eq $cookieSig) {@\\
\mbox{}\verb@            return $signedCookie;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return undef;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb154}{154}\NWlink{nuweb155}{, 155}\NWlink{nuweb156a}{, 156a}\NWlink{nuweb156b}{b}\NWlink{nuweb157a}{, 157a}\NWlink{nuweb157c}{c}\NWlink{nuweb158a}{, 158a}\NWlink{nuweb158b}{b}\NWlink{nuweb159}{, 159}\NWlink{nuweb160}{, 160}\NWlink{nuweb161}{, 161}\NWlink{nuweb162}{, 162}.
\item \NWtxtIdentsDefed\nobreak\  \verb@checkCookieSignature@\nobreak\ \NWlink{nuweb154}{154}\NWlink{nuweb160}{, 160}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{generateCookieID}

The {\tt generateCookieID} function generates a pseudorandom cookie
ID by hashing the login name and a pseudorandom sequence into a SHA1
hexadecimal signature.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap248}\raggedright\small
\NWtarget{nuweb162}{} \verb@"HDiet/cookie.pm"@\nobreak\ {\footnotesize {162}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub generateCookieID {@\\
\mbox{}\verb@        my ($login) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $login = encode_utf8($login);@\\
\mbox{}\verb@        for (my $i = 0; $i < 16; $i++) {@\\
\mbox{}\verb@            $login .= chr(int(rand(256)));@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        my $si = sha1_hex($login);@\\
\mbox{}\verb@        $si =~ tr/a-f/FGJKQW/;@\\
\mbox{}\verb@        return $si;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb154}{154}\NWlink{nuweb155}{, 155}\NWlink{nuweb156a}{, 156a}\NWlink{nuweb156b}{b}\NWlink{nuweb157a}{, 157a}\NWlink{nuweb157c}{c}\NWlink{nuweb158a}{, 158a}\NWlink{nuweb158b}{b}\NWlink{nuweb159}{, 159}\NWlink{nuweb160}{, 160}\NWlink{nuweb161}{, 161}\NWlink{nuweb162}{, 162}.
\item \NWtxtIdentsDefed\nobreak\  \verb@generateCookieID@\nobreak\ \NWlink{nuweb155}{155}.\item \NWtxtIdentsUsed\nobreak\  \verb@login@\nobreak\ \NWlink{nuweb121}{121}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

%                _
%    _ __  _   _| |__  _ __   __ _ _ __ ___   ___
%   | '_ \| | | | '_ \| '_ \ / _` | '_ ` _ \ / _ \
%   | |_) | |_| | |_) | | | | (_| | | | | | |  __/
%   | .__/ \__,_|_.__/|_| |_|\__,_|_| |_| |_|\___|
%   |_|

\clearpage
\vbox{
\chapter{{\tt pubname.pm}: Public Name Manager Object}
\label{pubname.pm}

The {\tt pubname} object provides utilities for managing
randomly assigned public names for users who wish to
disclose their logs without revealing their actual
identity.

}

\vbox{
\section{Package plumbing}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap249}\raggedright\small
\NWtarget{nuweb163}{} \verb@"HDiet/pubname.pm"@\nobreak\ {\footnotesize {163}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@#! @\hbox{$\langle\,${\itshape Perl directory}\nobreak\ {\footnotesize \NWlink{nuweb8d}{8d}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Perl language modes}\nobreak\ {\footnotesize \NWlink{nuweb387b}{387b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    package HDiet::pubname;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use Fcntl;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use HDiet::Cluster;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    require Exporter;@\\
\mbox{}\verb@    our @{\tt @}\verb@ISA = qw(Exporter);@\\
\mbox{}\verb@    our @{\tt @}\verb@EXPORT = ( );@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@nameSources = ( 'firstnames.txt', 'lastnames.txt' );@\\
\mbox{}\verb@    #   Names per nameSources entry.  Zero means use seek technique@\\
\mbox{}\verb@    my @{\tt @}\verb@nameLength = ( 24, 0 );@\\
\mbox{}\verb@@\\
\mbox{}\verb@    1;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use constant FILE_VERSION => 1;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb163}{163}\NWlink{nuweb164}{, 164}\NWlink{nuweb165}{, 165}\NWlink{nuweb166}{, 166}\NWlink{nuweb167}{, 167}\NWlink{nuweb168}{, 168}\NWlink{nuweb169a}{, 169a}\NWlink{nuweb170a}{, 170a}\NWlink{nuweb170b}{b}\NWlink{nuweb171a}{, 171a}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Constructor}

A new {\tt pubname} object is created by calling the
{\tt new} constructor.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap250}\raggedright\small
\NWtarget{nuweb164}{} \verb@"HDiet/pubname.pm"@\nobreak\ {\footnotesize {164}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub new {@\\
\mbox{}\verb@        my $self = {};@\\
\mbox{}\verb@        my ($invocant) = @{\tt @}\verb@_;@\\
\mbox{}\verb@        my $class = ref($invocant) || $invocant;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        bless($self, $class);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $self->{version} = FILE_VERSION;@\\
\mbox{}\verb@        $self->{public_name} = $self->{true_name} = '';@\\
\mbox{}\verb@        $self->{true_create_time} = $self->{public_create_time} = 0;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $self;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb163}{163}\NWlink{nuweb164}{, 164}\NWlink{nuweb165}{, 165}\NWlink{nuweb166}{, 166}\NWlink{nuweb167}{, 167}\NWlink{nuweb168}{, 168}\NWlink{nuweb169a}{, 169a}\NWlink{nuweb170a}{, 170a}\NWlink{nuweb170b}{b}\NWlink{nuweb171a}{, 171a}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Generate random name}

The {\tt generateRandomName} method returns a randomly chosen
name.  There is no guarantee that the name is not already in use;
see {\tt generateUniqueName} for a function which verifies the
name unique at the time of its creation.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap251}\raggedright\small
\NWtarget{nuweb165}{} \verb@"HDiet/pubname.pm"@\nobreak\ {\footnotesize {165}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub generateRandomName {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $name = '';@\\
\mbox{}\verb@@\\
\mbox{}\verb@        for (my $i = 0; $i <= $#nameSources; $i++) {@\\
\mbox{}\verb@            my $filename = "@\hbox{$\langle\,${\itshape Public Name Directory}\nobreak\ {\footnotesize \NWlink{nuweb7g}{7g}}$\,\rangle$}\verb@/$nameSources[$i]";@\\
\mbox{}\verb@            open(NF, "<:utf8", $filename) ||@\\
\mbox{}\verb@                die("pubname::generateUniqueName:  Cannot open $filename");@\\
\mbox{}\verb@            my $s;@\\
\mbox{}\verb@            if ($nameLength[$i] > 0) {@\\
\mbox{}\verb@                my $line = int(rand() * $nameLength[$i]) + 1;@\\
\mbox{}\verb@                while ($line-- > 0) {@\\
\mbox{}\verb@                    $s = <NF> ||@\\
\mbox{}\verb@                        die("pubname::generateUniqueName:  Unexpected EOF on $filename");@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                while (1) {@\\
\mbox{}\verb@                    seek(NF, int(rand() * (-s $filename)) - 64, 0);@\\
\mbox{}\verb@@\\
\mbox{}\verb@                    $s = <NF>;          # Burn characters to align with next line@\\
\mbox{}\verb@                    my $n = int(rand() * 7) + 1;@\\
\mbox{}\verb@                    while ($n-- > 0) {@\\
\mbox{}\verb@                        if (eof(NF)) {@\\
\mbox{}\verb@                            next;@\\
\mbox{}\verb@                        }@\\
\mbox{}\verb@                        $s = <NF>;@\\
\mbox{}\verb@                    }@\\
\mbox{}\verb@                    last;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            close(NF);@\\
\mbox{}\verb@@\\
\mbox{}\verb@            $s =~ s/\s+$//;@\\
\mbox{}\verb@            $name .= $s . ' ';@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $name =~ s/\s$//;@\\
\mbox{}\verb@        return $name;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb163}{163}\NWlink{nuweb164}{, 164}\NWlink{nuweb165}{, 165}\NWlink{nuweb166}{, 166}\NWlink{nuweb167}{, 167}\NWlink{nuweb168}{, 168}\NWlink{nuweb169a}{, 169a}\NWlink{nuweb170a}{, 170a}\NWlink{nuweb170b}{b}\NWlink{nuweb171a}{, 171a}.
\item \NWtxtIdentsDefed\nobreak\  \verb@generateRandomName@\nobreak\ \NWlink{nuweb166}{166}\NWlink{nuweb167}{, 167}.\item \NWtxtIdentsUsed\nobreak\  \verb@generateUniqueName@\nobreak\ \NWlink{nuweb166}{166}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Generate unique name}

The {\tt generateUniqueName} method returns a randomly chosen
name which is guaranteed, at the time it is returned, not to
be used as a public name.  Unless the caller has set some kind
of lock, however, there is no assurance some other process may
not grab it before you actually create such a name.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap252}\raggedright\small
\NWtarget{nuweb166}{} \verb@"HDiet/pubname.pm"@\nobreak\ {\footnotesize {166}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub generateUniqueName {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $name;@\\
\mbox{}\verb@        while (1) {@\\
\mbox{}\verb@            $name = $self->generateRandomName();@\\
\mbox{}\verb@            my $ufn = HDiet::user::quoteUserName($name);@\\
\mbox{}\verb@            if (!(-f "@\hbox{$\langle\,${\itshape Public Name Directory}\nobreak\ {\footnotesize \NWlink{nuweb7g}{7g}}$\,\rangle$}\verb@/$ufn.hdp")) {@\\
\mbox{}\verb@                last;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $name;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb163}{163}\NWlink{nuweb164}{, 164}\NWlink{nuweb165}{, 165}\NWlink{nuweb166}{, 166}\NWlink{nuweb167}{, 167}\NWlink{nuweb168}{, 168}\NWlink{nuweb169a}{, 169a}\NWlink{nuweb170a}{, 170a}\NWlink{nuweb170b}{b}\NWlink{nuweb171a}{, 171a}.
\item \NWtxtIdentsDefed\nobreak\  \verb@generateUniqueName@\nobreak\ \NWlink{nuweb165}{165}.\item \NWtxtIdentsUsed\nobreak\  \verb@generateRandomName@\nobreak\ \NWlink{nuweb165}{165}, \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Assign public name}

A public name is assigned to the user object passed as
the argument.  If the user already has a public name assigned,
it is discarded and replaced with the new one.  If no public
name was previously assigned, the date the user went public is
set to the present time; if this is an assignment of a new name
to a user who is already public, the \verb+public_since+ time
is not changed.

The public name fields in the user object are updated, but it
is the responsibility of the caller to write the user object
back to the user database.

The guarantee of uniqueness of the public name depends upon the
correct operation of the ``\verb+O_EXCL+'' flag in the {\tt sysopen}
function.  If this does not always fail for a pre-existing file (as
might be the case on cached cluster systems or tacky network file storage
architectures), then it is possible for two users to be assigned the
same public name.  While this is confusing, it will not damage the data of
either of the users.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap253}\raggedright\small
\NWtarget{nuweb167}{} \verb@"HDiet/pubname.pm"@\nobreak\ {\footnotesize {167}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub assignPublicName {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($ui) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($ui->{public}) {@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Delete existing public name}\nobreak\ {\footnotesize \NWlink{nuweb169b}{169b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($name, $pfn);@\\
\mbox{}\verb@        while (1) {@\\
\mbox{}\verb@            $name = $self->generateRandomName();@\\
\mbox{}\verb@            $pfn = HDiet::user::quoteUserName($name);@\\
\mbox{}\verb@            if (sysopen(PF, "@\hbox{$\langle\,${\itshape Public Name Directory}\nobreak\ {\footnotesize \NWlink{nuweb7g}{7g}}$\,\rangle$}\verb@/$pfn.hdp", O_CREAT | O_EXCL | O_WRONLY)) {@\\
\mbox{}\verb@                binmode(PF, ":utf8");@\\
\mbox{}\verb@                last;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (!($ui->{public})) {@\\
\mbox{}\verb@            $ui->{public} = 1;@\\
\mbox{}\verb@            $ui->{public_since} = time();@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $self->{public_name} = $ui->{public_name} = $name;@\\
\mbox{}\verb@        $self->{true_name} = $ui->{login_name};@\\
\mbox{}\verb@        $self->{true_create_time} = $ui->{account_created};@\\
\mbox{}\verb@        $self->{public_create_time} = $ui->{public_since};@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $self->save(\*PF);@\\
\mbox{}\verb@        close(PF);@\\
\mbox{}\verb@        clusterCopy("@\hbox{$\langle\,${\itshape Public Name Directory}\nobreak\ {\footnotesize \NWlink{nuweb7g}{7g}}$\,\rangle$}\verb@/$pfn.hdp");@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $name;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb163}{163}\NWlink{nuweb164}{, 164}\NWlink{nuweb165}{, 165}\NWlink{nuweb166}{, 166}\NWlink{nuweb167}{, 167}\NWlink{nuweb168}{, 168}\NWlink{nuweb169a}{, 169a}\NWlink{nuweb170a}{, 170a}\NWlink{nuweb170b}{b}\NWlink{nuweb171a}{, 171a}.
\item \NWtxtIdentsDefed\nobreak\  \verb@assignPublicName@\nobreak\ \NWlink{nuweb308}{308}.\item \NWtxtIdentsUsed\nobreak\  \verb@generateRandomName@\nobreak\ \NWlink{nuweb165}{165}, \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}, \verb@save@\nobreak\ \NWlink{nuweb31}{31}\NWlink{nuweb123}{, 123}\NWlink{nuweb151}{, 151}\NWlink{nuweb156b}{, 156b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Find public name}

The {\tt findPublicName} method is called with the public
name requested.  If such a name exists, its properties are
loaded into the object and the true name of the user is
returned to the caller.  If no such name exists {\tt undef}
is returned.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap254}\raggedright\small
\NWtarget{nuweb168}{} \verb@"HDiet/pubname.pm"@\nobreak\ {\footnotesize {168}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub findPublicName {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($pname) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   Clear out object to avoid confusion in case of no find@\\
\mbox{}\verb@        $self->{public_name} = $self->{true_name} = '';@\\
\mbox{}\verb@        $self->{true_create_time} = $self->{public_create_time} = 0;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $pfn = HDiet::user::quoteUserName($pname);@\\
\mbox{}\verb@        if (open(PF, "<:utf8", "@\hbox{$\langle\,${\itshape Public Name Directory}\nobreak\ {\footnotesize \NWlink{nuweb7g}{7g}}$\,\rangle$}\verb@/$pfn.hdp")) {@\\
\mbox{}\verb@            $self->load(\*PF);@\\
\mbox{}\verb@            close(PF);@\\
\mbox{}\verb@            return $self->{true_name};@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return undef;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb163}{163}\NWlink{nuweb164}{, 164}\NWlink{nuweb165}{, 165}\NWlink{nuweb166}{, 166}\NWlink{nuweb167}{, 167}\NWlink{nuweb168}{, 168}\NWlink{nuweb169a}{, 169a}\NWlink{nuweb170a}{, 170a}\NWlink{nuweb170b}{b}\NWlink{nuweb171a}{, 171a}.
\item \NWtxtIdentsDefed\nobreak\  \verb@findPublicName@\nobreak\ \NWlink{nuweb206}{206}\NWlink{nuweb321}{, 321}.\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}, \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Delete public name}

This method is called with the user object whose public name
is to be deleted.  If the user has no public name, the call is
ignored.  Otherwise, the public name file is deleted and the
public name flag, name string, and date assigned are cleared,
rendering the user private once again.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap255}\raggedright\small
\NWtarget{nuweb169a}{} \verb@"HDiet/pubname.pm"@\nobreak\ {\footnotesize {169a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub deletePublicName {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($ui) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($ui->{public}) {@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Delete existing public name}\nobreak\ {\footnotesize \NWlink{nuweb169b}{169b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@            $ui->{public} = 0;@\\
\mbox{}\verb@            $self->{public_name} = $ui->{public_name} = '';@\\
\mbox{}\verb@            $self->{public_create_time} = $self->{true_create_time} = $ui->{public_since} = 0;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb163}{163}\NWlink{nuweb164}{, 164}\NWlink{nuweb165}{, 165}\NWlink{nuweb166}{, 166}\NWlink{nuweb167}{, 167}\NWlink{nuweb168}{, 168}\NWlink{nuweb169a}{, 169a}\NWlink{nuweb170a}{, 170a}\NWlink{nuweb170b}{b}\NWlink{nuweb171a}{, 171a}.
\item \NWtxtIdentsDefed\nobreak\  \verb@deletePublicName@\nobreak\ \NWlink{nuweb308}{308}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Delete existing public name}

The existing public name for a user is deleted.  The public name
field is set to the null string, but the public name status and
time of creation of the public name are not changed.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap256}\raggedright\small
\NWtarget{nuweb169b}{} $\langle\,${\itshape Delete existing public name}\nobreak\ {\footnotesize {169b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $pfn = HDiet::user::quoteUserName($ui->{public_name});@\\
\mbox{}\verb@    if (!unlink("@\hbox{$\langle\,${\itshape Public Name Directory}\nobreak\ {\footnotesize \NWlink{nuweb7g}{7g}}$\,\rangle$}\verb@/$pfn.hdp")) {@\\
\mbox{}\verb@        die("Unable to delete old public name: @\hbox{$\langle\,${\itshape Public Name Directory}\nobreak\ {\footnotesize \NWlink{nuweb7g}{7g}}$\,\rangle$}\verb@/$pfn.hdp");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    clusterDelete("@\hbox{$\langle\,${\itshape Public Name Directory}\nobreak\ {\footnotesize \NWlink{nuweb7g}{7g}}$\,\rangle$}\verb@/$pfn.hdp");@\\
\mbox{}\verb@    $ui->{public_name} = '';@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb167}{167}\NWlink{nuweb169a}{, 169a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Describe}

The {\tt describe} method prints a primate-readable description
of the public name on the file handle (default {\tt STDOUT})
given by the argument.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap257}\raggedright\small
\NWtarget{nuweb170a}{} \verb@"HDiet/pubname.pm"@\nobreak\ {\footnotesize {170a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub describe {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($outfile) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (!(defined $outfile)) {@\\
\mbox{}\verb@            $outfile = \*STDOUT;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print($outfile "PUBNAME Version: $self->{version}\n");@\\
\mbox{}\verb@        print($outfile "  Public name:  '$self->{public_name}'\n");@\\
\mbox{}\verb@        print($outfile "  True name:    '$self->{true_name}'\n");@\\
\mbox{}\verb@        print($outfile "  First login:  " . localtime($self->{true_create_time}) . "\n");@\\
\mbox{}\verb@        print($outfile "  Public since: " . localtime($self->{public_create_time}) . "\n");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb163}{163}\NWlink{nuweb164}{, 164}\NWlink{nuweb165}{, 165}\NWlink{nuweb166}{, 166}\NWlink{nuweb167}{, 167}\NWlink{nuweb168}{, 168}\NWlink{nuweb169a}{, 169a}\NWlink{nuweb170a}{, 170a}\NWlink{nuweb170b}{b}\NWlink{nuweb171a}{, 171a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@describe@\nobreak\ \NWlink{nuweb27}{27}\NWlink{nuweb122}{, 122}\NWlink{nuweb150}{, 150}\NWlink{nuweb156a}{, 156a}, \verb@login@\nobreak\ \NWlink{nuweb121}{121}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Save}

The {\tt save} method writes the public name item to the already-open file handle
passed as the argument.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap258}\raggedright\small
\NWtarget{nuweb170b}{} \verb@"HDiet/pubname.pm"@\nobreak\ {\footnotesize {170b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub save {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($outfile) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $outfile <<"EOD";@\\
\mbox{}\verb@$self->{version}@\\
\mbox{}\verb@$self->{public_name}@\\
\mbox{}\verb@$self->{true_name}@\\
\mbox{}\verb@$self->{true_create_time}@\\
\mbox{}\verb@$self->{public_create_time}@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb163}{163}\NWlink{nuweb164}{, 164}\NWlink{nuweb165}{, 165}\NWlink{nuweb166}{, 166}\NWlink{nuweb167}{, 167}\NWlink{nuweb168}{, 168}\NWlink{nuweb169a}{, 169a}\NWlink{nuweb170a}{, 170a}\NWlink{nuweb170b}{b}\NWlink{nuweb171a}{, 171a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@save@\nobreak\ \NWlink{nuweb31}{31}\NWlink{nuweb123}{, 123}\NWlink{nuweb151}{, 151}\NWlink{nuweb156b}{, 156b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Load}

The {\tt load} method reads a public name file from the argument file handle
in the format produced by {\tt save}.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap259}\raggedright\small
\NWtarget{nuweb171a}{} \verb@"HDiet/pubname.pm"@\nobreak\ {\footnotesize {171a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub load {@\\
\mbox{}\verb@        my $self = shift;@\\
\mbox{}\verb@        my ($infile) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $s = in($infile);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($s != FILE_VERSION) {@\\
\mbox{}\verb@            die("user::load: Incompatible file version $s");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $self->{public_name} = in($infile);@\\
\mbox{}\verb@        $self->{true_name} = in($infile);@\\
\mbox{}\verb@        $self->{true_create_time} = in($infile);@\\
\mbox{}\verb@        $self->{public_create_time} = in($infile);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Read line from persistent object file}\nobreak\ ({\footnotesize 171b\label{scrap260}
 }\mbox{}\verb@pubname@ ) {\footnotesize \NWlink{nuweb413b}{413b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb163}{163}\NWlink{nuweb164}{, 164}\NWlink{nuweb165}{, 165}\NWlink{nuweb166}{, 166}\NWlink{nuweb167}{, 167}\NWlink{nuweb168}{, 168}\NWlink{nuweb169a}{, 169a}\NWlink{nuweb170a}{, 170a}\NWlink{nuweb170b}{b}\NWlink{nuweb171a}{, 171a}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

%    __  __       _         ____
%   |  \/  | __ _(_)_ __   |  _ \ _ __ ___   __ _ _ __ __ _ _ __ ___
%   | |\/| |/ _` | | '_ \  | |_) | '__/ _ \ / _` | '__/ _` | '_ ` _ \
%   | |  | | (_| | | | | | |  __/| | | (_) | (_| | | | (_| | | | | | |
%   |_|  |_|\__,_|_|_| |_| |_|   |_|  \___/ \__, |_|  \__,_|_| |_| |_|
%                                           |___/

\clearpage
\vbox{
\chapter{{\tt HackDiet.pl}: Main CGI Application}

{\tt HackDiet.pl} is the main CGI application program.  It is invoked
when one of its request forms is submitted by a user. Apart from the
modules defined elsewhere in this document, the libraries included in
the distribution, and the required Perl library modules, it is
entirely self-contained.

}

\vbox{
\section{Main program}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap261}\raggedright\small
\NWtarget{nuweb173}{} \verb@"HackDiet.pl"@\nobreak\ {\footnotesize {173}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@#! @\hbox{$\langle\,${\itshape Perl directory}\nobreak\ {\footnotesize \NWlink{nuweb8d}{8d}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Documentation in POD format}\nobreak\ {\footnotesize \NWlink{nuweb455}{455}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Global declarations}\nobreak\ {\footnotesize \NWlink{nuweb387a}{387a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Set handler for termination signals}\nobreak\ {\footnotesize \NWlink{nuweb174a}{174a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   Override site address in otherwise relative URLs@\\
\mbox{}\verb@    my $homeBase = "@\hbox{$\langle\,${\itshape Web Document Home}\nobreak\ {\footnotesize \NWlink{nuweb5d}{5d}}$\,\rangle$}\verb@";@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $dataBase = "@\hbox{$\langle\,${\itshape Database Directory}\nobreak\ {\footnotesize \NWlink{nuweb7d}{7d}}$\,\rangle$}\verb@";@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Process command line options}\nobreak\ {\footnotesize \NWlink{nuweb389a}{389a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Validate option specifications}\nobreak\ {\footnotesize \NWlink{nuweb389b}{389b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($#ARGV != -1) {@\\
\mbox{}\verb@        &print_command_line_help;@\\
\mbox{}\verb@        exit(0);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    binmode(STDIN, ":utf8");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $fh = \*STDOUT;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my %CGIargs = &parse_cgi_arguments;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $inHTML = 0;@\\
\mbox{}\verb@    my $readOnly = 0;@\\
\mbox{}\verb@    my $cookieLogin = 0;@\\
\mbox{}\verb@    my $cookieUser;@\\
\mbox{}\verb@    our @{\tt @}\verb@HTTP_header;@\\
\mbox{}\verb@    our @{\tt @}\verb@headerScripts;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Define requests permissible whilst browsing public account}\nobreak\ {\footnotesize \NWlink{nuweb174b}{174b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Extract brain-dead Internet Exploder request field}\nobreak\ {\footnotesize \NWlink{nuweb176}{176}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Estimate local time at user site}\nobreak\ {\footnotesize \NWlink{nuweb177}{177}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Dispatch requests which return non-HTML results}\nobreak\ {\footnotesize \NWlink{nuweb178}{178}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@requeue:@\\
\mbox{}\verb@    binmode(STDOUT, ":utf8");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   Emit Content-type if we were invoked as a CGI program@\\
\mbox{}\verb@    if ($ENV{'REQUEST_METHOD'}) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape MIME Content-type specification}\nobreak\ {\footnotesize \NWlink{nuweb390a}{390a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $inHTML = 1;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    while (1) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Dispatch requests which return HTML result documents}\nobreak\ {\footnotesize \NWlink{nuweb179}{179}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        exit(0);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Utility functions}\nobreak\ {\footnotesize \NWlink{nuweb391}{391}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@parse_cgi_arguments@\nobreak\ \NWlink{nuweb412}{412}, \verb@print_command_line_help@\nobreak\ \NWlink{nuweb404}{404}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Set handler for termination signals}

To allow debugging of CPU loop and other ``hung program''
conditions which lead to CGI timeouts and 500 errors, we
catch the {\tt INT} signal, which can be sent to a CGI process
observed to be hung.  Upon receiving the signal, we print a
stack trace to {\tt STDERR}, which will be placed in the
HTTP server's error log and then terminate.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap262}\raggedright\small
\NWtarget{nuweb174a}{} $\langle\,${\itshape Set handler for termination signals}\nobreak\ {\footnotesize {174a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    $SIG{INT} =@\\
\mbox{}\verb@        sub {@\\
\mbox{}\verb@            my $i = 0;@\\
\mbox{}\verb@            my ($pkg, $file, $line);@\\
\mbox{}\verb@            print(STDERR "Termination by INT signal.  Stack trace:\n");@\\
\mbox{}\verb@            while (($pkg, $file, $line) = caller($i)) {@\\
\mbox{}\verb@                print(STDERR "    $i:  Package $pkg  File $file  Line $line\n");@\\
\mbox{}\verb@                $i++;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            die("INT received");@\\
\mbox{}\verb@        };@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb173}{173}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Define requests permissible whilst browsing public account}

Users browsing public accounts are permitted access only to the
strictly limited subset of transactions explicitly enumerated below.
A browsing user should never see a link which leads to a transaction
not on this list, but if a malicious user should cobble up a URL
specifying one, it will be thwarted when it is discovered that the
user is browsing and the request is not listed in the following hash.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap263}\raggedright\small
\NWtarget{nuweb174b}{} $\langle\,${\itshape Define requests permissible whilst browsing public account}\nobreak\ {\footnotesize {174b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my %browsing_user_requests = (@\\
\mbox{}\verb@        account => 1,@\\
\mbox{}\verb@        browsepub => 1,@\\
\mbox{}\verb@        calendar => 1,@\\
\mbox{}\verb@        chart => 1,@\\
\mbox{}\verb@        dietcalc => 1,@\\
\mbox{}\verb@        do_public_browseacct => 1,@\\
\mbox{}\verb@        histchart => 1,@\\
\mbox{}\verb@        histreq => 1,@\\
\mbox{}\verb@        log => 1,@\\
\mbox{}\verb@        logout => 1,@\\
\mbox{}\verb@        quitbrowse => 1,@\\
\mbox{}\verb@        trendan => 1@\\
\mbox{}\verb@    );@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb173}{173}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Extract brain-dead Internet Exploder request field}

Microsoft's lame attempt at a Web browser, ``Internet Exploder'', seems
to take every possible opportunity to misinterpret and mal-implement
even the simplest of Web standards.  Consider the humble ``\verb+<button>+''
tag, introduced in HTML 4.0 and part of the current HTML 4.01 and XHTML
1.0 standards.  Unlike the original ``\verb+<input type="submit">+''
button, in which both the label of the button and the text submitted
with the form when it is clicked are identical (and hence the button's
label cannot contain HTML mark-up or style specifications---just
the plain text permissible in an attribute value), the
``\verb+<button>+'' control decoupled these; the value submitted
with the form remains specified by the {\tt value=} attribute, but
the label on the button is given by the content of the tag, for
example:

\begin{verbatim}
    <button type="submit" name="action" value="detonate">
    <b>Ka-<em>BOOM!</em></b>
    </button>
\end{verbatim}
}

Even Web designers uninterested in fancy text in buttons find the
``\verb+<button>+'' tag attractive, because it provides a simple
way to include multiple buttons in a single form which send
different codes when pressed, independent of their labels.  A
common example is a form which lists a number of items as
rows in a table and, for each item, includes action buttons
which operate upon it, for example ``Edit'' and ``Delete''.  The
buttons in each row have the same label, but are distinguished by
their {\tt value} fields, for example:

\begin{verbatim}
    <button type="submit" name="edit" value="row12">Edit</button>
    <button type="submit" name="delete" value="row12">Delete</button>
\end{verbatim}

When one of these buttons is clicked, it informs the application
of both the operation requested and the row of the table operated
upon.  The ``\verb+<button>+'' tag is useful in any situation where
you wish to send different text to the server than is displayed as
the label on the button, which is why the keepers of the HTML standard
incorporated it back in 1998.

Well, it {\em would} be useful, if the idiots at Microsoft, who
retain a dismaying large share of the Web browser market, had
implemented it correctly.  Unlike every other competently-implemented
browser, which sends the {\tt name} and {\tt value} fields to
the server as CGI arguments, Internet Exploder, even the
much-vaunted version 7, sends the {\tt name} with the
{\em content} of the button tag instead of the {\tt value}.

In the first example, the server would see an argument named
``{\tt action}'' with a value of ``\verb+<b>Ka-<em>BOOM!</em></b>+'',
and in the second, if the user pressed the ``Edit'' button,
the server would receive ``{\tt edit=Edit}'', providing no
indication whatsoever of the table row upon which the user wished
to operate.  As a final kick in the face of the developer trying
to build an application on top of that rickety platform, Exploder
renders buttons defined with the \verb+<button>+ and
\verb+<input type="submit">+ tags at different vertical
positions, so if you combine a number of them on the
same line, it looks like they weren't securely glued to the
page and shook loose as they travelled over the Internet.

There are several discussions of this outrage on various
Web sites, and many suggestions of work-arounds, the vast
majority of which use JavaScript.  Now, I'm a fan of JavaScript,
which, used appropriately, can make pages more responsive
and interactive, but I dislike making pages that depend
upon it for correct operation; some users block JavaScript
as a matter of security (or are behind firewalls which do so),
and many text-only browsers and screen reader programs used by
blind users do not support JavaScript.  Disenfranchising
these individuals from using a Web application just to work
around Microsoft incompetence is unacceptable.

Here is the solution I have settled on.  This is implemented
in the context of a Perl CGI application which uses the Perl
{\tt CGI} package with extensions of my own devising to
parse form arguments into a hash named \verb+%CGIargs+.
Rather than use a button declared as:

\begin{verbatim}
    <button type="submit" name="edit" value="row12">Edit</button>
\end{verbatim}

\noindent
I declare it as:

\begin{verbatim}
    <input type="submit" name="edit=row12" value="Edit" />
\end{verbatim}

\noindent
and then use the following Perl code to parse any CGI
arguments with name fields containing an equal sign into
name and value pairs, which are assigned to new values in
the CGI arguments hash.  (If for some bizarre reason you
require CGI argument names containing equal signs for some
other purpose, simply pick a different delimiter.)

This solves the problem of multiple buttons per form with
the same value.  If you require buttons with HTML content,
you can use the same trick in the {\tt name=} field of
a \verb+<button>+ tag.  However, if your users are
using Exploder 6, you {\em still} cannot use multuple
\verb+<button>+ tags in a single form because it moronically
sends {\em all} buttons in the form, {\em not just the
one which was pressed!}  (Note that this doesn't happen
with multiple \verb+<input type="submit">+ buttons---that
would be too consistent for Microsoft.)  This has been
fixed in Exploder 7, but unless you don't care about users
who have yet to ``upgrade'' to that piece of\ldots software,
you're going to have to stay away from \verb+<button>+ entirely.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap264}\raggedright\small
\NWtarget{nuweb176}{} $\langle\,${\itshape Extract brain-dead Internet Exploder request field}\nobreak\ {\footnotesize {176}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (!defined $CGIargs{q}) {@\\
\mbox{}\verb@        for my $qk (keys(%CGIargs)) {@\\
\mbox{}\verb@            if ($qk =~ m/^(\w+)=(.*)$/) {@\\
\mbox{}\verb@                 $CGIargs{$1} = $2;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb173}{173}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
\vbox{
\subsection{Estimate local time at user site}

On various occasions, for example when deciding which monthly
log to display when a user logs in, or deciding if log entries
are ``in the future'', we would like to know the local wall
clock time at the user's location.  Unfortunately, the HTTP
request does not provide this information, so we fall back
on a scheme in which a {\tt hidden} input field called
\verb+HDiet_tzoffset+ is set by JavaScript code when each
of our pages is loaded and then submitted with each transaction
the user performs.  This code checks for the presence of
this field in the CGI request.  If present, and set to a
valid number, it will be used to set variables which
represent the local time in seconds since the epoch and
the local civil time.  If the field has the default value
of ``{\tt unknown}'', indicating JavaScript is not enabled,
or the field is out of range (more than 25 hours from UTC),
the specification is ignored and UTC is used as the local
time.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap265}\raggedright\small
\NWtarget{nuweb177}{} $\langle\,${\itshape Estimate local time at user site}\nobreak\ {\footnotesize {177}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my ($timeZoneOffset, $userTime) = ('unknown', time());@\\
\mbox{}\verb@    if (defined($CGIargs{HDiet_tzoffset})) {@\\
\mbox{}\verb@        if ($CGIargs{HDiet_tzoffset} =~ m/^\-?\d+$/) {@\\
\mbox{}\verb@            $timeZoneOffset = $CGIargs{HDiet_tzoffset};@\\
\mbox{}\verb@            if (abs($timeZoneOffset) > (25 * 60)) {@\\
\mbox{}\verb@                $timeZoneOffset = 'unknown';@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                $userTime -= $timeZoneOffset * 60;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    my $tzOff = "&amp;HDiet_tzoffset=$timeZoneOffset";@\\
\mbox{}\verb@    my ($userYear, $userMon, $userMday, $userHour, $userMin, $userSec) =@\\
\mbox{}\verb@        unix_time_to_civil_date_time($userTime);@\\
\mbox{}\verb@#if ($CGIargs{HDiet_tzoffset}) {@\\
\mbox{}\verb@#print(STDERR "Local time($CGIargs{HDiet_tzoffset}:$timeZoneOffset): $userYear-$userMon-$userMday $userHour:$userMin:$userSec\n");@\\
\mbox{}\verb@#}@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb173}{173}.
\item \NWtxtIdentsUsed\nobreak\  \verb@unix_time_to_civil_date_time@\nobreak\ \NWlink{nuweb451b}{451b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Dispatch requests which return non-HTML results}

Requests which return results with types other than HTML (for
example, the images for chart requests, zipped backup archives,
CSV files, etc.) are dispatched by the following code.  It is
up to the request handler to generate a ``{\tt Content-type}''
header appropriate for the result it returns.  An error in
one of the handlers can flip the request back to one of the
HTML handlers by performing a ``{\tt goto~requeue}'' before
the {\tt Content-type} is specified.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap266}\raggedright\small
\NWtarget{nuweb178}{} $\langle\,${\itshape Dispatch requests which return non-HTML results}\nobreak\ {\footnotesize {178}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (defined $CGIargs{q}) {@\\
\mbox{}\verb@        if ($CGIargs{q} eq 'chart') {@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Generate monthly chart}\nobreak\ {\footnotesize \NWlink{nuweb263a}{263a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        } elsif ($CGIargs{q} eq 'histchart') {@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Generate historical chart}\nobreak\ {\footnotesize \NWlink{nuweb303}{303}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        } elsif ($CGIargs{q} eq 'csvout') {@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Download monthly log as CSV file}\nobreak\ {\footnotesize \NWlink{nuweb248b}{248b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        } elsif ($CGIargs{q} eq 'xmlout') {@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Download monthly log as XML file}\nobreak\ {\footnotesize \NWlink{nuweb249}{249}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        } elsif ($CGIargs{q} eq 'backup') {@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Download backup copy of all logs for user}\nobreak\ {\footnotesize \NWlink{nuweb262}{262}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        } elsif ($CGIargs{q} eq 'do_exportdb') {@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Process database export}\nobreak\ {\footnotesize \NWlink{nuweb252}{252}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb173}{173}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Dispatch requests which return HTML result documents}

This is the master request dispatcher for requests which result
in the return of an HTML document to the user.  By the time we
get here the ``{\tt Content-type}'' of HTML has already been
specified.  This dispatcher is wrapped in a {\tt while} loop
and has an {\tt exit} at the bottom, so request handlers can
hand off requests to one another by modifying the CGI request
arguments and performing a {\tt next}.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap267}\raggedright\small
\NWtarget{nuweb179}{} $\langle\,${\itshape Dispatch requests which return HTML result documents}\nobreak\ {\footnotesize {179}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Login-related transactions}\nobreak\ {\footnotesize \NWlink{nuweb180a}{180a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Account management transactions}\nobreak\ {\footnotesize \NWlink{nuweb180b}{180b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'log') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Display monthly log}\nobreak\ {\footnotesize \NWlink{nuweb208}{208}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'update_log') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Update monthly log}\nobreak\ {\footnotesize \NWlink{nuweb219}{219}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'calendar') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Display calendar navigation page}\nobreak\ {\footnotesize \NWlink{nuweb221}{221}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'trendan') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Trend analysis}\nobreak\ {\footnotesize \NWlink{nuweb264}{264}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif (($CGIargs{q} eq 'dietcalc') || ($CGIargs{q} eq 'update_dietcalc')) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Diet calculator}\nobreak\ {\footnotesize \NWlink{nuweb274}{274}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'save_dietcalc') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Save diet calculator settings}\nobreak\ {\footnotesize \NWlink{nuweb293}{293}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'histreq') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Request historical chart}\nobreak\ {\footnotesize \NWlink{nuweb294}{294}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'importcsv') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Display CSV import request form}\nobreak\ {\footnotesize \NWlink{nuweb224}{224}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'csv_import_data') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Import uploaded CSV log entries}\nobreak\ {\footnotesize \NWlink{nuweb227}{227}, \ldots\ }$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'exportdb') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Export log database}\nobreak\ {\footnotesize \NWlink{nuweb250}{250}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'browsepub') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape List publicly-visible accounts}\nobreak\ {\footnotesize \NWlink{nuweb317}{317}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'do_public_browseacct') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Provide browse access to public account}\nobreak\ {\footnotesize \NWlink{nuweb320}{320}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'quitbrowse') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Quit browsing another account}\nobreak\ {\footnotesize \NWlink{nuweb248a}{248a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'configure_badge') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Configure Web page status badge}\nobreak\ {\footnotesize \NWlink{nuweb241}{241}, \ldots\ }$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'paper_logs') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Request paper log forms}\nobreak\ {\footnotesize \NWlink{nuweb258}{258}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'do_paper_logs') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Generate paper log forms}\nobreak\ {\footnotesize \NWlink{nuweb260}{260}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'update_badge') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Update Web page status badge}\nobreak\ {\footnotesize \NWlink{nuweb244}{244}, \ldots\ }$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'update_trend') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Recalculate trend carry-forward for all logs for a user}\nobreak\ {\footnotesize \NWlink{nuweb247}{247}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'feedback') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Send a feedback message}\nobreak\ {\footnotesize \NWlink{nuweb365}{365}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'send_feedback') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Send a message from the feedback form}\nobreak\ {\footnotesize \NWlink{nuweb370}{370}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'test') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Generate test output page}\nobreak\ {\footnotesize \NWlink{nuweb384b}{384b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Dispatch administrator requests}\nobreak\ {\footnotesize \NWlink{nuweb181}{181}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Emit diagnostic for undefined query}\nobreak\ {\footnotesize \NWlink{nuweb385a}{385a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb173}{173}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Login-related transactions}

The following transactions are associated with logging into
or out of an existing account.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap268}\raggedright\small
\NWtarget{nuweb180a}{} $\langle\,${\itshape Login-related transactions}\nobreak\ {\footnotesize {180a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ((!defined $CGIargs{q}) ||@\\
\mbox{}\verb@        ($CGIargs{q} eq 'login') ||@\\
\mbox{}\verb@        ($CGIargs{q} eq 'newlogin')) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Return login request form}\nobreak\ {\footnotesize \NWlink{nuweb182}{182}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'validate_user') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Validate user login request}\nobreak\ {\footnotesize \NWlink{nuweb183}{183}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'relogin') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Force re-login if session terminated or invalid}\nobreak\ {\footnotesize \NWlink{nuweb197}{197}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'logout') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Log out user: end session}\nobreak\ {\footnotesize \NWlink{nuweb204}{204}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'wipedb') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Delete entire log database}\nobreak\ {\footnotesize \NWlink{nuweb374}{374}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'do_wipedb') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Process database delete}\nobreak\ {\footnotesize \NWlink{nuweb377}{377}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'closeaccount') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Close this user account}\nobreak\ {\footnotesize \NWlink{nuweb380}{380}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'do_closeaccount') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Process user account close}\nobreak\ {\footnotesize \NWlink{nuweb382}{382}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@login@\nobreak\ \NWlink{nuweb121}{121}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Account management transactions}

The following transactions perform various functions
on a user account.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap269}\raggedright\small
\NWtarget{nuweb180b}{} $\langle\,${\itshape Account management transactions}\nobreak\ {\footnotesize {180b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'account') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Main account dispatch page}\nobreak\ {\footnotesize \NWlink{nuweb190}{190}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'new_account') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Process new user account request}\nobreak\ {\footnotesize \NWlink{nuweb305}{305}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'modacct') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Modify user account request}\nobreak\ {\footnotesize \NWlink{nuweb311}{311}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'clearcookies') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Forget all persistent logins}\nobreak\ {\footnotesize \NWlink{nuweb316}{316}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'edit_account') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Process user account modification}\nobreak\ {\footnotesize \NWlink{nuweb313}{313}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'pwreset') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Display password reset request form}\nobreak\ {\footnotesize \NWlink{nuweb198}{198}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'new_password') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Reset a user's password}\nobreak\ {\footnotesize \NWlink{nuweb199}{199}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Dispatch administrator requests}

Here we dispatch requests which are permitted only for users with
administrative privilege.  Each of these request handlers is responsible
for verifying that the user is so endowed; we can't do it here because
we haven't yet retrieved the session and user information, which does
not exist for all transactions.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap270}\raggedright\small
\NWtarget{nuweb181}{} $\langle\,${\itshape Dispatch administrator requests}\nobreak\ {\footnotesize {181}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'acctmgr') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Display administrator account manager}\nobreak\ {\footnotesize \NWlink{nuweb325}{325}, \ldots\ }$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'do_admin_browseacct') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Provide administrator access to user account}\nobreak\ {\footnotesize \NWlink{nuweb330}{330}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'do_admin_purgeacct') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Process administrator database purge}\nobreak\ {\footnotesize \NWlink{nuweb332}{332}, \ldots\ }$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'do_admin_delacct') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Process administrator account delete}\nobreak\ {\footnotesize \NWlink{nuweb334}{334}, \ldots\ }$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'sessmgr') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Display administrator session manager}\nobreak\ {\footnotesize \NWlink{nuweb336}{336}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'cookiemgr') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Display administrator persistent login manager}\nobreak\ {\footnotesize \NWlink{nuweb343}{343}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'do_admin_delcookie') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Delete a persistent login token}\nobreak\ {\footnotesize \NWlink{nuweb346}{346}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'globalstats') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Display administrator global statistics}\nobreak\ {\footnotesize \NWlink{nuweb348}{348}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'synthdata') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Generate synthetic data for user account}\nobreak\ {\footnotesize \NWlink{nuweb358}{358}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{q} eq 'do_admin_forceclose') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Force termination of user session}\nobreak\ {\footnotesize \NWlink{nuweb339}{339}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif (@\hbox{$\langle\,${\itshape Beta test}\nobreak\ {\footnotesize \NWlink{nuweb4a}{4a}}$\,\rangle$}\verb@ && ($CGIargs{q} eq 'invite')) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Request invitation codes}\nobreak\ {\footnotesize \NWlink{nuweb322}{322}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif (@\hbox{$\langle\,${\itshape Beta test}\nobreak\ {\footnotesize \NWlink{nuweb4a}{4a}}$\,\rangle$}\verb@ && ($CGIargs{q} eq 'generate_invitations')) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Generate invitation codes}\nobreak\ {\footnotesize \NWlink{nuweb323}{323}, \ldots\ }$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Return login request form}

The login request form is the point of entry when no session is
active (and hence when the program is invoked with no CGI arguments).
The user is invited to enter their user name and password.  A
``{\tt newlogin}'' transaction indicates the user has explicitly
logged out.  In this case we ignore the presence of a cookie,
which allows the user to explictly log back in without
``Remember me'' in order to perform operations which are
forbidden in a cookie login.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap271}\raggedright\small
\NWtarget{nuweb182}{} $\langle\,${\itshape Return login request form}\nobreak\ {\footnotesize {182}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    $CGIargs{HDiet_handheld} = 'y' if $CGIargs{handheld};@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ((!defined($CGIargs{q})) || ($CGIargs{q} ne 'newlogin')) {@\\
\mbox{}\verb@        $cookieUser = testCookiePresent(@\hbox{$\langle\,${\itshape Cookie name}\nobreak\ {\footnotesize \NWlink{nuweb12d}{12d}}$\,\rangle$}\verb@);@\\
\mbox{}\verb@        if (defined($cookieUser)) {@\\
\mbox{}\verb@#print(STDERR "A cookie was present for ($cookieUser)\n");@\\
\mbox{}\verb@            $cookieLogin = 1;@\\
\mbox{}\verb@            $CGIargs{q} = 'validate_user';@\\
\mbox{}\verb@            next;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Please Sign In", " checkSecure();", $CGIargs{HDiet_handheld});@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Please Sign In</h1>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    $CGIargs{HDiet_username} = '' if !defined($CGIargs{HDiet_username});@\\
\mbox{}\verb@    my $u = HDiet::user->new($CGIargs{HDiet_username});@\\
\mbox{}\verb@    $u->login_form($fh, $tzOff, $CGIargs{HDiet_handheld}, $CGIargs{HDiet_remember});@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb180a}{180a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@checkSecure@\nobreak\ \NWlink{nuweb483b}{483b}, \verb@login_form@\nobreak\ \NWlink{nuweb125}{125}, \verb@testCookiePresent@\nobreak\ \NWlink{nuweb160}{160}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Validate user login request}

This code handles the submission of the login request
form.  We receive the user ID and password as form arguments,
and verify them.  We also arrive here when the user requests
to create a new account, but that is distinguished by the
presence of the ``{\tt new}'' item among the arguments and
immediately dispatched to the new account form.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap272}\raggedright\small
\NWtarget{nuweb183}{} $\langle\,${\itshape Validate user login request}\nobreak\ {\footnotesize {183}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (defined($CGIargs{new})) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Create new user account request}\nobreak\ {\footnotesize \NWlink{nuweb304a}{304a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   If no user name given, re-issue login form@\\
\mbox{}\verb@        if ((!$cookieLogin) && ((!defined($CGIargs{HDiet_username})) ||@\\
\mbox{}\verb@            ($CGIargs{HDiet_username} eq ''))) {@\\
\mbox{}\verb@            $CGIargs{q} = 'login';@\\
\mbox{}\verb@            next;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($user_file_name, $ui);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($cookieLogin) {@\\
\mbox{}\verb@            $user_file_name = quoteUserName($cookieUser);@\\
\mbox{}\verb@            if (!(-f "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/UserAccount.hdu")@\\
\mbox{}\verb@                || (!open(FU, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/UserAccount.hdu"))) {@\\
\mbox{}\verb@                @\hbox{$\langle\,${\itshape Reject login: Unknown user name}\nobreak\ {\footnotesize \NWlink{nuweb185a}{185a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            $ui = HDiet::user->new();@\\
\mbox{}\verb@            $ui->load(\*FU);@\\
\mbox{}\verb@            close(FU);@\\
\mbox{}\verb@            $CGIargs{HDiet_username} = $ui->{login_name};@\\
\mbox{}\verb@            $CGIargs{HDiet_remember} = 'y';@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Validate user name and password}\nobreak\ {\footnotesize \NWlink{nuweb184}{184}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Close previous session if still open}\nobreak\ {\footnotesize \NWlink{nuweb186c}{186c}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Open new session and link to user directory}\nobreak\ {\footnotesize \NWlink{nuweb187}{187}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Update last login and transaction time}\nobreak\ {\footnotesize \NWlink{nuweb188a}{188a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Add login to history database}\nobreak\ {\footnotesize \NWlink{nuweb188b}{188b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Update persistent login state}\nobreak\ {\footnotesize \NWlink{nuweb189}{189}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   Queue the transaction to display the current month's log for this user@\\
\mbox{}\verb@@\\
\mbox{}\verb@        %CGIargs = (@\\
\mbox{}\verb@            q => "log",@\\
\mbox{}\verb@            s => $s->{session_id},@\\
\mbox{}\verb@            m => "now",@\\
\mbox{}\verb@            HDiet_tzoffset => $timeZoneOffset@\\
\mbox{}\verb@        );@\\
\mbox{}\verb@        next;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb180a}{180a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}, \verb@login@\nobreak\ \NWlink{nuweb121}{121}, \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Validate user name and password}

Validate the user name and password by first determining that a user
directory exists for the file name encoded user name supplied.  If so,
read the account information file (which should exist, unless this
login arrived while we're in the middle of creating a new account which,
of course, can happen) and validate the password.  If either the user
name or password is incorrect, reject the login attempt.

At the moment, we don't do anything to deter high-speed blasts of login
attempts to try to crack passwords by brute force.  This is one of the
many refinements to add in the future.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap273}\raggedright\small
\NWtarget{nuweb184}{} $\langle\,${\itshape Validate user name and password}\nobreak\ {\footnotesize {184}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    #   Verify user account directory exists and contains@\\
\mbox{}\verb@    #   valid user information file.@\\
\mbox{}\verb@    $user_file_name = quoteUserName($CGIargs{HDiet_username});@\\
\mbox{}\verb@    if (!(-f "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/UserAccount.hdu")@\\
\mbox{}\verb@        || (!open(FU, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/UserAccount.hdu"))) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Reject login: Unknown user name}\nobreak\ {\footnotesize \NWlink{nuweb185a}{185a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   Read user account information and check password@\\
\mbox{}\verb@    $ui = HDiet::user->new();@\\
\mbox{}\verb@    $ui->load(\*FU);@\\
\mbox{}\verb@    close(FU);@\\
\mbox{}\verb@    if (($CGIargs{HDiet_password} eq '') && $ui->{read_only}) {@\\
\mbox{}\verb@        $readOnly = 1;@\\
\mbox{}\verb@    } elsif ($CGIargs{HDiet_password} ne $ui->{password}) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Reject login: Incorrect password}\nobreak\ {\footnotesize \NWlink{nuweb186a}{186a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb183}{183}.
\item \NWtxtIdentsUsed\nobreak\  \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}, \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Reject login: Unknown user name}

Reject the login if a user name was specified for which we have no
account.  To increase security, for failed logins, we do not indicate
whether the user name or password was incorrect, but we process
these errors in separate code to allow diagnostics to be inserted
for debugging.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap274}\raggedright\small
\NWtarget{nuweb185a}{} $\langle\,${\itshape Reject login: Unknown user name}\nobreak\ {\footnotesize {185a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Log failed login attempt in system log}\nobreak\ ({\footnotesize 185b\label{scrap275}
 }\mbox{}\verb@0@ ) {\footnotesize \NWlink{nuweb185c}{185c}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    $CGIargs{HDiet_handheld} = 'y' if $CGIargs{handheld};@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Please Sign In", " checkSecure();", $CGIargs{HDiet_handheld});@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Sign In Invalid: Incorrect User Name or Password</h1>@\\
\mbox{}\verb@<h1 class="c">Please Sign In</h1>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    my $u = HDiet::user->new();@\\
\mbox{}\verb@    $u->login_form($fh, $tzOff, $CGIargs{HDiet_handheld}, $CGIargs{HDiet_remember});@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@    last;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb183}{183}\NWlink{nuweb184}{, 184}\NWlink{nuweb199}{, 199}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subparagraph{Log failed login attempt in system log}

When a login attempt fails, we record it in the system log in
the same format used by PAM authentication failures.  At Fourmilab,
these records are parsed by the
\href{http://www.fourmilab.ch/webtools/gardol/}{
Gardol
}
attack mitigation package
which, after a specified number of successive login failures, will
banish the IP address until it stops trying and goes silent for
a specified period of time.  The specified user name is given in
the ``{\tt ruser}'' field in the encoded form from
{\tt quoteUserName}, surrounded by single quotes.  The ``{\tt uid}''
field is zero if the user name was incorrect and 1 if the user
name was valid but an incorrect password was given.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap276}\raggedright\small
\NWtarget{nuweb185c}{} $\langle\,${\itshape Log failed login attempt in system log}\nobreak\ {\footnotesize {185c}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@lt = localtime(time());@\\
\mbox{}\verb@    my $ct = sprintf("%s %d %02d:%02d:%02d",@\\
\mbox{}\verb@        MONTH_ABBREVIATIONS->[$lt[4]], $lt[3], $lt[2], $lt[1], $lt[0]);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    openlog("HackDiet", "pid", "LOG_AUTH");@\\
\mbox{}\verb@    syslog("info",@\\
\mbox{}\verb@        "$ENV{REMOTE_ADDR}: (1) $ct $ENV{SERVER_NAME} HackDiet(pam_unix)[$$]: " .@\\
\mbox{}\verb@        "authentication failure; logname= uid=@{\tt @}\verb@1 euid=0 tty=http " .@\\
\mbox{}\verb@        "ruser='$user_file_name' rhost=$ENV{REMOTE_ADDR}");@\\
\mbox{}\verb@    closelog();@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb185a}{185a}\NWlink{nuweb186a}{, 186a}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Reject login: Incorrect password}

The user name specifies a valid account but the password doesn't
match.  As noted above, in production we don't inform the user
that the user name was actually valid, but we handle a bad
password in separate code so diagnostics can be added in
case of problems.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap277}\raggedright\small
\NWtarget{nuweb186a}{} $\langle\,${\itshape Reject login: Incorrect password}\nobreak\ {\footnotesize {186a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Log failed login attempt in system log}\nobreak\ ({\footnotesize 186b\label{scrap278}
 }\mbox{}\verb@1@ ) {\footnotesize \NWlink{nuweb185c}{185c}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    $CGIargs{HDiet_handheld} = 'y' if $CGIargs{handheld};@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Please Sign In", " checkSecure();", $CGIargs{HDiet_handheld});@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Sign In Invalid: Incorrect User Name or Password</h1>@\\
\mbox{}\verb@<h1 class="c">Please Sign In</h1>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    my $u = HDiet::user->new();@\\
\mbox{}\verb@    $u->login_form($fh, $tzOff, $CGIargs{HDiet_handheld}, $CGIargs{HDiet_remember});@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@    append_history($user_file_name, 10);@\\
\mbox{}\verb@    last;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb184}{184}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Close previous session if still open}

If a session is still open for this user (presumably because they
didn't bother to log off after the last session), there will be
an {\tt ActiveSession.hda} file in the user directory.  Use it
to obtain the session ID, then delete the session file from
the session directory and the back-link to it in the user
directory.  The forced closing of an active session is recorded
in the {\tt History.hdh} database in the user directory as a
type 3 record containing the time the session was closed and
the IP address from which the login was made which caused it to
be closed.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap279}\raggedright\small
\NWtarget{nuweb186c}{} $\langle\,${\itshape Close previous session if still open}\nobreak\ {\footnotesize {186c}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ((!$readOnly) && (-f "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/ActiveSession.hda")@\\
\mbox{}\verb@        && open(FS, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/ActiveSession.hda")) {@\\
\mbox{}\verb@        my $asn = load_active_session(\*FS);@\\
\mbox{}\verb@        close(FS);@\\
\mbox{}\verb@        unlink("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/ActiveSession.hda");@\\
\mbox{}\verb@        clusterDelete("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/ActiveSession.hda");@\\
\mbox{}\verb@        unlink("@\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$asn.hds");@\\
\mbox{}\verb@        clusterDelete("@\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$asn.hds");@\\
\mbox{}\verb@        append_history($user_file_name, 3);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb183}{183}\NWlink{nuweb199}{, 199}\NWlink{nuweb339}{, 339}.
\item \NWtxtIdentsUsed\nobreak\  \verb@append_history@\nobreak\ \NWlink{nuweb397}{397}, \verb@load_active_session@\nobreak\ \NWlink{nuweb153a}{153a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Open new session and link to user directory}

Open a new session for this user's login, and add it to the
session directory.  We create a back-link from the user directory
to the currently open session in the form of an ``active session
file'' named {\tt ActiveSession.hda} in the user directory; this
simply contains the session ID.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap280}\raggedright\small
\NWtarget{nuweb187}{} $\langle\,${\itshape Open new session and link to user directory}\nobreak\ {\footnotesize {187}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    #   Create new session and add file to session directory@\\
\mbox{}\verb@    my $s = HDiet::session->new($CGIargs{HDiet_username});@\\
\mbox{}\verb@    $s->{read_only} = $readOnly;@\\
\mbox{}\verb@    $s->{handheld} = 1 if $CGIargs{HDiet_handheld};@\\
\mbox{}\verb@    $s->{cookie} = $cookieLogin;@\\
\mbox{}\verb@    open(FS, ">:utf8", "@\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$s->{session_id}.hds") ||@\\
\mbox{}\verb@        die("Cannot create session file @\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$s->{session_id}.hds");@\\
\mbox{}\verb@    $s->save(\*FS);@\\
\mbox{}\verb@    close(FS);@\\
\mbox{}\verb@    clusterCopy("@\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$s->{session_id}.hds");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   Add the ActiveSession.hda back-link to the user directory@\\
\mbox{}\verb@    if (!$readOnly) {@\\
\mbox{}\verb@        open(FS, ">:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/ActiveSession.hda") ||@\\
\mbox{}\verb@            die("Cannot create active session file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/ActiveSession.hda");@\\
\mbox{}\verb@        $s->save_active_session(\*FS);@\\
\mbox{}\verb@        close(FS);@\\
\mbox{}\verb@        clusterCopy("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/ActiveSession.hda");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb183}{183}.
\item \NWtxtIdentsUsed\nobreak\  \verb@save@\nobreak\ \NWlink{nuweb31}{31}\NWlink{nuweb123}{, 123}\NWlink{nuweb151}{, 151}\NWlink{nuweb156b}{, 156b}, \verb@save_active_session@\nobreak\ \NWlink{nuweb152c}{152c}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Update last login and transaction time}

We keep track of the time and date of the last login by a user
and the last transaction processed for an open session in the
{\tt LastLogin.hdl} and {\tt LastTransaction.hdl} files in
the user directory.  These are simple text files, with the first
line a version identifier (``{\tt 1}'' currently), and the second
the \UNIX/ {\tt time()} of the event.  These files permit timing out
inactive sessions.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap281}\raggedright\small
\NWtarget{nuweb188a}{} $\langle\,${\itshape Update last login and transaction time}\nobreak\ {\footnotesize {188a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    #   Update the date and time of the last login by this user@\\
\mbox{}\verb@    if ($readOnly) {@\\
\mbox{}\verb@        open(FL, ">:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/LastLogin.hdl") ||@\\
\mbox{}\verb@           die("Cannot create last login file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/LastLogin.hdl");@\\
\mbox{}\verb@        print FL <<"EOD";@\\
\mbox{}\verb@1@\\
\mbox{}\verb@$s->{login_time}@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        close(FL);@\\
\mbox{}\verb@        clusterCopy("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/LastLogin.hdl");@\\
\mbox{}\verb@@\\
\mbox{}\verb@        update_last_transaction($user_file_name);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb183}{183}.
\item \NWtxtIdentsUsed\nobreak\  \verb@login@\nobreak\ \NWlink{nuweb121}{121}, \verb@update_last_transaction@\nobreak\ \NWlink{nuweb398}{398}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Add login to history database}

The new login is recorded in the {\tt History.hdh} database in the
user directory as a record of type 1 containing the \UNIX/ time of
the login and the IP address from which the user logged in.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap282}\raggedright\small
\NWtarget{nuweb188b}{} $\langle\,${\itshape Add login to history database}\nobreak\ {\footnotesize {188b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    append_history($user_file_name, 1, "$s->{handheld},$s->{cookie}") if !$readOnly;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb183}{183}.
\item \NWtxtIdentsUsed\nobreak\  \verb@append_history@\nobreak\ \NWlink{nuweb397}{397}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Update persistent login state}

If the user has checked the ``Remember me' box, create and store a
persistent login cookie which will be used in subsequent
automatic logins.  If the box is not checked and a cookie
(valid or not) is present, issue a header item which causes
it to be revoked; this allows a user to cancel ``Remember
me'' mode by explicitly logging out, then logging back in
with the box unchecked.

Another small subtlety if that the user may have a login cookie
present, but opt to explicitly log out and then log back with with
``Remember me'' set.  In this case, we want to get rid of the persistent
cookie on the server to avoid them accumulating.  (The periodic expired
cookie sweep will clean them up, but it's better to avoid the clutter
in the most common case which can lead to orphaned cookies.)

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap283}\raggedright\small
\NWtarget{nuweb189}{} $\langle\,${\itshape Update persistent login state}\nobreak\ {\footnotesize {189}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (!$ui->{read_only}) {@\\
\mbox{}\verb@        if ($CGIargs{HDiet_remember}) {@\\
\mbox{}\verb@            testCookiePresent(@\hbox{$\langle\,${\itshape Cookie name}\nobreak\ {\footnotesize \NWlink{nuweb12d}{12d}}$\,\rangle$}\verb@);@\\
\mbox{}\verb@            if (@\hbox{$\langle\,${\itshape Set cookies with JavaScript}\nobreak\ {\footnotesize \NWlink{nuweb13c}{13c}}$\,\rangle$}\verb@) {@\\
\mbox{}\verb@                push(@{\tt @}\verb@headerScripts,@\\
\mbox{}\verb@                    "function setCookie() {",@\\
\mbox{}\verb@                    "    document.cookie = '" . storeCookie($ui) . "';",@\\
\mbox{}\verb@                    "}");@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                push(@{\tt @}\verb@HTTP_header, "Set-Cookie: " . storeCookie($ui));@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            my $cname = @\hbox{$\langle\,${\itshape Cookie name}\nobreak\ {\footnotesize \NWlink{nuweb12d}{12d}}$\,\rangle$}\verb@;@\\
\mbox{}\verb@            if (defined(testCookiePresent($cname)) ||@\\
\mbox{}\verb@                (defined($ENV{HTTP_COOKIE}) &&@\\
\mbox{}\verb@                ($ENV{HTTP_COOKIE} =~ m/$cname=([0-9FGJKQW]{48})/))) {@\\
\mbox{}\verb@#print(STDERR "Revoking cookie $ENV{HTTP_COOKIE}\n");@\\
\mbox{}\verb@                my $excook = HDiet::cookie->new();@\\
\mbox{}\verb@                if (@\hbox{$\langle\,${\itshape Set cookies with JavaScript}\nobreak\ {\footnotesize \NWlink{nuweb13c}{13c}}$\,\rangle$}\verb@) {@\\
\mbox{}\verb@                    push(@{\tt @}\verb@headerScripts,@\\
\mbox{}\verb@                        "function setCookie() {\n",@\\
\mbox{}\verb@                        "    document.cookie = '" . $excook->expireCookie($cname) . "';\n",@\\
\mbox{}\verb@                        "}\n");@\\
\mbox{}\verb@                } else {@\\
\mbox{}\verb@                    push(@{\tt @}\verb@HTTP_header, "Set-Cookie: " . $excook->expireCookie($cname));@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb183}{183}.
\item \NWtxtIdentsUsed\nobreak\  \verb@expireCookie@\nobreak\ \NWlink{nuweb158b}{158b}, \verb@storeCookie@\nobreak\ \NWlink{nuweb159}{159}, \verb@testCookiePresent@\nobreak\ \NWlink{nuweb160}{160}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Main account dispatch page}

This page is displayed after a user successfully logs in.  It contains
links to all of the things the user can do once logged in.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap284}\raggedright\small
\NWtarget{nuweb190}{} $\langle\,${\itshape Main account dispatch page}\nobreak\ {\footnotesize {190}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $qun = quoteHTML($user_name);@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, $qun, undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, "Utilities", undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Show user name and account being browsed}\nobreak\ {\footnotesize \NWlink{nuweb191a}{191a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Standard navigation bar functions}\nobreak\ {\footnotesize \NWlink{nuweb191b}{191b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($browse_public) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Browsing public account functions}\nobreak\ {\footnotesize \NWlink{nuweb193}{193}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Utility functions for regular session}\nobreak\ {\footnotesize \NWlink{nuweb192}{192}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@#        if (@\hbox{$\langle\,${\itshape Beta test}\nobreak\ {\footnotesize \NWlink{nuweb4a}{4a}}$\,\rangle$}\verb@) {@\\
\mbox{}\verb@            print $fh <<"EOD";@\\
\mbox{}\verb@    <li class="skip"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=feedback$tzOff">Send feedback message</a></li>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@#        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@    <li class="skip"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=logout$tzOff">Sign out</a></li>@\\
\mbox{}\verb@</ul>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($ui->{administrator} || $assumed_identity) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Administrator-only functions}\nobreak\ {\footnotesize \NWlink{nuweb194}{194}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Show build number and date}\nobreak\ {\footnotesize \NWlink{nuweb195}{195}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb180b}{180b}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Show user name and account being browsed}

If the user is browsing a public account, show its public name.
Otherwise, generate the ``Welcome'' message for a user logged
into their own account.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap285}\raggedright\small
\NWtarget{nuweb191a}{} $\langle\,${\itshape Show user name and account being browsed}\nobreak\ {\footnotesize {191a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($browse_public) {@\\
\mbox{}\verb@        my $qrn = quoteHTML($real_user_name);@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h2 class="c">$qrn browsing<br /> public $qun account</h2>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Welcome, $qun</h1>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb190}{190}.
\item \NWtxtIdentsUsed\nobreak\  \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Standard navigation bar functions}

These menu items provide links to functions which, with the exception
of the diet calculator, also appear in the navigation bar.  They're
here in the interest of completeness.  The last item is, however,
the only way to get to the diet calculator.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap286}\raggedright\small
\NWtarget{nuweb191b}{} $\langle\,${\itshape Standard navigation bar functions}\nobreak\ {\footnotesize {191b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<ul>@\\
\mbox{}\verb@    <li><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=log&amp;m=now$tzOff">Current monthly log</a></li>@\\
\mbox{}\verb@    <li><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=calendar$tzOff">Historical logs</a></li>@\\
\mbox{}\verb@    <li><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=histreq$tzOff">Historical charts</a></li>@\\
\mbox{}\verb@    <li><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=trendan$tzOff">Trend analysis</a></li>@\\
\mbox{}\verb@    <li><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=dietcalc$tzOff">Diet calculator</a></li>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb190}{190}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Utility functions for regular session}

The following menu items are the grab-bag of functions a user can perform
when logged in to their account in the normal fashion.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap287}\raggedright\small
\NWtarget{nuweb192}{} $\langle\,${\itshape Utility functions for regular session}\nobreak\ {\footnotesize {192}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@    <li class="skip"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=modacct$tzOff">Edit account settings</a></li>@\\
\mbox{}\verb@    <li><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=configure_badge$tzOff">Configure Web page badge image</a></li>@\\
\mbox{}\verb@    <li><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=paper_logs$tzOff">Print paper log forms</a></li>@\\
\mbox{}\verb@    <li><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=update_trend&amp;m=0000-00&amp;canon=0$tzOff">Recalculate trend carry-forward</a></li>@\\
\mbox{}\verb@    <li><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=clearcookies$tzOff">Forget persistent logins</a></li>@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <li class="skip"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=exportdb$tzOff">Export database as CSV or XML</a></li>@\\
\mbox{}\verb@    <li><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=importcsv$tzOff">Import CSV  or XML database</a></li>@\\
\mbox{}\verb@    <li><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=backup$tzOff">Download native database backup</a></li>@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <li class="skip"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=wipedb$tzOff">Delete entire log database</a></li>@\\
\mbox{}\verb@    <li><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=closeaccount$tzOff">Close this user account</a></li>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (!$readOnly) {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <li class="skip">@\\
\mbox{}\verb@@\\
\mbox{}\verb@        <form id="Hdiet_pubacct" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@            <p style="margin-top: 0px; margin-bottom: 4px;">@\\
\mbox{}\verb@            <input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@            Browse public user accounts:@\\
\mbox{}\verb@            <select name="acct_category" size="1">@\\
\mbox{}\verb@                <option value="active" selected="selected">Active accounts</option>@\\
\mbox{}\verb@                <option value="inactive">Inactive accounts</option>@\\
\mbox{}\verb@                <option value="all">All accounts</option>@\\
\mbox{}\verb@            </select>@\\
\mbox{}\verb@            <input type="submit" name="q=browsepub" value=" View " />@\\
\mbox{}\verb@            </p>@\\
\mbox{}\verb@        </form>@\\
\mbox{}\verb@@\\
\mbox{}\verb@        <form id="Hdiet_acctmgr" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@            <p style="margin-top: 0px;">@\\
\mbox{}\verb@            Access public account name:@\\
\mbox{}\verb@            <input type="text" name="pubacct" maxlength="80" size="21" />@\\
\mbox{}\verb@            <input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@            <input type="submit" name="q=do_public_browseacct" value=" View " />@\\
\mbox{}\verb@            </p>@\\
\mbox{}\verb@        </form>@\\
\mbox{}\verb@    </li>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb190}{190}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Browsing public account functions}

The following menu items are shown only when the user is browsing a
public account.  They allow the user to quit browsing or choose a different
account to browse.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap288}\raggedright\small
\NWtarget{nuweb193}{} $\langle\,${\itshape Browsing public account functions}\nobreak\ {\footnotesize {193}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <li class="skip"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=quitbrowse$tzOff">Quit browsing <b>$qun</b> public account</a></li>@\\
\mbox{}\verb@    <li><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=browsepub$tzOff">Browse a different public user account</a>@\\
\mbox{}\verb@        <form id="Hdiet_acctmgr" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@            <p style="margin-top: 0px;">@\\
\mbox{}\verb@            Access public account name:@\\
\mbox{}\verb@            <input type="text" name="pubacct" maxlength="80" size="21" />@\\
\mbox{}\verb@            <input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@            <input type="submit" name="q=do_public_browseacct" value=" View " />@\\
\mbox{}\verb@            </p>@\\
\mbox{}\verb@        </form>@\\
\mbox{}\verb@    </li>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb190}{190}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Administrator-only functions}

The following functions are available only if the user has
administrator privilege.  The transactions which perform the following
functions individually check for privilege---they are not just protected
by being hidden on this page.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap289}\raggedright\small
\NWtarget{nuweb194}{} $\langle\,${\itshape Administrator-only functions}\nobreak\ {\footnotesize {194}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h2 class="c">Administrator Functions</h2>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<ul>@\\
\mbox{}\verb@    <li class="skip">@\\
\mbox{}\verb@        <form id="Hdiet_admacct" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@            <p style="margin-top: 0px; margin-bottom: 4px;">@\\
\mbox{}\verb@            <input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@            Manage user accounts:@\\
\mbox{}\verb@            <select name="acct_category" size="1">@\\
\mbox{}\verb@                <option value="active" selected="selected">Active accounts</option>@\\
\mbox{}\verb@                <option value="inactive">Inactive accounts</option>@\\
\mbox{}\verb@                <option value="all">All accounts</option>@\\
\mbox{}\verb@            </select>@\\
\mbox{}\verb@            <input type="submit" name="q=acctmgr" value=" View " />@\\
\mbox{}\verb@            </p>@\\
\mbox{}\verb@        </form>@\\
\mbox{}\verb@@\\
\mbox{}\verb@        <form id="Hdiet_acctadm" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@            <p style="margin-top: 0px;">@\\
\mbox{}\verb@            User account name:@\\
\mbox{}\verb@            <input type="text" name="useracct" maxlength="80" size="21" />@\\
\mbox{}\verb@            <input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@            <input type="submit" name="q=do_admin_browseacct" value=" View " />@\\
\mbox{}\verb@            &nbsp;@\\
\mbox{}\verb@            <input type="submit" name="q=do_admin_delacct" value=" Delete " />@\\
\mbox{}\verb@            <input type="submit" name="q=do_admin_purgeacct" value=" Purge Logs " />@\\
\mbox{}\verb@            <input type="password" name="HDiet_password" size="20" maxlength="4096" value="" />@\\
\mbox{}\verb@            </p>@\\
\mbox{}\verb@        </form>@\\
\mbox{}\verb@</li>@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <li><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=sessmgr$tzOff">Manage sessions</a></li>@\\
\mbox{}\verb@    <li><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=cookiemgr$tzOff">Manage persistent logins</a></li>@\\
\mbox{}\verb@    <li><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=globalstats$tzOff">Display global statistics</a></li>@\\
\mbox{}\verb@    <li><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=synthdata$tzOff">Generate synthetic data</a></li>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (@\hbox{$\langle\,${\itshape Beta test}\nobreak\ {\footnotesize \NWlink{nuweb4a}{4a}}$\,\rangle$}\verb@) {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@    <li><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=invite$tzOff">Create invitation codes</a></li>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@</ul>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb190}{190}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Show build number and date}

On beta test builds, show the build number (updated automatically by
the {\tt Makefile}) and the time and date of the build at the bottom
right of the page.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap290}\raggedright\small
\NWtarget{nuweb195}{} $\langle\,${\itshape Show build number and date}\nobreak\ {\footnotesize {195}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@#    if (@\hbox{$\langle\,${\itshape Beta test}\nobreak\ {\footnotesize \NWlink{nuweb4a}{4a}}$\,\rangle$}\verb@) {@\\
\mbox{}\verb@        my $bn = <<"EOD";@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Build Number}\nobreak\ {\footnotesize \NWlink{nuweb3c}{3c}}$\,\rangle$}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        $bn =~ s/\s+$/:/;@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<p class="build">@\\
\mbox{}\verb@Build $bn @\hbox{$\langle\,${\itshape Build Time}\nobreak\ {\footnotesize \NWlink{nuweb3d}{3d}}$\,\rangle$}\verb@</p>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@#    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb190}{190}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Generate assumed identity notification}

If the user is operating under an assumed identity (which can be the
administrator performing maintenance in the name of a user, or a
regular user browsing an account whose owner has granted public
read access), generate a message to remind the user the data presented
is not their own.

If the user is logged into a demonstration account in read-only mode,
a legend indicating this is displayed.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap291}\raggedright\small
\NWtarget{nuweb196}{} $\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize {196}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($readOnly) {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h3 class="browsing">Read-only access: Changes are not saved.</h3>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($assumed_identity) {@\\
\mbox{}\verb@        my $eu = quoteHTML($effective_user_name);@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<form id="Hdiet_quitadm" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@<div>@\\
\mbox{}\verb@<input type="hidden" name="q" value="quitbrowse" />@\\
\mbox{}\verb@<input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@</div>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h3 class="browsing">Administrator accessing account of $eu@\\
\mbox{}\verb@&nbsp; &nbsp; &nbsp;@\\
\mbox{}\verb@<input type="submit"@\\
\mbox{}\verb@    title="End browsing this account" value="Exit" />@\\
\mbox{}\verb@</h3>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    } elsif ($browse_public) {@\\
\mbox{}\verb@        my $eu = quoteHTML($effective_user_name);@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<form id="Hdiet_quitbrowse" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@<div>@\\
\mbox{}\verb@<input type="hidden" name="q" value="quitbrowse" />@\\
\mbox{}\verb@<input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@</div>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h3 class="browsing">Browsing public account $eu@\\
\mbox{}\verb@&nbsp; &nbsp; &nbsp;@\\
\mbox{}\verb@<input type="submit"@\\
\mbox{}\verb@    title="End browsing this public account" value="Exit" />@\\
\mbox{}\verb@</h3>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb190}{190}\NWlink{nuweb208}{, 208}\NWlink{nuweb221}{, 221}\NWlink{nuweb224}{, 224}\NWlink{nuweb227}{, 227}\NWlink{nuweb241}{, 241}\NWlink{nuweb244}{, 244}\NWlink{nuweb247}{, 247}\NWlink{nuweb250}{, 250}\NWlink{nuweb252}{, 252}\NWlink{nuweb258}{, 258}\NWlink{nuweb260}{, 260}\NWlink{nuweb262}{, 262}\NWlink{nuweb264}{, 264}\NWlink{nuweb274}{, 274}\NWlink{nuweb294}{, 294}\NWlink{nuweb311}{, 311}\NWlink{nuweb312}{, 312}\NWlink{nuweb313}{, 313}\NWlink{nuweb315}{, 315}\NWlink{nuweb316}{, 316}\NWlink{nuweb317}{, 317}\NWlink{nuweb320}{, 320}\NWlink{nuweb321}{, 321}\NWlink{nuweb322}{, 322}\NWlink{nuweb323}{, 323}\NWlink{nuweb325}{, 325}\NWlink{nuweb330}{, 330}\NWlink{nuweb331}{, 331}\NWlink{nuweb332}{, 332}\NWlink{nuweb334}{, 334}\NWlink{nuweb336}{, 336}\NWlink{nuweb340}{, 340}\NWlink{nuweb341}{, 341}\NWlink{nuweb342}{, 342}\NWlink{nuweb343}{, 343}\NWlink{nuweb347}{, 347}\NWlink{nuweb348}{, 348}\NWlink{nuweb358}{, 358}\NWlink{nuweb365}{, 365}\NWlink{nuweb370}{, 370}\NWlink{nuweb374}{, 374}\NWlink{nuweb377}{, 377}\NWlink{nuweb380}{, 380}\NWlink{nuweb382}{, 382}.
\item \NWtxtIdentsUsed\nobreak\  \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Force re-login if session terminated or invalid}

If the request contains a session ID which corresponds to no active
session, it's probably because the session has timed out or because
the user is submitting a form from one browser window after having logged
out from another.  In this case, we have no alternative but to discard
the request and ask the user to log back in.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap292}\raggedright\small
\NWtarget{nuweb197}{} $\langle\,${\itshape Force re-login if session terminated or invalid}\nobreak\ {\footnotesize {197}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    $CGIargs{HDiet_handheld} = 'y' if $CGIargs{handheld};@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Please Sign In", " checkSecure();", $CGIargs{HDiet_handheld});@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Your session has timed out or has been ended.</h1>@\\
\mbox{}\verb@<h1 class="c">Please Sign In Again</h1>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    my $u = HDiet::user->new();@\\
\mbox{}\verb@    $u->login_form($fh, $tzOff, $CGIargs{HDiet_handheld}, $CGIargs{HDiet_remember});@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb180a}{180a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@checkSecure@\nobreak\ \NWlink{nuweb483b}{483b}, \verb@login_form@\nobreak\ \NWlink{nuweb125}{125}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Display password reset request form}

Users who forget their password may request the password be reset
to a random value which is sent to their registered E-mail address.
To guard against malicious reset requests by those who guess common
user names, we require the user to specify the registered E-mail address
for the account when resetting the password.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap293}\raggedright\small
\NWtarget{nuweb198}{} $\langle\,${\itshape Display password reset request form}\nobreak\ {\footnotesize {198}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $qun = '';@\\
\mbox{}\verb@    $qun = quoteHTML($CGIargs{HDiet_username}) if defined($CGIargs{HDiet_username});@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Reset Password", undef, $CGIargs{HDiet_handheld});@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Reset Password</h1>@\\
\mbox{}\verb@<form id="Hdiet_reset_password" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Propagate handheld setting to subsequent forms}\nobreak\ {\footnotesize \NWlink{nuweb304b}{304b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@To reset your password to a new value, which will be sent via E-mail@\\
\mbox{}\verb@to the registered E-mail address for your account, enter your User@\\
\mbox{}\verb@Name and E-mail address in the boxes below and press the &ldquo;Reset@\\
\mbox{}\verb@Password&rdquo; button.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<table border="border" class="login">@\\
\mbox{}\verb@<tr><th><span class="accesskey">U</span>ser Name:</th>@\\
\mbox{}\verb@    <td><input accesskey="u" type="text" name="HDiet_username" size="60"@\\
\mbox{}\verb@               maxlength="@\hbox{$\langle\,${\itshape Maximum Text Input Field Length}\nobreak\ {\footnotesize \NWlink{nuweb11c}{11c}}$\,\rangle$}\verb@" value="$qun" /></td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@<tr><th><span class="accesskey">E</span>-mail address:</th>@\\
\mbox{}\verb@    <td><input accesskey="e" type="text" name="HDiet_email" size="60"@\\
\mbox{}\verb@               maxlength="@\hbox{$\langle\,${\itshape Maximum Text Input Field Length}\nobreak\ {\footnotesize \NWlink{nuweb11c}{11c}}$\,\rangle$}\verb@" value="" /></td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@</table>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    my $u = HDiet::user->new($CGIargs{HDiet_username});@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<input type="hidden" name="q" value="new_password" />@\\
\mbox{}\verb@<input type="submit" name="reset" value=" Reset Password " />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="submit" name="cancel" value=" Cancel " />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb180b}{180b}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@login@\nobreak\ \NWlink{nuweb121}{121}, \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Reset a user's password}

When a user requests a password reset, we first validate the user name
and confirm that the user has an E-mail address on file and that it
agrees with the E-mail address specified in the password reset
request. Then we close any session which may be active, call the
{\tt resetPassword} method of the {\tt user} object to generate the new
password, and send an E-mail to notify the user of the new password.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap294}\raggedright\small
\NWtarget{nuweb199}{} $\langle\,${\itshape Reset a user's password}\nobreak\ {\footnotesize {199}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    #   If no user name given or the user clicked "Cancel" re-issue login form@\\
\mbox{}\verb@    if (($CGIargs{HDiet_username} eq '') || $CGIargs{cancel}) {@\\
\mbox{}\verb@        $CGIargs{q} = 'login';@\\
\mbox{}\verb@        next;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   Verify user account directory exists and contains@\\
\mbox{}\verb@    #   valid user information file.@\\
\mbox{}\verb@    my $user_file_name = quoteUserName($CGIargs{HDiet_username});@\\
\mbox{}\verb@    if (!(-f "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/UserAccount.hdu")@\\
\mbox{}\verb@        || (!open(FU, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/UserAccount.hdu"))) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Reject login: Unknown user name}\nobreak\ {\footnotesize \NWlink{nuweb185a}{185a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   Read user account information@\\
\mbox{}\verb@    my $ui = HDiet::user->new();@\\
\mbox{}\verb@    $ui->load(\*FU);@\\
\mbox{}\verb@    close(FU);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Validate E-mail address agrees with specification in reset request}\nobreak\ {\footnotesize \NWlink{nuweb200}{200}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Prohibit password reset on read-only account}\nobreak\ {\footnotesize \NWlink{nuweb201}{201}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Close previous session if still open}\nobreak\ {\footnotesize \NWlink{nuweb186c}{186c}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $ui->resetPassword(@\hbox{$\langle\,${\itshape Length of automatically generated passwords}\nobreak\ {\footnotesize \NWlink{nuweb12c}{12c}}$\,\rangle$}\verb@);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Update user account information}\nobreak\ {\footnotesize \NWlink{nuweb309}{309}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Send E-mail confirming password reset}\nobreak\ {\footnotesize \NWlink{nuweb202}{202}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Return password reset confirmation page}\nobreak\ {\footnotesize \NWlink{nuweb203}{203}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    append_history($user_file_name, 6);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb180b}{180b}.
\item \NWtxtIdentsUsed\nobreak\  \verb@append_history@\nobreak\ \NWlink{nuweb397}{397}, \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}, \verb@login@\nobreak\ \NWlink{nuweb121}{121}, \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}, \verb@resetPassword@\nobreak\ \NWlink{nuweb135a}{135a}\NWlink{nuweb135b}{b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Validate E-mail address agrees with specification in reset request}

To prevent vandals from guessing common names and maliciously
resetting their passwords just to create irritation, we require
the user to enter their E-mail address in the password reset
request and require it to match the registered E-mail address
to which the new password will be sent.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap295}\raggedright\small
\NWtarget{nuweb200}{} $\langle\,${\itshape Validate E-mail address agrees with specification in reset request}\nobreak\ {\footnotesize {200}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($CGIargs{HDiet_email} ne $ui->{e_mail}) {@\\
\mbox{}\verb@        write_XHTML_prologue($fh, $homeBase, "Incorrect E-mail Address", undef, $CGIargs{HDiet_handheld});@\\
\mbox{}\verb@        my $arghandheld = $CGIargs{HDiet_handheld} ? '&amp;HDiet_handheld=y' : '';@\\
\mbox{}\verb@        my $qun = quoteHTML($CGIargs{HDiet_username});@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Incorrect E-mail Address</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@Your password reset request specified a different E-mail@\\
\mbox{}\verb@address than the one registered for your account to which@\\
\mbox{}\verb@the new password will be sent.  To avoid abuse, you must specify@\\
\mbox{}\verb@the registered E-mail address to confirm your identity before@\\
\mbox{}\verb@the password will be reset.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=login$arghandheld$tzOff">Sign In</a></h4>@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=pwreset$arghandheld&amp;HDiet_username=$qun$tzOff">Password Reset</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@        append_history($user_file_name, 9);@\\
\mbox{}\verb@        last;@\\
\mbox{}\verb@   }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb199}{199}.
\item \NWtxtIdentsUsed\nobreak\  \verb@append_history@\nobreak\ \NWlink{nuweb397}{397}, \verb@login@\nobreak\ \NWlink{nuweb121}{121}, \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Prohibit password reset on read-only account}

Users are not allowed to reset the password of read-only
demonstration accounts even if they know the E-mail address
(which they can determine from the account settings page).

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap296}\raggedright\small
\NWtarget{nuweb201}{} $\langle\,${\itshape Prohibit password reset on read-only account}\nobreak\ {\footnotesize {201}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($ui->{read_only}) {@\\
\mbox{}\verb@        write_XHTML_prologue($fh, $homeBase, "Password Reset Rejected", undef, $CGIargs{HDiet_handheld});@\\
\mbox{}\verb@        my $arghandheld = $CGIargs{HDiet_handheld} ? '&amp;HDiet_handheld=y' : '';@\\
\mbox{}\verb@        my $qun = quoteHTML($CGIargs{HDiet_username});@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Password Reset Rejected</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@This is a read-only demonstration account.  You are not permitted@\\
\mbox{}\verb@to request a password reset.  You can sign in to this account in@\\
\mbox{}\verb@read-only mode using a blank password.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=login$arghandheld$tzOff">Sign In</a></h4>@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=pwreset$arghandheld&amp;HDiet_username=$qun$tzOff">Password Reset</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@        last;@\\
\mbox{}\verb@   }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb199}{199}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@login@\nobreak\ \NWlink{nuweb121}{121}, \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Send E-mail confirming password reset}

Send an E-mail message to the user's registered account to
confirm that the password has been reset to the string
given in the message.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap297}\raggedright\small
\NWtarget{nuweb202}{} $\langle\,${\itshape Send E-mail confirming password reset}\nobreak\ {\footnotesize {202}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    $ui->sendMail("Password reset",@\\
\mbox{}\verb@"Your password for The Hacker's Diet Online:@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Site home URL}\nobreak\ {\footnotesize \NWlink{nuweb13e}{13e}}$\,\rangle$}\verb@@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@has been reset at your request.  The new password is:@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $ui->{password}@\\
\mbox{}\verb@@\\
\mbox{}\verb@You must enter the password exactly as given above; upper and@\\
\mbox{}\verb@lower case letters are not the same.  After logging into your@\\
\mbox{}\verb@account with this new password, you are encouraged to change@\\
\mbox{}\verb@your password to something easier to remember, but difficult@\\
\mbox{}\verb@for a stranger to guess.@\\
\mbox{}\verb@\n");@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb199}{199}.
\item \NWtxtIdentsUsed\nobreak\  \verb@sendMail@\nobreak\ \NWlink{nuweb136}{136}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Return password reset confirmation page}

Generate an HTML page which confirms that the new password has been
sent via E-mail.  The confirmation includes a button which returns
the user to the login page.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap298}\raggedright\small
\NWtarget{nuweb203}{} $\langle\,${\itshape Return password reset confirmation page}\nobreak\ {\footnotesize {203}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Password Reset and Mailed", undef, $CGIargs{HDiet_handheld});@\\
\mbox{}\verb@    my ($qun, $qem) = (quoteHTML($ui->{login_name}), quoteHTML($ui->{e_mail}));@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Password Reset and Mailed</h1>@\\
\mbox{}\verb@<form id="Hdiet_password_reset_confirmation" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Propagate handheld setting to subsequent forms}\nobreak\ {\footnotesize \NWlink{nuweb304b}{304b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@The password for your Hacker's Diet Online account:@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<blockquote>@\\
\mbox{}\verb@    <p><b>$qun</b></p>@\\
\mbox{}\verb@</blockquote>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@has been reset to a randomly-generated value which has@\\
\mbox{}\verb@been sent to your E-mail address:@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<blockquote>@\\
\mbox{}\verb@    <p><b>$qem</b></p>@\\
\mbox{}\verb@</blockquote>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@Once you receive this E-mail, return to the login page@\\
\mbox{}\verb@and enter the new password to access your account.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<input type="hidden" name="q" value="login" />@\\
\mbox{}\verb@<input type="hidden" name="HDiet_username" value="$ui->{login_name}" />@\\
\mbox{}\verb@<input type="submit" name="reset" value=" Return to Login Page " />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb199}{199}.
\item \NWtxtIdentsUsed\nobreak\  \verb@login@\nobreak\ \NWlink{nuweb121}{121}, \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Log out user: end session}

When a log out request is received from a user, close
the active session, deleting the session file and its
back-link in the user directory, and make a history log
item (type 2) for the log out.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap299}\raggedright\small
\NWtarget{nuweb204}{} $\langle\,${\itshape Log out user: end session}\nobreak\ {\footnotesize {204}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   Delete active session file@\\
\mbox{}\verb@    unlink("@\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$CGIargs{s}.hds");@\\
\mbox{}\verb@    clusterDelete("@\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$CGIargs{s}.hds");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (!$readOnly) {@\\
\mbox{}\verb@        unlink("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/ActiveSession.hda");@\\
\mbox{}\verb@        clusterDelete("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/ActiveSession.hda");@\\
\mbox{}\verb@        append_history($user_file_name, 2);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   Return user to login screen@\\
\mbox{}\verb@    %CGIargs = (@\\
\mbox{}\verb@        q => "newlogin",@\\
\mbox{}\verb@    );@\\
\mbox{}\verb@    $CGIargs{HDiet_handheld} = 'y' if $session->{handheld};@\\
\mbox{}\verb@    next;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb180a}{180a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@append_history@\nobreak\ \NWlink{nuweb397}{397}, \verb@login@\nobreak\ \NWlink{nuweb121}{121}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Retrieve active session information}

The session ID from the CGI request is used to locate the active
session file, from which the user name is extracted and quoted
into the name of the directory containing the information for that
user.  If the session ID is invalid, a ``relogin'' request is queued
to permit the user to log back in.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap300}\raggedright\small
\NWtarget{nuweb205}{} $\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize {205}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    $CGIargs{s} = '' if !defined($CGIargs{s});@\\
\mbox{}\verb@    if ($CGIargs{s} !~ m/^[0-9FGJKQW]{40}$/) {@\\
\mbox{}\verb@        die("Invalid (probably spoofed) session identifier ($CGIargs{s})");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    my $session = HDiet::session->new();@\\
\mbox{}\verb@    if (!open(FS, "<:utf8", "@\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$CGIargs{s}.hds")) {@\\
\mbox{}\verb@        %CGIargs = (@\\
\mbox{}\verb@            q => "relogin",@\\
\mbox{}\verb@        );@\\
\mbox{}\verb@        if (!$inHTML) {@\\
\mbox{}\verb@            goto requeue;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        next;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    $session->load(\*FS);@\\
\mbox{}\verb@    close(FS);@\\
\mbox{}\verb@    my $user_name = $session->{login_name};@\\
\mbox{}\verb@    my $real_user_name = $user_name;@\\
\mbox{}\verb@    my $effective_user_name = '';@\\
\mbox{}\verb@    my $assumed_identity = 0;@\\
\mbox{}\verb@    my $browse_public = 0;@\\
\mbox{}\verb@    $readOnly = $session->{read_only};@\\
\mbox{}\verb@    if ($readOnly) {@\\
\mbox{}\verb@        delete $browsing_user_requests{browsepub};@\\
\mbox{}\verb@        delete $browsing_user_requests{do_public_browseacct};@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    if ($session->{effective_name} ne '') {@\\
\mbox{}\verb@        $assumed_identity = 1;@\\
\mbox{}\verb@        $effective_user_name = $session->{effective_name};@\\
\mbox{}\verb@    } elsif ($session->{browse_name} ne '') {@\\
\mbox{}\verb@        $browse_public = 1;@\\
\mbox{}\verb@        $effective_user_name = $session->{browse_name};@\\
\mbox{}\verb@        if (!$browsing_user_requests{$CGIargs{q}}) {@\\
\mbox{}\verb@            my $qun = quoteUserName($real_user_name);@\\
\mbox{}\verb@            my $qpn = quoteUserName($effective_user_name);@\\
\mbox{}\verb@            die("Invalid \"$CGIargs{q}\" transaction attempted by $qun while browsing public account $qpn");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    my $user_file_name = quoteUserName($user_name);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb190}{190}\NWlink{nuweb204}{, 204}\NWlink{nuweb208}{, 208}\NWlink{nuweb219}{, 219}\NWlink{nuweb221}{, 221}\NWlink{nuweb224}{, 224}\NWlink{nuweb227}{, 227}\NWlink{nuweb241}{, 241}\NWlink{nuweb244}{, 244}\NWlink{nuweb247}{, 247}\NWlink{nuweb248a}{, 248a}\NWlink{nuweb248b}{b}\NWlink{nuweb249}{, 249}\NWlink{nuweb250}{, 250}\NWlink{nuweb252}{, 252}\NWlink{nuweb254}{, 254}\NWlink{nuweb255}{, 255}\NWlink{nuweb256}{, 256}\NWlink{nuweb257}{, 257}\NWlink{nuweb258}{, 258}\NWlink{nuweb260}{, 260}\NWlink{nuweb262}{, 262}\NWlink{nuweb263a}{, 263a}\NWlink{nuweb264}{, 264}\NWlink{nuweb274}{, 274}\NWlink{nuweb293}{, 293}\NWlink{nuweb294}{, 294}\NWlink{nuweb303}{, 303}\NWlink{nuweb311}{, 311}\NWlink{nuweb313}{, 313}\NWlink{nuweb316}{, 316}\NWlink{nuweb317}{, 317}\NWlink{nuweb320}{, 320}\NWlink{nuweb322}{, 322}\NWlink{nuweb323}{, 323}\NWlink{nuweb325}{, 325}\NWlink{nuweb330}{, 330}\NWlink{nuweb332}{, 332}\NWlink{nuweb334}{, 334}\NWlink{nuweb336}{, 336}\NWlink{nuweb339}{, 339}\NWlink{nuweb343}{, 343}\NWlink{nuweb346}{, 346}\NWlink{nuweb348}{, 348}\NWlink{nuweb358}{, 358}\NWlink{nuweb365}{, 365}\NWlink{nuweb370}{, 370}\NWlink{nuweb374}{, 374}\NWlink{nuweb377}{, 377}\NWlink{nuweb380}{, 380}\NWlink{nuweb382}{, 382}\NWlink{nuweb385a}{, 385a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}, \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Retrieve user account information}

Load the account information for the user submitting
this request (obtained from the active session identifier,
above) into a {\tt user} object named \verb+$ui+.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap301}\raggedright\small
\NWtarget{nuweb206}{} $\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize {206}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    open(FU, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/UserAccount.hdu") ||@\\
\mbox{}\verb@        die("Cannot open user account file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/UserAccount.hdu");@\\
\mbox{}\verb@    my $ui = HDiet::user->new();@\\
\mbox{}\verb@    $ui->load(\*FU);@\\
\mbox{}\verb@    close(FU);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($assumed_identity) {@\\
\mbox{}\verb@        if (!$ui->{administrator}) {@\\
\mbox{}\verb@            die("Attempt by non-administrator $user_file_name to assume identity");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $user_name = $effective_user_name;@\\
\mbox{}\verb@        $user_file_name = quoteUserName($user_name);@\\
\mbox{}\verb@        open(FU, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/UserAccount.hdu") ||@\\
\mbox{}\verb@            die("Cannot open effective user account file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/UserAccount.hdu");@\\
\mbox{}\verb@        $ui->load(\*FU);@\\
\mbox{}\verb@        close(FU);@\\
\mbox{}\verb@    } elsif ($browse_public) {@\\
\mbox{}\verb@        my $pn = HDiet::pubname->new();@\\
\mbox{}\verb@        if (defined($pn->findPublicName($effective_user_name))) {@\\
\mbox{}\verb@            $user_name = $pn->{public_name};@\\
\mbox{}\verb@            $user_file_name = quoteUserName($pn->{true_name});@\\
\mbox{}\verb@            open(FU, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/UserAccount.hdu") ||@\\
\mbox{}\verb@                die("Cannot open effective user account file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/UserAccount.hdu");@\\
\mbox{}\verb@            $ui->load(\*FU);@\\
\mbox{}\verb@            close(FU);@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $browse_public = 0;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb190}{190}\NWlink{nuweb208}{, 208}\NWlink{nuweb219}{, 219}\NWlink{nuweb221}{, 221}\NWlink{nuweb224}{, 224}\NWlink{nuweb227}{, 227}\NWlink{nuweb241}{, 241}\NWlink{nuweb244}{, 244}\NWlink{nuweb247}{, 247}\NWlink{nuweb248a}{, 248a}\NWlink{nuweb248b}{b}\NWlink{nuweb249}{, 249}\NWlink{nuweb250}{, 250}\NWlink{nuweb252}{, 252}\NWlink{nuweb254}{, 254}\NWlink{nuweb255}{, 255}\NWlink{nuweb256}{, 256}\NWlink{nuweb257}{, 257}\NWlink{nuweb258}{, 258}\NWlink{nuweb260}{, 260}\NWlink{nuweb262}{, 262}\NWlink{nuweb263a}{, 263a}\NWlink{nuweb264}{, 264}\NWlink{nuweb274}{, 274}\NWlink{nuweb293}{, 293}\NWlink{nuweb294}{, 294}\NWlink{nuweb303}{, 303}\NWlink{nuweb311}{, 311}\NWlink{nuweb313}{, 313}\NWlink{nuweb316}{, 316}\NWlink{nuweb317}{, 317}\NWlink{nuweb320}{, 320}\NWlink{nuweb322}{, 322}\NWlink{nuweb323}{, 323}\NWlink{nuweb325}{, 325}\NWlink{nuweb330}{, 330}\NWlink{nuweb332}{, 332}\NWlink{nuweb334}{, 334}\NWlink{nuweb336}{, 336}\NWlink{nuweb339}{, 339}\NWlink{nuweb343}{, 343}\NWlink{nuweb346}{, 346}\NWlink{nuweb348}{, 348}\NWlink{nuweb358}{, 358}\NWlink{nuweb365}{, 365}\NWlink{nuweb370}{, 370}\NWlink{nuweb374}{, 374}\NWlink{nuweb377}{, 377}\NWlink{nuweb380}{, 380}\NWlink{nuweb382}{, 382}.
\item \NWtxtIdentsUsed\nobreak\  \verb@findPublicName@\nobreak\ \NWlink{nuweb168}{168}, \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}, \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Sanity check year and month specification}

Many transactions include a ``\verb+$CGIargs{m}+'' argument which
specifies the year and month of the log bring processed in
ISO-8601 ({\em YYYY}{\tt -}{\em MM}) format.  This specification
is turned directly into the name of the file containing the
monthly log, so we must be very careful not to allow an abusive
specification which might escape the desired directory.  The
following code, which should be invoked after expansion of
a ``{\tt now}'' specification into the current year and month,
if any, validates strict compliance with the syntax and
reasonableness for the numerical values.  It is permissible to
make this check from transactions which do not return HTML
results, but it must be made before they write their
{\tt Content-type} specification to the result stream.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap302}\raggedright\small
\NWtarget{nuweb207}{} $\langle\,${\itshape Sanity check year and month specification}\nobreak\ {\footnotesize {207}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (!(($CGIargs{m} =~ m/^(\d\d\d\d)\-(\d\d)$/) &&@\\
\mbox{}\verb@        ($1 >= 1980) && ($1 <= ((unix_time_to_civil_date_time($userTime))[0] + 1)) &&@\\
\mbox{}\verb@        ($2 >= 1) && ($2 <= 12))) {@\\
\mbox{}\verb@        if (!$inHTML) {@\\
\mbox{}\verb@            if ($ENV{'REQUEST_METHOD'}) {@\\
\mbox{}\verb@                @\hbox{$\langle\,${\itshape MIME Content-type specification}\nobreak\ {\footnotesize \NWlink{nuweb390a}{390a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            $inHTML = 1;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        write_XHTML_prologue($fh, $homeBase, "Create New User Account", undef, $session->{handheld});@\\
\mbox{}\verb@        my $qm = quoteHTML($CGIargs{m});@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Invalid Log Date Specification</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@Your request specified an invalid date:@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="centred">@\\
\mbox{}\verb@<tt>$qm</tt>@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@for a monthly log.  Dates must be specified as &ldquo;<i>YYYY</i><tt>-</tt><i>MM</i>&rdquo;.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=account&amp;s=$session->{session_id}$tzOff">Return to account home page</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@        last;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb210}{210}\NWlink{nuweb247}{, 247}\NWlink{nuweb263a}{, 263a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}, \verb@unix_time_to_civil_date_time@\nobreak\ \NWlink{nuweb451b}{451b}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Display monthly log}

The monthly log view is the user's main point of interaction
with the application.  The current month's log is displayed
when the user logs in, and the log page contains links to
other components of the application.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap303}\raggedright\small
\NWtarget{nuweb208}{} $\langle\,${\itshape Display monthly log}\nobreak\ {\footnotesize {208}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Determine which monthly log to display}\nobreak\ {\footnotesize \NWlink{nuweb209}{209}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Read log if in database or create blank log if it's not}\nobreak\ {\footnotesize \NWlink{nuweb210}{210}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase,@\\
\mbox{}\verb@        "Monthly log for " . $monthNames[$mlog->{month}] . " " . $mlog->{year},@\\
\mbox{}\verb@        "setResizeEventHandle();", $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id},@\\
\mbox{}\verb@        (($CGIargs{m} eq $nowmonth) ? "Log" : undef),@\\
\mbox{}\verb@        'onclick="return leaveDocument();"', $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<form id="monthlog" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $printFriendly = defined($CGIargs{print}) && $CGIargs{print};@\\
\mbox{}\verb@    my $monochrome = defined($CGIargs{mono}) && $CGIargs{mono};@\\
\mbox{}\verb@    my $printfix = ($printFriendly ? 'pr_' : '') . ($monochrome ? 'mo_' : '');@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Monthly log title and navigation buttons}\nobreak\ {\footnotesize \NWlink{nuweb211}{211}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Set monthly log property variables}\nobreak\ {\footnotesize \NWlink{nuweb212a}{212a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $mlw = $session->{handheld} ? 320 : 640;@\\
\mbox{}\verb@    my $mlh = $session->{handheld} ? 240 : 480;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<div id="canvas" class="canvas"></div>@\\
\mbox{}\verb@<p class="trendan">@\\
\mbox{}\verb@<script type="text/javascript" src="@\hbox{$\langle\,${\itshape Web Document Home}\nobreak\ {\footnotesize \NWlink{nuweb5d}{5d}}$\,\rangle$}\verb@/wz_jsgraphics.js"></script>@\\
\mbox{}\verb@<img id="chart" src="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=chart&amp;s=$session->{session_id}&amp;m=$CGIargs{m}$modeArgs&amp;qx=$cachebuster$tzOff"@\\
\mbox{}\verb@     width="$mlw" height="$mlh" alt="Chart for $monthyear" />@\\
\mbox{}\verb@<br />@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Generate hidden monthly log property fields}\nobreak\ {\footnotesize \NWlink{nuweb213}{213}}$\,\rangle$}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Display trend summary below monthly chart}\nobreak\ {\footnotesize \NWlink{nuweb215}{215}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print($fh "</p>\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $mlog->toHTML($fh, 1, 31,@\\
\mbox{}\verb@        $ui->{display_unit}, $ui->{decimal_character}, $browse_public,@\\
\mbox{}\verb@        $printFriendly, $monochrome);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Monthly log control panel}\nobreak\ {\footnotesize \NWlink{nuweb216}{216}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Dump objects if requested by administrator}\nobreak\ {\footnotesize \NWlink{nuweb218}{218}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@$monthNames@\nobreak\ \NWlink{nuweb388b}{388b}, \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@leaveDocument@\nobreak\ \NWlink{nuweb484b}{484b}, \verb@toHTML@\nobreak\ \NWlink{nuweb36}{36}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Determine which monthly log to display}

The choice of the year and month can be made in a variety of
ways.  In normal navigation, the year and month are passed
as ``{\tt m}'' and ``{\tt y}'' CGI arguments.  The initial
display of the current log after a user logs in is
performed with an argument of ``{\tt now}''.  Arguments of
``{\tt new\_m}'' and ``{\tt new\_y}'' are used when creating
a new log from the selection boxes on the Calendar page.


\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap304}\raggedright\small
\NWtarget{nuweb209}{} $\langle\,${\itshape Determine which monthly log to display}\nobreak\ {\footnotesize {209}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (defined($CGIargs{new_y}) && defined($CGIargs{new_m}) &&@\\
\mbox{}\verb@        (!defined($CGIargs{m}))) {@\\
\mbox{}\verb@        $CGIargs{m} = sprintf("%04d-%02d", $CGIargs{new_y}, $CGIargs{new_m});@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   If the date argument is "now", fill in the current year and month@\\
\mbox{}\verb@    $CGIargs{m} = "now" if !defined($CGIargs{m});@\\
\mbox{}\verb@    my ($year, $mon, $mday, $hour, $min, $sec) =@\\
\mbox{}\verb@        unix_time_to_civil_date_time($userTime);@\\
\mbox{}\verb@    my $nowmonth = sprintf("%04d-%02d", $year, $mon);@\\
\mbox{}\verb@    if ($CGIargs{m} eq "now") {@\\
\mbox{}\verb@        $CGIargs{m} = $nowmonth;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb208}{208}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@min@\nobreak\ \NWlink{nuweb405}{405}, \verb@unix_time_to_civil_date_time@\nobreak\ \NWlink{nuweb451b}{451b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Read log if in database or create blank log if it's not}

If a log exists for this month, load it into a {\tt monthlog} structure.  Should
no log exist (the user wishes to enter data for a new month), we create an
empty log on the fly, plugging in the log weight unit preference from
the {\tt user} object.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap305}\raggedright\small
\NWtarget{nuweb210}{} $\langle\,${\itshape Read log if in database or create blank log if it's not}\nobreak\ {\footnotesize {210}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Sanity check year and month specification}\nobreak\ {\footnotesize \NWlink{nuweb207}{207}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $mlog = HDiet::monthlog->new();@\\
\mbox{}\verb@    if (-f "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$CGIargs{m}.hdb") {@\\
\mbox{}\verb@        open(FL, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$CGIargs{m}.hdb") ||@\\
\mbox{}\verb@            die("Cannot open monthly log file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$CGIargs{m}.hdb");@\\
\mbox{}\verb@        $mlog->load(\*FL);@\\
\mbox{}\verb@        close(FL);@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        $mlog->{login_name} = $user_name;@\\
\mbox{}\verb@        $CGIargs{m} =~ m/(^\d+)\-(\d+)$/;@\\
\mbox{}\verb@        my ($yy, $mm) = ($1, $2);@\\
\mbox{}\verb@        $mlog->{year} = $yy + 0;@\\
\mbox{}\verb@        $mlog->{month} = $mm + 0;@\\
\mbox{}\verb@        $mlog->{log_unit} = $ui->{log_unit};@\\
\mbox{}\verb@        $mlog->{last_modification_time} = 0;@\\
\mbox{}\verb@        $mlog->{trend_carry_forward} = 0;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Fill in trend carry-forward from most recent previous log, if required}\nobreak\ {\footnotesize \NWlink{nuweb214}{214}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb208}{208}\NWlink{nuweb219}{, 219}\NWlink{nuweb248b}{, 248b}\NWlink{nuweb249}{, 249}\NWlink{nuweb263a}{, 263a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Monthly log title and navigation buttons}

Above the monthly chart, a title identifying the year and month
is displayed with two navigation buttons on either side which
select the previous and next month.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap306}\raggedright\small
\NWtarget{nuweb211}{} $\langle\,${\itshape Monthly log title and navigation buttons}\nobreak\ {\footnotesize {211}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $monthyear = $monthNames[$mlog->{month}] . " " . $mlog->{year};@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my ($lasty, $lastm) = $mlog->previousMonth();@\\
\mbox{}\verb@    my $slast = sprintf("%04d-%02d", $lasty, $lastm);@\\
\mbox{}\verb@    my ($slast_link, $slast_button);@\\
\mbox{}\verb@    my $modeArgs = '';@\\
\mbox{}\verb@    $modeArgs .= '&amp;print=y' if $CGIargs{print};@\\
\mbox{}\verb@    $modeArgs .= '&amp;mono=y' if $CGIargs{mono};@\\
\mbox{}\verb@    if ($slast ne '') {@\\
\mbox{}\verb@        $slast_link = "<a class=\"i\" href=\"@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=log&amp;" .@\\
\mbox{}\verb@            "HDiet_tzoffset=$timeZoneOffset&amp;" .@\\
\mbox{}\verb@            "s=$session->{session_id}&amp;m=$slast$modeArgs\" onclick=\"return leaveDocument();\">";@\\
\mbox{}\verb@        if ($session->{handheld}) {@\\
\mbox{}\verb@            $slast_button = "$slast_link<b>&lt;</b></a>";@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $slast_button = "$slast_link<img src=\"$homeBase/figures/prev.png\" class=\"b0\" width=\"32\" height=\"32\" alt=\"Previous month: $slast\" /></a>";@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        if ($session->{handheld}) {@\\
\mbox{}\verb@            $slast_button = "<b>&lt;</b>";@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $slast_button = "<img src=\"$homeBase/figures/prev_gr.png\" class=\"b0\" width=\"32\" height=\"32\" alt=\"No previous month\" />";@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my ($nexty, $nextm) = $mlog->nextMonth();@\\
\mbox{}\verb@    my $snext = sprintf("%04d-%02d", $nexty, $nextm);@\\
\mbox{}\verb@    my ($snext_link, $snext_button);@\\
\mbox{}\verb@    if ($snext ne '') {@\\
\mbox{}\verb@        $snext_link = "<a class=\"i\" href=\"@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=log&amp;" .@\\
\mbox{}\verb@            "HDiet_tzoffset=$timeZoneOffset&amp;" .@\\
\mbox{}\verb@            "s=$session->{session_id}&amp;m=$snext$modeArgs\" onclick=\"return leaveDocument();\">";@\\
\mbox{}\verb@        if ($session->{handheld}) {@\\
\mbox{}\verb@            $snext_button = "$snext_link<b>&gt;</b></a>";@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $snext_button = "$snext_link<img src=\"$homeBase/figures/next.png\" class=\"b0\" width=\"32\" height=\"32\" alt=\"Next month: $snext\" /></a>";@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        if ($session->{handheld}) {@\\
\mbox{}\verb@            $snext_button = "<b>&gt;</b>";@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $snext_button = "<img src=\"$homeBase/figures/next_gr.png\" class=\"b0\" width=\"32\" height=\"32\" alt=\"No next month\" />";@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print($fh "<h1 class=\"${printfix}monthyear\">" .@\\
\mbox{}\verb@              $slast_button .@\\
\mbox{}\verb@              ' &nbsp; <span>' .@\\
\mbox{}\verb@              $monthyear .@\\
\mbox{}\verb@              "</span> &nbsp; $snext_button</h1>\n");@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb208}{208}.
\item \NWtxtIdentsUsed\nobreak\  \verb@$monthNames@\nobreak\ \NWlink{nuweb388b}{388b}, \verb@leaveDocument@\nobreak\ \NWlink{nuweb484b}{484b}, \verb@nextMonth@\nobreak\ \NWlink{nuweb70}{70}, \verb@previousMonth@\nobreak\ \NWlink{nuweb70}{70}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Set monthly log property variables}

The following variables are to set to properties of the monthly
log and user which will appear in the HTML form we're about to
generate.  Many of these will be embedded in the hidden variables
below which serve to pass them to the JavaScript live update code.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap307}\raggedright\small
\NWtarget{nuweb212a}{} $\langle\,${\itshape Set monthly log property variables}\nobreak\ {\footnotesize {212a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $mdays = $mlog->monthdays();@\\
\mbox{}\verb@    my $fracf = $mlog->fractionFlagged();@\\
\mbox{}\verb@    my $mbmi = $mlog->bodyMassIndex($ui->{height});@\\
\mbox{}\verb@    my $lbmi = $mlog->bodyMassIndex($ui->{height}, -1);@\\
\mbox{}\verb@    my $qun = quoteHTML($user_name);@\\
\mbox{}\verb@    my $t0 = $mlog->{trend_carry_forward} * HDiet::monthlog::WEIGHT_CONVERSION->[$mlog->{log_unit}][$ui->{display_unit}];@\\
\mbox{}\verb@    my @{\tt @}\verb@dcalc;@\\
\mbox{}\verb@    if ($ui->{plot_diet_plan}) {@\\
\mbox{}\verb@        @{\tt @}\verb@dcalc = $ui->dietPlanLimits();@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $iscale = $mlog->computeChartScale(640, 480, $ui->{display_unit}, \@{\tt @}\verb@dcalc);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Define ``cachebuster'' argument}\nobreak\ {\footnotesize \NWlink{nuweb212b}{212b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb208}{208}.
\item \NWtxtIdentsUsed\nobreak\  \verb@bodyMassIndex@\nobreak\ \NWlink{nuweb29}{29}, \verb@computeChartScale@\nobreak\ \NWlink{nuweb45}{45}, \verb@dietPlanLimits@\nobreak\ \NWlink{nuweb142}{142}, \verb@fractionFlagged@\nobreak\ \NWlink{nuweb30}{30}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}, \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Define ``cachebuster'' argument}

Some browsers and HTTP proxy servers ignore our ``{\tt Cache-control}''
header item and improperly cache images embedded in pages if their
CGI arguments are the same, even though the image may have changed (for
example, by adding items to a log).  To keep this from happening, we
include a ``cachebuster'' argument named ``{\tt qx}'' (courtesy
of Doc Smith), which is set to a pseudorandom value which will
differ on every request.  This suffices to keep the miscreants in
the middle from caching the image.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap308}\raggedright\small
\NWtarget{nuweb212b}{} $\langle\,${\itshape Define ``cachebuster'' argument}\nobreak\ {\footnotesize {212b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $cachebuster = sprintf("%x", (int(rand(65536))) & 0xFFFF);@\\
\mbox{}\verb@    $cachebuster =~ tr/a-f/FGJKQW/;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb212a}{212a}\NWlink{nuweb297}{, 297}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Generate hidden monthly log property fields}

The following hidden input fields serve as fixed arguments to
the form and to provide the JaavScript live update code access
to quantities it needs to update the log and chart.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap309}\raggedright\small
\NWtarget{nuweb213}{} $\langle\,${\itshape Generate hidden monthly log property fields}\nobreak\ {\footnotesize {213}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@<input type="hidden" name="q" value="update_log" />@\\
\mbox{}\verb@<input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@<input type="hidden" name="m" value="$CGIargs{m}" />@\\
\mbox{}\verb@<input type="hidden" name="md" id="md" value="$mdays" />@\\
\mbox{}\verb@<input type="hidden" name="t0" id="t0" value="$t0" />@\\
\mbox{}\verb@<input type="hidden" name="du" id="du" value="$ui->{display_unit}" />@\\
\mbox{}\verb@<input type="hidden" name="hgt" id="hgt" value="$ui->{height}" />@\\
\mbox{}\verb@<input type="hidden" name="dc" id="dc" value="$ui->{decimal_character}" />@\\
\mbox{}\verb@<input type="hidden" name="sc" id ="sc" value="$iscale" />@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb208}{208}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}


\vbox{
\subsubsection{Fill in trend carry-forward from most recent previous log, if required}

No log exists in the database for this month, so we've created a
blank log for this month (which won't be added to the database
until until and unless the user saves it).  Now we need to find
the most recent log in the database and fill in its final trend
value as the trend carry-forward for this probationary new log.
We need to do this now, as opposed to propagating the trend from
the previous log when the log is saved, because the trend
carry=forward is needed by the JavaScript code to perform live
trend updates when the user enters weights.

This code also handles supplying trend carry-forwards for logs in the
database which somehow happened to end up with a zero carry-forward.
This shouldn't happen, but should some obscure import circumstance
or other operation result in such a log making it to the database,
this will keep it from confusing the user adding entries to it, and
the problem will be corrected when the log is saved.

Note that we must cope with the possibility that the weight unit
in the newly created log may differ from that of the most recent
log.  This happens when the user changes the log unit setting
to one different from that of the existing log.  In this
circumstance, we must convert the trend value to the units of
the new log.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap310}\raggedright\small
\NWtarget{nuweb214}{} $\langle\,${\itshape Fill in trend carry-forward from most recent previous log, if required}\nobreak\ {\footnotesize {214}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($mlog->{trend_carry_forward} == 0) {@\\
\mbox{}\verb@        my $cmon = sprintf("%04d-%02d", $mlog->{year}, $mlog->{month});@\\
\mbox{}\verb@        my @{\tt @}\verb@logs = $ui->enumerateMonths();@\\
\mbox{}\verb@        for (my $m = $#logs; $m >= 0; $m--) {@\\
\mbox{}\verb@            if ($logs[$m] lt $cmon) {@\\
\mbox{}\verb@                my $llog = HDiet::monthlog->new();@\\
\mbox{}\verb@                open(LL, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$logs[$m].hdb") ||@\\
\mbox{}\verb@                    die("Cannot open previous monthly log file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$logs[$m].hdb");@\\
\mbox{}\verb@                $llog->load(\*LL);@\\
\mbox{}\verb@                close(LL);@\\
\mbox{}\verb@                for (my $d = $llog->monthdays(); $d >= 1; $d--) {@\\
\mbox{}\verb@                    if ($llog->{trend}[$d]) {@\\
\mbox{}\verb@                        $mlog->{trend_carry_forward} = $llog->{trend}[$d] *@\\
\mbox{}\verb@                            HDiet::monthlog::WEIGHT_CONVERSION->[$llog->{log_unit}][$mlog->{log_unit}];;@\\
\mbox{}\verb@                        last;@\\
\mbox{}\verb@                    }@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@                last;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb210}{210}.
\item \NWtxtIdentsUsed\nobreak\  \verb@enumerateMonths@\nobreak\ \NWlink{nuweb140}{140}, \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Display trend summary below monthly chart}

Below the monthly chart we display a trend analysis and,
if the user has specified a height, the body mass index
value.  The HTML code for this section is complicated by the
need to include ``{\tt id=} attributes so that the JavaScript
live update code can modify these values as log entries are
modified.

If we're displaying an historical chart (one older than the
most recent in the database), we fit the trend slope based
on the data plotted in the chart: what you see is what you get.
When plotting the most recent chart (usually the current month's),
we create a {\tt history} object and use it to fit a trend for the
last week's data (even if this requires retrieving data for
the end of the previous month).  This avoids discontinuous jumps
in the trend analysis at the start of a month, where there are
only a few data points to fit, and makes the data plotted in
the current chart always agree with the ``Last Week'' analysis
in the Trend Analysis page.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap311}\raggedright\small
\NWtarget{nuweb215}{} $\langle\,${\itshape Display trend summary below monthly chart}\nobreak\ {\footnotesize {215}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $tslope = 0;@\\
\mbox{}\verb@    my $hist = HDiet::history->new($ui, $user_file_name);@\\
\mbox{}\verb@    my ($ly, $lm, $ld, $ldu, $lw, $lt) = $hist->lastDay();@\\
\mbox{}\verb@@\\
\mbox{}\verb@#print(STDERR "Last day: $ly-$lm-$ld  ($mlog->{year}-$mlog->{month})   Lw $lw   Lt $lt\n");@\\
\mbox{}\verb@    if (defined($lw) &&@\\
\mbox{}\verb@        ($mlog->{year} == $ly) &&@\\
\mbox{}\verb@        ($mlog->{month} == $lm)) {@\\
\mbox{}\verb@#print(STDERR "Computed trend the hard way for $ly-$lm-$ld\n");@\\
\mbox{}\verb@        my $l_jd = gregorian_to_jd($ly, $lm, $ld);@\\
\mbox{}\verb@        my ($s_y, $s_m, $s_d) = $hist->firstDay();@\\
\mbox{}\verb@        my $s_jd = gregorian_to_jd($s_y, $s_m, $s_d);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my (@{\tt @}\verb@intervals, @{\tt @}\verb@slopes);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (($l_jd - $s_jd) > 1) {@\\
\mbox{}\verb@            my ($f_y, $f_m, $f_d) = $hist->firstDayOfInterval($ly, $lm, $ld, 7);@\\
\mbox{}\verb@            my $f_jd = gregorian_to_jd($f_y, $f_m, $f_d);@\\
\mbox{}\verb@            push(@{\tt @}\verb@intervals, sprintf("%04d-%02d-%02d", $f_y, $f_m, $f_d),@\\
\mbox{}\verb@                              sprintf("%04d-%02d-%02d", $ly, $lm, $ld));@\\
\mbox{}\verb@            @{\tt @}\verb@slopes = $hist->analyseTrend(@{\tt @}\verb@intervals);@\\
\mbox{}\verb@            $tslope = $slopes[0];@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@#print(STDERR "Computed trend the easy way for $ly-$lm-$ld\n");@\\
\mbox{}\verb@        $tslope = $mlog->computeTrend();@\\
\mbox{}\verb@        $tslope *= HDiet::monthlog::WEIGHT_CONVERSION->[$mlog->{log_unit}][$ui->{display_unit}];@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    my $sweekly = $ui->localiseDecimal(sprintf("%.2f", abs($tslope) * 7));@\\
\mbox{}\verb@    print($fh 'Weekly <span id="delta_sign">' .@\\
\mbox{}\verb@            (($tslope > 0) ? "gain" : "loss") .@\\
\mbox{}\verb@            "</span> <span id=\"weekly_delta\">$sweekly</span> " .@\\
\mbox{}\verb@            $mlog->DELTA_WEIGHT_UNITS->[$ui->{display_unit}] .@\\
\mbox{}\verb@            "s.  Daily <span id=\"calorie_sign\">" .@\\
\mbox{}\verb@            (($tslope > 0) ? "excess" : "deficit") .@\\
\mbox{}\verb@            sprintf("</span>: <span id=\"daily_calories\">%.0f</span> ", abs($tslope) *@\\
\mbox{}\verb@                ($mlog->CALORIES_PER_WEIGHT_UNIT->[$ui->{display_unit}] /@\\
\mbox{}\verb@                $mlog->CALORIES_PER_ENERGY_UNIT->[$ui->{energy_unit}])) .@\\
\mbox{}\verb@            $mlog->ENERGY_UNITS->[$ui->{energy_unit}] . "s" .@\\
\mbox{}\verb@            "." .@\\
\mbox{}\verb@            (($fracf > 0) ? sprintf("  <span id=\"fracf\" " .@\\
\mbox{}\verb@                "style=\"display: inline;\"><span id=\"percent_flagged\">" .@\\
\mbox{}\verb@                "%.0f%%</span> flagged.</span>", $fracf * 100) :@\\
\mbox{}\verb@                            sprintf("  <span id=\"fracf\" " .@\\
\mbox{}\verb@                "style=\"display: none;\"><span id=\"percent_flagged\">" .@\\
\mbox{}\verb@                "%.0f%%</span> flagged.</span>", $fracf * 100)));@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($mbmi > 0) {@\\
\mbox{}\verb@        my ($lmbmi, $llbmi) = ($ui->localiseDecimal($mbmi), $ui->localiseDecimal($lbmi));@\\
\mbox{}\verb@        print($fh "\n<span id=\"bmi\" style=\"display: inline;\">" .@\\
\mbox{}\verb@            "<br />\nBody mass index: mean <span id=\"mean_bmi\">" .@\\
\mbox{}\verb@            "$lmbmi</span>, most recent <span id=\"last_bmi\">$llbmi</span>.</span>\n");@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        print($fh "\n<span id=\"bmi\" style=\"display: none;\">" .@\\
\mbox{}\verb@            "<br />\nBody mass index: mean <span id=\"mean_bmi\">" .@\\
\mbox{}\verb@            "???</span>, most recent <span id=\"last_bmi\">???</span>.</span>\n");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb208}{208}.
\item \NWtxtIdentsUsed\nobreak\  \verb@analyseTrend@\nobreak\ \NWlink{nuweb79}{79}, \verb@CALORIES_PER_ENERGY_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@CALORIES_PER_WEIGHT_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@computeTrend@\nobreak\ \NWlink{nuweb28}{28}, \verb@ENERGY_UNITS@\nobreak\ \NWlink{nuweb24}{24}, \verb@firstDay@\nobreak\ \NWlink{nuweb109a}{109a}, \verb@firstDayOfInterval@\nobreak\ \NWlink{nuweb111}{111}, \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}, \verb@lastDay@\nobreak\ \NWlink{nuweb108}{108}, \verb@localiseDecimal@\nobreak\ \NWlink{nuweb146b}{146b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Monthly log control panel}

For regular logins, the the monthly log control panel consists of just
the ``Update'' and ``Reset'' buttons.  For administrator logins or
access to another account, three checkboxes are displayed which allow
the {\tt monthlog}, {\tt user}, and/or {\tt session} objects to be
displayed.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap312}\raggedright\small
\NWtarget{nuweb216}{} $\langle\,${\itshape Monthly log control panel}\nobreak\ {\footnotesize {216}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($browse_public) {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        my $ckprint = $CGIargs{print} ? ' checked="checked"' : '';@\\
\mbox{}\verb@        my $ckmono = $CGIargs{mono} ? ' checked="checked"' : '';@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<input type="submit" value=" Update " />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="reset" onclick="unsavedChanges = 0;" value=" Reset " />@\\
\mbox{}\verb@<br />@\\
\mbox{}\verb@<label><input type="checkbox" name="print" value="y"$ckprint  />&nbsp;Printer&nbsp;friendly</label>@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<label><input type="checkbox" name="mono" value="y"$ckmono  />&nbsp;Monochrome</label>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Administrator object dump selection}\nobreak\ {\footnotesize \NWlink{nuweb217}{217}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb208}{208}.
\item \NWtxtIdentsUsed\nobreak\  \verb@unsavedChanges@\nobreak\ \NWlink{nuweb484a}{484a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Administrator object dump selection}

By checking one or more of the following checkboxes,
the administrator can request a dump of the
{\tt monthlog}, {\tt user}, and/or {\tt session}
objects.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap313}\raggedright\small
\NWtarget{nuweb217}{} $\langle\,${\itshape Administrator object dump selection}\nobreak\ {\footnotesize {217}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($ui->{administrator} || $assumed_identity) {@\\
\mbox{}\verb@        my $ckdl = $CGIargs{dumplog} ? ' checked="checked"' : '';@\\
\mbox{}\verb@        my $ckdu = $CGIargs{dumpuser} ? ' checked="checked"' : '';@\\
\mbox{}\verb@        my $ckds = $CGIargs{dumpsession} ? ' checked="checked"' : '';@\\
\mbox{}\verb@        my $ckde = $CGIargs{dumpenvironment} ? ' checked="checked"' : '';@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<br />@\\
\mbox{}\verb@Dump: <label><input type="checkbox" name="dumplog" value="y"$ckdl  />&nbsp;Log</label>@\\
\mbox{}\verb@      <label><input type="checkbox" name="dumpuser" value="y"$ckdu  />&nbsp;User</label>@\\
\mbox{}\verb@      <label><input type="checkbox" name="dumpsession" value="y"$ckds  />&nbsp;Session</label>@\\
\mbox{}\verb@      <label><input type="checkbox" name="dumpenvironment" value="y"$ckde  />&nbsp;Environment</label>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb216}{216}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Dump objects if requested by administrator}

If the administrator has checked one or more of the object dump
boxes at the bottom of the monthly log form (either in the
administrator's own account or when accessing another user's
account), perform the dump.  Note that since the object dump
methods write to a file, we need to capture the output in a
temporary file and then run it through {\tt quoteHTMLFile}
to quote the output for inclusion in an HTML \verb+<pre>+
section.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap314}\raggedright\small
\NWtarget{nuweb218}{} $\langle\,${\itshape Dump objects if requested by administrator}\nobreak\ {\footnotesize {218}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($ui->{administrator} || $assumed_identity) {@\\
\mbox{}\verb@@\\
\mbox{}\verb@        sub describeHTML {@\\
\mbox{}\verb@            my ($object, $fh, $title) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@            print($fh "<h4>$title</h4>\n") if $title;@\\
\mbox{}\verb@            print($fh "<pre style=\"unicode-bidi: bidi-override;\">\n");@\\
\mbox{}\verb@            use File::Temp qw(tempfile);@\\
\mbox{}\verb@            my $tfh = tempfile();@\\
\mbox{}\verb@            binmode($tfh, ":utf8");@\\
\mbox{}\verb@            $object->describe($tfh);@\\
\mbox{}\verb@            seek($tfh, 0, 0);@\\
\mbox{}\verb@            quoteHTMLFile($tfh, $fh);@\\
\mbox{}\verb@            close($tfh);@\\
\mbox{}\verb@            print($fh "</pre>\n");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($CGIargs{dumplog}) {@\\
\mbox{}\verb@            describeHTML($mlog, $fh, "Log");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if ($CGIargs{dumpuser}) {@\\
\mbox{}\verb@            describeHTML($ui, $fh, "User");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if ($CGIargs{dumpsession}) {@\\
\mbox{}\verb@            describeHTML($session, $fh, "Session");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if ($CGIargs{dumpenvironment}) {@\\
\mbox{}\verb@            use Data::Dumper;@\\
\mbox{}\verb@            my $denv = Data::Dumper->Dump([\%CGIargs, \%ENV], ['*CGIargs', '*ENV']);@\\
\mbox{}\verb@            $denv = quoteHTML($denv);@\\
\mbox{}\verb@            print($fh "<h4>Environment</h4>\n");@\\
\mbox{}\verb@            print($fh "<pre style=\"unicode-bidi: bidi-override;\">\n");@\\
\mbox{}\verb@            print($fh $denv);@\\
\mbox{}\verb@            print($fh "</pre>\n");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb208}{208}.
\item \NWtxtIdentsUsed\nobreak\  \verb@describe@\nobreak\ \NWlink{nuweb27}{27}\NWlink{nuweb122}{, 122}\NWlink{nuweb150}{, 150}\NWlink{nuweb156a}{, 156a}, \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}, \verb@quoteHTMLFile@\nobreak\ \NWlink{nuweb439}{439}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Update monthly log}

The changes made by the user in a monthly log form are applied to the log
item in the database, which is written back if any changes were made.  Note
that this code must handle the case where there is no existing item for this
month in the database, as the user may be making the first entries for this
month.

An update is logged in the history file as a type 5 transaction, with the extra
fields indicating the month updated, and the total number of changes and
changes to weight, rung, flag, and comment fields separately.  If the month
updated is not the most recent in the database (which we detect by comparing
its date against the current date), and any weights were changed, then the
resulting change to the final trend for the month must ne propagated to subsequent
months in the database.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap315}\raggedright\small
\NWtarget{nuweb219}{} $\langle\,${\itshape Update monthly log}\nobreak\ {\footnotesize {219}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Read log if in database or create blank log if it's not}\nobreak\ {\footnotesize \NWlink{nuweb210}{210}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my ($changes, $change_weight, $change_rung,@\\
\mbox{}\verb@        $change_flag, $change_comment) = $mlog->updateFromCGI(\%CGIargs);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Write updated log item back to database}\nobreak\ {\footnotesize \NWlink{nuweb220a}{220a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   Enqueue a transaction to display the updated log@\\
\mbox{}\verb@        %CGIargs = (@\\
\mbox{}\verb@            q => "log",@\\
\mbox{}\verb@            s => $session->{session_id},@\\
\mbox{}\verb@            m => $CGIargs{m},@\\
\mbox{}\verb@            dumplog => $CGIargs{dumplog},@\\
\mbox{}\verb@            dumpuser => $CGIargs{dumpuser},@\\
\mbox{}\verb@            dumpsession => $CGIargs{dumpsession},@\\
\mbox{}\verb@            dumpenvironment => $CGIargs{dumpenvironment},@\\
\mbox{}\verb@            print => $CGIargs{print},@\\
\mbox{}\verb@            mono => $CGIargs{mono},@\\
\mbox{}\verb@        );@\\
\mbox{}\verb@        next;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@updateFromCGI@\nobreak\ \NWlink{nuweb56}{56}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Write updated log item back to database}

If any changes were made in the log, write it back to the database,
note the modification in the user's transaction history log, and
update the time of the last transaction from this user.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap316}\raggedright\small
\NWtarget{nuweb220a}{} $\langle\,${\itshape Write updated log item back to database}\nobreak\ {\footnotesize {220a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (($changes > 0) && (!$readOnly)) {@\\
\mbox{}\verb@        $mlog->{last_modification_time} = time();@\\
\mbox{}\verb@        open(FL, ">:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$CGIargs{m}.hdb") ||@\\
\mbox{}\verb@            die("Cannot update monthly log file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$CGIargs{m}.hdb");@\\
\mbox{}\verb@        $mlog->save(\*FL);@\\
\mbox{}\verb@        close(FL);@\\
\mbox{}\verb@        clusterCopy("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$CGIargs{m}.hdb");@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($ui->{badge_trend} != 0) {@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Update Web page badge}\nobreak\ {\footnotesize \NWlink{nuweb220b}{220b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        append_history($user_file_name, 5,@\\
\mbox{}\verb@            "$CGIargs{m},$changes,$change_weight,$change_rung,$change_flag,$change_comment");@\\
\mbox{}\verb@@\\
\mbox{}\verb@        update_last_transaction($user_file_name);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($change_weight > 0) {@\\
\mbox{}\verb@#print("Propagating trend starting at $CGIargs{m}<br />\n");@\\
\mbox{}\verb@            propagate_trend($ui, $CGIargs{m}, 0);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb219}{219}.
\item \NWtxtIdentsUsed\nobreak\  \verb@append_history@\nobreak\ \NWlink{nuweb397}{397}, \verb@propagate_trend@\nobreak\ \NWlink{nuweb392}{392}, \verb@save@\nobreak\ \NWlink{nuweb31}{31}\NWlink{nuweb123}{, 123}\NWlink{nuweb151}{, 151}\NWlink{nuweb156b}{, 156b}, \verb@update_last_transaction@\nobreak\ \NWlink{nuweb398}{398}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Update Web page badge}

When a change is made to a monthly log or to the badge configuration,
we re-generate the badge image served to requesters by the
{\tt HackDietBadge} program (page~\pageref{HackDietBadge}).  The
badge is generated in a temporary file and then renamed to the
badge file name to avoid race conditions when the badge is being
updated and served to a requester at the same time.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap317}\raggedright\small
\NWtarget{nuweb220b}{} $\langle\,${\itshape Update Web page badge}\nobreak\ {\footnotesize {220b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    open(FB, ">@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/BadgeImageNew.png") ||@\\
\mbox{}\verb@        die("Cannot update monthly log file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/BadgeImageNew.png");@\\
\mbox{}\verb@    my $hist = HDiet::history->new($ui, $user_file_name);@\\
\mbox{}\verb@    $hist->drawBadgeImage(\*FB, $ui->{badge_trend});@\\
\mbox{}\verb@    close(FB);@\\
\mbox{}\verb@    do_command("mv @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/BadgeImageNew.png @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/BadgeImage.png");@\\
\mbox{}\verb@    clusterCopy("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/BadgeImage.png");@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb220a}{220a}\NWlink{nuweb244}{, 244}.
\item \NWtxtIdentsUsed\nobreak\  \verb@do_command@\nobreak\ \NWlink{nuweb406a}{406a}, \verb@drawBadgeImage@\nobreak\ \NWlink{nuweb101a}{101a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Display calendar navigation page}

The calendar page provides the primary means of access to the
database of monthly logs.  For each year with a log in the database,
a calendar is generated with links for months in the database
which display the log.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap318}\raggedright\small
\NWtarget{nuweb221}{} $\langle\,${\itshape Display calendar navigation page}\nobreak\ {\footnotesize {221}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $calPerLine = 4;             # Calendars per line@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $qun = quoteHTML($user_name);@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Choose Monthly Log", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, "History", undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $calPerLine = 1 if $session->{handheld};@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Choose Monthly Log</h1>@\\
\mbox{}\verb@<table class="list_of_calendars">@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my ($intr, $calsline) = (0, 0);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@years = $ui->enumerateYears();@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate table of yearly calendars}\nobreak\ {\footnotesize \NWlink{nuweb222}{222}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($intr) {@\\
\mbox{}\verb@        print($fh "</tr>\n");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@</table>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (!$browse_public) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape New monthly log creation form}\nobreak\ {\footnotesize \NWlink{nuweb223}{223}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    update_last_transaction($user_file_name);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@enumerateYears@\nobreak\ \NWlink{nuweb141}{141}, \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}, \verb@update_last_transaction@\nobreak\ \NWlink{nuweb398}{398}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Generate table of yearly calendars}

Having obtained a list of all the years for which logs exist
in the database, we iterate over the years and generate tables
for all years which have one or more monthly logs in the database.
This is all wrapped into an XHTML table with
\verb+$calPerLine+ yearly calendars per row.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap319}\raggedright\small
\NWtarget{nuweb222}{} $\langle\,${\itshape Generate table of yearly calendars}\nobreak\ {\footnotesize {222}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $y = 0; $y <= $#years; $y++) {@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (!$intr) {@\\
\mbox{}\verb@            print($fh "<tr>\n");@\\
\mbox{}\verb@            $intr = 1;@\\
\mbox{}\verb@            $calsline = 0;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($calsline >= $calPerLine) {@\\
\mbox{}\verb@            print($fh "</tr><tr>\n");@\\
\mbox{}\verb@            $calsline = 0;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<td><table class="calendar" border="border">@\\
\mbox{}\verb@<tr><th colspan="3">$years[$y]</th></tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        my @{\tt @}\verb@months = $ui->enumerateMonths($years[$y]);@\\
\mbox{}\verb@        my $m = 0;@\\
\mbox{}\verb@        for (my $i = 0; $i < 4; $i++) {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@    <tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@            for (my $j = 0; $j < 3; $j++) {@\\
\mbox{}\verb@                $m++;@\\
\mbox{}\verb@                print($fh "        <td>");@\\
\mbox{}\verb@                my $ym = sprintf("%04d-%02d", $years[$y], $m);@\\
\mbox{}\verb@                my $havemonth = 0;@\\
\mbox{}\verb@                for (my $k = 0; $k <= $#months; $k++) {@\\
\mbox{}\verb@                    if ($months[$k] eq $ym) {@\\
\mbox{}\verb@                        print($fh "<a href=\"@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session->{session_id}&amp;q=log&amp;m=$ym$tzOff\">");@\\
\mbox{}\verb@                        $havemonth = 1;@\\
\mbox{}\verb@                        last;@\\
\mbox{}\verb@                    }@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@                print($fh substr($monthNames[$m], 0, 3));@\\
\mbox{}\verb@                if ($havemonth) {@\\
\mbox{}\verb@                    print($fh "</a>");@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@                print($fh "</td>\n");@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@</table></td>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        $calsline++;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb221}{221}.
\item \NWtxtIdentsUsed\nobreak\  \verb@$monthNames@\nobreak\ \NWlink{nuweb388b}{388b}, \verb@enumerateMonths@\nobreak\ \NWlink{nuweb140}{140}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{New monthly log creation form}

Generate an HTML form which allows the user to create a new
monthly log.  All this actually does is invoke the monthly
log display transaction with the specified year and month; the
monthly log form already knows how to create blank logs for
months not present in the database.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap320}\raggedright\small
\NWtarget{nuweb223}{} $\langle\,${\itshape New monthly log creation form}\nobreak\ {\footnotesize {223}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<form id="Hdiet_create_new_monthly_log" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@<p>@\\
\mbox{}\verb@<input type="hidden" name="q" value="log" />@\\
\mbox{}\verb@<input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@<b>Create/display log for:</b>@\\
\mbox{}\verb@<select name="new_m" id="new_m">@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my ($year, $mon, $mday, $hour, $min, $sec) =@\\
\mbox{}\verb@        unix_time_to_civil_date_time($userTime);@\\
\mbox{}\verb@    for (my $i = 1; $i <= 12; $i++) {@\\
\mbox{}\verb@        my $sel = ($i == $mon) ? ' selected="selected"' : '';@\\
\mbox{}\verb@        print($fh "<option value=\"$i\"$sel>$monthNames[$i]</option>\n")@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@</select>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<select name="new_y" id="new_y">@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $y = $year; $y >= 1985; $y--) {@\\
\mbox{}\verb@        print($fh "<option>$y</option>\n")@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@</select>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<label title="Create/display log for the specified month and year"><input type="submit" value=" Create Log " /></label>@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb221}{221}.
\item \NWtxtIdentsUsed\nobreak\  \verb@min@\nobreak\ \NWlink{nuweb405}{405}, \verb@unix_time_to_civil_date_time@\nobreak\ \NWlink{nuweb451b}{451b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Display CSV import request form}

A user can import log items into a database from CSV files
in either the form created by saving an Excel weight log
or those written by {\tt hdread} from Palm database
backups.  The CSV file can either be uploaded from a file
on the local computer or pasted into a text box on the
import request form itself.


\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap321}\raggedright\small
\NWtarget{nuweb224}{} $\langle\,${\itshape Display CSV import request form}\nobreak\ {\footnotesize {224}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Import CSV or XML Database", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Import CSV or XML Database</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@You can import log entries from CSV files either saved from Excel@\\
\mbox{}\verb@logs or exported from a backup of a Palm database with the@\\
\mbox{}\verb@<tt>hdread</tt> program.  You can also import XML database backups@\\
\mbox{}\verb@from this application.  Logs in any format can either be uploaded from a@\\
\mbox{}\verb@file on your computer or simply pasted into the text box below.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@Normally, log entries from files you import will not overwrite@\\
\mbox{}\verb@existing entries in the online database; if one or more fields in@\\
\mbox{}\verb@a daily entry are nonblank, they will not be replaced by the@\\
\mbox{}\verb@contents of a record for the same day in the imported file.  If you wish@\\
\mbox{}\verb@to have records imported from the file override existing records,@\\
\mbox{}\verb@check the &ldquo;Allow overwrite&rdquo; box in the import request.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<div>@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape CSV file upload import form}\nobreak\ {\footnotesize \NWlink{nuweb225}{225}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@<br />@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape CSV direct upload import form}\nobreak\ {\footnotesize \NWlink{nuweb226a}{226a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@<br />@\\
\mbox{}\verb@</div>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=account&amp;s=$session->{session_id}$tzOff">Back to account page</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    update_last_transaction($user_file_name);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@update_last_transaction@\nobreak\ \NWlink{nuweb398}{398}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{CSV file upload import form}

The fields in this fieldset allow the user to specify a local
file containing CSV or XML to be imported.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap322}\raggedright\small
\NWtarget{nuweb225}{} $\langle\,${\itshape CSV file upload import form}\nobreak\ {\footnotesize {225}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@<fieldset id="Hdiet_CSV_upload_fs"><legend>Import CSV or XML by File Upload</legend>@\\
\mbox{}\verb@<form id="Hdiet_CSV_upload" enctype="multipart/form-data"@\\
\mbox{}\verb@    method="post" action="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?enc=raw$tzOff">@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@  <p>@\\
\mbox{}\verb@    <label title="Choose a Local CSV or XML File to Upload and Import" for="uploaded_file">Local File:</label>@\\
\mbox{}\verb@    <input type="file" id="uploaded_file" name="uploaded_file" size="30" />@\\
\mbox{}\verb@    <input type="hidden" name="q" value="csv_import_data" />@\\
\mbox{}\verb@    <input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@    <label title="Upload and import CSV or XML file"><input type="submit" value=" Import " /></label>@\\
\mbox{}\verb@    <br />@\\
\mbox{}\verb@    <label><input type="checkbox" name="overwrite" value="y" />&nbsp;Allow&nbsp;overwrite</label>@\\
\mbox{}\verb@    <label><input type="checkbox" name="listimp" value="y" />&nbsp;List&nbsp;imported&nbsp;records</label>@\\
\mbox{}\verb@  </p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p>@\\
\mbox{}\verb@Select the file you wish to upload and import.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@</fieldset>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb224}{224}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{CSV direct upload import form}

The fields in this fieldset allow the user to directly paste
CSV or XML into a {\tt textarea} box, which is sent with the form
to be imported.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap323}\raggedright\small
\NWtarget{nuweb226a}{} $\langle\,${\itshape CSV direct upload import form}\nobreak\ {\footnotesize {226a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@<fieldset class="front" id="Hdiet_CSV_submit_fs"><legend>Import Pasted CSV or XML Log Entries</legend>@\\
\mbox{}\verb@<form id="Hdiet_CSV_submit" enctype="multipart/form-data"@\\
\mbox{}\verb@    method="post" action="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@">@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ ({\footnotesize 226b\label{scrap324}
 }\mbox{}\verb@1@ ) {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@<p>Paste the CSV or XML you wish to import in the text area below:</p>@\\
\mbox{}\verb@<p>@\\
\mbox{}\verb@    <label title="Paste the CSV or XML log entries here" for="file">@\\
\mbox{}\verb@    <textarea cols="75" rows="12" name="file" id="file"></textarea></label><br />@\\
\mbox{}\verb@    <input type="hidden" name="q" value="csv_import_data" />@\\
\mbox{}\verb@    <input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@    <label title="Import CSV or XML log entries"><input type="submit" value=" Import " /></label>@\\
\mbox{}\verb@    <label title="Clear the entry field"><input type="reset" value=" Clear " /></label>@\\
\mbox{}\verb@    <label><input type="checkbox" name="overwrite" value="y" />&nbsp;Allow&nbsp;overwrite</label>@\\
\mbox{}\verb@    <label><input type="checkbox" name="listimp" value="y" />&nbsp;List&nbsp;imported&nbsp;records</label>@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@</fieldset>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb224}{224}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Import uploaded CSV log entries}

This task is invoked when the user uploads log entries in CSV or XML
format.  We automatically determine whether they were in XML, exported
from an Excel log, written by {\tt hdread}, or exported in CSV from
this application and parse them accordingly.  Note that for this
determination to be correct, it is essential that the user include
all the header lines in the CSV.  We make no assumptions about the
order of log items imported, but the header lines must be
at the top.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap325}\raggedright\small
\NWtarget{nuweb227}{} $\langle\,${\itshape Import uploaded CSV log entries}\nobreak\ {\footnotesize {227}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Database Imported", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Database Imported</h1>@\\
\mbox{}\verb@<form id="Hdiet_CSV_import_confirmation" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@The submitted log items have been processed as follows.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<input type="hidden" name="q" value="account" />@\\
\mbox{}\verb@<input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@<input type="submit" name="account" value=" Return to Account Page " />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb227}{227}\NWlink{nuweb228a}{, 228a}\NWlink{nuweb228b}{b}\NWlink{nuweb229}{, 229}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{

Initialise variables for the database import process.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap326}\raggedright\small
\NWtarget{nuweb228a}{} $\langle\,${\itshape Import uploaded CSV log entries}\nobreak\ {\footnotesize {228a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $listStyle;@\\
\mbox{}\verb@    my ($imp, $over);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $csv = HDiet::Text::CSV->new();@\\
\mbox{}\verb@    my ($n, $imported, $noparse, $already, $notentry) = (0, 0, 0, 0, 0);@\\
\mbox{}\verb@    my (%mondb, %monchanges);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $overwrite = defined($CGIargs{overwrite});@\\
\mbox{}\verb@    my $listCSV = defined($CGIargs{listimp});@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   Set log format and weight unit unknown@\\
\mbox{}\verb@    my ($logFormat, $csvUnit, $hdOnlineLog) = ('Unknown', -1, 0);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb227}{227}\NWlink{nuweb228a}{, 228a}\NWlink{nuweb228b}{b}\NWlink{nuweb229}{, 229}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{

Import the records, producing an annotated list of items
imported if requested.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap327}\raggedright\small
\NWtarget{nuweb228b}{} $\langle\,${\itshape Import uploaded CSV log entries}\nobreak\ {\footnotesize {228b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($listCSV) {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<pre>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($CGIargs{file} =~ m/\s*<\?xml\s+/) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Import log items from XML database file}\nobreak\ {\footnotesize \NWlink{nuweb230}{230}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Import log items from CSV database file}\nobreak\ {\footnotesize \NWlink{nuweb233}{233}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Write back logs modified by database import}\nobreak\ {\footnotesize \NWlink{nuweb240a}{240a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($listCSV) {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@</pre>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Append summary of records imported}\nobreak\ {\footnotesize \NWlink{nuweb240b}{240b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb227}{227}\NWlink{nuweb228a}{, 228a}\NWlink{nuweb228b}{b}\NWlink{nuweb229}{, 229}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@xml@\nobreak\ \NWlink{nuweb440}{440}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{

Add a history record summarising the records imported and update
the user's last transaction time.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap328}\raggedright\small
\NWtarget{nuweb229}{} $\langle\,${\itshape Import uploaded CSV log entries}\nobreak\ {\footnotesize {229}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (!$readOnly) {@\\
\mbox{}\verb@        my $histrec = "$logFormat,$overwrite,$imported,$notentry,$already,$noparse";@\\
\mbox{}\verb@        foreach $md (sort(keys(%mondb))) {@\\
\mbox{}\verb@            if ($monchanges{$md} > 0) {@\\
\mbox{}\verb@                $histrec .= ",$md,$monchanges{$md}";@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        append_history($user_file_name, 7, "$histrec");@\\
\mbox{}\verb@@\\
\mbox{}\verb@        update_last_transaction($user_file_name);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb227}{227}\NWlink{nuweb228a}{, 228a}\NWlink{nuweb228b}{b}\NWlink{nuweb229}{, 229}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@append_history@\nobreak\ \NWlink{nuweb397}{397}, \verb@update_last_transaction@\nobreak\ \NWlink{nuweb398}{398}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Import log items from XML database file}

This appears to be an XML database export file.  Parse it with the
XML parser, then walk through the document tree and import the
log entries it contains.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap329}\raggedright\small
\NWtarget{nuweb230}{} $\langle\,${\itshape Import log items from XML database file}\nobreak\ {\footnotesize {230}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $parser = XML::LibXML->new();@\\
\mbox{}\verb@    my $doc = $parser->parse_string($CGIargs{file});@\\
\mbox{}\verb@    my $root = $doc->getDocumentElement();@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $indent = '';@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my %logItem;@\\
\mbox{}\verb@    my ($logYear, $logMonth);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $logFormat = 'XML';@\\
\mbox{}\verb@    parseDOMTree($root, '');@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   For node name mnemonics see:@\\
\mbox{}\verb@    #       /usr/lib/perl5/vendor_perl/5.8.8/i386-linux-thread-multi/XML/LibXML/Common.pm@\\
\mbox{}\verb@    sub parseDOMTree {@\\
\mbox{}\verb@        my ($elem, $parent) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($elem->nodeType() == TEXT_NODE) {@\\
\mbox{}\verb@            my $v = $elem->nodeValue();@\\
\mbox{}\verb@            if ($v !~ m/^\s*$/) {@\\
\mbox{}\verb@                if (($parent eq 'log-unit') || ($parent eq 'weight-unit')) {@\\
\mbox{}\verb@                    $csvUnit = WEIGHT_KILOGRAM if ($elem->nodeValue() eq 'kilogram');@\\
\mbox{}\verb@                    $csvUnit = WEIGHT_POUND if ($elem->nodeValue() eq 'pound');@\\
\mbox{}\verb@                    $csvUnit = WEIGHT_STONE if ($elem->nodeValue() eq 'stone');@\\
\mbox{}\verb@                } elsif ($parent eq 'year') {@\\
\mbox{}\verb@                    $logYear = $elem->nodeValue();@\\
\mbox{}\verb@                } elsif ($parent eq 'month') {@\\
\mbox{}\verb@                    $logMonth = $elem->nodeValue();@\\
\mbox{}\verb@                } elsif ($parent =~ m/(date|weight|rung|flag|comment)/) {@\\
\mbox{}\verb@                    $logItem{$parent} = $elem->nodeValue();@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        } elsif ($elem->nodeType() == ELEMENT_NODE) {@\\
\mbox{}\verb@            if ($elem->nodeName() eq 'day') {@\\
\mbox{}\verb@                %logItem = ();                  # Clear log item fields@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if ($elem->hasChildNodes()) {@\\
\mbox{}\verb@            my @{\tt @}\verb@kids = $elem->getChildNodes();@\\
\mbox{}\verb@            for my $kid (@{\tt @}\verb@kids) {@\\
\mbox{}\verb@                $indent .= '  ';@\\
\mbox{}\verb@                parseDOMTree($kid, $elem->nodeName());@\\
\mbox{}\verb@                $indent =~ s/  //;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (($elem->nodeType() == ELEMENT_NODE) &&@\\
\mbox{}\verb@            ($elem->nodeName() eq 'day')) {@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Process XML daily log entry}\nobreak\ {\footnotesize \NWlink{nuweb231}{231}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb228b}{228b}.
\item \NWtxtIdentsUsed\nobreak\  \verb@WEIGHT_KILOGRAM@\nobreak\ \NWlink{nuweb24}{24}, \verb@WEIGHT_POUND@\nobreak\ \NWlink{nuweb24}{24}, \verb@WEIGHT_STONE@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Process XML daily log entry}

All of the fields for a log entry are children of the
{\tt day} element, which we process here.  If we're making
a listing, we generate a pseudo-record solely to be
listed.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap330}\raggedright\small
\NWtarget{nuweb231}{} $\langle\,${\itshape Process XML daily log entry}\nobreak\ {\footnotesize {231}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    #   Sanity check date before proceeding@\\
\mbox{}\verb@    if (($logYear >= 1980) &&  ($logYear <= ((unix_time_to_civil_date_time($userTime))[0]))) {@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $monkey = sprintf("%04d-%02d", $logYear, $logMonth);@\\
\mbox{}\verb@        my ($yy, $mm) = ($logYear, $logMonth);@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Load or create monthly log containing imported record}\nobreak\ {\footnotesize \NWlink{nuweb236}{236}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   Test whether an entry already exists for this day@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ((!$overwrite) && ($mlog->{weight}[$logItem{date}] || $mlog->{rung}[$logItem{date}] ||@\\
\mbox{}\verb@                $mlog->{flag}[$logItem{date}] || $mlog->{comment}[$logItem{date}])) {@\\
\mbox{}\verb@            $listStyle = 'conflict';@\\
\mbox{}\verb@            $already++;@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $mlog->{weight}[$logItem{date}] = ($logItem{weight} *@\\
\mbox{}\verb@                    WEIGHT_CONVERSION->[$csvUnit][$mlog->{log_unit}])@\\
\mbox{}\verb@                if defined($logItem{weight});@\\
\mbox{}\verb@            $mlog->{rung}[$logItem{date}] = $logItem{rung}@\\
\mbox{}\verb@                if defined($logItem{rung});@\\
\mbox{}\verb@            $mlog->{flag}[$logItem{date}] = $logItem{flag}@\\
\mbox{}\verb@                if defined($logItem{flag});@\\
\mbox{}\verb@            $mlog->{comment}[$logItem{date}] = $logItem{comment};@\\
\mbox{}\verb@@\\
\mbox{}\verb@            $monchanges{$monkey}++;@\\
\mbox{}\verb@            $listStyle = 'imported';@\\
\mbox{}\verb@            $imported++;@\\
\mbox{}\verb@       }@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        $listStyle = 'noparse';@\\
\mbox{}\verb@        $noparse++;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $n++;@\\
\mbox{}\verb@    if ($listCSV) {@\\
\mbox{}\verb@        my $listline =  quoteHTML(sprintf("%04d-%02d-%02d  %4.1f  %3d  %1d  %s",@\\
\mbox{}\verb@            $logYear, $logMonth, $logItem{date},@\\
\mbox{}\verb@            defined($logItem{weight}) ? $logItem{weight} : 0,@\\
\mbox{}\verb@            defined($logItem{rung}) ? $logItem{rung} : 0,@\\
\mbox{}\verb@            defined($logItem{flag}) ? $logItem{flag} : 0,@\\
\mbox{}\verb@            defined($logItem{comment}) ? $logItem{comment} : ''));@\\
\mbox{}\verb@        printf("<span class=\"$listStyle\">%4d.  %s</span>\n", $n, $listline);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb230}{230}.
\item \NWtxtIdentsUsed\nobreak\  \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}, \verb@unix_time_to_civil_date_time@\nobreak\ \NWlink{nuweb451b}{451b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Dump XML database file}

Output an interpreted dump of the uploaded XML database file to
standard output.  This is used for debugging XML parsing and
interpretation.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap331}\raggedright\small
\NWtarget{nuweb232}{} $\langle\,${\itshape Dump XML database file}\nobreak\ {\footnotesize {232}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $parser = XML::LibXML->new();@\\
\mbox{}\verb@    my $doc = $parser->parse_string($CGIargs{file});@\\
\mbox{}\verb@    my $root = $doc->getDocumentElement();@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $indent = '';@\\
\mbox{}\verb@@\\
\mbox{}\verb@    guzz($root);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   For node name mnemonics see:@\\
\mbox{}\verb@    #       /usr/lib/perl5/vendor_perl/5.8.8/i386-linux-thread-multi/XML/LibXML/Common.pm@\\
\mbox{}\verb@    sub guzz {@\\
\mbox{}\verb@        my $elem = shift();@\\
\mbox{}\verb@        if ($elem->nodeType() == TEXT_NODE) {@\\
\mbox{}\verb@            my $v = $elem->nodeValue();@\\
\mbox{}\verb@            if ($v !~ m/^\s*$/) {@\\
\mbox{}\verb@                print($indent . "Txt: " . $elem->nodeName() . "  " . $elem->nodeValue(), "\n");@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        } elsif ($elem->nodeType() == ELEMENT_NODE) {@\\
\mbox{}\verb@            print($indent . "Elt: " . $elem->nodeName() . "\n");@\\
\mbox{}\verb@            if ($elem->hasAttributes()) {@\\
\mbox{}\verb@                my @{\tt @}\verb@attrs = $elem->attributes();@\\
\mbox{}\verb@                for my $a (@{\tt @}\verb@attrs) {@\\
\mbox{}\verb@                    print($indent . "Atr: " . $a->nodeName() . "  " . $a->nodeValue(), "\n");@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if ($elem->hasChildNodes()) {@\\
\mbox{}\verb@            my @{\tt @}\verb@kids = $elem->getChildNodes();@\\
\mbox{}\verb@            for my $kid (@{\tt @}\verb@kids) {@\\
\mbox{}\verb@                $indent .= '  ';@\\
\mbox{}\verb@                guzz($kid);@\\
\mbox{}\verb@                $indent =~ s/  //;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item {\NWtxtMacroNoRef}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Import log items from CSV database file}

The file did not begin with an XML header, so we conclude it must be
in CSV format.  Attempt to parse in the assorted CSV formats we
support.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap332}\raggedright\small
\NWtarget{nuweb233}{} $\langle\,${\itshape Import log items from CSV database file}\nobreak\ {\footnotesize {233}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    while ($CGIargs{file} =~ s/^([^\n]*\r?\n)//s) {@\\
\mbox{}\verb@        $n++;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $l = $1;@\\
\mbox{}\verb@        my $listline = $l;@\\
\mbox{}\verb@        $listline =~ s/\s+$//;@\\
\mbox{}\verb@        $listStyle = 'noparse';@\\
\mbox{}\verb@        if (($listline ne '') && $csv->parse($l)) {@\\
\mbox{}\verb@            $listStyle = 'notentry';@\\
\mbox{}\verb@            my @{\tt @}\verb@f = $csv->fields();@\\
\mbox{}\verb@            $imp = 0;@\\
\mbox{}\verb@            $over = 0;@\\
\mbox{}\verb@@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Check for Excel CSV record}\nobreak\ {\footnotesize \NWlink{nuweb234}{234}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@            if (!($imp || $over)) {@\\
\mbox{}\verb@                @\hbox{$\langle\,${\itshape Check for Palm/HDREAD CSV record}\nobreak\ {\footnotesize \NWlink{nuweb238}{238}}$\,\rangle$}\verb@@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@@\\
\mbox{}\verb@            if ($imp) {@\\
\mbox{}\verb@                $listStyle = 'imported';@\\
\mbox{}\verb@                $imported++;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@@\\
\mbox{}\verb@            if ($listStyle eq 'notentry') {@\\
\mbox{}\verb@                $notentry++;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $listStyle = 'noparse';@\\
\mbox{}\verb@            $noparse++;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($listCSV) {@\\
\mbox{}\verb@            $listline = quoteHTML($listline);@\\
\mbox{}\verb@            printf("<span class=\"$listStyle\">%4d.  %s</span>\n", $n, $listline);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb228b}{228b}.
\item \NWtxtIdentsUsed\nobreak\  \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Check for Excel CSV record}

Test if this record is in the format of the CSV export of an
Excel yearly log.  If so, determine whether it is a the
header line specifying the log units and set \verb+$csvUnit+ accordingly.
If this is a non-void daily log entry, extract the fields and
import them into the database.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap333}\raggedright\small
\NWtarget{nuweb234}{} $\langle\,${\itshape Check for Excel CSV record}\nobreak\ {\footnotesize {234}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $excelCSVdebug = 0;@\\
\mbox{}\verb@    if ($listline =~ m/^Date,,Weight,Trend,Variance,,Rung,Flag$/) {@\\
\mbox{}\verb@        $logFormat = 'Excel';@\\
\mbox{}\verb@#print("Set format Excel\n") if $excelCSVdebug;@\\
\mbox{}\verb@    } elsif (($logFormat eq 'Excel') && ($csvUnit < 0) &&@\\
\mbox{}\verb@             ($listline =~ m/^,,(\w+),,\w+\s+\d+,,,$/)) {@\\
\mbox{}\verb@        my $wunit = $1;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $csvUnit = WEIGHT_KILOGRAM if ($wunit =~ m/^Kilograms/i) || ($wunit eq 0);@\\
\mbox{}\verb@        $csvUnit = WEIGHT_POUND if ($wunit =~ m/^Pounds/i) || ($wunit eq 1);@\\
\mbox{}\verb@        $csvUnit = WEIGHT_STONE if ($wunit =~ m/^Stones/i) || ($wunit eq -1);@\\
\mbox{}\verb@#print("Setunit $csvUnit\n") if $excelCSVdebug;@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@#print("        Parsed($#f) 0($f[0])  1($f[1])   2($f[2])   3($f[3])   4($f[4])   5($f[5])   6($f[6])  7($f[7])  8($f[8])\n") if $excelCSVdebug;@\\
\mbox{}\verb@        if (($#f >= 5) &&@\\
\mbox{}\verb@            ($f[0] =~ m/^\d+[\/\-\.]\d+[\/\-\.]\d+$/) &&  # Date@\\
\mbox{}\verb@            ($f[1] =~ m/^[a-z]+$/i) &&                  # Day of week@\\
\mbox{}\verb@            ($f[2] =~ m/^[\p{IsWord}\s\.]+$/) &&        # Weight@\\
\mbox{}\verb@            ($f[3] =~ m/^[\d\.]+$/) &&                  # Trend@\\
\mbox{}\verb@            ($f[4] =~ m/^\-?[\d\.]*$/) &&               # Variance@\\
\mbox{}\verb@            ($f[5] =~ m/^[\d\.]*$/) &&                  # Hidden carry-forward@\\
\mbox{}\verb@            ($f[6] =~ m/^\s*\d*$/)) {                   # Exercise rung@\\
\mbox{}\verb@#print("        Import ($f[0])  ($f[2])   ($f[6])  ($f[7])\n") if $excelCSVdebug;@\\
\mbox{}\verb@            my ($date, $weight, $rung) = ($f[0], $f[2], $f[6]);@\\
\mbox{}\verb@            $rung =~ s/\s//g;@\\
\mbox{}\verb@            my $flag = $f[7] ? 1 : 0;@\\
\mbox{}\verb@            my $comment = defined($f[8]) ? $f[8] : '';@\\
\mbox{}\verb@@\\
\mbox{}\verb@            #   See if the first field is something we can interpret plausibly as a date@\\
\mbox{}\verb@            $f[0] =~ m/^(\d+)([\/\-\.])(\d+)([\/\-\.])(\d+)$/;@\\
\mbox{}\verb@            if ($2 eq $4) {@\\
\mbox{}\verb@                @\hbox{$\langle\,${\itshape Parse Excel CSV date field}\nobreak\ {\footnotesize \NWlink{nuweb235}{235}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@                #   Sanity check date before proceeding@\\
\mbox{}\verb@                if (($yy >= 1980) &&  ($yy <= ((unix_time_to_civil_date_time($userTime))[0]))) {@\\
\mbox{}\verb@                    my $monkey = sprintf("%04d-%02d", $yy, $mm);@\\
\mbox{}\verb@@\\
\mbox{}\verb@                    @\hbox{$\langle\,${\itshape Load or create monthly log containing imported record}\nobreak\ {\footnotesize \NWlink{nuweb236}{236}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@                    #   Test whether an entry already exists for this day@\\
\mbox{}\verb@@\\
\mbox{}\verb@                    if ((!$overwrite) && ($mlog->{weight}[$dd] || $mlog->{rung}[$dd] ||@\\
\mbox{}\verb@                            $mlog->{flag}[$dd] || $mlog->{comment}[$dd])) {@\\
\mbox{}\verb@                        $listStyle = 'conflict';@\\
\mbox{}\verb@                        $already++;@\\
\mbox{}\verb@                        $over = 1;@\\
\mbox{}\verb@                    } else {@\\
\mbox{}\verb@                        @\hbox{$\langle\,${\itshape Set monthly log entry from Excel CSV record}\nobreak\ {\footnotesize \NWlink{nuweb237}{237}}$\,\rangle$}\verb@@\\
\mbox{}\verb@                    }@\\
\mbox{}\verb@                } else { print ("ExcelBarfel: $yy-$mm-$dd\n") if $excelCSVdebug; }@\\
\mbox{}\verb@            } else { print ("ExcelGarfel: $1 $2 $3 $4 $5 $6\n") if $excelCSVdebug; }@\\
\mbox{}\verb@@\\
\mbox{}\verb@         }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb233}{233}.
\item \NWtxtIdentsUsed\nobreak\  \verb@unix_time_to_civil_date_time@\nobreak\ \NWlink{nuweb451b}{451b}, \verb@WEIGHT_KILOGRAM@\nobreak\ \NWlink{nuweb24}{24}, \verb@WEIGHT_POUND@\nobreak\ \NWlink{nuweb24}{24}, \verb@WEIGHT_STONE@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Parse Excel CSV date field}

We accept three different date formats in Excel CSV:
{\em YYYY}{\tt -}{\em MM}{\tt -}{\em DD},
{\em MM}{\tt /}{\em DD}{\tt /}{\em YYYY}, and
{\em DD}{\tt .}{\em MM}{\tt .}{\em YYYY}\@.  In
any of these, the year may be given as a two digit
quantity to which 1900 is added if 89 or greater
and 2000 otherwise.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap334}\raggedright\small
\NWtarget{nuweb235}{} $\langle\,${\itshape Parse Excel CSV date field}\nobreak\ {\footnotesize {235}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my ($yy, $mm, $dd);@\\
\mbox{}\verb@    if ($2 eq '-') {            # YYYY-MM-DD@\\
\mbox{}\verb@        $yy = $1 + 0;@\\
\mbox{}\verb@        $mm = $3 + 0;@\\
\mbox{}\verb@        $dd = $5 + 0;@\\
\mbox{}\verb@    } elsif ($2 eq '/') {       # MM/DD/YYYY@\\
\mbox{}\verb@        $yy = $5 + 0;@\\
\mbox{}\verb@        $mm = $1 + 0;@\\
\mbox{}\verb@        $dd = $3 + 0;@\\
\mbox{}\verb@    } elsif ($2 eq '.') {       # DD.MM.YYYY@\\
\mbox{}\verb@        $yy = $5 + 0;@\\
\mbox{}\verb@        $mm = $3 + 0;@\\
\mbox{}\verb@        $dd = $1 + 0;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   Kludge for two digit years@\\
\mbox{}\verb@    if ($yy < 100) {@\\
\mbox{}\verb@        if ($yy > 88) {@\\
\mbox{}\verb@            $yy += 1900;@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $yy += 2000;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb234}{234}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Load or create monthly log containing Excel CSV record}

If the log containing the record is already in the
\verb+%mondb+ cache, return it.  Otherwise, load it from
the database or create a new blank log if this is a month
not present in the database.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap335}\raggedright\small
\NWtarget{nuweb236}{} $\langle\,${\itshape Load or create monthly log containing imported record}\nobreak\ {\footnotesize {236}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $mlog;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (defined($mondb{$monkey})) {@\\
\mbox{}\verb@        $mlog = $mondb{$monkey};@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        $mlog = HDiet::monthlog->new();@\\
\mbox{}\verb@        $mondb{$monkey} = $mlog;@\\
\mbox{}\verb@        $monchanges{$monkey} = 0;@\\
\mbox{}\verb@        if (-f "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$monkey.hdb") {@\\
\mbox{}\verb@            open(FL, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$monkey.hdb") ||@\\
\mbox{}\verb@                die("Cannot open monthly log file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$monkey.hdb");@\\
\mbox{}\verb@            $mlog->load(\*FL);@\\
\mbox{}\verb@            close(FL);@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $mlog->{year} = $yy;@\\
\mbox{}\verb@            $mlog->{month} = $mm;@\\
\mbox{}\verb@            $mlog->{log_unit} = $ui->{log_unit};@\\
\mbox{}\verb@            $mlog->{trend_carry_forward} = 0;@\\
\mbox{}\verb@            $mlog->{last_modification_time} = 0;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb231}{231}\NWlink{nuweb234}{, 234}\NWlink{nuweb238}{, 238}.
\item \NWtxtIdentsUsed\nobreak\  \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Set monthly log entry from Excel CSV record}

Store the parsed fields from the Excel CSV record into the indicated
date in the monthly log.  Note that in Excel logs a comment can appear
either in the weight field or in column 8 along with a valid weight
field.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap336}\raggedright\small
\NWtarget{nuweb237}{} $\langle\,${\itshape Set monthly log entry from Excel CSV record}\nobreak\ {\footnotesize {237}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $cmt = '';@\\
\mbox{}\verb@    if ($f[2] !~ m/^[\d\.]+$/) {@\\
\mbox{}\verb@        $cmt = $f[2];@\\
\mbox{}\verb@        $f[2] = '';@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    $cmt = $f[8] if defined($f[8]) && $f[8] ne '';@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $mlog->{weight}[$dd] = ($f[2] * WEIGHT_CONVERSION->[$csvUnit][$mlog->{log_unit}]) if $f[2] ne '';@\\
\mbox{}\verb@    $mlog->{rung}[$dd] = $f[6] if $f[6] ne '';@\\
\mbox{}\verb@    $mlog->{flag}[$dd] = '1' if $f[7] ne '';@\\
\mbox{}\verb@    $mlog->{flag}[$dd] = undef if (!$f[7]) || ($f[7] eq '0') ||@\\
\mbox{}\verb@        ($f[7] eq '') || ($f[7] =~ m/^\s*$/);@\\
\mbox{}\verb@    $mlog->{comment}[$dd] = $cmt if $cmt ne '';@\\
\mbox{}\verb@    if ($cmt eq '') {@\\
\mbox{}\verb@        undef $mlog->{comment}[$dd];@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $monchanges{$monkey}++;@\\
\mbox{}\verb@    $imp = 1;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb234}{234}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Check for Palm/HDREAD CSV record}

Records which appear to be in HDREAD format may have come from
HDREAD or have been exported from this application.  The only
difference occurs in the comments field, which may contain
escaped UTF-8 characters exported from an online monthly
log.  HDREAD-generated files contain only ISO 8859-1 characters
and use the Excel quoting convention.  We detect records
we've exported by the presence of a CSV version number on
the ``{\tt StartTrend}'' record and set the \verb+$hdOnlineLog+
flag, which causes records to be imported with the
{\tt importCSV} method of the monthly log.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap337}\raggedright\small
\NWtarget{nuweb238}{} $\langle\,${\itshape Check for Palm/HDREAD CSV record}\nobreak\ {\footnotesize {238}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($listline =~ m/^Date,Weight,Rung,Flag,Comment$/) {@\\
\mbox{}\verb@        $logFormat = 'HDRead';@\\
\mbox{}\verb@    } elsif (($logFormat eq 'HDRead') &&@\\
\mbox{}\verb@             ($#f >= 4) &&@\\
\mbox{}\verb@             ($f[0] eq 'StartTrend') &&@\\
\mbox{}\verb@             ($f[2] >= WEIGHT_KILOGRAM) && ($f[2] <= WEIGHT_STONE)) {@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $csvUnit = $f[2];@\\
\mbox{}\verb@        $hdOnlineLog = 0;@\\
\mbox{}\verb@        if (($#f >= 5) && ($f[5] =~ m/^[\d\.]+$/)) {@\\
\mbox{}\verb@            $hdOnlineLog = 1;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        $f[0] =~ s/\s//g if defined($f[0]);@\\
\mbox{}\verb@        $f[1] =~ s/\s//g if defined($f[1]);@\\
\mbox{}\verb@        $f[2] =~ s/\s//g if defined($f[2]);@\\
\mbox{}\verb@        $f[3] =~ s/\s//g if defined($f[3]);@\\
\mbox{}\verb@        if (($#f >= 4) &&@\\
\mbox{}\verb@            ($f[0] =~ m/^\d+\-\d+\-\d+$/) &&        # Date@\\
\mbox{}\verb@            ($f[1] =~ m/^[\d\.]*$/) &&              # Weight@\\
\mbox{}\verb@            ($f[2] =~ m/^\d*$/)) {                  # Exercise rung@\\
\mbox{}\verb@            my ($date, $weight, $rung) = ($f[0], $f[1], $f[2]);@\\
\mbox{}\verb@            my $flag = $f[3] ? 1 : 0;@\\
\mbox{}\verb@            my $comment = defined($f[4]) ? $f[4] : '';@\\
\mbox{}\verb@@\\
\mbox{}\verb@            #   See if the first field is an ISO 8601 date@\\
\mbox{}\verb@            $f[0] =~ m/^(\d+)\-(\d+)\-(\d+)$/;@\\
\mbox{}\verb@            my ($yy, $mm, $dd) = ($1, $2, $3);@\\
\mbox{}\verb@@\\
\mbox{}\verb@            #   Sanity check date before proceeding@\\
\mbox{}\verb@            if (($yy >= 1980) &&  ($yy <= ((unix_time_to_civil_date_time($userTime))[0]))) {@\\
\mbox{}\verb@@\\
\mbox{}\verb@                my $monkey = sprintf("%04d-%02d", $yy, $mm);@\\
\mbox{}\verb@@\\
\mbox{}\verb@                @\hbox{$\langle\,${\itshape Load or create monthly log containing imported record}\nobreak\ {\footnotesize \NWlink{nuweb236}{236}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@                #   Test whether an entry already exists for this day@\\
\mbox{}\verb@@\\
\mbox{}\verb@                if ((!$overwrite) && ($mlog->{weight}[$dd] || $mlog->{rung}[$dd] ||@\\
\mbox{}\verb@                        $mlog->{flag}[$dd] || $mlog->{comment}[$dd])) {@\\
\mbox{}\verb@                    $listStyle = 'conflict';@\\
\mbox{}\verb@                    $already++;@\\
\mbox{}\verb@                } else {@\\
\mbox{}\verb@                    @\hbox{$\langle\,${\itshape Set monthly log entry from Palm CSV record}\nobreak\ {\footnotesize \NWlink{nuweb239}{239}}$\,\rangle$}\verb@@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }# else { print ("PalmBarfel: $yy-$mm-$dd\n"); }@\\
\mbox{}\verb@         }# else { print ("PalmGarfel: ($f[0])  ($f[1])   ($f[2])  ($f[3]) ($f[4])\n"); }@\\
\mbox{}\verb@     }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb233}{233}.
\item \NWtxtIdentsUsed\nobreak\  \verb@unix_time_to_civil_date_time@\nobreak\ \NWlink{nuweb451b}{451b}, \verb@WEIGHT_KILOGRAM@\nobreak\ \NWlink{nuweb24}{24}, \verb@WEIGHT_STONE@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Set monthly log entry from Palm CSV record}

The CSV record has passed all the tests, so now nothing
remains but to actually import it.  If this is a record
we have exported (see the above section for details on
how that is detected), we simply pass it to the
{\tt importCSV} method of the monthly log which contains
the record.  Otherwise, we set the fields in the log
entry directly from the values we've parsed from the record.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap338}\raggedright\small
\NWtarget{nuweb239}{} $\langle\,${\itshape Set monthly log entry from Palm CSV record}\nobreak\ {\footnotesize {239}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($hdOnlineLog) {@\\
\mbox{}\verb@        if ($mlog->importCSV($listline)) {@\\
\mbox{}\verb@            $monchanges{$monkey}++;@\\
\mbox{}\verb@            $imp = 1;@\\
\mbox{}\verb@       }@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        $mlog->{weight}[$dd] = ($f[1] *@\\
\mbox{}\verb@            WEIGHT_CONVERSION->[$csvUnit][$mlog->{log_unit}]) if $f[1] ne '';@\\
\mbox{}\verb@        $mlog->{rung}[$dd] = $f[2] if $f[2] ne '';@\\
\mbox{}\verb@        $mlog->{flag}[$dd] = $flag;@\\
\mbox{}\verb@        $mlog->{comment}[$dd] = $comment;@\\
\mbox{}\verb@        if ($comment eq '') {@\\
\mbox{}\verb@            undef $mlog->{comment}[$dd];@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $monchanges{$monkey}++;@\\
\mbox{}\verb@    $imp = 1;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb238}{238}.
\item \NWtxtIdentsUsed\nobreak\  \verb@importCSV@\nobreak\ \NWlink{nuweb63}{63}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Write back logs modified by database import}

Any logs which have been modified as a result of the database import
are written back to the database.  The last modification time in each
log is sent to the current time.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap339}\raggedright\small
\NWtarget{nuweb240a}{} $\langle\,${\itshape Write back logs modified by database import}\nobreak\ {\footnotesize {240a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $md;@\\
\mbox{}\verb@    if (!$readOnly) {@\\
\mbox{}\verb@        foreach $md (sort(keys(%mondb))) {@\\
\mbox{}\verb@            if ($monchanges{$md} > 0) {@\\
\mbox{}\verb@                $mondb{$md}->{last_modification_time} = time();@\\
\mbox{}\verb@                open(FL, ">:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$md.hdb") ||@\\
\mbox{}\verb@                    die("Cannot open monthly log file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$md.hdb");@\\
\mbox{}\verb@                $mondb{$md}->save(\*FL);@\\
\mbox{}\verb@                close(FL);@\\
\mbox{}\verb@                clusterCopy("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$md.hdb");@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb228b}{228b}.
\item \NWtxtIdentsUsed\nobreak\  \verb@save@\nobreak\ \NWlink{nuweb31}{31}\NWlink{nuweb123}{, 123}\NWlink{nuweb151}{, 151}\NWlink{nuweb156b}{, 156b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Append summary of records imported}

Generate a legend in the results page which shows the disposition
of the lines imported: added to the database, ignored to avoid overwriting
existing data, and skipped due to syntax errors or not being a
daily log item.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap340}\raggedright\small
\NWtarget{nuweb240b}{} $\langle\,${\itshape Append summary of records imported}\nobreak\ {\footnotesize {240b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print($fh "<p>\n@\\
\mbox{}\verb@Records submitted: $n.<br />\n@\\
\mbox{}\verb@Log items imported: $imported.<br />\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print($fh "<span class=\"notentry\">Records ignored as not daily log entries: $notentry.</span><br />\n")@\\
\mbox{}\verb@        if $notentry > 0;@\\
\mbox{}\verb@    print($fh "<span class=\"conflict\">Records skipped to avoid overwriting existing entries: $already.</span><br />\n")@\\
\mbox{}\verb@        if $already > 0;@\\
\mbox{}\verb@    print($fh "<span class=\"noparse\">Records discarded due to parsing errors: $noparse.</span><br />\n")@\\
\mbox{}\verb@        if $noparse > 0;@\\
\mbox{}\verb@    print($fh "</p>\n");@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb228b}{228b}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Configure Web page status badge}

This form allows the user to enable the generation of a Web page
``badge'' image which shows the most recent weight entry and the
energy balance and weight gain/loss trend for a user-specified
interval.  When the form is submitted a \verb+update_badge+
transaction is submitted to apply the changes.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap341}\raggedright\small
\NWtarget{nuweb241}{} $\langle\,${\itshape Configure Web page status badge}\nobreak\ {\footnotesize {241}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Configure Web Page Status Badge", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@cterm;@\\
\mbox{}\verb@    $cterm[0] = $cterm[7] = $cterm[14] = $cterm[1] = $cterm[3] = $cterm[6] = $cterm[12] = '';@\\
\mbox{}\verb@    $cterm[abs($ui->{badge_trend})] = ' selected="selected"';@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Configure Web Page Status Badge</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="centred">@\\
\mbox{}\verb@<img src="$homeBase/figures/badge_sample.png"@\\
\mbox{}\verb@    width="200" height="78"@\\
\mbox{}\verb@    alt="Sample Web status badge" />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@A Web badge is a small image like the example above which you can add to@\\
\mbox{}\verb@your personal Web page or Web log which shows, as of the@\\
\mbox{}\verb@most recent log entry, your weight, daily energy (calorie or kilojoule)@\\
\mbox{}\verb@balance, and your present weekly rate of weight loss or gain based@\\
\mbox{}\verb@upon fitting a linear trend to the trend values for the interval@\\
\mbox{}\verb@chosen below.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<form id="Hdiet_badgeconf" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb241}{241}\NWlink{nuweb242}{, 242}\NWlink{nuweb243}{, 243}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Interval selection}

A {\tt select} box allows the user to specify the interval over
which the trend shown in the badge is to be computed.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap342}\raggedright\small
\NWtarget{nuweb242}{} $\langle\,${\itshape Configure Web page status badge}\nobreak\ {\footnotesize {242}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<select name="badge_term" id="badge_term"@\\
\mbox{}\verb@    onchange="change_badge_term();">@\\
\mbox{}\verb@    <option value="0"$cterm[0]>Disable badge</option>@\\
\mbox{}\verb@    <option value="7"$cterm[7]>Week</option>@\\
\mbox{}\verb@    <option value="14"$cterm[14]>Fortnight</option>@\\
\mbox{}\verb@    <option value="-1"$cterm[1]>Month</option>@\\
\mbox{}\verb@    <option value="-3"$cterm[3]>Quarter</option>@\\
\mbox{}\verb@    <option value="-6"$cterm[6]>Six months</option>@\\
\mbox{}\verb@    <option value="-12"$cterm[12]>Year</option>@\\
\mbox{}\verb@</select>@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@After choosing the interval over which you wish the trend to be@\\
\mbox{}\verb@computed, press the &ldquo;Apply&rdquo; button below.  You'll@\\
\mbox{}\verb@be taken to a confirmation page which includes HTML/XHTML code@\\
\mbox{}\verb@you can cut and paste into your Web page to display the badge.@\\
\mbox{}\verb@If you select &ldquo;Disable badge&rdquo;, badge generation will@\\
\mbox{}\verb@be disabled and any existing badge image deleted; if you disable@\\
\mbox{}\verb@badge generation, be sure to remove the badge image from your Web@\\
\mbox{}\verb@page, as otherwise visitors will see an &ldquo;Invalid request&rdquo;@\\
\mbox{}\verb@icon instead of the badge.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb241}{241}\NWlink{nuweb242}{, 242}\NWlink{nuweb243}{, 243}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Form action buttons}

The following buttons appear at the bottom of the badge configuration
form.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap343}\raggedright\small
\NWtarget{nuweb243}{} $\langle\,${\itshape Configure Web page status badge}\nobreak\ {\footnotesize {243}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@<input type="submit" name="q=update_badge" value=" Apply " />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="reset" value=" Reset " />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="submit" name="q=account" value=" Cancel " />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb241}{241}\NWlink{nuweb242}{, 242}\NWlink{nuweb243}{, 243}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Update Web page status badge}

When an \verb+update_badge+ transaction is received, this code updates the
{\tt user} object with the new badge trend interval (zero if badge generation
is disabled) and updates the badge (deleting it if generation has been
disabled).  A {\tt textbox} containing the XHTML to be copied into a
page to display the badge is supplied to the user if badge generation
is enabled.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap344}\raggedright\small
\NWtarget{nuweb244}{} $\langle\,${\itshape Update Web page status badge}\nobreak\ {\footnotesize {244}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Web Page Status Badge Configuration Changed", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $CGIargs{badge_term} = '0' if !defined($CGIargs{badge_term});@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $ui->{badge_trend} = $CGIargs{badge_term};@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my %valid_term = ( 0, 1, 7, 1, 14, 1, -1, 1, -3, 1, -6, 1, -12, 1 );@\\
\mbox{}\verb@    if (!defined($valid_term{$ui->{badge_trend}})) {@\\
\mbox{}\verb@        $ui->{badge_trend} = 0;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Update user account information}\nobreak\ {\footnotesize \NWlink{nuweb309}{309}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($ui->{badge_trend} != 0) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Update Web page badge}\nobreak\ {\footnotesize \NWlink{nuweb220b}{220b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        if (-f "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/BadgeImage.png") {@\\
\mbox{}\verb@            unlink("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/BadgeImage.png");@\\
\mbox{}\verb@            clusterDelete("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/BadgeImage.png");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Web Page Status Badge<br />@\\
\mbox{}\verb@Configuration Changed</h1>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb244}{244}\NWlink{nuweb245}{, 245}\NWlink{nuweb246}{, 246}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Show updated badge configuration}

Display the current badge configuration in the result page
returned when the badge trend interval is changed.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap345}\raggedright\small
\NWtarget{nuweb245}{} $\langle\,${\itshape Update Web page status badge}\nobreak\ {\footnotesize {245}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($ui->{badge_trend} == 0) {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@You have disabled generation of a Web page status badge.  Please be@\\
\mbox{}\verb@sure to remove the HTML/XHTML code from your Web page which displays@\\
\mbox{}\verb@the badge, otherwise you'll see an &ldquo;Invalid request&rdquo; icon@\\
\mbox{}\verb@where the badge used to appear.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        my @{\tt @}\verb@cterm;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $cterm[7]  = 'week';@\\
\mbox{}\verb@        $cterm[14] = 'fortnight';@\\
\mbox{}\verb@        $cterm[1]  = 'month';@\\
\mbox{}\verb@        $cterm[3]  = 'quarter';@\\
\mbox{}\verb@        $cterm[6]  = 'six months';@\\
\mbox{}\verb@        $cterm[12] = 'year';@\\
\mbox{}\verb@        my $ct = $cterm[abs($ui->{badge_trend})];@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $uec = $ui->generateEncryptedUserID();@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@You have enabled Web page status badge generation with the@\\
\mbox{}\verb@trend for the last@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="centred">@\\
\mbox{}\verb@<b>$ct</b>@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@displayed in the badge.  To display the badge on your Web page,@\\
\mbox{}\verb@copy and paste the following HTML/XHTML code into the page@\\
\mbox{}\verb@where you'd like to badge to appear.  Be sure to select the@\\
\mbox{}\verb@<em>entire</em> text in the box: the URL for the image is@\\
\mbox{}\verb@very long and must not be truncated.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb244}{244}\NWlink{nuweb245}{, 245}\NWlink{nuweb246}{, 246}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generateEncryptedUserID@\nobreak\ \NWlink{nuweb143}{143}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Show prototype XHTML code to display badge}

The XHTML code which the user can copy and paste into their Web
page to display the badge is shown in a read-only {\tt textbox},
ready to be selected and copied.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap346}\raggedright\small
\NWtarget{nuweb246}{} $\langle\,${\itshape Update Web page status badge}\nobreak\ {\footnotesize {246}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<form id="Hdiet_badgeproto" action="#" onsubmit="return false;">@\\
\mbox{}\verb@<p class="centred">@\\
\mbox{}\verb@<textarea cols="80" rows="4" name="protocode" readonly="readonly"@\\
\mbox{}\verb@    style="background-color: #FFFFA0; color: inherit;">@\\
\mbox{}\verb@&lt;a href="@\hbox{$\langle\,${\itshape Site home URL}\nobreak\ {\footnotesize \NWlink{nuweb13e}{13e}}$\,\rangle$}\verb@@\hbox{$\langle\,${\itshape Web Document Home}\nobreak\ {\footnotesize \NWlink{nuweb5d}{5d}}$\,\rangle$}\verb@/"&gt;&lt;img style="border: 0px;"@\\
\mbox{}\verb@src="@\hbox{$\langle\,${\itshape Site home URL}\nobreak\ {\footnotesize \NWlink{nuweb13e}{13e}}$\,\rangle$}\verb@@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@Badge?t=1&amp;amp;b=$uec"@\\
\mbox{}\verb@alt="The Hacker's Diet Online" /&gt;&lt;/a&gt;@\\
\mbox{}\verb@</textarea>@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=account&amp;s=$session->{session_id}$tzOff">Return to account page</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (!$readOnly) {@\\
\mbox{}\verb@        append_history($user_file_name, 19, $ui->{badge_trend});@\\
\mbox{}\verb@        update_last_transaction($user_file_name);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb244}{244}\NWlink{nuweb245}{, 245}\NWlink{nuweb246}{, 246}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@append_history@\nobreak\ \NWlink{nuweb397}{397}, \verb@update_last_transaction@\nobreak\ \NWlink{nuweb398}{398}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Recalculate trend carry-forward for all logs for a user}

An ``update\_trend'' request forces a complete recalculation and
re-propagation of the trend throughout all monthly logs in
a user's database.  This can be used to recover from mess-ups, but
can also be handy after bulk database changes such as importing
large amounts of CSV data.  A record of type 4 is appended to the history database
to log the forced recalculation.

Optional CGI arguments allow specifying the first month in
the recalculation (for example, ``{\tt m=1998-09}'') and forced
canonicalisation of all weight entries in the logs
processed (``{\tt canon=1}'').

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap347}\raggedright\small
\NWtarget{nuweb247}{} $\langle\,${\itshape Recalculate trend carry-forward for all logs for a user}\nobreak\ {\footnotesize {247}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $CGIargs{m} = '0000-00' if !defined($CGIargs{m});@\\
\mbox{}\verb@    $CGIargs{canon} = 0 if !defined($CGIargs{canon});@\\
\mbox{}\verb@    if ($CGIargs{canon} ne 0) {@\\
\mbox{}\verb@        $CGIargs{canon} = 1;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($CGIargs{m} ne '0000-00') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Sanity check year and month specification}\nobreak\ {\footnotesize \NWlink{nuweb207}{207}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@write_XHTML_prologue($fh, $homeBase, "Recompute trend carry-forward", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Trend Recalculation Complete</h1>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    propagate_trend($ui, $CGIargs{m}, $CGIargs{canon}) if !$readOnly;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=account&amp;s=$session->{session_id}$tzOff">Back to account page</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (!$readOnly) {@\\
\mbox{}\verb@        append_history($user_file_name, 4, "$CGIargs{m},$CGIargs{canon}");@\\
\mbox{}\verb@        update_last_transaction($user_file_name);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@append_history@\nobreak\ \NWlink{nuweb397}{397}, \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@propagate_trend@\nobreak\ \NWlink{nuweb392}{392}, \verb@update_last_transaction@\nobreak\ \NWlink{nuweb398}{398}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Quit browsing another account}

The ``{\tt quitbrowse}'' transaction terminates browsing of another
user account by the administrator or read-only browsing of a public
account by a user.  If somebody fakes up this transaction in a
session which is not browsing, no harm will be done---it will
simply be ignored.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap348}\raggedright\small
\NWtarget{nuweb248a}{} $\langle\,${\itshape Quit browsing another account}\nobreak\ {\footnotesize {248a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($assumed_identity || $browse_public) {@\\
\mbox{}\verb@        $session->{effective_name} = $session->{browse_name} = '';@\\
\mbox{}\verb@        open(FS, ">:utf8", "@\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$session->{session_id}.hds") ||@\\
\mbox{}\verb@            die("Cannot create session file @\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$session->{session_id}.hds");@\\
\mbox{}\verb@        $session->save(\*FS);@\\
\mbox{}\verb@        close(FS);@\\
\mbox{}\verb@        clusterCopy("@\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$session->{session_id}.hds");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    $CGIargs{q} = 'account';@\\
\mbox{}\verb@    next;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@save@\nobreak\ \NWlink{nuweb31}{31}\NWlink{nuweb123}{, 123}\NWlink{nuweb151}{, 151}\NWlink{nuweb156b}{, 156b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Download monthly log as CSV file}

Download the current-displayed monthly log as a CSV file in our
extended format.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap349}\raggedright\small
\NWtarget{nuweb248b}{} $\langle\,${\itshape Download monthly log as CSV file}\nobreak\ {\footnotesize {248b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Read log if in database or create blank log if it's not}\nobreak\ {\footnotesize \NWlink{nuweb210}{210}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print($fh "Content-type: text/csv; charset=iso-8859-1\r\n");@\\
\mbox{}\verb@    print($fh "Content-disposition: attachment; filename=\"$CGIargs{m}.csv\"\r\n");@\\
\mbox{}\verb@    print($fh "\r\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $mlog->exportCSV($fh);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    exit(0);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb178}{178}.
\item \NWtxtIdentsUsed\nobreak\  \verb@exportCSV@\nobreak\ \NWlink{nuweb64}{64}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Download monthly log as XML file}

Download the current-displayed monthly log as an XML in
our format.  We simply output a ``{\tt hackersdiet}'' DTD
XML file with a single {\tt monthlog}'' element containing the
present log.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap350}\raggedright\small
\NWtarget{nuweb249}{} $\langle\,${\itshape Download monthly log as XML file}\nobreak\ {\footnotesize {249}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Read log if in database or create blank log if it's not}\nobreak\ {\footnotesize \NWlink{nuweb210}{210}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    binmode($fh, ":utf8");@\\
\mbox{}\verb@    print($fh "Content-type: application/xml; charset=utf-8\r\n");@\\
\mbox{}\verb@    print($fh "Content-disposition: attachment; filename=\"$CGIargs{m}.xml\"\r\n");@\\
\mbox{}\verb@    print($fh "\r\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    generateXMLprologue($fh);@\\
\mbox{}\verb@    $mlog->exportXML($fh, 1);@\\
\mbox{}\verb@    generateXMLepilogue($fh);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    exit(0);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb178}{178}.
\item \NWtxtIdentsUsed\nobreak\  \verb@exportXML@\nobreak\ \NWlink{nuweb68}{68}, \verb@generateXMLepilogue@\nobreak\ \NWlink{nuweb441b}{441b}, \verb@generateXMLprologue@\nobreak\ \NWlink{nuweb441a}{441a}, \verb@xml@\nobreak\ \NWlink{nuweb440}{440}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Export log database}

Export the entire database in a user-selected format selected
from the following request form.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap351}\raggedright\small
\NWtarget{nuweb250}{} $\langle\,${\itshape Export log database}\nobreak\ {\footnotesize {250}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@years = $ui->enumerateYears();@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Set variables to default to previous request settings}\nobreak\ {\footnotesize \NWlink{nuweb299}{299}, \ldots\ }$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Export Log Database", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Export Log Database</h1>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<form id="Hdiet_exportdb" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<b>Format:</b><br />@\\
\mbox{}\verb@    <label><input type="radio" name="format" value="xml" checked="checked" />&nbsp;Hacker's Diet <em>Online</em> XML</label><br />@\\
\mbox{}\verb@    <label><input type="radio" name="format" value="csv" />&nbsp;Hacker's Diet <em>Online</em> CSV</label><br />@\\
\mbox{}\verb@    <label><input type="radio" name="format" value="palm" />&nbsp;Palm Eat Watch CSV</label><br />@\\
\mbox{}\verb@    <label><input type="radio" name="format" value="excel" />&nbsp;Legacy Excel CSV</label><br />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Selection of months to export from database}\nobreak\ {\footnotesize \NWlink{nuweb251a}{251a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@<input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@<input type="submit" name="q=do_exportdb" value=" Export " />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="reset" value=" Reset " />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="submit" name="q=account" value=" Cancel " />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@enumerateYears@\nobreak\ \NWlink{nuweb141}{141}, \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}, \verb@xml@\nobreak\ \NWlink{nuweb440}{440}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}


\vbox{
\subsubsection{Selection of months to export from database}

The following controls allow the user to select either all
months in the database or a range of months.  The starting and
ending months are preset to the first and last months present
in the database.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap352}\raggedright\small
\NWtarget{nuweb251a}{} $\langle\,${\itshape Selection of months to export from database}\nobreak\ {\footnotesize {251a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<label><input type="radio" name="period" value="a" checked="checked" />&nbsp;<b>Export all months</b></label>@\\
\mbox{}\verb@<br />@\\
\mbox{}\verb@<label><input type="radio" name="period" value="c" />&nbsp;<b>Export months</b></label>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $fy_selected[0] = ' selected="selected"';@\\
\mbox{}\verb@    my @{\tt @}\verb@f_mon = $ui->enumerateMonths($years[0]);@\\
\mbox{}\verb@    $f_mon[0] =~ m/^\d+\-(\d+)$/;@\\
\mbox{}\verb@    my $fmon = $1 + 0;@\\
\mbox{}\verb@    $fm_selected[$fmon] = ' selected="selected"';@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print($fh "From\n");@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Custom trend start date}\nobreak\ ({\footnotesize 251b\label{scrap353}
 }\mbox{}\verb@0@ ) {\footnotesize \NWlink{nuweb272}{272}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<br />@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $ty_selected[$#years] = ' selected="selected"';@\\
\mbox{}\verb@    @{\tt @}\verb@f_mon = $ui->enumerateMonths($years[$#years]);@\\
\mbox{}\verb@    $f_mon[$#f_mon] =~ m/^\d+\-(\d+)$/;@\\
\mbox{}\verb@    $fmon = $1 + 0;@\\
\mbox{}\verb@    $tm_selected[$fmon] = ' selected="selected"';@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print($fh "To\n");@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Custom trend end date}\nobreak\ ({\footnotesize 251c\label{scrap354}
 }\mbox{}\verb@0@ ) {\footnotesize \NWlink{nuweb273}{273}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<br />@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb250}{250}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Process database export}

Perform the database export operation requested by the above form.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap355}\raggedright\small
\NWtarget{nuweb252}{} $\langle\,${\itshape Process database export}\nobreak\ {\footnotesize {252}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Determine first and last days in database}\nobreak\ {\footnotesize \NWlink{nuweb253}{253}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $CGIargs{from_d} = 1;@\\
\mbox{}\verb@    $CGIargs{to_d} = 31;@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Process custom interval specification, if any}\nobreak\ {\footnotesize \NWlink{nuweb266}{266}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my ($start_ym, $end_ym) = ("0000-00", "9999-99");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($custom) {@\\
\mbox{}\verb@        $start_ym = sprintf("%04d-%02d", $cust_start_y, $cust_start_m);@\\
\mbox{}\verb@        $end_ym = sprintf("%04d-%02d", $cust_end_y, $cust_end_m);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $CGIargs{format} = '?' if !$CGIargs{format};@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($CGIargs{format} eq 'xml') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Export database as XML}\nobreak\ {\footnotesize \NWlink{nuweb254}{254}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{format} eq 'csv') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Export database as Hacker's Diet Online CSV}\nobreak\ {\footnotesize \NWlink{nuweb255}{255}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{format} eq 'palm') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Export database as Palm Eat Watch CSV}\nobreak\ {\footnotesize \NWlink{nuweb256}{256}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($CGIargs{format} eq 'excel') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Export database as Legacy Excel Eat Watch CSV}\nobreak\ {\footnotesize \NWlink{nuweb257}{257}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1>Invalid format specified for database export.</h1>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape MIME Content-type specification}\nobreak\ {\footnotesize \NWlink{nuweb390a}{390a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Export Log Database", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=account&amp;s=$session->{session_id}$tzOff">Back to account page</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb178}{178}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}, \verb@xml@\nobreak\ \NWlink{nuweb440}{440}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Determine first and last days in database}

Find the first and last dates in the database.  These are used as the default
settings for a custom request and to limit out of range requests to data
actually present in the database.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap356}\raggedright\small
\NWtarget{nuweb253}{} $\langle\,${\itshape Determine first and last days in database}\nobreak\ {\footnotesize {253}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $hist = HDiet::history->new($ui, $user_file_name);@\\
\mbox{}\verb@    my ($s_y, $s_m, $s_d) = $hist->firstDay();@\\
\mbox{}\verb@    my $s_jd = gregorian_to_jd($s_y, $s_m, $s_d);@\\
\mbox{}\verb@    my ($l_y, $l_m, $l_d) = $hist->lastDay();@\\
\mbox{}\verb@    my $l_jd = gregorian_to_jd($l_y, $l_m, $l_d);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb252}{252}\NWlink{nuweb265a}{, 265a}\NWlink{nuweb295}{, 295}.
\item \NWtxtIdentsUsed\nobreak\  \verb@firstDay@\nobreak\ \NWlink{nuweb109a}{109a}, \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}, \verb@lastDay@\nobreak\ \NWlink{nuweb108}{108}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Export database in XML format}

Export the database as XML.  The user identification, preferences, and
diet plan precede the monthly logs selected to be exported.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap357}\raggedright\small
\NWtarget{nuweb254}{} $\langle\,${\itshape Export database as XML}\nobreak\ {\footnotesize {254}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    binmode($fh, ":utf8");@\\
\mbox{}\verb@@\\
\mbox{}\verb@#my $oldfh = select $fh; $| = 1; select $oldfh;@\\
\mbox{}\verb@    print($fh "Content-type: application/xml; charset=utf-8\r\n");@\\
\mbox{}\verb@    print($fh "Content-disposition: attachment; filename=\"hackdiet_db.xml\"\r\n");@\\
\mbox{}\verb@    print($fh "\r\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    generateXMLprologue($fh);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $ep = timeXML(time());@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@    <epoch>$ep</epoch>@\\
\mbox{}\verb@    <account version="1.0">@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    $ui->exportUserInformationXML($fh);@\\
\mbox{}\verb@    $ui->exportPreferencesXML($fh);@\\
\mbox{}\verb@    $ui->exportDietPlanXML($fh);@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@    </account>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@logs = $ui->enumerateMonths();@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@    <monthlogs version="1.0">@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    for (my $i = 0; $i <= $#logs; $i++) {@\\
\mbox{}\verb@        if (($logs[$i] ge $start_ym) && ($logs[$i] le $end_ym)) {@\\
\mbox{}\verb@            my $mlog = HDiet::monthlog->new();@\\
\mbox{}\verb@            open(FL, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$logs[$i].hdb") ||@\\
\mbox{}\verb@                die("Cannot open monthly log file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$logs[$i].hdb");@\\
\mbox{}\verb@            $mlog->load(\*FL);@\\
\mbox{}\verb@            close(FL);@\\
\mbox{}\verb@@\\
\mbox{}\verb@            $mlog->exportXML($fh, 1);@\\
\mbox{}\verb@@\\
\mbox{}\verb@            undef($mlog);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@    </monthlogs>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    generateXMLepilogue($fh);@\\
\mbox{}\verb@    exit(0);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb252}{252}.
\item \NWtxtIdentsUsed\nobreak\  \verb@enumerateMonths@\nobreak\ \NWlink{nuweb140}{140}, \verb@exportDietPlanXML@\nobreak\ \NWlink{nuweb139}{139}, \verb@exportPreferencesXML@\nobreak\ \NWlink{nuweb138}{138}, \verb@exportUserInformationXML@\nobreak\ \NWlink{nuweb137}{137}, \verb@exportXML@\nobreak\ \NWlink{nuweb68}{68}, \verb@generateXMLepilogue@\nobreak\ \NWlink{nuweb441b}{441b}, \verb@generateXMLprologue@\nobreak\ \NWlink{nuweb441a}{441a}, \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}, \verb@timeXML@\nobreak\ \NWlink{nuweb443}{443}, \verb@xml@\nobreak\ \NWlink{nuweb440}{440}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Export database as Hacker's Diet Online CSV}

Export the database in our extended CSV format, which allows encoding
of embedded Unicode characters.  All of the selected months are
simply concatenated into one big CSV file, repeating the header lines
for each month.  Our CSV import code handles this with no difficulty,
and it's the only way we can inform it if, for example, the weight unit
changes from one monthly log to another.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap358}\raggedright\small
\NWtarget{nuweb255}{} $\langle\,${\itshape Export database as Hacker's Diet Online CSV}\nobreak\ {\footnotesize {255}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print($fh "Content-type: text/csv; charset=iso-8859-1\r\n");@\\
\mbox{}\verb@    print($fh "Content-disposition: attachment; filename=\"hackdiet_db.csv\"\r\n");@\\
\mbox{}\verb@    print($fh "\r\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print($fh encodeCSV("Epoch", timeXML(time())), "\r\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print($fh encodeCSV("User", "1.0", $ui->{login_name},@\\
\mbox{}\verb@        $ui->{first_name}, $ui->{middle_name}, $ui->{last_name},@\\
\mbox{}\verb@        $ui->{e_mail}, timeXML($ui->{account_created})), "\r\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print($fh encodeCSV("Preferences", "1.0",@\\
\mbox{}\verb@        HDiet::monthlog::WEIGHT_UNITS->[$ui->{log_unit}],@\\
\mbox{}\verb@        HDiet::monthlog::WEIGHT_UNITS->[$ui->{display_unit}],@\\
\mbox{}\verb@        HDiet::monthlog::ENERGY_UNITS->[$ui->{energy_unit}],@\\
\mbox{}\verb@        $ui->{current_rung},@\\
\mbox{}\verb@        $ui->{decimal_character}), "\r\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $at = timeXML($ui->{calc_start_date});@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print($fh encodeCSV("Diet-Plan", "1.0",@\\
\mbox{}\verb@        $ui->{calc_calorie_balance},@\\
\mbox{}\verb@        $ui->{calc_start_weight},@\\
\mbox{}\verb@        $ui->{calc_goal_weight},@\\
\mbox{}\verb@        $at,@\\
\mbox{}\verb@        $ui->{plot_diet_plan}), "\r\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@logs = $ui->enumerateMonths();@\\
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $i = 0; $i <= $#logs; $i++) {@\\
\mbox{}\verb@        if (($logs[$i] ge $start_ym) && ($logs[$i] le $end_ym)) {@\\
\mbox{}\verb@            my $mlog = HDiet::monthlog->new();@\\
\mbox{}\verb@            open(FL, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$logs[$i].hdb") ||@\\
\mbox{}\verb@                die("Cannot open monthly log file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$logs[$i].hdb");@\\
\mbox{}\verb@            $mlog->load(\*FL);@\\
\mbox{}\verb@            close(FL);@\\
\mbox{}\verb@@\\
\mbox{}\verb@            $mlog->exportCSV($fh);@\\
\mbox{}\verb@@\\
\mbox{}\verb@            undef($mlog);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    exit(0);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb252}{252}.
\item \NWtxtIdentsUsed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_goal_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@encodeCSV@\nobreak\ \NWlink{nuweb17}{17}, \verb@ENERGY_UNITS@\nobreak\ \NWlink{nuweb24}{24}, \verb@enumerateMonths@\nobreak\ \NWlink{nuweb140}{140}, \verb@exportCSV@\nobreak\ \NWlink{nuweb64}{64}, \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}, \verb@timeXML@\nobreak\ \NWlink{nuweb443}{443}, \verb@WEIGHT_UNITS@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Export database as Palm Eat Watch CSV}

The database is exported in the format used by the {\tt hdread}
desktop utility used with the Palm Eat Watch.  Exporting in this
format allows logs created with this application to be imported
onto handheld devices running the Palm software.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap359}\raggedright\small
\NWtarget{nuweb256}{} $\langle\,${\itshape Export database as Palm Eat Watch CSV}\nobreak\ {\footnotesize {256}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print($fh "Content-type: text/csv; charset=iso-8859-1\r\n");@\\
\mbox{}\verb@    print($fh "Content-disposition: attachment; filename=\"hackdiet_db.csv\"\r\n");@\\
\mbox{}\verb@    print($fh "\r\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@logs = $ui->enumerateMonths();@\\
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $i = 0; $i <= $#logs; $i++) {@\\
\mbox{}\verb@        if (($logs[$i] ge $start_ym) && ($logs[$i] le $end_ym)) {@\\
\mbox{}\verb@            my $mlog = HDiet::monthlog->new();@\\
\mbox{}\verb@            open(FL, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$logs[$i].hdb") ||@\\
\mbox{}\verb@                die("Cannot open monthly log file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$logs[$i].hdb");@\\
\mbox{}\verb@            $mlog->load(\*FL);@\\
\mbox{}\verb@            close(FL);@\\
\mbox{}\verb@@\\
\mbox{}\verb@            $mlog->exportHDReadCSV($fh);@\\
\mbox{}\verb@@\\
\mbox{}\verb@            undef($mlog);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    exit(0);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb252}{252}.
\item \NWtxtIdentsUsed\nobreak\  \verb@enumerateMonths@\nobreak\ \NWlink{nuweb140}{140}, \verb@exportHDReadCSV@\nobreak\ \NWlink{nuweb65}{65}, \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Export database as Legacy Excel Eat Watch CSV}

The database is exported in the legacy format used by the Excel
Eat Watch spreadsheet.  The data from this export must be pasted
into a spreadsheet created for the year from the master template.
Exporting in this format loses comments which appear on days for
which a weight is entered.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap360}\raggedright\small
\NWtarget{nuweb257}{} $\langle\,${\itshape Export database as Legacy Excel Eat Watch CSV}\nobreak\ {\footnotesize {257}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print($fh "Content-type: text/csv; charset=iso-8859-1\r\n");@\\
\mbox{}\verb@    print($fh "Content-disposition: attachment; filename=\"hackdiet_db.csv\"\r\n");@\\
\mbox{}\verb@    print($fh "\r\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@logs = $ui->enumerateMonths();@\\
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $i = 0; $i <= $#logs; $i++) {@\\
\mbox{}\verb@        if (($logs[$i] ge $start_ym) && ($logs[$i] le $end_ym)) {@\\
\mbox{}\verb@            my $mlog = HDiet::monthlog->new();@\\
\mbox{}\verb@            open(FL, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$logs[$i].hdb") ||@\\
\mbox{}\verb@                die("Cannot open monthly log file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$logs[$i].hdb");@\\
\mbox{}\verb@            $mlog->load(\*FL);@\\
\mbox{}\verb@            close(FL);@\\
\mbox{}\verb@@\\
\mbox{}\verb@            $mlog->exportExcelCSV($fh);@\\
\mbox{}\verb@@\\
\mbox{}\verb@            undef($mlog);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    exit(0);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb252}{252}.
\item \NWtxtIdentsUsed\nobreak\  \verb@enumerateMonths@\nobreak\ \NWlink{nuweb140}{140}, \verb@exportExcelCSV@\nobreak\ \NWlink{nuweb66}{66}, \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Request paper log forms}

Request a document the user can print to use to log weight and exercise
for later entry to the application.  We set the {\tt target} property
of the form so that the paper log document opens in a new window.  If
JavaScript is not available, it will open in the current window and the
user will have to return to the request page with the ``Back'' button.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap361}\raggedright\small
\NWtarget{nuweb258}{} $\langle\,${\itshape Request paper log forms}\nobreak\ {\footnotesize {258}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@years;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Set variables to default to previous request settings}\nobreak\ {\footnotesize \NWlink{nuweb299}{299}, \ldots\ }$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Generate Log Forms", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Generate Paper Log Forms</h1>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<form id="Hdiet_plog" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Selection of months for paper logs}\nobreak\ {\footnotesize \NWlink{nuweb259a}{259a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@<input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@<input type="submit" name="q=do_paper_logs" value=" Generate " />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="reset" value=" Reset " />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="submit" name="q=account" value=" Cancel " />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<script type="text/javascript" defer="defer">@\\
\mbox{}\verb@/* <![CDATA[ */@\\
\mbox{}\verb@    if (document.getElementById && document.getElementById("Hdiet_plog")) {@\\
\mbox{}\verb@        document.getElementById("Hdiet_plog").target = "_blank";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@/* ]]> */@\\
\mbox{}\verb@</script>@\\
\mbox{}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Selection of months for paper logs}

The following controls allow the user to select which months will be
included in the paper log document.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap362}\raggedright\small
\NWtarget{nuweb259a}{} $\langle\,${\itshape Selection of months for paper logs}\nobreak\ {\footnotesize {259a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $jdnow = unix_time_to_jd(time());@\\
\mbox{}\verb@    my ($enowy, $enowm, $enowd) = jd_to_gregorian($jdnow);@\\
\mbox{}\verb@    my @{\tt @}\verb@f_mon;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $y = $enowy - 1; $y <= $enowy + 1; $y++) {@\\
\mbox{}\verb@        $fy_selected[$y - ($enowy - 1)] = $ty_selected[$y - ($enowy - 1)] = '';@\\
\mbox{}\verb@        $years[$y - ($enowy - 1)] = $y;@\\
\mbox{}\verb@        for (my $m = 1; $m <= 12; $m++) {@\\
\mbox{}\verb@            $f_mon[$m] = sprintf("%4d-%02d", $y, $m);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    $fy_selected[1] = ' selected="selected"';@\\
\mbox{}\verb@    $fm_selected[1] = ' selected="selected"';@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print($fh "From\n");@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Custom trend start date}\nobreak\ ({\footnotesize 259b\label{scrap363}
 }\mbox{}\verb@0@ ) {\footnotesize \NWlink{nuweb272}{272}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<br />@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $ty_selected[1] = ' selected="selected"';@\\
\mbox{}\verb@    $tm_selected[12] = ' selected="selected"';@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print($fh "To\n");@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Custom trend end date}\nobreak\ ({\footnotesize 259c\label{scrap364}
 }\mbox{}\verb@0@ ) {\footnotesize \NWlink{nuweb273}{273}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<br />@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb258}{258}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Generate paper log forms}

Generate a document the user can print to use to log weight and exercise
for later entry to the application.  This transaction is invoked
from the request form above, and passed the starting and
ending year and month for the logs to be printed.  The paper log
document is opened it a new window and, a second later, a print
operation is queued (the latter two operations require JavaScript).

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap365}\raggedright\small
\NWtarget{nuweb260}{} $\langle\,${\itshape Generate paper log forms}\nobreak\ {\footnotesize {260}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@years;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Set variables to default to previous request settings}\nobreak\ {\footnotesize \NWlink{nuweb299}{299}, \ldots\ }$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Weight and Exercise Log",@\\
\mbox{}\verb@        " if (window.print) { setTimeout('window.print()', 1000); }", $session->{handheld}, 1);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   If start and end dates are reversed, silently exchange them.@\\
\mbox{}\verb@    if (gregorian_to_jd($CGIargs{from_y}, $CGIargs{from_m}, 1) >@\\
\mbox{}\verb@        gregorian_to_jd($CGIargs{to_y}, $CGIargs{to_m}, 1)) {@\\
\mbox{}\verb@        my ($fy, $fm) = ($CGIargs{from_y}, $CGIargs{from_m});@\\
\mbox{}\verb@        ($CGIargs{from_y}, $CGIargs{from_m}) = ($CGIargs{to_y}, $CGIargs{to_m});@\\
\mbox{}\verb@        ($CGIargs{to_y}, $CGIargs{to_m}) = ($fy, $fm);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $firstpage = 1;@\\
\mbox{}\verb@    for (my $y = $CGIargs{from_y}; $y <= $CGIargs{to_y}; $y++) {@\\
\mbox{}\verb@        my $sm = ($y == $CGIargs{from_y}) ? $CGIargs{from_m} : 1;@\\
\mbox{}\verb@        my $em = ($y == $CGIargs{to_y}) ? $CGIargs{to_m} : 12;@\\
\mbox{}\verb@        for (my $m = $sm; $m <= $em; ) {@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Generate paper log form for month}\nobreak\ {\footnotesize \NWlink{nuweb261}{261}}$\,\rangle$}\verb@@\\
\mbox{}\verb@            $m++;@\\
\mbox{}\verb@            if ($m > 12) {@\\
\mbox{}\verb@                $m = 1;@\\
\mbox{}\verb@                last;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}, \verb@start@\nobreak\ \NWlink{nuweb19b}{19b}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Generate paper log form for month}

A paper log page is generated for the current year and month.  This
page is styled for ``paged media'' (dead trees), and is designed to
print on ISO A4 or U.S. ``A'' size paper with reasonable margins.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap366}\raggedright\small
\NWtarget{nuweb261}{} $\langle\,${\itshape Generate paper log form for month}\nobreak\ {\footnotesize {261}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $plc = $firstpage ? 'plog_first' : 'plog_subsequent';@\\
\mbox{}\verb@    $firstpage = 0;@\\
\mbox{}\verb@    my $mdays = HDiet::monthlog::monthdays($y, $m);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<div class="$plc">@\\
\mbox{}\verb@<h1 class="plog">Weight and Exercise Log</h1>@\\
\mbox{}\verb@<h2 class="plog">$monthNames[$m] $y</h2>@\\
\mbox{}\verb@<table class="plog">@\\
\mbox{}\verb@    <tr class="heading">@\\
\mbox{}\verb@        <th class="h1" colspan="3">Date</th>@\\
\mbox{}\verb@        <td class="s2"></td>@\\
\mbox{}\verb@        <th class="h4">Weight</th>@\\
\mbox{}\verb@        <td class="s4"></td>@\\
\mbox{}\verb@        <th class="h5">Rung</th>@\\
\mbox{}\verb@        <td class="s5"></td>@\\
\mbox{}\verb@        <th class="h6">Flag</th>@\\
\mbox{}\verb@        <td class="s6"></td>@\\
\mbox{}\verb@        <th class="h7">Comments</th>@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $wday = jd_to_weekday(gregorian_to_jd($y, $m, 1));@\\
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $d = 1; $d <= $mdays; $d++) {@\\
\mbox{}\verb@        my $wdn = substr(HDiet::Julian::WEEKDAY_NAMES->[$wday], 0, 3);@\\
\mbox{}\verb@        $wday = ($wday + 1) % 7;@\\
\mbox{}\verb@        #   The "&nbsp;"s in this table are courtesy of crap-bag@\\
\mbox{}\verb@        #   Internet Explorer, which doesn't draw a border below@\\
\mbox{}\verb@        #   a table cell if it's empty.@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@    <tr>@\\
\mbox{}\verb@        <th class="c1">$d</th>@\\
\mbox{}\verb@        <td class="s1"></td>@\\
\mbox{}\verb@        <td class="c2">$wdn</td>@\\
\mbox{}\verb@        <td class="s2"></td>@\\
\mbox{}\verb@        <td class="c3">&nbsp;</td>@\\
\mbox{}\verb@        <td class="s3"></td>@\\
\mbox{}\verb@        <td class="c4">&nbsp;</td>@\\
\mbox{}\verb@        <td class="s4"></td>@\\
\mbox{}\verb@        <td class="c5">&nbsp;</td>@\\
\mbox{}\verb@        <td class="s5"></td>@\\
\mbox{}\verb@        <td class="c6">&nbsp;</td>@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@</table>@\\
\mbox{}\verb@</div>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb260}{260}.
\item \NWtxtIdentsUsed\nobreak\  \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@jd_to_weekday@\nobreak\ \NWlink{nuweb449a}{449a}, \verb@Julian@\nobreak\ \NWlink{nuweb445}{445}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}, \verb@WEEKDAY_NAMES@\nobreak\ \NWlink{nuweb445}{445}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Download backup copy of all logs for user}

A user may download a Zipped archive containing logs for all
months in the database by submitting a ``backup'' request.  The
backup is returned as an in-line download, created on the
fly by invoking the ``{\tt zip}'' program with its output directed to
standard output, which is returned from the CGI application.
The default file name is
``{\tt hackdiet\_log\_backup\_}{\em YYYY}{\tt -}{\em MM}{\tt -}{\em DD}{\tt .zip}'',
based on the current date in UTC.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap367}\raggedright\small
\NWtarget{nuweb262}{} $\langle\,${\itshape Download backup copy of all logs for user}\nobreak\ {\footnotesize {262}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $nlogs = `ls -1 @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/????-??.hdb 2>/dev/null | wc -l`;@\\
\mbox{}\verb@    chomp($nlogs);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($nlogs > 0) {@\\
\mbox{}\verb@        my ($year, $mon, $mday, $hour, $min, $sec) =@\\
\mbox{}\verb@            unix_time_to_civil_date_time($userTime);@\\
\mbox{}\verb@        my $date = sprintf("%04d-%02d-%02d", $year, $mon, $mday);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print($fh "Content-type: application/zip\r\n");@\\
\mbox{}\verb@        print($fh "Content-disposition: attachment; filename=\"hackdiet_log_backup_$date.zip\"\r\n");@\\
\mbox{}\verb@        print($fh "\r\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@        system("zip -q -j - @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/????-??.hdb");@\\
\mbox{}\verb@        exit(0);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape MIME Content-type specification}\nobreak\ {\footnotesize \NWlink{nuweb390a}{390a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@write_XHTML_prologue($fh, $homeBase, "Download backup copy", undef, $session->{handheld});@\\
\mbox{}\verb@generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">You have no logs to back up!</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=log&amp;s=$session->{session_id}$tzOff">Back to monthly log</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    update_last_transaction($user_file_name) if !$readOnly;@\\
\mbox{}\verb@    exit(0);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb178}{178}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@min@\nobreak\ \NWlink{nuweb405}{405}, \verb@unix_time_to_civil_date_time@\nobreak\ \NWlink{nuweb451b}{451b}, \verb@update_last_transaction@\nobreak\ \NWlink{nuweb398}{398}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Generate monthly chart}

A monthly chart is generated and returned as an in-line PNG image by
the ``chart'' query, where, as for the monthly log documents in which
such charts are usually embedded, the ``m'' argument specifies the year
and month to be charted.  It is perfectly valid to request a chart for
a month for which no log exists in the database; an empty log will be
synthesised and a blank chart generated.  Optional ``width'' and ``height''
arguments allow specifying the chart size.  If omitted, the chart defaults
to 640$\times$480 pixels.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap368}\raggedright\small
\NWtarget{nuweb263a}{} $\langle\,${\itshape Generate monthly chart}\nobreak\ {\footnotesize {263a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Sanity check year and month specification}\nobreak\ {\footnotesize \NWlink{nuweb207}{207}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Read log if in database or create blank log if it's not}\nobreak\ {\footnotesize \NWlink{nuweb210}{210}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Specify Content-type for PNG image}\nobreak\ {\footnotesize \NWlink{nuweb263b}{263b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $CGIargs{width} = ($session->{handheld} ? 320 : 640) if !defined $CGIargs{width};@\\
\mbox{}\verb@    $CGIargs{height} = ($session->{handheld} ? 240 : 480) if !defined $CGIargs{height};@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@dcalc;@\\
\mbox{}\verb@    if ($ui->{plot_diet_plan}) {@\\
\mbox{}\verb@        @{\tt @}\verb@dcalc = $ui->dietPlanLimits();@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $mlog->plotChart($fh, $CGIargs{width}, $CGIargs{height},@\\
\mbox{}\verb@        $ui->{display_unit}, $ui->{decimal_character}, \@{\tt @}\verb@dcalc,@\\
\mbox{}\verb@        $CGIargs{print}, $CGIargs{mono});@\\
\mbox{}\verb@@\\
\mbox{}\verb@    update_last_transaction($user_file_name) if !$readOnly;@\\
\mbox{}\verb@    exit(0);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb178}{178}.
\item \NWtxtIdentsUsed\nobreak\  \verb@dietPlanLimits@\nobreak\ \NWlink{nuweb142}{142}, \verb@plotChart@\nobreak\ \NWlink{nuweb46}{46}, \verb@update_last_transaction@\nobreak\ \NWlink{nuweb398}{398}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Specify Content-type for PNG image}

Embedded images for charts are included in HTML documents as
query URLs which provide all of the parameters required to generate
the image.  When the browser renders the document, it will send a request
to the server, which prepares the image on the fly.  This approach makes
generation of the image ``stateless''---it can be performed by any
server in the cluster so long as it has access to the current
database from which the image is to be generated.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap369}\raggedright\small
\NWtarget{nuweb263b}{} $\langle\,${\itshape Specify Content-type for PNG image}\nobreak\ {\footnotesize {263b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print($fh "Content-type: image/png\r\n\r\n");@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb263a}{263a}\NWlink{nuweb303}{, 303}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Trend analysis}

Output the trend analysis page.  This page contains the default trend
analyses for periods ending at the present, and includes a form to
request custom trend analyses.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap370}\raggedright\small
\NWtarget{nuweb264}{} $\langle\,${\itshape Trend analysis}\nobreak\ {\footnotesize {264}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@years = $ui->enumerateYears();@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Trend Analysis", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, "Trend", undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($#years >= 0) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Emit trend anlysis page}\nobreak\ {\footnotesize \NWlink{nuweb265a}{265a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@        <h2>You have no log entries!  You must enter weight logs@\\
\mbox{}\verb@            before you can perform trend analysis.</h2>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=account&amp;s=$session->{session_id}$tzOff">Back to account page</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    update_last_transaction($user_file_name) if !$readOnly;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@enumerateYears@\nobreak\ \NWlink{nuweb141}{141}, \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@update_last_transaction@\nobreak\ \NWlink{nuweb398}{398}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Emit trend anlysis page}

Generate the page containing the trend analyses for the various intervals.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap371}\raggedright\small
\NWtarget{nuweb265a}{} $\langle\,${\itshape Emit trend anlysis page}\nobreak\ {\footnotesize {265a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Trend Analysis</h1>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Determine first and last days in database}\nobreak\ {\footnotesize \NWlink{nuweb253}{253}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Add standard intervals to analysis list}\nobreak\ {\footnotesize \NWlink{nuweb265b}{265b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Process custom interval specification, if any}\nobreak\ {\footnotesize \NWlink{nuweb266}{266}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($custom) {@\\
\mbox{}\verb@        push(@{\tt @}\verb@intervals, sprintf("%04d-%02d-%02d", $cust_start_y, $cust_start_m, $cust_start_d),@\\
\mbox{}\verb@                          sprintf("%04d-%02d-%02d", $cust_end_y, $cust_end_m, $cust_end_d));@\\
\mbox{}\verb@        push(@{\tt @}\verb@dayspan, ($cust_end_jd - $cust_start_jd) + 1);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Output trend analysis report for intervals evaluated}\nobreak\ {\footnotesize \NWlink{nuweb267}{267}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Set variables to default to previous request settings}\nobreak\ {\footnotesize \NWlink{nuweb299}{299}, \ldots\ }$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate form fields for custom trend interval}\nobreak\ {\footnotesize \NWlink{nuweb270}{270}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb264}{264}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Add standard intervals to analysis list}

Each of the standard trend analysis intervals (week, fortnight,
month, etc.) are evaluated back from the last log entry in
the database.  Each interval which begins on or after the
first entry in the database is added to the list of
intervals for which the trend will be evaluated.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap372}\raggedright\small
\NWtarget{nuweb265b}{} $\langle\,${\itshape Add standard intervals to analysis list}\nobreak\ {\footnotesize {265b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my (@{\tt @}\verb@intervals, @{\tt @}\verb@dayspan);@\\
\mbox{}\verb@    for my $interval (7, 14, -1, -3, -6, -12) {@\\
\mbox{}\verb@        my ($f_y, $f_m, $f_d) = $hist->firstDayOfInterval($l_y, $l_m, $l_d, $interval);@\\
\mbox{}\verb@        my $f_jd = gregorian_to_jd($f_y, $f_m, $f_d);@\\
\mbox{}\verb@        if ($f_jd < $s_jd) {@\\
\mbox{}\verb@            last;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        push(@{\tt @}\verb@intervals, sprintf("%04d-%02d-%02d", $f_y, $f_m, $f_d),@\\
\mbox{}\verb@                          sprintf("%04d-%02d-%02d", $l_y, $l_m, $l_d));@\\
\mbox{}\verb@        push(@{\tt @}\verb@dayspan, ($l_jd - $f_jd) + 1);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb265a}{265a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@firstDayOfInterval@\nobreak\ \NWlink{nuweb111}{111}, \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Process custom interval specification, if any}

If a custom interval has been requested, validate it and add it
to the end of the list of intervals to be computed.  If the
custom interval is void, custom interval generation is disabled.
If the start and end of the interval are reversed, put them in
the correct order.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap373}\raggedright\small
\NWtarget{nuweb266}{} $\langle\,${\itshape Process custom interval specification, if any}\nobreak\ {\footnotesize {266}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $custom = $CGIargs{period} && ($CGIargs{period} eq 'c');@\\
\mbox{}\verb@    my ($cust_start_y, $cust_start_m, $cust_start_d, $cust_start_jd,@\\
\mbox{}\verb@        $cust_end_y, $cust_end_m, $cust_end_d,$cust_end_jd);@\\
\mbox{}\verb@    if ($custom) {@\\
\mbox{}\verb@        ($cust_start_y, $cust_start_m, $cust_start_d) = ($CGIargs{from_y}, $CGIargs{from_m}, $CGIargs{from_d});@\\
\mbox{}\verb@        $cust_start_jd = gregorian_to_jd($cust_start_y, $cust_start_m, $cust_start_d);@\\
\mbox{}\verb@        ($cust_end_y, $cust_end_m, $cust_end_d) = ($CGIargs{to_y}, $CGIargs{to_m}, $CGIargs{to_d});@\\
\mbox{}\verb@        $cust_end_jd = gregorian_to_jd($cust_end_y, $cust_end_m, $cust_end_d);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($cust_end_jd != $cust_start_jd) {@\\
\mbox{}\verb@            #   If start or end of interval is outside the database,@\\
\mbox{}\verb@            #   constrain it to the  first or last entry.@\\
\mbox{}\verb@            if (($cust_start_jd < $s_jd) || ($cust_start_jd > $l_jd)) {@\\
\mbox{}\verb@                ($cust_start_y, $cust_start_m, $cust_start_d, $cust_start_jd) =@\\
\mbox{}\verb@                    ($s_y, $s_m, $s_d, $s_jd);@\\
\mbox{}\verb@               ($CGIargs{from_y}, $CGIargs{from_m}, $CGIargs{from_d}) =@\\
\mbox{}\verb@                    ($cust_start_y, $cust_start_m, $cust_start_d);@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            if (($cust_end_jd < $s_jd) || ($cust_end_jd > $l_jd)) {@\\
\mbox{}\verb@                ($cust_end_y, $cust_end_m, $cust_end_d, $cust_end_jd) =@\\
\mbox{}\verb@                    ($l_y, $l_m, $l_d, $l_jd);@\\
\mbox{}\verb@                ($CGIargs{to_y}, $CGIargs{to_m}, $CGIargs{to_d}) =@\\
\mbox{}\verb@                    ($cust_end_y, $cust_end_m, $cust_end_d);@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@@\\
\mbox{}\verb@            #   If end of interval is before start, reverse them@\\
\mbox{}\verb@            if ($cust_end_jd < $cust_start_jd) {@\\
\mbox{}\verb@                my @{\tt @}\verb@temp = ($cust_start_y, $cust_start_m, $cust_start_d, $cust_start_jd);@\\
\mbox{}\verb@                ($cust_start_y, $cust_start_m, $cust_start_d, $cust_start_jd) =@\\
\mbox{}\verb@                    ($cust_end_y, $cust_end_m, $cust_end_d, $cust_end_jd);@\\
\mbox{}\verb@                ($CGIargs{from_y}, $CGIargs{from_m}, $CGIargs{from_d}) =@\\
\mbox{}\verb@                    ($cust_start_y, $cust_start_m, $cust_start_d);@\\
\mbox{}\verb@                ($cust_end_y, $cust_end_m, $cust_end_d, $cust_end_jd) = @{\tt @}\verb@temp;@\\
\mbox{}\verb@                ($CGIargs{to_y}, $CGIargs{to_m}, $CGIargs{to_d}) =@\\
\mbox{}\verb@                    ($cust_end_y, $cust_end_m, $cust_end_d);@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $custom = 0;                # Void interval disables custom display@\\
\mbox{}\verb@            $CGIargs{period} = '';@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb252}{252}\NWlink{nuweb265a}{, 265a}\NWlink{nuweb295}{, 295}.
\item \NWtxtIdentsUsed\nobreak\  \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}, \verb@start@\nobreak\ \NWlink{nuweb19b}{19b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Output trend analysis report for intervals evaluated}

Generate a table with rows for each of the intervals for which we
we computed a trend.  If there were so few days that we couldn't
compute even the shortest interval, a message is output explaining
the absence of a trend report.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap374}\raggedright\small
\NWtarget{nuweb267}{} $\langle\,${\itshape Output trend analysis report for intervals evaluated}\nobreak\ {\footnotesize {267}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($#intervals >= 0) {@\\
\mbox{}\verb@        my $wu = HDiet::monthlog::DELTA_WEIGHT_UNITS->[$ui->{display_unit}];@\\
\mbox{}\verb@        my $eu = HDiet::monthlog::ENERGY_UNITS->[$ui->{energy_unit}];@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<table class="trendan" border="border">@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@    <th class="custitle" colspan="6">Intervals ending $intervals[1]</th>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@    <th rowspan="2">Last&hellip;</th>@\\
\mbox{}\verb@    <th rowspan="2"><span class="r">Gain</span>/<span class="g">Loss</span><br /> ${wu}s/week</th>@\\
\mbox{}\verb@    <th rowspan="2"><span class="r">Excess</span>/<span class="g">Deficit</span><br />${eu}s/day</th>@\\
\mbox{}\verb@    <th colspan="3" style="border-bottom: none;">Weight Trend</th>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@    <th style="border-top: none; border-right: none;">Min.</th>@\\
\mbox{}\verb@    <th style="border-top: none; border-left: none; border-right: none;">Mean</th>@\\
\mbox{}\verb@    <th style="border-top: none; border-left: none;">Max.</th>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        my @{\tt @}\verb@slopes = $hist->analyseTrend(@{\tt @}\verb@intervals);@\\
\mbox{}\verb@        my @{\tt @}\verb@inames = ( 'Week', 'Fortnight', 'Month', 'Quarter', 'Six months', 'Year' );@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Output table rows for each interval analysed}\nobreak\ {\footnotesize \NWlink{nuweb268}{268}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@</table>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h2>There are insufficient log entries to perform@\\
\mbox{}\verb@trend analysis.  You need at least a week's data@\\
\mbox{}\verb@to compute a trend.</h2>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb265a}{265a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@analyseTrend@\nobreak\ \NWlink{nuweb79}{79}, \verb@ENERGY_UNITS@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Output table rows for each interval analysed}

For each interval for which we computed a trend, output a row in
the analysis table listing the interval, weight gain/loss, and
energy balance for that interval.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap375}\raggedright\small
\NWtarget{nuweb268}{} $\langle\,${\itshape Output table rows for each interval analysed}\nobreak\ {\footnotesize {268}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $i = 0; $i < (($#slopes + 1) / 4); $i++) {@\\
\mbox{}\verb@        my $tslope = $slopes[$i * 4];@\\
\mbox{}\verb@        my $deltaW = sprintf("%.2f", $tslope * 7);@\\
\mbox{}\verb@        $deltaW =~ s/\./$ui->{decimal_character}/;@\\
\mbox{}\verb@        my $deltaE = sprintf("%.0f", $tslope *@\\
\mbox{}\verb@            (HDiet::monthlog::CALORIES_PER_WEIGHT_UNIT->[$ui->{display_unit}] /@\\
\mbox{}\verb@             HDiet::monthlog::CALORIES_PER_ENERGY_UNIT->[$ui->{energy_unit}]));@\\
\mbox{}\verb@        my $colour = $tslope > 0 ? 'r' : 'g';@\\
\mbox{}\verb@        my $ecolour = $colour;@\\
\mbox{}\verb@        if ($deltaW =~ m/^\-?0[\.,]00$/) {@\\
\mbox{}\verb@            $colour = 'bk';@\\
\mbox{}\verb@            $deltaW =~ s/^\-//;@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $deltaW =~ s/^(\d)/\+$1/;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if ($deltaE =~ m/^\-?0$/) {@\\
\mbox{}\verb@            $ecolour = 'bk';@\\
\mbox{}\verb@            $deltaE =~ s/^\-//;@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $deltaE =~ s/^(\d)/\+$1/;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $deltaW =~ s/\-/&minus;/;@\\
\mbox{}\verb@        $deltaE =~ s/\-/&minus;/;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $eMinWeight = HDiet::monthlog::editWeight($slopes[($i * 4) + 1],@\\
\mbox{}\verb@            $ui->{display_unit}, $ui->{decimal_character});@\\
\mbox{}\verb@        my $eMaxWeight = HDiet::monthlog::editWeight($slopes[($i * 4) + 2],@\\
\mbox{}\verb@            $ui->{display_unit}, $ui->{decimal_character});@\\
\mbox{}\verb@        my $eMeanWeight = HDiet::monthlog::editWeight($slopes[($i * 4) + 3],@\\
\mbox{}\verb@            $ui->{display_unit}, $ui->{decimal_character});@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Label trend report for custom interval}\nobreak\ {\footnotesize \NWlink{nuweb269}{269}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@    <td>$inames[$i]</td>@\\
\mbox{}\verb@    <td class="w"><span class="$colour">$deltaW</span></td>@\\
\mbox{}\verb@    <td class="e"><span class="$ecolour">$deltaE</span></td>@\\
\mbox{}\verb@    <td class="e">$eMinWeight</td>@\\
\mbox{}\verb@    <td class="e">$eMeanWeight</td>@\\
\mbox{}\verb@    <td class="e">$eMaxWeight</td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb267}{267}.
\item \NWtxtIdentsUsed\nobreak\  \verb@CALORIES_PER_ENERGY_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@CALORIES_PER_WEIGHT_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@editWeight@\nobreak\ \NWlink{nuweb41a}{41a}\NWlink{nuweb485a}{, 485a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Label trend report for custom interval}

If this is the row reporting a custom interval, synthesise a label
giving its duration in years, months, and days.  A separator row
sets off the custom interval from the standard intervals.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap376}\raggedright\small
\NWtarget{nuweb269}{} $\langle\,${\itshape Label trend report for custom interval}\nobreak\ {\footnotesize {269}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@#print(STDERR "Custom $custom $i $#slopes\n");@\\
\mbox{}\verb@    if ($custom && ($i == (($#slopes + 1) / 4) - 1)) {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@    <th class="custitle" colspan="6">$intervals[$i * 2] &ndash; $intervals[($i * 2) + 1]</th>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        my ($cd_y, $cd_m, $cd_d) = (0, 0, 0);@\\
\mbox{}\verb@        my $cd_lastm = $cust_end_jd;@\\
\mbox{}\verb@        while (1) {@\\
\mbox{}\verb@            my ($ly, $lm, $ld) = $hist->firstDayOfInterval($cust_end_y, $cust_end_m, $cust_end_d, -($cd_m + 1));@\\
\mbox{}\verb@            my $mjd = gregorian_to_jd($ly, $lm, $ld);@\\
\mbox{}\verb@            if ($mjd < $cust_start_jd) {@\\
\mbox{}\verb@                last;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            $cd_m++;@\\
\mbox{}\verb@            $cd_lastm = $mjd;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $cd_d = $cd_lastm - $cust_start_jd;@\\
\mbox{}\verb@        $cd_y = int($cd_m / 12);@\\
\mbox{}\verb@        $cd_m %= 12;@\\
\mbox{}\verb@        my $custdur = (($cd_y > 0) ? "$cd_y y " : '') .@\\
\mbox{}\verb@                      (($cd_m > 0) ? "$cd_m m " : '') .@\\
\mbox{}\verb@                      (($cd_d > 0) ? "$cd_d d " : '');@\\
\mbox{}\verb@        $inames[$i] = $custdur;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb268}{268}.
\item \NWtxtIdentsUsed\nobreak\  \verb@firstDayOfInterval@\nobreak\ \NWlink{nuweb111}{111}, \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Generate form fields for custom trend interval}

Following the trend report we output a form, initialise to the
parameters of the current report (or defaults if this is the
first trend report generated), which allows the user to
request a trend report for a custom interval.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap377}\raggedright\small
\NWtarget{nuweb270}{} $\langle\,${\itshape Generate form fields for custom trend interval}\nobreak\ {\footnotesize {270}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<form id="Hdiet_histchart" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<label><input type="checkbox" name="period" value="c"$percheck{c} />&nbsp;<b>Custom</b></label>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Custom start and end date selection boxes}\nobreak\ {\footnotesize \NWlink{nuweb271a}{271a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<br />@\\
\mbox{}\verb@@\\
\mbox{}\verb@<input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@<input type="submit" name="q=trendan" value=" Update " />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="reset" value=" Reset " />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb265a}{265a}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Custom start and end date selection boxes}

The start and end dates of a custom interval are chosen with
selection boxes populated with the range of dates present in
the database.  If no previous selection was made, these
fields are initially set to the first and last days in
the entire database.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap378}\raggedright\small
\NWtarget{nuweb271a}{} $\langle\,${\itshape Custom start and end date selection boxes}\nobreak\ {\footnotesize {271a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@f_mon;@\\
\mbox{}\verb@    my $fmon;@\\
\mbox{}\verb@    if (!$CGIargs{from_y}) {@\\
\mbox{}\verb@        $fy_selected[0] = ' selected="selected"';@\\
\mbox{}\verb@        @{\tt @}\verb@f_mon = $ui->enumerateMonths($years[0]);@\\
\mbox{}\verb@        $f_mon[0] =~ m/^\d+\-(\d+)$/;@\\
\mbox{}\verb@        $fmon = $1 + 0;@\\
\mbox{}\verb@        $fm_selected[$fmon] = ' selected="selected"';@\\
\mbox{}\verb@        $fd_selected[$s_d] = ' selected="selected"';@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print($fh "From\n");@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Custom trend start date}\nobreak\ ({\footnotesize 271b\label{scrap379}
 }\mbox{}\verb@1@ ) {\footnotesize \NWlink{nuweb272}{272}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<br />@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (!$CGIargs{to_y}) {@\\
\mbox{}\verb@        $ty_selected[$#years] = ' selected="selected"';@\\
\mbox{}\verb@        @{\tt @}\verb@f_mon = $ui->enumerateMonths($years[$#years]);@\\
\mbox{}\verb@        $f_mon[$#f_mon] =~ m/^\d+\-(\d+)$/;@\\
\mbox{}\verb@        $fmon = $1 + 0;@\\
\mbox{}\verb@        $tm_selected[$fmon] = ' selected="selected"';@\\
\mbox{}\verb@        $td_selected[$l_d] = ' selected="selected"';@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print($fh "To\n");@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Custom trend end date}\nobreak\ ({\footnotesize 271c\label{scrap380}
 }\mbox{}\verb@1@ ) {\footnotesize \NWlink{nuweb273}{273}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb270}{270}\NWlink{nuweb296}{, 296}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subparagraph{Custom trend start date}

The following selection fields specify the starting date of the
custom interval.  A macro argument controls whether a selection
field for days is generated (nonzero) or omitted (zero).  A
second macro argument controls whether an {\tt onchange}
attribute is included in the selection fields.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap381}\raggedright\small
\NWtarget{nuweb272}{} $\langle\,${\itshape Custom trend start date}\nobreak\ {\footnotesize {272}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my ($ysel, $msel, $dsel) = ("") x 3;@\\
\mbox{}\verb@    if ("@{\tt @}\verb@2") {@\\
\mbox{}\verb@        $ysel = ' onchange="change_from_y();"';@\\
\mbox{}\verb@        $msel = ' onchange="change_from_m();"';@\\
\mbox{}\verb@        $dsel = ' onchange="change_from_d();"';@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@    <select name="from_y" id="from_y"$ysel>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate option items for years in database}\nobreak\ {\footnotesize \NWlink{nuweb301b}{301b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@    </select>&nbsp;<select name="from_m" id="from_m"$msel>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $mid = "fm_";@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate option items for months}\nobreak\ {\footnotesize \NWlink{nuweb302a}{302a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@    </select>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (@{\tt @}\verb@1) {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@    <select name="from_d" id="from_d"$dsel>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $did;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (@{\tt @}\verb@1) {@\\
\mbox{}\verb@        $did = "fd_";@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Generate option items for days}\nobreak\ {\footnotesize \NWlink{nuweb302b}{302b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@        </select>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb251a}{251a}\NWlink{nuweb259a}{, 259a}\NWlink{nuweb271a}{, 271a}\NWlink{nuweb282a}{, 282a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@change_from_d@\nobreak\ \NWlink{nuweb513b}{513b}, \verb@change_from_m@\nobreak\ \NWlink{nuweb513b}{513b}, \verb@change_from_y@\nobreak\ \NWlink{nuweb513b}{513b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subparagraph{Custom trend end date}

The following selection fields specify the ending date of the
custom interval.  A macro argument controls whether a selection
field for days is generated (nonzero) or omitted (zero).  A
second macro argument controls whether an {\tt onchange}
attribute is included in the selection fields.


\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap382}\raggedright\small
\NWtarget{nuweb273}{} $\langle\,${\itshape Custom trend end date}\nobreak\ {\footnotesize {273}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    ($ysel, $msel, $dsel) = ("") x 3;@\\
\mbox{}\verb@    if ("@{\tt @}\verb@2") {@\\
\mbox{}\verb@        $ysel = ' onchange="change_to_y();"';@\\
\mbox{}\verb@        $msel = ' onchange="change_to_m();"';@\\
\mbox{}\verb@        $dsel = ' onchange="change_to_d();"';@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@    <select name="to_y" id="to_y"$ysel>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @{\tt @}\verb@fy_selected = @{\tt @}\verb@ty_selected;@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate option items for years in database}\nobreak\ {\footnotesize \NWlink{nuweb301b}{301b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@    </select>&nbsp;<select name="to_m" id="to_m"$msel>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $mid = "tm_";@\\
\mbox{}\verb@    @{\tt @}\verb@fm_selected = @{\tt @}\verb@tm_selected;@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate option items for months}\nobreak\ {\footnotesize \NWlink{nuweb302a}{302a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@    </select>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (@{\tt @}\verb@1) {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@    <select name="to_d" id="to_d"$dsel>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (@{\tt @}\verb@1) {@\\
\mbox{}\verb@        $did = "td_";@\\
\mbox{}\verb@        @{\tt @}\verb@fd_selected = @{\tt @}\verb@td_selected;@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Generate option items for days}\nobreak\ {\footnotesize \NWlink{nuweb302b}{302b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@    </select>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb251a}{251a}\NWlink{nuweb259a}{, 259a}\NWlink{nuweb271a}{, 271a}\NWlink{nuweb282a}{, 282a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@change_to_d@\nobreak\ \NWlink{nuweb514b}{514b}, \verb@change_to_m@\nobreak\ \NWlink{nuweb514b}{514b}, \verb@change_to_y@\nobreak\ \NWlink{nuweb514b}{514b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Diet calculator}

Generate the diet calculator page.  The fields are initially filled in
from the values saved in the {\tt user} object.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap383}\raggedright\small
\NWtarget{nuweb274}{} $\langle\,${\itshape Diet calculator}\nobreak\ {\footnotesize {274}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Diet Calculator", "loadDietCalcFields();", $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef,@\\
\mbox{}\verb@        'onclick="return leaveDocument();"', $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Set primary diet calculator fields from user object}\nobreak\ {\footnotesize \NWlink{nuweb275}{275}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Calculate dependent variables from primary variables}\nobreak\ {\footnotesize \NWlink{nuweb284}{284}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@years;@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate array of years for diet calculator selection}\nobreak\ {\footnotesize \NWlink{nuweb277a}{277a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@goofs;@\\
\mbox{}\verb@    if ($CGIargs{q} eq 'update_dietcalc') {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Perform static update of diet calculator}\nobreak\ {\footnotesize \NWlink{nuweb286}{286}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Preset diet calculator start and end dates}\nobreak\ {\footnotesize \NWlink{nuweb277b}{277b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Set variables to default to previous request settings}\nobreak\ {\footnotesize \NWlink{nuweb299}{299}, \ldots\ }$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $e_sw = HDiet::monthlog::editWeight($calc_start_weight, $calc_weight_unit, $ui->{decimal_character});@\\
\mbox{}\verb@    my $e_gw = HDiet::monthlog::editWeight($calc_goal_weight, $calc_weight_unit, $ui->{decimal_character});@\\
\mbox{}\verb@    my $e_dw = HDiet::monthlog::editWeight($calc_weight_change, $calc_weight_unit, $ui->{decimal_character});@\\
\mbox{}\verb@    my $e_ww = HDiet::monthlog::editWeight($calc_weight_week, $calc_weight_unit, $ui->{decimal_character});@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Diet Calculator</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Generate warning if JavaScript disabled in diet calculator form}\nobreak\ {\footnotesize \NWlink{nuweb276a}{276a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Report warnings from static diet calculator update}\nobreak\ {\footnotesize \NWlink{nuweb276b}{276b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<form id="Hdiet_newacct" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Generate diet calculator form}\nobreak\ {\footnotesize \NWlink{nuweb278a}{278a}, \ldots\ }$\,\rangle$}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (!$browse_public) {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Diet calculator form action buttons}\nobreak\ {\footnotesize \NWlink{nuweb283}{283}}$\,\rangle$}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    update_last_transaction($user_file_name) if !$readOnly;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@calc_goal_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_weight_change,@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_weight_unit,@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_weight_week@\nobreak\ \NWlink{nuweb505}{505}, \verb@editWeight@\nobreak\ \NWlink{nuweb41a}{41a}\NWlink{nuweb485a}{, 485a}, \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@leaveDocument@\nobreak\ \NWlink{nuweb484b}{484b}, \verb@loadDietCalcFields@\nobreak\ \NWlink{nuweb506}{506}, \verb@update_last_transaction@\nobreak\ \NWlink{nuweb398}{398}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Set primary diet calculator fields from user object}

We somewhat arbitrarily divide the diet calculator fields into ``primary''
and ``dependent'' quantities.  The primary quantities are those which are
stored in the {\tt user} object, and the dependent quantities are computed
from them when the form is displayed.  Of course, the user may change
the dependent quantities, with the changes propagated back to the
primary quantities in the defined fashion.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap384}\raggedright\small
\NWtarget{nuweb275}{} $\langle\,${\itshape Set primary diet calculator fields from user object}\nobreak\ {\footnotesize {275}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my ($calc_calorie_balance, $calc_start_weight, $calc_goal_weight,@\\
\mbox{}\verb@        $calc_weight_change, $calc_weight_week, $calc_weeks, $calc_months,, $calc_end_date,@\\
\mbox{}\verb@        $calc_start_date, $plot_diet_plan, $calc_weight_unit, $calc_energy_unit) =@\\
\mbox{}\verb@       (round($ui->{calc_calorie_balance} * ENERGY_CONVERSION->[ENERGY_CALORIE][$ui->{energy_unit}]),@\\
\mbox{}\verb@        $ui->{calc_start_weight} * WEIGHT_CONVERSION->[WEIGHT_KILOGRAM][$ui->{display_unit}],@\\
\mbox{}\verb@        $ui->{calc_goal_weight} * WEIGHT_CONVERSION->[WEIGHT_KILOGRAM][$ui->{display_unit}],@\\
\mbox{}\verb@        0, 0, 0, 0, 0,@\\
\mbox{}\verb@        $ui->{calc_start_date}, $ui->{plot_diet_plan},@\\
\mbox{}\verb@        $ui->{display_unit}, $ui->{energy_unit}@\\
\mbox{}\verb@       );@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Override diet calculator primary fields from form fields}\nobreak\ {\footnotesize \NWlink{nuweb285}{285}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $ckplan = $ui->{plot_diet_plan} ? ' checked="checked"' : '';@\\
\mbox{}\verb@    my @{\tt @}\verb@eunit = ('', '');@\\
\mbox{}\verb@    $eunit[$calc_energy_unit] = ' selected="selected"';@\\
\mbox{}\verb@    my @{\tt @}\verb@wunit = ('', '', '');@\\
\mbox{}\verb@    $wunit[$calc_weight_unit] = ' selected="selected"';@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($calc_start_date == 0) {@\\
\mbox{}\verb@        $calc_start_date = time();@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   If no start weight specified, use last trend value from the@\\
\mbox{}\verb@    #   most recent log or a default if no logs exist.@\\
\mbox{}\verb@    if ($calc_start_weight == 0) {@\\
\mbox{}\verb@        my $hist = HDiet::history->new($ui, $user_file_name);@\\
\mbox{}\verb@        my ($ly, $lm, $ld, $ldu, $lw, $lt) = $hist->lastDay();@\\
\mbox{}\verb@        if (defined($lt)) {@\\
\mbox{}\verb@            $calc_start_weight = sprintf("%.1f", $lt * WEIGHT_CONVERSION->[$ldu][$ui->{display_unit}]);@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $calc_start_weight = ($ui->{display_unit} == WEIGHT_KILOGRAM) ? 80 : 175;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   If no goal weight specified, assume 5 kilos or 10 pounds loss@\\
\mbox{}\verb@    if ($calc_goal_weight == 0) {@\\
\mbox{}\verb@        $calc_goal_weight = $calc_start_weight - (($ui->{display_unit} == WEIGHT_KILOGRAM) ? 5 : 10);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb274}{274}.
\item \NWtxtIdentsUsed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_end_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_goal_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_months@\nobreak\ \NWlink{nuweb513a}{513a}, \verb@calc_months,@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_weeks@\nobreak\ \NWlink{nuweb505}{505}\NWlink{nuweb512b}{, 512b}, \verb@calc_weight_change,@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_weight_unit,@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_weight_week@\nobreak\ \NWlink{nuweb505}{505}, \verb@ENERGY_CALORIE@\nobreak\ \NWlink{nuweb24}{24}, \verb@ENERGY_CONVERSION@\nobreak\ \NWlink{nuweb24}{24}, \verb@lastDay@\nobreak\ \NWlink{nuweb108}{108}, \verb@start@\nobreak\ \NWlink{nuweb19b}{19b}, \verb@WEIGHT_KILOGRAM@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}
\vbox{
\subsubsection{Generate warning if JavaScript disabled in diet calculator form}

If JavaScript is not enabled, a warning is omitted which reminds
the user to press the ``Update'' button after each single-field
change.  This is the only way the static CGI update code can know
the order in which to apply changes.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap385}\raggedright\small
\NWtarget{nuweb276a}{} $\langle\,${\itshape Generate warning if JavaScript disabled in diet calculator form}\nobreak\ {\footnotesize {276a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified" id="noJS"@\\
\mbox{}\verb@   style="margin-left: auto; margin-right: auto; width: 75%; display: block; font-family: sans-serif; font-weight: bold;">@\\
\mbox{}\verb@<script type="text/javascript">@\\
\mbox{}\verb@/* <![CDATA[ */@\\
\mbox{}\verb@    document.getElementById("noJS").style.display = "none";@\\
\mbox{}\verb@/* ]]> */@\\
\mbox{}\verb@</script>@\\
\mbox{}\verb@Your browser does not support JavaScript (or it is disabled).  Please@\\
\mbox{}\verb@click the &ldquo;Update&rdquo; button after each change to a form field@\\
\mbox{}\verb@to update the rest of the form.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb274}{274}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Report warnings from static diet calculator update}

Any errors detected in a static update to the diet calculator
are pushed onto the \verb+@goofs+ array.  If the array is
not non-void, we emit the errors in a list before the
diet calculator form.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap386}\raggedright\small
\NWtarget{nuweb276b}{} $\langle\,${\itshape Report warnings from static diet calculator update}\nobreak\ {\footnotesize {276b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($#goofs >= 0) {@\\
\mbox{}\verb@   print $fh <<"EOD";@\\
\mbox{}\verb@<h3 class="warning">Warning:  The following errors were found in@\\
\mbox{}\verb@your changes to the diet calculator</h3>@\\
\mbox{}\verb@<ul class="goofs">@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    for (my $i = 0; $i <= $#goofs; $i++) {@\\
\mbox{}\verb@        print($fh "<li>$goofs[$i].</li>\n");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@</ul>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@   }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb274}{274}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Generate array of years for diet calculator selection}

The list of years in the diet calculator selection box must encompass
the range including the starting and ending dates of the diet plan and
any year the user is likely to select.  We include all years for which
we have logs in the database, the start and end years of the diet plan,
and the previous and next years.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap387}\raggedright\small
\NWtarget{nuweb277a}{} $\langle\,${\itshape Generate array of years for diet calculator selection}\nobreak\ {\footnotesize {277a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $cyear = (jd_to_gregorian(unix_time_to_jd($userTime)))[0];@\\
\mbox{}\verb@    @{\tt @}\verb@years = $ui->enumerateYears();@\\
\mbox{}\verb@    if ($#years < 0) {          # If no years in database, include current year@\\
\mbox{}\verb@        push(@{\tt @}\verb@years, $cyear);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    my $lyear = max($cyear, (jd_to_gregorian(unix_time_to_jd($calc_start_date)))[0],@\\
\mbox{}\verb@        (jd_to_gregorian(unix_time_to_jd($calc_end_date)))[0]);@\\
\mbox{}\verb@    while ($years[$#years] < ($lyear + 1)) {@\\
\mbox{}\verb@        push(@{\tt @}\verb@years, $years[$#years] + 1);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    while ($years[0] > ($cyear - 1)) {@\\
\mbox{}\verb@        unshift(@{\tt @}\verb@years, $years[0] - 1);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb274}{274}\NWlink{nuweb286}{, 286}.
\item \NWtxtIdentsUsed\nobreak\  \verb@calc_end_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@enumerateYears@\nobreak\ \NWlink{nuweb141}{141}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@jd_to_gregorian@\nobreak\ \NWlink{nuweb448}{448}, \verb@max@\nobreak\ \NWlink{nuweb405}{405}, \verb@unix_time_to_jd@\nobreak\ \NWlink{nuweb450b}{450b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Preset diet calculator start and end dates}

The diet calculator start and end dates from the {\tt user}
object are converted from \UNIX/ time to CGI arguments
which will be used when generating the form to preset the
date selection boxes.  We also convert the dates into
Julian dates for use in the actual diet calculator
computations.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap388}\raggedright\small
\NWtarget{nuweb277b}{} $\langle\,${\itshape Preset diet calculator start and end dates}\nobreak\ {\footnotesize {277b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    #   Preset start date selection fields@\\
\mbox{}\verb@    my $s_jd = unix_time_to_jd($calc_start_date);@\\
\mbox{}\verb@    ($CGIargs{from_y}, $CGIargs{from_m}, $CGIargs{from_d}) = jd_to_gregorian($s_jd);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   Preset end date selection fields@\\
\mbox{}\verb@    my $e_jd = unix_time_to_jd($calc_end_date);@\\
\mbox{}\verb@    ($CGIargs{to_y}, $CGIargs{to_m}, $CGIargs{to_d}) = jd_to_gregorian($e_jd);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb274}{274}.
\item \NWtxtIdentsUsed\nobreak\  \verb@calc_end_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@jd_to_gregorian@\nobreak\ \NWlink{nuweb448}{448}, \verb@start@\nobreak\ \NWlink{nuweb19b}{19b}, \verb@unix_time_to_jd@\nobreak\ \NWlink{nuweb450b}{450b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Generate diet calculator form}

The diet calculator is embedded in an XHTML \verb+<table>+ generated
by the following.  The editable fields are complicated by the need for
them to activate JavaScript functions upon change.  For every input
field the user can modify, there is a companion ``{\verb+r_+}'' field
which contains the initial value displayed in the form.  Users who
do not have JavaScript may change a form value, then submit the form with
the ``Update'' button; when the server receives the form, it compares
the ``{\verb+r_+}'' fields with the input fields to determine which
field the user changed and applies the change, returning an updated
form to the user.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap389}\raggedright\small
\NWtarget{nuweb278a}{} $\langle\,${\itshape Generate diet calculator form}\nobreak\ {\footnotesize {278a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@<table border="border" class="login">@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb278a}{278a}\NWlink{nuweb278b}{b}\NWlink{nuweb279a}{, 279a}\NWlink{nuweb279b}{b}\NWlink{nuweb280a}{, 280a}\NWlink{nuweb280b}{b}\NWlink{nuweb281}{, 281}\NWlink{nuweb282a}{, 282a}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb274}{274}.
\item \NWtxtIdentsUsed\nobreak\  \verb@login@\nobreak\ \NWlink{nuweb121}{121}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Diet calculator: calorie balance}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap390}\raggedright\small
\NWtarget{nuweb278b}{} $\langle\,${\itshape Generate diet calculator form}\nobreak\ {\footnotesize {278b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    <tr>@\\
\mbox{}\verb@        <th><label for="calc_calorie_balance">Daily balance</label></th>@\\
\mbox{}\verb@        <td><input type="text" name="calc_calorie_balance"  id="calc_calorie_balance"@\\
\mbox{}\verb@                onchange="change_calc_calorie_balance();"@\\
\mbox{}\verb@                size="5" maxlength="5"@\\
\mbox{}\verb@                value="$calc_calorie_balance" />@\\
\mbox{}\verb@            <input type="hidden" name="r_calc_calorie_balance"@\\
\mbox{}\verb@                value="$calc_calorie_balance" />@\\
\mbox{}\verb@            <select name="calc_energy_unit" id="calc_energy_unit"@\\
\mbox{}\verb@                    onchange="change_calc_energy_unit();">@\\
\mbox{}\verb@                <option value="0"$eunit[0]>cal</option>@\\
\mbox{}\verb@                <option value="1"$eunit[1]>kJ</option>@\\
\mbox{}\verb@            </select>@\\
\mbox{}\verb@            <input type="hidden" name="r_calc_energy_unit"@\\
\mbox{}\verb@                value="$calc_energy_unit" />@\\
\mbox{}\verb@        </td>@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb278a}{278a}\NWlink{nuweb278b}{b}\NWlink{nuweb279a}{, 279a}\NWlink{nuweb279b}{b}\NWlink{nuweb280a}{, 280a}\NWlink{nuweb280b}{b}\NWlink{nuweb281}{, 281}\NWlink{nuweb282a}{, 282a}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb274}{274}.
\item \NWtxtIdentsUsed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}, \verb@change_calc_calorie_balance@\nobreak\ \NWlink{nuweb509a}{509a}, \verb@change_calc_energy_unit@\nobreak\ \NWlink{nuweb509b}{509b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Diet calculator: initial weight}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap391}\raggedright\small
\NWtarget{nuweb279a}{} $\langle\,${\itshape Generate diet calculator form}\nobreak\ {\footnotesize {279a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    <tr>@\\
\mbox{}\verb@        <th><label for="calc_start_weight">Initial weight</label></th>@\\
\mbox{}\verb@        <td><input type="text" name="calc_start_weight" id="calc_start_weight"@\\
\mbox{}\verb@                onchange="change_calc_start_weight();"@\\
\mbox{}\verb@                size="7" maxlength="7"@\\
\mbox{}\verb@                value="$e_sw" />@\\
\mbox{}\verb@            <input type="hidden" name="r_calc_start_weight"@\\
\mbox{}\verb@                value="$e_sw" />@\\
\mbox{}\verb@            <select name="calc_weight_unit" id="calc_weight_unit"@\\
\mbox{}\verb@                onchange="change_calc_weight_unit();">@\\
\mbox{}\verb@                <option value="0"$wunit[0]>kilograms</option>@\\
\mbox{}\verb@                <option value="1"$wunit[1]>pounds</option>@\\
\mbox{}\verb@                <option value="2"$wunit[2]>stones</option>@\\
\mbox{}\verb@            </select>@\\
\mbox{}\verb@            <input type="hidden" name="r_calc_weight_unit"@\\
\mbox{}\verb@                value="$calc_weight_unit" />@\\
\mbox{}\verb@        </td>@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb278a}{278a}\NWlink{nuweb278b}{b}\NWlink{nuweb279a}{, 279a}\NWlink{nuweb279b}{b}\NWlink{nuweb280a}{, 280a}\NWlink{nuweb280b}{b}\NWlink{nuweb281}{, 281}\NWlink{nuweb282a}{, 282a}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb274}{274}.
\item \NWtxtIdentsUsed\nobreak\  \verb@calc_start_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@change_calc_start_weight@\nobreak\ \NWlink{nuweb510a}{510a}, \verb@change_calc_weight_unit@\nobreak\ \NWlink{nuweb510b}{510b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Diet calculator: goal weight}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap392}\raggedright\small
\NWtarget{nuweb279b}{} $\langle\,${\itshape Generate diet calculator form}\nobreak\ {\footnotesize {279b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    <tr>@\\
\mbox{}\verb@        <th><label for="calc_goal_weight">Goal weight</label></th>@\\
\mbox{}\verb@        <td><input type="text" name="calc_goal_weight" id="calc_goal_weight"@\\
\mbox{}\verb@                onchange="change_calc_goal_weight();"@\\
\mbox{}\verb@                size="7" maxlength="7"@\\
\mbox{}\verb@                value="$e_gw" />@\\
\mbox{}\verb@            <input type="hidden" name="r_calc_goal_weight"@\\
\mbox{}\verb@                value="$e_gw" />@\\
\mbox{}\verb@        </td>@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb278a}{278a}\NWlink{nuweb278b}{b}\NWlink{nuweb279a}{, 279a}\NWlink{nuweb279b}{b}\NWlink{nuweb280a}{, 280a}\NWlink{nuweb280b}{b}\NWlink{nuweb281}{, 281}\NWlink{nuweb282a}{, 282a}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb274}{274}.
\item \NWtxtIdentsUsed\nobreak\  \verb@calc_goal_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@change_calc_goal_weight@\nobreak\ \NWlink{nuweb511a}{511a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Diet calculator: desired weight change}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap393}\raggedright\small
\NWtarget{nuweb280a}{} $\langle\,${\itshape Generate diet calculator form}\nobreak\ {\footnotesize {280a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    <tr>@\\
\mbox{}\verb@        <th><label for="calc_weight_change">Desired weight change</label></th>@\\
\mbox{}\verb@        <td><input type="text" name="calc_weight_change" id="calc_weight_change"@\\
\mbox{}\verb@                onchange="change_calc_weight_change();"@\\
\mbox{}\verb@                size="7" maxlength="7"@\\
\mbox{}\verb@                value="$e_dw" />@\\
\mbox{}\verb@            <input type="hidden" name="r_calc_weight_change"@\\
\mbox{}\verb@                value="$e_dw" />@\\
\mbox{}\verb@        </td>@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb278a}{278a}\NWlink{nuweb278b}{b}\NWlink{nuweb279a}{, 279a}\NWlink{nuweb279b}{b}\NWlink{nuweb280a}{, 280a}\NWlink{nuweb280b}{b}\NWlink{nuweb281}{, 281}\NWlink{nuweb282a}{, 282a}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb274}{274}.
\item \NWtxtIdentsUsed\nobreak\  \verb@change_calc_weight_change@\nobreak\ \NWlink{nuweb511b}{511b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Diet calculator: weight change per week}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap394}\raggedright\small
\NWtarget{nuweb280b}{} $\langle\,${\itshape Generate diet calculator form}\nobreak\ {\footnotesize {280b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    <tr>@\\
\mbox{}\verb@        <th><label for="calc_weight_week">Weight change per week</label></th>@\\
\mbox{}\verb@        <td><input type="text" name="calc_weight_week" id="calc_weight_week"@\\
\mbox{}\verb@                onchange="change_calc_weight_week();"@\\
\mbox{}\verb@                size="7" maxlength="7"@\\
\mbox{}\verb@                value="$e_ww" />@\\
\mbox{}\verb@            <input type="hidden" name="r_calc_weight_week"@\\
\mbox{}\verb@                value="$e_ww" />@\\
\mbox{}\verb@        </td>@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb278a}{278a}\NWlink{nuweb278b}{b}\NWlink{nuweb279a}{, 279a}\NWlink{nuweb279b}{b}\NWlink{nuweb280a}{, 280a}\NWlink{nuweb280b}{b}\NWlink{nuweb281}{, 281}\NWlink{nuweb282a}{, 282a}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb274}{274}.
\item \NWtxtIdentsUsed\nobreak\  \verb@calc_weight_week@\nobreak\ \NWlink{nuweb505}{505}, \verb@change_calc_weight_week@\nobreak\ \NWlink{nuweb512a}{512a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Diet calculator: diet duration}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap395}\raggedright\small
\NWtarget{nuweb281}{} $\langle\,${\itshape Generate diet calculator form}\nobreak\ {\footnotesize {281}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    <tr>@\\
\mbox{}\verb@        <th><label for="calc_weeks">Diet duration</label></th>@\\
\mbox{}\verb@        <td><input type="text" name="calc_weeks" id="calc_weeks"@\\
\mbox{}\verb@                onchange="change_calc_weeks();"@\\
\mbox{}\verb@                size="5" maxlength="5"@\\
\mbox{}\verb@                value="$calc_weeks" />&nbsp;weeks,@\\
\mbox{}\verb@            <input type="hidden" name="r_calc_weeks"@\\
\mbox{}\verb@                value="$calc_weeks" />@\\
\mbox{}\verb@            <input type="text" name="calc_months" id="calc_months"@\\
\mbox{}\verb@                onchange="change_calc_months();"@\\
\mbox{}\verb@                size="5" maxlength="5"@\\
\mbox{}\verb@                value="$calc_months" />&nbsp;months@\\
\mbox{}\verb@            <input type="hidden" name="r_calc_months"@\\
\mbox{}\verb@                value="$calc_months" />@\\
\mbox{}\verb@        </td>@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb278a}{278a}\NWlink{nuweb278b}{b}\NWlink{nuweb279a}{, 279a}\NWlink{nuweb279b}{b}\NWlink{nuweb280a}{, 280a}\NWlink{nuweb280b}{b}\NWlink{nuweb281}{, 281}\NWlink{nuweb282a}{, 282a}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb274}{274}.
\item \NWtxtIdentsUsed\nobreak\  \verb@calc_months@\nobreak\ \NWlink{nuweb513a}{513a}, \verb@calc_weeks@\nobreak\ \NWlink{nuweb505}{505}\NWlink{nuweb512b}{, 512b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Diet calculator: start and end dates}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap396}\raggedright\small
\NWtarget{nuweb282a}{} $\langle\,${\itshape Generate diet calculator form}\nobreak\ {\footnotesize {282a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    <tr>@\\
\mbox{}\verb@        <th><label for="from_y">Start date</label></th>@\\
\mbox{}\verb@        <td>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Custom trend start date}\nobreak\ ({\footnotesize 282b\label{scrap397}
 }\mbox{}\verb@1@,{\footnotesize 282c\label{scrap398}
 }\mbox{}\verb@1@ ) {\footnotesize \NWlink{nuweb272}{272}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $disped = ($e_jd >= $s_jd) ? 'inline' : 'none';@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@            <input type="hidden" name="r_calc_start_date"@\\
\mbox{}\verb@                value="$s_jd" />@\\
\mbox{}\verb@        </td>@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@    <tr>@\\
\mbox{}\verb@        <th><label for="to_y">End date</label></th>@\\
\mbox{}\verb@        <td>@\\
\mbox{}\verb@            <span id="end_date" style="display: $disped;">@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Custom trend end date}\nobreak\ ({\footnotesize 282d\label{scrap399}
 }\mbox{}\verb@1@,{\footnotesize 282e\label{scrap400}
 }\mbox{}\verb@1@ ) {\footnotesize \NWlink{nuweb273}{273}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $disped = ($e_jd < $s_jd) ? 'inline' : 'none';@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@        </span>@\\
\mbox{}\verb@            <input type="hidden" name="r_calc_end_date"@\\
\mbox{}\verb@                value="$e_jd" />@\\
\mbox{}\verb@            <span id="endless_date" style="display: $disped;"@\\
\mbox{}\verb@                onmouseover="document.getElementById('end_date').style.display = 'inline'; document.getElementById('endless_date').style.display = 'none';">@\\
\mbox{}\verb@            <i>Never</i>@\\
\mbox{}\verb@            </span>@\\
\mbox{}\verb@        </td>@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@@\\
\mbox{}\verb@</table>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb278a}{278a}\NWlink{nuweb278b}{b}\NWlink{nuweb279a}{, 279a}\NWlink{nuweb279b}{b}\NWlink{nuweb280a}{, 280a}\NWlink{nuweb280b}{b}\NWlink{nuweb281}{, 281}\NWlink{nuweb282a}{, 282a}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb274}{274}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Diet calculator form action buttons}

In addition to the usual ``Save'', ``Reset'', and ``Cancel'' buttons,
if the user's browser lacks JavaScript, an ``Update'' button will be
displayed which, when pressed, submits the form with a transaction
which discovers the change made to a field and updates the calculator
in a page returned to the user.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap401}\raggedright\small
\NWtarget{nuweb283}{} $\langle\,${\itshape Diet calculator form action buttons}\nobreak\ {\footnotesize {283}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@<p class="centred" id="noJS1" style="display: block;">@\\
\mbox{}\verb@<script type="text/javascript">@\\
\mbox{}\verb@/* <![CDATA[ */@\\
\mbox{}\verb@    document.getElementById("noJS1").style.display = "none";@\\
\mbox{}\verb@/* ]]> */@\\
\mbox{}\verb@</script>@\\
\mbox{}\verb@<input type="submit" name="q=update_dietcalc" value="     Update     " />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<label><input type="checkbox" name="plot_plan"@\\
\mbox{}\verb@    value="y"$ckplan onchange="change_calc_plot_plan();"@\\
\mbox{}\verb@    />&nbsp;Plot&nbsp;plan&nbsp;in&nbsp;chart</label>@\\
\mbox{}\verb@<br />@\\
\mbox{}\verb@<input type="hidden" name="du" id="du" value="$ui->{display_unit}" />@\\
\mbox{}\verb@<input type="hidden" name="dc" id="dc" value="$ui->{decimal_character}" />@\\
\mbox{}\verb@<input type="hidden" name="eu" id="eu" value="$ui->{energy_unit}" />@\\
\mbox{}\verb@<input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@<input type="submit" name="q=save_dietcalc" value=" Save " />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="reset" onclick="unsavedChanges = 0;" value=" Reset " />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="submit" name="q=account" value=" Cancel " />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb274}{274}.
\item \NWtxtIdentsUsed\nobreak\  \verb@change_calc_plot_plan@\nobreak\ \NWlink{nuweb515}{515}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@unsavedChanges@\nobreak\ \NWlink{nuweb484a}{484a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}


\vbox{
\subsubsection{Calculate dependent variables from primary variables}

We take the initial weight, weight goal, and daily calorie balance
as the primary variables; changes made by the user in other quantities
are always reflected in them.  Starting from these variables, then,
we compute all the dependent variables for the form.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap402}\raggedright\small
\NWtarget{nuweb284}{} $\langle\,${\itshape Calculate dependent variables from primary variables}\nobreak\ {\footnotesize {284}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@$calc_calorie_balance = (-500 * ENERGY_CONVERSION->[ENERGY_CALORIE][$calc_energy_unit]) if $calc_calorie_balance == 0;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $calc_weight_change = $calc_goal_weight - $calc_start_weight;@\\
\mbox{}\verb@    $calc_weight_week = (($calc_calorie_balance * ENERGY_CONVERSION->[$calc_energy_unit][ENERGY_CALORIE]) * 7) / CALORIES_PER_WEIGHT_UNIT->[$calc_weight_unit];@\\
\mbox{}\verb@    $calc_weeks = round($calc_weight_change / $calc_weight_week);@\\
\mbox{}\verb@    $calc_months = round(((($calc_weight_change / $calc_weight_week) * 7.0) / 30.44));@\\
\mbox{}\verb@    $calc_end_date = $calc_start_date + ($calc_weeks * 7.0 * 24.0 * 60.0 * 60.0);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb274}{274}\NWlink{nuweb286}{, 286}.
\item \NWtxtIdentsUsed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_end_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_goal_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_months@\nobreak\ \NWlink{nuweb513a}{513a}, \verb@calc_start_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_weeks@\nobreak\ \NWlink{nuweb505}{505}\NWlink{nuweb512b}{, 512b}, \verb@calc_weight_week@\nobreak\ \NWlink{nuweb505}{505}, \verb@CALORIES_PER_WEIGHT_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@ENERGY_CALORIE@\nobreak\ \NWlink{nuweb24}{24}, \verb@ENERGY_CONVERSION@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Override diet calculator primary fields from form fields}

If JavaScript is not enabled, we may arrive here because the user has
pressed the ``Update'' button without having changed any fields.  In
this circumstance we need to override the primary fields from the user
object with those in the form fields.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap403}\raggedright\small
\NWtarget{nuweb285}{} $\langle\,${\itshape Override diet calculator primary fields from form fields}\nobreak\ {\footnotesize {285}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($CGIargs{q} eq 'update_dietcalc') {@\\
\mbox{}\verb@        if (defined($CGIargs{r_calc_energy_unit})) {@\\
\mbox{}\verb@            $calc_energy_unit = $CGIargs{r_calc_energy_unit};@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if (defined($CGIargs{r_calc_calorie_balance})) {@\\
\mbox{}\verb@            $calc_calorie_balance = $CGIargs{r_calc_calorie_balance};@\\
\mbox{}\verb@            $calc_calorie_balance =~ s/,/./g;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (defined($CGIargs{r_calc_weight_unit})) {@\\
\mbox{}\verb@            $calc_weight_unit = $CGIargs{r_calc_weight_unit};@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if (defined($CGIargs{r_calc_start_weight})) {@\\
\mbox{}\verb@            my $w = $CGIargs{r_calc_start_weight};@\\
\mbox{}\verb@            $w =~ s/,/./g;@\\
\mbox{}\verb@            #   If specification is stones and pounds, convert to pounds@\\
\mbox{}\verb@            if (($w ne '') && ($calc_weight_unit == WEIGHT_STONE)) {@\\
\mbox{}\verb@                if ($w =~ m/\s*(\d+)\s+([\d\.]+)/) {@\\
\mbox{}\verb@                    $w = ($1 * 14) + $2;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            $calc_start_weight = $w *@\\
\mbox{}\verb@                HDiet::monthlog::WEIGHT_CONVERSION->[$CGIargs{r_calc_weight_unit}][$calc_weight_unit];@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (defined($CGIargs{r_calc_goal_weight})) {@\\
\mbox{}\verb@            my $w = $CGIargs{r_calc_goal_weight};@\\
\mbox{}\verb@            $w =~ s/,/./g;@\\
\mbox{}\verb@            #   If specification is stones and pounds, convert to pounds@\\
\mbox{}\verb@            if (($w ne '') && ($calc_weight_unit == WEIGHT_STONE)) {@\\
\mbox{}\verb@                if ($w =~ m/\s*(\d+)\s+([\d\.]+)/) {@\\
\mbox{}\verb@                    $w = ($1 * 14) + $2;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            $calc_goal_weight = $w *@\\
\mbox{}\verb@                HDiet::monthlog::WEIGHT_CONVERSION->[$CGIargs{r_calc_weight_unit}][$calc_weight_unit];@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (defined($CGIargs{r_calc_start_date})) {@\\
\mbox{}\verb@            $calc_start_date = jd_to_unix_time($CGIargs{r_calc_start_date});@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (defined($CGIargs{r_plot_plan})) {@\\
\mbox{}\verb@            $plot_diet_plan = defined($CGIargs{r_plot_plan}) ? 1 : 0;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb275}{275}.
\item \NWtxtIdentsUsed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_goal_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@jd_to_unix_time@\nobreak\ \NWlink{nuweb451a}{451a}, \verb@WEIGHT_STONE@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Perform static update of diet calculator}

This code is invoked when the diet calculator form is invoked
by an ``\verb+update_dietcalc+'' transaction.  This occurs
when a user deprived of JavaScript changes a field and then
presses the ``Update'' button to propagate the changes through
the diet calculator form.  We compare the fields with their
initial values saved in the hidden ``\verb+r_+'' fields and
process the first one found to have changed.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap404}\raggedright\small
\NWtarget{nuweb286}{} $\langle\,${\itshape Perform static update of diet calculator}\nobreak\ {\footnotesize {286}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $nschanges = 0;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Static change to energy unit}\nobreak\ {\footnotesize \NWlink{nuweb287a}{287a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Static change to daily balance}\nobreak\ {\footnotesize \NWlink{nuweb287b}{287b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Static change to weight unit}\nobreak\ {\footnotesize \NWlink{nuweb288a}{288a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Static change to initial weight}\nobreak\ {\footnotesize \NWlink{nuweb288b}{288b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Static change to goal weight}\nobreak\ {\footnotesize \NWlink{nuweb289a}{289a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Static change to desired weight change}\nobreak\ {\footnotesize \NWlink{nuweb289b}{289b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Static change to weight change per week}\nobreak\ {\footnotesize \NWlink{nuweb290a}{290a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Static change to diet duration in weeks}\nobreak\ {\footnotesize \NWlink{nuweb290b}{290b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Static change to diet duration in months}\nobreak\ {\footnotesize \NWlink{nuweb291a}{291a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Static change to start date}\nobreak\ {\footnotesize \NWlink{nuweb291b}{291b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Static change to end date}\nobreak\ {\footnotesize \NWlink{nuweb292}{292}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($nschanges > 0) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Calculate dependent variables from primary variables}\nobreak\ {\footnotesize \NWlink{nuweb284}{284}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Generate array of years for diet calculator selection}\nobreak\ {\footnotesize \NWlink{nuweb277a}{277a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        if ($nschanges > 1) {@\\
\mbox{}\verb@            push(@{\tt @}\verb@goofs, "Warning: you have changed more than one field in the@\\
\mbox{}\verb@Diet Calculator before pressing the &ldquo;Update&rdquo; button.@\\
\mbox{}\verb@This may result in unintended changes.  Please press the@\\
\mbox{}\verb@&ldquo;Update&rdquo; button after each change to a field");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb274}{274}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Static change to energy unit}

When the user changes the energy unit, the daily energy balance is
converted to the equivalent value in the newly chosen unit.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap405}\raggedright\small
\NWtarget{nuweb287a}{} $\langle\,${\itshape Static change to energy unit}\nobreak\ {\footnotesize {287a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($CGIargs{calc_energy_unit} ne $CGIargs{r_calc_energy_unit}) {@\\
\mbox{}\verb@        $calc_energy_unit = $CGIargs{calc_energy_unit};@\\
\mbox{}\verb@        $calc_calorie_balance = round($calc_calorie_balance *@\\
\mbox{}\verb@            ENERGY_CONVERSION->[$CGIargs{r_calc_energy_unit}][$calc_energy_unit]);@\\
\mbox{}\verb@        @{\tt @}\verb@eunit = ('', '');@\\
\mbox{}\verb@        $eunit[$calc_energy_unit] = ' selected="selected"';@\\
\mbox{}\verb@        $nschanges++;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb286}{286}.
\item \NWtxtIdentsUsed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}, \verb@ENERGY_CONVERSION@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Static change to daily balance}

The daily energy balance is a primary quantity; changes to it are
handled by the computation of derived quantities.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap406}\raggedright\small
\NWtarget{nuweb287b}{} $\langle\,${\itshape Static change to daily balance}\nobreak\ {\footnotesize {287b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($CGIargs{calc_calorie_balance} ne $CGIargs{r_calc_calorie_balance}) {@\\
\mbox{}\verb@        if ($CGIargs{calc_calorie_balance} =~ m/^\s*([\+\-]?\d+([\.,]\d*)?)\s*$/) {@\\
\mbox{}\verb@            $calc_calorie_balance = $1;@\\
\mbox{}\verb@            $calc_calorie_balance =~ s/,/./g;@\\
\mbox{}\verb@            $calc_calorie_balance = round($calc_calorie_balance);@\\
\mbox{}\verb@            $nschanges++;@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            push(@{\tt @}\verb@goofs, "Invalid daily balance");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb286}{286}.
\item \NWtxtIdentsUsed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Static change to weight unit}

If the user changes the weight unit, the initial and goal weight are
converted to the equivalent in the new unit.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap407}\raggedright\small
\NWtarget{nuweb288a}{} $\langle\,${\itshape Static change to weight unit}\nobreak\ {\footnotesize {288a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($CGIargs{calc_weight_unit} ne $CGIargs{r_calc_weight_unit}) {@\\
\mbox{}\verb@        $calc_weight_unit = $CGIargs{calc_weight_unit};@\\
\mbox{}\verb@        $calc_start_weight *= HDiet::monthlog::WEIGHT_CONVERSION->[$CGIargs{r_calc_weight_unit}][$CGIargs{calc_weight_unit}];@\\
\mbox{}\verb@        $calc_goal_weight *= HDiet::monthlog::WEIGHT_CONVERSION->[$CGIargs{r_calc_weight_unit}][$CGIargs{calc_weight_unit}];@\\
\mbox{}\verb@        @{\tt @}\verb@wunit = ('', '', '');@\\
\mbox{}\verb@        $wunit[$calc_weight_unit] = ' selected="selected"';@\\
\mbox{}\verb@        $nschanges++;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb286}{286}.
\item \NWtxtIdentsUsed\nobreak\  \verb@calc_goal_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_weight@\nobreak\ \NWlink{nuweb505}{505}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Static change to initial weight}

The initial weight is a primary quantity; changes to it are handled
by the regular recalculation of derived quantities.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap408}\raggedright\small
\NWtarget{nuweb288b}{} $\langle\,${\itshape Static change to initial weight}\nobreak\ {\footnotesize {288b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($CGIargs{calc_start_weight} ne $CGIargs{r_calc_start_weight}) {@\\
\mbox{}\verb@        my $w = parseWeight($CGIargs{calc_start_weight}, $calc_weight_unit);@\\
\mbox{}\verb@        if (defined($w)) {@\\
\mbox{}\verb@            $calc_start_weight = $w;@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            push(@{\tt @}\verb@goofs, "Invalid initial weight");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $nschanges++;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb286}{286}.
\item \NWtxtIdentsUsed\nobreak\  \verb@calc_start_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@parseWeight@\nobreak\ \NWlink{nuweb401}{401}\NWlink{nuweb485b}{, 485b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Static change to goal weight}

The goal weight is a primary quantity; changes to it are handled
by the regular recalculation of derived quantities.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap409}\raggedright\small
\NWtarget{nuweb289a}{} $\langle\,${\itshape Static change to goal weight}\nobreak\ {\footnotesize {289a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($CGIargs{calc_goal_weight} ne $CGIargs{r_calc_goal_weight}) {@\\
\mbox{}\verb@        my $w = parseWeight($CGIargs{calc_goal_weight}, $calc_weight_unit);@\\
\mbox{}\verb@        if (defined($w)) {@\\
\mbox{}\verb@            $calc_goal_weight = $w;@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            push(@{\tt @}\verb@goofs, "Invalid goal weight");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $nschanges++;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb286}{286}.
\item \NWtxtIdentsUsed\nobreak\  \verb@calc_goal_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@parseWeight@\nobreak\ \NWlink{nuweb401}{401}\NWlink{nuweb485b}{, 485b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Static change to desired weight change}

Changing the desired weight change adjusts the goal weight to be
the specified difference from the initial weight.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap410}\raggedright\small
\NWtarget{nuweb289b}{} $\langle\,${\itshape Static change to desired weight change}\nobreak\ {\footnotesize {289b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($CGIargs{calc_weight_change} ne $CGIargs{r_calc_weight_change}) {@\\
\mbox{}\verb@        my $w = parseSignedWeight($CGIargs{calc_weight_change}, $calc_weight_unit);@\\
\mbox{}\verb@        if (defined($w)) {@\\
\mbox{}\verb@            $calc_goal_weight = $calc_start_weight + $w;@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            push(@{\tt @}\verb@goofs, "Invalid desired weight change");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $nschanges++;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb286}{286}.
\item \NWtxtIdentsUsed\nobreak\  \verb@calc_goal_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@parseSignedWeight@\nobreak\ \NWlink{nuweb402}{402}\NWlink{nuweb486}{, 486}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Static change to weight change per week}

Changing the desired weight change per week adjusts the
energy balance to achieve the requested gain or loss.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap411}\raggedright\small
\NWtarget{nuweb290a}{} $\langle\,${\itshape Static change to weight change per week}\nobreak\ {\footnotesize {290a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($CGIargs{calc_weight_week} ne $CGIargs{r_calc_weight_week}) {@\\
\mbox{}\verb@        my $w = parseSignedWeight($CGIargs{calc_weight_week}, $calc_weight_unit);@\\
\mbox{}\verb@        if (defined($w)) {@\\
\mbox{}\verb@            $calc_calorie_balance = round(($w * CALORIES_PER_WEIGHT_UNIT->[$calc_weight_unit]) /@\\
\mbox{}\verb@                ((ENERGY_CONVERSION->[$calc_energy_unit][ENERGY_CALORIE]) * 7));@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            push(@{\tt @}\verb@goofs, "Invalid weight change per week");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $nschanges++;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb286}{286}.
\item \NWtxtIdentsUsed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_weight_week@\nobreak\ \NWlink{nuweb505}{505}, \verb@CALORIES_PER_WEIGHT_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@ENERGY_CALORIE@\nobreak\ \NWlink{nuweb24}{24}, \verb@ENERGY_CONVERSION@\nobreak\ \NWlink{nuweb24}{24}, \verb@parseSignedWeight@\nobreak\ \NWlink{nuweb402}{402}\NWlink{nuweb486}{, 486}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Static change to diet duration in weeks}

Changing the diet duration in weeks adjusts the energy balance
to achieve the specified duration.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap412}\raggedright\small
\NWtarget{nuweb290b}{} $\langle\,${\itshape Static change to diet duration in weeks}\nobreak\ {\footnotesize {290b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($CGIargs{calc_weeks} ne $CGIargs{r_calc_weeks}) {@\\
\mbox{}\verb@        my $ddw = -1;@\\
\mbox{}\verb@        if ($CGIargs{calc_weeks} =~ m/^\s*(\d+)\s*$/) {@\\
\mbox{}\verb@            if ($1 > 0) {@\\
\mbox{}\verb@                $ddw = $1;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if ($ddw > 0) {@\\
\mbox{}\verb@            $calc_calorie_balance = round((($calc_weight_change / $ddw) *@\\
\mbox{}\verb@                (CALORIES_PER_WEIGHT_UNIT->[$calc_weight_unit] / 7)));@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            push(@{\tt @}\verb@goofs, "Invalid diet duration in weeks");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $nschanges++;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb286}{286}.
\item \NWtxtIdentsUsed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_weeks@\nobreak\ \NWlink{nuweb505}{505}\NWlink{nuweb512b}{, 512b}, \verb@CALORIES_PER_WEIGHT_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Static change to diet duration in months}

Changing the diet duration in months adjusts the energy balance
to achieve the specified duration.  We use the mean length of
months in the Gregorian calendar.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap413}\raggedright\small
\NWtarget{nuweb291a}{} $\langle\,${\itshape Static change to diet duration in months}\nobreak\ {\footnotesize {291a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($CGIargs{calc_months} ne $CGIargs{r_calc_months}) {@\\
\mbox{}\verb@        my $ddm = -1;@\\
\mbox{}\verb@        if ($CGIargs{calc_months} =~ m/^\s*(\d+)\s*$/) {@\\
\mbox{}\verb@            if ($1 > 0) {@\\
\mbox{}\verb@                $ddm = $1;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if ($ddm > 0) {@\\
\mbox{}\verb@            $calc_calorie_balance = int((($calc_weight_change / $ddm) *@\\
\mbox{}\verb@                (CALORIES_PER_WEIGHT_UNIT->[$calc_weight_unit] / 30.44)));@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            push(@{\tt @}\verb@goofs, "Invalid diet duration in months");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $nschanges++;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb286}{286}.
\item \NWtxtIdentsUsed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_months@\nobreak\ \NWlink{nuweb513a}{513a}, \verb@CALORIES_PER_WEIGHT_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Static change to start date}

The start date is a primary quantity; changing it simply causes
the end date to reflect the diet duration.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap414}\raggedright\small
\NWtarget{nuweb291b}{} $\langle\,${\itshape Static change to start date}\nobreak\ {\footnotesize {291b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (gregorian_to_jd($CGIargs{from_y}, $CGIargs{from_m}, $CGIargs{from_d}) !=@\\
\mbox{}\verb@            $CGIargs{r_calc_start_date}) {@\\
\mbox{}\verb@        $calc_start_date = jd_to_unix_time(gregorian_to_jd($CGIargs{from_y}, $CGIargs{from_m}, $CGIargs{from_d}));@\\
\mbox{}\verb@        $nschanges++;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb286}{286}.
\item \NWtxtIdentsUsed\nobreak\  \verb@calc_start_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}, \verb@jd_to_unix_time@\nobreak\ \NWlink{nuweb451a}{451a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Static change to end date}

When the user changes the end date, we adjust the daily energy balance
to achieve the desired diet duration.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap415}\raggedright\small
\NWtarget{nuweb292}{} $\langle\,${\itshape Static change to end date}\nobreak\ {\footnotesize {292}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (gregorian_to_jd($CGIargs{to_y}, $CGIargs{to_m}, $CGIargs{to_d}) !=@\\
\mbox{}\verb@            $CGIargs{r_calc_end_date}) {@\\
\mbox{}\verb@        my $ed = jd_to_unix_time(gregorian_to_jd($CGIargs{to_y}, $CGIargs{to_m}, $CGIargs{to_d}));@\\
\mbox{}\verb@        if ($ed > $calc_start_date) {@\\
\mbox{}\verb@            $calc_calorie_balance = round((($calc_weight_change /@\\
\mbox{}\verb@                (($ed - $calc_start_date) / (24 * 60 * 60))) *@\\
\mbox{}\verb@                    CALORIES_PER_WEIGHT_UNIT->[$calc_weight_unit]) /@\\
\mbox{}\verb@                    ENERGY_CONVERSION->[$calc_energy_unit][ENERGY_CALORIE]);@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            push(@{\tt @}\verb@goofs, "End date must be after start date");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $nschanges++;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb286}{286}.
\item \NWtxtIdentsUsed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@CALORIES_PER_WEIGHT_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@ENERGY_CALORIE@\nobreak\ \NWlink{nuweb24}{24}, \verb@ENERGY_CONVERSION@\nobreak\ \NWlink{nuweb24}{24}, \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}, \verb@jd_to_unix_time@\nobreak\ \NWlink{nuweb451a}{451a}, \verb@start@\nobreak\ \NWlink{nuweb19b}{19b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Save diet calculator settings}

We save the settings from the diet calculator form in the {\tt user}
object and update the user database, then re-display the diet calculator
with the new settings.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap416}\raggedright\small
\NWtarget{nuweb293}{} $\langle\,${\itshape Save diet calculator settings}\nobreak\ {\footnotesize {293}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $CGIargs{calc_calorie_balance} =~ s/,/./g;@\\
\mbox{}\verb@    $ui->{calc_calorie_balance} = $CGIargs{calc_calorie_balance} *@\\
\mbox{}\verb@        ENERGY_CONVERSION->[$CGIargs{calc_energy_unit}][ENERGY_CALORIE];@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $CGIargs{calc_start_weight} =~ s/,/./g;@\\
\mbox{}\verb@    my $w = $CGIargs{calc_start_weight};@\\
\mbox{}\verb@    #   If specification is stones and pounds, convert to pounds@\\
\mbox{}\verb@    if (($w ne '') && ($CGIargs{calc_weight_unit} == WEIGHT_STONE)) {@\\
\mbox{}\verb@        if ($w =~ m/\s*(\d+)\s+([\d\.]+)/) {@\\
\mbox{}\verb@            $w = ($1 * 14) + $2;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    $ui->{calc_start_weight} = $w *@\\
\mbox{}\verb@        HDiet::monthlog::WEIGHT_CONVERSION->[$CGIargs{calc_weight_unit}][WEIGHT_KILOGRAM];@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $CGIargs{calc_goal_weight} =~ s/,/./g;@\\
\mbox{}\verb@    $w = $CGIargs{calc_goal_weight};@\\
\mbox{}\verb@    #   If specification is stones and pounds, convert to pounds@\\
\mbox{}\verb@    if (($w ne '') && ($CGIargs{calc_weight_unit} == WEIGHT_STONE)) {@\\
\mbox{}\verb@        if ($w =~ m/\s*(\d+)\s+([\d\.]+)/) {@\\
\mbox{}\verb@            $w = ($1 * 14) + $2;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    $ui->{calc_goal_weight} = $w *@\\
\mbox{}\verb@        HDiet::monthlog::WEIGHT_CONVERSION->[$CGIargs{calc_weight_unit}][WEIGHT_KILOGRAM];@\\
\mbox{}\verb@    $ui->{calc_start_date} = jd_to_unix_time(gregorian_to_jd($CGIargs{from_y}, $CGIargs{from_m}, $CGIargs{from_d}));@\\
\mbox{}\verb@    $ui->{plot_diet_plan} = defined($CGIargs{plot_plan}) ? 1 : 0;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (!$readOnly) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Update user account information}\nobreak\ {\footnotesize \NWlink{nuweb309}{309}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        append_history($user_file_name, 15);@\\
\mbox{}\verb@        update_last_transaction($user_file_name);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    $CGIargs{q} = 'dietcalc';@\\
\mbox{}\verb@    next;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@append_history@\nobreak\ \NWlink{nuweb397}{397}, \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_goal_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@ENERGY_CALORIE@\nobreak\ \NWlink{nuweb24}{24}, \verb@ENERGY_CONVERSION@\nobreak\ \NWlink{nuweb24}{24}, \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}, \verb@jd_to_unix_time@\nobreak\ \NWlink{nuweb451a}{451a}, \verb@update_last_transaction@\nobreak\ \NWlink{nuweb398}{398}, \verb@WEIGHT_KILOGRAM@\nobreak\ \NWlink{nuweb24}{24}, \verb@WEIGHT_STONE@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Request historical chart}

The ``histreq'' query displays the Historical Chart Request
form, which allows the user to specify the date range to be
charted in a variety of ways.  The result is a page with much the
same format which includes a stateless request to generate the
chart, which is embedded in the page.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap417}\raggedright\small
\NWtarget{nuweb294}{} $\langle\,${\itshape Request historical chart}\nobreak\ {\footnotesize {294}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@years = $ui->enumerateYears();@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Chart Workshop", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, "Chart", undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($#years >= 0) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Emit historical chart request form}\nobreak\ {\footnotesize \NWlink{nuweb295}{295}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h2>You have no log entries!  You must enter weight logs@\\
\mbox{}\verb@    before you can request historical charts.</h2>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@    update_last_transaction($user_file_name);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@enumerateYears@\nobreak\ \NWlink{nuweb141}{141}, \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@update_last_transaction@\nobreak\ \NWlink{nuweb398}{398}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Emit historical chart request form}

The HTML form used to request a historical chart is written
to the output stream.  If the request was invoked with arguments
specified by a previous invocation, the fields in the request are
preset to those of the last request.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap418}\raggedright\small
\NWtarget{nuweb295}{} $\langle\,${\itshape Emit historical chart request form}\nobreak\ {\footnotesize {295}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Chart Workshop</h1>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Determine first and last days in database}\nobreak\ {\footnotesize \NWlink{nuweb253}{253}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Process custom interval specification, if any}\nobreak\ {\footnotesize \NWlink{nuweb266}{266}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Embed historical chart image in request/result page}\nobreak\ {\footnotesize \NWlink{nuweb297}{297}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Set variables to default to previous request settings}\nobreak\ {\footnotesize \NWlink{nuweb299}{299}, \ldots\ }$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<form id="Hdiet_histchart" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<b>Last:</b>@\\
\mbox{}\verb@    <label><input type="radio" name="period" value="m"$percheck{m} />&nbsp;Month</label>@\\
\mbox{}\verb@    <label><input type="radio" name="period" value="q"$percheck{q} />&nbsp;Quarter</label>@\\
\mbox{}\verb@    <label><input type="radio" name="period" value="h"$percheck{h} />&nbsp;Six&nbsp;months</label>@\\
\mbox{}\verb@    <label><input type="radio" name="period" value="y"$percheck{y} />&nbsp;Year</label>@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <br />@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate form fields for custom chart interval}\nobreak\ {\footnotesize \NWlink{nuweb296}{296}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<br />@\\
\mbox{}\verb@@\\
\mbox{}\verb@<b><label for="size">Chart size:</label></b>&nbsp;<select name="size" id="size">@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate option items for chart sizes}\nobreak\ {\footnotesize \NWlink{nuweb302c}{302c}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@</select>@\\
\mbox{}\verb@<br />@\\
\mbox{}\verb@<label><input type="checkbox" name="print" value="y"$ckprint  />&nbsp;Printer&nbsp;friendly</label>@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<label><input type="checkbox" name="mono" value="y"$ckmono  />&nbsp;Monochrome</label>@\\
\mbox{}\verb@<br />@\\
\mbox{}\verb@@\\
\mbox{}\verb@<input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@<input type="submit" name="q=histreq" value=" Update " />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="reset" value=" Reset " />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb294}{294}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Generate form fields for custom chart interval}

The following fields allow the user to request a chart covering
any interval in the database.  The selection fields are initialised
to produce a chart of all days in the database.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap419}\raggedright\small
\NWtarget{nuweb296}{} $\langle\,${\itshape Generate form fields for custom chart interval}\nobreak\ {\footnotesize {296}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<label><input type="radio" name="period" value="c"$percheck{c} />&nbsp;<b>Custom</b></label>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Custom start and end date selection boxes}\nobreak\ {\footnotesize \NWlink{nuweb271a}{271a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb295}{295}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Embed historical chart image in request/result page}

The historical chart is generated in a ``stateless'' fashion by embedding
an image which invokes this application with a ``histchart'' transaction,
specifying all of the arguments with which we were invoked.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap420}\raggedright\small
\NWtarget{nuweb297}{} $\langle\,${\itshape Embed historical chart image in request/result page}\nobreak\ {\footnotesize {297}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my ($chart_w, $chart_h) = (800, 600);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    ($chart_w, $chart_h) = (320, 240) if $session->{handheld};@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (defined($CGIargs{size})) {@\\
\mbox{}\verb@        if ($CGIargs{size} =~ m/^(\d+)x(\d+)$/) {@\\
\mbox{}\verb@            ($chart_w, $chart_h) = ($1, $2);@\\
\mbox{}\verb@            $chart_w = min(1600, max($chart_w, 320));@\\
\mbox{}\verb@            $chart_h = min(1600, max($chart_h, 200));@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $chart_args = "width=$chart_w&amp;height=$chart_h";@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Determine range of dates to plot in historical chart}\nobreak\ {\footnotesize \NWlink{nuweb298}{298}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@#    my ($start_y, $start_m, $start_d) = ($CGIargs{from_y}, $CGIargs{from_m}, $CGIargs{from_d});@\\
\mbox{}\verb@#    my ($end_y, $end_m, $end_d) = ($CGIargs{to_y}, $CGIargs{to_m}, $CGIargs{to_d});@\\
\mbox{}\verb@    $chart_args .= "&amp;start=$start_y-$start_m-$start_d&amp;end=$end_y-$end_m-$end_d";@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $modeArgs = '';@\\
\mbox{}\verb@    $modeArgs .= '&amp;print=y' if $CGIargs{print};@\\
\mbox{}\verb@    $modeArgs .= '&amp;mono=y' if $CGIargs{mono};@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Define ``cachebuster'' argument}\nobreak\ {\footnotesize \NWlink{nuweb212b}{212b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<p class="centred">@\\
\mbox{}\verb@<img src="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=histchart&amp;s=$session->{session_id}&amp;$chart_args$modeArgs&amp;qx=$cachebuster$tzOff"@\\
\mbox{}\verb@     width="$chart_w" height="$chart_h" alt="Historical chart" />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb295}{295}.
\item \NWtxtIdentsUsed\nobreak\  \verb@max@\nobreak\ \NWlink{nuweb405}{405}, \verb@min@\nobreak\ \NWlink{nuweb405}{405}, \verb@start@\nobreak\ \NWlink{nuweb19b}{19b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subparagraph{Determine range of dates to plot in historical chart}

Use the setting of the ``{\tt period}'' radio button to select
the start and end dates for the historical chart.  In no circumstances
will the date span we determine exceed that of log entries in the
database.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap421}\raggedright\small
\NWtarget{nuweb298}{} $\langle\,${\itshape Determine range of dates to plot in historical chart}\nobreak\ {\footnotesize {298}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my ($start_y, $start_m, $start_d, $end_y, $end_m, $end_d);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $period = $CGIargs{period};@\\
\mbox{}\verb@    $period = 'q' if !$period;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($custom) {@\\
\mbox{}\verb@        ($start_y, $start_m, $start_d) = ($cust_start_y, $cust_start_m, $cust_start_d);@\\
\mbox{}\verb@        ($end_y, $end_m, $end_d) = ($cust_end_y, $cust_end_m, $cust_end_d);@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        my %periodIntervals = (@\\
\mbox{}\verb@                                'm' => -1,@\\
\mbox{}\verb@                                'q' => -3,@\\
\mbox{}\verb@                                'h' => -6,@\\
\mbox{}\verb@                                'y' => -12@\\
\mbox{}\verb@                              );@\\
\mbox{}\verb@        my $pint = $periodIntervals{$period};@\\
\mbox{}\verb@        if (!$pint) {@\\
\mbox{}\verb@            $period = $CGIargs{period} = 'q';@\\
\mbox{}\verb@            $pint = $periodIntervals{$period};@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($f_y, $f_m, $f_d) = $hist->firstDayOfInterval($l_y, $l_m, $l_d, $pint);@\\
\mbox{}\verb@        my $f_jd = gregorian_to_jd($f_y, $f_m, $f_d);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($f_jd < $s_jd) {@\\
\mbox{}\verb@            ($f_y, $f_m, $f_d, $f_jd) = ($s_y, $s_m, $s_d, $s_jd);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        ($start_y, $start_m, $start_d) = ($f_y, $f_m, $f_d);@\\
\mbox{}\verb@        ($end_y, $end_m, $end_d) = ($l_y, $l_m, $l_d);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb297}{297}.
\item \NWtxtIdentsUsed\nobreak\  \verb@firstDayOfInterval@\nobreak\ \NWlink{nuweb111}{111}, \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Set variables to default to previous request settings}

If we have been invoked from a previous historical chart request,
examing the CGI query arguments and preset the variables which will
initialise the fields in our request form to those of the last
request.  The user perceived this as the request parameters being
persistent, with the ability to adjust them and refine the request.

This code is used by several forms; fields which aren't defined
by a form will be ignored.

We have a variety of standard periods as well as ``Custom'', which
is defined by the fields which follow.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap422}\raggedright\small
\NWtarget{nuweb299}{} $\langle\,${\itshape Set variables to default to previous request settings}\nobreak\ {\footnotesize {299}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my %percheck = ( 'm', '', 'q', '', 'h', '', 'y', '', 'c', '' );@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (defined($CGIargs{period})) {@\\
\mbox{}\verb@        $percheck{$CGIargs{period}} = ' checked="checked"';@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        $percheck{q} = ' checked="checked"';@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb299}{299}\NWlink{nuweb300}{, 300}\NWlink{nuweb301a}{, 301a}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb250}{250}\NWlink{nuweb258}{, 258}\NWlink{nuweb260}{, 260}\NWlink{nuweb265a}{, 265a}\NWlink{nuweb274}{, 274}\NWlink{nuweb295}{, 295}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
The following selection boxes specify the starting and ending
dates of the custom interval.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap423}\raggedright\small
\NWtarget{nuweb300}{} $\langle\,${\itshape Set variables to default to previous request settings}\nobreak\ {\footnotesize {300}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my (@{\tt @}\verb@fy_selected, @{\tt @}\verb@ty_selected);@\\
\mbox{}\verb@    for (my $i = 0; $i <= $#years; $i++) {@\\
\mbox{}\verb@        if (defined($CGIargs{from_y}) && ($CGIargs{from_y} eq $years[$i])) {@\\
\mbox{}\verb@            $fy_selected[$i] = ' selected="selected"';@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $fy_selected[$i] = '';@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if (defined($CGIargs{to_y}) && ($CGIargs{to_y} eq $years[$i])) {@\\
\mbox{}\verb@            $ty_selected[$i] = ' selected="selected"';@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $ty_selected[$i] = '';@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my (@{\tt @}\verb@fm_selected, @{\tt @}\verb@tm_selected);@\\
\mbox{}\verb@    for (my $i = 1; $i <= 12; $i++) {@\\
\mbox{}\verb@        if (defined($CGIargs{from_m}) && ($CGIargs{from_m} == $i)) {@\\
\mbox{}\verb@            $fm_selected[$i] = ' selected="selected"';@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $fm_selected[$i] = '';@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if (defined($CGIargs{to_m}) && ($CGIargs{to_m} == $i)) {@\\
\mbox{}\verb@            $tm_selected[$i] = ' selected="selected"';@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $tm_selected[$i] = '';@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my (@{\tt @}\verb@fd_selected, @{\tt @}\verb@td_selected);@\\
\mbox{}\verb@    for (my $i = 1; $i <= 31; $i++) {@\\
\mbox{}\verb@        if (defined($CGIargs{from_d}) && ($CGIargs{from_d} == $i)) {@\\
\mbox{}\verb@            $fd_selected[$i] = ' selected="selected"';@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $fd_selected[$i] = '';@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if (defined($CGIargs{to_d}) && ($CGIargs{to_d} == $i)) {@\\
\mbox{}\verb@            $td_selected[$i] = ' selected="selected"';@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $td_selected[$i] = '';@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb299}{299}\NWlink{nuweb300}{, 300}\NWlink{nuweb301a}{, 301a}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb250}{250}\NWlink{nuweb258}{, 258}\NWlink{nuweb260}{, 260}\NWlink{nuweb265a}{, 265a}\NWlink{nuweb274}{, 274}\NWlink{nuweb295}{, 295}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
The chart size is set by a selection box, which defaults fo
$800\times 600$ for screen presentation and $320\times 240$
for handheld devices.  In fact, chart generation can handle
arbitrary size specifications, but for the moment we only
allow the choices in the selection field.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap424}\raggedright\small
\NWtarget{nuweb301a}{} $\langle\,${\itshape Set variables to default to previous request settings}\nobreak\ {\footnotesize {301a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@cs_selected;@\\
\mbox{}\verb@    $CGIargs{size} = '800x600' if !defined($CGIargs{size});@\\
\mbox{}\verb@    $CGIargs{size} = '320x240' if $session->{handheld};@\\
\mbox{}\verb@    for (my $i = 0; $i <= $#chartSizes; $i++) {@\\
\mbox{}\verb@        if ($CGIargs{size} eq $chartSizes[$i]) {@\\
\mbox{}\verb@            $cs_selected[$i] = ' selected="selected"';@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $cs_selected[$i] = '';@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $ckprint = $CGIargs{print} ? ' checked="checked"' : '';@\\
\mbox{}\verb@    my $ckmono = $CGIargs{mono} ? ' checked="checked"' : '';@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb299}{299}\NWlink{nuweb300}{, 300}\NWlink{nuweb301a}{, 301a}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb250}{250}\NWlink{nuweb258}{, 258}\NWlink{nuweb260}{, 260}\NWlink{nuweb265a}{, 265a}\NWlink{nuweb274}{, 274}\NWlink{nuweb295}{, 295}.
\item \NWtxtIdentsUsed\nobreak\  \verb@$chartSizes@\nobreak\ \NWlink{nuweb388b}{388b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Generate option items for years in database}

Crank out an XHTML \verb+<option>+ item for each year present in
the database.  This is used to supply the values for the
from and to \verb+<select>+ fields in the request form.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap425}\raggedright\small
\NWtarget{nuweb301b}{} $\langle\,${\itshape Generate option items for years in database}\nobreak\ {\footnotesize {301b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $i = 0; $i <= $#years; $i++) {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@        <option$fy_selected[$i]>$years[$i]</option>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb272}{272}\NWlink{nuweb273}{, 273}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Generate option items for months}

Output XHTML \verb+<option>+ item for each month name.  These may
be twiddle with JavaScript to hide months for which no log exists
in the specified year.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap426}\raggedright\small
\NWtarget{nuweb302a}{} $\langle\,${\itshape Generate option items for months}\nobreak\ {\footnotesize {302a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $i = 1; $i <= $#monthNames; $i++) {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@        <option id="$mid$i" value="$i"$fm_selected[$i]>$monthNames[$i]</option>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb272}{272}\NWlink{nuweb273}{, 273}\NWlink{nuweb361}{, 361}\NWlink{nuweb362}{, 362}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Generate option items for days}

Output XHTML \verb+<option>+ item for each day of the month.  These may
be twiddled with JavaScript to hide days which are not present in the
given month of the specified year.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap427}\raggedright\small
\NWtarget{nuweb302b}{} $\langle\,${\itshape Generate option items for days}\nobreak\ {\footnotesize {302b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $i = 1; $i <= 31; $i++) {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@        <option id="$did$i"$fd_selected[$i]>$i</option>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb272}{272}\NWlink{nuweb273}{, 273}\NWlink{nuweb361}{, 361}\NWlink{nuweb362}{, 362}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Generate option items for chart sizes}

Output XHTML \verb+<option>+ item for each day of the month.  These may
be twiddle with JavaScript to hide days which are not present in the
given month of the specified year.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap428}\raggedright\small
\NWtarget{nuweb302c}{} $\langle\,${\itshape Generate option items for chart sizes}\nobreak\ {\footnotesize {302c}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $i = 0; $i <= $#chartSizes; $i++) {@\\
\mbox{}\verb@        my $cs = $chartSizes[$i];@\\
\mbox{}\verb@        $cs =~ s/x/&times;/;@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@        <option id="cs$chartSizes[$i]" value="$chartSizes[$i]"$cs_selected[$i]>$cs</option>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb295}{295}.
\item \NWtxtIdentsUsed\nobreak\  \verb@$chartSizes@\nobreak\ \NWlink{nuweb388b}{388b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Generate historical chart}

A historical chart is generated and returned as an in-line PNG image by
the ``histchart'' query.  Optional ``width'' and ``height''
arguments allow specifying the chart size.  If omitted, the chart defaults
to 640$\times$480 pixels.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap429}\raggedright\small
\NWtarget{nuweb303}{} $\langle\,${\itshape Generate historical chart}\nobreak\ {\footnotesize {303}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $hc = HDiet::history->new($ui, $user_file_name);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Specify Content-type for PNG image}\nobreak\ {\footnotesize \NWlink{nuweb263b}{263b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $CGIargs{width} = 640 if !defined $CGIargs{width};@\\
\mbox{}\verb@    $CGIargs{height} = 480 if !defined $CGIargs{height};@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my ($start_date, $end_date);@\\
\mbox{}\verb@@\\
\mbox{}\verb@###### FIXME:  Sanity check arguments and default if not specified.@\\
\mbox{}\verb@    $start_date = $CGIargs{start} if defined($CGIargs{start});@\\
\mbox{}\verb@    $end_date = $CGIargs{end} if defined($CGIargs{end});@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@dcalc;@\\
\mbox{}\verb@    if ($ui->{plot_diet_plan}) {@\\
\mbox{}\verb@        @{\tt @}\verb@dcalc = $ui->dietPlanLimits();@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $hc->drawChart($fh, $start_date, $end_date, $CGIargs{width}, $CGIargs{height}, \@{\tt @}\verb@dcalc,@\\
\mbox{}\verb@        $CGIargs{print}, $CGIargs{mono});@\\
\mbox{}\verb@@\\
\mbox{}\verb@    update_last_transaction($user_file_name);@\\
\mbox{}\verb@    exit(0);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb178}{178}.
\item \NWtxtIdentsUsed\nobreak\  \verb@dietPlanLimits@\nobreak\ \NWlink{nuweb142}{142}, \verb@drawChart@\nobreak\ \NWlink{nuweb82}{82}, \verb@start@\nobreak\ \NWlink{nuweb19b}{19b}, \verb@update_last_transaction@\nobreak\ \NWlink{nuweb398}{398}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Create new user account request}

Return the form a user fills in to request the creation of a new account.
If this request is made from the login page, any name already entered in
the login form is filled into the corresponding field on the new account
form.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap430}\raggedright\small
\NWtarget{nuweb304a}{} $\langle\,${\itshape Create new user account request}\nobreak\ {\footnotesize {304a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Create New Account", undef, $CGIargs{HDiet_handheld});@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Create New Account</h1>@\\
\mbox{}\verb@<form id="Hdiet_newacct" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Propagate handheld setting to subsequent forms}\nobreak\ {\footnotesize \NWlink{nuweb304b}{304b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $u = HDiet::user->new($CGIargs{HDiet_username});@\\
\mbox{}\verb@    $u->new_account_form($fh);@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<input type="hidden" name="q" value="new_account" />@\\
\mbox{}\verb@<input type="submit" name="login" value=" Create Account " tabindex="19" />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="reset" value=" Clear Form " tabindex="20" />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb183}{183}.
\item \NWtxtIdentsUsed\nobreak\  \verb@login@\nobreak\ \NWlink{nuweb121}{121}, \verb@new_account_form@\nobreak\ \NWlink{nuweb127}{127}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Propagate handheld setting to subsequent forms}

Since we are not logged in at this point, we don't have a session
in which to remember whether the user is accessing us from a handheld
device; we'll have been passed the \verb+HDiet_handheld+ setting
from the main login form checkbox, but we must explicitly propagate
this setting to forms we invoke.  This is done by including a
hidden form field which sets \verb+HDiet_handheld+ if that
variable is set in our own arguments.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap431}\raggedright\small
\NWtarget{nuweb304b}{} $\langle\,${\itshape Propagate handheld setting to subsequent forms}\nobreak\ {\footnotesize {304b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($CGIargs{HDiet_handheld}) {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<div><input type="hidden" name="HDiet_handheld" value="y" /></div>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb198}{198}\NWlink{nuweb203}{, 203}\NWlink{nuweb304a}{, 304a}\NWlink{nuweb310}{, 310}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Process new user account request}

Return the form a user fills in to request the creation of a new account.
If this request is made from the login page, any name already entered in
the login form is filled into the corresponding field on the new account
form.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap432}\raggedright\small
\NWtarget{nuweb305}{} $\langle\,${\itshape Process new user account request}\nobreak\ {\footnotesize {305}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@goofs;@\\
\mbox{}\verb@@\\
\mbox{}\verb@if (0) {        # Set to 1 to investigate reports of account creation problems@\\
\mbox{}\verb@    open(NOF, ">/tmp/hdiet_newacct_$$.txt");@\\
\mbox{}\verb@    use Data::Dumper;@\\
\mbox{}\verb@    print(NOF Data::Dumper->Dump([\%CGIargs, \%ENV], ['*CGIargs', '*ENV']));@\\
\mbox{}\verb@    close(NOF);@\\
\mbox{}\verb@@\\
\mbox{}\verb@}@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Validate user name for new account}\nobreak\ {\footnotesize \NWlink{nuweb306a}{306a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Validate beta test invitation code}\nobreak\ {\footnotesize \NWlink{nuweb306b}{306b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($CGIargs{HDiet_password} ne $CGIargs{HDiet_rpassword}) {@\\
\mbox{}\verb@        push(@{\tt @}\verb@goofs, "Password does not match password confirmation");@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        if (length($CGIargs{HDiet_password}) < 6) {@\\
\mbox{}\verb@            push(@{\tt @}\verb@goofs, "Password must be at least six characters");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    if ($CGIargs{HDiet_email} eq '') {@\\
\mbox{}\verb@        push(@{\tt @}\verb@goofs, "E-mail address is blank");@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        if ($CGIargs{HDiet_email} !~ m/@{\tt @}\verb@/) {@\\
\mbox{}\verb@            push(@{\tt @}\verb@goofs, "E-mail address contains no '\@{\tt @}\verb@' sign");@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $CGIargs{HDiet_email} =~ m/@{\tt @}\verb@(.*)$/;@\\
\mbox{}\verb@            if (!validMailDomain(encodeDomainName($1))) {@\\
\mbox{}\verb@                my $dn = quoteHTML($1);@\\
\mbox{}\verb@                push(@{\tt @}\verb@goofs, "Domain name <tt>$dn</tt> in your E-mail address is invalid");@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($#goofs >= 0) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Report errors in new account request and re-issue form}\nobreak\ {\footnotesize \NWlink{nuweb310}{310}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Create the new user account}\nobreak\ {\footnotesize \NWlink{nuweb307b}{307b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Cancel used beta test invitation code}\nobreak\ {\footnotesize \NWlink{nuweb307a}{307a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    next;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb180b}{180b}.
\item \NWtxtIdentsUsed\nobreak\  \verb@encodeDomainName@\nobreak\ \NWlink{nuweb410}{410}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}, \verb@validMailDomain@\nobreak\ \NWlink{nuweb411}{411}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Validate user name for new account}

Verify that the user name is non-blank and doesn't duplicate that
of an existing account.  We discard trailing white space in user names
but permit leading spaces for the kinky crowd who gets off on such
esoterica.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap433}\raggedright\small
\NWtarget{nuweb306a}{} $\langle\,${\itshape Validate user name for new account}\nobreak\ {\footnotesize {306a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $user_file_name;@\\
\mbox{}\verb@    $CGIargs{HDiet_username} =~ s/\s+$//;@\\
\mbox{}\verb@    if ($CGIargs{HDiet_username} eq '') {@\\
\mbox{}\verb@        push(@{\tt @}\verb@goofs, "User name is blank");@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        $user_file_name = quoteUserName($CGIargs{HDiet_username});@\\
\mbox{}\verb@        if (-d "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name") {@\\
\mbox{}\verb@            push(@{\tt @}\verb@goofs, "User name is already taken: please choose another");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb305}{305}.
\item \NWtxtIdentsUsed\nobreak\  \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Validate beta test invitation code}

In beta test mode, we require an ``invitation code'' to create a new
account.  These invitation codes are generated by an admnistrator
task and stored as files in a directory within the database tree.
We have the ability to define a ``backdoor'' code which allows
creation of accounts without an invitation code.  This allows
testing new account creation without using up invitation codes
at an excessive rate.  Obviously, you shouldn't set the backdoor
to something too easy to guess.  The best choice is to set the backdoor
to the null string; that disables the backdoor entirely.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap434}\raggedright\small
\NWtarget{nuweb306b}{} $\langle\,${\itshape Validate beta test invitation code}\nobreak\ {\footnotesize {306b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $betaInvitation = '';@\\
\mbox{}\verb@    if (@\hbox{$\langle\,${\itshape Beta test}\nobreak\ {\footnotesize \NWlink{nuweb4a}{4a}}$\,\rangle$}\verb@) {@\\
\mbox{}\verb@        if ((@\hbox{$\langle\,${\itshape Beta test backdoor}\nobreak\ {\footnotesize \NWlink{nuweb4b}{4b}}$\,\rangle$}\verb@ eq '') ||@\\
\mbox{}\verb@            ($CGIargs{HDiet_invitation} ne @\hbox{$\langle\,${\itshape Beta test backdoor}\nobreak\ {\footnotesize \NWlink{nuweb4b}{4b}}$\,\rangle$}\verb@)) {@\\
\mbox{}\verb@            if ($CGIargs{HDiet_invitation} eq '') {@\\
\mbox{}\verb@                push(@{\tt @}\verb@goofs, "Beta test invitation is blank");@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                $betaInvitation = $CGIargs{HDiet_invitation};@\\
\mbox{}\verb@                $betaInvitation =~ s/\W//g;@\\
\mbox{}\verb@                if (!(-f "@\hbox{$\langle\,${\itshape Beta Test Invitations Directory}\nobreak\ {\footnotesize \NWlink{nuweb8a}{8a}}$\,\rangle$}\verb@/$betaInvitation.hdi")) {@\\
\mbox{}\verb@                    push(@{\tt @}\verb@goofs, "Beta test invitation is invalid or already used");@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb305}{305}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Cancel used beta test invitation code}

Once a beta test invitation code has been used to create an account,
we cancel it by deleting it from the invitations directory.  If the
backdoor was used, \verb+$betaInvitation+ will remain the null string and
this code will be skipped.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap435}\raggedright\small
\NWtarget{nuweb307a}{} $\langle\,${\itshape Cancel used beta test invitation code}\nobreak\ {\footnotesize {307a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (@\hbox{$\langle\,${\itshape Beta test}\nobreak\ {\footnotesize \NWlink{nuweb4a}{4a}}$\,\rangle$}\verb@) {@\\
\mbox{}\verb@        if ($betaInvitation ne '') {@\\
\mbox{}\verb@            if (!unlink("@\hbox{$\langle\,${\itshape Beta Test Invitations Directory}\nobreak\ {\footnotesize \NWlink{nuweb8a}{8a}}$\,\rangle$}\verb@/$betaInvitation.hdi")) {@\\
\mbox{}\verb@                print(STDERR "Unable to unlink @\hbox{$\langle\,${\itshape Beta Test Invitations Directory}\nobreak\ {\footnotesize \NWlink{nuweb8a}{8a}}$\,\rangle$}\verb@/$betaInvitation.hdi\n");@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            clusterDelete("@\hbox{$\langle\,${\itshape Beta Test Invitations Directory}\nobreak\ {\footnotesize \NWlink{nuweb8a}{8a}}$\,\rangle$}\verb@/$betaInvitation.hdi");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb305}{305}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Create the new user account}

Everything appears to be on the up and up.  Create the directory for the
new user account, write the account information into it, and return the
user to the login page so they can access the new account.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap436}\raggedright\small
\NWtarget{nuweb307b}{} $\langle\,${\itshape Create the new user account}\nobreak\ {\footnotesize {307b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (mkdir("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name")) {@\\
\mbox{}\verb@        clusterMkdir("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name");@\\
\mbox{}\verb@        my $ui = HDiet::user->new($CGIargs{HDiet_username});@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Store settings for user account}\nobreak\ {\footnotesize \NWlink{nuweb308}{308}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Update user account information}\nobreak\ {\footnotesize \NWlink{nuweb309}{309}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        $CGIargs{q} = 'login';@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@         push(@{\tt @}\verb@goofs, "Sorry, somebody else just took that user name: please choose another");@\\
\mbox{}\verb@         @\hbox{$\langle\,${\itshape Report errors in new account request and re-issue form}\nobreak\ {\footnotesize \NWlink{nuweb310}{310}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb305}{305}.
\item \NWtxtIdentsUsed\nobreak\  \verb@login@\nobreak\ \NWlink{nuweb121}{121}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Store settings for user account}

Store the settings from the fields of the account settings
form into the user object.  The test for a blank password allows
this code to be used both for new account creation (where we have
already verified the password is non-blank) and for account
modification (where a blank password indicates no change).

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap437}\raggedright\small
\NWtarget{nuweb308}{} $\langle\,${\itshape Store settings for user account}\nobreak\ {\footnotesize {308}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (defined($CGIargs{HDiet_height_cm})) {@\\
\mbox{}\verb@        $CGIargs{HDiet_height_cm} =~ s/,/./g;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    if (defined($CGIargs{HDiet_height_in})) {@\\
\mbox{}\verb@        $CGIargs{HDiet_height_in} =~ s/,/./g;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($CGIargs{HDiet_height_cm} eq '') {@\\
\mbox{}\verb@        $CGIargs{HDiet_height_cm} = 0;@\\
\mbox{}\verb@        if (($CGIargs{HDiet_height_ft} ne '') || ($CGIargs{HDiet_height_in} ne '')) {@\\
\mbox{}\verb@            $CGIargs{HDiet_height_cm} = 2.54 *@\\
\mbox{}\verb@                ((($CGIargs{HDiet_height_in} ne '') ? $CGIargs{HDiet_height_in} : 0) +@\\
\mbox{}\verb@                 ((($CGIargs{HDiet_height_ft} ne '') ? $CGIargs{HDiet_height_ft} * 12 : 0)));@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    if ($CGIargs{HDiet_password} ne '') {@\\
\mbox{}\verb@        $ui->{password} = $CGIargs{HDiet_password};@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    $CGIargs{HDiet_dchar} = '.' if ($CGIargs{HDiet_dchar} !~ m/^[\.,]$/);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $ui->{first_name} = $CGIargs{HDiet_namef};@\\
\mbox{}\verb@    $ui->{last_name} = $CGIargs{HDiet_namel};@\\
\mbox{}\verb@    $ui->{middle_name} = $CGIargs{HDiet_namem};@\\
\mbox{}\verb@    $ui->{e_mail} = $CGIargs{HDiet_email};@\\
\mbox{}\verb@    $ui->{log_unit} = $CGIargs{HDiet_wunit};@\\
\mbox{}\verb@    $ui->{display_unit} = $CGIargs{HDiet_dunit};@\\
\mbox{}\verb@    $ui->{energy_unit} = $CGIargs{HDiet_eunit};@\\
\mbox{}\verb@    $ui->{decimal_character} = $CGIargs{HDiet_dchar};@\\
\mbox{}\verb@    $ui->{height} = $CGIargs{HDiet_height_cm};@\\
\mbox{}\verb@    $ui->{account_created} = time() if $ui->{account_created} == 0;@\\
\mbox{}\verb@    $ui->{last_modification_time} = time();@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($CGIargs{HDiet_public}) {@\\
\mbox{}\verb@        if ((!$ui->{public}) || $CGIargs{HDiet_pubnew}) {@\\
\mbox{}\verb@            my $pn = HDiet::pubname->new();@\\
\mbox{}\verb@            $pn->assignPublicName($ui);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        if ($ui->{public}) {@\\
\mbox{}\verb@            my $pn = HDiet::pubname->new();@\\
\mbox{}\verb@            $pn->deletePublicName($ui);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb307b}{307b}\NWlink{nuweb313}{, 313}.
\item \NWtxtIdentsUsed\nobreak\  \verb@assignPublicName@\nobreak\ \NWlink{nuweb167}{167}, \verb@deletePublicName@\nobreak\ \NWlink{nuweb169a}{169a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Update user account information}

Save the user account information in the {\tt UserAccount.hdu}
file in the user directory.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap438}\raggedright\small
\NWtarget{nuweb309}{} $\langle\,${\itshape Update user account information}\nobreak\ {\footnotesize {309}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    open(FU, ">:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/UserAccount.hdu") ||@\\
\mbox{}\verb@        die("Cannot open user account file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/UserAccount.hdu");@\\
\mbox{}\verb@    $ui->save(\*FU);@\\
\mbox{}\verb@    close(FU);@\\
\mbox{}\verb@    clusterCopy("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/UserAccount.hdu");@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb199}{199}\NWlink{nuweb244}{, 244}\NWlink{nuweb293}{, 293}\NWlink{nuweb307b}{, 307b}\NWlink{nuweb313}{, 313}.
\item \NWtxtIdentsUsed\nobreak\  \verb@save@\nobreak\ \NWlink{nuweb31}{31}\NWlink{nuweb123}{, 123}\NWlink{nuweb151}{, 151}\NWlink{nuweb156b}{, 156b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Report errors in new account request and re-issue form}

One or more errors were detected in the user's request to create
a new account.  List the errors, then re-issue the form with the
previous values already filled in.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap439}\raggedright\small
\NWtarget{nuweb310}{} $\langle\,${\itshape Report errors in new account request and re-issue form}\nobreak\ {\footnotesize {310}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Create New User Account", undef, $CGIargs{HDiet_handheld});@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Errors in New Account Request</h1>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<p>@\\
\mbox{}\verb@The following errors were found in your request to create@\\
\mbox{}\verb@a new account.  Please remedy them and try again.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<ol>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $i = 0; $i <= $#goofs; $i++) {@\\
\mbox{}\verb@        print($fh "<li>$goofs[$i].</li>\n");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@</ol>@\\
\mbox{}\verb@<form id="Hdiet_newacct" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Propagate handheld setting to subsequent forms}\nobreak\ {\footnotesize \NWlink{nuweb304b}{304b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $u = HDiet::user->new($CGIargs{HDiet_username});@\\
\mbox{}\verb@    $u->{e_mail} = $CGIargs{HDiet_email};@\\
\mbox{}\verb@    $u->{first_name} = $CGIargs{HDiet_namef};@\\
\mbox{}\verb@    $u->{last_name} = $CGIargs{HDiet_namel};@\\
\mbox{}\verb@    $u->{middle_name} = $CGIargs{HDiet_namem};@\\
\mbox{}\verb@    $u->{log_unit} = $CGIargs{HDiet_wunit};@\\
\mbox{}\verb@    $u->{display_unit} = $CGIargs{HDiet_dunit};@\\
\mbox{}\verb@    $u->{energy_unit} = $CGIargs{HDiet_eunit};@\\
\mbox{}\verb@    $CGIargs{HDiet_dchar} = '.' if ($CGIargs{HDiet_dchar} !~ m/^[\.,]$/);@\\
\mbox{}\verb@    $u->{decimal_character} = $CGIargs{HDiet_dchar};@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $u->new_account_form($fh);@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<input type="hidden" name="q" value="new_account" />@\\
\mbox{}\verb@<input type="submit" name="login" value=" Create Account " tabindex="19" />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="reset" value=" Clear Form " tabindex="20" />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@    last;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb305}{305}\NWlink{nuweb307b}{, 307b}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@login@\nobreak\ \NWlink{nuweb121}{121}, \verb@new_account_form@\nobreak\ \NWlink{nuweb127}{127}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Modify user account request}

This form is returned when a logged in user wishes to modify
the settings for their account.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap440}\raggedright\small
\NWtarget{nuweb311}{} $\langle\,${\itshape Modify user account request}\nobreak\ {\footnotesize {311}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($session->{cookie}) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Reject setting query or change from cookie-based login}\nobreak\ {\footnotesize \NWlink{nuweb312}{312}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@@\\
\mbox{}\verb@        write_XHTML_prologue($fh, $homeBase, "Modify Account Settings", undef, $session->{handheld});@\\
\mbox{}\verb@        generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, "Settings", undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Modify Account Settings</h1>@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@To change your password, enter the new value in the &ldquo;Password&rdquo;@\\
\mbox{}\verb@and &ldquo;Retype password&rdquo; fields; if these fields are left blank,@\\
\mbox{}\verb@your password will be unchanged.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@<form id="Hdiet_newacct" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        $ui->new_account_form($fh, 1);@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@<input type="hidden" name="decimal_character" value="$ui->{decimal_character}" />@\\
\mbox{}\verb@<input type="submit" name="q=edit_account" value=" Apply " />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="reset" value=" Reset " />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="submit" name="q=account" value=" Cancel " />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        update_last_transaction($user_file_name);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb180b}{180b}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@new_account_form@\nobreak\ \NWlink{nuweb127}{127}, \verb@update_last_transaction@\nobreak\ \NWlink{nuweb398}{398}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Reject setting query or change from cookie-based login}

A user who has logged in with a ``Remember me'' cookie is not permitted
to view or modify the account settings.  This reduces the potential
damage in the case of a cookie compromise, as the attacker cannot
view or change the user's personal information, or change the
password and thus render the account inaccessible to its owner.
The legitimate user can access the settings by logging out, logging
back in with a password, and then navigating to the settings page.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap441}\raggedright\small
\NWtarget{nuweb312}{} $\langle\,${\itshape Reject setting query or change from cookie-based login}\nobreak\ {\footnotesize {312}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Settings Inaccessible", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, "Settings", undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Settings Inaccessible</h1>@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@You signed into this session with &ldquo;Remember me&rdquo;.@\\
\mbox{}\verb@In the interest of security, the private information in the Settings@\\
\mbox{}\verb@page cannot be displayed or changed in such a session.  To access the@\\
\mbox{}\verb@Settings page, please sign out and then sign back in with your@\\
\mbox{}\verb@user name and password.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    update_last_transaction($user_file_name);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb311}{311}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@update_last_transaction@\nobreak\ \NWlink{nuweb398}{398}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Process user account modification}

This transaction runs when the user submits the user
account modification form.  It validates the fields and
if all is well updates the user account properties.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap442}\raggedright\small
\NWtarget{nuweb313}{} $\langle\,${\itshape Process user account modification}\nobreak\ {\footnotesize {313}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@goofs;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($CGIargs{HDiet_password} ne $CGIargs{HDiet_rpassword}) {@\\
\mbox{}\verb@        push(@{\tt @}\verb@goofs, "Password does not match password confirmation");@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        if (($CGIargs{HDiet_password} ne '') && (length($CGIargs{HDiet_password})) < 6) {@\\
\mbox{}\verb@            push(@{\tt @}\verb@goofs, "New password must be at least six characters");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    if ($CGIargs{HDiet_email} eq '') {@\\
\mbox{}\verb@        push(@{\tt @}\verb@goofs, "E-mail address is blank");@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        if ($CGIargs{HDiet_email} !~ m/@{\tt @}\verb@/) {@\\
\mbox{}\verb@            push(@{\tt @}\verb@goofs, "E-mail address contains no '\@{\tt @}\verb@' sign");@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $CGIargs{HDiet_email} =~ m/@{\tt @}\verb@(.*)$/;@\\
\mbox{}\verb@            if (!validMailDomain(encodeDomainName($1))) {@\\
\mbox{}\verb@                my $dn = quoteHTML($1);@\\
\mbox{}\verb@                push(@{\tt @}\verb@goofs, "Domain name <tt>$dn</tt> in your E-mail address is invalid");@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($#goofs >= 0) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Report errors in account modification request and re-issue form}\nobreak\ {\footnotesize \NWlink{nuweb315}{315}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (!$readOnly) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Log changes to account settings}\nobreak\ {\footnotesize \NWlink{nuweb314}{314}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Store settings for user account}\nobreak\ {\footnotesize \NWlink{nuweb308}{308}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Update user account information}\nobreak\ {\footnotesize \NWlink{nuweb309}{309}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Account Settings Changed", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Account Settings Changed</tt></h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@The settings for your account have been changed per your request.@\\
\mbox{}\verb@Please click the link below to return to your account's home page.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=account&amp;s=$session->{session_id}$tzOff">Return to account home page</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    update_last_transaction($user_file_name);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb180b}{180b}.
\item \NWtxtIdentsUsed\nobreak\  \verb@encodeDomainName@\nobreak\ \NWlink{nuweb410}{410}, \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}, \verb@update_last_transaction@\nobreak\ \NWlink{nuweb398}{398}, \verb@validMailDomain@\nobreak\ \NWlink{nuweb411}{411}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Log changes to account settings}

Compare the new account settings to those presently in effect
and compose a string indicating which have changed, which is appended
to the history log.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap443}\raggedright\small
\NWtarget{nuweb314}{} $\langle\,${\itshape Log changes to account settings}\nobreak\ {\footnotesize {314}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $settings_changed = '';@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $CGIargs{HDiet_height_cm} =~ s/,/./;@\\
\mbox{}\verb@    $CGIargs{HDiet_height_in} =~ s/,/./;@\\
\mbox{}\verb@    my $heightcm = $CGIargs{HDiet_height_cm};@\\
\mbox{}\verb@    if ($heightcm eq '') {@\\
\mbox{}\verb@        $heightcm = 0;@\\
\mbox{}\verb@        if (($CGIargs{HDiet_height_ft} ne '') || ($CGIargs{HDiet_height_in} ne '')) {@\\
\mbox{}\verb@            $heightcm = 2.54 *@\\
\mbox{}\verb@                ((($CGIargs{HDiet_height_in} ne '') ? $CGIargs{HDiet_height_in} : 0) +@\\
\mbox{}\verb@                 ((($CGIargs{HDiet_height_ft} ne '') ? $CGIargs{HDiet_height_ft} * 12 : 0)));@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    if ($CGIargs{HDiet_password} ne '') {@\\
\mbox{}\verb@        $settings_changed .= ',Password' if $ui->{password} ne $CGIargs{HDiet_password};@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    $settings_changed .= ',FirstName' if $ui->{first_name} ne $CGIargs{HDiet_namef};@\\
\mbox{}\verb@    $settings_changed .= ',LastName' if $ui->{last_name} ne $CGIargs{HDiet_namel};@\\
\mbox{}\verb@    $settings_changed .= ',MiddleName' if $ui->{middle_name} ne $CGIargs{HDiet_namem};@\\
\mbox{}\verb@    $settings_changed .= ',E-Mail' if $ui->{e_mail} ne $CGIargs{HDiet_email};@\\
\mbox{}\verb@    $settings_changed .= ',LogUnit' if $ui->{log_unit} ne $CGIargs{HDiet_wunit};@\\
\mbox{}\verb@    $settings_changed .= ',DisplayUnit' if $ui->{display_unit} ne $CGIargs{HDiet_dunit};@\\
\mbox{}\verb@    $settings_changed .= ',EnergyUnit' if $ui->{energy_unit} ne $CGIargs{HDiet_eunit};@\\
\mbox{}\verb@    $settings_changed .= ',DecimalCharacter' if $ui->{decimal_character} ne $CGIargs{HDiet_dchar};@\\
\mbox{}\verb@    $settings_changed .= ',Height' if $ui->{height} ne $heightcm;@\\
\mbox{}\verb@    $settings_changed .= ',Public' if $ui->{public} != ($CGIargs{HDiet_public} ? 1 : 0);@\\
\mbox{}\verb@    $settings_changed .= ',Pubname' if $CGIargs{HDiet_pubnew};@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $settings_changed =~ s/^,//;@\\
\mbox{}\verb@    append_history($user_file_name, 8, $settings_changed);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb313}{313}.
\item \NWtxtIdentsUsed\nobreak\  \verb@append_history@\nobreak\ \NWlink{nuweb397}{397}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Report errors in account modification request and re-issue form}

One or more errors were detected in the user's request to change
account settings.  List the errors, then re-issue the form with the
previous values already filled in.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap444}\raggedright\small
\NWtarget{nuweb315}{} $\langle\,${\itshape Report errors in account modification request and re-issue form}\nobreak\ {\footnotesize {315}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Modify Account Settings", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, "Settings", undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Errors in Account Settings</h1>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<p>@\\
\mbox{}\verb@The following errors were found in your request to change@\\
\mbox{}\verb@your account settings.  Please remedy them and try again.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<ol>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $i = 0; $i <= $#goofs; $i++) {@\\
\mbox{}\verb@        print($fh "<li>$goofs[$i].</li>\n");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@</ol>@\\
\mbox{}\verb@<form id="Hdiet_newacct" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $ui->new_account_form($fh, 1);@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@<input type="hidden" name="decimal_character" value="$ui->{decimal_character}" />@\\
\mbox{}\verb@<input type="submit" name="q=edit_account" value=" Apply " />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="reset" value=" Reset " />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="submit" name="q=account" value=" Cancel " />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=account&amp;s=$session->{session_id}$tzOff">Back to account page</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@    last;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb313}{313}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@new_account_form@\nobreak\ \NWlink{nuweb127}{127}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Forget all persistent logins}

Scan the ``Remember me'' directory and delete all tokens belonging to
this user.  This has the effect of invalidating all persistent login
cookies stored in browsers for this user.  The browser will retain the
cookie and send it, but since there is no token corresponding to
its value, it will be ignored.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap445}\raggedright\small
\NWtarget{nuweb316}{} $\langle\,${\itshape Forget all persistent logins}\nobreak\ {\footnotesize {316}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Obtain list of persistent login tokens}\nobreak\ {\footnotesize \NWlink{nuweb344}{344}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Forget Persistent Logins", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, "Settings", undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $ndel = 0;@\\
\mbox{}\verb@#print($fh "<pre>\n");@\\
\mbox{}\verb@    for my $f (keys(%cookies)) {@\\
\mbox{}\verb@        my $cook = $cookies{$f};@\\
\mbox{}\verb@        if ($cook->{login_name} eq $ui->{login_name}) {@\\
\mbox{}\verb@#            $cook->describe($fh);@\\
\mbox{}\verb@            $ndel += unlink("@\hbox{$\langle\,${\itshape Remember Me Directory}\nobreak\ {\footnotesize \NWlink{nuweb13d}{13d}}$\,\rangle$}\verb@/$f.hdr");@\\
\mbox{}\verb@            clusterDelete("@\hbox{$\langle\,${\itshape Remember Me Directory}\nobreak\ {\footnotesize \NWlink{nuweb13d}{13d}}$\,\rangle$}\verb@/$f.hdr");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@#print($fh "</pre>\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Forget Persistent Logins</h1>@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($ndel > 0) {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@All persistent logins (a total of $ndel) have been forgotten.  You@\\
\mbox{}\verb@will have to log in with your name and password on the next session@\\
\mbox{}\verb@from all browsers.@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@You had no persistent logins.@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    update_last_transaction($user_file_name);@\\
\mbox{}\verb@    append_history($user_file_name, 18, $ndel);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb180b}{180b}.
\item \NWtxtIdentsUsed\nobreak\  \verb@append_history@\nobreak\ \NWlink{nuweb397}{397}, \verb@describe@\nobreak\ \NWlink{nuweb27}{27}\NWlink{nuweb122}{, 122}\NWlink{nuweb150}{, 150}\NWlink{nuweb156a}{, 156a}, \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@update_last_transaction@\nobreak\ \NWlink{nuweb398}{398}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{List publicly-visible accounts}

Show a list of accounts whose owners have granted read-only browse
access to the general public.  The form includes buttons which
permit visitors to browse the public account of their choice.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap446}\raggedright\small
\NWtarget{nuweb317}{} $\langle\,${\itshape List publicly-visible accounts}\nobreak\ {\footnotesize {317}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($readOnly) {@\\
\mbox{}\verb@        my $qun = quoteUserName($real_user_name);@\\
\mbox{}\verb@        die("Invalid \"$CGIargs{q}\" transaction attempted by read-only account $qun");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Browse Public Accounts", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $acct_category = $CGIargs{acct_category};@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Obtain list of public accounts}\nobreak\ {\footnotesize \NWlink{nuweb318}{318}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c" style="margin-bottom: 0px;">Browse Public Accounts</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $acct_qual;@\\
\mbox{}\verb@    my ($chk_all, $chk_act, $chk_inact) = ('', '', '');@\\
\mbox{}\verb@    if (!defined($acct_category) || ($acct_category eq 'all')) {@\\
\mbox{}\verb@        print($fh "<h3 class=\"acct_category\">All Public Accounts</h3>\n");@\\
\mbox{}\verb@        $acct_qual = '';@\\
\mbox{}\verb@        $chk_all = ' selected="selected"';@\\
\mbox{}\verb@    } elsif ($acct_category eq 'active') {@\\
\mbox{}\verb@        print($fh "<h3 class=\"acct_category\">Active Public Accounts (Updated in the last 30 days)</h3>\n");@\\
\mbox{}\verb@        $acct_qual = 'active ';@\\
\mbox{}\verb@        $chk_act = ' selected="selected"';@\\
\mbox{}\verb@    } elsif ($acct_category eq 'inactive') {@\\
\mbox{}\verb@        print($fh "<h3 class=\"acct_category\">Inactive Public Accounts (No update in the last 30 days)</h3>\n");@\\
\mbox{}\verb@        $acct_qual = 'inactive ';@\\
\mbox{}\verb@        $chk_inact = ' selected="selected"';@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<form id="Hdiet_pubacct" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@    <p class="centred" style="margin-top: 0px; margin-bottom: 4px;">@\\
\mbox{}\verb@    <input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@    <select name="acct_category" size="1">@\\
\mbox{}\verb@        <option value="active"$chk_act>Active accounts</option>@\\
\mbox{}\verb@        <option value="inactive"$chk_inact>Inactive accounts</option>@\\
\mbox{}\verb@        <option value="all"$chk_all>All accounts</option>@\\
\mbox{}\verb@    </select>@\\
\mbox{}\verb@    <input type="submit" name="q=browsepub" value=" View " />@\\
\mbox{}\verb@    </p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<form id="Hdiet_acctmgr" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<input type="submit" name="q=do_public_browseacct" value=" Access " />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<table border="border" class="mlog">@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@    <th>Sel</th>@\\
\mbox{}\verb@    <th>Public Name</th>@\\
\mbox{}\verb@    <th>Member Since</th>@\\
\mbox{}\verb@    <th>Public Since</th>@\\
\mbox{}\verb@    <th>Weight</th>@\\
\mbox{}\verb@    <th>Energy</th>@\\
\mbox{}\verb@    <th>Months</th>@\\
\mbox{}\verb@    <th>First Log</th>@\\
\mbox{}\verb@    <th>Last Log</th>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $accts_displayed = 0;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate table of public accounts}\nobreak\ {\footnotesize \NWlink{nuweb319}{319}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@</table>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="centred">@\\
\mbox{}\verb@$accts_displayed ${acct_qual}public accounts displayed.<br />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@<input type="submit" name="q=do_public_browseacct" value=" Access " />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Obtain list of public accounts}

Walk through the {\tt Pubname} directory and build a hash of all
public accounts.  The key to the hash is the name of the
account, and the value is the real user name.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap447}\raggedright\small
\NWtarget{nuweb318}{} $\langle\,${\itshape Obtain list of public accounts}\nobreak\ {\footnotesize {318}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my %accounts;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    opendir(CD, "@\hbox{$\langle\,${\itshape Public Name Directory}\nobreak\ {\footnotesize \NWlink{nuweb7g}{7g}}$\,\rangle$}\verb@") ||@\\
\mbox{}\verb@        die("Cannot open directory @\hbox{$\langle\,${\itshape Public Name Directory}\nobreak\ {\footnotesize \NWlink{nuweb7g}{7g}}$\,\rangle$}\verb@");@\\
\mbox{}\verb@    for my $f (grep(/.*\.hdp$/, readdir(CD))) {@\\
\mbox{}\verb@        open(FU, "<:utf8", "@\hbox{$\langle\,${\itshape Public Name Directory}\nobreak\ {\footnotesize \NWlink{nuweb7g}{7g}}$\,\rangle$}\verb@/$f") ||@\\
\mbox{}\verb@            die("Cannot open user account directory @\hbox{$\langle\,${\itshape Public Name Directory}\nobreak\ {\footnotesize \NWlink{nuweb7g}{7g}}$\,\rangle$}\verb@/$f");@\\
\mbox{}\verb@        my $pn = HDiet::pubname->new();@\\
\mbox{}\verb@        $pn->load(\*FU);@\\
\mbox{}\verb@        close(FU);@\\
\mbox{}\verb@        my $sortcode = $pn->{public_name};@\\
\mbox{}\verb@        $accounts{$sortcode} = $pn->{true_name};@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    closedir(CD);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb317}{317}.
\item \NWtxtIdentsUsed\nobreak\  \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Generate table of public accounts}

Iterate over the hash containing the public accounts and generate
the XHTML table from which the user can choose the one to
access.  Each row in the table has a radio button which allows
that account to be selected.  The table is generated in alphabetical
order of public name.  The \verb+%accounts+ hash uses the public
name as the key and contains the true name as the value; the
properties of the account are retrieved for each account from
the user's account directory.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap448}\raggedright\small
\NWtarget{nuweb319}{} $\langle\,${\itshape Generate table of public accounts}\nobreak\ {\footnotesize {319}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (!defined($acct_category)) {@\\
\mbox{}\verb@        $acct_category = 'active';@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    for my $n (sort(keys(%accounts))) {@\\
\mbox{}\verb@        my $qn = quoteHTML($n);@\\
\mbox{}\verb@        my $qun = quoteUserName($accounts{$n});@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($acct_category ne 'all') {@\\
\mbox{}\verb@            my $lti = time() - last_transaction_time($qun);@\\
\mbox{}\verb@            my $month = 30 * 24 * 60 * 60;@\\
\mbox{}\verb@            if ((($acct_category eq 'active') && ($lti > $month)) ||@\\
\mbox{}\verb@                (($acct_category eq 'inactive') && ($lti < $month))) {@\\
\mbox{}\verb@                next;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        open(FU, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$qun/UserAccount.hdu") ||@\\
\mbox{}\verb@            next;@\\
\mbox{}\verb@        my $ui = HDiet::user->new();@\\
\mbox{}\verb@        $ui->load(\*FU);@\\
\mbox{}\verb@        close(FU);@\\
\mbox{}\verb@        my $alink = quoteHTML($n);@\\
\mbox{}\verb@        my @{\tt @}\verb@acreate = gmtime($ui->{account_created});@\\
\mbox{}\verb@        my $acr = sprintf("%04d-%02d-%02d", $acreate[5] + 1900, $acreate[4] + 1, $acreate[3]);@\\
\mbox{}\verb@        my @{\tt @}\verb@apsince = gmtime($ui->{public_since});@\\
\mbox{}\verb@        my $aps = sprintf("%04d-%02d-%02d", $apsince[5] + 1900, $apsince[4] + 1, $apsince[3]);@\\
\mbox{}\verb@        my ($wu, $eu) = (HDiet::monthlog::WEIGHT_ABBREVIATIONS->[$ui->{display_unit}],@\\
\mbox{}\verb@                         HDiet::monthlog::ENERGY_ABBREVIATIONS->[$ui->{energy_unit}]);@\\
\mbox{}\verb@        my @{\tt @}\verb@months = $ui->enumerateMonths();@\\
\mbox{}\verb@        my $nmonths = $#months + 1;@\\
\mbox{}\verb@        $months[0] = '' if $nmonths == 0;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $accts_displayed++;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@    <td><input type="radio" name="pubacct" value="$alink" /></td>@\\
\mbox{}\verb@    <td>$n</td>@\\
\mbox{}\verb@    <td>$acr</td>@\\
\mbox{}\verb@    <td>$aps</td>@\\
\mbox{}\verb@    <td>$wu</td>@\\
\mbox{}\verb@    <td>$eu</td>@\\
\mbox{}\verb@    <td>$nmonths</td>@\\
\mbox{}\verb@    <td>$months[0]</td>@\\
\mbox{}\verb@    <td>$months[$#months]</td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb317}{317}.
\item \NWtxtIdentsUsed\nobreak\  \verb@enumerateMonths@\nobreak\ \NWlink{nuweb140}{140}, \verb@last_transaction_time@\nobreak\ \NWlink{nuweb399a}{399a}, \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}, \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}, \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Provide browse access to public account}

The user has selected a public account to browse.  After verifying that
there is, in fact, a public account with the name requested, the
\verb+browse_name+ of the user's session is set to the requested
public name.  On subsequent transactions, the user will be granted
read-only access to the designated public account.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap449}\raggedright\small
\NWtarget{nuweb320}{} $\langle\,${\itshape Provide browse access to public account}\nobreak\ {\footnotesize {320}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($readOnly) {@\\
\mbox{}\verb@        my $qun = quoteUserName($real_user_name);@\\
\mbox{}\verb@        die("Invalid \"$CGIargs{q}\" transaction attempted by read-only account $qun");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (!defined($CGIargs{pubacct})) {@\\
\mbox{}\verb@        write_XHTML_prologue($fh, $homeBase, "Invalid Access Request", undef, $session->{handheld});@\\
\mbox{}\verb@        generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Invalid Access Request</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@You entered a request to access a public account, but did not specify which@\\
\mbox{}\verb@account you wished to access.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=browsepub&amp;s=$session->{session_id}$tzOff">Return to browse public accounts</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@        exit(0);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Look up public account and verify it exists}\nobreak\ {\footnotesize \NWlink{nuweb321}{321}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $session->{effective_name} = '';@\\
\mbox{}\verb@    $session->{browse_name} = $pn->{public_name};@\\
\mbox{}\verb@    open(FS, ">:utf8", "@\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$session->{session_id}.hds") ||@\\
\mbox{}\verb@        die("Cannot create session file @\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$session->{session_id}.hds");@\\
\mbox{}\verb@    $session->save(\*FS);@\\
\mbox{}\verb@    close(FS);@\\
\mbox{}\verb@    clusterCopy("@\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$session->{session_id}.hds");@\\
\mbox{}\verb@    $CGIargs{q} = 'account';@\\
\mbox{}\verb@    next;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}, \verb@save@\nobreak\ \NWlink{nuweb31}{31}\NWlink{nuweb123}{, 123}\NWlink{nuweb151}{, 151}\NWlink{nuweb156b}{, 156b}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Look up public account and verify it exists}

The specified public account name is looked up using the
{\tt pubname::findPublicName} method.  If no such account is
found, an XHTML reply page is returned to the user.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap450}\raggedright\small
\NWtarget{nuweb321}{} $\langle\,${\itshape Look up public account and verify it exists}\nobreak\ {\footnotesize {321}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $pn = HDiet::pubname->new();@\\
\mbox{}\verb@    if (!defined($pn->findPublicName($CGIargs{pubacct}))) {@\\
\mbox{}\verb@        my $qn = quoteHTML($CGIargs{pubacct});@\\
\mbox{}\verb@        write_XHTML_prologue($fh, $homeBase, "Invalid Access Request", undef, $session->{handheld});@\\
\mbox{}\verb@        generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Invalid Access Request</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@You requested to access a public account@\\
\mbox{}\verb@&ldquo;<b>$qn</b>&rdquo;, but no such public@\\
\mbox{}\verb@account exists.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=browsepub&amp;s=$session->{session_id}$tzOff">Return to browse public accounts</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@        exit(0);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb320}{320}.
\item \NWtxtIdentsUsed\nobreak\  \verb@findPublicName@\nobreak\ \NWlink{nuweb168}{168}, \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Request invitation codes}

Request one or more codes used to invite users during the
beta test phase.  The request form allows the administrator
to specify how many codes are to be generated.  The codes
are returned in a text box on a result form.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap451}\raggedright\small
\NWtarget{nuweb322}{} $\langle\,${\itshape Request invitation codes}\nobreak\ {\footnotesize {322}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (@\hbox{$\langle\,${\itshape Beta test}\nobreak\ {\footnotesize \NWlink{nuweb4a}{4a}}$\,\rangle$}\verb@) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Verify that user has administrator privilege}\nobreak\ {\footnotesize \NWlink{nuweb331}{331}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        write_XHTML_prologue($fh, $homeBase, "Request Invitation Codes", undef, $session->{handheld});@\\
\mbox{}\verb@        generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Request Invitation Codes</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<form id="Hdiet_invite" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@Number of invitations to generate:@\\
\mbox{}\verb@<input type="text" name="ninvite" size="4" maxlength="4" value="1" />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@<input type="submit" name="q=generate_invitations" value=" Generate " />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="reset" value=" Reset " />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb181}{181}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Generate invitation codes}

Generate the requested beta test invitation codes and report them in a
text box whence they can be copied and saved for issuance to authorised
testers.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap452}\raggedright\small
\NWtarget{nuweb323}{} $\langle\,${\itshape Generate invitation codes}\nobreak\ {\footnotesize {323}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (@\hbox{$\langle\,${\itshape Beta test}\nobreak\ {\footnotesize \NWlink{nuweb4a}{4a}}$\,\rangle$}\verb@) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Verify that user has administrator privilege}\nobreak\ {\footnotesize \NWlink{nuweb331}{331}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        write_XHTML_prologue($fh, $homeBase, "Invitation Codes Generated", undef, $session->{handheld});@\\
\mbox{}\verb@        generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $ninvite = $CGIargs{ninvite};@\\
\mbox{}\verb@        $ninvite = 1 if !$ninvite;@\\
\mbox{}\verb@        $ninvite = max(1, min($ninvite, 20));@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Invitation Codes Generated</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<form id="Hdiet_invgen" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@<input type="hidden" name="ninvite" value="$ninvite" />@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<textarea cols="20" rows="$ninvite" name="invitations">@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb323}{323}\NWlink{nuweb324}{, 324}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb181}{181}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@max@\nobreak\ \NWlink{nuweb405}{405}, \verb@min@\nobreak\ \NWlink{nuweb405}{405}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
Now we actually generate the requested number of invitation
codes and plug them into the results text box.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap453}\raggedright\small
\NWtarget{nuweb324}{} $\langle\,${\itshape Generate invitation codes}\nobreak\ {\footnotesize {324}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@        for (my $i = 0; $i < $ninvite; $i++) {@\\
\mbox{}\verb@            my $pw;@\\
\mbox{}\verb@@\\
\mbox{}\verb@            while (1) {@\\
\mbox{}\verb@                #   Generate invitations until we find a unique one@\\
\mbox{}\verb@                $pw = $ui->generatePassword(8,@\\
\mbox{}\verb@                        "ABCDEFGHIJKLMNPQRSTUVWXYZ" .@\\
\mbox{}\verb@                        "abcdefghjkmnopqrstuvwxyz" .@\\
\mbox{}\verb@                        "23456789");@\\
\mbox{}\verb@                if (!(-f "@\hbox{$\langle\,${\itshape Beta Test Invitations Directory}\nobreak\ {\footnotesize \NWlink{nuweb8a}{8a}}$\,\rangle$}\verb@/$pw.hdi")) {@\\
\mbox{}\verb@                    last;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            open(FO, ">:utf8", "@\hbox{$\langle\,${\itshape Beta Test Invitations Directory}\nobreak\ {\footnotesize \NWlink{nuweb8a}{8a}}$\,\rangle$}\verb@/$pw.hdi") ||@\\
\mbox{}\verb@                die("Cannot create invitation file @\hbox{$\langle\,${\itshape Beta Test Invitations Directory}\nobreak\ {\footnotesize \NWlink{nuweb8a}{8a}}$\,\rangle$}\verb@/$pw.hdi");@\\
\mbox{}\verb@            print(FO time() . "\n");@\\
\mbox{}\verb@            close(FO);@\\
\mbox{}\verb@            clusterCopy("@\hbox{$\langle\,${\itshape Beta Test Invitations Directory}\nobreak\ {\footnotesize \NWlink{nuweb8a}{8a}}$\,\rangle$}\verb@/$pw.hdi");@\\
\mbox{}\verb@            print($fh quoteHTML($pw), "\n");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@</textarea>@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@<input type="submit" name="q=generate_invitations" value=" Generate More " />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="submit" name="q=account" value=" Done " />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb323}{323}\NWlink{nuweb324}{, 324}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb181}{181}.
\item \NWtxtIdentsUsed\nobreak\  \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Display administrator account manager}

Display the account manager page, which summaries existing
accounts and allows the administrator to perform various
functions upon them.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap454}\raggedright\small
\NWtarget{nuweb325}{} $\langle\,${\itshape Display administrator account manager}\nobreak\ {\footnotesize {325}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Verify that user has administrator privilege}\nobreak\ {\footnotesize \NWlink{nuweb331}{331}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Account Manager", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c" style="margin-bottom: 0px;">Account Manager</h1>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $acct_qual;@\\
\mbox{}\verb@    my ($chk_all, $chk_act, $chk_inact) = ('', '', '');@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $acct_category = $CGIargs{acct_category};@\\
\mbox{}\verb@    if (!defined($acct_category) || ($acct_category eq 'all')) {@\\
\mbox{}\verb@        print($fh "<h3 class=\"acct_category\">All Accounts</h3>\n");@\\
\mbox{}\verb@        $acct_qual = '';@\\
\mbox{}\verb@        $chk_all = ' selected="selected"';@\\
\mbox{}\verb@    } elsif ($acct_category eq 'active') {@\\
\mbox{}\verb@        print($fh "<h3 class=\"acct_category\">Active Accounts (Updated in the last 30 days)</h3>\n");@\\
\mbox{}\verb@        $acct_qual = 'active ';@\\
\mbox{}\verb@        $chk_act = ' selected="selected"';@\\
\mbox{}\verb@    } elsif ($acct_category eq 'inactive') {@\\
\mbox{}\verb@        print($fh "<h3 class=\"acct_category\">Inactive Accounts (No update in the last 30 days)</h3>\n");@\\
\mbox{}\verb@        $acct_qual = 'inactive ';@\\
\mbox{}\verb@        $chk_inact = ' selected="selected"';@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<form id="Hdiet_pubacct" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@    <p class="centred" style="margin-top: 0px; margin-bottom: 4px;">@\\
\mbox{}\verb@    <input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@    <select name="acct_category" size="1">@\\
\mbox{}\verb@        <option value="active"$chk_act>Active accounts</option>@\\
\mbox{}\verb@        <option value="inactive"$chk_inact>Inactive accounts</option>@\\
\mbox{}\verb@        <option value="all"$chk_all>All accounts</option>@\\
\mbox{}\verb@    </select>@\\
\mbox{}\verb@    <input type="submit" name="q=acctmgr" value=" View " />@\\
\mbox{}\verb@    </p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@<form id="Hdiet_acctmgr" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb325}{325}\NWlink{nuweb326}{, 326}\NWlink{nuweb327}{, 327}\NWlink{nuweb328}{, 328}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb181}{181}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{

The following table lists the accounts.  The column headings are
defined in the first row.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap455}\raggedright\small
\NWtarget{nuweb326}{} $\langle\,${\itshape Display administrator account manager}\nobreak\ {\footnotesize {326}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@<table border="border" class="mlog">@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@    <th>Sel</th>@\\
\mbox{}\verb@    <th>Login</th>@\\
\mbox{}\verb@    <th>First</th>@\\
\mbox{}\verb@    <th>Mid</th>@\\
\mbox{}\verb@    <th>Last</th>@\\
\mbox{}\verb@    <th>E-mail</th>@\\
\mbox{}\verb@    <th>Created</th>@\\
\mbox{}\verb@    <th>Weight</th>@\\
\mbox{}\verb@    <th>Energy</th>@\\
\mbox{}\verb@    <th>Adm</th>@\\
\mbox{}\verb@    <th>Pub</th>@\\
\mbox{}\verb@    <th>R/O</th>@\\
\mbox{}\verb@    <th>Pubname</th>@\\
\mbox{}\verb@    <th>Months</th>@\\
\mbox{}\verb@    <th>Start</th>@\\
\mbox{}\verb@    <th>Latest</th>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb325}{325}\NWlink{nuweb326}{, 326}\NWlink{nuweb327}{, 327}\NWlink{nuweb328}{, 328}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb181}{181}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{

Loop through the accounts, sorted in alphabetical order (case-insensitive),
and output one account per line.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap456}\raggedright\small
\NWtarget{nuweb327}{} $\langle\,${\itshape Display administrator account manager}\nobreak\ {\footnotesize {327}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Obtain list of open accounts}\nobreak\ {\footnotesize \NWlink{nuweb329}{329}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my ($naccts, $npub) = (0, 0);@\\
\mbox{}\verb@    for my $n (sort({ lc($a) cmp lc($b)} keys(%accounts))) {@\\
\mbox{}\verb@        my $qn = quoteHTML($n);@\\
\mbox{}\verb@        open(FU, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$accounts{$n}/UserAccount.hdu") ||@\\
\mbox{}\verb@            die("Cannot open user account directory @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$accounts{$n}/UserAccount.hdu");@\\
\mbox{}\verb@        my $ui = HDiet::user->new();@\\
\mbox{}\verb@        $ui->load(\*FU);@\\
\mbox{}\verb@        close(FU);@\\
\mbox{}\verb@        my $alink = quoteHTML($n);@\\
\mbox{}\verb@        my @{\tt @}\verb@acreate = gmtime($ui->{account_created});@\\
\mbox{}\verb@        my $acr = sprintf("%04d-%02d-%02d", $acreate[5] + 1900, $acreate[4] + 1, $acreate[3]);@\\
\mbox{}\verb@        my $qem = quoteHTML($ui->{e_mail});@\\
\mbox{}\verb@        my $adm = $ui->{administrator} ? '&#10004;' : '';@\\
\mbox{}\verb@        my $pub = $ui->{public} ? '&#10004;' : '';@\\
\mbox{}\verb@        my $ronly = $ui->{read_only} ? '&#10004;' : '';@\\
\mbox{}\verb@        my @{\tt @}\verb@name = (quoteHTML($ui->{first_name}), quoteHTML($ui->{middle_name}),@\\
\mbox{}\verb@                     quoteHTML($ui->{last_name}), quoteHTML($ui->{public_name}));@\\
\mbox{}\verb@#if ($ui->{log_unit} eq '' || $ui->{display_unit} eq '' || $ui->{energy_unit} eq '') { print(STDERR "Gronk!  $n  ($ui->{log_unit}) ($ui->{display_unit}) ($ui->{energy_unit})\n"); }@\\
\mbox{}\verb@        my ($wu, $eu) = ((HDiet::monthlog::WEIGHT_ABBREVIATIONS->[$ui->{log_unit}] .@\\
\mbox{}\verb@                        "/" . HDiet::monthlog::WEIGHT_ABBREVIATIONS->[$ui->{display_unit}]),@\\
\mbox{}\verb@                         HDiet::monthlog::ENERGY_ABBREVIATIONS->[$ui->{energy_unit}]);@\\
\mbox{}\verb@        my @{\tt @}\verb@months = $ui->enumerateMonths();@\\
\mbox{}\verb@        my $nmonths = $#months + 1;@\\
\mbox{}\verb@        $months[0] = '' if $nmonths == 0;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $naccts++;@\\
\mbox{}\verb@        $npub++ if $ui->{public};@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@    <td><input type="radio" name="useracct" value="$alink" /></td>@\\
\mbox{}\verb@    <td>$n</td>@\\
\mbox{}\verb@    <td>$name[0]</td>@\\
\mbox{}\verb@    <td>$name[1]</td>@\\
\mbox{}\verb@    <td>$name[2]</td>@\\
\mbox{}\verb@    <td>$qem</td>@\\
\mbox{}\verb@    <td>$acr</td>@\\
\mbox{}\verb@    <td>$wu</td>@\\
\mbox{}\verb@    <td>$eu</td>@\\
\mbox{}\verb@    <td>$adm</td>@\\
\mbox{}\verb@    <td>$pub</td>@\\
\mbox{}\verb@    <td>$ronly</td>@\\
\mbox{}\verb@    <td>$name[3]</td>@\\
\mbox{}\verb@    <td>$nmonths</td>@\\
\mbox{}\verb@    <td>$months[0]</td>@\\
\mbox{}\verb@    <td>$months[$#months]</td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb325}{325}\NWlink{nuweb326}{, 326}\NWlink{nuweb327}{, 327}\NWlink{nuweb328}{, 328}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb181}{181}.
\item \NWtxtIdentsUsed\nobreak\  \verb@enumerateMonths@\nobreak\ \NWlink{nuweb140}{140}, \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}, \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{

Generate the controls at the bottom of the account manager
form.  The password field is used to confirm account
deletion or database purge operations.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap457}\raggedright\small
\NWtarget{nuweb328}{} $\langle\,${\itshape Display administrator account manager}\nobreak\ {\footnotesize {328}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $percentPub = int(($npub * 100) / $naccts);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@</table>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="acct_summary">@\\
\mbox{}\verb@$naccts accounts, $npub of which ($percentPub%) grant public access.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@<input type="submit" name="q=do_admin_browseacct" value=" Access " />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="submit" name="q=do_admin_delacct" value=" Delete " />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="submit" name="q=do_admin_purgeacct" value=" Purge Logs " />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@Administrator password:@\\
\mbox{}\verb@    <input type="password" name="HDiet_password" size="20"@\\
\mbox{}\verb@               maxlength="@\hbox{$\langle\,${\itshape Maximum Text Input Field Length}\nobreak\ {\footnotesize \NWlink{nuweb11c}{11c}}$\,\rangle$}\verb@" value="" />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb325}{325}\NWlink{nuweb326}{, 326}\NWlink{nuweb327}{, 327}\NWlink{nuweb328}{, 328}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb181}{181}.
\item \NWtxtIdentsUsed\nobreak\  \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Obtain list of open accounts}

Walk through the {\tt Users} directory and build a hash of all
open accounts.  The key to the hash is the sort code for the
account, and the value is the user directory name.  If the
account category is set to active or inactive, we filter the
list of accounts based on whether the last transaction time is
less than or greater than 30 days from the present, respectively.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap458}\raggedright\small
\NWtarget{nuweb329}{} $\langle\,${\itshape Obtain list of open accounts}\nobreak\ {\footnotesize {329}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my %accounts;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (!defined($acct_category)) {@\\
\mbox{}\verb@        $acct_category = 'active';@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    opendir(CD, "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@") ||@\\
\mbox{}\verb@        die("Cannot open directory @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@");@\\
\mbox{}\verb@    for my $f (grep(!/\.\.?\z/, readdir(CD))) {@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($acct_category ne 'all') {@\\
\mbox{}\verb@            my $lti = time() - last_transaction_time($f);@\\
\mbox{}\verb@            my $month = 30 * 24 * 60 * 60;@\\
\mbox{}\verb@            if ((($acct_category eq 'active') && ($lti > $month)) ||@\\
\mbox{}\verb@                (($acct_category eq 'inactive') && ($lti < $month))) {@\\
\mbox{}\verb@                next;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        open(FU, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$f/UserAccount.hdu") ||@\\
\mbox{}\verb@            die("Cannot open user account directory @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$f/UserAccount.hdu");@\\
\mbox{}\verb@        my $ui = HDiet::user->new();@\\
\mbox{}\verb@        $ui->load(\*FU);@\\
\mbox{}\verb@        close(FU);@\\
\mbox{}\verb@        my $sortcode = $ui->{login_name};@\\
\mbox{}\verb@        $accounts{$sortcode} = $f;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    closedir(CD);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb327}{327}.
\item \NWtxtIdentsUsed\nobreak\  \verb@last_transaction_time@\nobreak\ \NWlink{nuweb399a}{399a}, \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Provide administrator access to user account}

The administrator has requested access to a user account.  After confirming
that this account, indeed, has administrator privileges, we update the session
to assume the identity of the requested user account.  This provides full
read/write access to the account---the administrator can do anything the user
can do.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap459}\raggedright\small
\NWtarget{nuweb330}{} $\langle\,${\itshape Provide administrator access to user account}\nobreak\ {\footnotesize {330}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Verify that user has administrator privilege}\nobreak\ {\footnotesize \NWlink{nuweb331}{331}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (!defined($CGIargs{useracct})) {@\\
\mbox{}\verb@        write_XHTML_prologue($fh, $homeBase, "Invalid Access Request", undef, $session->{handheld});@\\
\mbox{}\verb@        generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Invalid Access Request</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@You entered a request to access a user account, but did not specify which@\\
\mbox{}\verb@account you wished to access.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=acctmgr&amp;s=$session->{session_id}$tzOff">Return to account manager</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@        exit(0);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $user_file_name = quoteUserName($CGIargs{useracct});@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (!(-d "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name")) {@\\
\mbox{}\verb@        write_XHTML_prologue($fh, $homeBase, "Invalid Access Request", undef, $session->{handheld});@\\
\mbox{}\verb@        generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $qun = quoteHTML($CGIargs{useracct});@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Invalid Access Request</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@You requested access to account <b>$qun</b>, but no such account exists.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=acctmgr&amp;s=$session->{session_id}$tzOff">Return to account manager</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@        exit(0);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $session->{effective_name} = $CGIargs{useracct};@\\
\mbox{}\verb@    $session->{browse_name} = '';@\\
\mbox{}\verb@    open(FS, ">:utf8", "@\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$session->{session_id}.hds") ||@\\
\mbox{}\verb@        die("Cannot create session file @\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$session->{session_id}.hds");@\\
\mbox{}\verb@    $session->save(\*FS);@\\
\mbox{}\verb@    close(FS);@\\
\mbox{}\verb@    clusterCopy("@\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$session->{session_id}.hds");@\\
\mbox{}\verb@    $CGIargs{q} = 'account';@\\
\mbox{}\verb@    next;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb181}{181}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}, \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}, \verb@save@\nobreak\ \NWlink{nuweb31}{31}\NWlink{nuweb123}{, 123}\NWlink{nuweb151}{, 151}\NWlink{nuweb156b}{, 156b}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Verify that user has administrator privilege}

The user has requested a transaction which requires administrative
privilege.  If he doesn't have it, bounce the transaction with a
curt reply an send the user scurrying back into the permitted
area.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap460}\raggedright\small
\NWtarget{nuweb331}{} $\langle\,${\itshape Verify that user has administrator privilege}\nobreak\ {\footnotesize {331}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (!$ui->{administrator}) {@\\
\mbox{}\verb@        write_XHTML_prologue($fh, $homeBase, "Administrator Privilege Required", undef, $session->{handheld});@\\
\mbox{}\verb@        generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Administrator Privilege Required</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@This operation requires administrator privilege, which you do not@\\
\mbox{}\verb@have.  This request from IP address $ENV{REMOTE_ADDR} has been@\\
\mbox{}\verb@logged.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=account&amp;s=$session->{session_id}$tzOff">Return to account page</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        append_history($user_file_name, 11, $CGIargs{q});@\\
\mbox{}\verb@        exit(0);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb322}{322}\NWlink{nuweb323}{, 323}\NWlink{nuweb325}{, 325}\NWlink{nuweb330}{, 330}\NWlink{nuweb332}{, 332}\NWlink{nuweb334}{, 334}\NWlink{nuweb336}{, 336}\NWlink{nuweb339}{, 339}\NWlink{nuweb343}{, 343}\NWlink{nuweb346}{, 346}\NWlink{nuweb348}{, 348}\NWlink{nuweb358}{, 358}.
\item \NWtxtIdentsUsed\nobreak\  \verb@append_history@\nobreak\ \NWlink{nuweb397}{397}, \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Process administrator database purge}

The administrator has requested to purge all the logs in a
user's account.  Verify the administrator password and then
delete the logs after backing them up ``just in case''.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap461}\raggedright\small
\NWtarget{nuweb332}{} $\langle\,${\itshape Process administrator database purge}\nobreak\ {\footnotesize {332}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Verify that user has administrator privilege}\nobreak\ {\footnotesize \NWlink{nuweb331}{331}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (!defined($CGIargs{useracct})) {@\\
\mbox{}\verb@        write_XHTML_prologue($fh, $homeBase, "Invalid Access Request", undef, $session->{handheld});@\\
\mbox{}\verb@        generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Invalid Access Request</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@You entered a request to purge a user account's logs, but did not@\\
\mbox{}\verb@specify which account you wished to purge.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=acctmgr&amp;s=$session->{session_id}$tzOff">Return to account manager</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@        exit(0);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Validate administrator password}\nobreak\ {\footnotesize \NWlink{nuweb340}{340}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Delete User Account", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb332}{332}\NWlink{nuweb333}{, 333}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb181}{181}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
Validate that a user directory exists and, if so, back up all of the
{\tt .hdb} files in it and delete them.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap462}\raggedright\small
\NWtarget{nuweb333}{} $\langle\,${\itshape Process administrator database purge}\nobreak\ {\footnotesize {333}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $qun = quoteHTML($CGIargs{useracct});@\\
\mbox{}\verb@    my $aufn = $user_file_name;     # Save administrator's user file name@\\
\mbox{}\verb@    $user_file_name = quoteUserName($CGIargs{useracct});@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (!(-d "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name")) {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h3>There is no user account named <b>$qun</b>.</h3>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=acctmgr&amp;s=$session->{session_id}$tzOff">Return to account manager</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    } elsif (is_user_session_open($CGIargs{useracct})) {@\\
\mbox{}\verb@       print $fh <<"EOD";@\\
\mbox{}\verb@<h3>User <b>$qun</b> has an active session.  You must terminate@\\
\mbox{}\verb@it before the database can be purged.</h3>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=sessmgr&amp;s=$session->{session_id}$tzOff">Go to session manager</a></h4>@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=acctmgr&amp;s=$session->{session_id}$tzOff">Return to account manager</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        open(FU, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/UserAccount.hdu") ||@\\
\mbox{}\verb@            die("Administrator purge logs: cannot open user account file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/UserAccount.hdu");@\\
\mbox{}\verb@        my $di = HDiet::user->new();@\\
\mbox{}\verb@        $di->load(\*FU);@\\
\mbox{}\verb@        close(FU);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my @{\tt @}\verb@months = $di->enumerateMonths();@\\
\mbox{}\verb@        my $nmonths = $#months + 1;@\\
\mbox{}\verb@        my $mont = 'month' . (($nmonths != 1) ? 's' : '');@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Backup user account before destructive operation}\nobreak\ {\footnotesize \NWlink{nuweb379a}{379a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        for my $m (@{\tt @}\verb@months) {@\\
\mbox{}\verb@            unlink("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$m.hdb") ||@\\
\mbox{}\verb@               die("Cannot delete log file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$m.hdb");@\\
\mbox{}\verb@            clusterDelete("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$m.hdb");@\\
\mbox{}\verb@#print($fh "<pre>unlink @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$m.hdb</pre>\n");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        append_history($user_file_name, 14, $nmonths);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Logs Purged</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@Purged all $nmonths $mont of logs from user account <b>$qun</b>.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=acctmgr&amp;s=$session->{session_id}$tzOff">Return to account manager</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb332}{332}\NWlink{nuweb333}{, 333}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb181}{181}.
\item \NWtxtIdentsUsed\nobreak\  \verb@append_history@\nobreak\ \NWlink{nuweb397}{397}, \verb@enumerateMonths@\nobreak\ \NWlink{nuweb140}{140}, \verb@is_user_session_open@\nobreak\ \NWlink{nuweb400}{400}, \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}, \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}, \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Process administrator account delete}

The administrator has requested to delete a user account.  Verify that
there are logs in the database (if there are, the administrator must
first perform a ``Purge Logs'' operation to delete tiem), and if the
administrator password entered to confirm the operation is correct,
delete the account.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap463}\raggedright\small
\NWtarget{nuweb334}{} $\langle\,${\itshape Process administrator account delete}\nobreak\ {\footnotesize {334}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Verify that user has administrator privilege}\nobreak\ {\footnotesize \NWlink{nuweb331}{331}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (!defined($CGIargs{useracct})) {@\\
\mbox{}\verb@        write_XHTML_prologue($fh, $homeBase, "Invalid Access Request", undef, $session->{handheld});@\\
\mbox{}\verb@        generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Invalid Access Request</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@You entered a request to delete a user account, but did not specify which@\\
\mbox{}\verb@account you wished to delete.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=acctmgr&amp;s=$session->{session_id}$tzOff">Return to account manager</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@        exit(0);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Validate administrator password}\nobreak\ {\footnotesize \NWlink{nuweb340}{340}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Delete User Account", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb334}{334}\NWlink{nuweb335}{, 335}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb181}{181}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
Validate that the user directory exists and that no session for
this user is open, and that there are no monthly logs in the
database for this user.  If all these conditions obtain, we
make a backup of the user directory, then delete it and
all of its contents.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap464}\raggedright\small
\NWtarget{nuweb335}{} $\langle\,${\itshape Process administrator account delete}\nobreak\ {\footnotesize {335}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $qun = quoteHTML($CGIargs{useracct});@\\
\mbox{}\verb@    my $aufn = $user_file_name;     # Save administrator's user file name@\\
\mbox{}\verb@    $user_file_name = quoteUserName($CGIargs{useracct});@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (!(-d "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name")) {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h3>There is no user account named <b>$qun</b>.</h3>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    } elsif (is_user_session_open($CGIargs{useracct})) {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h3>User <b>$qun</b> has an active session.  You must terminate@\\
\mbox{}\verb@it before the account can be deleted.</h3>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=sessmgr&amp;s=$session->{session_id}$tzOff">Go to session manager</a></h4>@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=acctmgr&amp;s=$session->{session_id}$tzOff">Return to account manager</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        open(FU, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/UserAccount.hdu") ||@\\
\mbox{}\verb@            die("Administrator delete account: cannot open user account file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/UserAccount.hdu");@\\
\mbox{}\verb@        my $di = HDiet::user->new();@\\
\mbox{}\verb@        $di->load(\*FU);@\\
\mbox{}\verb@        close(FU);@\\
\mbox{}\verb@        my @{\tt @}\verb@months = $di->enumerateMonths();@\\
\mbox{}\verb@        my $nmonths = $#months + 1;@\\
\mbox{}\verb@        my $mont = 'month' . (($nmonths != 1) ? 's' : '');@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($nmonths > 0) {@\\
\mbox{}\verb@            print $fh <<"EOD";@\\
\mbox{}\verb@<h3>User <b>$qun</b> has $nmonths $mont of logs in the database.@\\
\mbox{}\verb@Before you can delete this account, you must first purge the logs from@\\
\mbox{}\verb@the database.  Return here after the logs have been purged.</h3>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=acctmgr&amp;s=$session->{session_id}$tzOff">Return to account manager</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Backup user account before destructive operation}\nobreak\ {\footnotesize \NWlink{nuweb379a}{379a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@            do_command("rm -rf @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name");@\\
\mbox{}\verb@            clusterRecursiveDelete("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name");@\\
\mbox{}\verb@@\\
\mbox{}\verb@            print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Account Deleted</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@User account <b>$qun</b> has been deleted.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=acctmgr&amp;s=$session->{session_id}$tzOff">Return to account manager</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb334}{334}\NWlink{nuweb335}{, 335}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb181}{181}.
\item \NWtxtIdentsUsed\nobreak\  \verb@do_command@\nobreak\ \NWlink{nuweb406a}{406a}, \verb@enumerateMonths@\nobreak\ \NWlink{nuweb140}{140}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@is_user_session_open@\nobreak\ \NWlink{nuweb400}{400}, \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}, \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}, \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Display administrator session manager}

Display the session manager page, which summaries open
sessions and allows the administrator to perform various
functions upon them.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap465}\raggedright\small
\NWtarget{nuweb336}{} $\langle\,${\itshape Display administrator session manager}\nobreak\ {\footnotesize {336}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Verify that user has administrator privilege}\nobreak\ {\footnotesize \NWlink{nuweb331}{331}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Session Manager", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Obtain list of open sessions}\nobreak\ {\footnotesize \NWlink{nuweb337}{337}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Session Manager</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<form id="Hdiet_sessmgr" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@<table border="border" class="mlog">@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@    <th>Sel</th>@\\
\mbox{}\verb@    <th>User</th>@\\
\mbox{}\verb@    <th>Session Start</th>@\\
\mbox{}\verb@    <th>Administering</th>@\\
\mbox{}\verb@    <th>Browsing</th>@\\
\mbox{}\verb@    <th>R/O</th>@\\
\mbox{}\verb@    <th>Handheld</th>@\\
\mbox{}\verb@    <th>Cookie</th>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate table of open sessions}\nobreak\ {\footnotesize \NWlink{nuweb338}{338}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@</table>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@<input type="submit" name="q=do_admin_forceclose" value=" Terminate " />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@Administrator password:@\\
\mbox{}\verb@    <input type="password" name="HDiet_password" size="20"@\\
\mbox{}\verb@               maxlength="@\hbox{$\langle\,${\itshape Maximum Text Input Field Length}\nobreak\ {\footnotesize \NWlink{nuweb11c}{11c}}$\,\rangle$}\verb@" value="" />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb181}{181}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Obtain list of open sessions}

Walk through the {\tt Sessions} directory and build a hash of all
open sessions.  The key to the hash is the user name,
and the value is the session ID.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap466}\raggedright\small
\NWtarget{nuweb337}{} $\langle\,${\itshape Obtain list of open sessions}\nobreak\ {\footnotesize {337}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my %sessions;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    opendir(CD, "@\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@") ||@\\
\mbox{}\verb@        die("Cannot open directory @\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@");@\\
\mbox{}\verb@    for my $f (grep(/\w+\.hds/, readdir(CD))) {@\\
\mbox{}\verb@        open(FU, "<:utf8", "@\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$f") ||@\\
\mbox{}\verb@            die("Cannot open session @\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$f");@\\
\mbox{}\verb@        my $session = HDiet::session->new();@\\
\mbox{}\verb@        $session->load(\*FU);@\\
\mbox{}\verb@        close(FU);@\\
\mbox{}\verb@        $sessions{$session->{login_name}} = $session->{session_id};@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    closedir(CD);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb336}{336}\NWlink{nuweb339}{, 339}.
\item \NWtxtIdentsUsed\nobreak\  \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Generate table of open sessions}

Generate a table of active sessions, sorted by the user name
(case-insensitive).  Each item contains a radio button which can
be used to select the session for termination.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap467}\raggedright\small
\NWtarget{nuweb338}{} $\langle\,${\itshape Generate table of open sessions}\nobreak\ {\footnotesize {338}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    for my $f (sort({ lc($a) cmp lc($b)} keys(%sessions))) {@\\
\mbox{}\verb@        open(FU, "<:utf8", "@\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$sessions{$f}.hds") ||@\\
\mbox{}\verb@            die("Cannot open session @\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$sessions{$f}.hds");@\\
\mbox{}\verb@        my $session = HDiet::session->new();@\\
\mbox{}\verb@        $session->load(\*FU);@\\
\mbox{}\verb@        close(FU);@\\
\mbox{}\verb@        my $qun = quoteHTML($f);@\\
\mbox{}\verb@        my $alink = quoteHTML($sessions{$f});@\\
\mbox{}\verb@        my @{\tt @}\verb@sopen = gmtime($session->{login_time});@\\
\mbox{}\verb@        my $acr = sprintf("%04d-%02d-%02d %02d:%02d", $sopen[5] + 1900, $sopen[4] + 1, $sopen[3], $sopen[2], $sopen[1]);@\\
\mbox{}\verb@        my $qef = quoteHTML($session->{effective_name});@\\
\mbox{}\verb@        my $qbr = quoteHTML($session->{browse_name});@\\
\mbox{}\verb@        my $rocheck = $session->{read_only} ? '&#10004;' : '';@\\
\mbox{}\verb@        my $hhcheck = $session->{handheld} ? '&#10004;' : '';@\\
\mbox{}\verb@        my $cookiecheck = $session->{cookie} ? '&#10004;' : '';@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@    <td><input type="radio" name="sessionid" value="$alink" /></td>@\\
\mbox{}\verb@    <td>$qun</td>@\\
\mbox{}\verb@    <td>$acr</td>@\\
\mbox{}\verb@    <td>$qef</td>@\\
\mbox{}\verb@    <td>$qbr</td>@\\
\mbox{}\verb@    <td class="centred">$rocheck</td>@\\
\mbox{}\verb@    <td class="centred">$hhcheck</td>@\\
\mbox{}\verb@    <td class="centred">$cookiecheck</td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb336}{336}.
\item \NWtxtIdentsUsed\nobreak\  \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}, \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Force termination of user session}

Force termination of an open user session.  The administrator password must
have been specified in the request form in order to perform the
termination.  As with all administrative requests, we ``trust no one'' and
re-verify all aspects of the request.  If for some screwball reason there is
an open session file in the {\tt Sessions} for a user, but the user's
{\tt ActiveSession.hda} points back to a different session, the act of
closing the session will clean this up---both the bogus session and the
one the account points back to will be deleted.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap468}\raggedright\small
\NWtarget{nuweb339}{} $\langle\,${\itshape Force termination of user session}\nobreak\ {\footnotesize {339}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Verify that user has administrator privilege}\nobreak\ {\footnotesize \NWlink{nuweb331}{331}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Confirm a session is selected}\nobreak\ {\footnotesize \NWlink{nuweb341}{341}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Validate specified session}\nobreak\ {\footnotesize \NWlink{nuweb342}{342}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Obtain list of open sessions}\nobreak\ {\footnotesize \NWlink{nuweb337}{337}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $user = '';@\\
\mbox{}\verb@    for my $f (sort(keys(%sessions))) {@\\
\mbox{}\verb@        if ($sessions{$f} eq $CGIargs{sessionid}) {@\\
\mbox{}\verb@            $user = $f;@\\
\mbox{}\verb@            last;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Validate administrator password}\nobreak\ {\footnotesize \NWlink{nuweb340}{340}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $qun = quoteHTML($user);@\\
\mbox{}\verb@    my $aufn = $user_file_name;     # Save administrator's user file name@\\
\mbox{}\verb@    $user_file_name = quoteUserName($user);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Close previous session if still open}\nobreak\ {\footnotesize \NWlink{nuweb186c}{186c}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   On the off possibility that there is a discrepancy between the@\\
\mbox{}\verb@    #   session pointer in the Sessions directory and the back pointer@\\
\mbox{}\verb@    #   in the Users directory, if the session close above did not@\\
\mbox{}\verb@    #   delete the open session file, manually delete it now.@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (-f "@\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$CGIargs{sessionid}.hds") {@\\
\mbox{}\verb@        unlink("@\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$CGIargs{sessionid}.hds");@\\
\mbox{}\verb@        clusterDelete("@\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$CGIargs{sessionid}.hds");@\\
\mbox{}\verb@print(STDERR "Deleting bogus open session $CGIargs{sessionid} for user $user_file_name\n");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    append_history($aufn, 13, $user_file_name);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $CGIargs{q} = 'sessmgr';@\\
\mbox{}\verb@    undef($CGIargs{sessionid});@\\
\mbox{}\verb@    undef($CGIargs{password});@\\
\mbox{}\verb@    next;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb181}{181}.
\item \NWtxtIdentsUsed\nobreak\  \verb@append_history@\nobreak\ \NWlink{nuweb397}{397}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}, \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Validate administrator password}

Potentially destructive administrative operations must be confirmed
by manually entering the administrator's password on the request
form.  Validate the password entered agrees with that of the
account under which the administrator is logged in and, if
it doesn't,  reject the request and log it in the administrator's
history file.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap469}\raggedright\small
\NWtarget{nuweb340}{} $\langle\,${\itshape Validate administrator password}\nobreak\ {\footnotesize {340}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($CGIargs{HDiet_password} ne $ui->{password}) {@\\
\mbox{}\verb@        write_XHTML_prologue($fh, $homeBase, "Administrator Password Required", undef, $session->{handheld});@\\
\mbox{}\verb@        generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Administrator Password Required</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@This operation requires confirmation by entering your password.  You@\\
\mbox{}\verb@either failed to enter a password, or the password you entered is@\\
\mbox{}\verb@incorrect.  This request from IP address $ENV{REMOTE_ADDR} has been@\\
\mbox{}\verb@logged.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=account&amp;s=$session->{session_id}$tzOff">Return to account page</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        append_history($user_file_name, 11, $CGIargs{q});@\\
\mbox{}\verb@        exit(0);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb332}{332}\NWlink{nuweb334}{, 334}\NWlink{nuweb339}{, 339}\NWlink{nuweb346}{, 346}.
\item \NWtxtIdentsUsed\nobreak\  \verb@append_history@\nobreak\ \NWlink{nuweb397}{397}, \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Confirm a session is selected}

Make sure the administrator actually selected a session.  If not,
reject the request.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap470}\raggedright\small
\NWtarget{nuweb341}{} $\langle\,${\itshape Confirm a session is selected}\nobreak\ {\footnotesize {341}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (!defined($CGIargs{sessionid})) {@\\
\mbox{}\verb@        write_XHTML_prologue($fh, $homeBase, "No Session Selected", undef, $session->{handheld});@\\
\mbox{}\verb@        generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">No Session Selected</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@You requested to terminate a selection, but failed to specify which@\\
\mbox{}\verb@session you wish to terminate.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=account&amp;s=$session->{session_id}$tzOff">Return to account page</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@        exit(0);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb339}{339}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Validate specified session}

Validate the syntax of the session name specified and confirm that a
session by that name exists in the session directory.  Syntax checking
is essential to prevent malicious traversal of parent directories.
We do not give the attacker the satisfaction of knowing we spotted
the attempt, but simply report it as an invalid session ID.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap471}\raggedright\small
\NWtarget{nuweb342}{} $\langle\,${\itshape Validate specified session}\nobreak\ {\footnotesize {342}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (($CGIargs{sessionid} !~ m/^[0-9FGJKQW]{40}$/) ||@\\
\mbox{}\verb@        (!-f "@\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$CGIargs{sessionid}.hds")) {@\\
\mbox{}\verb@        write_XHTML_prologue($fh, $homeBase, "No Such Session", undef, $session->{handheld});@\\
\mbox{}\verb@        generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">No Such Session</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@You requested to terminate session ID <tt>$CGIargs{sessionid}</tt>, but@\\
\mbox{}\verb@no such session is open.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=account&amp;s=$session->{session_id}$tzOff">Return to account page</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@        exit(0);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb339}{339}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Display administrator persistent login manager}

Display the persistent manager page, which summaries persistent
login cookies and allows the administrator to perform various
functions upon them.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap472}\raggedright\small
\NWtarget{nuweb343}{} $\langle\,${\itshape Display administrator persistent login manager}\nobreak\ {\footnotesize {343}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Verify that user has administrator privilege}\nobreak\ {\footnotesize \NWlink{nuweb331}{331}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Persistent Login Manager", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Obtain list of persistent login tokens}\nobreak\ {\footnotesize \NWlink{nuweb344}{344}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Persistent Login Manager</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<form id="Hdiet_cookiemgr" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@<table border="border" class="mlog">@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@    <th>Sel</th>@\\
\mbox{}\verb@    <th>User</th>@\\
\mbox{}\verb@    <th>Token</th>@\\
\mbox{}\verb@    <th>Created</th>@\\
\mbox{}\verb@    <th>Expiration</th>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate table of persistent logins}\nobreak\ {\footnotesize \NWlink{nuweb345}{345}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@</table>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@<input type="submit" name="q=do_admin_delcookie" value=" Delete " />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="submit" name="q=cookiemgr" value=" Update " />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@Administrator password:@\\
\mbox{}\verb@    <input type="password" name="HDiet_password" size="20"@\\
\mbox{}\verb@               maxlength="@\hbox{$\langle\,${\itshape Maximum Text Input Field Length}\nobreak\ {\footnotesize \NWlink{nuweb11c}{11c}}$\,\rangle$}\verb@" value="" />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb181}{181}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Obtain list of persistent login tokens}

Walk through the {\tt RememberMe} directory and build a hash of all
persistent login tokens.  The key to the hash is the token ID,
and the value is the token object.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap473}\raggedright\small
\NWtarget{nuweb344}{} $\langle\,${\itshape Obtain list of persistent login tokens}\nobreak\ {\footnotesize {344}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my %cookies;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    opendir(CD, "@\hbox{$\langle\,${\itshape Remember Me Directory}\nobreak\ {\footnotesize \NWlink{nuweb13d}{13d}}$\,\rangle$}\verb@") ||@\\
\mbox{}\verb@        die("Cannot open directory @\hbox{$\langle\,${\itshape Remember Me Directory}\nobreak\ {\footnotesize \NWlink{nuweb13d}{13d}}$\,\rangle$}\verb@");@\\
\mbox{}\verb@    for my $f (grep(/\w+\.hdr/, readdir(CD))) {@\\
\mbox{}\verb@        open(FU, "<:utf8", "@\hbox{$\langle\,${\itshape Remember Me Directory}\nobreak\ {\footnotesize \NWlink{nuweb13d}{13d}}$\,\rangle$}\verb@/$f") ||@\\
\mbox{}\verb@#        open(FU, "<", "@\hbox{$\langle\,${\itshape Remember Me Directory}\nobreak\ {\footnotesize \NWlink{nuweb13d}{13d}}$\,\rangle$}\verb@/$f") ||                #### Poison cookie search@\\
\mbox{}\verb@            die("Cannot open persistent login @\hbox{$\langle\,${\itshape Remember Me Directory}\nobreak\ {\footnotesize \NWlink{nuweb13d}{13d}}$\,\rangle$}\verb@/$f");@\\
\mbox{}\verb@        my $cookie = HDiet::cookie->new();@\\
\mbox{}\verb@        $cookie->load(\*FU);@\\
\mbox{}\verb@#if ($cookie->{login_name} =~ m/^[ -~]*$/) { next; }                     #### Poison cookie search@\\
\mbox{}\verb@        close(FU);@\\
\mbox{}\verb@        $cookies{$cookie->{cookie_id}} = $cookie;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    closedir(CD);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb316}{316}\NWlink{nuweb343}{, 343}\NWlink{nuweb346}{, 346}.
\item \NWtxtIdentsUsed\nobreak\  \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}, \verb@login@\nobreak\ \NWlink{nuweb121}{121}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Generate table of persistent logins}

A table row is generated for each existing persistent logins, sorted
by the user name to whom the login belongs, case-insensitive.  Each
item contains a radio button which can be used to select it for
deletion.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap474}\raggedright\small
\NWtarget{nuweb345}{} $\langle\,${\itshape Generate table of persistent logins}\nobreak\ {\footnotesize {345}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    for my $f (sort({ lc($cookies{$a}->{login_name}) cmp lc($cookies{$b}->{login_name})} keys(%cookies))) {@\\
\mbox{}\verb@        my $cook = $cookies{$f};@\\
\mbox{}\verb@        my $qtok = quoteHTML($f);@\\
\mbox{}\verb@        my $qun = quoteHTML($cook->{login_name});@\\
\mbox{}\verb@        my @{\tt @}\verb@sopen = gmtime($cook->{login_time});@\\
\mbox{}\verb@        my $acr = sprintf("%04d-%02d-%02d %02d:%02d", $sopen[5] + 1900, $sopen[4] + 1, $sopen[3], $sopen[2], $sopen[1]);@\\
\mbox{}\verb@        @{\tt @}\verb@sopen = gmtime($cook->{expiry_time});@\\
\mbox{}\verb@        my $aex = sprintf("%04d-%02d-%02d %02d:%02d", $sopen[5] + 1900, $sopen[4] + 1, $sopen[3], $sopen[2], $sopen[1]);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@    <td><input type="radio" name="cookieid" value="$qtok" /></td>@\\
\mbox{}\verb@    <td>$qun</td>@\\
\mbox{}\verb@    <td class="monospace">$qtok</td>@\\
\mbox{}\verb@    <td>$acr</td>@\\
\mbox{}\verb@    <td>$aex</td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb343}{343}.
\item \NWtxtIdentsUsed\nobreak\  \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Delete a persistent login token}

Delete a persistent login token.  The administrator password must
have been specified in the request form in order to perform the
termination.  As with all administrative requests, we ``trust no one'' and
re-verify all aspects of the request.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap475}\raggedright\small
\NWtarget{nuweb346}{} $\langle\,${\itshape Delete a persistent login token}\nobreak\ {\footnotesize {346}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Verify that user has administrator privilege}\nobreak\ {\footnotesize \NWlink{nuweb331}{331}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Confirm a persistent login is selected}\nobreak\ {\footnotesize \NWlink{nuweb347}{347}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Obtain list of persistent login tokens}\nobreak\ {\footnotesize \NWlink{nuweb344}{344}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (defined($cookies{$CGIargs{cookieid}})) {@\\
\mbox{}\verb@        my $cook = $cookies{$CGIargs{cookieid}};@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Validate administrator password}\nobreak\ {\footnotesize \NWlink{nuweb340}{340}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $qun = quoteUserName($cook->{login_name});@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (-f "@\hbox{$\langle\,${\itshape Remember Me Directory}\nobreak\ {\footnotesize \NWlink{nuweb13d}{13d}}$\,\rangle$}\verb@/$CGIargs{cookieid}.hdr") {@\\
\mbox{}\verb@            unlink("@\hbox{$\langle\,${\itshape Remember Me Directory}\nobreak\ {\footnotesize \NWlink{nuweb13d}{13d}}$\,\rangle$}\verb@/$CGIargs{cookieid}.hdr");@\\
\mbox{}\verb@            clusterDelete("@\hbox{$\langle\,${\itshape Remember Me Directory}\nobreak\ {\footnotesize \NWlink{nuweb13d}{13d}}$\,\rangle$}\verb@/$CGIargs{cookieid}.hdr");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        append_history($user_file_name, 17, "$qun,$cook->{cookie_id}");@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@print(STDERR "Bogus delete cookie request for $CGIargs{cookieid}\n");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $CGIargs{q} = 'cookiemgr';@\\
\mbox{}\verb@    undef($CGIargs{cookieid});@\\
\mbox{}\verb@    undef($CGIargs{password});@\\
\mbox{}\verb@    next;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb181}{181}.
\item \NWtxtIdentsUsed\nobreak\  \verb@append_history@\nobreak\ \NWlink{nuweb397}{397}, \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Confirm a persistent login is selected}

Make sure the administrator actually selected a persistent login
token.  If not, reject the request.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap476}\raggedright\small
\NWtarget{nuweb347}{} $\langle\,${\itshape Confirm a persistent login is selected}\nobreak\ {\footnotesize {347}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (!defined($CGIargs{cookieid})) {@\\
\mbox{}\verb@        write_XHTML_prologue($fh, $homeBase, "No Persistent Login Selected", undef, $session->{handheld});@\\
\mbox{}\verb@        generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">No Persistent Login Selected</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@You requested to delete a persistent login, but failed to specify which@\\
\mbox{}\verb@login you wish to terminate.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=account&amp;s=$session->{session_id}$tzOff">Return to account page</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@        exit(0);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb346}{346}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@login@\nobreak\ \NWlink{nuweb121}{121}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Display administrator global statistics}

Display the global statistics.  This invokes the aggregator to retrieve
recent information across all accounts and generates a report of activity,
including a histogram of how current user log entries are, aggregate trend
values for active account and active public accounts, and the fastest weight
gain and loss for all and public accounts.  This is an administrator-only page,
and hence is free to disclose information for non-public accounts.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap477}\raggedright\small
\NWtarget{nuweb348}{} $\langle\,${\itshape Display administrator global statistics}\nobreak\ {\footnotesize {348}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Verify that user has administrator privilege}\nobreak\ {\footnotesize \NWlink{nuweb331}{331}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Global Statistics", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Global Statistics</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<form id="Hdiet_globalstats" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $hndays = 30;            # Number of days to analyse@\\
\mbox{}\verb@    my $mincov = 80;            # Minimum coverage in percent to rank gain/loss@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Request log records from the aggregator and compute global statistics}\nobreak\ {\footnotesize \NWlink{nuweb349}{349}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate global statistics for open accounts}\nobreak\ {\footnotesize \NWlink{nuweb350}{350}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Display global statistics mean trend change}\nobreak\ {\footnotesize \NWlink{nuweb351}{351}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Compute global statistics gain and loss extrema}\nobreak\ {\footnotesize \NWlink{nuweb352}{352}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Display global statistics gain and loss extrema}\nobreak\ {\footnotesize \NWlink{nuweb353}{353}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Display global statistics log update frequency}\nobreak\ {\footnotesize \NWlink{nuweb354}{354}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Receive log records from the aggregator for global statistics}\nobreak\ {\footnotesize \NWlink{nuweb355}{355}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb181}{181}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Request log records from the aggregator and compute global statistics}

Most of the actual computation of statistics is actually done in the
\verb+receive_aggregated_statistics_records+ subroutine below
(page~\pageref{Receive log records from the aggregator for global statistics}), which
is called by the aggregator for each log item returned.  Here we define
the variables which will be used in computing the statistics and start
the aggregator running.  Note that we call \verb+receive_aggregated_statistics_records+
with a dummy user account at the end to flush out the last user's
statistics.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap478}\raggedright\small
\NWtarget{nuweb349}{} $\langle\,${\itshape Request log records from the aggregator and compute global statistics}\nobreak\ {\footnotesize {349}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my (@{\tt @}\verb@acchist, @{\tt @}\verb@pacchist);@\\
\mbox{}\verb@    my ($acctotal, $pacctotal, $badgetotal) = (0, 0, 0);@\\
\mbox{}\verb@    my (@{\tt @}\verb@ttrend, @{\tt @}\verb@pttrend);@\\
\mbox{}\verb@    my (@{\tt @}\verb@ntrend, @{\tt @}\verb@nptrend);@\\
\mbox{}\verb@    my ($minslope, $maxslope) = (1E100, -1E100);@\\
\mbox{}\verb@    my ($pminslope, $pmaxslope) = (1E100, -1E100);@\\
\mbox{}\verb@    my ($minslopeuser, $maxslopeuser, $pminslopeuser, $pmaxslopeuser);@\\
\mbox{}\verb@    my ($minslopecov, $maxslopecov, $pminslopecov, $pmaxslopecov);@\\
\mbox{}\verb@    my $jdnow = unix_time_to_jd(time());@\\
\mbox{}\verb@    my ($enowy, $enowm, $enowd) = jd_to_gregorian($jdnow);@\\
\mbox{}\verb@    $jdnow = gregorian_to_jd($enowy, $enowm, $enowd);@\\
\mbox{}\verb@    my $jdthen = $jdnow - ($hndays + 1);@\\
\mbox{}\verb@    my ($lastuser, $lastpubname) = ('', '');@\\
\mbox{}\verb@    my $lastacc = -1;@\\
\mbox{}\verb@    my $totuser = 0;@\\
\mbox{}\verb@    my $agg = HDiet::Aggregator->new(\&receive_aggregated_statistics_records, $ui->{display_unit});@\\
\mbox{}\verb@    my ($naccts, $npaccts) = $agg->retrieve($jdthen, $jdnow, 0);@\\
\mbox{}\verb@    my %lu = ( "login_name", $lastuser . "xxx" );@\\
\mbox{}\verb@    receive_aggregated_statistics_records(\%lu, $jdnow, undef);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb348}{348}.
\item \NWtxtIdentsUsed\nobreak\  \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}, \verb@jd_to_gregorian@\nobreak\ \NWlink{nuweb448}{448}, \verb@retrieve@\nobreak\ \NWlink{nuweb116}{116}, \verb@unix_time_to_jd@\nobreak\ \NWlink{nuweb450b}{450b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Generate global statistics for open accounts}

The open account statistics are presented in a table which
shows the number of active and inactive accounts for all
accounts and just public accounts.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap479}\raggedright\small
\NWtarget{nuweb350}{} $\langle\,${\itshape Generate global statistics for open accounts}\nobreak\ {\footnotesize {350}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my ($cumaccts, $pcumaccts) = (0, 0);@\\
\mbox{}\verb@    for (my $i = 0; $i <= $hndays; $i++) {@\\
\mbox{}\verb@        $acchist[$i] = 0 if !defined($acchist[$i]);@\\
\mbox{}\verb@        $pacchist[$i] = 0 if !defined($pacchist[$i]);@\\
\mbox{}\verb@        $cumaccts += $acchist[$i];@\\
\mbox{}\verb@        $pcumaccts += $pacchist[$i];@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    my ($inacccts, $pinaccts) = ($naccts - $cumaccts, $npaccts - $pcumaccts);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h2>Open Accounts</h2>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<table class="global_stats">@\\
\mbox{}\verb@    <tr>@\\
\mbox{}\verb@        <th class="v"></th>@\\
\mbox{}\verb@        <th>All</th>@\\
\mbox{}\verb@        <th>Public</th>@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <tr>@\\
\mbox{}\verb@        <th class="l">Active</th>@\\
\mbox{}\verb@        <td>$cumaccts</td>@\\
\mbox{}\verb@        <td>$pcumaccts</td>@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <tr>@\\
\mbox{}\verb@        <th class="l">Inactive</th>@\\
\mbox{}\verb@        <td>$inacccts</td>@\\
\mbox{}\verb@        <td>$pinaccts</td>@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <tr>@\\
\mbox{}\verb@        <th class="l">Total</th>@\\
\mbox{}\verb@        <td>$naccts</td>@\\
\mbox{}\verb@        <td>$npaccts</td>@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@</table>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p>@\\
\mbox{}\verb@&ldquo;Active&rdquo; accounts are those with a weight log@\\
\mbox{}\verb@entry in the last $hndays days.  A total of $badgetotal accounts@\\
\mbox{}\verb@have badge generation enabled.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb348}{348}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Display global statistics mean trend change}

Using the trend values from all accounts with complete logs
which span the reporting period, we synthesise an overall mean
trend for all users and public users only.  This provides a
sense of how the user community as a whole is progressing.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap480}\raggedright\small
\NWtarget{nuweb351}{} $\langle\,${\itshape Display global statistics mean trend change}\nobreak\ {\footnotesize {351}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $balunits = HDiet::monthlog::ENERGY_ABBREVIATIONS->[$ui->{energy_unit}] . "/day";@\\
\mbox{}\verb@    my $wunits = HDiet::monthlog::DELTA_WEIGHT_ABBREVIATIONS->[$ui->{display_unit}] . "/week";@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $fitter = HDiet::trendfit->new();@\\
\mbox{}\verb@    my $pfitter = HDiet::trendfit->new();@\\
\mbox{}\verb@    for (my $i = 1; $i <= $hndays; $i++) {@\\
\mbox{}\verb@        $fitter->addPoint($ttrend[$i] / $ntrend[$i]);@\\
\mbox{}\verb@        $pfitter->addPoint($pttrend[$i] / $nptrend[$i]);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    my $ttslope = $fitter->fitSlope();@\\
\mbox{}\verb@    my $pttslope = $pfitter->fitSlope();@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $meanslopeweek = gs_snum(sprintf("%.2f", $ttslope * 7));@\\
\mbox{}\verb@    my $meanslopebal = gs_snum(sprintf("%.0f ", $ttslope *@\\
\mbox{}\verb@                (HDiet::monthlog::CALORIES_PER_WEIGHT_UNIT->[$ui->{display_unit}] /@\\
\mbox{}\verb@                 HDiet::monthlog::CALORIES_PER_ENERGY_UNIT->[$ui->{energy_unit}])));@\\
\mbox{}\verb@    my $pmeanslopeweek = gs_snum(sprintf("%.2f", $pttslope * 7));@\\
\mbox{}\verb@    my $pmeanslopebal = gs_snum(sprintf("%.0f ", $pttslope *@\\
\mbox{}\verb@                (HDiet::monthlog::CALORIES_PER_WEIGHT_UNIT->[$ui->{display_unit}] /@\\
\mbox{}\verb@                 HDiet::monthlog::CALORIES_PER_ENERGY_UNIT->[$ui->{energy_unit}])));@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h2>Mean Gain/Loss</h2>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<table class="global_stats">@\\
\mbox{}\verb@    <tr>@\\
\mbox{}\verb@        <th colspan="2" class="blr">All Accounts</th>@\\
\mbox{}\verb@        <th colspan="2" class="blr">Public Accounts</th>@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <tr>@\\
\mbox{}\verb@        <th>$balunits</th>@\\
\mbox{}\verb@        <th>$wunits</th>@\\
\mbox{}\verb@        <th class="bl">$balunits</th>@\\
\mbox{}\verb@        <th>$wunits</th>@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <tr>@\\
\mbox{}\verb@        <td>$meanslopebal</td>@\\
\mbox{}\verb@        <td>$meanslopeweek</td>@\\
\mbox{}\verb@        <td>$pmeanslopebal</td>@\\
\mbox{}\verb@        <td>$pmeanslopeweek</td>@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@</table>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p>@\\
\mbox{}\verb@Only accounts with weight entries in each month in the last@\\
\mbox{}\verb@$hndays days are included.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb348}{348}.
\item \NWtxtIdentsUsed\nobreak\  \verb@addPoint@\nobreak\ \NWlink{nuweb20a}{20a}, \verb@CALORIES_PER_ENERGY_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@CALORIES_PER_WEIGHT_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@fitSlope@\nobreak\ \NWlink{nuweb20b}{20b}\NWlink{nuweb488a}{, 488a}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Compute global statistics gain and loss extrema}

While receiving log items from the aggregator, the trend for
each user with complete logs for the interval is computed
and the minimum and maxinum for all accounts and public
accounts is saved.  We now edit the fit trend slope to the
weekly gain/loss and energy balance to be displayed in the
gain and loss extrema table.  These values are displayed
in the administrator's chosen display weight and energy
units.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap481}\raggedright\small
\NWtarget{nuweb352}{} $\langle\,${\itshape Compute global statistics gain and loss extrema}\nobreak\ {\footnotesize {352}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $minslopeweek = gs_snum(sprintf("%.2f", $minslope * 7));@\\
\mbox{}\verb@    my $minslopebal = gs_snum(sprintf("%.0f ", $minslope *@\\
\mbox{}\verb@                (HDiet::monthlog::CALORIES_PER_WEIGHT_UNIT->[$ui->{display_unit}] /@\\
\mbox{}\verb@                 HDiet::monthlog::CALORIES_PER_ENERGY_UNIT->[$ui->{energy_unit}])));@\\
\mbox{}\verb@    my $qminslopeuser = quoteHTML($minslopeuser);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $pminslopeweek = gs_snum(sprintf("%.2f", $pminslope * 7));@\\
\mbox{}\verb@    my $pminslopebal = gs_snum(sprintf("%.0f ", $pminslope *@\\
\mbox{}\verb@                (HDiet::monthlog::CALORIES_PER_WEIGHT_UNIT->[$ui->{display_unit}] /@\\
\mbox{}\verb@                 HDiet::monthlog::CALORIES_PER_ENERGY_UNIT->[$ui->{energy_unit}])));@\\
\mbox{}\verb@    my $qpminslopeuser = quoteHTML($pminslopeuser);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $maxslopeweek = gs_snum(sprintf("%.2f", $maxslope * 7));@\\
\mbox{}\verb@    my $maxslopebal = gs_snum(sprintf("%.0f ", $maxslope *@\\
\mbox{}\verb@                (HDiet::monthlog::CALORIES_PER_WEIGHT_UNIT->[$ui->{display_unit}] /@\\
\mbox{}\verb@                 HDiet::monthlog::CALORIES_PER_ENERGY_UNIT->[$ui->{energy_unit}])));@\\
\mbox{}\verb@    my $qmaxslopeuser = quoteHTML($maxslopeuser);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $pmaxslopeweek = gs_snum(sprintf("%.2f", $pmaxslope * 7));@\\
\mbox{}\verb@    my $pmaxslopebal = gs_snum(sprintf("%.0f ", $pmaxslope *@\\
\mbox{}\verb@                (HDiet::monthlog::CALORIES_PER_WEIGHT_UNIT->[$ui->{display_unit}] /@\\
\mbox{}\verb@                 HDiet::monthlog::CALORIES_PER_ENERGY_UNIT->[$ui->{energy_unit}])));@\\
\mbox{}\verb@    my $qpmaxslopeuser = quoteHTML($pmaxslopeuser);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    sub gs_snum {@\\
\mbox{}\verb@        my ($v) = @{\tt @}\verb@_;@\\
\mbox{}\verb@        $v =~ s/\-/&minus;/;@\\
\mbox{}\verb@        $v =~ s/^(\d)/\+$1/;@\\
\mbox{}\verb@        return $v;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb348}{348}.
\item \NWtxtIdentsUsed\nobreak\  \verb@CALORIES_PER_ENERGY_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@CALORIES_PER_WEIGHT_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Display global statistics gain and loss extrema}

The gain and loss extrema are displayed in a table with separate
sections for all accounts and public accounts only.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap482}\raggedright\small
\NWtarget{nuweb353}{} $\langle\,${\itshape Display global statistics gain and loss extrema}\nobreak\ {\footnotesize {353}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h2>Gain and Loss Extrema</h2>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<table class="global_stats">@\\
\mbox{}\verb@    <tr>@\\
\mbox{}\verb@        <th class="v"></th>@\\
\mbox{}\verb@        <th colspan="3" class="blr">All Accounts</th>@\\
\mbox{}\verb@        <th colspan="3" class="blr">Public Accounts</th>@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <tr>@\\
\mbox{}\verb@        <th class="v"></th>@\\
\mbox{}\verb@        <th class="bl">Name</th>@\\
\mbox{}\verb@        <th>$balunits</th>@\\
\mbox{}\verb@        <th>$wunits</th>@\\
\mbox{}\verb@        <th class="bl">Name</th>@\\
\mbox{}\verb@        <th>$balunits</th>@\\
\mbox{}\verb@        <th>$wunits</th>@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <tr>@\\
\mbox{}\verb@        <th class="l">Fastest loss</th>@\\
\mbox{}\verb@        <td class="c">$qminslopeuser</td>@\\
\mbox{}\verb@        <td>$minslopebal</td>@\\
\mbox{}\verb@        <td>$minslopeweek</td>@\\
\mbox{}\verb@        <td class="c">$qpminslopeuser</td>@\\
\mbox{}\verb@        <td>$pminslopebal</td>@\\
\mbox{}\verb@        <td>$pminslopeweek</td>@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <tr>@\\
\mbox{}\verb@        <th class="l">Fastest gain</th>@\\
\mbox{}\verb@        <td class="c">$qmaxslopeuser</td>@\\
\mbox{}\verb@        <td>$maxslopebal</td>@\\
\mbox{}\verb@        <td>$maxslopeweek</td>@\\
\mbox{}\verb@        <td class="c">$qpmaxslopeuser</td>@\\
\mbox{}\verb@        <td>$pmaxslopebal</td>@\\
\mbox{}\verb@        <td>$pmaxslopeweek</td>@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@</table>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p>@\\
\mbox{}\verb@Only accounts with $mincov% or more weight entries logged are included.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb348}{348}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Display global statistics log update frequency}

We display a table showing, for all accounts and public accounts, the
number of accounts, percent of class, and cumulative percent of accounts
which have been updated in intervals ranging from less than one day
to one month or more.  This gives a sense of how active the user
community is in updating logs.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap483}\raggedright\small
\NWtarget{nuweb354}{} $\langle\,${\itshape Display global statistics log update frequency}\nobreak\ {\footnotesize {354}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h2>Log Update Frequency</h2>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<table class="global_stats">@\\
\mbox{}\verb@    <tr>@\\
\mbox{}\verb@        <th class="v"></th>@\\
\mbox{}\verb@        <th colspan="3" class="blr">All Accounts</th>@\\
\mbox{}\verb@        <th colspan="3" class="blr">Public Accounts</th>@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <tr>@\\
\mbox{}\verb@        <th class="v">Days</th>@\\
\mbox{}\verb@        <th class="bl">Accounts</th>@\\
\mbox{}\verb@        <th>Percent</th>@\\
\mbox{}\verb@        <th>Cumulative</th>@\\
\mbox{}\verb@@\\
\mbox{}\verb@        <th class="bl">Accounts</th>@\\
\mbox{}\verb@        <th>Percent</th>@\\
\mbox{}\verb@        <th>Cumulative</th>@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my ($cum, $pcum) = (0, 0);@\\
\mbox{}\verb@    for (my $i = 0; $i <= $hndays; $i++) {@\\
\mbox{}\verb@        $acchist[$i] = 0 if !defined($acchist[$i]);@\\
\mbox{}\verb@        $pacchist[$i] = 0 if !defined($pacchist[$i]);@\\
\mbox{}\verb@        $cum += $acchist[$i];@\\
\mbox{}\verb@        $pcum += $pacchist[$i];@\\
\mbox{}\verb@        my $si = ($i < 1) ? "&lt;1" : (($i >= $hndays) ? "$hndays+" : $i);@\\
\mbox{}\verb@        printf($fh "    <tr><td>%s</td> <td>%d</td> <td>%d%%</td> <td>%d%%</td> " .@\\
\mbox{}\verb@                   "<td>%d</td> <td>%d%%</td> <td>%d%%</td></tr>\n",@\\
\mbox{}\verb@            $si,@\\
\mbox{}\verb@            $acchist[$i], int((($acchist[$i] / $acctotal) * 100) + 0.5),@\\
\mbox{}\verb@                int((($cum / $acctotal) * 100) + 0.5),@\\
\mbox{}\verb@            $pacchist[$i], int((($pacchist[$i] / $pacctotal) * 100) + 0.5),@\\
\mbox{}\verb@                int((($pcum / $pacctotal) * 100) + 0.5));@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    printf($fh "    <tr><td>Total</td> <td>%d</td> <td>100%%</td> <td>100%%</td> " .@\\
\mbox{}\verb@               "<td>%d</td> <td>100%%</td> <td>100%%</td></tr>\n",@\\
\mbox{}\verb@        $acctotal, $pacctotal);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@</table>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb348}{348}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Receive log records from the aggregator for global statistics}
\label{Receive log records from the aggregator for global statistics}

The following subroutine is called by the aggregator for each
log item returned.  The code assumes that all the records for
a given user will be returned together, and that within a
user's data, records will be in date order.  Separate accumulations
are done for all users and public users only, and a
``coverage'' statistic is computed indicating the percentage
of days in the interval for which weight was logged.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap484}\raggedright\small
\NWtarget{nuweb355}{} $\langle\,${\itshape Receive log records from the aggregator for global statistics}\nobreak\ {\footnotesize {355}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $acctrend = 0;@\\
\mbox{}\verb@    my $uljd;@\\
\mbox{}\verb@    my @{\tt @}\verb@utrend;@\\
\mbox{}\verb@    my $weightdays = 0;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    sub receive_aggregated_statistics_records {@\\
\mbox{}\verb@        my ($user, $jd, $weight, $trend, $rung, $flag, $comment) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@#if ($user->{login_name} eq 'astuemky') {@\\
\mbox{}\verb@#    print(STDERR "User $user->{login_name} $jd ", jd_to_RFC_3339_date($jd),@\\
\mbox{}\verb@#       " W = $weight  T = $trend  R = $rung  F = $flag  C = $comment\n");@\\
\mbox{}\verb@#}@\\
\mbox{}\verb@        if (($user->{login_name} ne $lastuser) &&@\\
\mbox{}\verb@                defined($weight)) {@\\
\mbox{}\verb@            if (($lastuser ne '') && ($lastacc >= 0)) {@\\
\mbox{}\verb@                if ($lastacc > $hndays) {@\\
\mbox{}\verb@                    $lastacc = $hndays;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@                $acchist[$lastacc]++;@\\
\mbox{}\verb@                $acctotal++;@\\
\mbox{}\verb@                if ($user->{public}) {@\\
\mbox{}\verb@                    $pacchist[$lastacc]++;@\\
\mbox{}\verb@                    $pacctotal++;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@@\\
\mbox{}\verb@                $badgetotal++ if ((defined($user->{badge_trend})) &&@\\
\mbox{}\verb@                    ($user->{badge_trend} != 0));@\\
\mbox{}\verb@@\\
\mbox{}\verb@                if ($acctrend && ($uljd == $jdnow)) {@\\
\mbox{}\verb@                    @\hbox{$\langle\,${\itshape Update global statistics overall trend analysis}\nobreak\ {\footnotesize \NWlink{nuweb356}{356}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@#if (($#utrend + 1) == 0) {@\\
\mbox{}\verb@#    my $sjd = jd_to_RFC_3339_date($jd);@\\
\mbox{}\verb@#    print(STDERR "Utrend zero for user $user->{login_name} at JD $jd, $sjd  Lastuser = $lastuser\n");@\\
\mbox{}\verb@#}@\\
\mbox{}\verb@                    my $coverage = int((($weightdays / ($#utrend + 1)) * 100) + 0.5);@\\
\mbox{}\verb@@\\
\mbox{}\verb@                    @\hbox{$\langle\,${\itshape Compute global statistics trend analysis for previous user}\nobreak\ {\footnotesize \NWlink{nuweb357}{357}}$\,\rangle$}\verb@@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@@\\
\mbox{}\verb@            $lastuser = $user->{login_name};@\\
\mbox{}\verb@            $lastpubname = $user->{public} ? $user->{public_name} : '';@\\
\mbox{}\verb@            $weightdays = 0;@\\
\mbox{}\verb@            $totuser++;@\\
\mbox{}\verb@@\\
\mbox{}\verb@            $acctrend = 0;@\\
\mbox{}\verb@            if ($jd == $jdthen) {@\\
\mbox{}\verb@                $acctrend = 1;@\\
\mbox{}\verb@                @{\tt @}\verb@utrend = ( );@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if ($acctrend && defined($trend)) {@\\
\mbox{}\verb@            push(@{\tt @}\verb@utrend, $trend);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $uljd = $jd;@\\
\mbox{}\verb@        if (defined($weight)) {@\\
\mbox{}\verb@            $lastacc = int($jdnow - $jd);@\\
\mbox{}\verb@            $weightdays++;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb348}{348}.
\item \NWtxtIdentsUsed\nobreak\  \verb@jd_to_RFC_3339_date@\nobreak\ \NWlink{nuweb452b}{452b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Update global statistics overall trend analysis}

If we have complete trend data for the user whose log items
we have just completed receiving, add it to the global composite
trend arrays (\verb+@ttrend+ for all accounts,
\verb+@pttrend+ for public accounts only).  For each
day in the trend array, we keep track of the number of items
added to the bin.  This isn't strictly necessary since we
currently only add the user's data if it's complete, but
doing so permits loosening this constraint in the future
should we judge that wise.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap485}\raggedright\small
\NWtarget{nuweb356}{} $\langle\,${\itshape Update global statistics overall trend analysis}\nobreak\ {\footnotesize {356}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@#print(STDERR "$lastuser trend complete.\n");@\\
\mbox{}\verb@    my $ufitter = HDiet::trendfit->new();@\\
\mbox{}\verb@    for (my $i = 0; $i <= $#utrend; $i++) {@\\
\mbox{}\verb@        $ufitter->addPoint($utrend[$i]);@\\
\mbox{}\verb@#print(STDERR "$lastuser $user->{login_name} trend[$i] undefined.\n") if !defined($utrend[$i]);@\\
\mbox{}\verb@        $ttrend[$i] += $utrend[$i];@\\
\mbox{}\verb@        $ntrend[$i]++;@\\
\mbox{}\verb@#print(STDERR "$lastuser trend $i: $ttrend[$i]  $ntrend[$i]\n");@\\
\mbox{}\verb@        if ($user->{public}) {@\\
\mbox{}\verb@            $pttrend[$i] += $utrend[$i];@\\
\mbox{}\verb@            $nptrend[$i]++;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb355}{355}.
\item \NWtxtIdentsUsed\nobreak\  \verb@addPoint@\nobreak\ \NWlink{nuweb20a}{20a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Compute global statistics trend analysis for previous user}

After we've received all of the records for a user, if the coverage
(percentage of weights logged in the interval) is greater than our
threshold, we fit a linear trend and, if it's greater than the
previous maximum or less than the previous mininum, we save the user
name as the current fastest gain or loss.  This is done separately
for all account and for public accounts only.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap486}\raggedright\small
\NWtarget{nuweb357}{} $\langle\,${\itshape Compute global statistics trend analysis for previous user}\nobreak\ {\footnotesize {357}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($coverage >= $mincov) {@\\
\mbox{}\verb@        my $uslope = $ufitter->fitSlope();@\\
\mbox{}\verb@        if (($uslope < 0) && ($uslope < $minslope)) {@\\
\mbox{}\verb@            $minslope = $uslope;@\\
\mbox{}\verb@            $minslopeuser = $lastuser;@\\
\mbox{}\verb@            $minslopecov = $coverage;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if (($uslope > 0) && ($uslope > $maxslope)) {@\\
\mbox{}\verb@            $maxslope = $uslope;@\\
\mbox{}\verb@            $maxslopeuser = $lastuser;@\\
\mbox{}\verb@            $maxslopecov = $coverage;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($lastpubname ne '') {@\\
\mbox{}\verb@            if (($uslope < 0) && ($uslope < $pminslope)) {@\\
\mbox{}\verb@                $pminslope = $uslope;@\\
\mbox{}\verb@                $pminslopeuser = $lastpubname;@\\
\mbox{}\verb@                $pminslopecov = $coverage;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            if (($uslope > 0) && ($uslope > $pmaxslope)) {@\\
\mbox{}\verb@                $pmaxslope = $uslope;@\\
\mbox{}\verb@                $pmaxslopeuser = $lastpubname;@\\
\mbox{}\verb@                $pmaxslopecov = $coverage;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb355}{355}.
\item \NWtxtIdentsUsed\nobreak\  \verb@fitSlope@\nobreak\ \NWlink{nuweb20b}{20b}\NWlink{nuweb488a}{, 488a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Generate synthetic data for user account}

The synthetic data generator allows an administrator to
fill demonstration accounts with synthetic data generated
by combining a linear trend with a variety of perturbation
functions.  The form is re-displayed after each generation
request to facilitate piecing together multiple sequences
of synthetic data.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap487}\raggedright\small
\NWtarget{nuweb358}{} $\langle\,${\itshape Generate synthetic data for user account}\nobreak\ {\footnotesize {358}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (!$assumed_identity) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Verify that user has administrator privilege}\nobreak\ {\footnotesize \NWlink{nuweb331}{331}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Synthetic Data Generator", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Synthetic Data Generator</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<form id="Hdiet_synthdata" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $npert = 5;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate synthetic data as specified in form}\nobreak\ {\footnotesize \NWlink{nuweb359}{359}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate synthetic data specification form}\nobreak\ {\footnotesize \NWlink{nuweb360}{360}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb181}{181}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Generate synthetic data as specified in form}

If we arrived here from a previous instance of this form
being submitted, parse and validate the form arguments
and generate the synthetic data.

When generating synthetic data for the ``flag'' field, existing
entries are replaced, and the ``Percent to fill'' field controls
the percentage of days which are flagged.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap488}\raggedright\small
\NWtarget{nuweb359}{} $\langle\,${\itshape Generate synthetic data as specified in form}\nobreak\ {\footnotesize {359}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (defined($CGIargs{from_y}) && ($CGIargs{from_y} ne '')) {@\\
\mbox{}\verb@        my ($from_y, $from_m, $from_d) = ($CGIargs{from_y}, $CGIargs{from_m}, $CGIargs{from_d});@\\
\mbox{}\verb@        my ($to_y, $to_m, $to_d) = ($CGIargs{to_y}, $CGIargs{to_m}, $CGIargs{to_d});@\\
\mbox{}\verb@        my ($field, $fillfrac, $start_value, $end_value) =@\\
\mbox{}\verb@            ($CGIargs{field}, $CGIargs{fill_frac}, $CGIargs{start_value}, $CGIargs{end_value});@\\
\mbox{}\verb@        my $format = ($field eq 'weight') ? '%.1f' : '%.0f';@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $start_value =~ s/,/./;@\\
\mbox{}\verb@        $end_value =~ s/,/./;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my @{\tt @}\verb@pertarg;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        for (my $n = 1; $n <= $npert; $n++) {@\\
\mbox{}\verb@            if (($CGIargs{"pf_$n"} ne '') && $CGIargs{"pm_$n"}) {@\\
\mbox{}\verb@                $CGIargs{"pm_$n"} =~ s/,/./;@\\
\mbox{}\verb@                $CGIargs{"po_$n"} =~ s/,/./;@\\
\mbox{}\verb@                $CGIargs{"pp_$n"} =~ s/,/./;@\\
\mbox{}\verb@                push(@{\tt @}\verb@pertarg, $CGIargs{"pf_$n"},  $CGIargs{"pm_$n"});@\\
\mbox{}\verb@                if ($CGIargs{"pf_$n"} eq 'sine') {@\\
\mbox{}\verb@                    push(@{\tt @}\verb@pertarg, $CGIargs{"po_$n"},  $CGIargs{"pp_$n"});@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $hist = HDiet::history->new($ui, $user_file_name);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($field eq 'flag') {@\\
\mbox{}\verb@            $hist->syntheticData(@\\
\mbox{}\verb@                    sprintf("%04d-%02d-%02d", $from_y, $from_m, $from_d),@\\
\mbox{}\verb@                    sprintf("%04d-%02d-%02d", $to_y, $to_m, $to_d),@\\
\mbox{}\verb@                    $field, 1, 0, 0, '%d');@\\
\mbox{}\verb@            $start_value = $end_value = 1;@\\
\mbox{}\verb@            $format = '%d';@\\
\mbox{}\verb@            @{\tt @}\verb@pertarg = ( );@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $hist->syntheticData(@\\
\mbox{}\verb@                sprintf("%04d-%02d-%02d", $from_y, $from_m, $from_d),@\\
\mbox{}\verb@                sprintf("%04d-%02d-%02d", $to_y, $to_m, $to_d),@\\
\mbox{}\verb@                $field, $fillfrac / 100, $start_value, $end_value, $format,@\\
\mbox{}\verb@                @{\tt @}\verb@pertarg);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        propagate_trend($ui, sprintf("%04d-%02d", $from_y, $from_m), 0);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb358}{358}.
\item \NWtxtIdentsUsed\nobreak\  \verb@propagate_trend@\nobreak\ \NWlink{nuweb392}{392}, \verb@syntheticData@\nobreak\ \NWlink{nuweb105}{105}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Generate synthetic data specification form}


\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap489}\raggedright\small
\NWtarget{nuweb360}{} $\langle\,${\itshape Generate synthetic data specification form}\nobreak\ {\footnotesize {360}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<table class="syndata">@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Synthetic data start date}\nobreak\ {\footnotesize \NWlink{nuweb361}{361}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Synthetic data end date}\nobreak\ {\footnotesize \NWlink{nuweb362}{362}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Synthetic data field selection}\nobreak\ {\footnotesize \NWlink{nuweb363a}{363a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@    <th class="l">Percent to fill:</th>@\\
\mbox{}\verb@    <td colspan="4">@\\
\mbox{}\verb@    <input type="text" name="fill_frac" value="100" size="4" maxlength="4" />%@\\
\mbox{}\verb@    </td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Synthetic data start and end values}\nobreak\ {\footnotesize \NWlink{nuweb363b}{363b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Table of perturbation functions}\nobreak\ {\footnotesize \NWlink{nuweb364}{364}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@<td colspan="5" class="c">@\\
\mbox{}\verb@    <input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@    <input type="submit" name="q=synthdata" value=" Generate " />@\\
\mbox{}\verb@    &nbsp;@\\
\mbox{}\verb@    <input type="reset" value=" Reset " />@\\
\mbox{}\verb@    &nbsp;@\\
\mbox{}\verb@    <input type="submit" name="q=gonque" value=" Cancel " />@\\
\mbox{}\verb@</td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@</table>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb358}{358}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Synthetic data start date}

These fields specify the date at which the synthetic data generation
should start.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap490}\raggedright\small
\NWtarget{nuweb361}{} $\langle\,${\itshape Synthetic data start date}\nobreak\ {\footnotesize {361}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my ($ysel, $msel, $dsel) = ("") x 3;@\\
\mbox{}\verb@    my (@{\tt @}\verb@fm_selected, @{\tt @}\verb@fd_selected);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $i = 1; $i <= 31; $i++) {@\\
\mbox{}\verb@        $fd_selected[$i] = '';@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    for (my $i = 1; $i <= 12; $i++) {@\\
\mbox{}\verb@        $fm_selected[$i] = '';@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@    <th class="l">Start date:</th>@\\
\mbox{}\verb@    <td colspan="4">@\\
\mbox{}\verb@    <input type="text" name="from_y" value="" size="5" maxlength="5" />@\\
\mbox{}\verb@    <select name="from_m" id="from_m"$msel>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $mid = "fm_";@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate option items for months}\nobreak\ {\footnotesize \NWlink{nuweb302a}{302a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@    </select>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@    <select name="from_d" id="from_d"$dsel>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $did = "fd_";@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate option items for days}\nobreak\ {\footnotesize \NWlink{nuweb302b}{302b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@    </select>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@    </td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb360}{360}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Synthetic data end date}

These fields specify the date at which the synthetic data generation
ends.


\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap491}\raggedright\small
\NWtarget{nuweb362}{} $\langle\,${\itshape Synthetic data end date}\nobreak\ {\footnotesize {362}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@    <th class="l">End date:</th>@\\
\mbox{}\verb@    <td colspan="4">@\\
\mbox{}\verb@    <input type="text" name="to_y" value="" size="5" maxlength="5" />@\\
\mbox{}\verb@    <select name="to_m" id="to_m"$msel>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $mid = "tm_";@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate option items for months}\nobreak\ {\footnotesize \NWlink{nuweb302a}{302a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@    </select>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@    <select name="to_d" id="to_d"$dsel>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $did = "td_";@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate option items for days}\nobreak\ {\footnotesize \NWlink{nuweb302b}{302b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@    </select>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@    </td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb360}{360}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Synthetic data field selection}

This selection box specifies which field is to be filled with
the synthetic data.  The data format is implicitly selected by
the choice of field.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap492}\raggedright\small
\NWtarget{nuweb363a}{} $\langle\,${\itshape Synthetic data field selection}\nobreak\ {\footnotesize {363a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@     print $fh <<"EOD";@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@    <th class="l">Field:</th>@\\
\mbox{}\verb@    <td colspan="4">@\\
\mbox{}\verb@    <select name="field">@\\
\mbox{}\verb@        <option value="weight">Weight</option>@\\
\mbox{}\verb@        <option value="rung">Exercise rung</option>@\\
\mbox{}\verb@        <option value="flag">Flag</option>@\\
\mbox{}\verb@    </select>@\\
\mbox{}\verb@    </td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb360}{360}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Synthetic data start and end values}

The underlying function for generating synthetic data is a linear
trend from the start value to the end value, specified in the
following two fields.  This deterministic progression may be
modified by the perturbation function specified below.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap493}\raggedright\small
\NWtarget{nuweb363b}{} $\langle\,${\itshape Synthetic data start and end values}\nobreak\ {\footnotesize {363b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@    <th class="l">Start value:</th>@\\
\mbox{}\verb@    <td colspan="4">@\\
\mbox{}\verb@    <input type="text" name="start_value" value="" size="6" maxlength="6" />@\\
\mbox{}\verb@    </td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@    <th class="l">End value:</th>@\\
\mbox{}\verb@    <td colspan="4">@\\
\mbox{}\verb@    <input type="text" name="end_value" value="" size="6" maxlength="6" />@\\
\mbox{}\verb@    </td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb360}{360}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Table of perturbation functions}

The user can supply a total of \verb+$npert+ perturbation functions
which are applied to the linear data trend.  Blank functions or those
with an unspecified or zero range are ignored.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap494}\raggedright\small
\NWtarget{nuweb364}{} $\langle\,${\itshape Table of perturbation functions}\nobreak\ {\footnotesize {364}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@    <td colspan="1"></td>@\\
\mbox{}\verb@    <th>Function</th>@\\
\mbox{}\verb@    <th>Range</th>@\\
\mbox{}\verb@    <th>Period</th>@\\
\mbox{}\verb@    <th>Phase</th>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    for (my $p = 1; $p <= $npert; $p++) {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@    <th class="l">Perturbation $p:</th>@\\
\mbox{}\verb@    <td>@\\
\mbox{}\verb@    <select name="pf_$p">@\\
\mbox{}\verb@        <option value=""></option>@\\
\mbox{}\verb@        <option value="uniform">Uniform</option>@\\
\mbox{}\verb@        <option value="gaussian">Gaussian</option>@\\
\mbox{}\verb@        <option value="sine">Sinusoidal</option>@\\
\mbox{}\verb@    </select>@\\
\mbox{}\verb@    </td>@\\
\mbox{}\verb@    <td><input type="text" name="pm_$p" value="" size="5" maxlength="5" /></td>@\\
\mbox{}\verb@    <td><input type="text" name="po_$p" value="" size="5" maxlength="5" /></td>@\\
\mbox{}\verb@    <td><input type="text" name="pp_$p" value="" size="5" maxlength="5" /></td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb360}{360}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Send a feedback message}

Display a form which allows users to send feedback to developers.  The
feedback is sent to an E-mail address which is never disclosed to
users.  The user may request a copy be sent to the E-mail address
configured for the account.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap495}\raggedright\small
\NWtarget{nuweb365}{} $\langle\,${\itshape Send a feedback message}\nobreak\ {\footnotesize {365}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Send Feedback", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Send Feedback</h1>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my ($subject, $category, $message, $from) = ('') x 4;@\\
\mbox{}\verb@    my @{\tt @}\verb@feedsel;@\\
\mbox{}\verb@    if (defined($CGIargs{message})) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Show preview of message being composed}\nobreak\ {\footnotesize \NWlink{nuweb367}{367}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate feedback message composition form}\nobreak\ {\footnotesize \NWlink{nuweb366}{366}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Generate feedback message composition form}

The feedback composition form consists of a table containing
the input fields, the checkbox which enables copying the message
to the sender, and the action buttons to preview, submit, or
cancel the message.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap496}\raggedright\small
\NWtarget{nuweb366}{} $\langle\,${\itshape Generate feedback message composition form}\nobreak\ {\footnotesize {366}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    $feedsel[$CGIargs{category}] = 1 if defined($CGIargs{category});@\\
\mbox{}\verb@    my $ckcopy = defined($CGIargs{copy_sender}) ? ' checked="checked"' : '';@\\
\mbox{}\verb@    my $qun = quoteHTML($user_name);@\\
\mbox{}\verb@    my $em = $ui->{e_mail};@\\
\mbox{}\verb@    if ("$ui->{first_name}$ui->{middle_name}$ui->{last_name}" ne "") {@\\
\mbox{}\verb@        my $fname = "$ui->{first_name} $ui->{middle_name} $ui->{last_name}";@\\
\mbox{}\verb@        $fname =~ s/\s+/ /g;@\\
\mbox{}\verb@        $fname =~ s/^\s+//;@\\
\mbox{}\verb@        $fname =~ s/\s+$//;@\\
\mbox{}\verb@        $em = "$fname <$em>";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    my $qem = quoteHTML($em);@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<form id="Hdiet_feedback" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@<table border="border" class="feedback">@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@<th>Name:<br />E-mail:</th> <td>$qun<br />$qem</td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Enumerate feedback message categories}\nobreak\ {\footnotesize \NWlink{nuweb369}{369}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $qms = quoteHTML($message);@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@<th>Subject:</th>@\\
\mbox{}\verb@<td>@\\
\mbox{}\verb@    <input type="text" name="subject" value="$subject" size="64" maxlength="80" />@\\
\mbox{}\verb@</td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@<th class="t">Message:</th>@\\
\mbox{}\verb@<td>@\\
\mbox{}\verb@    <textarea cols="64" rows="16" name="message">$qms</textarea>@\\
\mbox{}\verb@</td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@</table>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<input type="checkbox" name="copy_sender" id="copy_sender"$ckcopy />&nbsp;<label@\\
\mbox{}\verb@    for="copy_sender">Send me a copy of the feedback message</label><br />@\\
\mbox{}\verb@<input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@<input type="submit" name="q=feedback" value=" Preview " onclick="return validateFeedback();" />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="submit" name="q=send_feedback" value=" Send Feedback " onclick="return validateFeedback();" />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="submit" name="q=account" value=" Cancel " />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb365}{365}.
\item \NWtxtIdentsUsed\nobreak\  \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}, \verb@validateFeedback@\nobreak\ \NWlink{nuweb516a}{516a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Show preview of message being composed}

If the ``{\tt message}'' form argument is defined, we were invoked
by the ``Preview'' button from a message being composed.  Preset
the fields to appear in the form to the values from the invoking
form and show the message preview before the composition form.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap497}\raggedright\small
\NWtarget{nuweb367}{} $\langle\,${\itshape Show preview of message being composed}\nobreak\ {\footnotesize {367}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    ($subject, $category, $message, $from) =@\\
\mbox{}\verb@            ($CGIargs{subject},@\\
\mbox{}\verb@             $feedback_categories[$CGIargs{category}],@\\
\mbox{}\verb@             $CGIargs{message},@\\
\mbox{}\verb@             $ui->{e_mail});@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $subject =~ s/[\r\n]/ /g;@\\
\mbox{}\verb@    $category =~ s/[\r\n]/ /g;@\\
\mbox{}\verb@    $message =~ s/\r\n/\n/g;@\\
\mbox{}\verb@    $message =~ s/\n\.\n/\n\. \n/g;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Show feedback message in reply page}\nobreak\ {\footnotesize \NWlink{nuweb373}{373}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $feedsel[$CGIargs{category}] = 1;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Check spelling in subject and message}\nobreak\ {\footnotesize \NWlink{nuweb368}{368}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb365}{365}.
\item \NWtxtIdentsUsed\nobreak\  \verb@$feedback_categories@\nobreak\ \NWlink{nuweb388b}{388b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Check spelling in subject and message}

Just like the friendly gas stations in the Era of Service---``Free
fill-up if we forget to check the oil''---we provide a free spelling
check every time the user requests a preview of the message.  Someday
we'll include a language preference in the {\tt user} object to
determine the language against which the message is checked.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap498}\raggedright\small
\NWtarget{nuweb368}{} $\langle\,${\itshape Check spelling in subject and message}\nobreak\ {\footnotesize {368}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $spell = 1;          # We may make this optional some day@\\
\mbox{}\verb@    my $spellCmd = @\hbox{$\langle\,${\itshape Command to check spelling}\nobreak\ {\footnotesize \NWlink{nuweb12b}{12b}}$\,\rangle$}\verb@;@\\
\mbox{}\verb@    if ($spell && ($spellCmd ne '')) {@\\
\mbox{}\verb@        my $sfn = "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/spell$$.tmp";@\\
\mbox{}\verb@        if (open(SP, "|-:utf8", "$spellCmd >$sfn")) {@\\
\mbox{}\verb@            print(SP $subject . "\n");@\\
\mbox{}\verb@            print(SP $message . "\n");@\\
\mbox{}\verb@            close(SP);@\\
\mbox{}\verb@            open(SF, "<:utf8", $sfn) ||@\\
\mbox{}\verb@                die("Cannot reopen spelling file $sfn");@\\
\mbox{}\verb@            my $pt = '';@\\
\mbox{}\verb@            while (<SF>) {@\\
\mbox{}\verb@                $pt .= $_;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            close(SF);@\\
\mbox{}\verb@            unlink($sfn);@\\
\mbox{}\verb@            $pt =~ s/^\s+//;@\\
\mbox{}\verb@            $pt =~ s/\s+$//;@\\
\mbox{}\verb@            $pt =~ s/\s+/ /g;@\\
\mbox{}\verb@            if ($pt eq '') {@\\
\mbox{}\verb@                print $fh <<"EOD";@\\
\mbox{}\verb@<div class="spell_ok">@\\
\mbox{}\verb@<h4>No Misspelled Words</h4>@\\
\mbox{}\verb@</div>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                $pt = quoteHTML(wrapText($pt, @\hbox{$\langle\,${\itshape Maximum line length in feedback E-mail messages}\nobreak\ {\footnotesize \NWlink{nuweb11g}{11g}}$\,\rangle$}\verb@));@\\
\mbox{}\verb@                print $fh <<"EOD";@\\
\mbox{}\verb@<div class="spell_dubieties">@\\
\mbox{}\verb@<h4>Possibly Misspelled Words</h4>@\\
\mbox{}\verb@<pre>$pt@\\
\mbox{}\verb@</pre>@\\
\mbox{}\verb@</div>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb367}{367}.
\item \NWtxtIdentsUsed\nobreak\  \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}, \verb@wrapText@\nobreak\ \NWlink{nuweb403}{403}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Enumerate feedback message categories}

Emit the selection list of feedback message categories.  These
are simply included as text in the feedback message, so the
content of the option tags are used as their values.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap499}\raggedright\small
\NWtarget{nuweb369}{} $\langle\,${\itshape Enumerate feedback message categories}\nobreak\ {\footnotesize {369}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@<th>Category:</th>@\\
\mbox{}\verb@<td>@\\
\mbox{}\verb@    <select name="category" id="category">@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    for (my $i = 0; $i <= $#feedback_categories; $i++) {@\\
\mbox{}\verb@        my $sel = $feedsel[$i] ? ' selected="selected"' : '';@\\
\mbox{}\verb@        print($fh "        <option value=\"$i\"$sel>$feedback_categories[$i]</option>\n");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@    </select>@\\
\mbox{}\verb@</td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb366}{366}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Send a message from the feedback form}

When the user clicks the ``Send Feedback'' button in the feedback form, this
transaction sends the E-mail message to the designated feedback address.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap500}\raggedright\small
\NWtarget{nuweb370}{} $\langle\,${\itshape Send a message from the feedback form}\nobreak\ {\footnotesize {370}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Feedback Sent", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my ($subject, $category, $message, $from) =@\\
\mbox{}\verb@            ($CGIargs{subject},@\\
\mbox{}\verb@             $feedback_categories[$CGIargs{category}],@\\
\mbox{}\verb@             $CGIargs{message},@\\
\mbox{}\verb@             $ui->{e_mail});@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $subject =~ s/[\r\n]/ /g;@\\
\mbox{}\verb@    $category =~ s/[\r\n]/ /g;@\\
\mbox{}\verb@    $message =~ s/\r\n/\n/g;@\\
\mbox{}\verb@    $message =~ s/^\.\n/\. \n/;@\\
\mbox{}\verb@    $message =~ s/\n\.\n/\n\. \n/g;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (!$readOnly) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Send mail to feedback address}\nobreak\ {\footnotesize \NWlink{nuweb371}{371}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($CGIargs{copy_sender}) {@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Send copy to the submitter}\nobreak\ {\footnotesize \NWlink{nuweb372}{372}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Feedback Sent</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@<b>The following feedback message has been sent.  Thank you@\\
\mbox{}\verb@for contributing to the improvement of The Hacker's Diet@\\
\mbox{}\verb@<em>Online</em>.</b>@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Show feedback message in reply page}\nobreak\ {\footnotesize \NWlink{nuweb373}{373}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=account&amp;s=$session->{session_id}$tzOff">Back@\\
\mbox{}\verb@    to account page</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    append_history($user_file_name, 16, $category) if !$readOnly;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@$feedback_categories@\nobreak\ \NWlink{nuweb388b}{388b}, \verb@append_history@\nobreak\ \NWlink{nuweb397}{397}, \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Send mail to feedback address}

Send the feedback message to the designated feedback
E-mail address.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap501}\raggedright\small
\NWtarget{nuweb371}{} $\langle\,${\itshape Send mail to feedback address}\nobreak\ {\footnotesize {371}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    $from = "@\hbox{$\langle\,${\itshape From address for mail sent to users}\nobreak\ {\footnotesize \NWlink{nuweb11e}{11e}}$\,\rangle$}\verb@" if !defined($from);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $zto = '@\hbox{$\langle\,${\itshape Address for feedback E-mail}\nobreak\ {\footnotesize \NWlink{nuweb11f}{11f}}$\,\rangle$}\verb@';@\\
\mbox{}\verb@    my $bn = <<"EOD";@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Build Number}\nobreak\ {\footnotesize \NWlink{nuweb3c}{3c}}$\,\rangle$}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    $bn =~ s/\s+$//;@\\
\mbox{}\verb@    my $bt = <<"EOD";@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Build Time}\nobreak\ {\footnotesize \NWlink{nuweb3d}{3d}}$\,\rangle$}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    $bt =~ s/\s+$//;@\\
\mbox{}\verb@    my $browser = defined($ENV{HTTP_USER_AGENT}) ? "\r\nBrowser:  $ENV{HTTP_USER_AGENT}" : '';@\\
\mbox{}\verb@    my $fullName;@\\
\mbox{}\verb@    if ("$ui->{first_name}$ui->{middle_name}$ui->{last_name}" ne "") {@\\
\mbox{}\verb@        $fullName = "$ui->{first_name} $ui->{middle_name} $ui->{last_name}";@\\
\mbox{}\verb@        $fullName =~ s/\s+/ /g;@\\
\mbox{}\verb@        $fullName =~ s/^\s+//;@\\
\mbox{}\verb@        $fullName =~ s/\s+$//;@\\
\mbox{}\verb@        $fullName = "\r\nUser:     $fullName";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    open(MAIL, "|-:utf8", "@\hbox{$\langle\,${\itshape Path to Invoke Sendmail}\nobreak\ {\footnotesize \NWlink{nuweb11d}{11d}}$\,\rangle$}\verb@",@\\
\mbox{}\verb@            "-f$from",@\\
\mbox{}\verb@            $zto) ||@\\
\mbox{}\verb@        die("Cannot create pipe to @\hbox{$\langle\,${\itshape Path to Invoke Sendmail}\nobreak\ {\footnotesize \NWlink{nuweb11d}{11d}}$\,\rangle$}\verb@");@\\
\mbox{}\verb@    print MAIL <<"EOD";@\\
\mbox{}\verb@From $from\r@\\
\mbox{}\verb@To: $zto\r@\\
\mbox{}\verb@Subject: [HackDiet Feedback] $category\r@\\
\mbox{}\verb@Content-type: text/plain; charset=utf-8\r@\\
\mbox{}\verb@\r@\\
\mbox{}\verb@From:     $ui->{login_name} <$from>$fullName\r@\\
\mbox{}\verb@Category: $category\r@\\
\mbox{}\verb@Subject:  $subject$browser\r@\\
\mbox{}\verb@Build:    $bn: $bt\r@\\
\mbox{}\verb@\r@\\
\mbox{}\verb@$message@\\
\mbox{}\verb@.\r@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    close(MAIL);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb370}{370}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Send copy to the submitter}

If requested, send a copy of the feedback message to the
submitter's E-mail address.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap502}\raggedright\small
\NWtarget{nuweb372}{} $\langle\,${\itshape Send copy to the submitter}\nobreak\ {\footnotesize {372}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    open(MAIL, "|-:utf8", "@\hbox{$\langle\,${\itshape Path to Invoke Sendmail}\nobreak\ {\footnotesize \NWlink{nuweb11d}{11d}}$\,\rangle$}\verb@",@\\
\mbox{}\verb@            "-f@\hbox{$\langle\,${\itshape From address for mail sent to users}\nobreak\ {\footnotesize \NWlink{nuweb11e}{11e}}$\,\rangle$}\verb@",@\\
\mbox{}\verb@            $from) ||@\\
\mbox{}\verb@        die("Cannot create pipe to @\hbox{$\langle\,${\itshape Path to Invoke Sendmail}\nobreak\ {\footnotesize \NWlink{nuweb11d}{11d}}$\,\rangle$}\verb@");@\\
\mbox{}\verb@    print MAIL <<"EOD";@\\
\mbox{}\verb@From $from\r@\\
\mbox{}\verb@To: $from\r@\\
\mbox{}\verb@Subject: [Hacker's Diet Online Feedback] $category\r@\\
\mbox{}\verb@Content-type: text/plain; charset=utf-8\r@\\
\mbox{}\verb@\r@\\
\mbox{}\verb@From:     $ui->{login_name} <$from>\r@\\
\mbox{}\verb@Category: $category\r@\\
\mbox{}\verb@Subject:  $subject\r@\\
\mbox{}\verb@\r@\\
\mbox{}\verb@$message@\\
\mbox{}\verb@.\r@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    close(MAIL);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb370}{370}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Show feedback message in reply page}

Format the feedback message as currently composed for
inclusion in a Web page.  This can be used either for a preview
of the message during composition or as a confirmation
after the message is sent.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap503}\raggedright\small
\NWtarget{nuweb373}{} $\langle\,${\itshape Show feedback message in reply page}\nobreak\ {\footnotesize {373}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $pt = $CGIargs{message};@\\
\mbox{}\verb@    $pt =~ s/\r\n/\n/g;@\\
\mbox{}\verb@    my $t = $pt;@\\
\mbox{}\verb@    $pt = '';@\\
\mbox{}\verb@    if (!($t =~ m/\n$/)) {@\\
\mbox{}\verb@        $t .= "\n";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    while ($t =~ s/^(.*\n)//) {@\\
\mbox{}\verb@        my $l = $1;@\\
\mbox{}\verb@        if (length($l) > @\hbox{$\langle\,${\itshape Maximum line length in feedback E-mail messages}\nobreak\ {\footnotesize \NWlink{nuweb11g}{11g}}$\,\rangle$}\verb@) {@\\
\mbox{}\verb@            $l = wrapText($l, @\hbox{$\langle\,${\itshape Maximum line length in feedback E-mail messages}\nobreak\ {\footnotesize \NWlink{nuweb11g}{11g}}$\,\rangle$}\verb@);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $pt .= $l;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    $pt =~ s/\n\n+$/\n/;@\\
\mbox{}\verb@    $pt = quoteHTML($pt);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my ($qli, $qem, $qcat, $qsub) = (quoteHTML($ui->{login_name}), quoteHTML($ui->{e_mail}),@\\
\mbox{}\verb@        quoteHTML($category), quoteHTML($subject));@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@@\\
\mbox{}\verb@<pre class="preview"><b>From:</b>     $qli &lt;$qem&gt;@\\
\mbox{}\verb@<b>Category:</b> $qcat@\\
\mbox{}\verb@<b>Subject:</b>  $qsub@\\
\mbox{}\verb@@\\
\mbox{}\verb@$pt</pre>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb367}{367}\NWlink{nuweb370}{, 370}.
\item \NWtxtIdentsUsed\nobreak\  \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}, \verb@wrapText@\nobreak\ \NWlink{nuweb403}{403}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Delete entire log database}

Delete all logs for a user.  This must be performed before we allow
the user to close an account.  The user is implored (but not required)
to download a backup of the logs before deleting them from the database.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap504}\raggedright\small
\NWtarget{nuweb374}{} $\langle\,${\itshape Delete entire log database}\nobreak\ {\footnotesize {374}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@months = $ui->enumerateMonths();@\\
\mbox{}\verb@    my $nmonths = $#months + 1;@\\
\mbox{}\verb@    my $mont = 'month' . (($nmonths != 1) ? 's' : '');@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Delete Entire Database", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@     print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Delete Entire Log Database</h1>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($nmonths == 0) {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h3>You have no logs in the database!  Either you have never entered@\\
\mbox{}\verb@and saved any log items, or you have already deleted your logs.</h3>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Emit shrill warning about what is about to transpire}\nobreak\ {\footnotesize \NWlink{nuweb375a}{375a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Generate form permitting user to back up database}\nobreak\ {\footnotesize \NWlink{nuweb375b}{375b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@<form id="Hdiet_wipedb" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@In order to confirm your intention to@\\
\mbox{}\verb@<span class="shrill">irreversibly delete</span> your entire@\\
\mbox{}\verb@log database, please enter your user name and password in the fields@\\
\mbox{}\verb@below, and type the one-time &ldquo;confirmation code&rdquo;@\\
\mbox{}\verb@in the box.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Generate destructive operation confirmation form}\nobreak\ {\footnotesize \NWlink{nuweb376}{376}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@<input type="hidden" name="c" value="$consig" />@\\
\mbox{}\verb@<input type="submit" class="darwin" name="q=do_wipedb" value=" Delete Entire Log Database&#xa;(Cannot be undone!)" />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="submit" name="q=account" value=" Cancel " />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb180a}{180a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@enumerateMonths@\nobreak\ \NWlink{nuweb140}{140}, \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Emit shrill warning about what is about to transpire}

The following message reminds the user what's going to happen if
this request is allowed to proceed and beseeches him to download
a backup of the database before destroying the online copy.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap505}\raggedright\small
\NWtarget{nuweb375a}{} $\langle\,${\itshape Emit shrill warning about what is about to transpire}\nobreak\ {\footnotesize {375a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@This page allows you to <span class="shrill">delete your entire log database</span>@\\
\mbox{}\verb@of $nmonths $mont from The Hacker's Diet <em>Online</em>.  This operation is@\\
\mbox{}\verb@<span class="shrill">irrevocable</span>&mdash;unless you have previously downloaded@\\
\mbox{}\verb@a backup copy of your logs, all of the information you have entered@\\
\mbox{}\verb@into them will be <span class="shrill">lost forever</span>.  Consequently, before@\\
\mbox{}\verb@proceeding, we <span class="shrill">implore you</span> to make a database backup@\\
\mbox{}\verb@now by pressing the button below.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb374}{374}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Generate form permitting user to back up database}

Having urged the user to back up the database, the following form
provides a one-button means of doing so.  A backup of the entire
database in XML format is automatically selected.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap506}\raggedright\small
\NWtarget{nuweb375b}{} $\langle\,${\itshape Generate form permitting user to back up database}\nobreak\ {\footnotesize {375b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@<form id="Hdiet_exportdb" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@<input type="hidden" name="format" value="xml" />@\\
\mbox{}\verb@<input type="hidden" name="period" value="a" />@\\
\mbox{}\verb@@\\
\mbox{}\verb@<input type="submit" name="q=do_exportdb" value=" Back Up Entire Log Database " />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb374}{374}.
\item \NWtxtIdentsUsed\nobreak\  \verb@xml@\nobreak\ \NWlink{nuweb440}{440}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Generate destructive operation confirmation form}

Destructive operations, such as deleting all a user's logs from the
database or closing an account, require confirmation by the user.  We
ask the user to enter their user name, password, and a randomly-generated
``confirmation code'' before proceeding with such an irrevocable operation.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap507}\raggedright\small
\NWtarget{nuweb376}{} $\langle\,${\itshape Generate destructive operation confirmation form}\nobreak\ {\footnotesize {376}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $concode = $ui->generatePassword(10);@\\
\mbox{}\verb@    my $consig = sha1_hex($concode . @\hbox{$\langle\,${\itshape Confirmation signature encoding suffix}\nobreak\ {\footnotesize \NWlink{nuweb4d}{4d}}$\,\rangle$}\verb@);@\\
\mbox{}\verb@    $consig =~ tr/a-f/FGJKQW/;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<table border="border" class="login">@\\
\mbox{}\verb@<tr><th>User Name:</th>@\\
\mbox{}\verb@    <td><input type="text" name="HDiet_username" size="60"@\\
\mbox{}\verb@               maxlength="@\hbox{$\langle\,${\itshape Maximum Text Input Field Length}\nobreak\ {\footnotesize \NWlink{nuweb11c}{11c}}$\,\rangle$}\verb@" value="" /></td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@<tr><th>Password:</th>@\\
\mbox{}\verb@    <td><input type="password" name="HDiet_password" size="60"@\\
\mbox{}\verb@               maxlength="@\hbox{$\langle\,${\itshape Maximum Text Input Field Length}\nobreak\ {\footnotesize \NWlink{nuweb11c}{11c}}$\,\rangle$}\verb@" value="" /></td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@<tr><th>Confirmation:</th>@\\
\mbox{}\verb@    <td><input type="text" name="HDiet_confirmation" size="15"@\\
\mbox{}\verb@               maxlength="15" value="" />@\\
\mbox{}\verb@        <span onmousedown="return false;" onmouseover="return false;">&nbsp;@\\
\mbox{}\verb@        Enter code <tt><b>$concode</b></tt> in the box at the left.</span></td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@</table>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb374}{374}\NWlink{nuweb380}{, 380}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@login@\nobreak\ \NWlink{nuweb121}{121}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Process database delete}

Perform the database delete operation requested by the above form.  Before
undertaking the deletion, we verify that the user name and password given
in the request form match those for the account, and that the signature
of the confirmation code matches that of the code the user was requested
to enter.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap508}\raggedright\small
\NWtarget{nuweb377}{} $\langle\,${\itshape Process database delete}\nobreak\ {\footnotesize {377}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Log Database Deletion", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $CGIargs{c} = '' if !defined($CGIargs{c});@\\
\mbox{}\verb@    $CGIargs{HDiet_confirmation} = '' if !$CGIargs{HDiet_confirmation};@\\
\mbox{}\verb@    my $consig = sha1_hex($CGIargs{HDiet_confirmation} . @\hbox{$\langle\,${\itshape Confirmation signature encoding suffix}\nobreak\ {\footnotesize \NWlink{nuweb4d}{4d}}$\,\rangle$}\verb@);@\\
\mbox{}\verb@    $consig =~ tr/a-f/FGJKQW/;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (($CGIargs{HDiet_username} ne $ui->{login_name}) ||@\\
\mbox{}\verb@        ($CGIargs{HDiet_password} ne $ui->{password})) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Reject deletion request when user name and password fail to match}\nobreak\ {\footnotesize \NWlink{nuweb378a}{378a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($consig ne $CGIargs{c}) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Reject deletion request when confirmation code fails to match}\nobreak\ {\footnotesize \NWlink{nuweb378b}{378b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        if (!$readOnly) {@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Backup user account before destructive operation}\nobreak\ {\footnotesize \NWlink{nuweb379a}{379a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@            my @{\tt @}\verb@months = $ui->enumerateMonths();@\\
\mbox{}\verb@            for my $m (@{\tt @}\verb@months) {@\\
\mbox{}\verb@                unlink("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$m.hdb") ||@\\
\mbox{}\verb@                   die("Cannot delete log file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$m.hdb");@\\
\mbox{}\verb@                clusterDelete("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$m.hdb");@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@@\\
\mbox{}\verb@            append_history($user_file_name, 12);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Generate confirmation of database deletion}\nobreak\ {\footnotesize \NWlink{nuweb379b}{379b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=account&amp;s=$session->{session_id}$tzOff">Back to account page</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb180a}{180a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@append_history@\nobreak\ \NWlink{nuweb397}{397}, \verb@enumerateMonths@\nobreak\ \NWlink{nuweb140}{140}, \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Reject deletion request when user name and password fail to match}

If the user name and password entered by the user to confirm the
database deletion fail to match, issue a message indicating this
is the case and reject the request.  A link back to the deletion
request page is provided in case the user wishes to try again.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap509}\raggedright\small
\NWtarget{nuweb378a}{} $\langle\,${\itshape Reject deletion request when user name and password fail to match}\nobreak\ {\footnotesize {378a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Log Database Deletion Rejected</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h3>The User Name and/or Password entered to confirm the log database@\\
\mbox{}\verb@deletion did not match those of your user account.</h3>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=wipedb&amp;s=$session->{session_id}$tzOff">Back@\\
\mbox{}\verb@    to Delete Log Database Request</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb377}{377}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Reject deletion request when confirmation code fails to match}

In addition to the user name and password, the user is required to
enter a pseudorandomly generated ``confirmation code'' to proceed with
the database deletion.  If the code entered fails to match, the
request is rejected.  A link back to the deletion request allows
the user to try again.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap510}\raggedright\small
\NWtarget{nuweb378b}{} $\langle\,${\itshape Reject deletion request when confirmation code fails to match}\nobreak\ {\footnotesize {378b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Log Database Deletion Rejected</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h3>The confirmation code entered for the deletion request did not match@\\
\mbox{}\verb@that given in the request form.</h3>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=wipedb&amp;s=$session->{session_id}$tzOff">Back@\\
\mbox{}\verb@    to Delete Log Database Request</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb377}{377}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Backup user account before destructive operation}

Before performing an operation which will result in irrevocable loss of
user account data, if ``Backups Directory'' is defined, we make a backup
of the user account prior to deletion of the data.  This allows us to
easily restore in cases of inadvertent deletion or errors in the
application which cause deletion without the user's express intent.
These backups should be purged by a CRON job after a decent interval
in the interest of user privacy.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap511}\raggedright\small
\NWtarget{nuweb379a}{} $\langle\,${\itshape Backup user account before destructive operation}\nobreak\ {\footnotesize {379a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $tfn = timeXML(time());@\\
\mbox{}\verb@    $tfn =~ s/:/./g;            # Avoid idiot tar treating time as hostname@\\
\mbox{}\verb@    if ("@\hbox{$\langle\,${\itshape Backups Directory}\nobreak\ {\footnotesize \NWlink{nuweb8b}{8b}}$\,\rangle$}\verb@" ne '') {@\\
\mbox{}\verb@        do_command("( cd @\hbox{$\langle\,${\itshape Backups Directory}\nobreak\ {\footnotesize \NWlink{nuweb8b}{8b}}$\,\rangle$}\verb@; tar cfj ${user_file_name}_" .@\\
\mbox{}\verb@            $tfn . ".bz2 -C ../Users $user_file_name )");@\\
\mbox{}\verb@        clusterCopy("@\hbox{$\langle\,${\itshape Backups Directory}\nobreak\ {\footnotesize \NWlink{nuweb8b}{8b}}$\,\rangle$}\verb@/${user_file_name}_$tfn.bz2");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb333}{333}\NWlink{nuweb335}{, 335}\NWlink{nuweb377}{, 377}\NWlink{nuweb382}{, 382}.
\item \NWtxtIdentsUsed\nobreak\  \verb@do_command@\nobreak\ \NWlink{nuweb406a}{406a}, \verb@timeXML@\nobreak\ \NWlink{nuweb443}{443}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Generate confirmation of database deletion}

Confirm to the user that the databases have been deleted and
provide links to proceed to account closure or, in the case
of second thoughts, database restoration.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap512}\raggedright\small
\NWtarget{nuweb379b}{} $\langle\,${\itshape Generate confirmation of database deletion}\nobreak\ {\footnotesize {379b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@<h1 class="c">All Log Databases Deleted</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@Pursuant to your request, all logs have been deleted from your database@\\
\mbox{}\verb@on The Hacker's Diet <em>Online</em>.  You can now@\\
\mbox{}\verb@<a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=closeaccount&amp;s=$session->{session_id}$tzOff">close your account</a>@\\
\mbox{}\verb@if you wish, or@\\
\mbox{}\verb@<a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=importcsv&amp;s=$session->{session_id}$tzOff">restore your database</a>@\\
\mbox{}\verb@from a backup copy you downloaded@\\
\mbox{}\verb@before deleting the database.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb377}{377}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Close this user account}

The user's account is closed, and all account-related data are deleted.
Before the account can be closed, the user must delete all logs from
the database.  We make this a separate operation to bring home to the user
just what is being lost.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap513}\raggedright\small
\NWtarget{nuweb380}{} $\langle\,${\itshape Close this user account}\nobreak\ {\footnotesize {380}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@months = $ui->enumerateMonths();@\\
\mbox{}\verb@    my $nmonths = $#months + 1;@\\
\mbox{}\verb@    my $mont = 'month' . (($nmonths != 1) ? 's' : '');@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Close User Account", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@     print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Close User Account</h1>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($nmonths > 0) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Reject request if logs remain in database}\nobreak\ {\footnotesize \NWlink{nuweb381a}{381a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $qun = quoteHTML($ui->{login_name});@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Warn user about consequences of closing account}\nobreak\ {\footnotesize \NWlink{nuweb381b}{381b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@<form id="Hdiet_wipedb" @\hbox{$\langle\,${\itshape Form processing action and method}\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$}\verb@>@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@If you wish to proceed with closing your account, please@\\
\mbox{}\verb@confirm by entering your user name and password in the fields@\\
\mbox{}\verb@below, and type the one-time &ldquo;confirmation code&rdquo;@\\
\mbox{}\verb@in the box.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Generate destructive operation confirmation form}\nobreak\ {\footnotesize \NWlink{nuweb376}{376}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<input type="hidden" name="s" value="$session->{session_id}" />@\\
\mbox{}\verb@<input type="hidden" name="c" value="$consig" />@\\
\mbox{}\verb@<input type="submit" class="darwin" name="q=do_closeaccount" value=" Close User Account&#xa;(Cannot be undone!) " />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="submit" name="q=account" value=" Cancel " />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb180a}{180a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@enumerateMonths@\nobreak\ \NWlink{nuweb140}{140}, \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Reject request if logs remain in database}

One or more monthly logs remain in the database.  Reject the
account close request and issue a message explaining why.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap514}\raggedright\small
\NWtarget{nuweb381a}{} $\langle\,${\itshape Reject request if logs remain in database}\nobreak\ {\footnotesize {381a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<h3>You have $nmonths $mont of logs in the database.  Before you can@\\
\mbox{}\verb@close your account, you must@\\
\mbox{}\verb@<a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=wipedb&amp;s=$session->{session_id}$tzOff">delete@\\
\mbox{}\verb@all of your logs</a> from the database.  Return here after the logs have been@\\
\mbox{}\verb@deleted.</h3>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb380}{380}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Warn user about consequences of closing account}

The following message reminds the user that closing the account
discards all preference settings and makes the account name
available to other users.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap515}\raggedright\small
\NWtarget{nuweb381b}{} $\langle\,${\itshape Warn user about consequences of closing account}\nobreak\ {\footnotesize {381b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@This page allows you to <span class="shrill">close your account</span>@\\
\mbox{}\verb@on The Hacker's Diet <em>Online</em>.  This will discard all the@\\
\mbox{}\verb@preferences you have specified for your account and make your@\\
\mbox{}\verb@present user name &ldquo;<b>$qun</b>&rdquo; available for@\\
\mbox{}\verb@creation of a new account by another person.  Note that there@\\
\mbox{}\verb@is no charge for maintaining an account, and that data are kept@\\
\mbox{}\verb@in your account indefinitely even if your account is inactive.@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb380}{380}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Process user account close}

The user has entered a close account request.  Validate the user name,
password, and confirmation code and, if all is well, delete everything
associated with the account.  Note that we must repeat the check for all
logs having been deleted first, since a malicious user may cobble up a
direct transaction request which bypasses the check in the usual request
page above, or save a request from earlier, then transmit it after
new logs have been created.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap516}\raggedright\small
\NWtarget{nuweb382}{} $\langle\,${\itshape Process user account close}\nobreak\ {\footnotesize {382}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve user account information}\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "User Account Close", undef, $session->{handheld});@\\
\mbox{}\verb@    generate_XHTML_navigation_bar($fh, $homeBase, $session->{session_id}, undef, undef, $browse_public, $timeZoneOffset);@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate assumed identity notification}\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $CGIargs{c} = '' if !defined($CGIargs{c});@\\
\mbox{}\verb@    $CGIargs{HDiet_confirmation} = '' if !$CGIargs{HDiet_confirmation};@\\
\mbox{}\verb@    my $consig = sha1_hex($CGIargs{HDiet_confirmation} . @\hbox{$\langle\,${\itshape Confirmation signature encoding suffix}\nobreak\ {\footnotesize \NWlink{nuweb4d}{4d}}$\,\rangle$}\verb@);@\\
\mbox{}\verb@    $consig =~ tr/a-f/FGJKQW/;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (($CGIargs{HDiet_username} ne $ui->{login_name}) ||@\\
\mbox{}\verb@        ($CGIargs{HDiet_password} ne $ui->{password})) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Reject account close for user name or password mismatch}\nobreak\ {\footnotesize \NWlink{nuweb383a}{383a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } elsif ($consig ne $CGIargs{c}) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Reject account close for confirmation code mismatch}\nobreak\ {\footnotesize \NWlink{nuweb383b}{383b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        my @{\tt @}\verb@months = $ui->enumerateMonths();@\\
\mbox{}\verb@        my $nmonths = $#months + 1;@\\
\mbox{}\verb@        if ($nmonths > 0) {@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Reject account close if logs remain in the database}\nobreak\ {\footnotesize \NWlink{nuweb384a}{384a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            if (!$readOnly) {@\\
\mbox{}\verb@                #   Delete active session file@\\
\mbox{}\verb@                unlink("@\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$CGIargs{s}.hds");@\\
\mbox{}\verb@                clusterDelete("@\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$CGIargs{s}.hds");@\\
\mbox{}\verb@                unlink("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/ActiveSession.hda");@\\
\mbox{}\verb@                clusterDelete("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/ActiveSession.hda");@\\
\mbox{}\verb@@\\
\mbox{}\verb@                @\hbox{$\langle\,${\itshape Backup user account before destructive operation}\nobreak\ {\footnotesize \NWlink{nuweb379a}{379a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@                #   At this point the user is logged out.  We can now delete@\\
\mbox{}\verb@                #   the user directory and all its contents.@\\
\mbox{}\verb@                do_command("rm -rf @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name");@\\
\mbox{}\verb@                clusterRecursiveDelete("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name");@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@@\\
\mbox{}\verb@            print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Account Closed</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="justified">@\\
\mbox{}\verb@Pursuant to your request, your account@\\
\mbox{}\verb@on The Hacker's Diet <em>Online</em> has been closed.  You can now@\\
\mbox{}\verb@<a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@/">log into another account</a>@\\
\mbox{}\verb@if you wish, or@\\
\mbox{}\verb@<a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=validate_user&amp;new=new_account$tzOff">create@\\
\mbox{}\verb@a new account</a>.  Otherwise, thank you for participating and farewell!@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb180a}{180a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@do_command@\nobreak\ \NWlink{nuweb406a}{406a}, \verb@enumerateMonths@\nobreak\ \NWlink{nuweb140}{140}, \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Reject account close for user name or password mismatch}

The user is required to confirm the account close by entering
their user name and password.  If the values entered do not match
those of the account, the request is rejected.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap517}\raggedright\small
\NWtarget{nuweb383a}{} $\langle\,${\itshape Reject account close for user name or password mismatch}\nobreak\ {\footnotesize {383a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">User Account Close Rejected</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h3>The User Name and/or Password entered to confirm the account@\\
\mbox{}\verb@close did not match those of your user account.</h3>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=closeaccount&amp;s=$session->{session_id}$tzOff">Back@\\
\mbox{}\verb@    to Close User Account Request</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb382}{382}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Reject account close for confirmation code mismatch}

To confirm the account close operation, the user is required to enter
a randomly generated ``confirmation code''.  If the code entered does
not match that supplied in the close account form, the request is
rejected.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap518}\raggedright\small
\NWtarget{nuweb383b}{} $\langle\,${\itshape Reject account close for confirmation code mismatch}\nobreak\ {\footnotesize {383b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">User Account Close Rejected</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h3>The confirmation code entered for the account close request did not match@\\
\mbox{}\verb@that given in the request form.</h3>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=closeaccount&amp;s=$session->{session_id}$tzOff">Back@\\
\mbox{}\verb@    to Close User Account Request</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb382}{382}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Reject account close if logs remain in the database}

All monthly logs must be deleted from the database before an
account may be closed.  If logs remain, reject the request.  This will
usually be caught when the account close request form is displayed,
but we must double-check here because the user may have directly
crafted a transaction which bypasses the request form or recorded
a previous request made before creating one or more new logs.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap519}\raggedright\small
\NWtarget{nuweb384a}{} $\langle\,${\itshape Reject account close if logs remain in the database}\nobreak\ {\footnotesize {384a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $mont = 'month' . (($nmonths != 1) ? 's' : '');@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">User Account Close Rejected</h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h3>You have $nmonths $mont of logs in the database.  Before you can@\\
\mbox{}\verb@close your account, you must@\\
\mbox{}\verb@<a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=wipedb&amp;s=$session->{session_id}$tzOff">delete@\\
\mbox{}\verb@all of your logs</a> from the database.  Return here after the logs have been@\\
\mbox{}\verb@deleted.</h3>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=closeaccount&amp;s=$session->{session_id}$tzOff">Back@\\
\mbox{}\verb@    to Close User Account Request</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb382}{382}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Generate test output page}

The following code generates the HTML result when the CGI program is
invoked with the ``test'' query.  The contents of this page will
vary as we use it to test various facilities under development.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap520}\raggedright\small
\NWtarget{nuweb384b}{} $\langle\,${\itshape Generate test output page}\nobreak\ {\footnotesize {384b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Emit diagnostic for undefined query}


\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap521}\raggedright\small
\NWtarget{nuweb385a}{} $\langle\,${\itshape Emit diagnostic for undefined query}\nobreak\ {\footnotesize {385a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Retrieve active session information}\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    write_XHTML_prologue($fh, $homeBase, "Undefined Query", undef, $session->{handheld});@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c">Undefined query: <tt>$CGIargs{q}</tt></h1>@\\
\mbox{}\verb@<h4 class="nav"><a href="@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?q=account&amp;s=$session->{session_id}$tzOff">Back to account page</a></h4>@\\
\mbox{}\verb@<pre>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Dump CGI environment and parsed arguments}\nobreak\ {\footnotesize \NWlink{nuweb385b}{385b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    print $fh <<"EOD";@\\
\mbox{}\verb@</pre>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    write_XHTML_epilogue($fh, $homeBase);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb179}{179}.
\item \NWtxtIdentsUsed\nobreak\  \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Dump CGI environment and parsed arguments}

The {\tt Data::Dumper} facility is used to dump the environment
variables passed when we were invoked as a CGI program and the
hash of arguments into which we parsed the arguments.  If you use
this in within HTML output, be sure it's within a
{\tt pre} sequence or the browser will mangle its rendering.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap522}\raggedright\small
\NWtarget{nuweb385b}{} $\langle\,${\itshape Dump CGI environment and parsed arguments}\nobreak\ {\footnotesize {385b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    use Data::Dumper;@\\
\mbox{}\verb@    print($fh Data::Dumper->Dump([\%CGIargs, \%ENV], ['*CGIargs', '*ENV']));@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb385a}{385a}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{JavaScript debugging console}


\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap523}\raggedright\small
\NWtarget{nuweb386a}{} $\langle\,${\itshape JavaScript debugging console}\nobreak\ {\footnotesize {386a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@print $fh <<"EOD";@\\
\mbox{}\verb@                      <h3>Debugging Console</h3>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<form id="debugging_console" action="#" onsubmit="return false;">@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p class="mlog_buttons">@\\
\mbox{}\verb@<textarea id="log" rows="6" cols="80">@\\
\mbox{}\verb@</textarea>@\\
\mbox{}\verb@<br />@\\
\mbox{}\verb@<input type="button" value=" Clear " onclick="document.getElementById('debugging_console').log.value = '';" />@\\
\mbox{}\verb@&nbsp;@\\
\mbox{}\verb@<input type="button" value=" Test " onclick="TestSomething();" />@\\
\mbox{}\verb@</p>@\\
\mbox{}\verb@</form>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h4 class="nav"><a href="javascript:">JavaScript Console</a></h4>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item {\NWtxtMacroNoRef}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Template}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap524}\raggedright\small
\NWtarget{nuweb386b}{} $\langle\,${\itshape Template}\nobreak\ {\footnotesize {386b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item {\NWtxtMacroNoRef}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\section{Global declarations}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap525}\raggedright\small
\NWtarget{nuweb387a}{} $\langle\,${\itshape Global declarations}\nobreak\ {\footnotesize {387a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Perl language modes}\nobreak\ {\footnotesize \NWlink{nuweb387b}{387b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use Time::Local;@\\
\mbox{}\verb@    use Encode qw(decode_utf8);@\\
\mbox{}\verb@    use GD;@\\
\mbox{}\verb@    use Digest::SHA1  qw(sha1_hex);@\\
\mbox{}\verb@    use XML::LibXML;@\\
\mbox{}\verb@    use XML::LibXML::Common qw(:w3c);       # XML/DOM node type mnemonics@\\
\mbox{}\verb@    use HDiet::Julian qw(MONTH_ABBREVIATIONS :DEFAULT);@\\
\mbox{}\verb@    use Socket qw(inet_aton);@\\
\mbox{}\verb@    use Sys::Syslog;@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use lib "@\hbox{$\langle\,${\itshape CGI Support Directory}\nobreak\ {\footnotesize \NWlink{nuweb6f}{6f}}$\,\rangle$}\verb@/Cgi";@\\
\mbox{}\verb@    use CGI;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use HDiet::Aggregator;@\\
\mbox{}\verb@    use HDiet::Cluster;@\\
\mbox{}\verb@    use HDiet::monthlog;@\\
\mbox{}\verb@    use HDiet::user;@\\
\mbox{}\verb@    use HDiet::history;@\\
\mbox{}\verb@    use HDiet::pubname;@\\
\mbox{}\verb@    use HDiet::session;@\\
\mbox{}\verb@    use HDiet::cookie;@\\
\mbox{}\verb@    use HDiet::hdCSV;@\\
\mbox{}\verb@    use HDiet::html;@\\
\mbox{}\verb@    use HDiet::xml;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use HDiet::Util::IDNA::Punycode;@\\
\mbox{}\verb@    use HDiet::Text::CSV;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Default parameter settings}\nobreak\ {\footnotesize \NWlink{nuweb388a}{388a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Global variables}\nobreak\ {\footnotesize \NWlink{nuweb388b}{388b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb173}{173}\NWlink{nuweb461}{, 461}.
\item \NWtxtIdentsUsed\nobreak\  \verb@html@\nobreak\ \NWlink{nuweb431}{431}, \verb@Julian@\nobreak\ \NWlink{nuweb445}{445}, \verb@xml@\nobreak\ \NWlink{nuweb440}{440}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
\section{Perl language modes}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap526}\raggedright\small
\NWtarget{nuweb387b}{} $\langle\,${\itshape Perl language modes}\nobreak\ {\footnotesize {387b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    require 5;@\\
\mbox{}\verb@    use strict;@\\
\mbox{}\verb@    use warnings;@\\
\mbox{}\verb@    use utf8;@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb15}{15}\NWlink{nuweb18}{, 18}\NWlink{nuweb23}{, 23}\NWlink{nuweb75}{, 75}\NWlink{nuweb114}{, 114}\NWlink{nuweb118}{, 118}\NWlink{nuweb148}{, 148}\NWlink{nuweb154}{, 154}\NWlink{nuweb163}{, 163}\NWlink{nuweb387a}{, 387a}\NWlink{nuweb415}{, 415}\NWlink{nuweb421a}{, 421a}\NWlink{nuweb431}{, 431}\NWlink{nuweb440}{, 440}\NWlink{nuweb445}{, 445}\NWlink{nuweb459}{, 459}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
\vbox{
\subsection{Default parameter settings}

The following variables contain parameters which control
the operation of the program.  All of these are defaults
which can be overridden by command line options.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap527}\raggedright\small
\NWtarget{nuweb388a}{} $\langle\,${\itshape Default parameter settings}\nobreak\ {\footnotesize {388a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb387a}{387a}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Global variables}

The following variables are global to the entire
{\tt main} program.  We could make many of
these more local, but the entire program is sufficiently
short and straightforward we'd probably only end up
obfuscating things in the interest of ``purity.''

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap528}\raggedright\small
\NWtarget{nuweb388b}{} $\langle\,${\itshape Global variables}\nobreak\ {\footnotesize {388b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    #   Processing arguments and options@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $verbose = 0;            # Verbose output for debugging@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $testmode = 0;           # Test mode: don't update real database@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   Handy constants@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my %mnames = split(/,/, "Jan,1,Feb,2,Mar,3,Apr,4,May,5,Jun,6,Jul,7,Aug,8,Sep,9,Oct,10,Nov,11,Dec,12");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    our @{\tt @}\verb@monthNames = (   "Zeroary",@\\
\mbox{}\verb@                           "January", "February", "March",@\\
\mbox{}\verb@                           "April", "May", "June",@\\
\mbox{}\verb@                           "July", "August", "September",@\\
\mbox{}\verb@                           "October", "November", "December"@\\
\mbox{}\verb@                     );@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@chartSizes = ( '320x240', '480x360', '512x384', '640x480', '800x600', '1024x768', '1200x900', '1600x1200' );@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@feedback_categories = ( @\hbox{$\langle\,${\itshape Categories of feedback messages}\nobreak\ {\footnotesize \NWlink{nuweb12a}{12a}}$\,\rangle$}\verb@ );@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb387a}{387a}.
\item \NWtxtIdentsDefed\nobreak\  \verb@$chartSizes@\nobreak\ \NWlink{nuweb301a}{301a}\NWlink{nuweb302c}{, 302c}, \verb@$feedback_categories@\nobreak\ \NWlink{nuweb367}{367}\NWlink{nuweb370}{, 370}, \verb@$mnames@\nobreak\ \NWtxtIdentsNotUsed, \verb@$monthNames@\nobreak\ \NWlink{nuweb208}{208}\NWlink{nuweb211}{, 211}\NWlink{nuweb222}{, 222}, \verb@$testmode@\nobreak\ \NWlink{nuweb389a}{389a}, \verb@$verbose@\nobreak\ \NWlink{nuweb389a}{389a}\NWlink{nuweb406a}{, 406a}\NWlink{nuweb421a}{, 421a}\NWlink{nuweb423b}{, 423b}\NWlink{nuweb425}{, 425}\NWlink{nuweb426}{, 426}\NWlink{nuweb429b}{, 429b}.\item \NWtxtIdentsUsed\nobreak\  \verb@verbose@\nobreak\ \NWlink{nuweb71}{71}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Process command line options}

We use the {\tt Getopt::Long} module to process command line
options.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap529}\raggedright\small
\NWtarget{nuweb389a}{} $\langle\,${\itshape Process command line options}\nobreak\ {\footnotesize {389a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    use Getopt::Long;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    GetOptions(@\\
\mbox{}\verb@                'copyright' => sub { print("This program is in the public domain.\n"); exit(0); },@\\
\mbox{}\verb@                'help' => sub { &print_command_line_help; exit(0); },@\\
\mbox{}\verb@                'test' => \$testmode,@\\
\mbox{}\verb@                'verbose' => \$verbose,@\\
\mbox{}\verb@                'version' => sub { print("Version @\hbox{$\langle\,${\itshape Version}\nobreak\ {\footnotesize \NWlink{nuweb3a}{3a}}$\,\rangle$}\verb@, @\hbox{$\langle\,${\itshape Release Date}\nobreak\ {\footnotesize \NWlink{nuweb3b}{3b}}$\,\rangle$}\verb@\n"); exit(0); }@\\
\mbox{}\verb@              );@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb173}{173}.
\item \NWtxtIdentsUsed\nobreak\  \verb@$testmode@\nobreak\ \NWlink{nuweb388b}{388b}, \verb@$verbose@\nobreak\ \NWlink{nuweb388b}{388b}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@print_command_line_help@\nobreak\ \NWlink{nuweb404}{404}, \verb@verbose@\nobreak\ \NWlink{nuweb71}{71}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Validate option specfications}

Validate the option specifications before we begin processing.
Pre-checking them avoids ugly pratfalls later on.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap530}\raggedright\small
\NWtarget{nuweb389b}{} $\langle\,${\itshape Validate option specifications}\nobreak\ {\footnotesize {389b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    {@\\
\mbox{}\verb@        my $ok = 1;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (!$ok) {@\\
\mbox{}\verb@            die("Invalid option specification(s)");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb173}{173}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{XHTML generation}

The following sections generate the XHTML result from a
transaction.  All of these write to a file handle named
\verb+$fh+, which should be set to the actual open UTF-8
file handle before using this code.  When running as a CGI
application, the file handle will be bound to {\tt STDOUT}.

}

\vbox{
\subsection{Mime Content-type specification}

When we're invoked as a CGI program, the MIME {\tt Content-type} must
be specified before the actual text is returned.  Although strictly
speaking, we should specify a type of ``{\tt application/xhtml+xml}''
for XHTML documents, many installed browsers do not handle this
properly, so we fib and claim it to be HTML, having carefully
fudged the syntax of the document to slip by benighted HTML-only
browsers.  Note that the header lines are terminated by both a
carriage return and line feed, as required by the standard.  In fact,
most browsers don't require the carriage return, but why violate
a standard and ask for trouble?

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap531}\raggedright\small
\NWtarget{nuweb390a}{} $\langle\,${\itshape MIME Content-type specification}\nobreak\ {\footnotesize {390a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print($fh "Content-type: text/html\r\n\r\n");@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb173}{173}\NWlink{nuweb207}{, 207}\NWlink{nuweb252}{, 252}\NWlink{nuweb262}{, 262}.
\item \NWtxtIdentsUsed\nobreak\  \verb@html@\nobreak\ \NWlink{nuweb431}{431}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Local time zone offset field}

In assorted circumstances we'd like to know the offset between the user's
local time zone and that of UTC.  This allows us, for example, to define
the ``current day'' in the user's time zone, not that of the prime meridian
or some other location, and cope with collectivist ``summer time'' schemes.

HTTP does not provide this information directly, so we employ the
following kludge.  In each form we send to the user, a hidden field
named ``\verb+HDiet_tzoffset+'' is embedded.  The JavaScript support
code run at document initialisation time calls a {\tt determineTimeZoneOffset()}
function which calculates the local offset from UTC in minutes and plugs it
into this field which is then submitted when the user transmits the form
for processing.  If JavaScript is unavailable or disabled, the field simply
retains its original value of ``{\tt unknown}'' and the server proceeds as
if local time were UTC.

If you have more than one form in your document and need to distinguish
the time zone offset fields (to avoid duplicating an {\tt id} field, which
is impermissible, you can pass a disambiguation string as a macro
argument which will be appended to the ID value.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap532}\raggedright\small
\NWtarget{nuweb390b}{} $\langle\,${\itshape Local time zone offset field}\nobreak\ {\footnotesize {390b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@<div><input type="hidden" name="HDiet_tzoffset" id="tzoffset@{\tt @}\verb@1" value="unknown" /></div>@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb125}{125}\NWlink{nuweb193}{, 193}\NWlink{nuweb198}{, 198}\NWlink{nuweb203}{, 203}\NWlink{nuweb208}{, 208}\NWlink{nuweb223}{, 223}\NWlink{nuweb225}{, 225}\NWlink{nuweb226a}{, 226a}\NWlink{nuweb227}{, 227}\NWlink{nuweb241}{, 241}\NWlink{nuweb250}{, 250}\NWlink{nuweb258}{, 258}\NWlink{nuweb270}{, 270}\NWlink{nuweb274}{, 274}\NWlink{nuweb295}{, 295}\NWlink{nuweb304a}{, 304a}\NWlink{nuweb310}{, 310}\NWlink{nuweb311}{, 311}\NWlink{nuweb315}{, 315}\NWlink{nuweb317}{, 317}\NWlink{nuweb322}{, 322}\NWlink{nuweb323}{, 323}\NWlink{nuweb325}{, 325}\NWlink{nuweb336}{, 336}\NWlink{nuweb343}{, 343}\NWlink{nuweb348}{, 348}\NWlink{nuweb358}{, 358}\NWlink{nuweb366}{, 366}\NWlink{nuweb374}{, 374}\NWlink{nuweb375b}{, 375b}\NWlink{nuweb380}{, 380}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Utility Functions}

The following utility functions are defined in the main program
context to handle matters such as command line processing.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap533}\raggedright\small
\NWtarget{nuweb391}{} $\langle\,${\itshape Utility functions}\nobreak\ {\footnotesize {391}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Propagate trend through user's monthly logs}\nobreak\ {\footnotesize \NWlink{nuweb392}{392}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Append entry to transaction history log}\nobreak\ {\footnotesize \NWlink{nuweb397}{397}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Update time of user's last transaction}\nobreak\ {\footnotesize \NWlink{nuweb398}{398}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Return time of user's last transaction}\nobreak\ {\footnotesize \NWlink{nuweb399a}{399a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Test whether user has a session active}\nobreak\ {\footnotesize \NWlink{nuweb400}{400}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Parse weight value}\nobreak\ {\footnotesize \NWlink{nuweb401}{401}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Parse signed weight value}\nobreak\ {\footnotesize \NWlink{nuweb402}{402}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Wrap long lines onto multiple lines}\nobreak\ {\footnotesize \NWlink{nuweb403}{403}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Print command line help information}\nobreak\ {\footnotesize \NWlink{nuweb404}{404}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Minimum, Maximum, and Sign functions}\nobreak\ {\footnotesize \NWlink{nuweb405}{405}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Execute system command}\nobreak\ {\footnotesize \NWlink{nuweb406a}{406a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Edit Unix time value to ISO 8601 local date and time}\nobreak\ {\footnotesize \NWlink{nuweb406b}{406b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Convert characters in a string to hexadecimal}\nobreak\ {\footnotesize \NWlink{nuweb407}{407}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Test if month is the current month}\nobreak\ {\footnotesize \NWlink{nuweb408}{408}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Encode international domain name}\nobreak\ {\footnotesize \NWlink{nuweb410}{410}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Test domain valid for E-mail}\nobreak\ {\footnotesize \NWlink{nuweb411}{411}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Draw text in a chart}\nobreak\ {\footnotesize \NWlink{nuweb409}{409}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Parse CGI arguments}\nobreak\ {\footnotesize \NWlink{nuweb412}{412}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Supply default values for undefined variables}\nobreak\ {\footnotesize \NWlink{nuweb413a}{413a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb173}{173}\NWlink{nuweb461}{, 461}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Propagate trend through user's monthly logs}

When a user changes a weight entry in a monthly log which is not
the most recent in the database for that user, we must propagate
the change in the trend at the end of the modified log to all
subsequent logs, adjusting the {\tt trend\_carry\_forward}
field in each log which permits calculation of trend values
for days within it in isolation.

The {\tt propagate\_trend} function performs this.  It is called
with the user's account information object and the year and month
of the log in which the change occurred in {\em yyyy}{\tt -}{\em mm}
format.  To recompute the trend carry-forward for all the logs for
a user, specify ``{\tt 0000-00}'' or simply omit the second
argument.  The optional third argument, if nonzero, forces the
conversion of all weight entries in the log into canonical form; it
can be used to clean up oddly formatted numbers and nugatory decimal
places which have crept into the database.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap534}\raggedright\small
\NWtarget{nuweb392}{} $\langle\,${\itshape Propagate trend through user's monthly logs}\nobreak\ {\footnotesize {392}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub propagate_trend {@\\
\mbox{}\verb@        my ($user, $first, $canon) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $first = '0000-00' if !defined($first) || ($first eq '');@\\
\mbox{}\verb@        $canon = 0 if !defined($canon);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my @{\tt @}\verb@logs = $user->enumerateMonths();@\\
\mbox{}\verb@        my $user_file_name = quoteUserName($user->{login_name});@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Identify log where recomputation begins}\nobreak\ {\footnotesize \NWlink{nuweb393a}{393a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Load first log into memory}\nobreak\ {\footnotesize \NWlink{nuweb393b}{393b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        for ($i = $ifirst + 1; $i <= $#logs; $i++) {@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Propagate trend to next log}\nobreak\ {\footnotesize \NWlink{nuweb394}{394}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($user->{badge_trend} != 0) {@\\
\mbox{}\verb@            open(FB, ">@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/BadgeImageNew.png") ||@\\
\mbox{}\verb@                die("Cannot update monthly log file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/BadgeImageNew.png");@\\
\mbox{}\verb@            my $hist = HDiet::history->new($user, $user_file_name);@\\
\mbox{}\verb@            $hist->drawBadgeImage(\*FB, $user->{badge_trend});@\\
\mbox{}\verb@            close(FB);@\\
\mbox{}\verb@            do_command("mv @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/BadgeImageNew.png @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/BadgeImage.png");@\\
\mbox{}\verb@            clusterCopy("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/BadgeImage.png");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@   }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb391}{391}.
\item \NWtxtIdentsDefed\nobreak\  \verb@propagate_trend@\nobreak\ \NWlink{nuweb220a}{220a}\NWlink{nuweb247}{, 247}\NWlink{nuweb359}{, 359}.\item \NWtxtIdentsUsed\nobreak\  \verb@do_command@\nobreak\ \NWlink{nuweb406a}{406a}, \verb@drawBadgeImage@\nobreak\ \NWlink{nuweb101a}{101a}, \verb@enumerateMonths@\nobreak\ \NWlink{nuweb140}{140}, \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Identify log where recomputation begins}

Now we scan the array containing the list of logs to find the
index for the month whose log item was modified.  We test
for this using an inequality in order to select the first log
when recomputation for all months has been selected.  We assume
that the trend carry-forward for this log is correct (or zero,
indicating no previous month, if this is the first month in
the database).

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap535}\raggedright\small
\NWtarget{nuweb393a}{} $\langle\,${\itshape Identify log where recomputation begins}\nobreak\ {\footnotesize {393a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $ifirst;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    for ($ifirst = 0; $ifirst <= $#logs; $ifirst++) {@\\
\mbox{}\verb@        if ($logs[$ifirst] ge $first) {@\\
\mbox{}\verb@            last;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb392}{392}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Load first log into memory}

We start the trend propagation by bringing the first log into
memory.  Note that loading the log causes its trend values to be
filled in.  We save the trend from the last day of the month as
the value to carry over into the next.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap536}\raggedright\small
\NWtarget{nuweb393b}{} $\langle\,${\itshape Load first log into memory}\nobreak\ {\footnotesize {393b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $mlog = HDiet::monthlog->new();@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $i = $ifirst;@\\
\mbox{}\verb@    open(FL, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$logs[$i].hdb") ||@\\
\mbox{}\verb@        die("Cannot open monthly log file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$logs[$i].hdb");@\\
\mbox{}\verb@    $mlog->load(\*FL);@\\
\mbox{}\verb@    close(FL);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($canon) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape If requested, canonicalise weight entries in log}\nobreak\ {\footnotesize \NWlink{nuweb396}{396}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Write modified log back to database}\nobreak\ {\footnotesize \NWlink{nuweb395b}{395b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $ltrend = $mlog->{trend}[$mlog->monthdays()];@\\
\mbox{}\verb@    my $lunit = $mlog->{log_unit};@\\
\mbox{}\verb@    undef($mlog);@\\
\mbox{}\verb@@\\
\mbox{}\verb@#print("First log: $logs[$ifirst]  Trend = $ltrend<br>\n");@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb392}{392}.
\item \NWtxtIdentsUsed\nobreak\  \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Propagate trend to next log}

For each subsequent log, we load it into memory, plug in the trend
from the last day of the previous log, and recompute its trend with the
new carry-forward.  Then we save the log with the new carry-forward
and get the trend from the last day to apply to the next log.  The
trend carry-forward is canonicalised to four decimal places with
insignificant trailing zeroes and decimal places removed.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap537}\raggedright\small
\NWtarget{nuweb394}{} $\langle\,${\itshape Propagate trend to next log}\nobreak\ {\footnotesize {394}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    $mlog = HDiet::monthlog->new();@\\
\mbox{}\verb@@\\
\mbox{}\verb@    open(FL, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$logs[$i].hdb") ||@\\
\mbox{}\verb@        die("Cannot open monthly log file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$logs[$i].hdb");@\\
\mbox{}\verb@    $mlog->load(\*FL);@\\
\mbox{}\verb@    close(FL);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Convert trend to weight unit in this log, if different}\nobreak\ {\footnotesize \NWlink{nuweb395a}{395a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $ltrend = 0 if !defined($ltrend);@\\
\mbox{}\verb@    $ltrend = sprintf("%.4f", $ltrend);@\\
\mbox{}\verb@    $ltrend =~ s/(\.[^0]*)0+$/$1/;@\\
\mbox{}\verb@    $ltrend =~ s/\.$//;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape If requested, canonicalise weight entries in log}\nobreak\ {\footnotesize \NWlink{nuweb396}{396}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@#print("Log: $logs[$i]  Trend = $ltrend, was $mlog->{trend_carry_forward}<br>\n");@\\
\mbox{}\verb@    $mlog->{trend_carry_forward} = $ltrend;@\\
\mbox{}\verb@    $mlog->computeTrend();@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Write modified log back to database}\nobreak\ {\footnotesize \NWlink{nuweb395b}{395b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $ltrend = $mlog->{trend}[$mlog->monthdays()];@\\
\mbox{}\verb@    undef($mlog);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb392}{392}.
\item \NWtxtIdentsUsed\nobreak\  \verb@computeTrend@\nobreak\ \NWlink{nuweb28}{28}, \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Convert trend to weight unit in this log, if different}

It may come to pass that logs in the database use different weight
units (for example, if the user has moved from an area where
one unit is prevalent to another, and changed his log unit
preference accordingly).  If the trend value we propagated
from the previous log is in a different unit than that used
in the present log, convert it to the current log's unit and
note the change in trend units for the next time around.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap538}\raggedright\small
\NWtarget{nuweb395a}{} $\langle\,${\itshape Convert trend to weight unit in this log, if different}\nobreak\ {\footnotesize {395a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($lunit != $mlog->{log_unit}) {@\\
\mbox{}\verb@        $ltrend *= WEIGHT_CONVERSION->[$lunit][$mlog->{log_unit}];@\\
\mbox{}\verb@#print("Log: $logs[$i]  Converted trend unit from $lunit to $mlog->{log_unit}<br>\n");@\\
\mbox{}\verb@        $lunit = $mlog->{log_unit};@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb394}{394}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{Write modified log back to database}

The current log is written back to the database directory.  The
{\tt last\_modification\_time} in the log is updated to the
current time.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap539}\raggedright\small
\NWtarget{nuweb395b}{} $\langle\,${\itshape Write modified log back to database}\nobreak\ {\footnotesize {395b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    $mlog->{last_modification_time} = time();@\\
\mbox{}\verb@    open(FL, ">:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$logs[$i].hdb") ||@\\
\mbox{}\verb@        die("Cannot create monthly log file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$logs[$i].hdb");@\\
\mbox{}\verb@    $mlog->save(\*FL);@\\
\mbox{}\verb@    close(FL);@\\
\mbox{}\verb@    clusterCopy("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/$logs[$i].hdb");@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb393b}{393b}\NWlink{nuweb394}{, 394}.
\item \NWtxtIdentsUsed\nobreak\  \verb@save@\nobreak\ \NWlink{nuweb31}{31}\NWlink{nuweb123}{, 123}\NWlink{nuweb151}{, 151}\NWlink{nuweb156b}{, 156b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\paragraph{If requested, canonicalise weight entries in log}

If requested by the \verb+$canon+ argument, swoop through the
weight entries in the log and transform them to canonical form
(as defined by {\tt monthlog::canonicalWeight}.  This can be
used to clean up ratty numbers which crept past our other
canonicalisation safeguards.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap540}\raggedright\small
\NWtarget{nuweb396}{} $\langle\,${\itshape If requested, canonicalise weight entries in log}\nobreak\ {\footnotesize {396}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($canon) {@\\
\mbox{}\verb@        my $ncanon = 0;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        for (my $j = 1; $j <= $mlog->monthdays(); $j++) {@\\
\mbox{}\verb@            if (defined($mlog->{weight}[$j]) && ($mlog->{weight}[$j] ne '')) {@\\
\mbox{}\verb@                my $cw = canonicalWeight($mlog->{weight}[$j]);@\\
\mbox{}\verb@                if ($cw ne $mlog->{weight}[$j]) {@\\
\mbox{}\verb@#print("Log: $logs[$i]  Day $j:  $mlog->{weight}[$j] ==> $cw<br>\n");@\\
\mbox{}\verb@                    $mlog->{weight}[$j] = $cw;@\\
\mbox{}\verb@                    $ncanon++;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($ncanon > 0) {@\\
\mbox{}\verb@#print("Log: $logs[$i]  $ncanon weight entries canonicalised.<br>\n");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb393b}{393b}\NWlink{nuweb394}{, 394}.
\item \NWtxtIdentsUsed\nobreak\  \verb@canonicalWeight@\nobreak\ \NWlink{nuweb42a}{42a}, \verb@monthdays@\nobreak\ \NWlink{nuweb69}{69}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Append entry to transaction history log}

An entry with the type given by the second argument is appended
to the {\tt History.hdh} log in the directory for the user specified
by the first argument, which must be the user name encoded as a file
name (we could do it here, but in fact everywhere this function is used
we already have the file-encoded user name available in a variable, so
why waste the time?).  The optional third argument, if specified and
nonblank, is appended to the history record with a leading comma.  This
allows additional fields to be added to the end of the log item, which
always begins with the type, \UNIX/ {\tt time} of the entry, and
the IP address of the client who submitted the transaction.

History log items are as follows:

\begin{center}
\begin{tabular}{|c|l|l|}
\hline
{\bf Type}    &   {\bf Transaction}     &   {\bf Extra fields} \\
\hline
1       &   Log in                      &  Handheld,Cookie \\
2       &   Log out                     &   \\
3       &   Session closed by log in    &   \\
4       &   Trend re-propagation        &  First month,Canonical weight \\
5       &   Monthly log update          &  Month,Total changes,weights,rungs,flags,comments \\
6       &   Password reset              &   \\
7       &   CSV import                  &  \parbox{8cm}{Format, Overwrite, Imported, Not~entry, No~overwrite, No~parse, Month, Changes,\ldots} \\
8       &   User account settings change &  Settings changed \\
9       &   Invalid password reset      &   \\
10      &   Failed login attempt        &   \\
11      &   User attempted administrator command &  Command \\
12      &   Delete all logs from database &   \\
13      &   Administrator force session close &  User file name \\
14      &   Administrator purge logs    &   Months purged \\
15      &   Diet calculator updated     &   \\
16      &   Feedback message sent       &   Category \\
17      &   Administrator deleted persistent login    &   User file name \\
18      &   Persistent logins cleared   &   Number cleared \\
19      &   Badge configuration changed &   Trend interval \\
\hline
\end{tabular}
\end{center}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap541}\raggedright\small
\NWtarget{nuweb397}{} $\langle\,${\itshape Append entry to transaction history log}\nobreak\ {\footnotesize {397}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub append_history {@\\
\mbox{}\verb@        my ($user_file, $type, $extra) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $extra = '' if !defined($extra);@\\
\mbox{}\verb@        if ($extra ne '') {@\\
\mbox{}\verb@            $extra = ',' . $extra;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        open(FH, ">>:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file/History.hdh") ||@\\
\mbox{}\verb@           die("Cannot append to history file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file/History.hdh");@\\
\mbox{}\verb@        print(FH "$type," . time() . ",$ENV{REMOTE_ADDR}$extra\n");@\\
\mbox{}\verb@        close(FH);@\\
\mbox{}\verb@        clusterCopy("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file/History.hdh");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb391}{391}.
\item \NWtxtIdentsDefed\nobreak\  \verb@append_history@\nobreak\ \NWlink{nuweb186a}{186a}\NWlink{nuweb186c}{c}\NWlink{nuweb188b}{, 188b}\NWlink{nuweb199}{, 199}\NWlink{nuweb200}{, 200}\NWlink{nuweb204}{, 204}\NWlink{nuweb220a}{, 220a}\NWlink{nuweb229}{, 229}\NWlink{nuweb246}{, 246}\NWlink{nuweb247}{, 247}\NWlink{nuweb293}{, 293}\NWlink{nuweb314}{, 314}\NWlink{nuweb316}{, 316}\NWlink{nuweb331}{, 331}\NWlink{nuweb333}{, 333}\NWlink{nuweb339}{, 339}\NWlink{nuweb340}{, 340}\NWlink{nuweb346}{, 346}\NWlink{nuweb370}{, 370}\NWlink{nuweb377}{, 377}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Update time of user's last transaction}

We keep track of the time and date of the last transaction processed
for a user in the {\tt LastTransaction.hdl} file in the user
directory.  This is a simple text file, with the first line a version
identifier (``{\tt 1}'' currently), and the second the \UNIX/ {\tt
time()} of the transaction.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap542}\raggedright\small
\NWtarget{nuweb398}{} $\langle\,${\itshape Update time of user's last transaction}\nobreak\ {\footnotesize {398}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub update_last_transaction {@\\
\mbox{}\verb@        my ($user_file) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   Update the date and time of the last transaction by this user@\\
\mbox{}\verb@        my $now = time();@\\
\mbox{}\verb@        open(FL, ">:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file/LastTransaction.hdl") ||@\\
\mbox{}\verb@            die("Cannot update last transaction file @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file/LastTransaction.hdl");@\\
\mbox{}\verb@        print FL <<"EOD";@\\
\mbox{}\verb@1@\\
\mbox{}\verb@$now@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@        close(FL);@\\
\mbox{}\verb@        clusterCopy("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file/LastTransaction.hdl");@\\
\mbox{}\verb@   }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb391}{391}.
\item \NWtxtIdentsDefed\nobreak\  \verb@update_last_transaction@\nobreak\ \NWlink{nuweb188a}{188a}\NWlink{nuweb220a}{, 220a}\NWlink{nuweb221}{, 221}\NWlink{nuweb224}{, 224}\NWlink{nuweb229}{, 229}\NWlink{nuweb246}{, 246}\NWlink{nuweb247}{, 247}\NWlink{nuweb262}{, 262}\NWlink{nuweb263a}{, 263a}\NWlink{nuweb264}{, 264}\NWlink{nuweb274}{, 274}\NWlink{nuweb293}{, 293}\NWlink{nuweb294}{, 294}\NWlink{nuweb303}{, 303}\NWlink{nuweb311}{, 311}\NWlink{nuweb312}{, 312}\NWlink{nuweb313}{, 313}\NWlink{nuweb316}{, 316}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Return time of user's last transaction}

Return the \UNIX/ {\tt time()} value of the last transaction made by
the user whose user file name is passed as the argument.  If the user
has no last transaction, a time of zero is returned.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap543}\raggedright\small
\NWtarget{nuweb399a}{} $\langle\,${\itshape Return time of user's last transaction}\nobreak\ {\footnotesize {399a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub last_transaction_time {@\\
\mbox{}\verb@        my ($user_file) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (open(FL, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file/LastTransaction.hdl")) {@\\
\mbox{}\verb@            my $lt = 0;@\\
\mbox{}\verb@            my $s = in(\*FL);@\\
\mbox{}\verb@            if ($s == 1) {          # Only proceed if version correct@\\
\mbox{}\verb@                $s = in(\*FL);@\\
\mbox{}\verb@                if ($s =~ m/^\d+$/) {@\\
\mbox{}\verb@                    $lt = $s;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            close(FL);@\\
\mbox{}\verb@            return $lt;@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            return 0;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@   }@\\
\mbox{}\verb@@\\
\mbox{}\verb@   @\hbox{$\langle\,${\itshape Read line from persistent object file}\nobreak\ ({\footnotesize 399b\label{scrap544}
 }\mbox{}\verb@main@ ) {\footnotesize \NWlink{nuweb413b}{413b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb391}{391}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Test whether user has a session active}

Check whether the user whose name is passed as the argument has
a session open.  This check assumes as little as possible about
the correctness of the database, and can be used by the administrative
routines to clean up messes.  It looks for an {\tt ActiveSession.hda}
file in the user's directory.  If one is present, it then reads the
session ID from it and attempts to retrieve the active session
file from the {\tt Sessions} directory.  If one is found, then the
user does, indeed, have a session active.  If no session file
exists, then this is an ``orphaned session'' due to a ``Lazarus file'',
mis-conceived restore, or some other vicissitude of computing.  We
delete the orphaned session and report no session open.  The converse
case, where there is a session file in the {\tt Sessions} directory
but no {\tt ActiveSession.hda} in the user directory poses no
problem, since the administrator terminate session facility will clean
this up.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap545}\raggedright\small
\NWtarget{nuweb400}{} $\langle\,${\itshape Test whether user has a session active}\nobreak\ {\footnotesize {400}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub is_user_session_open {@\\
\mbox{}\verb@        my ($user_name) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $user_file_name = quoteUserName($user_name);@\\
\mbox{}\verb@        if ((-f "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/ActiveSession.hda")@\\
\mbox{}\verb@            && open(FS, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/ActiveSession.hda")) {@\\
\mbox{}\verb@            my $asn = load_active_session(\*FS);@\\
\mbox{}\verb@            close(FS);@\\
\mbox{}\verb@            if (-f "@\hbox{$\langle\,${\itshape Session Directory}\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$}\verb@/$asn.hds") {@\\
\mbox{}\verb@                return 1;@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                unlink("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/ActiveSession.hda");@\\
\mbox{}\verb@                clusterDelete("@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/ActiveSession.hda");@\\
\mbox{}\verb@#print(STDERR "is_user_session_open abstergifying orphaned session @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/ActiveSession.hda\n");@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return 0;@\\
\mbox{}\verb@   }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb391}{391}.
\item \NWtxtIdentsDefed\nobreak\  \verb@is_user_session_open@\nobreak\ \NWlink{nuweb333}{333}\NWlink{nuweb335}{, 335}.\item \NWtxtIdentsUsed\nobreak\  \verb@load_active_session@\nobreak\ \NWlink{nuweb153a}{153a}, \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Parse weight value}

Parse a weight value given by the first string argument in the
unit given by the second.  If the unit is {\tt WEIGHT\_STONE},
the ``stones and pound'' syntax is accepted.  If an invalid weight
is specified {\tt undef} is returned.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap546}\raggedright\small
\NWtarget{nuweb401}{} $\langle\,${\itshape Parse weight value}\nobreak\ {\footnotesize {401}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub parseWeight {@\\
\mbox{}\verb@        my ($w, $unit) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $w =~ s/,/./g;@\\
\mbox{}\verb@        my $n;@\\
\mbox{}\verb@        if ($unit == WEIGHT_STONE) {@\\
\mbox{}\verb@            if ($w =~ m/^\s*(\d+)\s+(\d*\.?\d*)\s*$/) {@\\
\mbox{}\verb@                $n = ($1 * 14) + $2;@\\
\mbox{}\verb@            } elsif ($w =~ m/^\s*(\d*\.?\d*)\s*$/) {@\\
\mbox{}\verb@                $n = $1 * 14;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            if ($w =~ m/^\s*(\d*\.?\d*)\s*$/) {@\\
\mbox{}\verb@                $n = $1;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return $n;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb391}{391}.
\item \NWtxtIdentsDefed\nobreak\  \verb@parseWeight@\nobreak\ \NWlink{nuweb288b}{288b}\NWlink{nuweb289a}{, 289a}\NWlink{nuweb402}{, 402}\NWlink{nuweb485b}{, 485b}\NWlink{nuweb486}{, 486}\NWlink{nuweb488b}{, 488b}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb493b}{b}\NWlink{nuweb495}{, 495}\NWlink{nuweb497}{, 497}\NWlink{nuweb498}{, 498}\NWlink{nuweb500}{, 500}\NWlink{nuweb501}{, 501}\NWlink{nuweb506}{, 506}\NWlink{nuweb510b}{, 510b}.\item \NWtxtIdentsUsed\nobreak\  \verb@WEIGHT_STONE@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Parse signed weight value}

Parse a signed weight value from the first argument string in
the unit given by the second.  This is simply a wrapper for
{\tt parseWeight} which handles an optional prefix sign.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap547}\raggedright\small
\NWtarget{nuweb402}{} $\langle\,${\itshape Parse signed weight value}\nobreak\ {\footnotesize {402}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub parseSignedWeight {@\\
\mbox{}\verb@        my ($w, $unit) = @{\tt @}\verb@_;@\\
\mbox{}\verb@        my $sgn = 1;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($w =~ s/\s*([\+\-])//) {@\\
\mbox{}\verb@            if ($1 eq '-') {@\\
\mbox{}\verb@                $sgn = -1;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        my $v = parseWeight($w, $unit);@\\
\mbox{}\verb@        if (defined($v)) {@\\
\mbox{}\verb@            return $sgn * $v;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return undef;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb391}{391}.
\item \NWtxtIdentsDefed\nobreak\  \verb@parseSignedWeight@\nobreak\ \NWlink{nuweb289b}{289b}\NWlink{nuweb290a}{, 290a}\NWlink{nuweb486}{, 486}\NWlink{nuweb506}{, 506}.\item \NWtxtIdentsUsed\nobreak\  \verb@parseWeight@\nobreak\ \NWlink{nuweb401}{401}\NWlink{nuweb485b}{, 485b}, \verb@sgn@\nobreak\ \NWlink{nuweb405}{405}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Wrap long lines onto multiple lines}

Wrap text in the first argument (which may contain explicit line
breaks) so as not to exceed the maximum characters per line given by
the second argument.  If a line cannot be split due to absence of
white space break points, it is allowed to overflow the column limit.
Based upon the Perl module Text::Wrap by David Muir Sharnoff, much
simplified for use here.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap548}\raggedright\small
\NWtarget{nuweb403}{} $\langle\,${\itshape Wrap long lines onto multiple lines}\nobreak\ {\footnotesize {403}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub wrapText {@\\
\mbox{}\verb@        my ($t, $columns) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($ip, $xp) = ('', '');@\\
\mbox{}\verb@        my $break = '\s';@\\
\mbox{}\verb@        my $separator = "\n";@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $r = "";@\\
\mbox{}\verb@        my $tail = $t;@\\
\mbox{}\verb@        my $lead = $ip;@\\
\mbox{}\verb@        my $ll = $columns - length($ip) - 1;@\\
\mbox{}\verb@        my $nll = $columns - length($xp) - 1;@\\
\mbox{}\verb@        my $nl = "";@\\
\mbox{}\verb@        my $remainder = "";@\\
\mbox{}\verb@@\\
\mbox{}\verb@        pos($t) = 0;@\\
\mbox{}\verb@        while ($t !~ /\G\s*\Z/gc) {@\\
\mbox{}\verb@            if ($t =~ /\G([^\n]{0,$ll})($break|\z)/xmgc) {@\\
\mbox{}\verb@                $r .= $nl . $lead . $1;@\\
\mbox{}\verb@                $remainder = $2;@\\
\mbox{}\verb@            } elsif ($t =~ /\G([^\n]*?)($break|\z)/xmgc) {@\\
\mbox{}\verb@                $r .= $nl . $lead . $1;@\\
\mbox{}\verb@                $remainder = $2;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@@\\
\mbox{}\verb@            $lead = $xp;@\\
\mbox{}\verb@            $ll = $nll;@\\
\mbox{}\verb@            $nl = $separator;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $r .= $remainder;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $r .= $lead . substr($t, pos($t), length($t)-pos($t))@\\
\mbox{}\verb@                if pos($t) ne length($t);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $r;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb391}{391}.
\item \NWtxtIdentsDefed\nobreak\  \verb@wrapText@\nobreak\ \NWlink{nuweb368}{368}\NWlink{nuweb373}{, 373}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Print command line help information}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap549}\raggedright\small
\NWtarget{nuweb404}{} $\langle\,${\itshape Print command line help information}\nobreak\ {\footnotesize {404}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub print_command_line_help {@\\
\mbox{}\verb@        print << "EOD";@\\
\mbox{}\verb@Usage: HackDiet.pl [ options ]@\\
\mbox{}\verb@       Options:@\\
\mbox{}\verb@             --copyright     Print copyright information@\\
\mbox{}\verb@             --help          Print this message@\\
\mbox{}\verb@             --test          Test mode: do not actually block hosts@\\
\mbox{}\verb@             --verbose       Print verbose debugging information@\\
\mbox{}\verb@             --version       Print version number@\\
\mbox{}\verb@Version @\hbox{$\langle\,${\itshape Version}\nobreak\ {\footnotesize \NWlink{nuweb3a}{3a}}$\,\rangle$}\verb@, @\hbox{$\langle\,${\itshape Release Date}\nobreak\ {\footnotesize \NWlink{nuweb3b}{3b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@   }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb391}{391}.
\item \NWtxtIdentsDefed\nobreak\  \verb@print_command_line_help@\nobreak\ \NWlink{nuweb173}{173}\NWlink{nuweb389a}{, 389a}.\item \NWtxtIdentsUsed\nobreak\  \verb@verbose@\nobreak\ \NWlink{nuweb71}{71}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Minimum, Maximum, Sign, and Round functions}

The {\tt min} and {\tt max} functions return the largest and smallest
of their arbitrarily long list of arguments.  The {\tt sgn} function
returns 1 if the argument is positive, $-1$ if negative, and 0 if zero.
The {\tt round} function rounds a number to the nearest integer
(positive or negative).

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap550}\raggedright\small
\NWtarget{nuweb405}{} $\langle\,${\itshape Minimum, Maximum, and Sign functions}\nobreak\ {\footnotesize {405}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    #   Return least of arguments@\\
\mbox{}\verb@    sub min {@\\
\mbox{}\verb@        my $v = 1e308;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $a;@\\
\mbox{}\verb@        while (defined($a = shift())) {@\\
\mbox{}\verb@            $v = $a if $a < $v;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return $v;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   Return greatest of arguments@\\
\mbox{}\verb@    sub max {@\\
\mbox{}\verb@        my $v = -1e308;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $a;@\\
\mbox{}\verb@        while (defined($a = shift())) {@\\
\mbox{}\verb@            $v = $a if $a > $v;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return $v;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   Return sign of argument@\\
\mbox{}\verb@    sub sgn {@\\
\mbox{}\verb@        my $a = shift();@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return ($a == 0) ? 0 : (($a > 0) ? 1 : -1);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   Round number to nearest integer@\\
\mbox{}\verb@    sub round {@\\
\mbox{}\verb@        return sprintf("%.0f", shift());@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb23}{23}\NWlink{nuweb75}{, 75}\NWlink{nuweb391}{, 391}.
\item \NWtxtIdentsDefed\nobreak\  \verb@max@\nobreak\ \NWlink{nuweb19b}{19b}\NWlink{nuweb20a}{, 20a}\NWlink{nuweb21}{, 21}\NWlink{nuweb50}{, 50}\NWlink{nuweb52}{, 52}\NWlink{nuweb85}{, 85}\NWlink{nuweb86}{, 86}\NWlink{nuweb277a}{, 277a}\NWlink{nuweb297}{, 297}\NWlink{nuweb323}{, 323}\NWlink{nuweb497}{, 497}\NWlink{nuweb525}{, 525}, \verb@min@\nobreak\ \NWlink{nuweb19b}{19b}\NWlink{nuweb20a}{, 20a}\NWlink{nuweb21}{, 21}\NWlink{nuweb50}{, 50}\NWlink{nuweb52}{, 52}\NWlink{nuweb85}{, 85}\NWlink{nuweb86}{, 86}\NWlink{nuweb91}{, 91}\NWlink{nuweb209}{, 209}\NWlink{nuweb223}{, 223}\NWlink{nuweb262}{, 262}\NWlink{nuweb297}{, 297}\NWlink{nuweb323}{, 323}\NWlink{nuweb406b}{, 406b}\NWlink{nuweb425}{, 425}\NWlink{nuweb426}{, 426}\NWlink{nuweb449b}{, 449b}\NWlink{nuweb525}{, 525}, \verb@Round@\nobreak\ \NWlink{nuweb51}{51}\NWlink{nuweb446b}{, 446b}, \verb@sgn@\nobreak\ \NWlink{nuweb41a}{41a}\NWlink{nuweb54}{, 54}\NWlink{nuweb97}{, 97}\NWlink{nuweb142}{, 142}\NWlink{nuweb402}{, 402}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb486}{, 486}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Execute system command}

Run a system command unless we're in {\tt --test} mode, in which case we
just print the command on standard error.  An optional second argument
may supply an annotation to be prefixed to the command when it is
printed in {\tt --verbose} mode.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap551}\raggedright\small
\NWtarget{nuweb406a}{} $\langle\,${\itshape Execute system command}\nobreak\ {\footnotesize {406a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub do_command {@\\
\mbox{}\verb@        my ($cmd, $annotation) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($verbose) {@\\
\mbox{}\verb@            if (!defined($annotation)) {@\\
\mbox{}\verb@                $annotation = '';@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                $annotation .= ": ";@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            print(STDERR "$annotation$cmd\n");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (!$testmode) {@\\
\mbox{}\verb@            system($cmd);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb391}{391}.
\item \NWtxtIdentsDefed\nobreak\  \verb@do_command@\nobreak\ \NWlink{nuweb113a}{113a}\NWlink{nuweb220b}{, 220b}\NWlink{nuweb335}{, 335}\NWlink{nuweb379a}{, 379a}\NWlink{nuweb382}{, 382}\NWlink{nuweb392}{, 392}.\item \NWtxtIdentsUsed\nobreak\  \verb@$verbose@\nobreak\ \NWlink{nuweb388b}{388b}, \verb@verbose@\nobreak\ \NWlink{nuweb71}{71}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Edit Unix time value to ISO 8601 local date and time}

The Unix {\tt time()} value argument is edited to a string in the
ISO 8601 {\tt YYYY-MM-DD~HH:MM} format.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap552}\raggedright\small
\NWtarget{nuweb406b}{} $\langle\,${\itshape Edit Unix time value to ISO 8601 local date and time}\nobreak\ {\footnotesize {406b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@#    sub etime {@\\
\mbox{}\verb@#        my ($sec, $min, $hour, $mday, $mon, $year) = localtime($_[0]);@\\
\mbox{}\verb@#        return sprintf("%d-%02d-%02d %02d:%02d",@\\
\mbox{}\verb@#            $year + 1900, $mon + 1, $mday, $hour, $min);@\\
\mbox{}\verb@#    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb391}{391}.
\item \NWtxtIdentsDefed\nobreak\  \verb@etime@\nobreak\ \NWtxtIdentsNotUsed.\item \NWtxtIdentsUsed\nobreak\  \verb@min@\nobreak\ \NWlink{nuweb405}{405}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Convert characters in a string to hexadecimal}

The characters in the string argument are converted to space
separated two digit hexadecimal values if their code points
are 255 or less.  Unicode characters with higher code points
are output in as many hexadecimal digits as required to
represent them.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap553}\raggedright\small
\NWtarget{nuweb407}{} $\langle\,${\itshape Convert characters in a string to hexadecimal}\nobreak\ {\footnotesize {407}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub toHex {@\\
\mbox{}\verb@        my ($s) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $h = '';@\\
\mbox{}\verb@        while ($s =~ s/^(.)//s) {@\\
\mbox{}\verb@            $h .= sprintf("%02X ", ord($1));@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $h =~ s/\s$//;@\\
\mbox{}\verb@        return $h;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb391}{391}.
\item \NWtxtIdentsDefed\nobreak\  \verb@toHex@\nobreak\ \NWtxtIdentsNotUsed.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Test if month is the current month}

Estimate, being conservative based upon differences in time zone
between the user and the server, whether a month specified by
the year and date arguments, is the current month or a month in
the past.  This test is used only for optimising things such as
skipping the call on trend propagation when a change is made
to the current month's log, and the like.  It should never be
used in circumstances where the user will perceive different
behaviour, as opposed to internal optimisations.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap554}\raggedright\small
\NWtarget{nuweb408}{} $\langle\,${\itshape Test if month is the current month}\nobreak\ {\footnotesize {408}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub isCurrentMonth {@\\
\mbox{}\verb@        my ($lyear, $lmonth) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   Julian day at the server@\\
\mbox{}\verb@        my $server_jd = unix_time_to_jd(time());@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   JD at start of specified month@\\
\mbox{}\verb@        my $this_month_jd = gregorian_to_jd($lyear, $lmonth, 1);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        #   JD at start of next month@\\
\mbox{}\verb@        my ($nyear, $nmonth) = ($lyear, $lmonth + 1);@\\
\mbox{}\verb@        if ($lmonth >= 12) {@\\
\mbox{}\verb@            $lyear++;@\\
\mbox{}\verb@            $lmonth = 1;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        my $next_month_jd = gregorian_to_jd($nyear, $nmonth, 1);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return ($server_jd >= ($this_month_jd + 1)) &&@\\
\mbox{}\verb@               ($server_jd <= ($next_month_jd - 1));@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb391}{391}.
\item \NWtxtIdentsDefed\nobreak\  \verb@isCurrentMonth@\nobreak\ \NWtxtIdentsNotUsed.\item \NWtxtIdentsUsed\nobreak\  \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}, \verb@Julian@\nobreak\ \NWlink{nuweb445}{445}, \verb@start@\nobreak\ \NWlink{nuweb19b}{19b}, \verb@unix_time_to_jd@\nobreak\ \NWlink{nuweb450b}{450b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Draw text in a chart}

The specified \verb+$text+ is drawn into an open {\tt GD} \verb+$image+
with the specified size, angle, position, and colour.  The horizontal and
vertical alignment may be specified as follows.  The difference between the
``origin'' and the leftmost or bottom pixel is due to any
space between the origin point of the first character and the presence
of descenders in the typeset text.

\begin{center}
{\bf Horizontal Alignment}\\
\begin{tabular}{|c|l|}
\hline
{\bf Code}      &   \makebox[8em]{\bf Alignment}         \\
\hline
{\tt o}         &   Origin                  \\
{\tt l}         &   Leftmost pixel          \\
{\tt c}         &   Centre                  \\
{\tt r}         &   Rightmost pixel         \\
\hline
\end{tabular}
\end{center}

\begin{center}
{\bf Vertical Alignment}\\
\begin{tabular}{|c|l|}
\hline
{\bf Code}      &   \makebox[8em]{\bf Alignment}         \\
\hline
{\tt o}         &   Origin                  \\
{\tt b}         &   Bottom pixel            \\
{\tt c}         &   Centre                  \\
{\tt t}         &   Top pixel               \\
\hline
\end{tabular}
\end{center}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap555}\raggedright\small
\NWtarget{nuweb409}{} $\langle\,${\itshape Draw text in a chart}\nobreak\ {\footnotesize {409}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub drawText {@\\
\mbox{}\verb@        my ($img, $text, $font, $size, $angle, $x, $y, $alignh, $alignv, $colour) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $fontFile = "@\hbox{$\langle\,${\itshape TrueType Font Directory}\nobreak\ {\footnotesize \NWlink{nuweb6g}{6g}}$\,\rangle$}\verb@/$font.ttf";@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (($alignh ne 'o') || ($alignv ne 'o')) {@\\
\mbox{}\verb@            my @{\tt @}\verb@ext =  GD::Image->stringFT($colour, $fontFile, $size, $angle, $x, $y, $text);@\\
\mbox{}\verb@@\\
\mbox{}\verb@            if ($alignh eq 'l') {@\\
\mbox{}\verb@                $x -= ($ext[0] - $x);@\\
\mbox{}\verb@            } elsif ($alignh eq 'c') {@\\
\mbox{}\verb@                $x -= int(($ext[2] - $ext[0]) / 2);@\\
\mbox{}\verb@            } elsif ($alignh eq 'r') {@\\
\mbox{}\verb@                $x -= $ext[2] - $x;@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                die("drawText: invalid horizontal alignment '$alignh'") if $alignh ne 'o';@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@@\\
\mbox{}\verb@            if ($alignv eq 'b') {@\\
\mbox{}\verb@                $y -= ($ext[1] - $y);@\\
\mbox{}\verb@            } elsif ($alignv eq 'c') {@\\
\mbox{}\verb@                $y += int(($y - $ext[7]) / 2);@\\
\mbox{}\verb@            } elsif ($alignv eq 't') {@\\
\mbox{}\verb@                $y -= $ext[7] - $y;@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                die("drawText: invalid vertical alignment '$alignv'") if $alignv ne 'o';@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $img->stringFT($colour, $fontFile, $size, $angle, $x, $y, $text);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb391}{391}.
\item \NWtxtIdentsDefed\nobreak\  \verb@drawText@\nobreak\ \NWlink{nuweb48b}{48b}\NWlink{nuweb49}{, 49}\NWlink{nuweb55}{, 55}\NWlink{nuweb91}{, 91}\NWlink{nuweb92}{, 92}\NWlink{nuweb93}{, 93}\NWlink{nuweb94}{, 94}\NWlink{nuweb99}{, 99}\NWlink{nuweb100}{, 100}\NWlink{nuweb103a}{, 103a}\NWlink{nuweb103b}{b}\NWlink{nuweb104}{, 104}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Encode international domain name}

The argument is an Internet domain name which may (or may
not) contain non-ASCII characters which must be encoded
before querying a domain name server.  If any characters
which require such encoding are present, this function
encodes them according to RFC~3490 into the ``punycode'' representation.
Each dot-separated component of the domain name is
encoded separately.  An ASCII domain name or numeric
IP address specification is not modified by this function.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap556}\raggedright\small
\NWtarget{nuweb410}{} $\langle\,${\itshape Encode international domain name}\nobreak\ {\footnotesize {410}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub encodeDomainName {@\\
\mbox{}\verb@        my ($idn) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $dn = '';@\\
\mbox{}\verb@        my $w;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        foreach $w (split(/\./, $idn)) {@\\
\mbox{}\verb@            $dn .= encode_punycode($w) . '.';@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $dn =~ s/\.$//;@\\
\mbox{}\verb@        return $dn;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb391}{391}.
\item \NWtxtIdentsDefed\nobreak\  \verb@encodeDomainName@\nobreak\ \NWlink{nuweb305}{305}\NWlink{nuweb313}{, 313}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Test domain valid for E-mail}

Determine whether the argument is an Internet domain name which
is able to receive E-mail.  We use the ``{\tt dig}'' program to
retrieve the {\tt MX} (mail exchanger) records for the domain,
filter certain bogus results from parking services, and count
the number of records obtained.  If the domain has one or more
valid mail exchanger records, we deem it valid as an E-mail
destination.  If we find no {\tt MX} record, we test for
address {\tt A} records; this handles poorly-configured sites
which run a mail exchanger on port 25 but which have no
{\tt MX} record in their DNS configuration.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap557}\raggedright\small
\NWtarget{nuweb411}{} $\langle\,${\itshape Test domain valid for E-mail}\nobreak\ {\footnotesize {411}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub validMailDomain {@\\
\mbox{}\verb@        my ($dn) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $nmx = `dig +short $dn MX | egrep -v ' 127\.0\.0.' | wc -l`;@\\
\mbox{}\verb@        $nmx =~ s/\s//g;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($nmx == 0) {@\\
\mbox{}\verb@            $nmx = `dig +short $dn A | egrep -v ' 127\.0\.0.' | wc -l`;@\\
\mbox{}\verb@            $nmx =~ s/\s//g;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $nmx > 0;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb391}{391}.
\item \NWtxtIdentsDefed\nobreak\  \verb@validMailDomain@\nobreak\ \NWlink{nuweb305}{305}\NWlink{nuweb313}{, 313}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Parse CGI arguments}

When we are invoked as a CGI application by a Web server, the
arguments will be passed either in the ``\verb+QUERY_STRING+''
environment variable (for a ``{\tt get}'' request) or via standard
input (for a ``{\tt post}'' request).  The \verb+parse_cgi_arguments+
subroutine determines the request type, retrieves the arguments, and
decodes them into a hash keyed by the field name which gives the
decoded value of each.  The hash is returned as the result of the
subroutine.  If the document is encoded in UTF-8, field names and
values may contain Unicode characters.

If the form includes an uploaded file which should be processed as
a raw sequence of bytes, the request URL should include a query string
of ``{\tt ?enc=raw}'' (note that you can specify a query string on
the URL even if the form is performing a POST submission of multipart
form data).  This causes the standard input stream to be put into raw
mode, as opposed to UTF-8, and allows the uploaded file data to be
processed without passing through the usual UTF-8 decoder.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap558}\raggedright\small
\NWtarget{nuweb412}{} $\langle\,${\itshape Parse CGI arguments}\nobreak\ {\footnotesize {412}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub parse_cgi_arguments {@\\
\mbox{}\verb@        my $data;@\\
\mbox{}\verb@#   NOTE: On Perl 5.8.5 we needed to read the CGI POST arguments@\\
\mbox{}\verb@#   in UTF-8 mode.  On Perl 5.8.8 the decode_utf8() function@\\
\mbox{}\verb@#   appears to double-decode POST (but not GET arguments) unless@\\
\mbox{}\verb@#   we read the POST arguments in :raw mode.  I am not sure@\\
\mbox{}\verb@#   I understand this (and there is much conflicting information@\\
\mbox{}\verb@#   on this topic on the Web), but simply always reading STDIN@\\
\mbox{}\verb@#   in :raw appears to work, at least at the moment.@\\
\mbox{}\verb@#        if ($ENV{QUERY_STRING} =~ m/enc=raw/) {@\\
\mbox{}\verb@#            binmode(STDIN, ":raw");@\\
\mbox{}\verb@#        }@\\
\mbox{}\verb@        binmode(STDIN, ":raw");@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $query = new CGI;@\\
\mbox{}\verb@#print("Content-type: text/plain\r\n\r\nQuery:\n");@\\
\mbox{}\verb@#use Data::Dumper;@\\
\mbox{}\verb@#print(Dumper($query));@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my %CGIfields = $query->Vars();@\\
\mbox{}\verb@        my $uploaded = 0;@\\
\mbox{}\verb@        if ($CGIfields{uploaded_file}) {@\\
\mbox{}\verb@#print(STDERR "Uploading file...\n");@\\
\mbox{}\verb@            my $uploaded_content = '';@\\
\mbox{}\verb@@\\
\mbox{}\verb@            my $uf = $query->upload('uploaded_file');@\\
\mbox{}\verb@            while (<$uf>) {@\\
\mbox{}\verb@                $uploaded_content .= $_;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            close($uf);@\\
\mbox{}\verb@            $CGIfields{file} = $uploaded_content;@\\
\mbox{}\verb@            $uploaded = 1;@\\
\mbox{}\verb@#print(STDERR "Uploaded file of " . length($CGIfields{file}) . " bytes.\n");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@#   DECODE CGI ARGUMENTS FROM UTF-8.  THIS MAY BREAK POST AND@\\
\mbox{}\verb@#   NEEDS MORE RESEARCH.  SEE COMMENTS FOR 2007-03-21.@\\
\mbox{}\verb@for my $k (keys %CGIfields) {@\\
\mbox{}\verb@    if ($k eq 'file') {@\\
\mbox{}\verb@        #   IF ARGUMENT IS FILE, DO NOT DECODE FROM UTF-8.  THIS NEEDS@\\
\mbox{}\verb@        #   TO BE THOUGHT OUT.  WE MAY TRY DECODING AND USE THE DECODE@\\
\mbox{}\verb@        #   IF IT WORKS.@\\
\mbox{}\verb@#print(STDERR "Uploaded " . length($CGIfields{file}) . "\n");@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        $CGIfields{$k} = decode_utf8($CGIfields{$k});@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@#print(STDERR "Argument $k " . length($CGIfields{$k}) . " bytes.\n");@\\
\mbox{}\verb@}@\\
\mbox{}\verb@        return %CGIfields;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb391}{391}.
\item \NWtxtIdentsDefed\nobreak\  \verb@parse_cgi_arguments@\nobreak\ \NWlink{nuweb173}{173}.\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Supply default values for undefined variables}

To conserve memory, we frequently leave inapplicable fields
in the \verb+%Sessions+ hash undefined.  The following little
functions, whose names are pronounced ``not-defined zero'' and
``not-defined blank'' return their argument value if it is
defined and zero or the null string respectively if it is not.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap559}\raggedright\small
\NWtarget{nuweb413a}{} $\langle\,${\itshape Supply default values for undefined variables}\nobreak\ {\footnotesize {413a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub ndz {@\\
\mbox{}\verb@        return defined($_[0]) ? $_[0] : 0;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    sub ndb {@\\
\mbox{}\verb@        return defined($_[0]) ? $_[0] : '';@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb391}{391}.
\item \NWtxtIdentsDefed\nobreak\  \verb@ndb@\nobreak\ \NWtxtIdentsNotUsed, \verb@ndz@\nobreak\ \NWtxtIdentsNotUsed.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Read line from persistent object file}

All of our persistent objects store their data in text files containing
one line for each instance variable in the object.  The following macro
generates the {\tt in} function used to read the next item from one
of these files.  The macro is called with an argument which specifies
the name of the object, which is used in an error message if an unexpected
end of file is encountered.

The function is called with the first argument the file handle from
which the item is to be read.  The optional second argument specifies
the default value to be returned if an end of file is encountered.  If
no default is given and the end of file is encountered, the program will
abort with an error message.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap560}\raggedright\small
\NWtarget{nuweb413b}{} $\langle\,${\itshape Read line from persistent object file}\nobreak\ {\footnotesize {413b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub in {@\\
\mbox{}\verb@        my ($fh, $default) = @{\tt @}\verb@_;@\\
\mbox{}\verb@        my $s;@\\
\mbox{}\verb@        if ($s = <$fh>) {@\\
\mbox{}\verb@            $s =~ s/\s+$//;@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            if (defined($default)) {@\\
\mbox{}\verb@                $s = $default;@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                die("@{\tt @}\verb@1::in: Unexpected end of file");@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return $s;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb35a}{35a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}\NWlink{nuweb171a}{, 171a}\NWlink{nuweb399a}{, 399a}\NWlink{nuweb421a}{, 421a}.
\item \NWtxtIdentsDefed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb16}{16}\NWlink{nuweb17}{, 17}\NWlink{nuweb24}{, 24}\NWlink{nuweb27}{, 27}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb54}{, 54}\NWlink{nuweb75}{, 75}\NWlink{nuweb85}{, 85}\NWlink{nuweb94}{, 94}\NWlink{nuweb95}{, 95}\NWlink{nuweb97}{, 97}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb153a}{, 153a}\NWlink{nuweb157a}{, 157a}\NWlink{nuweb168}{, 168}\NWlink{nuweb171a}{, 171a}\NWlink{nuweb173}{, 173}\NWlink{nuweb198}{, 198}\NWlink{nuweb201}{, 201}\NWlink{nuweb209}{, 209}\NWlink{nuweb224}{, 224}\NWlink{nuweb226a}{, 226a}\NWlink{nuweb245}{, 245}\NWlink{nuweb261}{, 261}\NWlink{nuweb276b}{, 276b}\NWlink{nuweb277a}{, 277a}\NWlink{nuweb283}{, 283}\NWlink{nuweb286}{, 286}\NWlink{nuweb290b}{, 290b}\NWlink{nuweb291a}{, 291a}\NWlink{nuweb305}{, 305}\NWlink{nuweb310}{, 310}\NWlink{nuweb311}{, 311}\NWlink{nuweb312}{, 312}\NWlink{nuweb313}{, 313}\NWlink{nuweb315}{, 315}\NWlink{nuweb316}{, 316}\NWlink{nuweb317}{, 317}\NWlink{nuweb325}{, 325}\NWlink{nuweb335}{, 335}\NWlink{nuweb339}{, 339}\NWlink{nuweb348}{, 348}\NWlink{nuweb350}{, 350}\NWlink{nuweb351}{, 351}\NWlink{nuweb374}{, 374}\NWlink{nuweb376}{, 376}\NWlink{nuweb378b}{, 378b}\NWlink{nuweb380}{, 380}\NWlink{nuweb381a}{, 381a}\NWlink{nuweb381b}{b}\NWlink{nuweb383b}{, 383b}\NWlink{nuweb384a}{, 384a}\NWlink{nuweb389a}{, 389a}\NWlink{nuweb399a}{, 399a}\NWlink{nuweb412}{, 412}\NWlink{nuweb415}{, 415}\NWlink{nuweb425}{, 425}\NWlink{nuweb430a}{, 430a}\NWlink{nuweb455}{, 455}\NWlink{nuweb462}{, 462}\NWlink{nuweb481}{, 481}\NWlink{nuweb488b}{, 488b}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb497}{, 497}\NWlink{nuweb502}{, 502}\NWlink{nuweb503}{, 503}\NWlink{nuweb504}{, 504}\NWlink{nuweb517}{, 517}\NWlink{nuweb526}{, 526}\NWlink{nuweb530}{, 530}\NWlink{nuweb532}{, 532}\NWlink{nuweb535}{, 535}\NWlink{nuweb540}{, 540}\NWlink{nuweb544}{, 544}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

%     ____ _           _
%    / ___| |_   _ ___| |_ ___ _ __
%   | |   | | | | / __| __/ _ \ '__|
%   | |___| | |_| \__ \ ||  __/ |
%    \____|_|\__,_|___/\__\___|_|

\clearpage
\vbox{
\chapter{Cluster file system support}
\label{Cluster.pm}

Since we store all of our data in ordinary files in the host
file system, server cluster support is simply a matter of replicating
changes to these files made on one server to others in the cluster,
much as is done by {\tt rdist} for other server content.  (We could,
in fact, use {\tt rdist}, but it's a heavyweight solution in this
case, where we know precisely the changes we wish to make and are
informed immediately when changes are made on the local server.)

Every committed change to a local file or directory is accompanied
by a call on one of the methods of the {\tt Cluster} object which
queues a transaction to replicate the change on other servers in the
cluster.  The transactions are stored as files in a cluster synchronisation
directory, which are deleted as the transactions are completed.

The stand-alone {\tt ClusterSync.pl} program processes these transactions
by submitting {\tt scp} or {\tt ssh} commands.  It registers its process
ID in a file so that it can be notified of the queueing of new transactions
via {\tt USR1} signals.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap561}\raggedright\small
\NWtarget{nuweb415}{} \verb@"HDiet/Cluster.pm"@\nobreak\ {\footnotesize {415}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@#! @\hbox{$\langle\,${\itshape Perl directory}\nobreak\ {\footnotesize \NWlink{nuweb8d}{8d}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Perl language modes}\nobreak\ {\footnotesize \NWlink{nuweb387b}{387b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    package HDiet::Cluster;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use Time::HiRes qw( gettimeofday );@\\
\mbox{}\verb@    use Digest::SHA1  qw(sha1_hex);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    require Exporter;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    our @{\tt @}\verb@ISA = qw(Exporter);@\\
\mbox{}\verb@    our @{\tt @}\verb@EXPORT = qw( clusterConfiguration@\\
\mbox{}\verb@                       clusterCopy clusterDelete clusterMkdir clusterRmdir clusterRecursiveDelete );@\\
\mbox{}\verb@    our @{\tt @}\verb@EXPORT_OK = qw( command );@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@clusterHosts = qw (@\hbox{$\langle\,${\itshape Cluster Member Hosts}\nobreak\ {\footnotesize \NWlink{nuweb8f}{8f}}$\,\rangle$}\verb@);@\\
\mbox{}\verb@    my $hostname = $ENV{SERVER_NAME};@\\
\mbox{}\verb@#$hostname = "server0.fourmilab.ch" if !defined($hostname);@\\
\mbox{}\verb@    my $journal_sequence = 0;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    1;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use constant FILE_VERSION => 1;     # If you change this, change in ClusterSync.pl below also!@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb415}{415}\NWlink{nuweb416}{, 416}\NWlink{nuweb418}{, 418}\NWlink{nuweb419a}{, 419a}\NWlink{nuweb419b}{b}\NWlink{nuweb419c}{c}\NWlink{nuweb420a}{, 420a}\NWlink{nuweb420b}{b}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Display cluster configuration}

The current cluster configuration is printed on the file handle passed
as the argument, or {\tt STDOUT} if omitted.  If a cluster is configured,
the presence or absence of the cluster transaction directory and
each of its subsidiary cluster member subdirectories is checked
and reported.  For cluster member directories, the number of queued transaction
files is listed.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap562}\raggedright\small
\NWtarget{nuweb416}{} \verb@"HDiet/Cluster.pm"@\nobreak\ {\footnotesize {416}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub clusterConfiguration {@\\
\mbox{}\verb@        my ($outfile) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (!(defined $outfile)) {@\\
\mbox{}\verb@            $outfile = \*STDOUT;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        print($outfile "Host name: $hostname\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ("@\hbox{$\langle\,${\itshape Cluster Transaction Directory}\nobreak\ {\footnotesize \NWlink{nuweb8c}{8c}}$\,\rangle$}\verb@" eq '') {@\\
\mbox{}\verb@            print($outfile "Clustering disabled: Cluster Transaction Directory not specified\n");@\\
\mbox{}\verb@        } elsif ($#clusterHosts < 0) {@\\
\mbox{}\verb@            print($outfile "Clustering disabled: No Cluster Member Hosts configured\n");@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            print($outfile "Cluster members:");@\\
\mbox{}\verb@            for (my $i = 0; $i <= $#clusterHosts; $i++) {@\\
\mbox{}\verb@                print($outfile ' ');@\\
\mbox{}\verb@                if ($clusterHosts[$i] eq $hostname) {@\\
\mbox{}\verb@                    print($outfile '[');@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@                print($outfile $clusterHosts[$i]);@\\
\mbox{}\verb@                if ($clusterHosts[$i] eq $hostname) {@\\
\mbox{}\verb@                    print($outfile ']');@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            @\hbox{$\langle\,${\itshape Display summary of cluster transaction queue}\nobreak\ {\footnotesize \NWlink{nuweb417}{417}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb415}{415}\NWlink{nuweb416}{, 416}\NWlink{nuweb418}{, 418}\NWlink{nuweb419a}{, 419a}\NWlink{nuweb419b}{b}\NWlink{nuweb419c}{c}\NWlink{nuweb420a}{, 420a}\NWlink{nuweb420b}{b}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Display summary of cluster transaction queue}

Walk through the cluster transaction directory and, for each cluster
member other than ourselves, display the number of transactions
queued for that member.  Missing and unreadable directories are
reported.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap563}\raggedright\small
\NWtarget{nuweb417}{} $\langle\,${\itshape Display summary of cluster transaction queue}\nobreak\ {\footnotesize {417}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    print($outfile "\n");@\\
\mbox{}\verb@    print($outfile "Transaction directory: @\hbox{$\langle\,${\itshape Cluster Transaction Directory}\nobreak\ {\footnotesize \NWlink{nuweb8c}{8c}}$\,\rangle$}\verb@  ");@\\
\mbox{}\verb@    if (-d "@\hbox{$\langle\,${\itshape Cluster Transaction Directory}\nobreak\ {\footnotesize \NWlink{nuweb8c}{8c}}$\,\rangle$}\verb@") {@\\
\mbox{}\verb@        print($outfile "Exists\n");@\\
\mbox{}\verb@        for (my $i = 0; $i <= $#clusterHosts; $i++) {@\\
\mbox{}\verb@            if ($clusterHosts[$i] ne $hostname) {@\\
\mbox{}\verb@                print($outfile "  Server directory: @\hbox{$\langle\,${\itshape Cluster Transaction Directory}\nobreak\ {\footnotesize \NWlink{nuweb8c}{8c}}$\,\rangle$}\verb@/$clusterHosts[$i]: ");@\\
\mbox{}\verb@                if (-d "@\hbox{$\langle\,${\itshape Cluster Transaction Directory}\nobreak\ {\footnotesize \NWlink{nuweb8c}{8c}}$\,\rangle$}\verb@/$clusterHosts[$i]") {@\\
\mbox{}\verb@                    my $n = 0;@\\
\mbox{}\verb@                    if (opendir(DI, "@\hbox{$\langle\,${\itshape Cluster Transaction Directory}\nobreak\ {\footnotesize \NWlink{nuweb8c}{8c}}$\,\rangle$}\verb@/$clusterHosts[$i]")) {@\\
\mbox{}\verb@                        my $e;@\\
\mbox{}\verb@                        while ($e = readdir(DI)) {@\\
\mbox{}\verb@                            if ($e !~ m/^\./) {@\\
\mbox{}\verb@                                $n++;@\\
\mbox{}\verb@                            }@\\
\mbox{}\verb@                        }@\\
\mbox{}\verb@                        print($outfile "Queue length $n\n");@\\
\mbox{}\verb@                        closedir(DI);@\\
\mbox{}\verb@                    } else {@\\
\mbox{}\verb@                        print($outfile "*Unreadable*\n");@\\
\mbox{}\verb@                    }@\\
\mbox{}\verb@                } else {@\\
\mbox{}\verb@                    print($outfile "*Missing*\n");@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        print($outfile "*Missing*\n");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb416}{416}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Enqueue cluster synchronisation transaction}

A synchronisation transaction is queued for all cluster
hosts other than this one.  The first argument is the operation
name and the second is the file name within the Database Directory
upon which the operation is to be performed.  If the

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap564}\raggedright\small
\NWtarget{nuweb418}{} \verb@"HDiet/Cluster.pm"@\nobreak\ {\footnotesize {418}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub enqueueClusterTransaction {@\\
\mbox{}\verb@        my ($operation, $filename) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (("@\hbox{$\langle\,${\itshape Cluster Transaction Directory}\nobreak\ {\footnotesize \NWlink{nuweb8c}{8c}}$\,\rangle$}\verb@" ne '') &&@\\
\mbox{}\verb@            ($#clusterHosts >= 0) &&@\\
\mbox{}\verb@            (-d "@\hbox{$\langle\,${\itshape Cluster Transaction Directory}\nobreak\ {\footnotesize \NWlink{nuweb8c}{8c}}$\,\rangle$}\verb@")) {@\\
\mbox{}\verb@            my ($sec, $usec) = gettimeofday();@\\
\mbox{}\verb@            my $efn = $filename;@\\
\mbox{}\verb@            $efn =~ s:[\./]:_:g;@\\
\mbox{}\verb@            my $transname = sprintf("T%d%06d_%03d_%s_%s.hdc", $sec, $usec,@\\
\mbox{}\verb@                                ++$journal_sequence, $operation, $efn);@\\
\mbox{}\verb@            for (my $i = 0; $i <= $#clusterHosts; $i++) {@\\
\mbox{}\verb@                if ($clusterHosts[$i] ne $hostname) {@\\
\mbox{}\verb@                    if (-d "@\hbox{$\langle\,${\itshape Cluster Transaction Directory}\nobreak\ {\footnotesize \NWlink{nuweb8c}{8c}}$\,\rangle$}\verb@/$clusterHosts[$i]") {@\\
\mbox{}\verb@                        open(TO, ">:utf8", "@\hbox{$\langle\,${\itshape Cluster Transaction Directory}\nobreak\ {\footnotesize \NWlink{nuweb8c}{8c}}$\,\rangle$}\verb@/$clusterHosts[$i]/$transname") ||@\\
\mbox{}\verb@                            die("Unable to create cluster transaction " .@\\
\mbox{}\verb@                                "@\hbox{$\langle\,${\itshape Cluster Transaction Directory}\nobreak\ {\footnotesize \NWlink{nuweb8c}{8c}}$\,\rangle$}\verb@/$clusterHosts[$i]/$transname");@\\
\mbox{}\verb@                        print(TO FILE_VERSION . "\n");@\\
\mbox{}\verb@                        print(TO "$operation\n");@\\
\mbox{}\verb@                        print(TO "$filename\n");@\\
\mbox{}\verb@                        print(TO sha1_hex(FILE_VERSION . $operation . $filename .@\\
\mbox{}\verb@                            @\hbox{$\langle\,${\itshape Confirmation signature encoding suffix}\nobreak\ {\footnotesize \NWlink{nuweb4d}{4d}}$\,\rangle$}\verb@) . "\n");@\\
\mbox{}\verb@                        close(TO);@\\
\mbox{}\verb@                        if (open(PI, "<@\hbox{$\langle\,${\itshape Cluster Synchronisation Process ID File}\nobreak\ {\footnotesize \NWlink{nuweb9f}{9f}}$\,\rangle$}\verb@")) {@\\
\mbox{}\verb@                            my $syncpid = <PI>;@\\
\mbox{}\verb@                            close(PI);@\\
\mbox{}\verb@                            $syncpid =~ s/\s//g;@\\
\mbox{}\verb@                            kill('@\hbox{$\langle\,${\itshape Cluster Synchronisation Signal}\nobreak\ {\footnotesize \NWlink{nuweb9e}{9e}}$\,\rangle$}\verb@', $syncpid);@\\
\mbox{}\verb@#print(STDERR "Sending @\hbox{$\langle\,${\itshape Cluster Synchronisation Signal}\nobreak\ {\footnotesize \NWlink{nuweb9e}{9e}}$\,\rangle$}\verb@ to process $syncpid\n");@\\
\mbox{}\verb@                        } else {@\\
\mbox{}\verb@#print(STDERR "Cannot open @\hbox{$\langle\,${\itshape Cluster Synchronisation Process ID File}\nobreak\ {\footnotesize \NWlink{nuweb9f}{9f}}$\,\rangle$}\verb@\n");@\\
\mbox{}\verb@                        }@\\
\mbox{}\verb@                    }@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb415}{415}\NWlink{nuweb416}{, 416}\NWlink{nuweb418}{, 418}\NWlink{nuweb419a}{, 419a}\NWlink{nuweb419b}{b}\NWlink{nuweb419c}{c}\NWlink{nuweb420a}{, 420a}\NWlink{nuweb420b}{b}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Copy a file to the cluster members}

The file specified by the argument is copied to other members
of the cluster.  This, like the subsequent functions, simply
calls enqueueClusterTransaction with the appropriate
transaction code.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap565}\raggedright\small
\NWtarget{nuweb419a}{} \verb@"HDiet/Cluster.pm"@\nobreak\ {\footnotesize {419a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub clusterCopy {@\\
\mbox{}\verb@        my ($filename) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        enqueueClusterTransaction('copy', $filename);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb415}{415}\NWlink{nuweb416}{, 416}\NWlink{nuweb418}{, 418}\NWlink{nuweb419a}{, 419a}\NWlink{nuweb419b}{b}\NWlink{nuweb419c}{c}\NWlink{nuweb420a}{, 420a}\NWlink{nuweb420b}{b}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Delete a file from cluster members}

The file specified by the argument is deleted from other
members of the cluster.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap566}\raggedright\small
\NWtarget{nuweb419b}{} \verb@"HDiet/Cluster.pm"@\nobreak\ {\footnotesize {419b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub clusterDelete {@\\
\mbox{}\verb@        my ($filename) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        enqueueClusterTransaction('delete', $filename);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb415}{415}\NWlink{nuweb416}{, 416}\NWlink{nuweb418}{, 418}\NWlink{nuweb419a}{, 419a}\NWlink{nuweb419b}{b}\NWlink{nuweb419c}{c}\NWlink{nuweb420a}{, 420a}\NWlink{nuweb420b}{b}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Create a directory on cluster members}

A directory whose name is given by the argument is created
on the cluster members.  The parent directory must already
exist.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap567}\raggedright\small
\NWtarget{nuweb419c}{} \verb@"HDiet/Cluster.pm"@\nobreak\ {\footnotesize {419c}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub clusterMkdir {@\\
\mbox{}\verb@        my ($filename) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        enqueueClusterTransaction('mkdir', $filename);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb415}{415}\NWlink{nuweb416}{, 416}\NWlink{nuweb418}{, 418}\NWlink{nuweb419a}{, 419a}\NWlink{nuweb419b}{b}\NWlink{nuweb419c}{c}\NWlink{nuweb420a}{, 420a}\NWlink{nuweb420b}{b}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Delete a directory from cluster members}

The directory specified by the argument is deleted from other
members of the cluster.  The directory must be empty.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap568}\raggedright\small
\NWtarget{nuweb420a}{} \verb@"HDiet/Cluster.pm"@\nobreak\ {\footnotesize {420a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub clusterRmdir {@\\
\mbox{}\verb@        my ($filename) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        enqueueClusterTransaction('rmdir', $filename);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb415}{415}\NWlink{nuweb416}{, 416}\NWlink{nuweb418}{, 418}\NWlink{nuweb419a}{, 419a}\NWlink{nuweb419b}{b}\NWlink{nuweb419c}{c}\NWlink{nuweb420a}{, 420a}\NWlink{nuweb420b}{b}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Recursively delete a directory from cluster members}

The directory specified by the argument and all its contents
are recursively deleted from the cluster members.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap569}\raggedright\small
\NWtarget{nuweb420b}{} \verb@"HDiet/Cluster.pm"@\nobreak\ {\footnotesize {420b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub clusterRecursiveDelete {@\\
\mbox{}\verb@        my ($filename) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        enqueueClusterTransaction('rmrf', $filename);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb415}{415}\NWlink{nuweb416}{, 416}\NWlink{nuweb418}{, 418}\NWlink{nuweb419a}{, 419a}\NWlink{nuweb419b}{b}\NWlink{nuweb419c}{c}\NWlink{nuweb420a}{, 420a}\NWlink{nuweb420b}{b}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Cluster synchronisation process}

This stand-alone program performs synchronisation of changes
made on a cluster machine with other members of the cluster.
The program runs as an independent process.  It periodically
scans the cluster transaction directory and attempts to
apply them to the other cluster members.  It publishes
its process ID and accepts {\tt SIGUSR1} signals from
the transaction processor which cause it to immediately
process newly-queued transactions.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap570}\raggedright\small
\NWtarget{nuweb421a}{} \verb@"HDiet/ClusterSync.pl"@\nobreak\ {\footnotesize {421a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@#! @\hbox{$\langle\,${\itshape Perl directory}\nobreak\ {\footnotesize \NWlink{nuweb8d}{8d}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Perl language modes}\nobreak\ {\footnotesize \NWlink{nuweb387b}{387b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use File::Temp qw(tempfile);@\\
\mbox{}\verb@    use Digest::SHA1  qw(sha1_hex);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use constant FILE_VERSION => 1;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    binmode(STDOUT, ":utf8");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Assume group and user identity of cluster synchronisation process}\nobreak\ {\footnotesize \NWlink{nuweb422a}{422a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my @{\tt @}\verb@clusterHosts = qw (@\hbox{$\langle\,${\itshape Cluster Member Hosts}\nobreak\ {\footnotesize \NWlink{nuweb8f}{8f}}$\,\rangle$}\verb@);@\\
\mbox{}\verb@    my %failed_hosts;@\\
\mbox{}\verb@    my %failed_transactions;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $tranqueue = 0;@\\
\mbox{}\verb@    my ($logging, $cycleLog) = (0, 0);@\\
\mbox{}\verb@    $SIG{@\hbox{$\langle\,${\itshape Cluster Synchronisation Signal}\nobreak\ {\footnotesize \NWlink{nuweb9e}{9e}}$\,\rangle$}\verb@} = sub { $tranqueue++; };@\\
\mbox{}\verb@    $SIG{INT} = $SIG{TERM} =@\\
\mbox{}\verb@        sub {@\\
\mbox{}\verb@            unlink("@\hbox{$\langle\,${\itshape Cluster Synchronisation Process ID File}\nobreak\ {\footnotesize \NWlink{nuweb9f}{9f}}$\,\rangle$}\verb@");@\\
\mbox{}\verb@            close(LOG) if $logging;@\\
\mbox{}\verb@            exit(0);@\\
\mbox{}\verb@        };@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $verbose = 0;@\\
\mbox{}\verb@    my $nosync = 0;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    $| = 0 if $verbose;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Save process ID of cluster synchronisation job}\nobreak\ {\footnotesize \NWlink{nuweb422b}{422b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Activate cluster synchronisation log file if configured}\nobreak\ {\footnotesize \NWlink{nuweb423a}{423a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    while (1) {@\\
\mbox{}\verb@        my $transfound = 0;@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Cycle active log file if HUP signal received}\nobreak\ {\footnotesize \NWlink{nuweb423b}{423b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Process queued cluster synchronisation transactions}\nobreak\ {\footnotesize \NWlink{nuweb424}{424}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        if ($transfound == 0) {@\\
\mbox{}\verb@            select(undef, undef, undef, @\hbox{$\langle\,${\itshape Cluster Synchronisation Time Interval}\nobreak\ {\footnotesize \NWlink{nuweb9a}{9a}}$\,\rangle$}\verb@);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Read line from persistent object file}\nobreak\ ({\footnotesize 421b\label{scrap571}
 }\mbox{}\verb@ClusterSync@ ) {\footnotesize \NWlink{nuweb413b}{413b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb421a}{421a}\NWlink{nuweb428}{, 428}\NWlink{nuweb429b}{, 429b}\NWlink{nuweb430a}{, 430a}\NWlink{nuweb430b}{b}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Assume group and user identity of cluster synchronisation process}

If we were started as super-user and we've been configured to run
under another identity, set our real and effective group and user ID
to the configured values.  If not started as super-user, no identity
change is made, nor is a change made if the configured identity is
the null string.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap572}\raggedright\small
\NWtarget{nuweb422a}{} $\langle\,${\itshape Assume group and user identity of cluster synchronisation process}\nobreak\ {\footnotesize {422a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (($> == 0) && (($) + 0) == 0)) {@\\
\mbox{}\verb@        if ("@\hbox{$\langle\,${\itshape Cluster Synchronisation Group ID}\nobreak\ {\footnotesize \NWlink{nuweb10c}{10c}}$\,\rangle$}\verb@" ne '') {@\\
\mbox{}\verb@            my $gid = getgrnam("@\hbox{$\langle\,${\itshape Cluster Synchronisation Group ID}\nobreak\ {\footnotesize \NWlink{nuweb10c}{10c}}$\,\rangle$}\verb@");@\\
\mbox{}\verb@            $( = $gid;@\\
\mbox{}\verb@            $) = "$gid $gid";@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if ("@\hbox{$\langle\,${\itshape Cluster Synchronisation User ID}\nobreak\ {\footnotesize \NWlink{nuweb10b}{10b}}$\,\rangle$}\verb@" ne '') {@\\
\mbox{}\verb@            my $uid = getpwnam("@\hbox{$\langle\,${\itshape Cluster Synchronisation User ID}\nobreak\ {\footnotesize \NWlink{nuweb10b}{10b}}$\,\rangle$}\verb@");@\\
\mbox{}\verb@            $< = $uid;@\\
\mbox{}\verb@            $> = $uid;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@#print("UID: $< $> GID: $( $) $$\n");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@#else { print("Not started as root.\n"); }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb421a}{421a}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Save process ID of cluster synchronisation job}

The process ID of the cluster synchronisation job is saved in the
designated file so that signals may be sent to notify it when new
transactions are queued.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap573}\raggedright\small
\NWtarget{nuweb422b}{} $\langle\,${\itshape Save process ID of cluster synchronisation job}\nobreak\ {\footnotesize {422b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    open(PIDF, ">@\hbox{$\langle\,${\itshape Cluster Synchronisation Process ID File}\nobreak\ {\footnotesize \NWlink{nuweb9f}{9f}}$\,\rangle$}\verb@") ||@\\
\mbox{}\verb@        die("Cannot create @\hbox{$\langle\,${\itshape Cluster Synchronisation Process ID File}\nobreak\ {\footnotesize \NWlink{nuweb9f}{9f}}$\,\rangle$}\verb@");@\\
\mbox{}\verb@    print(PIDF "$$\n");@\\
\mbox{}\verb@    close(PIDF);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb421a}{421a}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Activate cluster synchronisation log file if configured}

If a cluster synchronisation log file is configured, it is
opened (or created if not previously existing) in append
mode.  The variable \verb+$logging+ is set to enable the
generation of output to the log.  When logging, we listen
for the {\tt HUP} signal and, upon receiving it, close
and re-open the log file to permit cycling it by renaming
the existing file and then signalling this program.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap574}\raggedright\small
\NWtarget{nuweb423a}{} $\langle\,${\itshape Activate cluster synchronisation log file if configured}\nobreak\ {\footnotesize {423a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ("@\hbox{$\langle\,${\itshape Cluster Synchronisation Log File}\nobreak\ {\footnotesize \NWlink{nuweb10a}{10a}}$\,\rangle$}\verb@" ne '') {@\\
\mbox{}\verb@        open(LOG, ">>@\hbox{$\langle\,${\itshape Cluster Synchronisation Log File}\nobreak\ {\footnotesize \NWlink{nuweb10a}{10a}}$\,\rangle$}\verb@") ||@\\
\mbox{}\verb@            die("ClusterSync: Unable to open log file @\hbox{$\langle\,${\itshape Cluster Synchronisation Log File}\nobreak\ {\footnotesize \NWlink{nuweb10a}{10a}}$\,\rangle$}\verb@");@\\
\mbox{}\verb@        my $oldfh = select LOG; $| = 1; select $oldfh;@\\
\mbox{}\verb@        $logging = 1;@\\
\mbox{}\verb@        $SIG{HUP} =@\\
\mbox{}\verb@            sub {@\\
\mbox{}\verb@                $cycleLog = 1;@\\
\mbox{}\verb@            };@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb421a}{421a}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Cycle active log file if {\tt HUP} signal received}

If we receive the {\tt HUP} signal while logging is enabled, the
variable \verb+$cycleLog+ is set from the signal handler and
on the subsequent pass through the transaction processor we close
and re-open the log file to allow it to be rotated by renaming
it before sending the signal.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap575}\raggedright\small
\NWtarget{nuweb423b}{} $\langle\,${\itshape Cycle active log file if HUP signal received}\nobreak\ {\footnotesize {423b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($cycleLog) {@\\
\mbox{}\verb@        close(LOG);@\\
\mbox{}\verb@        open(LOG, ">>@\hbox{$\langle\,${\itshape Cluster Synchronisation Log File}\nobreak\ {\footnotesize \NWlink{nuweb10a}{10a}}$\,\rangle$}\verb@") ||@\\
\mbox{}\verb@            die("ClusterSync: Unable to reopen log file @\hbox{$\langle\,${\itshape Cluster Synchronisation Log File}\nobreak\ {\footnotesize \NWlink{nuweb10a}{10a}}$\,\rangle$}\verb@");@\\
\mbox{}\verb@        my $oldfh = select LOG; $| = 1; select $oldfh;@\\
\mbox{}\verb@        $cycleLog = 0;@\\
\mbox{}\verb@        print("ClusterSync: Log file cycled.\n") if $verbose;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb421a}{421a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@$verbose@\nobreak\ \NWlink{nuweb388b}{388b}, \verb@verbose@\nobreak\ \NWlink{nuweb71}{71}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Process queued cluster synchronisation transactions}

Walk through the cluster transaction directory and process
the queued transactions.  The transactions are sorted by
file name which, given the naming scheme we use, guarantees
that we'll execute them in the order they were queued.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap576}\raggedright\small
\NWtarget{nuweb424}{} $\langle\,${\itshape Process queued cluster synchronisation transactions}\nobreak\ {\footnotesize {424}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (-d "@\hbox{$\langle\,${\itshape Cluster Transaction Directory}\nobreak\ {\footnotesize \NWlink{nuweb8c}{8c}}$\,\rangle$}\verb@") {@\\
\mbox{}\verb@        for (my $i = 0; $i <= $#clusterHosts; $i++) {@\\
\mbox{}\verb@            my $destHost = $clusterHosts[$i];@\\
\mbox{}\verb@            if (defined $failed_hosts{$destHost}) {@\\
\mbox{}\verb@                if (time() > $failed_hosts{$destHost}) {@\\
\mbox{}\verb@                    undef($failed_hosts{$destHost});@\\
\mbox{}\verb@                    logmsg("Removing $destHost from failed hosts list.");@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@@\\
\mbox{}\verb@            if ((-d "@\hbox{$\langle\,${\itshape Cluster Transaction Directory}\nobreak\ {\footnotesize \NWlink{nuweb8c}{8c}}$\,\rangle$}\verb@/$destHost") &&@\\
\mbox{}\verb@                (!defined($failed_hosts{$destHost}))) {@\\
\mbox{}\verb@                if (opendir(DI, "@\hbox{$\langle\,${\itshape Cluster Transaction Directory}\nobreak\ {\footnotesize \NWlink{nuweb8c}{8c}}$\,\rangle$}\verb@/$destHost")) {@\\
\mbox{}\verb@                    my @{\tt @}\verb@transactions = sort(grep(/\.hdc$/, readdir(DI)));@\\
\mbox{}\verb@@\\
\mbox{}\verb@                    for my $t (@{\tt @}\verb@transactions) {@\\
\mbox{}\verb@                        $t = untaint($t);@\\
\mbox{}\verb@                        if (defined($failed_hosts{$destHost})) {@\\
\mbox{}\verb@                            last;@\\
\mbox{}\verb@                        }@\\
\mbox{}\verb@                        my $transfile = "@\hbox{$\langle\,${\itshape Cluster Transaction Directory}\nobreak\ {\footnotesize \NWlink{nuweb8c}{8c}}$\,\rangle$}\verb@/$destHost/$t";@\\
\mbox{}\verb@                        if (defined($failed_transactions{$t})) {@\\
\mbox{}\verb@                            @\hbox{$\langle\,${\itshape Determine if failed transaction should be retried}\nobreak\ {\footnotesize \NWlink{nuweb427}{427}}$\,\rangle$}\verb@@\\
\mbox{}\verb@                        }@\\
\mbox{}\verb@                        eval {@\\
\mbox{}\verb@                            @\hbox{$\langle\,${\itshape Execute cluster synchronisation transaction}\nobreak\ {\footnotesize \NWlink{nuweb425}{425}}$\,\rangle$}\verb@@\\
\mbox{}\verb@                        };@\\
\mbox{}\verb@                        if ($@{\tt @}\verb@) {@\\
\mbox{}\verb@                            @\hbox{$\langle\,${\itshape Recover from failure of a cluster synchronisation transaction}\nobreak\ {\footnotesize \NWlink{nuweb426}{426}}$\,\rangle$}\verb@@\\
\mbox{}\verb@                        } else {@\\
\mbox{}\verb@                            $transfound++;@\\
\mbox{}\verb@                            undef($failed_transactions{$t}) if defined $failed_transactions{$t};@\\
\mbox{}\verb@                        }@\\
\mbox{}\verb@                    }@\\
\mbox{}\verb@                    closedir(DI);@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb421a}{421a}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Execute cluster synchronisation transaction}

The cluster synchronisation transaction is executed by performing
an {\tt scp} or {\tt ssh} command to effect the change on the local
machine on the cluster host.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap577}\raggedright\small
\NWtarget{nuweb425}{} $\langle\,${\itshape Execute cluster synchronisation transaction}\nobreak\ {\footnotesize {425}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    open(FI, "<:utf8", $transfile) ||@\\
\mbox{}\verb@        die("ClusterSync: Unable to open $transfile");@\\
\mbox{}\verb@    my $file_version = in(\*FI);@\\
\mbox{}\verb@    if ($file_version != FILE_VERSION) {@\\
\mbox{}\verb@        die("ClusterSync: Invalid file version in $transfile");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    my $transaction = in(\*FI);@\\
\mbox{}\verb@    my $filename = in(\*FI);@\\
\mbox{}\verb@    my $signature = in(\*FI);@\\
\mbox{}\verb@    close(FI);@\\
\mbox{}\verb@    if ($verbose || $logging) {@\\
\mbox{}\verb@        my ($sec, $min, $hour, $mday, $mon, $year) = localtime(time());@\\
\mbox{}\verb@        my $dt = sprintf("%04d-%02d-%02d %02d:%02d",@\\
\mbox{}\verb@            $year + 1900,, $mon + 1, $mday, $hour, $min);@\\
\mbox{}\verb@        my $lm = "$dt $clusterHosts[$i]: $t\n" .@\\
\mbox{}\verb@                 "        Ver: $file_version\n" .@\\
\mbox{}\verb@                 "        Transaction: $transaction\n" .@\\
\mbox{}\verb@                 "        File: $filename";@\\
\mbox{}\verb@        logmsg("$lm");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    if (sha1_hex($file_version . $transaction . $filename .@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Confirmation signature encoding suffix}\nobreak\ {\footnotesize \NWlink{nuweb4d}{4d}}$\,\rangle$}\verb@) ne $signature) {@\\
\mbox{}\verb@        die("ClusterSync: Invalid signature in transaction");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    if ($filename !~ m:^@\hbox{$\langle\,${\itshape Database Directory}\nobreak\ {\footnotesize \NWlink{nuweb7d}{7d}}$\,\rangle$}\verb@:) {@\\
\mbox{}\verb@        die("ClusterSync: Bogus file name ($filename) in transaction");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    if (($filename =~ m/[;<>|#\$\*\?]/) || ($filename =~ m/\.\./)) {@\\
\mbox{}\verb@        die("ClusterSync: Abusive character in file name ($filename) in transaction");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $res;@\\
\mbox{}\verb@    if ($transaction eq 'copy') {@\\
\mbox{}\verb@        $res = syncCommand("scp -q -p '$filename' '$destHost:$filename'",@\\
\mbox{}\verb@            $destHost, $transfile);@\\
\mbox{}\verb@    } elsif ($transaction eq 'delete') {@\\
\mbox{}\verb@        $res = syncCommand("ssh $destHost \"rm '$filename'\"",@\\
\mbox{}\verb@            $destHost, $transfile);@\\
\mbox{}\verb@    } elsif ($transaction eq 'mkdir') {@\\
\mbox{}\verb@        $res = syncCommand("ssh $destHost \"mkdir '$filename'\"",@\\
\mbox{}\verb@            $destHost, $transfile);@\\
\mbox{}\verb@    } elsif ($transaction eq 'rmdir') {@\\
\mbox{}\verb@        $res = syncCommand("ssh $destHost \"rmdir '$filename'\"",@\\
\mbox{}\verb@            $destHost, $transfile);@\\
\mbox{}\verb@    } elsif ($transaction eq 'rmrf') {@\\
\mbox{}\verb@        $res = syncCommand("ssh $destHost \"rm -rf '$filename'\"",@\\
\mbox{}\verb@            $destHost, $transfile);@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        die("ClusterSync: Invalid transaction \"$transaction\"");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    logmsg("        Results: $res") if $res ne '';@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb424}{424}.
\item \NWtxtIdentsUsed\nobreak\  \verb@$verbose@\nobreak\ \NWlink{nuweb388b}{388b}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@min@\nobreak\ \NWlink{nuweb405}{405}, \verb@verbose@\nobreak\ \NWlink{nuweb71}{71}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Recover from failure of a cluster synchronisation transaction}

Errors encountered in processing cluster synchronisations may
be transient (for example, due to a race condition where we're
trying to read a transaction file before the process queueing
it has finished writing it, or permanent, as happens when a
process generating a transaction crashes while generating the
transaction, leaving it incomplete.  To avoid crashing the
synchronisation process, we attempt to execute transactions
within an {\tt eval} block and test for errors therein.  When
an error is detected, we handle it as follows.

Using the transaction file name as the key, we look up the
transaction in the \verb+%failed_transactions+ hash to see
whether it's an error we've previously dealt with.  If not,
then we make an entry in the hash with the transaction file
name as the key and a value consisting of an array of two
items, the first being the number of times the transaction
has failed (initially 1), and the second the time of the
most recent attempt to execute the transaction.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap578}\raggedright\small
\NWtarget{nuweb426}{} $\langle\,${\itshape Recover from failure of a cluster synchronisation transaction}\nobreak\ {\footnotesize {426}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my $whyFailed = $@{\tt @}\verb@;@\\
\mbox{}\verb@    $whyFailed =~ s/\s+$//;@\\
\mbox{}\verb@    if (!defined($failed_transactions{$t})) {@\\
\mbox{}\verb@        $failed_transactions{$t} = [ 1, time() + @\hbox{$\langle\,${\itshape Cluster Failed Transaction Retry Interval}\nobreak\ {\footnotesize \NWlink{nuweb9c}{9c}}$\,\rangle$}\verb@ ];@\\
\mbox{}\verb@        if ($verbose || $logging) {@\\
\mbox{}\verb@            my ($sec, $min, $hour, $mday, $mon, $year) = localtime(time());@\\
\mbox{}\verb@            my $dt = sprintf("%04d-%02d-%02d %02d:%02d",@\\
\mbox{}\verb@                $year + 1900,, $mon + 1, $mday, $hour, $min);@\\
\mbox{}\verb@            my $lm = "$dt $clusterHosts[$i]: $t\n";@\\
\mbox{}\verb@            ($sec, $min, $hour, $mday, $mon, $year) = localtime($failed_transactions{$t}[1]);@\\
\mbox{}\verb@            $dt = sprintf("%04d-%02d-%02d %02d:%02d",@\\
\mbox{}\verb@                $year + 1900,, $mon + 1, $mday, $hour, $min);@\\
\mbox{}\verb@            logmsg("$lm        Failed ($whyFailed) on first attempt.  Retry at $dt.");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        my ($nfails, $failtime) = ($failed_transactions{$t}[0], $failed_transactions{$t}[1]);@\\
\mbox{}\verb@        $nfails++;@\\
\mbox{}\verb@        if ($nfails >= @\hbox{$\langle\,${\itshape Cluster Failed Transaction Maximum Retries}\nobreak\ {\footnotesize \NWlink{nuweb9d}{9d}}$\,\rangle$}\verb@) {@\\
\mbox{}\verb@            undef($failed_transactions{$t});@\\
\mbox{}\verb@            unlink($transfile) ||@\\
\mbox{}\verb@                die("Cannot delete failed cluster transaction file $transfile");@\\
\mbox{}\verb@                $tranqueue--;@\\
\mbox{}\verb@            logmsg("        Failure limit exceeded.  Transaction deleted.");@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $failed_transactions{$t} = [ $nfails, time() + @\hbox{$\langle\,${\itshape Cluster Failed Transaction Retry Interval}\nobreak\ {\footnotesize \NWlink{nuweb9c}{9c}}$\,\rangle$}\verb@ ];@\\
\mbox{}\verb@            my ($sec, $min, $hour, $mday, $mon, $year) = localtime(time());@\\
\mbox{}\verb@            my $dt = sprintf("%04d-%02d-%02d %02d:%02d",@\\
\mbox{}\verb@                $year + 1900,, $mon + 1, $mday, $hour, $min);@\\
\mbox{}\verb@            my $lm = "$dt $clusterHosts[$i]: $t\n";@\\
\mbox{}\verb@            ($sec, $min, $hour, $mday, $mon, $year) = localtime($failed_transactions{$t}[1]);@\\
\mbox{}\verb@            $dt = sprintf("%04d-%02d-%02d %02d:%02d",@\\
\mbox{}\verb@                $year + 1900,, $mon + 1, $mday, $hour, $min);@\\
\mbox{}\verb@            logmsg("$lm        Failed ($whyFailed) on attempt $nfails.  Retry at $dt.");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb424}{424}.
\item \NWtxtIdentsUsed\nobreak\  \verb@$verbose@\nobreak\ \NWlink{nuweb388b}{388b}, \verb@min@\nobreak\ \NWlink{nuweb405}{405}, \verb@verbose@\nobreak\ \NWlink{nuweb71}{71}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Determine if failed transaction should be retried}

If the transaction has failed previously, we increment the
number of attempts and, if we've reached the maximum number
of retries, the transaction is deleted from the transaction
directory and the failed transaction hash.  Otherwise, we
leave the transaction to be retried when the configured
retry time arrives.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap579}\raggedright\small
\NWtarget{nuweb427}{} $\langle\,${\itshape Determine if failed transaction should be retried}\nobreak\ {\footnotesize {427}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    my ($nfails, $failtime) = ($failed_transactions{$t}[0], $failed_transactions{$t}[1]);@\\
\mbox{}\verb@    if ($failtime > time()) {@\\
\mbox{}\verb@#logmsg("** Transaction $t: retry time has not arrived after try $nfails.");@\\
\mbox{}\verb@        next;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb424}{424}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Execute cluster synchronisation command}

This subroutine executes and optionally logs a system command
executed to perform a cluster synchronisation transaction.

If the request fails with a message indicating a failure to contact
the destination host, the host name is placed in the
\verb+%failed_hosts+ hash, with a value indicating the time at which
requests to that host will be tried again.

We handle failure to delete a file specially.  Due to possible race
conditions, particularly when replacing RememberMe files in
logins, we may have a file deletion transaction queued for which
the file has never been created on the cluster host.  To avoid having
this transaction be retried forever, we consider the deletion of
a file which doesn't exist on the destination host as being
successful.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap580}\raggedright\small
\NWtarget{nuweb428}{} \verb@"HDiet/ClusterSync.pl"@\nobreak\ {\footnotesize {428}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub syncCommand {@\\
\mbox{}\verb@        my ($cmd, $host, $tfile) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        logmsg("    Command: $cmd");@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (!$nosync) {@\\
\mbox{}\verb@            my $tfh = new File::Temp(TEMPLATE => '/tmp/HDClusterXXXXXXXXXXXX',@\\
\mbox{}\verb@                               UNLINK => 1,@\\
\mbox{}\verb@                               SUFFIX => '.hdc');@\\
\mbox{}\verb@            $cmd = untaint($cmd);@\\
\mbox{}\verb@            my $status = system($cmd . ">$tfh 2>&1");@\\
\mbox{}\verb@@\\
\mbox{}\verb@            my @{\tt @}\verb@results;@\\
\mbox{}\verb@            my $jres;@\\
\mbox{}\verb@            if ($status != 0) {@\\
\mbox{}\verb@                seek($tfh, 0, 0);@\\
\mbox{}\verb@                @{\tt @}\verb@results = <$tfh>;@\\
\mbox{}\verb@                close($tfh);@\\
\mbox{}\verb@                my $jres = join("", @{\tt @}\verb@results);@\\
\mbox{}\verb@@\\
\mbox{}\verb@                @\hbox{$\langle\,${\itshape Check for errors we deem harmless to cluster synchronisation}\nobreak\ {\footnotesize \NWlink{nuweb429a}{429a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@@\\
\mbox{}\verb@            if ($status == 0) {@\\
\mbox{}\verb@                logmsg("        Executed OK.");@\\
\mbox{}\verb@                unlink($tfile) ||@\\
\mbox{}\verb@                    die("Cannot delete cluster transaction file $tfile");@\\
\mbox{}\verb@                $tranqueue--;@\\
\mbox{}\verb@                return join("", @{\tt @}\verb@results);@\\
\mbox{}\verb@@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                logmsg("        ***Sync command failed, status $status: $cmd");@\\
\mbox{}\verb@@\\
\mbox{}\verb@                if ($jres =~ m/(Connection timed out|Connection refused|lost connection)/) {@\\
\mbox{}\verb@                    $failed_hosts{$host} = time() + @\hbox{$\langle\,${\itshape Cluster Transaction Retry Time Interval}\nobreak\ {\footnotesize \NWlink{nuweb9b}{9b}}$\,\rangle$}\verb@;@\\
\mbox{}\verb@                    logmsg("Marking host $host failed until " .@\\
\mbox{}\verb@                           scalar(localtime($failed_hosts{$host})) . "\n");@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@                return $jres;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return undef;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb421a}{421a}\NWlink{nuweb428}{, 428}\NWlink{nuweb429b}{, 429b}\NWlink{nuweb430a}{, 430a}\NWlink{nuweb430b}{b}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Check for errors we deem harmless to cluster synchronisation}

Due to race conditions, delays in processing transactions, recovery
from transient failures, and other events which befall programs running
in the real world, it may come to pass that we attempt to process a file
delete or copy transaction for a file which no longer exists on the
server.  Rather than fail the transaction through the usual mechanism,
which would cause it to be senselessly retried several times before being
abandoned, we check for these cases specifically and deem the transaction
successful if it's one of the harmless cases.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap581}\raggedright\small
\NWtarget{nuweb429a}{} $\langle\,${\itshape Check for errors we deem harmless to cluster synchronisation}\nobreak\ {\footnotesize {429a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ($jres =~ m/rm: cannot remove\s.*No such file or directory/) {@\\
\mbox{}\verb@        logmsg("        Deeming delete of nonexistent file successful.");@\\
\mbox{}\verb@        $status = 0;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (($cmd =~ m/^scp /) && ($jres =~ m/: No such file or directory/)) {@\\
\mbox{}\verb@        logmsg("        Deeming copy of nonexistent file successful.");@\\
\mbox{}\verb@        $status = 0;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($jres =~ m/mkdir:\s+cannot\s+create\s+directory.*:\s+File\s+exists/) {@\\
\mbox{}\verb@        logmsg("        Deeming creation of already-extant directory successful.");@\\
\mbox{}\verb@        $status = 0;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ($jres =~ m/rmdir:\s+.*No\s+such\s+file\s+or\s+directory/) {@\\
\mbox{}\verb@        logmsg("        Deeming removal of nonexistent directory successful.");@\\
\mbox{}\verb@        $status = 0;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb428}{428}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Output a log message}

The message argument is output to the log file if logging is
configured and copied to standard output if verbose mode is
on.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap582}\raggedright\small
\NWtarget{nuweb429b}{} \verb@"HDiet/ClusterSync.pl"@\nobreak\ {\footnotesize {429b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub logmsg {@\\
\mbox{}\verb@        my ($msg) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print("$msg\n") if $verbose;@\\
\mbox{}\verb@        print(LOG "$msg\n") if $logging;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb421a}{421a}\NWlink{nuweb428}{, 428}\NWlink{nuweb429b}{, 429b}\NWlink{nuweb430a}{, 430a}\NWlink{nuweb430b}{b}.
\item \NWtxtIdentsUsed\nobreak\  \verb@$verbose@\nobreak\ \NWlink{nuweb388b}{388b}, \verb@verbose@\nobreak\ \NWlink{nuweb71}{71}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Conditionally un-taint a variable}

The first argument is tested to match the pattern given by the second
argument (an arbitrary string if no pattern is specified).  If it
matches, an untainted instance of the string is returned.  This can
be used to sanitise input from untrusted sources based upon
matching defined patterns.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap583}\raggedright\small
\NWtarget{nuweb430a}{} \verb@"HDiet/ClusterSync.pl"@\nobreak\ {\footnotesize {430a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub untaint {@\\
\mbox{}\verb@        my ($val, $pat) = @{\tt @}\verb@_;@\\
\mbox{}\verb@        $pat = qr/.*/ if !defined($pat);@\\
\mbox{}\verb@        if (!($val =~ m/^($pat)$/)) {@\\
\mbox{}\verb@            die("Failure to validate pattern in untaint");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return $1;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb421a}{421a}\NWlink{nuweb428}{, 428}\NWlink{nuweb429b}{, 429b}\NWlink{nuweb430a}{, 430a}\NWlink{nuweb430b}{b}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Display if variable is tainted}

For diagnostic purposes, it's handy to be able to test whether a value
is tainted.  This function is called with an arbitrary name and a
static value and prints a message indicating whether the value is
tainted.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap584}\raggedright\small
\NWtarget{nuweb430b}{} \verb@"HDiet/ClusterSync.pl"@\nobreak\ {\footnotesize {430b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub taintso {@\\
\mbox{}\verb@        my ($name, $var) = @{\tt @}\verb@_;@\\
\mbox{}\verb@        my $zip = substr($var, 0, 0);@\\
\mbox{}\verb@        local $@{\tt @}\verb@;@\\
\mbox{}\verb@        eval { eval "# $zip" };@\\
\mbox{}\verb@        if (length($@{\tt @}\verb@) != 0) {@\\
\mbox{}\verb@            print("$name tainted.\n");@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            print("$name clean.\n");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb421a}{421a}\NWlink{nuweb428}{, 428}\NWlink{nuweb429b}{, 429b}\NWlink{nuweb430a}{, 430a}\NWlink{nuweb430b}{b}.
\item \NWtxtIdentsUsed\nobreak\  \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

%    _     _             _
%   | |__ | |_ _ __ ___ | |
%   | '_ \| __| '_ ` _ \| |
%   | | | | |_| | | | | | |
%   |_| |_|\__|_| |_| |_|_|
%

\clearpage
\vbox{
\chapter{HTML utilities}
\label{html.pm}

The following utility functions are used in the generation of
HTML files.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap585}\raggedright\small
\NWtarget{nuweb431}{} \verb@"HDiet/html.pm"@\nobreak\ {\footnotesize {431}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@#! @\hbox{$\langle\,${\itshape Perl directory}\nobreak\ {\footnotesize \NWlink{nuweb8d}{8d}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Perl language modes}\nobreak\ {\footnotesize \NWlink{nuweb387b}{387b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    package HDiet::html;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    require Exporter;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    our @{\tt @}\verb@ISA = qw(Exporter);@\\
\mbox{}\verb@    our @{\tt @}\verb@EXPORT = qw( write_XHTML_prologue@\\
\mbox{}\verb@                       generate_XHTML_navigation_bar@\\
\mbox{}\verb@                       write_XHTML_epilogue@\\
\mbox{}\verb@                       quoteHTML quoteHTMLFile );@\\
\mbox{}\verb@    our @{\tt @}\verb@EXPORT_OK = qw( );@\\
\mbox{}\verb@    1;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Write XHTML prologue}\nobreak\ {\footnotesize \NWlink{nuweb432}{432}, \ldots\ }$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Generate XHTML navigation bar}\nobreak\ {\footnotesize \NWlink{nuweb435}{435}, \ldots\ }$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Write XHTML epilogue}\nobreak\ {\footnotesize \NWlink{nuweb438}{438}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Quote text for inclusion in HTML}\nobreak\ {\footnotesize \NWlink{nuweb439}{439}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtIdentsDefed\nobreak\  \verb@html@\nobreak\ \NWlink{nuweb14a}{14a}\NWlink{nuweb23}{, 23}\NWlink{nuweb118}{, 118}\NWlink{nuweb387a}{, 387a}\NWlink{nuweb390a}{, 390a}\NWlink{nuweb433}{, 433}\NWlink{nuweb438}{, 438}\NWlink{nuweb544}{, 544}\NWlink{nuweb545}{, 545}\NWlink{nuweb549}{, 549}\NWlink{nuweb550}{, 550}\NWlink{nuweb552a}{, 552a}\NWlink{nuweb552b}{b}.\item \NWtxtIdentsUsed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb435}{435}, \verb@quoteHTML@\nobreak\ \NWlink{nuweb439}{439}, \verb@quoteHTMLFile@\nobreak\ \NWlink{nuweb439}{439}, \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb438}{438}, \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb432}{432}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Write XHTML prologue}

The prologue for an XHTML result file is written to the
already-open UTF-8 file handle \verb+$fh+.  Note that if we're
generating the result from invocation as a CGI program, the
MIME {\tt Content-type} must previously have been output.
The optional \verb+$onload+ argument allows specification of
additional code to be executed in the {\tt onload} event
handler for the page.  If the optional \verb+$handheld+
argument is true, the prologue will be adapted to the small
screen of a handheld device.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap586}\raggedright\small
\NWtarget{nuweb432}{} $\langle\,${\itshape Write XHTML prologue}\nobreak\ {\footnotesize {432}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub write_XHTML_prologue {@\\
\mbox{}\verb@        my ($fh, $homeBase, $pageTitle, $onload, $handheld, $noheader) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $onload = '' if !$onload;@\\
\mbox{}\verb@        $noheader = 0 if !$noheader;@\\
\mbox{}\verb@        my $stylesheet = $handheld ? 'hdiet_handheld' : 'hdiet';@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb432}{432}\NWlink{nuweb433}{, 433}\NWlink{nuweb434}{, 434}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb431}{431}.
\item \NWtxtIdentsDefed\nobreak\  \verb@write_XHTML_prologue@\nobreak\ \NWlink{nuweb182}{182}\NWlink{nuweb185a}{, 185a}\NWlink{nuweb186a}{, 186a}\NWlink{nuweb190}{, 190}\NWlink{nuweb197}{, 197}\NWlink{nuweb198}{, 198}\NWlink{nuweb200}{, 200}\NWlink{nuweb201}{, 201}\NWlink{nuweb203}{, 203}\NWlink{nuweb207}{, 207}\NWlink{nuweb208}{, 208}\NWlink{nuweb221}{, 221}\NWlink{nuweb224}{, 224}\NWlink{nuweb227}{, 227}\NWlink{nuweb241}{, 241}\NWlink{nuweb244}{, 244}\NWlink{nuweb247}{, 247}\NWlink{nuweb250}{, 250}\NWlink{nuweb252}{, 252}\NWlink{nuweb258}{, 258}\NWlink{nuweb260}{, 260}\NWlink{nuweb262}{, 262}\NWlink{nuweb264}{, 264}\NWlink{nuweb274}{, 274}\NWlink{nuweb294}{, 294}\NWlink{nuweb304a}{, 304a}\NWlink{nuweb310}{, 310}\NWlink{nuweb311}{, 311}\NWlink{nuweb312}{, 312}\NWlink{nuweb313}{, 313}\NWlink{nuweb315}{, 315}\NWlink{nuweb316}{, 316}\NWlink{nuweb317}{, 317}\NWlink{nuweb320}{, 320}\NWlink{nuweb321}{, 321}\NWlink{nuweb322}{, 322}\NWlink{nuweb323}{, 323}\NWlink{nuweb325}{, 325}\NWlink{nuweb330}{, 330}\NWlink{nuweb331}{, 331}\NWlink{nuweb332}{, 332}\NWlink{nuweb334}{, 334}\NWlink{nuweb336}{, 336}\NWlink{nuweb340}{, 340}\NWlink{nuweb341}{, 341}\NWlink{nuweb342}{, 342}\NWlink{nuweb343}{, 343}\NWlink{nuweb347}{, 347}\NWlink{nuweb348}{, 348}\NWlink{nuweb358}{, 358}\NWlink{nuweb365}{, 365}\NWlink{nuweb370}{, 370}\NWlink{nuweb374}{, 374}\NWlink{nuweb377}{, 377}\NWlink{nuweb380}{, 380}\NWlink{nuweb382}{, 382}\NWlink{nuweb385a}{, 385a}\NWlink{nuweb431}{, 431}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{

Our documents all use the XHTML 1.0 Strict Document Type
Definition.  We use the UTF-8 character set, which is declared
by a ``{\tt meta http-equiv}'' tag.  If any additional HTTP header
items have been queued in the \verb+HTTP_header+ array, they
are emitted in the header.  Similarly, JavaScript code to be
included in the header, queued in \verb+headerScripts+, is
output here, wrapped with embedded script tags.

Note that this code leaves Perl in ``here document'' mode.  The
code that follows which writes the XHTML prologue assumes that
mode is on when it is invoked.  This is hideously ugly and
should be fixed some day.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap587}\raggedright\small
\NWtarget{nuweb433}{} $\langle\,${\itshape Write XHTML prologue}\nobreak\ {\footnotesize {433}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"@\\
\mbox{}\verb@    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">@\\
\mbox{}\verb@<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">@\\
\mbox{}\verb@<head>@\\
\mbox{}\verb@<title>The Hacker's Diet Online: $pageTitle</title>@\\
\mbox{}\verb@<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $umeta;@\\
\mbox{}\verb@        while ($umeta = shift(@{\tt @}\verb@::HTTP_header)) {@\\
\mbox{}\verb@            $umeta =~ s/^(\S+):\s+//;@\\
\mbox{}\verb@            my $mtype = $1;@\\
\mbox{}\verb@            print($fh "<meta http-equiv=\"$1\" content=\"$umeta\" />\n");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<link rel="stylesheet" href="$homeBase/$stylesheet.css" type="text/css" />@\\
\mbox{}\verb@<link rel="shortcut icon" href="$homeBase/figures/hdicon.ico" />@\\
\mbox{}\verb@<script type="text/javascript" src="$homeBase/hdiet.js">@\\
\mbox{}\verb@</script>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@       if (scalar(@{\tt @}\verb@::headerScripts) > 0) {@\\
\mbox{}\verb@           print($fh "<script type=\"text/javascript\">\n");@\\
\mbox{}\verb@           while ($umeta = shift(@{\tt @}\verb@::headerScripts)) {@\\
\mbox{}\verb@               print($fh "    $umeta\n");@\\
\mbox{}\verb@           }@\\
\mbox{}\verb@           print($fh "</script>\n");@\\
\mbox{}\verb@       }@\\
\mbox{}\verb@@\\
\mbox{}\verb@       print $fh <<"EOD";@\\
\mbox{}\verb@</head>@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb432}{432}\NWlink{nuweb433}{, 433}\NWlink{nuweb434}{, 434}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb431}{431}.
\item \NWtxtIdentsUsed\nobreak\  \verb@html@\nobreak\ \NWlink{nuweb431}{431}, \verb@xml@\nobreak\ \NWlink{nuweb440}{440}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{

When the document is loaded, we call the {\tt initialiseDocument} JavaScript
function which transforms the target specifications of external links and
determines the time zone offset from Universal Time.  The caller may supply
additional {\tt onload} code via the \verb+$onload+ argument.

We generate a standard heading at the top of the page: a
fancy table-based header for the desktop version and a simple
list of destinations for handheld devices.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap588}\raggedright\small
\NWtarget{nuweb434}{} $\langle\,${\itshape Write XHTML prologue}\nobreak\ {\footnotesize {434}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@<body onload="initialiseDocument();$onload">@\\
\mbox{}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (!$noheader) {@\\
\mbox{}\verb@            if ($handheld) {@\\
\mbox{}\verb@                print $fh <<"EOD";@\\
\mbox{}\verb@<h1 class="c"><a href="@\hbox{$\langle\,${\itshape Application documentation URL}\nobreak\ {\footnotesize \NWlink{nuweb14a}{14a}}$\,\rangle$}\verb@"><span class="title1">The Hacker's Diet <em>Online</em></span></a></h1>@\\
\mbox{}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                print $fh <<"EOD";@\\
\mbox{}\verb@<table class="title">@\\
\mbox{}\verb@<tr>@\\
\mbox{}\verb@<td class="licon">@\\
\mbox{}\verb@<a href="@\hbox{$\langle\,${\itshape Site home URL}\nobreak\ {\footnotesize \NWlink{nuweb13e}{13e}}$\,\rangle$}\verb@/" class="i"><img src="$homeBase/figures/swlogo.png"@\\
\mbox{}\verb@    id="flicon"@\\
\mbox{}\verb@    class="b0" width="82" height="74"@\\
\mbox{}\verb@    alt="Fourmilab home" />@\\
\mbox{}\verb@</a>@\\
\mbox{}\verb@</td>@\\
\mbox{}\verb@<td align="center" valign="top">@\\
\mbox{}\verb@<a href="@\hbox{$\langle\,${\itshape Application documentation URL}\nobreak\ {\footnotesize \NWlink{nuweb14a}{14a}}$\,\rangle$}\verb@"><span class="title1">The Hacker's Diet <em>Online</em></span></a><br />@\\
\mbox{}\verb@<span class="title2">How to lose weight and hair<br />@\\
\mbox{}\verb@through stress and poor nutrition</span>@\\
\mbox{}\verb@</td>@\\
\mbox{}\verb@<td class="ricon">@\\
\mbox{}\verb@<a href="@\hbox{$\langle\,${\itshape Book home URL}\nobreak\ {\footnotesize \NWlink{nuweb13f}{13f}}$\,\rangle$}\verb@" class="i"><img src="$homeBase/figures/titleicon.png"@\\
\mbox{}\verb@    id="hdicon"@\\
\mbox{}\verb@    class="b0" width="82" height="80"@\\
\mbox{}\verb@    alt="The Hacker's Diet Home" /></a>@\\
\mbox{}\verb@</td>@\\
\mbox{}\verb@</tr>@\\
\mbox{}\verb@</table>@\\
\mbox{}\verb@@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb432}{432}\NWlink{nuweb433}{, 433}\NWlink{nuweb434}{, 434}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb431}{431}.
\item \NWtxtIdentsUsed\nobreak\  \verb@initialiseDocument@\nobreak\ \NWlink{nuweb483a}{483a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Generate XHTML navigation bar}

Every page has a standard navigation bar at the top.  This allows
random access among the most frequently referenced pages.  The
caller must supply, in addition to the customary output stream
and application URL, the session ID and the identifier (as defined
in the \verb+%dest+ hash below) of its page; the latter is used to
highlight that item in the navigation bar as the current page and
disable its link.  When displaying the navigation bar on a minor
page (for example, CSV import) which does not appear within the
navigation bar itself, omit the page identifier or specify
``{\tt Other}''.

The optional \verb+$linkspec+ argument specifies text which is
included verbatim in the links included in the navigation bar.
This may be used, for example, to invoke JavaScript code which
warns the user of unsaved changes before navigating away from a page.

The optional \verb+$browse_public+ argument disables the
``{\tt Settings}'' item in the navigation bar while the user is
browsing a public account.

The \verb+$timeZoneOffset+ argument specifies the time zone
offset between the user's site and UTC (if known), or ``{\tt unknown}''
if it could not be determined.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap589}\raggedright\small
\NWtarget{nuweb435}{} $\langle\,${\itshape Generate XHTML navigation bar}\nobreak\ {\footnotesize {435}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub generate_XHTML_navigation_bar {@\\
\mbox{}\verb@        my ($fh, $homeBase, $session, $thispage, $linkspec, $browse_public, $timeZoneOffset) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $thispage = "Other" if !defined($thispage);@\\
\mbox{}\verb@        $linkspec = $linkspec ? (' ' . $linkspec) : '';@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $lurl = "<a class=\"navbar\"$linkspec href=\"@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@?s=$session&amp;q=";@\\
\mbox{}\verb@        my $eurl = "\">";@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $tz = "&amp;HDiet_tzoffset=$timeZoneOffset";@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb435}{435}\NWlink{nuweb436}{, 436}\NWlink{nuweb437}{, 437}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb431}{431}.
\item \NWtxtIdentsDefed\nobreak\  \verb@generate_XHTML_navigation_bar@\nobreak\ \NWlink{nuweb190}{190}\NWlink{nuweb208}{, 208}\NWlink{nuweb221}{, 221}\NWlink{nuweb224}{, 224}\NWlink{nuweb227}{, 227}\NWlink{nuweb241}{, 241}\NWlink{nuweb244}{, 244}\NWlink{nuweb247}{, 247}\NWlink{nuweb250}{, 250}\NWlink{nuweb252}{, 252}\NWlink{nuweb258}{, 258}\NWlink{nuweb262}{, 262}\NWlink{nuweb264}{, 264}\NWlink{nuweb274}{, 274}\NWlink{nuweb294}{, 294}\NWlink{nuweb311}{, 311}\NWlink{nuweb312}{, 312}\NWlink{nuweb313}{, 313}\NWlink{nuweb315}{, 315}\NWlink{nuweb316}{, 316}\NWlink{nuweb317}{, 317}\NWlink{nuweb320}{, 320}\NWlink{nuweb321}{, 321}\NWlink{nuweb322}{, 322}\NWlink{nuweb323}{, 323}\NWlink{nuweb325}{, 325}\NWlink{nuweb330}{, 330}\NWlink{nuweb331}{, 331}\NWlink{nuweb332}{, 332}\NWlink{nuweb334}{, 334}\NWlink{nuweb336}{, 336}\NWlink{nuweb340}{, 340}\NWlink{nuweb341}{, 341}\NWlink{nuweb342}{, 342}\NWlink{nuweb343}{, 343}\NWlink{nuweb347}{, 347}\NWlink{nuweb348}{, 348}\NWlink{nuweb358}{, 358}\NWlink{nuweb365}{, 365}\NWlink{nuweb370}{, 370}\NWlink{nuweb374}{, 374}\NWlink{nuweb377}{, 377}\NWlink{nuweb380}{, 380}\NWlink{nuweb382}{, 382}\NWlink{nuweb431}{, 431}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{

The following hash defines the destinations for the navigation bar.  These are
the transaction names and optional other CGI arguments for the
destinations.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap590}\raggedright\small
\NWtarget{nuweb436}{} $\langle\,${\itshape Generate XHTML navigation bar}\nobreak\ {\footnotesize {436}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@        my %dest = (@\\
\mbox{}\verb@                        Log => "log&amp;m=now",@\\
\mbox{}\verb@                        History => "calendar",@\\
\mbox{}\verb@                        Chart => "histreq",@\\
\mbox{}\verb@                        Trend => "trendan",@\\
\mbox{}\verb@                        Settings => "modacct",@\\
\mbox{}\verb@                        Utilities => "account",@\\
\mbox{}\verb@                        Signoff => "logout"@\\
\mbox{}\verb@                   );@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $dest{$thispage} = '';@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb435}{435}\NWlink{nuweb436}{, 436}\NWlink{nuweb437}{, 437}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb431}{431}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{

The \verb+$thispage+ argument allows specifying which page we are
currently displaying.  That item is displayed highlighted in the
navigation bar and no link is attached to it, since there's no
point in navigating back to the same page we're on.  It is
perfectly valid to specify \verb+undef+ for \verb+$thispage+---this
indicates you're on a page which isn't linked directly to the
navigation bar; in this case all of the links in the bar
will be active.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap591}\raggedright\small
\NWtarget{nuweb437}{} $\langle\,${\itshape Generate XHTML navigation bar}\nobreak\ {\footnotesize {437}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@        my (%elink, %active);@\\
\mbox{}\verb@        for my $k (keys %dest) {@\\
\mbox{}\verb@           if ($dest{$k} ne '') {@\\
\mbox{}\verb@                $dest{$k} = $lurl . $dest{$k} . $tz . $eurl;@\\
\mbox{}\verb@                $elink{$k} = '</a>';@\\
\mbox{}\verb@                $active{$k} = '';@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                $elink{$k} = '';@\\
\mbox{}\verb@                $active{$k} = ' class="active"';@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ($browse_public) {@\\
\mbox{}\verb@            $dest{Settings} = '';@\\
\mbox{}\verb@            $elink{Settings} = '';@\\
\mbox{}\verb@            $active{Settings} = ' class="disabled"';@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<table class="navbar">@\\
\mbox{}\verb@    <tr>@\\
\mbox{}\verb@        <td title="Display the current monthly log"$active{Log}>$dest{Log}Log$elink{Log}</td>@\\
\mbox{}\verb@        <td title="Show a calendar of all monthly logs"$active{History}>$dest{History}History$elink{History}</td>@\\
\mbox{}\verb@        <td title="Generate historical charts"$active{Chart}>$dest{Chart}Chart$elink{Chart}</td>@\\
\mbox{}\verb@        <td title="Analyse weight trend and energy balance"$active{Trend}>$dest{Trend}Trend$elink{Trend}</td>@\\
\mbox{}\verb@        <td title="Edit your account settings"$active{Settings}>$dest{Settings}Settings$elink{Settings}</td>@\\
\mbox{}\verb@        <td title="Perform various utility functions"$active{Utilities}>$dest{Utilities}Utilities$elink{Utilities}</td>@\\
\mbox{}\verb@        <td class="pad"></td>@\\
\mbox{}\verb@        <td title="Sign off from The Hacker's Diet Online"$active{Signoff}>$dest{Signoff}Sign&nbsp;Out$elink{Signoff}</td>@\\
\mbox{}\verb@    </tr>@\\
\mbox{}\verb@</table>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb435}{435}\NWlink{nuweb436}{, 436}\NWlink{nuweb437}{, 437}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb431}{431}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Write XHTML epilogue}

Our XHTML files have a stereotyped epilogue which is generated
by the following code.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap592}\raggedright\small
\NWtarget{nuweb438}{} $\langle\,${\itshape Write XHTML epilogue}\nobreak\ {\footnotesize {438}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub write_XHTML_epilogue {@\\
\mbox{}\verb@        my ($fh, $homeBase) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@</body>@\\
\mbox{}\verb@</html>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb431}{431}.
\item \NWtxtIdentsDefed\nobreak\  \verb@write_XHTML_epilogue@\nobreak\ \NWlink{nuweb182}{182}\NWlink{nuweb185a}{, 185a}\NWlink{nuweb186a}{, 186a}\NWlink{nuweb190}{, 190}\NWlink{nuweb197}{, 197}\NWlink{nuweb198}{, 198}\NWlink{nuweb200}{, 200}\NWlink{nuweb201}{, 201}\NWlink{nuweb203}{, 203}\NWlink{nuweb207}{, 207}\NWlink{nuweb208}{, 208}\NWlink{nuweb221}{, 221}\NWlink{nuweb224}{, 224}\NWlink{nuweb228b}{, 228b}\NWlink{nuweb243}{, 243}\NWlink{nuweb246}{, 246}\NWlink{nuweb247}{, 247}\NWlink{nuweb250}{, 250}\NWlink{nuweb252}{, 252}\NWlink{nuweb258}{, 258}\NWlink{nuweb260}{, 260}\NWlink{nuweb262}{, 262}\NWlink{nuweb264}{, 264}\NWlink{nuweb274}{, 274}\NWlink{nuweb294}{, 294}\NWlink{nuweb304a}{, 304a}\NWlink{nuweb310}{, 310}\NWlink{nuweb311}{, 311}\NWlink{nuweb312}{, 312}\NWlink{nuweb313}{, 313}\NWlink{nuweb315}{, 315}\NWlink{nuweb316}{, 316}\NWlink{nuweb317}{, 317}\NWlink{nuweb320}{, 320}\NWlink{nuweb321}{, 321}\NWlink{nuweb322}{, 322}\NWlink{nuweb324}{, 324}\NWlink{nuweb328}{, 328}\NWlink{nuweb330}{, 330}\NWlink{nuweb331}{, 331}\NWlink{nuweb332}{, 332}\NWlink{nuweb333}{, 333}\NWlink{nuweb334}{, 334}\NWlink{nuweb335}{, 335}\NWlink{nuweb336}{, 336}\NWlink{nuweb340}{, 340}\NWlink{nuweb341}{, 341}\NWlink{nuweb342}{, 342}\NWlink{nuweb343}{, 343}\NWlink{nuweb347}{, 347}\NWlink{nuweb348}{, 348}\NWlink{nuweb358}{, 358}\NWlink{nuweb365}{, 365}\NWlink{nuweb370}{, 370}\NWlink{nuweb374}{, 374}\NWlink{nuweb377}{, 377}\NWlink{nuweb380}{, 380}\NWlink{nuweb382}{, 382}\NWlink{nuweb385a}{, 385a}\NWlink{nuweb431}{, 431}.\item \NWtxtIdentsUsed\nobreak\  \verb@html@\nobreak\ \NWlink{nuweb431}{431}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Quote text for inclusion in HTML}

The {\tt quoteHTML} function quotes all HTML metacharacters
in its argument and expands characters which are not Latin-1
graphics to HTML numeric entities.  The quoted string is
returned.

The {\tt quoteHTMLFile} copies text in an input file handle
to the output file handle, applying {\tt quoteHTML} to all
lines.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap593}\raggedright\small
\NWtarget{nuweb439}{} $\langle\,${\itshape Quote text for inclusion in HTML}\nobreak\ {\footnotesize {439}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub quoteHTML {@\\
\mbox{}\verb@        my ($s) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $os = '';@\\
\mbox{}\verb@@\\
\mbox{}\verb@        while ($s =~ s/^(.)//s) {@\\
\mbox{}\verb@            my $o = ord($1);@\\
\mbox{}\verb@            if ($1 eq "\n") {@\\
\mbox{}\verb@                $os .= $1;@\\
\mbox{}\verb@            } elsif (($1 eq '<') || ($1 eq '>') || ($1 eq '&') || ($1 eq '"') ||@\\
\mbox{}\verb@                ($o < 32) ||@\\
\mbox{}\verb@                (($o >= 127) && ($o < 161)) || ($o > 255)) {@\\
\mbox{}\verb@                $os .= "&#$o;";@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                $os .= $1;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return $os;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    sub quoteHTMLFile {@\\
\mbox{}\verb@        my ($ifh, $ofh) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        while (<$ifh>) {@\\
\mbox{}\verb@            print($ofh quoteHTML($_));@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb431}{431}.
\item \NWtxtIdentsDefed\nobreak\  \verb@quoteHTML@\nobreak\ \NWlink{nuweb40a}{40a}\NWlink{nuweb125}{, 125}\NWlink{nuweb128}{, 128}\NWlink{nuweb134b}{, 134b}\NWlink{nuweb190}{, 190}\NWlink{nuweb191a}{, 191a}\NWlink{nuweb196}{, 196}\NWlink{nuweb198}{, 198}\NWlink{nuweb200}{, 200}\NWlink{nuweb201}{, 201}\NWlink{nuweb203}{, 203}\NWlink{nuweb207}{, 207}\NWlink{nuweb212a}{, 212a}\NWlink{nuweb218}{, 218}\NWlink{nuweb221}{, 221}\NWlink{nuweb231}{, 231}\NWlink{nuweb233}{, 233}\NWlink{nuweb305}{, 305}\NWlink{nuweb313}{, 313}\NWlink{nuweb319}{, 319}\NWlink{nuweb321}{, 321}\NWlink{nuweb324}{, 324}\NWlink{nuweb327}{, 327}\NWlink{nuweb330}{, 330}\NWlink{nuweb333}{, 333}\NWlink{nuweb335}{, 335}\NWlink{nuweb338}{, 338}\NWlink{nuweb339}{, 339}\NWlink{nuweb345}{, 345}\NWlink{nuweb352}{, 352}\NWlink{nuweb366}{, 366}\NWlink{nuweb368}{, 368}\NWlink{nuweb373}{, 373}\NWlink{nuweb380}{, 380}\NWlink{nuweb431}{, 431}, \verb@quoteHTMLFile@\nobreak\ \NWlink{nuweb218}{218}\NWlink{nuweb431}{, 431}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

%                   _
%   __  ___ __ ___ | |
%   \ \/ / '_ ` _ \| |
%    >  <| | | | | | |
%   /_/\_\_| |_| |_|_|

\clearpage
\vbox{
\chapter{XML utilities}
\label{xml.pm}

The following utility functions are used in the generation of
XML files.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap594}\raggedright\small
\NWtarget{nuweb440}{} \verb@"HDiet/xml.pm"@\nobreak\ {\footnotesize {440}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@#! @\hbox{$\langle\,${\itshape Perl directory}\nobreak\ {\footnotesize \NWlink{nuweb8d}{8d}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Perl language modes}\nobreak\ {\footnotesize \NWlink{nuweb387b}{387b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    package HDiet::xml;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    require Exporter;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    our @{\tt @}\verb@ISA = qw(Exporter);@\\
\mbox{}\verb@    our @{\tt @}\verb@EXPORT = qw(@\\
\mbox{}\verb@                       generateXMLprologue@\\
\mbox{}\verb@                       generateXMLepilogue@\\
\mbox{}\verb@                       textXML@\\
\mbox{}\verb@                       quoteXML@\\
\mbox{}\verb@                       timeXML@\\
\mbox{}\verb@                     );@\\
\mbox{}\verb@    our @{\tt @}\verb@EXPORT_OK = qw( );@\\
\mbox{}\verb@    1;@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb440}{440}\NWlink{nuweb441a}{, 441a}\NWlink{nuweb441b}{b}\NWlink{nuweb442a}{, 442a}\NWlink{nuweb442b}{b}\NWlink{nuweb443}{, 443}.
\item \NWtxtIdentsDefed\nobreak\  \verb@xml@\nobreak\ \NWlink{nuweb23}{23}\NWlink{nuweb118}{, 118}\NWlink{nuweb228b}{, 228b}\NWlink{nuweb249}{, 249}\NWlink{nuweb250}{, 250}\NWlink{nuweb252}{, 252}\NWlink{nuweb254}{, 254}\NWlink{nuweb375b}{, 375b}\NWlink{nuweb387a}{, 387a}\NWlink{nuweb433}{, 433}\NWlink{nuweb441a}{, 441a}\NWlink{nuweb552a}{, 552a}.\item \NWtxtIdentsUsed\nobreak\  \verb@generateXMLepilogue@\nobreak\ \NWlink{nuweb441b}{441b}, \verb@generateXMLprologue@\nobreak\ \NWlink{nuweb441a}{441a}, \verb@quoteXML@\nobreak\ \NWlink{nuweb442a}{442a}, \verb@textXML@\nobreak\ \NWlink{nuweb442b}{442b}, \verb@timeXML@\nobreak\ \NWlink{nuweb443}{443}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Generate XML prologue}

The standard XML prologue, including XML version, character set,
DOCTYPE, and our universal root element are written to the file
handle argument.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap595}\raggedright\small
\NWtarget{nuweb441a}{} \verb@"HDiet/xml.pm"@\nobreak\ {\footnotesize {441a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub generateXMLprologue {@\\
\mbox{}\verb@        my ($fh) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@<?xml version="1.0" encoding="UTF-8"?>@\\
\mbox{}\verb@<?xml-stylesheet type="text/css" href="http://www.fourmilab.ch/hackdiet/online/hackdiet_db.css"?>@\\
\mbox{}\verb@<!DOCTYPE hackersdiet SYSTEM@\\
\mbox{}\verb@          "http://www.fourmilab.ch/hackdiet/online/hackersdiet.dtd">@\\
\mbox{}\verb@<hackersdiet version="1.0">@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb440}{440}\NWlink{nuweb441a}{, 441a}\NWlink{nuweb441b}{b}\NWlink{nuweb442a}{, 442a}\NWlink{nuweb442b}{b}\NWlink{nuweb443}{, 443}.
\item \NWtxtIdentsDefed\nobreak\  \verb@generateXMLprologue@\nobreak\ \NWlink{nuweb249}{249}\NWlink{nuweb254}{, 254}\NWlink{nuweb440}{, 440}.\item \NWtxtIdentsUsed\nobreak\  \verb@xml@\nobreak\ \NWlink{nuweb440}{440}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Generate XML epilogue}

The standard XML epilogue, which simply closes the root
element from the prologue, is written to the file handle argument.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap596}\raggedright\small
\NWtarget{nuweb441b}{} \verb@"HDiet/xml.pm"@\nobreak\ {\footnotesize {441b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub generateXMLepilogue {@\\
\mbox{}\verb@        my ($fh) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        print $fh <<"EOD";@\\
\mbox{}\verb@</hackersdiet>@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb440}{440}\NWlink{nuweb441a}{, 441a}\NWlink{nuweb441b}{b}\NWlink{nuweb442a}{, 442a}\NWlink{nuweb442b}{b}\NWlink{nuweb443}{, 443}.
\item \NWtxtIdentsDefed\nobreak\  \verb@generateXMLepilogue@\nobreak\ \NWlink{nuweb249}{249}\NWlink{nuweb254}{, 254}\NWlink{nuweb440}{, 440}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{QuoteXML}

The {\tt quoteXML} function replaces XML metacharacters with named
entities; only ampersand and the less and greater than signs need
be replaced in this application.  In addition, if the \verb+$safe+
argument is true, all character with Unicode code points of 128
decimal and above are replaced with XML hexadecimal numeric entities,
resulting in a file which, even though nominally encoded in UTF-8,
can be edited with an editor aware only of the 7-bit ASCII set.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap597}\raggedright\small
\NWtarget{nuweb442a}{} \verb@"HDiet/xml.pm"@\nobreak\ {\footnotesize {442a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub quoteXML {@\\
\mbox{}\verb@        my ($s, $safe) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $s =~ s/&/&amp;/g;@\\
\mbox{}\verb@        $s =~ s/</&lt;/g;@\\
\mbox{}\verb@        $s =~ s/>/&gt;/g;@\\
\mbox{}\verb@        if ($safe) {@\\
\mbox{}\verb@            $s =~ s/([\x{80}-\x{FFFF}])/sprintf("&#x%x;", ord($1))/eg;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return $s;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb440}{440}\NWlink{nuweb441a}{, 441a}\NWlink{nuweb441b}{b}\NWlink{nuweb442a}{, 442a}\NWlink{nuweb442b}{b}\NWlink{nuweb443}{, 443}.
\item \NWtxtIdentsDefed\nobreak\  \verb@quoteXML@\nobreak\ \NWlink{nuweb137}{137}\NWlink{nuweb138}{, 138}\NWlink{nuweb440}{, 440}\NWlink{nuweb442b}{, 442b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{TextXML}

The {\tt textXML} function generates an XML element containing the
text given by the argument, which is quoted if necessary to escape any
metacharacters and/or avoid non-ASCII character if \verb+$safe+ is
specified.  The text is wrapped in an element with the specified
\verb+$tagname+.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap598}\raggedright\small
\NWtarget{nuweb442b}{} \verb@"HDiet/xml.pm"@\nobreak\ {\footnotesize {442b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub textXML {@\\
\mbox{}\verb@        my ($tagname, $s, $safe) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $s = quoteXML($s, $safe);@\\
\mbox{}\verb@        my $etagname = $tagname;@\\
\mbox{}\verb@        $etagname =~ s/\s+.*$//;@\\
\mbox{}\verb@        return "<$tagname>$s</$etagname>";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb440}{440}\NWlink{nuweb441a}{, 441a}\NWlink{nuweb441b}{b}\NWlink{nuweb442a}{, 442a}\NWlink{nuweb442b}{b}\NWlink{nuweb443}{, 443}.
\item \NWtxtIdentsDefed\nobreak\  \verb@textXML@\nobreak\ \NWlink{nuweb68}{68}\NWlink{nuweb440}{, 440}.\item \NWtxtIdentsUsed\nobreak\  \verb@quoteXML@\nobreak\ \NWlink{nuweb442a}{442a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{\UNIX/ time to ISO date and time}

The {\tt textXML} function generates an XML element containing the
text given by the argument, which is quoted if necessary to escape any
metacharacters and/or avoid non-ASCII character if \verb+$safe+ is
specified.  The text is wrapped in an element with the specified
\verb+$tagname+.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap599}\raggedright\small
\NWtarget{nuweb443}{} \verb@"HDiet/xml.pm"@\nobreak\ {\footnotesize {443}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub timeXML {@\\
\mbox{}\verb@        my ($utime) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my @{\tt @}\verb@lmod = gmtime($utime);@\\
\mbox{}\verb@        my $lm = sprintf("%04d-%02d-%02dT%02d:%02d:%02dZ",@\\
\mbox{}\verb@            $lmod[5] + 1900, $lmod[4] + 1, $lmod[3], $lmod[2], $lmod[1], $lmod[0]);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $lm;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb440}{440}\NWlink{nuweb441a}{, 441a}\NWlink{nuweb441b}{b}\NWlink{nuweb442a}{, 442a}\NWlink{nuweb442b}{b}\NWlink{nuweb443}{, 443}.
\item \NWtxtIdentsDefed\nobreak\  \verb@timeXML@\nobreak\ \NWlink{nuweb68}{68}\NWlink{nuweb137}{, 137}\NWlink{nuweb139}{, 139}\NWlink{nuweb254}{, 254}\NWlink{nuweb255}{, 255}\NWlink{nuweb379a}{, 379a}\NWlink{nuweb440}{, 440}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

%        _       _ _
%       | |_   _| (_) __ _ _ __
%    _  | | | | | | |/ _` | '_ \
%   | |_| | |_| | | | (_| | | | |
%    \___/ \__,_|_|_|\__,_|_| |_|

\clearpage
\vbox{
\chapter{Julian date utilities}
\label{Julian.pm}

We use Julian day numbers to represent times and dates.  This avoids
all cultural bias and eliminates worries about overflow apocalypses
in 2038 and beyond.  Time is represented as a fractional day.  Note that
Julian day numbers start at noon.  This package makes no aassuptions
regarding the time zone in which Julian day numbers are defined, but
they should be used only for UTC/GMT times and dates.  This program
conforms to that convention.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap600}\raggedright\small
\NWtarget{nuweb445}{} \verb@"HDiet/Julian.pm"@\nobreak\ {\footnotesize {445}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@#! @\hbox{$\langle\,${\itshape Perl directory}\nobreak\ {\footnotesize \NWlink{nuweb8d}{8d}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Perl language modes}\nobreak\ {\footnotesize \NWlink{nuweb387b}{387b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    package HDiet::Julian;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    require Exporter;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    our @{\tt @}\verb@ISA = qw(Exporter);@\\
\mbox{}\verb@    our @{\tt @}\verb@EXPORT = qw(gregorian_to_jd jd_to_gregorian jd_to_weekday@\\
\mbox{}\verb@        civil_time_to_jd jd_to_civil_time@\\
\mbox{}\verb@        unix_time_to_jd jd_to_unix_time unix_time_to_civil_date_time@\\
\mbox{}\verb@        jd_to_RFC_822_date jd_to_RFC_3339_date jd_to_old_cookie_date);@\\
\mbox{}\verb@    our @{\tt @}\verb@EXPORT_OK = qw(leap_gregorian GREGORIAN_EPOCH WEEKDAY_NAMES@\\
\mbox{}\verb@        MONTH_ABBREVIATIONS);@\\
\mbox{}\verb@    1;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Julian date constant definitions}\nobreak\ {\footnotesize \NWlink{nuweb446a}{446a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Julian date support functions}\nobreak\ {\footnotesize \NWlink{nuweb446b}{446b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Gregorian leap year computation}\nobreak\ {\footnotesize \NWlink{nuweb447a}{447a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Gregorian date to Julian day number}\nobreak\ {\footnotesize \NWlink{nuweb447b}{447b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Julian day to Gregorian date}\nobreak\ {\footnotesize \NWlink{nuweb448}{448}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Julian day to day of week}\nobreak\ {\footnotesize \NWlink{nuweb449a}{449a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Civil time to Julian day fraction}\nobreak\ {\footnotesize \NWlink{nuweb449b}{449b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Julian day fraction to civil time}\nobreak\ {\footnotesize \NWlink{nuweb450a}{450a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Unix time to Julian day and fraction}\nobreak\ {\footnotesize \NWlink{nuweb450b}{450b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Julian day and fraction to Unix time}\nobreak\ {\footnotesize \NWlink{nuweb451a}{451a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Unix time to civil date and time}\nobreak\ {\footnotesize \NWlink{nuweb451b}{451b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Julian day and fraction to RFC 822 time and date}\nobreak\ {\footnotesize \NWlink{nuweb452a}{452a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Julian day and fraction to RFC 3339 time and date}\nobreak\ {\footnotesize \NWlink{nuweb452b}{452b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Julian day and fraction to old HTTP cookie time and date}\nobreak\ {\footnotesize \NWlink{nuweb453}{453}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtIdentsDefed\nobreak\  \verb@GREGORIAN_EPOCH@\nobreak\ \NWlink{nuweb446a}{446a}\NWlink{nuweb447b}{, 447b}\NWlink{nuweb448}{, 448}, \verb@J1970@\nobreak\ \NWlink{nuweb446a}{446a}\NWlink{nuweb450b}{, 450b}\NWlink{nuweb451a}{, 451a}, \verb@Julian@\nobreak\ \NWlink{nuweb23}{23}\NWlink{nuweb52}{, 52}\NWlink{nuweb75}{, 75}\NWlink{nuweb114}{, 114}\NWlink{nuweb118}{, 118}\NWlink{nuweb154}{, 154}\NWlink{nuweb261}{, 261}\NWlink{nuweb387a}{, 387a}\NWlink{nuweb408}{, 408}\NWlink{nuweb446a}{, 446a}\NWlink{nuweb552a}{, 552a}, \verb@WEEKDAY_NAMES@\nobreak\ \NWlink{nuweb23}{23}\NWlink{nuweb37b}{, 37b}\NWlink{nuweb66}{, 66}\NWlink{nuweb75}{, 75}\NWlink{nuweb261}{, 261}\NWlink{nuweb446a}{, 446a}\NWlink{nuweb453}{, 453}.\item \NWtxtIdentsUsed\nobreak\  \verb@civil_time_to_jd@\nobreak\ \NWlink{nuweb449b}{449b}, \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}, \verb@jd_to_civil_time@\nobreak\ \NWlink{nuweb450a}{450a}, \verb@jd_to_gregorian@\nobreak\ \NWlink{nuweb448}{448}, \verb@jd_to_old_cookie_date@\nobreak\ \NWlink{nuweb453}{453}, \verb@jd_to_RFC_3339_date@\nobreak\ \NWlink{nuweb452b}{452b}, \verb@jd_to_RFC_822_date@\nobreak\ \NWlink{nuweb452a}{452a}, \verb@jd_to_unix_time@\nobreak\ \NWlink{nuweb451a}{451a}, \verb@jd_to_weekday@\nobreak\ \NWlink{nuweb449a}{449a}, \verb@leap_gregorian@\nobreak\ \NWlink{nuweb447a}{447a}, \verb@unix_time_to_civil_date_time@\nobreak\ \NWlink{nuweb451b}{451b}, \verb@unix_time_to_jd@\nobreak\ \NWlink{nuweb450b}{450b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Julian date constant definitions}

The following constants are used in Julian date computation
and/or furnished to users of this package for convenience.
In the latter category are the names of weekdays and
abbreviations for month names.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap601}\raggedright\small
\NWtarget{nuweb446a}{} $\langle\,${\itshape Julian date constant definitions}\nobreak\ {\footnotesize {446a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    use constant GREGORIAN_EPOCH => 1721425.5;@\\
\mbox{}\verb@    use constant WEEKDAY_NAMES => [ "Sunday", "Monday", "Tuesday", "Wednesday",@\\
\mbox{}\verb@                                    "Thursday", "Friday", "Saturday" ];@\\
\mbox{}\verb@    use constant MONTH_ABBREVIATIONS => [@\\
\mbox{}\verb@        "Jan", "Feb", "Mar", "Apr", "May", "Jun",@\\
\mbox{}\verb@        "Jul", "Aug", "Sep", "Oct", "Nov", "Dec" ];@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use constant J1970 => 2440587.5;    # Julian date at Unix epoch: 1970-01-01@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb445}{445}.
\item \NWtxtIdentsUsed\nobreak\  \verb@GREGORIAN_EPOCH@\nobreak\ \NWlink{nuweb445}{445}, \verb@J1970@\nobreak\ \NWlink{nuweb445}{445}, \verb@Julian@\nobreak\ \NWlink{nuweb445}{445}, \verb@WEEKDAY_NAMES@\nobreak\ \NWlink{nuweb445}{445}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Julian date support functions}

Our Julian day functions require a proper modulus function which
works for non-integers and a floor function which behaves properly
for negative numbers.  If these prove useful elsewhere, they may be
promoted to their own package and imported where needed.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap602}\raggedright\small
\NWtarget{nuweb446b}{} $\langle\,${\itshape Julian date support functions}\nobreak\ {\footnotesize {446b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    #   MOD  --  Modulus function which works for non-integers.@\\
\mbox{}\verb@@\\
\mbox{}\verb@    sub mod {@\\
\mbox{}\verb@        my ($a, $b) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return $a - ($b * floor($a / $b));@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    #   FLOOR  -- Round number to the nearest integer less than@\\
\mbox{}\verb@    #             the argument.  Note that, unlike int(), floor(-1.5) = -2.@\\
\mbox{}\verb@@\\
\mbox{}\verb@    sub floor {@\\
\mbox{}\verb@        my $x  = shift;@\\
\mbox{}\verb@        my $ix = int($x);@\\
\mbox{}\verb@        return (($x >= 0) || ($x == $ix)) ? $ix : ($ix - 1);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb445}{445}.
\item \NWtxtIdentsDefed\nobreak\  \verb@floor@\nobreak\ \NWlink{nuweb447b}{447b}\NWlink{nuweb448}{, 448}\NWlink{nuweb450a}{, 450a}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb488b}{, 488b}\NWlink{nuweb489}{, 489}\NWlink{nuweb494}{, 494}\NWlink{nuweb495}{, 495}\NWlink{nuweb499}{, 499}\NWlink{nuweb502}{, 502}\NWlink{nuweb503}{, 503}\NWlink{nuweb519b}{, 519b}\NWlink{nuweb521}{, 521}, \verb@mod@\nobreak\ \NWlink{nuweb448}{448}.\item \NWtxtIdentsUsed\nobreak\  \verb@Round@\nobreak\ \NWlink{nuweb405}{405}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Gregorian leap year computation}

Determine if the Gregorian year argument is a leap year.  Returns 1
if the year is a leap year, 0 otherwise.  This works for years prior
to the adoption of the Gregorian calendar including negative year
numbers.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap603}\raggedright\small
\NWtarget{nuweb447a}{} $\langle\,${\itshape Gregorian leap year computation}\nobreak\ {\footnotesize {447a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub leap_gregorian {@\\
\mbox{}\verb@        my $year = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return (($year % 4) == 0) &&@\\
\mbox{}\verb@                (!((($year % 100) == 0) && (($year % 400) != 0)));@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb445}{445}.
\item \NWtxtIdentsDefed\nobreak\  \verb@leap_gregorian@\nobreak\ \NWlink{nuweb445}{445}\NWlink{nuweb447b}{, 447b}\NWlink{nuweb448}{, 448}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Gregorian date to Julian day number}

The \verb+$year+, \verb+$month+, and \verb+$day+ arguments
specifying a date in the (proleptic) Gregorian calendar are
converted to the corresponding Julian day number at noon on
that date.  Note the \verb+$month+ is a calendar month, with
1 denoting January.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap604}\raggedright\small
\NWtarget{nuweb447b}{} $\langle\,${\itshape Gregorian date to Julian day number}\nobreak\ {\footnotesize {447b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub gregorian_to_jd {@\\
\mbox{}\verb@        my ($year, $month, $day) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return (GREGORIAN_EPOCH - 1) +@\\
\mbox{}\verb@               (365 * ($year - 1)) +@\\
\mbox{}\verb@               floor(($year - 1) / 4.0) +@\\
\mbox{}\verb@               (-floor(($year - 1) / 100.0)) +@\\
\mbox{}\verb@               floor(($year - 1) / 400.0) +@\\
\mbox{}\verb@               floor((((367 * $month) - 362) / 12) +@\\
\mbox{}\verb@               (($month <= 2) ? 0 :@\\
\mbox{}\verb@                                   (leap_gregorian($year) ? -1 : -2)@\\
\mbox{}\verb@               ) +@\\
\mbox{}\verb@               $day);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb445}{445}.
\item \NWtxtIdentsDefed\nobreak\  \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb36}{36}\NWlink{nuweb52}{, 52}\NWlink{nuweb66}{, 66}\NWlink{nuweb80}{, 80}\NWlink{nuweb84}{, 84}\NWlink{nuweb90}{, 90}\NWlink{nuweb91}{, 91}\NWlink{nuweb92}{, 92}\NWlink{nuweb102a}{, 102a}\NWlink{nuweb102b}{b}\NWlink{nuweb111}{, 111}\NWlink{nuweb117}{, 117}\NWlink{nuweb158b}{, 158b}\NWlink{nuweb215}{, 215}\NWlink{nuweb253}{, 253}\NWlink{nuweb260}{, 260}\NWlink{nuweb261}{, 261}\NWlink{nuweb265b}{, 265b}\NWlink{nuweb266}{, 266}\NWlink{nuweb269}{, 269}\NWlink{nuweb291b}{, 291b}\NWlink{nuweb292}{, 292}\NWlink{nuweb293}{, 293}\NWlink{nuweb298}{, 298}\NWlink{nuweb349}{, 349}\NWlink{nuweb408}{, 408}\NWlink{nuweb445}{, 445}\NWlink{nuweb448}{, 448}.\item \NWtxtIdentsUsed\nobreak\  \verb@floor@\nobreak\ \NWlink{nuweb446b}{446b}, \verb@GREGORIAN_EPOCH@\nobreak\ \NWlink{nuweb445}{445}, \verb@leap_gregorian@\nobreak\ \NWlink{nuweb447a}{447a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Julian day to Gregorian date}

Convert the Julian day argument (which may contain a day fraction) the
a proleptic Gregorian date, adjusting for the noon origin of Julian days
and midnight for Gregorian dates.  The year, calendar month (1$=$January),
and day of the month are returned as an array.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap605}\raggedright\small
\NWtarget{nuweb448}{} $\langle\,${\itshape Julian day to Gregorian date}\nobreak\ {\footnotesize {448}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub jd_to_gregorian {@\\
\mbox{}\verb@        my $jd = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($wjd, $depoch, $quadricent, $dqc, $cent, $dcent, $quad, $dquad,@\\
\mbox{}\verb@            $yindex, $yearday, $leapadj, $year, $month, $day);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $wjd = floor($jd - 0.5) + 0.5;@\\
\mbox{}\verb@        $depoch = $wjd - GREGORIAN_EPOCH;@\\
\mbox{}\verb@        $quadricent = floor($depoch / 146097);@\\
\mbox{}\verb@        $dqc = mod($depoch, 146097);@\\
\mbox{}\verb@        $cent = floor($dqc / 36524);@\\
\mbox{}\verb@        $dcent = mod($dqc, 36524);@\\
\mbox{}\verb@        $quad = floor($dcent / 1461);@\\
\mbox{}\verb@        $dquad = mod($dcent, 1461);@\\
\mbox{}\verb@        $yindex = floor($dquad / 365);@\\
\mbox{}\verb@        $year = ($quadricent * 400) + ($cent * 100) + ($quad * 4) + $yindex;@\\
\mbox{}\verb@        if (!(($cent == 4) || ($yindex == 4))) {@\\
\mbox{}\verb@            $year++;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        $yearday = $wjd - gregorian_to_jd($year, 1, 1);@\\
\mbox{}\verb@        $leapadj = (($wjd < gregorian_to_jd($year, 3, 1)) ? 0@\\
\mbox{}\verb@                                                      :@\\
\mbox{}\verb@                      (leap_gregorian($year) ? 1 : 2)@\\
\mbox{}\verb@                  );@\\
\mbox{}\verb@        $month = int(((($yearday + $leapadj) * 12) + 373) / 367);@\\
\mbox{}\verb@        $day = ($wjd - gregorian_to_jd($year, $month, 1)) + 1;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return ($year, $month, $day);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb445}{445}.
\item \NWtxtIdentsDefed\nobreak\  \verb@jd_to_gregorian@\nobreak\ \NWlink{nuweb52}{52}\NWlink{nuweb77}{, 77}\NWlink{nuweb84}{, 84}\NWlink{nuweb105}{, 105}\NWlink{nuweb111}{, 111}\NWlink{nuweb116}{, 116}\NWlink{nuweb259a}{, 259a}\NWlink{nuweb277a}{, 277a}\NWlink{nuweb277b}{b}\NWlink{nuweb349}{, 349}\NWlink{nuweb445}{, 445}\NWlink{nuweb451b}{, 451b}\NWlink{nuweb452a}{, 452a}\NWlink{nuweb452b}{b}\NWlink{nuweb453}{, 453}.\item \NWtxtIdentsUsed\nobreak\  \verb@floor@\nobreak\ \NWlink{nuweb446b}{446b}, \verb@GREGORIAN_EPOCH@\nobreak\ \NWlink{nuweb445}{445}, \verb@gregorian_to_jd@\nobreak\ \NWlink{nuweb447b}{447b}, \verb@leap_gregorian@\nobreak\ \NWlink{nuweb447a}{447a}, \verb@mod@\nobreak\ \NWlink{nuweb446b}{446b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Julian day to day of week}

An index denoting the day of the week (0$=$Sunday\ldots 6$=$Saturday)
is returned for the Julian day argument.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap606}\raggedright\small
\NWtarget{nuweb449a}{} $\langle\,${\itshape Julian day to day of week}\nobreak\ {\footnotesize {449a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub jd_to_weekday {@\\
\mbox{}\verb@        my $j = shift;@\\
\mbox{}\verb@        my $ij = int($j + 1.5);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $ij %= 7;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return ($ij < 0) ? (7 + $ij) : $ij;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb445}{445}.
\item \NWtxtIdentsDefed\nobreak\  \verb@jd_to_weekday@\nobreak\ \NWlink{nuweb36}{36}\NWlink{nuweb66}{, 66}\NWlink{nuweb261}{, 261}\NWlink{nuweb445}{, 445}\NWlink{nuweb453}{, 453}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Civil time to Julian day fraction}

Three arguments specifying the midnight-based hour, minute, and second
in civil time are converted to a day fraction which may be added to the
result of \verb+gregorian_to_jd+.  The seconds argument may contain a
fraction of seconds.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap607}\raggedright\small
\NWtarget{nuweb449b}{} $\langle\,${\itshape Civil time to Julian day fraction}\nobreak\ {\footnotesize {449b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub civil_time_to_jd {@\\
\mbox{}\verb@        my ($hour, $min, $sec) = @{\tt @}\verb@_;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $s = $sec + (60 * ($min + (60 * $hour)));@\\
\mbox{}\verb@        return ($s / (24 * 60 * 60));@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb445}{445}.
\item \NWtxtIdentsDefed\nobreak\  \verb@civil_time_to_jd@\nobreak\ \NWlink{nuweb445}{445}.\item \NWtxtIdentsUsed\nobreak\  \verb@min@\nobreak\ \NWlink{nuweb405}{405}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Julian day fraction to civil time}

Convert the day fraction in the noon-based Julian day argument
of civil hour, minute, and second, which are returned as an array.
Note that seconds are rounded to the nearest integer.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap608}\raggedright\small
\NWtarget{nuweb450a}{} $\langle\,${\itshape Julian day fraction to civil time}\nobreak\ {\footnotesize {450a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub jd_to_civil_time {@\\
\mbox{}\verb@        my $j = shift;@\\
\mbox{}\verb@        my ($ij, $hh, $mm, $ss);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        $j += 0.5;                    # Astronomical to civil@\\
\mbox{}\verb@        $ij = int(($j - floor($j)) * 86400.5);@\\
\mbox{}\verb@        $hh = int($ij / 3600);@\\
\mbox{}\verb@        $mm = int(($ij / 60) % 60);@\\
\mbox{}\verb@        $ss = int(($ij % 60) + 0.5);@\\
\mbox{}\verb@        return ($hh, $mm, $ss);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb445}{445}.
\item \NWtxtIdentsDefed\nobreak\  \verb@jd_to_civil_time@\nobreak\ \NWlink{nuweb445}{445}\NWlink{nuweb451b}{, 451b}\NWlink{nuweb452a}{, 452a}\NWlink{nuweb452b}{b}\NWlink{nuweb453}{, 453}.\item \NWtxtIdentsUsed\nobreak\  \verb@floor@\nobreak\ \NWlink{nuweb446b}{446b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{\UNIX/ time to Julian day and fraction}

\UNIX/ {\tt time()} values are defined as the number of seconds elapsed since
1970-01-01 at 00:00 UTC, not counting leap seconds.  This is a pure offset
from Julian Day number, so we need only add the offset and scale
appropriately.  The argument will usually be an integer, but need not be;
it may contain fractional seconds.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap609}\raggedright\small
\NWtarget{nuweb450b}{} $\langle\,${\itshape Unix time to Julian day and fraction}\nobreak\ {\footnotesize {450b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub unix_time_to_jd {@\\
\mbox{}\verb@        my $ut = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return J1970 + ($ut / (24 * 60 * 60));@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb445}{445}.
\item \NWtxtIdentsDefed\nobreak\  \verb@unix_time_to_jd@\nobreak\ \NWlink{nuweb142}{142}\NWlink{nuweb158a}{, 158a}\NWlink{nuweb259a}{, 259a}\NWlink{nuweb277a}{, 277a}\NWlink{nuweb277b}{b}\NWlink{nuweb349}{, 349}\NWlink{nuweb408}{, 408}\NWlink{nuweb445}{, 445}\NWlink{nuweb451b}{, 451b}.\item \NWtxtIdentsUsed\nobreak\  \verb@J1970@\nobreak\ \NWlink{nuweb445}{445}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Julian day and fraction to \UNIX/ time}

Even though we support arbitrary day fractions (up to the
precision of Perl numbers), \UNIX/ {\tt time()} values are traditionally
integers, so we force the result to be an integer here.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap610}\raggedright\small
\NWtarget{nuweb451a}{} $\langle\,${\itshape Julian day and fraction to Unix time}\nobreak\ {\footnotesize {451a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub jd_to_unix_time {@\\
\mbox{}\verb@        my $j = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return int((($j - J1970) * (24 * 60 * 60)) + 0.5);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb445}{445}.
\item \NWtxtIdentsDefed\nobreak\  \verb@jd_to_unix_time@\nobreak\ \NWlink{nuweb285}{285}\NWlink{nuweb291b}{, 291b}\NWlink{nuweb292}{, 292}\NWlink{nuweb293}{, 293}\NWlink{nuweb445}{, 445}.\item \NWtxtIdentsUsed\nobreak\  \verb@J1970@\nobreak\ \NWlink{nuweb445}{445}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{\UNIX/ time to civil date and time}

This function isn't properly a Julian date utility, but a
convenience for code which needs to work with \UNIX/ {\tt time()}
values which may exceed the ``doomsday date'' of 2038-01-19.
Perl, as of version 5.8, relies upon the C library's
{\tt gmtime} function to implement its own {\tt gmtime},
which results in disastrous truncation for days after
doomsday on 32-bit machines.

This function can be used to replace most (but not all) applications
of Perl's {\tt gmtime}, and avoids some of its C-legacy eccentricity.
It is called with a generalised \UNIX/ {\tt time} value which may
be negative or a positive value requiring more than 32 bits to
represent---any value corresponding to a non-negative Julian day
number is accepted.  A list is returned, containing values as
follows:

\begin{verbatim}
    ($year, $month, $day, $hour, $minute, $second) = unix_time_to_civil_date_time(time());
\end{verbatim}

\noindent
The year is the full Gregorian calendar year (no need to
add 1900), and the month value for January is 1.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap611}\raggedright\small
\NWtarget{nuweb451b}{} $\langle\,${\itshape Unix time to civil date and time}\nobreak\ {\footnotesize {451b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub unix_time_to_civil_date_time {@\\
\mbox{}\verb@        my $j = unix_time_to_jd(shift);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my @{\tt @}\verb@dt = jd_to_gregorian($j);@\\
\mbox{}\verb@        push(@{\tt @}\verb@dt, jd_to_civil_time($j));@\\
\mbox{}\verb@        return @{\tt @}\verb@dt;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb445}{445}.
\item \NWtxtIdentsDefed\nobreak\  \verb@unix_time_to_civil_date_time@\nobreak\ \NWlink{nuweb177}{177}\NWlink{nuweb207}{, 207}\NWlink{nuweb209}{, 209}\NWlink{nuweb223}{, 223}\NWlink{nuweb231}{, 231}\NWlink{nuweb234}{, 234}\NWlink{nuweb238}{, 238}\NWlink{nuweb262}{, 262}\NWlink{nuweb445}{, 445}.\item \NWtxtIdentsUsed\nobreak\  \verb@jd_to_civil_time@\nobreak\ \NWlink{nuweb450a}{450a}, \verb@jd_to_gregorian@\nobreak\ \NWlink{nuweb448}{448}, \verb@unix_time_to_jd@\nobreak\ \NWlink{nuweb450b}{450b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Julian day and fraction to RFC 822 time and date}

Comvert a Julian day and fraction to a date and time conforming to the
\href{http://www.ietf.org/rfc/rfc0822.txt}{
RFC 822
}
specification for Internet mail.  We assume that the Julian day
represents UTC and unconditionally specify the time zone as
``{\tt +0000}'' in the result.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap612}\raggedright\small
\NWtarget{nuweb452a}{} $\langle\,${\itshape Julian day and fraction to RFC 822 time and date}\nobreak\ {\footnotesize {452a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub jd_to_RFC_822_date {@\\
\mbox{}\verb@        my $j = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($uy, $um, $ud) = jd_to_gregorian($j);@\\
\mbox{}\verb@        my ($uhh, $umm, $uss) = jd_to_civil_time($j);@\\
\mbox{}\verb@@\\
\mbox{}\verb@       return sprintf("%02d/%s/%04d:%02d:%02d:%02d +0000",@\\
\mbox{}\verb@            $ud, MONTH_ABBREVIATIONS->[$um], $uy, $uhh, $umm, $uss);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb445}{445}.
\item \NWtxtIdentsDefed\nobreak\  \verb@jd_to_RFC_822_date@\nobreak\ \NWlink{nuweb445}{445}.\item \NWtxtIdentsUsed\nobreak\  \verb@jd_to_civil_time@\nobreak\ \NWlink{nuweb450a}{450a}, \verb@jd_to_gregorian@\nobreak\ \NWlink{nuweb448}{448}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Julian day and fraction to RFC 3339 time and date}

Comvert a Julian day and fraction to a date and time conforming to the
\href{http://www.ietf.org/rfc/rfc3339.txt}{
RFC 3339
}
date and time specification format, confirming to
ISO~8601.  We assume that the Julian day
represents UTC and unconditionally specify the time zone as
``{\tt Z}'' in the result.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap613}\raggedright\small
\NWtarget{nuweb452b}{} $\langle\,${\itshape Julian day and fraction to RFC 3339 time and date}\nobreak\ {\footnotesize {452b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub jd_to_RFC_3339_date {@\\
\mbox{}\verb@        my $j = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($uy, $um, $ud) = jd_to_gregorian($j);@\\
\mbox{}\verb@        my ($uhh, $umm, $uss) = jd_to_civil_time($j);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return sprintf("%04d-%02d-%02dT%02d:%02d:%02dZ",@\\
\mbox{}\verb@            $uy, $um, $ud, $uhh, $umm, $uss);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb445}{445}.
\item \NWtxtIdentsDefed\nobreak\  \verb@jd_to_RFC_3339_date@\nobreak\ \NWlink{nuweb355}{355}\NWlink{nuweb445}{, 445}.\item \NWtxtIdentsUsed\nobreak\  \verb@jd_to_civil_time@\nobreak\ \NWlink{nuweb450a}{450a}, \verb@jd_to_gregorian@\nobreak\ \NWlink{nuweb448}{448}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Julian day and fraction to old HTTP cookie time and date}

Comvert a Julian day and fraction to a date and time conforming to the
format used in ``old'' HTTP cookies, as defined in the
``HISTORICAL'' section of
\href{http://www.ietf.org/rfc/rfc2109.txt}{
RFC 2109
}.  (This is, in fact, a decade after the RFC,
the format which most sites continue to use for cookies. We assume
that the Julian day represents UTC.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap614}\raggedright\small
\NWtarget{nuweb453}{} $\langle\,${\itshape Julian day and fraction to old HTTP cookie time and date}\nobreak\ {\footnotesize {453}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    sub jd_to_old_cookie_date {@\\
\mbox{}\verb@        my $j = shift;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my ($uy, $um, $ud) = jd_to_gregorian($j);@\\
\mbox{}\verb@        my ($uhh, $umm, $uss) = jd_to_civil_time($j);@\\
\mbox{}\verb@        my $wdn = substr(WEEKDAY_NAMES->[jd_to_weekday($j)], 0, 3);@\\
\mbox{}\verb@        my $mabb = MONTH_ABBREVIATIONS->[$um - 1];@\\
\mbox{}\verb@@\\
\mbox{}\verb@        return sprintf("$wdn, %02d-$mabb-%04d %02d:%02d:%02d GMT",@\\
\mbox{}\verb@            $ud, $uy, $uhh, $umm, $uss);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb445}{445}.
\item \NWtxtIdentsDefed\nobreak\  \verb@jd_to_old_cookie_date@\nobreak\ \NWlink{nuweb158a}{158a}\NWlink{nuweb158b}{b}\NWlink{nuweb445}{, 445}.\item \NWtxtIdentsUsed\nobreak\  \verb@jd_to_civil_time@\nobreak\ \NWlink{nuweb450a}{450a}, \verb@jd_to_gregorian@\nobreak\ \NWlink{nuweb448}{448}, \verb@jd_to_weekday@\nobreak\ \NWlink{nuweb449a}{449a}, \verb@WEEKDAY_NAMES@\nobreak\ \NWlink{nuweb445}{445}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\clearpage
\vbox{
\chapter{Documentation in POD format}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap615}\raggedright\small
\NWtarget{nuweb455}{} $\langle\,${\itshape Documentation in POD format}\nobreak\ {\footnotesize {455}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@=head1 NAME@\\
\mbox{}\verb@@\\
\mbox{}\verb@HackDiet - Hacker's Diet Online Database Interface@\\
\mbox{}\verb@@\\
\mbox{}\verb@=head1 SYNOPSIS@\\
\mbox{}\verb@@\\
\mbox{}\verb@B<HackDiet.pl>@\\
\mbox{}\verb@[I<options>]@\\
\mbox{}\verb@@\\
\mbox{}\verb@=head1 DESCRIPTION@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Options documentation}\nobreak\ {\footnotesize \NWlink{nuweb456a}{456a}, \ldots\ }$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@=head1 VERSION@\\
\mbox{}\verb@@\\
\mbox{}\verb@This is B<HackDiet> version @\hbox{$\langle\,${\itshape Version}\nobreak\ {\footnotesize \NWlink{nuweb3a}{3a}}$\,\rangle$}\verb@, released @\hbox{$\langle\,${\itshape Release Date}\nobreak\ {\footnotesize \NWlink{nuweb3b}{3b}}$\,\rangle$}\verb@.@\\
\mbox{}\verb@The current version of this program is always posted at@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Book home URL}\nobreak\ {\footnotesize \NWlink{nuweb13f}{13f}}$\,\rangle$}\verb@/online/.@\\
\mbox{}\verb@@\\
\mbox{}\verb@=head1 AUTHOR@\\
\mbox{}\verb@@\\
\mbox{}\verb@John Walker@\\
\mbox{}\verb@(@\hbox{$\langle\,${\itshape Site home URL}\nobreak\ {\footnotesize \NWlink{nuweb13e}{13e}}$\,\rangle$}\verb@/)@\\
\mbox{}\verb@@\\
\mbox{}\verb@=head1 BUGS@\\
\mbox{}\verb@@\\
\mbox{}\verb@Please report any bugs to bugs@{\tt @}\verb@fourmilab.ch.@\\
\mbox{}\verb@@\\
\mbox{}\verb@=head1 SEE ALSO@\\
\mbox{}\verb@@\\
\mbox{}\verb@B<nuweb> (http://nuweb.sourceforge.net/),@\\
\mbox{}\verb@S<Literate Programming> (http://www.literateprogramming.com/).@\\
\mbox{}\verb@@\\
\mbox{}\verb@=head1 COPYRIGHT@\\
\mbox{}\verb@@\\
\mbox{}\verb@This program is in the public domain.@\\
\mbox{}\verb@@\\
\mbox{}\verb@=cut@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb173}{173}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Options}

Here we document the command-line options.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap616}\raggedright\small
\NWtarget{nuweb456a}{} $\langle\,${\itshape Options documentation}\nobreak\ {\footnotesize {456a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@=head1 OPTIONS@\\
\mbox{}\verb@@\\
\mbox{}\verb@All options may be abbreviated to their shortest@\\
\mbox{}\verb@unambiguous prefix.@\\
\mbox{}\verb@@\\
\mbox{}\verb@=over 5@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb456a}{456a}\NWlink{nuweb456b}{b}\NWlink{nuweb456c}{c}\NWlink{nuweb457a}{, 457a}\NWlink{nuweb457b}{b}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb455}{455}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{{\tt --copyright}}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap617}\raggedright\small
\NWtarget{nuweb456b}{} $\langle\,${\itshape Options documentation}\nobreak\ {\footnotesize {456b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@=item B<--copyright>@\\
\mbox{}\verb@@\\
\mbox{}\verb@Display copyright information.@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb456a}{456a}\NWlink{nuweb456b}{b}\NWlink{nuweb456c}{c}\NWlink{nuweb457a}{, 457a}\NWlink{nuweb457b}{b}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb455}{455}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{{\tt --help}}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap618}\raggedright\small
\NWtarget{nuweb456c}{} $\langle\,${\itshape Options documentation}\nobreak\ {\footnotesize {456c}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@=item B<--help>@\\
\mbox{}\verb@@\\
\mbox{}\verb@Display how to call information.@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb456a}{456a}\NWlink{nuweb456b}{b}\NWlink{nuweb456c}{c}\NWlink{nuweb457a}{, 457a}\NWlink{nuweb457b}{b}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb455}{455}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{{\tt --verbose}}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap619}\raggedright\small
\NWtarget{nuweb457a}{} $\langle\,${\itshape Options documentation}\nobreak\ {\footnotesize {457a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@=item B<--verbose>@\\
\mbox{}\verb@@\\
\mbox{}\verb@Generate verbose output to indicate what's going on.@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb456a}{456a}\NWlink{nuweb456b}{b}\NWlink{nuweb456c}{c}\NWlink{nuweb457a}{, 457a}\NWlink{nuweb457b}{b}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb455}{455}.
\item \NWtxtIdentsUsed\nobreak\  \verb@verbose@\nobreak\ \NWlink{nuweb71}{71}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{{\tt --version}}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap620}\raggedright\small
\NWtarget{nuweb457b}{} $\langle\,${\itshape Options documentation}\nobreak\ {\footnotesize {457b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@=item B<--version>@\\
\mbox{}\verb@@\\
\mbox{}\verb@Display version number.@\\
\mbox{}\verb@@\\
\mbox{}\verb@=back@\\
\mbox{}\verb@=cut@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroDefBy\ \NWlink{nuweb456a}{456a}\NWlink{nuweb456b}{b}\NWlink{nuweb456c}{c}\NWlink{nuweb457a}{, 457a}\NWlink{nuweb457b}{b}.
\item \NWtxtMacroRefIn\ \NWlink{nuweb455}{455}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

%    _   _            _    ____  _      _   ____            _
%   | | | | __ _  ___| | _|  _ \(_) ___| |_| __ )  __ _  __| | __ _  ___
%   | |_| |/ _` |/ __| |/ / | | | |/ _ \ __|  _ \ / _` |/ _` |/ _` |/ _ \
%   |  _  | (_| | (__|   <| |_| | |  __/ |_| |_) | (_| | (_| | (_| |  __/
%   |_| |_|\__,_|\___|_|\_\____/|_|\___|\__|____/ \__,_|\__,_|\__, |\___|
%                                                             |___/

\clearpage
\vbox{
\chapter{{\tt HackDietBadge.pl}: Return badge for user}
\label{HackDietBadge}

{\tt HackDietBadge.pl} is invoked by a URL provided to a user who
wishes to display a ``status badge'' on their Web page or log.  If
a badge image is configured, every time a change is made which
might affect the trend, the {\tt BadgeImage.png} image in the
user's directory is updated with the current data.  This is a
lightweight program which doesn't pull in any of the heavy machinery
of the main application.  All it does is parse the query, extract
the encrypted user name specification, verify it, and if everything
is valid copy the badge image as the CGI result.  If an error
is detected, a canned ``Invalid request'' image is returned and a
diagnostic message is output to {\tt STDERR} which will appear in
the Web server's error log.

}

\vbox{
\section{HackDietBadge}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap621}\raggedright\small
\NWtarget{nuweb459}{} \verb@"HackDietBadge.pl"@\nobreak\ {\footnotesize {459}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@#! @\hbox{$\langle\,${\itshape Perl directory}\nobreak\ {\footnotesize \NWlink{nuweb8d}{8d}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Perl language modes}\nobreak\ {\footnotesize \NWlink{nuweb387b}{387b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    use Crypt::OpenSSL::AES;@\\
\mbox{}\verb@    use Crypt::CBC;@\\
\mbox{}\verb@    use HDiet::Digest::Crc32;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print <<"EOD";@\\
\mbox{}\verb@Content-type: image/png\r@\\
\mbox{}\verb@Pragma: no-cache\r@\\
\mbox{}\verb@EOD@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (defined($ENV{QUERY_STRING}) && ($ENV{QUERY_STRING} =~ m/b=([0-9FGJKQW]+)/)) {@\\
\mbox{}\verb@        my $cuserid = $1;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $btype;@\\
\mbox{}\verb@        if ($ENV{QUERY_STRING} =~ m/t=(\d+)/) {@\\
\mbox{}\verb@            $btype = $1;@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            $btype = 0;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        my $user_file_name;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        eval {@\\
\mbox{}\verb@            $user_file_name = decodeEncryptedUserID($cuserid);@\\
\mbox{}\verb@        };@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ((!$@{\tt @}\verb@) && defined($user_file_name) &&@\\
\mbox{}\verb@            open(BI, "<@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/BadgeImage.png")) {@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            open(BI, "<@\hbox{$\langle\,${\itshape Image and Icon Directory}\nobreak\ {\footnotesize \NWlink{nuweb7a}{7a}}$\,\rangle$}\verb@/steenkin_badge.png") ||@\\
\mbox{}\verb@                die("Cannot open @\hbox{$\langle\,${\itshape Image and Icon Directory}\nobreak\ {\footnotesize \NWlink{nuweb7a}{7a}}$\,\rangle$}\verb@/steenkin_badge.png");@\\
\mbox{}\verb@            print(STDERR "HackDietBadge: Bogus or corrupted user specification\n");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        open(BI, "<@\hbox{$\langle\,${\itshape Image and Icon Directory}\nobreak\ {\footnotesize \NWlink{nuweb7a}{7a}}$\,\rangle$}\verb@/steenkin_badge.png") ||@\\
\mbox{}\verb@            die("Cannot open @\hbox{$\langle\,${\itshape Image and Icon Directory}\nobreak\ {\footnotesize \NWlink{nuweb7a}{7a}}$\,\rangle$}\verb@/steenkin_badge.png");@\\
\mbox{}\verb@        print(STDERR "HackDietBadge: Invalid or missing query string\n");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    print("Content-Length: ", -s BI, "\r\n\r\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $iobuf;@\\
\mbox{}\verb@    while (read(BI, $iobuf, 65536)) {@\\
\mbox{}\verb@        print($iobuf);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    close(BI);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Decode encrypted user ID}\nobreak\ {\footnotesize \NWlink{nuweb144}{144}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtIdentsUsed\nobreak\  \verb@decodeEncryptedUserID@\nobreak\ \NWlink{nuweb144}{144}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

%    _____         _         _ _
%   |_   _|__  ___| |_      | (_) __ _
%     | |/ _ \/ __| __|  _  | | |/ _` |
%     | |  __/\__ \ |_  | |_| | | (_| |
%     |_|\___||___/\__|  \___/|_|\__, |
%                                |___/

\clearpage
\vbox{
\chapter{{\tt jig.pl}: Test Jig}

The test jig is an executable program that includes all of the modules
of the CGI application which is used to run specific module tests
from the command line.  The nature of the tests evolves as the program
is developed and depends upon the current state of the project.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap622}\raggedright\small
\NWtarget{nuweb461}{} \verb@"jig.pl"@\nobreak\ {\footnotesize {461}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@#! @\hbox{$\langle\,${\itshape Perl directory}\nobreak\ {\footnotesize \NWlink{nuweb8d}{8d}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Global declarations}\nobreak\ {\footnotesize \NWlink{nuweb387a}{387a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    binmode(STDOUT, ":utf8");@\\
\mbox{}\verb@    binmode(STDIN, ":utf8");@\\
\mbox{}\verb@@\\
\mbox{}\verb@use Data::Dumper;@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $user_file_name = quoteUserName('John Walker');@\\
\mbox{}\verb@    if (!(-f "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/UserAccount.hdu")@\\
\mbox{}\verb@        || (!open(FU, "<:utf8", "@\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/UserAccount.hdu"))) {@\\
\mbox{}\verb@        die("Cannot open @\hbox{$\langle\,${\itshape Users Directory}\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$}\verb@/$user_file_name/UserAccount.hdu");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $ui = HDiet::user->new();@\\
\mbox{}\verb@    $ui->load(\*FU);@\\
\mbox{}\verb@    close(FU);@\\
\mbox{}\verb@@\\
\mbox{}\verb@#    $ui->describe();@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $uec = $ui->generateEncryptedUserID();@\\
\mbox{}\verb@    my $duec = decodeEncryptedUserID($uec);@\\
\mbox{}\verb@#    print(Dumper($uec, $duec));@\\
\mbox{}\verb@    print("Encoded ID: ($uec)\n");@\\
\mbox{}\verb@    print("User ID: ($duec)\n");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    my $hist = HDiet::history->new($ui, $user_file_name);@\\
\mbox{}\verb@    open(BF, ">/tmp/steenk.png") || die("Cannot create /tmp/steenk.png");@\\
\mbox{}\verb@    $hist->drawBadgeImage(\*BF, 14);@\\
\mbox{}\verb@    close(BF);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    exit(0);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Decode encrypted user ID}\nobreak\ {\footnotesize \NWlink{nuweb144}{144}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Utility functions}\nobreak\ {\footnotesize \NWlink{nuweb391}{391}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtIdentsUsed\nobreak\  \verb@decodeEncryptedUserID@\nobreak\ \NWlink{nuweb144}{144}, \verb@describe@\nobreak\ \NWlink{nuweb27}{27}\NWlink{nuweb122}{, 122}\NWlink{nuweb150}{, 150}\NWlink{nuweb156a}{, 156a}, \verb@drawBadgeImage@\nobreak\ \NWlink{nuweb101a}{101a}, \verb@generateEncryptedUserID@\nobreak\ \NWlink{nuweb143}{143}, \verb@load@\nobreak\ \NWlink{nuweb32a}{32a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}, \verb@quoteUserName@\nobreak\ \NWlink{nuweb145}{145}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

%    _
%   | |__  _   _ _ __ ___  _ __
%   | '_ \| | | | '_ ` _ \| '_ \
%   | |_) | |_| | | | | | | |_) |
%   |_.__/ \__,_|_| |_| |_| .__/
%                         |_|


\clearpage
\vbox{
\chapter{{\tt bump}: Increment build number}

This little shell script increments a number in the file
given by the argument.  It is used in the {\tt Makefile} to
increment the build number each time the Web file is extracted.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap623}\raggedright\small
\NWtarget{nuweb462}{} \verb@"bump"@\nobreak\ {\footnotesize {462}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@#! /bin/sh@\\
\mbox{}\verb@@\\
\mbox{}\verb@#   Increment a number kept in a file and echo it@\\
\mbox{}\verb@#   to standard output.@\\
\mbox{}\verb@@\\
\mbox{}\verb@LAST=`cat $1`@\\
\mbox{}\verb@NEXT=`expr $LAST \+ 1`@\\
\mbox{}\verb@echo $NEXT >$1@\\
\mbox{}\verb@echo $NEXT@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

%    ____  _         _          ____  _               _
%   / ___|| |_ _   _| | ___    / ___|| |__   ___  ___| |_
%   \___ \| __| | | | |/ _ \   \___ \| '_ \ / _ \/ _ \ __|
%    ___) | |_| |_| | |  __/    ___) | | | |  __/  __/ |_
%   |____/ \__|\__, |_|\___|   |____/|_| |_|\___|\___|\__|
%              |___/

\clearpage
\vbox{
\chapter{XHTML Style Sheet}

The {\tt hdiet.css} style sheet is shared by all documents in
the Web tree, both static and dynamically generated.
}

\vbox{
\section{Global document properties}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap624}\raggedright\small
\NWtarget{nuweb463}{} \verb@"hdiet.css"@\nobreak\ {\footnotesize {463}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    body {@\\
\mbox{}\verb@        margin-left: 10%;@\\
\mbox{}\verb@        margin-right: 10%;@\\
\mbox{}\verb@        background-color: #FFFFFF;@\\
\mbox{}\verb@        color: #000000;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb463}{463}\NWlink{nuweb464}{, 464}\NWlink{nuweb465}{, 465}\NWlink{nuweb466}{, 466}\NWlink{nuweb467a}{, 467a}\NWlink{nuweb467b}{b}\NWlink{nuweb468}{, 468}\NWlink{nuweb469}{, 469}\NWlink{nuweb470a}{, 470a}\NWlink{nuweb470b}{b}\NWlink{nuweb471a}{, 471a}\NWlink{nuweb471b}{b}\NWlink{nuweb472}{, 472}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Links}

The following define the default style for links within the
various documents.  The class ``{\tt i}'' links have no static or
dynamic decoration whatsoever; they are used in links which wrap
images and buttons where it should be self-evident that they
constitute a link (and the browser's default link rendering is
usually unspeakably ugly).

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap625}\raggedright\small
\NWtarget{nuweb464}{} \verb@"hdiet.css"@\nobreak\ {\footnotesize {464}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    a:link, a:visited {@\\
\mbox{}\verb@        background-color: inherit;@\\
\mbox{}\verb@        color: rgb(0%, 0%, 80%);@\\
\mbox{}\verb@        text-decoration: none;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    a:hover  {@\\
\mbox{}\verb@        background-color: rgb(30%, 30%, 100%);@\\
\mbox{}\verb@        color: rgb(100%, 100%, 100%);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    a:active {@\\
\mbox{}\verb@        color: rgb(100%, 0%, 0%);@\\
\mbox{}\verb@        background-color: rgb(30%, 30%, 100%);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    a.i:link, a.i:visited, a.i:hover {@\\
\mbox{}\verb@        background-color: inherit;@\\
\mbox{}\verb@        color: inherit;@\\
\mbox{}\verb@        text-decoration: none;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb463}{463}\NWlink{nuweb464}{, 464}\NWlink{nuweb465}{, 465}\NWlink{nuweb466}{, 466}\NWlink{nuweb467a}{, 467a}\NWlink{nuweb467b}{b}\NWlink{nuweb468}{, 468}\NWlink{nuweb469}{, 469}\NWlink{nuweb470a}{, 470a}\NWlink{nuweb470b}{b}\NWlink{nuweb471a}{, 471a}\NWlink{nuweb471b}{b}\NWlink{nuweb472}{, 472}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Headings and titles}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap626}\raggedright\small
\NWtarget{nuweb465}{} \verb@"hdiet.css"@\nobreak\ {\footnotesize {465}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    h1.c, h2.c {@\\
\mbox{}\verb@        text-align: center;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    h1.monthyear, h1.pr_monthyear, h1.pr_mo_monthyear, h1.mo_monthyear {@\\
\mbox{}\verb@        font-family: Helvetica, Arial, sans-serif;@\\
\mbox{}\verb@        text-align: center;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    h3.acct_category {@\\
\mbox{}\verb@        margin-top: 0px;@\\
\mbox{}\verb@        text-align: center;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    h3.browsing {@\\
\mbox{}\verb@        font-family: Helvetica, Arial, sans-serif;@\\
\mbox{}\verb@        text-align: center;@\\
\mbox{}\verb@        color: #FFFFFF;@\\
\mbox{}\verb@        background-color:  #00A000;@\\
\mbox{}\verb@        width: 66%;@\\
\mbox{}\verb@        margin-left: auto;@\\
\mbox{}\verb@        margin-right: auto;@\\
\mbox{}\verb@        padding-top: 2px;@\\
\mbox{}\verb@        padding-bottom: 3px;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    h3.warning {@\\
\mbox{}\verb@        font-family: Helvetica, Arial, sans-serif;@\\
\mbox{}\verb@        text-align: justify;@\\
\mbox{}\verb@        color: #000000;@\\
\mbox{}\verb@        background-color:  #F0F000;@\\
\mbox{}\verb@        width: 80%;@\\
\mbox{}\verb@        margin-left: auto;@\\
\mbox{}\verb@        margin-right: auto;@\\
\mbox{}\verb@        padding-left: 8px;@\\
\mbox{}\verb@        padding-right: 8px;@\\
\mbox{}\verb@        padding-top: 4px;@\\
\mbox{}\verb@        padding-bottom: 4px;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    .monthyear span {@\\
\mbox{}\verb@        background-color: #0000FF;@\\
\mbox{}\verb@        color: #FFFF00;@\\
\mbox{}\verb@        border-width: 4px;@\\
\mbox{}\verb@        border-color: #8080FF;@\\
\mbox{}\verb@        border-style: outset;@\\
\mbox{}\verb@        padding: 6px;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    span.title1 {@\\
\mbox{}\verb@        font-size: x-large;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    span.title2 {@\\
\mbox{}\verb@        font-size: large;@\\
\mbox{}\verb@        font-style: italic;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb463}{463}\NWlink{nuweb464}{, 464}\NWlink{nuweb465}{, 465}\NWlink{nuweb466}{, 466}\NWlink{nuweb467a}{, 467a}\NWlink{nuweb467b}{b}\NWlink{nuweb468}{, 468}\NWlink{nuweb469}{, 469}\NWlink{nuweb470a}{, 470a}\NWlink{nuweb470b}{b}\NWlink{nuweb471a}{, 471a}\NWlink{nuweb471b}{b}\NWlink{nuweb472}{, 472}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Blocks of text}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap627}\raggedright\small
\NWtarget{nuweb466}{} \verb@"hdiet.css"@\nobreak\ {\footnotesize {466}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    .justified {@\\
\mbox{}\verb@        text-align: justify;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    .centred {@\\
\mbox{}\verb@        text-align: center;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb463}{463}\NWlink{nuweb464}{, 464}\NWlink{nuweb465}{, 465}\NWlink{nuweb466}{, 466}\NWlink{nuweb467a}{, 467a}\NWlink{nuweb467b}{b}\NWlink{nuweb468}{, 468}\NWlink{nuweb469}{, 469}\NWlink{nuweb470a}{, 470a}\NWlink{nuweb470b}{b}\NWlink{nuweb471a}{, 471a}\NWlink{nuweb471b}{b}\NWlink{nuweb472}{, 472}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}


\vbox{
\section{Block text styles}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap628}\raggedright\small
\NWtarget{nuweb467a}{} \verb@"hdiet.css"@\nobreak\ {\footnotesize {467a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    p.acct_summary {@\\
\mbox{}\verb@        text-align: center;@\\
\mbox{}\verb@        margin-top: 0px;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    p.build {@\\
\mbox{}\verb@        text-align: right;@\\
\mbox{}\verb@        font-family: sans-serif;@\\
\mbox{}\verb@        font-size: smaller;@\\
\mbox{}\verb@        color: #909090;@\\
\mbox{}\verb@        background-color: inherit;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb463}{463}\NWlink{nuweb464}{, 464}\NWlink{nuweb465}{, 465}\NWlink{nuweb466}{, 466}\NWlink{nuweb467a}{, 467a}\NWlink{nuweb467b}{b}\NWlink{nuweb468}{, 468}\NWlink{nuweb469}{, 469}\NWlink{nuweb470a}{, 470a}\NWlink{nuweb470b}{b}\NWlink{nuweb471a}{, 471a}\NWlink{nuweb471b}{b}\NWlink{nuweb472}{, 472}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Inline text decoration}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap629}\raggedright\small
\NWtarget{nuweb467b}{} \verb@"hdiet.css"@\nobreak\ {\footnotesize {467b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    span.imported {@\\
\mbox{}\verb@        background-color: #FFFFFF;@\\
\mbox{}\verb@        color: inherit;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    span.notentry {@\\
\mbox{}\verb@        background-color: #FFFF00;@\\
\mbox{}\verb@        color: inherit;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    span.noparse {@\\
\mbox{}\verb@        background-color: #FFA0A0;@\\
\mbox{}\verb@        color: inherit;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    span.conflict {@\\
\mbox{}\verb@        background-color: #A0FFFF;@\\
\mbox{}\verb@        color: inherit;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    span.administrator {@\\
\mbox{}\verb@        color: #00A000;@\\
\mbox{}\verb@        background-color: inherit;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    span.shrill {@\\
\mbox{}\verb@        color: #FF0000;@\\
\mbox{}\verb@        background-color: inherit;@\\
\mbox{}\verb@        font-weight: bold;@\\
\mbox{}\verb@        font-style: italic;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    .darwin {@\\
\mbox{}\verb@        /* Why not use background-image?  Because it doesn't work@\\
\mbox{}\verb@           with Exploder (neither 6 nor 7).  See Microsoft Krap Bulletin 322240:@\\
\mbox{}\verb@               http://support.microsoft.com/kb/322240  */@\\
\mbox{}\verb@        background: url(@\hbox{$\langle\,${\itshape Web Document Home}\nobreak\ {\footnotesize \NWlink{nuweb5d}{5d}}$\,\rangle$}\verb@/figures/darwin.png);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb463}{463}\NWlink{nuweb464}{, 464}\NWlink{nuweb465}{, 465}\NWlink{nuweb466}{, 466}\NWlink{nuweb467a}{, 467a}\NWlink{nuweb467b}{b}\NWlink{nuweb468}{, 468}\NWlink{nuweb469}{, 469}\NWlink{nuweb470a}{, 470a}\NWlink{nuweb470b}{b}\NWlink{nuweb471a}{, 471a}\NWlink{nuweb471b}{b}\NWlink{nuweb472}{, 472}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Fieldsets}

We use \verb+<fieldset>+ tags in the CSV import form to make it clear
that importing by uploading a file is a completely distinct operation
from importing CSV entries pasted into a text area.  The style of this page
owes a great deal to the W3C XHTML validator.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap630}\raggedright\small
\NWtarget{nuweb468}{} \verb@"hdiet.css"@\nobreak\ {\footnotesize {468}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    fieldset {@\\
\mbox{}\verb@        padding: .5em;@\\
\mbox{}\verb@        background: white;@\\
\mbox{}\verb@        border: 1px dotted #9090FF;@\\
\mbox{}\verb@        margin-left: 20px;@\\
\mbox{}\verb@        margin-right: 20px;@\\
\mbox{}\verb@        margin-top: .5em;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    fieldset legend {@\\
\mbox{}\verb@        color: #FFFFFF;@\\
\mbox{}\verb@        background-color: #9090FF;@\\
\mbox{}\verb@        font-size: smaller;@\\
\mbox{}\verb@        padding: .1ex .5ex;@\\
\mbox{}\verb@        border-right: 1px solid gray;@\\
\mbox{}\verb@        border-bottom: 1px solid gray;@\\
\mbox{}\verb@        font-weight: bold;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    input {@\\
\mbox{}\verb@        vertical-align: middle;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    input.reset {@\\
\mbox{}\verb@        text-align: center;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    input.default {@\\
\mbox{}\verb@        text-align: center;@\\
\mbox{}\verb@        font-weight: bold;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb463}{463}\NWlink{nuweb464}{, 464}\NWlink{nuweb465}{, 465}\NWlink{nuweb466}{, 466}\NWlink{nuweb467a}{, 467a}\NWlink{nuweb467b}{b}\NWlink{nuweb468}{, 468}\NWlink{nuweb469}{, 469}\NWlink{nuweb470a}{, 470a}\NWlink{nuweb470b}{b}\NWlink{nuweb471a}{, 471a}\NWlink{nuweb471b}{b}\NWlink{nuweb472}{, 472}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Images}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap631}\raggedright\small
\NWtarget{nuweb469}{} \verb@"hdiet.css"@\nobreak\ {\footnotesize {469}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    img.b0 {@\\
\mbox{}\verb@        border: 0px;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb463}{463}\NWlink{nuweb464}{, 464}\NWlink{nuweb465}{, 465}\NWlink{nuweb466}{, 466}\NWlink{nuweb467a}{, 467a}\NWlink{nuweb467b}{b}\NWlink{nuweb468}{, 468}\NWlink{nuweb469}{, 469}\NWlink{nuweb470a}{, 470a}\NWlink{nuweb470b}{b}\NWlink{nuweb471a}{, 471a}\NWlink{nuweb471b}{b}\NWlink{nuweb472}{, 472}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Canvas}

A ``{\tt canvas}'' division is positioned by the JavaScript code
to overlap the chart image in a monthly log page.  This permits
the live update code to draw new entries into the chart as they
are made in the log.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap632}\raggedright\small
\NWtarget{nuweb470a}{} \verb@"hdiet.css"@\nobreak\ {\footnotesize {470a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    div.canvas {@\\
\mbox{}\verb@        border: 0px;@\\
\mbox{}\verb@        position: absolute;@\\
\mbox{}\verb@        left: 0px;@\\
\mbox{}\verb@        top: 0px;@\\
\mbox{}\verb@        height: 100px;@\\
\mbox{}\verb@        width: 100px;@\\
\mbox{}\verb@        visibility: hidden;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb463}{463}\NWlink{nuweb464}{, 464}\NWlink{nuweb465}{, 465}\NWlink{nuweb466}{, 466}\NWlink{nuweb467a}{, 467a}\NWlink{nuweb467b}{b}\NWlink{nuweb468}{, 468}\NWlink{nuweb469}{, 469}\NWlink{nuweb470a}{, 470a}\NWlink{nuweb470b}{b}\NWlink{nuweb471a}{, 471a}\NWlink{nuweb471b}{b}\NWlink{nuweb472}{, 472}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Lists}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap633}\raggedright\small
\NWtarget{nuweb470b}{} \verb@"hdiet.css"@\nobreak\ {\footnotesize {470b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    li.skip {@\\
\mbox{}\verb@        margin-top: 1ex;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    ul.goofs {@\\
\mbox{}\verb@        font-family: Helvetica, Arial, sans-serif;@\\
\mbox{}\verb@        text-align: justify;@\\
\mbox{}\verb@        color: #FF0000;@\\
\mbox{}\verb@        background-color:  inherit;@\\
\mbox{}\verb@        width: 80%;@\\
\mbox{}\verb@        margin-left: auto;@\\
\mbox{}\verb@        margin-right: auto;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb463}{463}\NWlink{nuweb464}{, 464}\NWlink{nuweb465}{, 465}\NWlink{nuweb466}{, 466}\NWlink{nuweb467a}{, 467a}\NWlink{nuweb467b}{b}\NWlink{nuweb468}{, 468}\NWlink{nuweb469}{, 469}\NWlink{nuweb470a}{, 470a}\NWlink{nuweb470b}{b}\NWlink{nuweb471a}{, 471a}\NWlink{nuweb471b}{b}\NWlink{nuweb472}{, 472}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Navigation}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap634}\raggedright\small
\NWtarget{nuweb471a}{} \verb@"hdiet.css"@\nobreak\ {\footnotesize {471a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    p.mlog_buttons {@\\
\mbox{}\verb@        text-align: center;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    p.trendan {@\\
\mbox{}\verb@        font-weight: bold;@\\
\mbox{}\verb@        text-align: center;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    span.accesskey {@\\
\mbox{}\verb@        text-decoration: underline;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    span.required {@\\
\mbox{}\verb@        background-color: inherit;@\\
\mbox{}\verb@        color: #FF0000;@\\
\mbox{}\verb@        font-weight: bold;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    h4.nav {@\\
\mbox{}\verb@        margin-top: 0px;@\\
\mbox{}\verb@        margin-bottom: 0px;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb463}{463}\NWlink{nuweb464}{, 464}\NWlink{nuweb465}{, 465}\NWlink{nuweb466}{, 466}\NWlink{nuweb467a}{, 467a}\NWlink{nuweb467b}{b}\NWlink{nuweb468}{, 468}\NWlink{nuweb469}{, 469}\NWlink{nuweb470a}{, 470a}\NWlink{nuweb470b}{b}\NWlink{nuweb471a}{, 471a}\NWlink{nuweb471b}{b}\NWlink{nuweb472}{, 472}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Paper log forms}

The following style definitions are used when printing paper log
forms.  We explicitly insert page breaks before all but the
first division container in which the log pages are enclosed.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap635}\raggedright\small
\NWtarget{nuweb471b}{} \verb@"hdiet.css"@\nobreak\ {\footnotesize {471b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    div.plog_subsequent {@\\
\mbox{}\verb@        page-break-before: always;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    h1.plog {@\\
\mbox{}\verb@        margin-bottom: 0px;@\\
\mbox{}\verb@        text-align: center;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    h2.plog {@\\
\mbox{}\verb@        margin-top: 0px;@\\
\mbox{}\verb@        text-align: center;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.plog {@\\
\mbox{}\verb@        margin-left: auto;@\\
\mbox{}\verb@        margin-right: auto;@\\
\mbox{}\verb@        width: 100%;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.plog tr.heading {@\\
\mbox{}\verb@        font-weight: bold;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.plog th.h1 {@\\
\mbox{}\verb@        text-align: center;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.plog th.h7 {@\\
\mbox{}\verb@        text-align: center;@\\
\mbox{}\verb@        width: 33em;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.plog th.c1 {@\\
\mbox{}\verb@        text-align: right;@\\
\mbox{}\verb@        width: 2em;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.plog td.s1 {@\\
\mbox{}\verb@        width: 0.5em;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.plog td.c2 {@\\
\mbox{}\verb@        text-align: left;@\\
\mbox{}\verb@        width: 2em;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.plog td.s2 {@\\
\mbox{}\verb@        width: 1em;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.plog td.c3 {@\\
\mbox{}\verb@        border-bottom: 1px solid black;@\\
\mbox{}\verb@        width: 3em;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.plog td.s3 {@\\
\mbox{}\verb@        width: 1em;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.plog td.c4 {@\\
\mbox{}\verb@        border-bottom: 1px solid black;@\\
\mbox{}\verb@        width: 3em;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.plog td.s4 {@\\
\mbox{}\verb@        width: 1em;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.plog td.c5 {@\\
\mbox{}\verb@        border-bottom: 1px solid black;@\\
\mbox{}\verb@        width: 2em;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.plog td.s5 {@\\
\mbox{}\verb@        width: 1em;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.plog td.c6 {@\\
\mbox{}\verb@        border-bottom: 1px solid black;@\\
\mbox{}\verb@        width: 33em;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb463}{463}\NWlink{nuweb464}{, 464}\NWlink{nuweb465}{, 465}\NWlink{nuweb466}{, 466}\NWlink{nuweb467a}{, 467a}\NWlink{nuweb467b}{b}\NWlink{nuweb468}{, 468}\NWlink{nuweb469}{, 469}\NWlink{nuweb470a}{, 470a}\NWlink{nuweb470b}{b}\NWlink{nuweb471a}{, 471a}\NWlink{nuweb471b}{b}\NWlink{nuweb472}{, 472}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Tables}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap636}\raggedright\small
\NWtarget{nuweb472}{} \verb@"hdiet.css"@\nobreak\ {\footnotesize {472}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Page title table}\nobreak\ {\footnotesize \NWlink{nuweb473a}{473a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Sign in and account management tables}\nobreak\ {\footnotesize \NWlink{nuweb473b}{473b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Monthly log table}\nobreak\ {\footnotesize \NWlink{nuweb474}{474}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Navigation bar table}\nobreak\ {\footnotesize \NWlink{nuweb476}{476}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Trend analysis table}\nobreak\ {\footnotesize \NWlink{nuweb475}{475}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Calendar Navigation Tables}\nobreak\ {\footnotesize \NWlink{nuweb477}{477}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Persistent login manager table}\nobreak\ {\footnotesize \NWlink{nuweb478a}{478a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Feedback message table}\nobreak\ {\footnotesize \NWlink{nuweb478b}{478b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Global statistics tables}\nobreak\ {\footnotesize \NWlink{nuweb479}{479}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb463}{463}\NWlink{nuweb464}{, 464}\NWlink{nuweb465}{, 465}\NWlink{nuweb466}{, 466}\NWlink{nuweb467a}{, 467a}\NWlink{nuweb467b}{b}\NWlink{nuweb468}{, 468}\NWlink{nuweb469}{, 469}\NWlink{nuweb470a}{, 470a}\NWlink{nuweb470b}{b}\NWlink{nuweb471a}{, 471a}\NWlink{nuweb471b}{b}\NWlink{nuweb472}{, 472}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Page title table}

We use a uniform design for the title of all pages.  This consists
of a table containing two navigation icons at the left and
right and the main title centred in the middle.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap637}\raggedright\small
\NWtarget{nuweb473a}{} $\langle\,${\itshape Page title table}\nobreak\ {\footnotesize {473a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    table.title {@\\
\mbox{}\verb@        width: 100%;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.title td.licon {@\\
\mbox{}\verb@        width: 90px;@\\
\mbox{}\verb@        text-align: left;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.title td.ricon {@\\
\mbox{}\verb@        width: 90px;@\\
\mbox{}\verb@        text-align: right;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb472}{472}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}


\vbox{
\subsection{Sign in and account management tables}

The following styles are used by all of the forms related
to account management: new account creation, account
settings changes, and sign in.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap638}\raggedright\small
\NWtarget{nuweb473b}{} $\langle\,${\itshape Sign in and account management tables}\nobreak\ {\footnotesize {473b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    table.login {@\\
\mbox{}\verb@        background-color: #E0E0FF;@\\
\mbox{}\verb@        color: #000000;@\\
\mbox{}\verb@        margin-left: auto;@\\
\mbox{}\verb@        margin-right: auto;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.login th {@\\
\mbox{}\verb@        text-align: left;@\\
\mbox{}\verb@        padding-right: 1em;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb472}{472}.
\item \NWtxtIdentsUsed\nobreak\  \verb@login@\nobreak\ \NWlink{nuweb121}{121}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Monthly log table}

The monthly log table includes both static text and editable
fields.  Span definitions are used to colour code
variance items according to their sign.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap639}\raggedright\small
\NWtarget{nuweb474}{} $\langle\,${\itshape Monthly log table}\nobreak\ {\footnotesize {474}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    table.mlog, table.mo_mlog {@\\
\mbox{}\verb@        background-color: #D0D0D0;@\\
\mbox{}\verb@        color: #000000;@\\
\mbox{}\verb@        margin-left: auto;@\\
\mbox{}\verb@        margin-right: auto;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.pr_mlog, table.pr_mo_mlog {@\\
\mbox{}\verb@        margin-left: auto;@\\
\mbox{}\verb@        margin-right: auto;@\\
\mbox{}\verb@        border: thin solid;@\\
\mbox{}\verb@        border-collapse: collapse;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.pr_mlog td, table.pr_mlog th, table.pr_mo_mlog td, table.pr_mo_mlog th {@\\
\mbox{}\verb@        padding-left: 0.2em;@\\
\mbox{}\verb@        padding-right: 0.2em;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    td.r {@\\
\mbox{}\verb@        text-align: right;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    span.r {@\\
\mbox{}\verb@        color: #FF0000;@\\
\mbox{}\verb@        background-color: #D0D0D0;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    span.bk {@\\
\mbox{}\verb@        color: #000000;@\\
\mbox{}\verb@        background-color: #D0D0D0;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    span.g {@\\
\mbox{}\verb@        color: #00A000;@\\
\mbox{}\verb@        background-color: #D0D0D0;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    span.pr_r {@\\
\mbox{}\verb@        color: #FF0000;@\\
\mbox{}\verb@        background-color: inherit;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    span.pr_bk {@\\
\mbox{}\verb@        color: #000000;@\\
\mbox{}\verb@        background-color: inherit;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    span.pr_g {@\\
\mbox{}\verb@        color: #00A000;@\\
\mbox{}\verb@        background-color: inherit;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb472}{472}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Trend analysis table}

The trend analysis table presents the weight and energy balance
of the standard trend intervals up to the most recent log
entry and, optionally, a user-specified custom trend interval.
Items in this table ``borrow'' the {\tt span} styles from the
monthly log table to colour code positive and negative numbers.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap640}\raggedright\small
\NWtarget{nuweb475}{} $\langle\,${\itshape Trend analysis table}\nobreak\ {\footnotesize {475}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    table.trendan {@\\
\mbox{}\verb@        background-color: #D0D0D0;@\\
\mbox{}\verb@        color: #000000;@\\
\mbox{}\verb@        margin-left: auto;@\\
\mbox{}\verb@        margin-right: auto;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.trendan td.w, td.e {@\\
\mbox{}\verb@        text-align: center;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.trendan th.custitle {@\\
\mbox{}\verb@        background-color: #E0E0FF;@\\
\mbox{}\verb@        color: #000000;@\\
\mbox{}\verb@        border-left-style: none;@\\
\mbox{}\verb@        border-right-style: none;@\\
\mbox{}\verb@     }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.trendan th {@\\
\mbox{}\verb@        padding-left: 4px;@\\
\mbox{}\verb@        padding-right: 4px;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb472}{472}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Navigation bar table}

The following declarations define the style of the navigation bar
which appears at the top of all pages displayed during a session.
The navigation bar is a full page width table with a single row
which contains columns for each of the destinations available
from it.  The {\tt td} item representing the present page (if any) is
given a class of {\tt active}.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap641}\raggedright\small
\NWtarget{nuweb476}{} $\langle\,${\itshape Navigation bar table}\nobreak\ {\footnotesize {476}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    table.navbar {@\\
\mbox{}\verb@        background-color: #6060FF;@\\
\mbox{}\verb@        color: #FFFFFF;@\\
\mbox{}\verb@        width: 100%;@\\
\mbox{}\verb@        font-family: Helvetica, Arial, sans-serif;@\\
\mbox{}\verb@        font-weight: bold;@\\
\mbox{}\verb@        font-size: larger;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.navbar td:first-child {@\\
\mbox{}\verb@        border-left: none;@\\
\mbox{}\verb@        text-align: center;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@   table.navbar td {@\\
\mbox{}\verb@        border-left: 2px solid #FFFFFF;@\\
\mbox{}\verb@        text-align: center;@\\
\mbox{}\verb@        padding-left: 8px;@\\
\mbox{}\verb@        padding-right: 8px;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.navbar td.active {@\\
\mbox{}\verb@        color: #FFFF60;@\\
\mbox{}\verb@        background-color: #6060FF;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.navbar td.disabled {@\\
\mbox{}\verb@        color: #D0D0D0;@\\
\mbox{}\verb@        background-color: #6060FF;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.navbar td.pad {@\\
\mbox{}\verb@        width: 99%;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    a.navbar:link, a.navbar:visited {@\\
\mbox{}\verb@        background-color: inherit;@\\
\mbox{}\verb@        color: #FFFFFF;@\\
\mbox{}\verb@        text-decoration: none;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    a.navbar:hover  {@\\
\mbox{}\verb@        background-color: #30D030;@\\
\mbox{}\verb@        color: inherit;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    a.navbar:active {@\\
\mbox{}\verb@        color: #FF3030;@\\
\mbox{}\verb@        background-color: #30D030;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb472}{472}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Calendar Navigation Tables}

Access to all historical logs in the database is via the calendar
page, which shows a list of calendars, each representing a year.
Within each year's calendar, months present in the database
are linked to a monthly log page which will display them.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap642}\raggedright\small
\NWtarget{nuweb477}{} $\langle\,${\itshape Calendar Navigation Tables}\nobreak\ {\footnotesize {477}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    table.list_of_calendars {@\\
\mbox{}\verb@        margin-left: auto;@\\
\mbox{}\verb@        margin-right: auto;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.calendar {@\\
\mbox{}\verb@        margin: 16px;@\\
\mbox{}\verb@        color: inherit;@\\
\mbox{}\verb@        background-color: #E0E0E0;@\\
\mbox{}\verb@   }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.calendar th {@\\
\mbox{}\verb@        font-size: larger;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.calendar td {@\\
\mbox{}\verb@        padding: 4px;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb472}{472}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Persistent login manager table}

The only peculiarity with the persistent login manager table
is the token (cookie) field, which we want to display in a
monospace font and smaller so the table isn't so wide.  This
class definition is not bound to the persistent login table
and may be used elsewhere should the need arise.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap643}\raggedright\small
\NWtarget{nuweb478a}{} $\langle\,${\itshape Persistent login manager table}\nobreak\ {\footnotesize {478a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    td.monospace {@\\
\mbox{}\verb@        font-family: monospace;@\\
\mbox{}\verb@        font-size: smaller;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb472}{472}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Feedback message table}

Access to all historical logs in the database is via the calendar
page, which shows a list of calendars, each representing a year.
Within each year's calendar, months present in the database
are linked to a monthly log page which will display them.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap644}\raggedright\small
\NWtarget{nuweb478b}{} $\langle\,${\itshape Feedback message table}\nobreak\ {\footnotesize {478b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    table.feedback {@\\
\mbox{}\verb@        width: 80%;@\\
\mbox{}\verb@        color: inherit;@\\
\mbox{}\verb@        background-color: #E0E0E0;@\\
\mbox{}\verb@        margin-left: auto;@\\
\mbox{}\verb@        margin-right: auto;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.feedback th.t {@\\
\mbox{}\verb@        vertical-align: top;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    .preview {@\\
\mbox{}\verb@        padding: 8px;@\\
\mbox{}\verb@        background-color: #FFFFA0;@\\
\mbox{}\verb@        width: 80%;@\\
\mbox{}\verb@        margin-left: auto;@\\
\mbox{}\verb@        margin-right: auto;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    div.spell_ok {@\\
\mbox{}\verb@        background-color: #00C000;@\\
\mbox{}\verb@        color: #FFFFFF;@\\
\mbox{}\verb@        width: 80%;@\\
\mbox{}\verb@        margin-left: auto;@\\
\mbox{}\verb@        margin-right: auto;@\\
\mbox{}\verb@        padding-left: 8px;@\\
\mbox{}\verb@        padding-right: 8px;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    div.spell_ok h4 {@\\
\mbox{}\verb@        padding-top: 2px;@\\
\mbox{}\verb@        padding-bottom: 4px;@\\
\mbox{}\verb@        font-family: sans-serif;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    div.spell_dubieties {@\\
\mbox{}\verb@        background-color: #FFA0A0;@\\
\mbox{}\verb@        color: inherit;@\\
\mbox{}\verb@        width: 80%;@\\
\mbox{}\verb@        margin-left: auto;@\\
\mbox{}\verb@        margin-right: auto;@\\
\mbox{}\verb@        padding-left: 8px;@\\
\mbox{}\verb@        padding-right: 8px;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    div.spell_dubieties h4 {@\\
\mbox{}\verb@        padding-top: 2px;@\\
\mbox{}\verb@        font-family: sans-serif;@\\
\mbox{}\verb@        margin-bottom: 0px;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb472}{472}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Global statistics tables}

The global statistics are presented in a series of tables which
share the following styles.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap645}\raggedright\small
\NWtarget{nuweb479}{} $\langle\,${\itshape Global statistics tables}\nobreak\ {\footnotesize {479}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    table.global_stats {@\\
\mbox{}\verb@        background-color: #D0D0D0;@\\
\mbox{}\verb@        color: #000000;@\\
\mbox{}\verb@        border: 3px ridge;@\\
\mbox{}\verb@        margin-left: auto;@\\
\mbox{}\verb@        margin-right: auto;@\\
\mbox{}\verb@        border-collapse: collapse;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.global_stats td {@\\
\mbox{}\verb@        text-align: right;@\\
\mbox{}\verb@        border: 3px ridge;@\\
\mbox{}\verb@        padding-left: 1em;@\\
\mbox{}\verb@        padding-right: 1em;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.global_stats td.c {@\\
\mbox{}\verb@        text-align: center;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.global_stats th.l {@\\
\mbox{}\verb@        text-align: left;@\\
\mbox{}\verb@        border: 3px ridge;@\\
\mbox{}\verb@        padding-right: 1em;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.global_stats th.l {@\\
\mbox{}\verb@        border-right: none;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.global_stats th.blr {@\\
\mbox{}\verb@        border-left: 3px ridge;@\\
\mbox{}\verb@        border-right: 3px ridge;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.global_stats th.bl {@\\
\mbox{}\verb@        border-left: 3px ridge;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb472}{472}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

%    _   _                 _ _          _     _
%   | | | | __ _ _ __   __| | |__   ___| | __| |
%   | |_| |/ _` | '_ \ / _` | '_ \ / _ \ |/ _` |
%   |  _  | (_| | | | | (_| | | | |  __/ | (_| |
%   |_| |_|\__,_|_| |_|\__,_|_| |_|\___|_|\__,_|
%

\clearpage
\vbox{
\chapter{XHTML Handheld Style Sheet}

The {\tt hdiet\_handheld.css} style sheet supplies
the rules used when pages are displayed on handheld devices such as
personal digital assistants or mobile telephones.  Because these
devices typically have slow Internet connections, the size of this
file should be kept as small as possible.
}

\vbox{
\section{Global document properties}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap646}\raggedright\small
\NWtarget{nuweb480}{} \verb@"hdiet_handheld.css"@\nobreak\ {\footnotesize {480}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    table.login {@\\
\mbox{}\verb@        background-color: #FFFFFF;@\\
\mbox{}\verb@        color: #000000;@\\
\mbox{}\verb@        margin-left: 0px;@\\
\mbox{}\verb@        margin-right: auto;@\\
\mbox{}\verb@        border: none;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    table.login td, table.login th {@\\
\mbox{}\verb@        border: none;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtIdentsUsed\nobreak\  \verb@login@\nobreak\ \NWlink{nuweb121}{121}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

%        _                  ____            _       _
%       | | __ ___   ____ _/ ___|  ___ _ __(_)_ __ | |_
%    _  | |/ _` \ \ / / _` \___ \ / __| '__| | '_ \| __|
%   | |_| | (_| |\ V / (_| |___) | (__| |  | | |_) | |_
%    \___/ \__,_| \_/ \__,_|____/ \___|_|  |_| .__/ \__|
%                                            |_|

\clearpage
\vbox{
\chapter{JavaScript Utilities}

The {\tt hdiet.js} JavaScript program includes common utilities
shared by all pages and the dynamic update facilities used by
the log pages.
}

\vbox{
\section{Global definitions}

The following definitions are used in various functions
below.  Most of these have the same names and values as
constants in the Perl application.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap647}\raggedright\small
\NWtarget{nuweb481}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {481}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    var WEIGHT_KILOGRAM = 0;@\\
\mbox{}\verb@    var WEIGHT_STONE = 2;@\\
\mbox{}\verb@    var WEIGHT_ABBREVIATIONS = [ "kg", "lb", "st" ];@\\
\mbox{}\verb@    var CALORIES_PER_WEIGHT_UNIT = [ 7716, 3500, 3500 ];@\\
\mbox{}\verb@    var WEIGHT_CONVERSION = [@\\
\mbox{}\verb@    /*  Entries for pounds and stones are identical because@\\
\mbox{}\verb@        even if stones are selected, entries in log items are@\\
\mbox{}\verb@        always kept in pounds.@\\
\mbox{}\verb@@\\
\mbox{}\verb@       To:         kg               lb             st@\\
\mbox{}\verb@                                                                  From   */@\\
\mbox{}\verb@              [ 1.0,            2.2046226,     2.2046226    ],  //  kg@\\
\mbox{}\verb@              [ 0.45359237,     1.0,           1.0          ],  //  lb@\\
\mbox{}\verb@              [ 0.45359237,     1.0,           1.0          ]   //  st@\\
\mbox{}\verb@    ];@\\
\mbox{}\verb@    var CALORIES_PER_ENERGY_UNIT = [ 1, 0.239045 ];@\\
\mbox{}\verb@    var ENERGY_CONVERSION = [@\\
\mbox{}\verb@    //@\\
\mbox{}\verb@    //  To:         cal         kJ                 From@\\
\mbox{}\verb@                [   1.0,        4.18331  ],     //  cal@\\
\mbox{}\verb@                [   0.239045,   1.0      ]      //  kJ@\\
\mbox{}\verb@    ];@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsUsed\nobreak\  \verb@CALORIES_PER_ENERGY_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@CALORIES_PER_WEIGHT_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@ENERGY_CONVERSION@\nobreak\ \NWlink{nuweb24}{24}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}, \verb@WEIGHT_KILOGRAM@\nobreak\ \NWlink{nuweb24}{24}, \verb@WEIGHT_STONE@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Unicode text entity definitions}

We define symbolic names for the following Unicode
characters which are used in the program.  The names are
their Unicode names with spaces replaced with underscores.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap648}\raggedright\small
\NWtarget{nuweb482}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {482}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    var U_MINUS_SIGN = "\u2212";@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@U_MINUS_SIGN@\nobreak\ \NWlink{nuweb524a}{524a}.\item \NWtxtIdentsUsed\nobreak\  \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Document load-time processing}

The {\tt initialiseDocument} function is called from the
``{\tt onload}'' event handler in our HTML documents.  It performs
document-level initialisation and configuration functions.  If
the document header has defined the \verb+setCookie+ function, we
call it here.  We might want to eventually make this more general
and invoke functions defined in the header as members of an
array of functions, but this suffices for now.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap649}\raggedright\small
\NWtarget{nuweb483a}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {483a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function initialiseDocument() {@\\
\mbox{}\verb@        externalLinks();@\\
\mbox{}\verb@        determineTimeZoneOffset();@\\
\mbox{}\verb@        if ((typeof setCookie) === (typeof Function)) {@\\
\mbox{}\verb@            setCookie();@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@initialiseDocument@\nobreak\ \NWlink{nuweb434}{434}\NWlink{nuweb544}{, 544}.\item \NWtxtIdentsUsed\nobreak\  \verb@determineTimeZoneOffset@\nobreak\ \NWlink{nuweb518}{518}, \verb@externalLinks@\nobreak\ \NWlink{nuweb517}{517}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Warn if document accessed insecurely}

The {\tt checkSecure} function, usually called from the {\tt onload}
event handler of the {\tt body} tag of a document, verifies that the
document was loaded securely and complains if it wasn't.  This
warns the user who is using an HTTP connection vulnerable to
sniffing when contacting the server.  An inexcusable kludge disables
this check when testing development builds on the Fourmilab backup server.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap650}\raggedright\small
\NWtarget{nuweb483b}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {483b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function checkSecure() {@\\
\mbox{}\verb@        if ((!location.protocol.match(/^https:/i)) &&@\\
\mbox{}\verb@            (location.hostname != "server1.fourmilab.ch")) {@\\
\mbox{}\verb@            alert("Warning!  This document appears to have been " +@\\
\mbox{}\verb@                  "received over an insecure Internet link (http: " +@\\
\mbox{}\verb@                  "as opposed to https:).  It is possible the data " +@\\
\mbox{}\verb@                  "you submit may be intercepted by an " +@\\
\mbox{}\verb@                  "eavesdropper between your computer and The " +@\\
\mbox{}\verb@                  "Hacker's Diet Online server.\n\n" +@\\
\mbox{}\verb@                  "To be safe, please re-submit your query to the secure server:\n " +@\\
\mbox{}\verb@                  "    https://www.fourmilab.ch@\hbox{$\langle\,${\itshape URL to invoke this program}\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$}\verb@");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@checkSecure@\nobreak\ \NWlink{nuweb182}{182}\NWlink{nuweb185a}{, 185a}\NWlink{nuweb186a}{, 186a}\NWlink{nuweb197}{, 197}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Record unsaved changes}

Every time the user modifies a field in the monthly log, {\tt countChange}
should be called to increment {\tt unsavedChanges} which, if nonzero when
the user clicks on a link which departs the monthly log form, will give the
user an opportunity to cancel following the link and save the changes
before leaving.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap651}\raggedright\small
\NWtarget{nuweb484a}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {484a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    var unsavedChanges = 0;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    function countChange() {@\\
\mbox{}\verb@        unsavedChanges++;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@countChange@\nobreak\ \NWlink{nuweb493a}{493a}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb507}{, 507}\NWlink{nuweb515}{, 515}\NWlink{nuweb524b}{, 524b}, \verb@unsavedChanges@\nobreak\ \NWlink{nuweb216}{216}\NWlink{nuweb283}{, 283}\NWlink{nuweb484b}{, 484b}.\item \NWtxtIdentsUsed\nobreak\  \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Document departure processing}

The {\tt leaveDocument} function should be called by any
link or button in a monthly log form which leaves the
document for another.  This function checks whether the
user has unsaved changes and allows returning to the
form so that they may be saved with the ``Update'' button.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap652}\raggedright\small
\NWtarget{nuweb484b}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {484b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function leaveDocument() {@\\
\mbox{}\verb@        if (unsavedChanges > 0) {@\\
\mbox{}\verb@            return window.confirm("You have " + unsavedChanges +@\\
\mbox{}\verb@                " unsaved change" + (unsavedChanges > 1 ? "s" : "") +@\\
\mbox{}\verb@                " to this form.  To discard " +@\\
\mbox{}\verb@                "these changes and navigate away from this page " +@\\
\mbox{}\verb@                "press OK.  Otherwise, press Cancel and save your " +@\\
\mbox{}\verb@                "changes before leaving this page.");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@leaveDocument@\nobreak\ \NWlink{nuweb208}{208}\NWlink{nuweb211}{, 211}\NWlink{nuweb274}{, 274}.\item \NWtxtIdentsUsed\nobreak\  \verb@save@\nobreak\ \NWlink{nuweb31}{31}\NWlink{nuweb123}{, 123}\NWlink{nuweb151}{, 151}\NWlink{nuweb156b}{, 156b}, \verb@unsavedChanges@\nobreak\ \NWlink{nuweb484a}{484a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Format weight to display unit}

The {\tt editWeight} function returns a string with its first weight
argument formatted appropriate for the display unit specified by
the second argument.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap653}\raggedright\small
\NWtarget{nuweb485a}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {485a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    var decimalCharacter = ".";             // User decimal separator character@\\
\mbox{}\verb@@\\
\mbox{}\verb@    function editWeight(weight, unit) {@\\
\mbox{}\verb@         if (unit == WEIGHT_STONE) {@\\
\mbox{}\verb@            var sgn = (weight < 0) ? "-" : "";@\\
\mbox{}\verb@            weight = Math.abs(weight);@\\
\mbox{}\verb@            var stones = Math.floor(weight / 14);@\\
\mbox{}\verb@            var lbs = weight - (stones * 14);@\\
\mbox{}\verb@//alert("Stoner " + weight + "  " + stones + "  " + lbs);@\\
\mbox{}\verb@            return (sgn + stones.toFixed(0)) + " " +@\\
\mbox{}\verb@                ((lbs < 10) ? " " : "") + lbs.toFixed(1).replace(/\./, decimalCharacter);@\\
\mbox{}\verb@         } else {@\\
\mbox{}\verb@            return weight.toFixed(1).replace(/\./, decimalCharacter);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@editWeight@\nobreak\ \NWlink{nuweb41a}{41a}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb55}{, 55}\NWlink{nuweb93}{, 93}\NWlink{nuweb103b}{, 103b}\NWlink{nuweb268}{, 268}\NWlink{nuweb274}{, 274}\NWlink{nuweb488b}{, 488b}\NWlink{nuweb489}{, 489}\NWlink{nuweb497}{, 497}\NWlink{nuweb498}{, 498}\NWlink{nuweb507}{, 507}.\item \NWtxtIdentsUsed\nobreak\  \verb@floor@\nobreak\ \NWlink{nuweb446b}{446b}, \verb@sgn@\nobreak\ \NWlink{nuweb405}{405}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}, \verb@WEIGHT_STONE@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Parse weight}

The {\tt parseWeight} function returns the contents of a weight field
as a number,  If the display unit is stones and pounds, the value
is returned in pounds.  We accept either a comma or period as the
decimal character.  If the value is invalid, -1 is returned.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap654}\raggedright\small
\NWtarget{nuweb485b}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {485b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function parseWeight(weight, unit) {@\\
\mbox{}\verb@        weight = weight.replace(/,/g, ".");@\\
\mbox{}\verb@        if (unit == WEIGHT_STONE) {@\\
\mbox{}\verb@            var comp = weight.match(/^\s*(\d+)\s+(\d+\.?\d*)\s*$/);@\\
\mbox{}\verb@            if (comp != null) {@\\
\mbox{}\verb@                return (Number(comp[1]) * 14) + Number(comp[2]);@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@//            alert("Sproink (" + weight + ")");@\\
\mbox{}\verb@            if (!weight.match(/^\s*(\d+\.?\d*)\s*$/)) {@\\
\mbox{}\verb@                return -1;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            return Number(weight) * 14;@\\
\mbox{}\verb@         } else {@\\
\mbox{}\verb@            if (!weight.match(/^\s*(\d+\.?\d*)\s*$/)) {@\\
\mbox{}\verb@                return -1;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            return Number(weight);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@parseWeight@\nobreak\ \NWlink{nuweb288b}{288b}\NWlink{nuweb289a}{, 289a}\NWlink{nuweb401}{, 401}\NWlink{nuweb402}{, 402}\NWlink{nuweb486}{, 486}\NWlink{nuweb488b}{, 488b}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb493b}{b}\NWlink{nuweb495}{, 495}\NWlink{nuweb497}{, 497}\NWlink{nuweb498}{, 498}\NWlink{nuweb500}{, 500}\NWlink{nuweb501}{, 501}\NWlink{nuweb506}{, 506}\NWlink{nuweb510b}{, 510b}.\item \NWtxtIdentsUsed\nobreak\  \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}, \verb@WEIGHT_STONE@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Parse signed weight}

The {\tt parseSignedWeight} works precisely like {\tt parseWeight}, but
the weight may be preceded by an optional sign.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap655}\raggedright\small
\NWtarget{nuweb486}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {486}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function parseSignedWeight(weight, unit) {@\\
\mbox{}\verb@        var sgn = 1;@\\
\mbox{}\verb@        var ms = weight.match(/\s*([\+\-])/);@\\
\mbox{}\verb@        if (ms != null) {@\\
\mbox{}\verb@            if (ms[1] == '-') {@\\
\mbox{}\verb@                sgn = -1;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            weight = weight.replace(/\s*[\+\-]/, "");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return parseWeight(weight, unit) * sgn;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@parseSignedWeight@\nobreak\ \NWlink{nuweb289b}{289b}\NWlink{nuweb290a}{, 290a}\NWlink{nuweb402}{, 402}\NWlink{nuweb506}{, 506}.\item \NWtxtIdentsUsed\nobreak\  \verb@parseWeight@\nobreak\ \NWlink{nuweb401}{401}\NWlink{nuweb485b}{, 485b}, \verb@sgn@\nobreak\ \NWlink{nuweb405}{405}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Trend fitting utilities}

The following functions perform a linear regression fit on a set
of points.  The intermediate values are kept in globals and hence
only one fit may be underway at a time.  Since that's all we require
within the document, there's no need for an object-oriented
interface as in the Perl implementation on the server.
}

\vbox{
\subsection{Start fit}

The {\tt fitStart} function initialises the fit accumulation
variables for a new linear regression fit.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap656}\raggedright\small
\NWtarget{nuweb487a}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {487a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    var fit_n, fit_s1, fit_s2, fit_s3, fit_s4;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    function fitStart() {@\\
\mbox{}\verb@        fit_n = fit_s1 = fit_s2 = fit_s3 = fit_s4 = 0;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@fitStart@\nobreak\ \NWlink{nuweb500}{500}, \verb@fit_n@\nobreak\ \NWlink{nuweb487b}{487b}\NWlink{nuweb488a}{, 488a}, \verb@fit_s1@\nobreak\ \NWlink{nuweb487b}{487b}\NWlink{nuweb488a}{, 488a}, \verb@fit_s2@\nobreak\ \NWlink{nuweb487b}{487b}\NWlink{nuweb488a}{, 488a}, \verb@fit_s3@\nobreak\ \NWlink{nuweb487b}{487b}\NWlink{nuweb488a}{, 488a}, \verb@fit_s4@\nobreak\ \NWlink{nuweb487b}{487b}\NWlink{nuweb488a}{, 488a}.\item \NWtxtIdentsUsed\nobreak\  \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Add Point}

The {\tt fitAddPoint} function adds a point value to the trend we're fitting.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap657}\raggedright\small
\NWtarget{nuweb487b}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {487b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function fitAddPoint(value) {@\\
\mbox{}\verb@        fit_s1 += (fit_n + 1) * value;@\\
\mbox{}\verb@        fit_s2 += (fit_n + 1);@\\
\mbox{}\verb@        fit_s3 += value;@\\
\mbox{}\verb@        fit_s4 += (fit_n + 1) * (fit_n + 1);@\\
\mbox{}\verb@        fit_n++;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@fitAddPoint@\nobreak\ \NWlink{nuweb500}{500}.\item \NWtxtIdentsUsed\nobreak\  \verb@fit_n@\nobreak\ \NWlink{nuweb487a}{487a}, \verb@fit_s1@\nobreak\ \NWlink{nuweb487a}{487a}, \verb@fit_s2@\nobreak\ \NWlink{nuweb487a}{487a}, \verb@fit_s3@\nobreak\ \NWlink{nuweb487a}{487a}, \verb@fit_s4@\nobreak\ \NWlink{nuweb487a}{487a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Fit Slope}

The {\tt fitSlope} function fits a linear trend to the points
supplied so far and returns its slope.  You are free to continue
adding points after returning the trend.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap658}\raggedright\small
\NWtarget{nuweb488a}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {488a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function fitSlope() {@\\
\mbox{}\verb@//alert(fit_n + " " + fit_s1 + " " + fit_s2 + " " + fit_s3 + " " + fit_s4);@\\
\mbox{}\verb@        return ((fit_s1 * fit_n) - (fit_s2 * fit_s3)) /@\\
\mbox{}\verb@                ((fit_s4 * fit_n) - (fit_s2 * fit_s2));@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@fitSlope@\nobreak\ \NWlink{nuweb18}{18}\NWlink{nuweb20b}{, 20b}\NWlink{nuweb28}{, 28}\NWlink{nuweb79}{, 79}\NWlink{nuweb351}{, 351}\NWlink{nuweb357}{, 357}\NWlink{nuweb500}{, 500}.\item \NWtxtIdentsUsed\nobreak\  \verb@fit_n@\nobreak\ \NWlink{nuweb487a}{487a}, \verb@fit_s1@\nobreak\ \NWlink{nuweb487a}{487a}, \verb@fit_s2@\nobreak\ \NWlink{nuweb487a}{487a}, \verb@fit_s3@\nobreak\ \NWlink{nuweb487a}{487a}, \verb@fit_s4@\nobreak\ \NWlink{nuweb487a}{487a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}


\vbox{
\section{Expand abbreviated weight entry}

We allow the user to abbreviate weight entries in the log in
various ways.  If this is a valid abbreviation, find the previous
weight log item and expand it accordingly.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap659}\raggedright\small
\NWtarget{nuweb488b}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {488b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function expandAbbreviatedWeight(day, unit) {@\\
\mbox{}\verb@        var w = document.getElementById("w" + day).value;@\\
\mbox{}\verb@        w = w.replace(/^\s+/, "");@\\
\mbox{}\verb@        w = w.replace(/\s+$/, "");@\\
\mbox{}\verb@        w = w.replace(/,/g, ".");@\\
\mbox{}\verb@@\\
\mbox{}\verb@        //   In stones, all abbreviations have a decimal@\\
\mbox{}\verb@        if ((unit == WEIGHT_STONE) && (!w.match(/\d*[\.,]\d*/))) {@\\
\mbox{}\verb@            //  Canonicalise weight@\\
\mbox{}\verb@            if (w != '') {@\\
\mbox{}\verb@                document.getElementById("w" + day).value =@\\
\mbox{}\verb@                                editWeight(parseWeight(w, unit), unit);@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            return true;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if ((w == '.') || (w == ',') || (w.match(/^[\.,]\d+$/)) ||@\\
\mbox{}\verb@            (w.match(/^\d([\.,]\d*)?$/)) ||@\\
\mbox{}\verb@            ((unit == WEIGHT_STONE) && w.match(/^\d\d[\.,]\d*$/))) {@\\
\mbox{}\verb@            var p = 0, pd =  0;@\\
\mbox{}\verb@            for (var i = day - 1; i >= 1; i--) {@\\
\mbox{}\verb@                p = document.getElementById("w" + i).value;@\\
\mbox{}\verb@                if (p.match(/^\d/)) {@\\
\mbox{}\verb@                    pd = p.replace(/,/g, ".");@\\
\mbox{}\verb@                    break;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            if (pd <= 0) {@\\
\mbox{}\verb@                alert("Cannot abbreviate weight.  No previous weight in this month's log.");@\\
\mbox{}\verb@                return false;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            if ((w == '.') || (w == ',')) {@\\
\mbox{}\verb@                document.getElementById("w" + day).value = p;@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                var pn = Number(pd);@\\
\mbox{}\verb@                if (unit == WEIGHT_STONE) {@\\
\mbox{}\verb@                    @\hbox{$\langle\,${\itshape Expand abbreviated stones and pounds entry}\nobreak\ {\footnotesize \NWlink{nuweb489}{489}}$\,\rangle$}\verb@@\\
\mbox{}\verb@                } else {@\\
\mbox{}\verb@                    if (w.match(/^[\.,]\d+$/)) {@\\
\mbox{}\verb@                        document.getElementById("w" + day).value =@\\
\mbox{}\verb@                            editWeight(Math.floor(pn) + Number(w), unit);@\\
\mbox{}\verb@                    } else if (w.match(/^\d([\.,]\d*)?$/)) {@\\
\mbox{}\verb@                        document.getElementById("w" + day).value =@\\
\mbox{}\verb@                            editWeight(((Math.floor(pn  / 10)) * 10) + Number(w), unit);@\\
\mbox{}\verb@                    }@\\
\mbox{}\verb@//else { alert("Failed to parse (" + w + ")"); }@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return true;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@expandAbbreviatedWeight@\nobreak\ \NWlink{nuweb493a}{493a}.\item \NWtxtIdentsUsed\nobreak\  \verb@editWeight@\nobreak\ \NWlink{nuweb41a}{41a}\NWlink{nuweb485a}{, 485a}, \verb@floor@\nobreak\ \NWlink{nuweb446b}{446b}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@parseWeight@\nobreak\ \NWlink{nuweb401}{401}\NWlink{nuweb485b}{, 485b}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}, \verb@WEIGHT_STONE@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Expand abbreviated stones and pounds entry}

When the weight unit is set to stones an abbreviation may be used to
change the pounds and decimal place of the previous stone and pound
display just as when the units are pounds. In addition, when the
display unit is set to stones, if the previous entry has a pounds
field between 10 and 13 and the user enters a single digit, decimal
character, and optional decimal digit, the action taken depends on the
units digit entered.  If it's between 0 and 3, it replaces the last
digit of the pounds in the last entry, but if the digit is 4 or
greater (which is invalid in a stones and pounds display), that digit
replaces the two digit pounds field in the previous entry.  This
reduces the scribbling required when the weight happens to fluctuate
around {\em X} stones 10.  In addition, when the display unit is
stones, the user can enter two digits followed by the decimal
character and an optional decimal digit to replace the pounds field of
the last stones and pounds entry; the decimal character must be
entered to distinguish the entry from one denoting an even number of
stones.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap660}\raggedright\small
\NWtarget{nuweb489}{} $\langle\,${\itshape Expand abbreviated stones and pounds entry}\nobreak\ {\footnotesize {489}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    var sf = p.match(/^(\d+)\s+(\d*[\.,]?\d*)$/);@\\
\mbox{}\verb@    var stones, pounds;@\\
\mbox{}\verb@    if (sf != null) {@\\
\mbox{}\verb@        stones = Number(sf[1]);@\\
\mbox{}\verb@        pounds = Number(sf[2].replace(/,/g, "."));@\\
\mbox{}\verb@//alert("Previous st=" + stones + " lbs=" + pounds);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@//else { alert("Unable to parse previous stones value (" + p + ")"); }@\\
\mbox{}\verb@    var nw = Number(w);@\\
\mbox{}\verb@    if (pounds >= 10) {@\\
\mbox{}\verb@        if (nw < 4) {@\\
\mbox{}\verb@            if (w.match(/^[\.,]\d+$/)) {@\\
\mbox{}\verb@                pounds = Math.floor(pounds) + nw;// alert("gonk 5");@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                pounds = ((Math.floor(pounds  / 10)) * 10) + nw;// alert("gonk 6");@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            pounds = nw;// alert("gonk 2");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        if (w.match(/^[\.,]\d+$/)) {@\\
\mbox{}\verb@            pounds = Math.floor(pounds) + nw;// alert("gonk 3");@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            pounds = nw;// alert("gonk 4");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@//alert("New st=" + stones + " lbs=" + pounds);@\\
\mbox{}\verb@    document.getElementById("w" + day).value = editWeight((stones * 14) + pounds, unit);@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb488b}{488b}.
\item \NWtxtIdentsUsed\nobreak\  \verb@editWeight@\nobreak\ \NWlink{nuweb41a}{41a}\NWlink{nuweb485a}{, 485a}, \verb@floor@\nobreak\ \NWlink{nuweb446b}{446b}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Create canvas to draw in chart image}

We plot new entries in the monthly chart by overlaying a \verb+<div>+
on it, which is dynamically sized and positioned to precisely
overlay the chart.  The following code, which is called whenever
we need to plot in the chart, positions the division over the chart
and creates a graphics object to draw in it.  Subsequent calls
simply return the existing object.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap661}\raggedright\small
\NWtarget{nuweb490}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {490}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    var plot;@\\
\mbox{}\verb@    var plotChart;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    function getCanvas(imageID) {@\\
\mbox{}\verb@        if (!plot) {@\\
\mbox{}\verb@            var canvas = document.getElementById("canvas");@\\
\mbox{}\verb@            plotChart = document.getElementById(imageID);@\\
\mbox{}\verb@            var elementChain = plotChart;@\\
\mbox{}\verb@            var offsetLeft = 0, offsetTop = 0;@\\
\mbox{}\verb@            while (elementChain) {@\\
\mbox{}\verb@                offsetLeft += elementChain.offsetLeft;@\\
\mbox{}\verb@                offsetTop += elementChain.offsetTop;@\\
\mbox{}\verb@                elementChain = elementChain.offsetParent;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            canvas.style.width = plotChart.width + "px";@\\
\mbox{}\verb@            canvas.style.height = plotChart.height + "px";@\\
\mbox{}\verb@            canvas.style.left = offsetLeft + "px";@\\
\mbox{}\verb@            canvas.style.top = offsetTop + "px";@\\
\mbox{}\verb@            canvas.style.visibility = "visible";@\\
\mbox{}\verb@            plot = new jsGraphics(canvas);@\\
\mbox{}\verb@//alert("Create canvas");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return plot;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsUsed\nobreak\  \verb@plotChart@\nobreak\ \NWlink{nuweb46}{46}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Handle resize of window}

This event handler is invoked when the user resizes the window.  It is
responsible for repositioning the canvas over the current location of
the monthly chart after the resize.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap662}\raggedright\small
\NWtarget{nuweb491}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {491}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function resizeEvent(e) {@\\
\mbox{}\verb@        var canvas = document.getElementById("canvas");@\\
\mbox{}\verb@        var chart = plotChart;@\\
\mbox{}\verb@        var elementChain = plotChart;@\\
\mbox{}\verb@        var offsetLeft = 0, offsetTop = 0;@\\
\mbox{}\verb@        while (elementChain) {@\\
\mbox{}\verb@            offsetLeft += elementChain.offsetLeft;@\\
\mbox{}\verb@            offsetTop += elementChain.offsetTop;@\\
\mbox{}\verb@            elementChain = elementChain.offsetParent;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        canvas.style.left = offsetLeft + "px";@\\
\mbox{}\verb@        canvas.style.top = offsetTop + "px";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    function setResizeEventHandle() {@\\
\mbox{}\verb@        //  For competently-implemented and standards-compliant browsers@\\
\mbox{}\verb@        if (document.implementation.hasFeature("Events", "2.0")) {@\\
\mbox{}\verb@            this.addEventListener("resize", resizeEvent, false);@\\
\mbox{}\verb@        //  For Exploder@\\
\mbox{}\verb@        } else if (document.attachEvent) {@\\
\mbox{}\verb@            this.attachEvent("onresize", resizeEvent);@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsUsed\nobreak\  \verb@plotChart@\nobreak\ \NWlink{nuweb46}{46}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Recompute after weight change}

When a weight field is modified, we need to recompute the trend and
variances for this and subsequent days in the log.  The {\tt changeWeight}
function is invoked from the {\tt onchange} handler in the weight fields
of the monthly log form.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap663}\raggedright\small
\NWtarget{nuweb492}{} $\langle\,${\itshape Maximum Expected Weight Variance}\nobreak\ {\footnotesize {492}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@0.06@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb493b}{493b}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap664}\raggedright\small
\NWtarget{nuweb493a}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {493a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function changeWeight(day) {@\\
\mbox{}\verb@        var n = Number(document.getElementById("md").getAttribute("value"));    // Number of days@\\
\mbox{}\verb@        var t = Number(document.getElementById("t0").getAttribute("value"));    // Trend carry-forward@\\
\mbox{}\verb@        var unit = Number(document.getElementById("du").getAttribute("value")); // Display unit@\\
\mbox{}\verb@        var height = Number(document.getElementById("hgt").getAttribute("value")); // Height in centimetres@\\
\mbox{}\verb@        decimalCharacter = document.getElementById("dc").getAttribute("value");@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (!expandAbbreviatedWeight(day, unit)) {@\\
\mbox{}\verb@            document.getElementById("w" + day).value = "";@\\
\mbox{}\verb@            return;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        var ckw = 0;@\\
\mbox{}\verb@        if (document.getElementById("w" + day).value.match(/^\s*$/)) {@\\
\mbox{}\verb@            document.getElementById("w" + day).value = "";@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            var ckw = parseWeight(document.getElementById("w" + day).value, unit);@\\
\mbox{}\verb@            if (ckw < 0) {@\\
\mbox{}\verb@                alert("Weight entry invalid.");@\\
\mbox{}\verb@                resetFocus("w", day);@\\
\mbox{}\verb@                return;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        countChange();@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Find most recent trend value before this day}\nobreak\ {\footnotesize \NWlink{nuweb497}{497}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Check for implausibly large change in weight}\nobreak\ {\footnotesize \NWlink{nuweb493b}{493b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Undraw trend values starting at this day}\nobreak\ {\footnotesize \NWlink{nuweb494}{494}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        plotWeightOnChart(day, unit);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Update the trend and variance for this and subsequent days}\nobreak\ {\footnotesize \NWlink{nuweb498}{498}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Fit a linear trend and update weight and energy balance}\nobreak\ {\footnotesize \NWlink{nuweb500}{500}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Update the mean and most recent body mass index}\nobreak\ {\footnotesize \NWlink{nuweb501}{501}}$\,\rangle$}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@changeWeight@\nobreak\ \NWlink{nuweb38}{38}.\item \NWtxtIdentsUsed\nobreak\  \verb@countChange@\nobreak\ \NWlink{nuweb484a}{484a}, \verb@expandAbbreviatedWeight@\nobreak\ \NWlink{nuweb488b}{488b}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@parseWeight@\nobreak\ \NWlink{nuweb401}{401}\NWlink{nuweb485b}{, 485b}, \verb@resetFocus@\nobreak\ \NWlink{nuweb516b}{516b}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Check for implausibly large change in weight}

The following code applies heuristics which attempt to detect weight
entries which are inconsistent with earlier log entries and possibly
erroneous.  The eccentricities of users' log-keeping habits complicate
this substantially.  A user who enters their weight almost every day
is easy to cope with; we can simply compare the trend with the weight
entry and flag it if the change exceeds the maximum seen in a large
sample of data.  The user who enters weight only infrequently poses
more of a problem.  We take the following approach. First, we test the
weight against the trend as if the user were assiduous in logging
weight.  If that test indicates an anomaly, we then see if there is a
previous weight entry in the log and, if so, apply the fraction change
test against that weight as opposed to the trend (as the user has
presumably already confirmed that change if it triggers the dubiety
test).  If no previous weight has been entered in the month, we
compute the number of days so far with no weight entries and simulate
a trend driven by a linear progression from the starting trend to the
entered weight and use that in the plausibility test.  All of this is,
of course, {\em ad hack}, but then all we're trying to do is catch
fat-finger errors, and any alert we flash can be dismissed by the user
simply by pressing the OK button.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap665}\raggedright\small
\NWtarget{nuweb493b}{} $\langle\,${\itshape Check for implausibly large change in weight}\nobreak\ {\footnotesize {493b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if ((t > 0) && (ckw > 0) && ((Math.abs(t - ckw) / t) > @\hbox{$\langle\,${\itshape Maximum Expected Weight Variance}\nobreak\ {\footnotesize \NWlink{nuweb492}{492}}$\,\rangle$}\verb@)) {@\\
\mbox{}\verb@        var deltad = -1, lastw = 0;@\\
\mbox{}\verb@        for (var ld = day - 1; ld >= 1; ld--) {@\\
\mbox{}\verb@            if (document.getElementById("w" + ld).value != "") {@\\
\mbox{}\verb@                deltad = day - ld;@\\
\mbox{}\verb@                lastw = parseWeight(document.getElementById("w" + ld).value, unit);@\\
\mbox{}\verb@                break;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if (deltad == -1) {@\\
\mbox{}\verb@            deltad = day;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@//alert("deltad " + deltad + " lastw " + lastw);@\\
\mbox{}\verb@        if (lastw > 0) {@\\
\mbox{}\verb@            if (Math.abs(lastw - ckw) > Math.abs(t - ckw)) {@\\
\mbox{}\verb@                lastw = t;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            var simt = t;@\\
\mbox{}\verb@            for (var i = 1; i < deltad; i++) {@\\
\mbox{}\verb@                simt = simt + (((t + (((ckw - t) * i) / deltad)) - simt) / 10);@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@//alert("simt " + simt);@\\
\mbox{}\verb@            lastw = simt;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@//alert("Adjusted lastw " + lastw);@\\
\mbox{}\verb@        if ((Math.abs(ckw - lastw) / lastw) > @\hbox{$\langle\,${\itshape Maximum Expected Weight Variance}\nobreak\ {\footnotesize \NWlink{nuweb492}{492}}$\,\rangle$}\verb@) {@\\
\mbox{}\verb@            if (!confirm("This weight is a " +@\\
\mbox{}\verb@                (((ckw - lastw) * 100) / lastw).toFixed(1).replace(/\./, decimalCharacter) +@\\
\mbox{}\verb@                "% change\u2014possibly incorrect.\n" +@\\
\mbox{}\verb@                "Press OK to accept weight as entered, Cancel to correct.")) {@\\
\mbox{}\verb@                resetFocus("w", day);@\\
\mbox{}\verb@                return;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb493a}{493a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@parseWeight@\nobreak\ \NWlink{nuweb401}{401}\NWlink{nuweb485b}{, 485b}, \verb@resetFocus@\nobreak\ \NWlink{nuweb516b}{516b}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Undraw trend values starting at this day}


\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap666}\raggedright\small
\NWtarget{nuweb494}{} $\langle\,${\itshape Undraw trend values starting at this day}\nobreak\ {\footnotesize {494}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@/* ******@\\
\mbox{}\verb@@\\
\mbox{}\verb@    var scaling = document.getElementById("sc").getAttribute("value").@\\
\mbox{}\verb@            match(/^([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+)$/);@\\
\mbox{}\verb@    for (var i = 1; i <= 7; i++) {@\\
\mbox{}\verb@        scaling[i] = Number(scaling[i]);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    for (var d = day; d < (nd - 1); d++) {@\\
\mbox{}\verb@        var tfrom = document.getElementById("T" + (d + 1)).getAttribute("value"),@\\
\mbox{}\verb@            tto = document.getElementById("T" + (d + 2)).getAttribute("value");@\\
\mbox{}\verb@        if (tfrom.match(/^\d/) && tto.match(/^\d/)) {@\\
\mbox{}\verb@            tfrom = Number(tfrom);@\\
\mbox{}\verb@            tto = Number(tto);@\\
\mbox{}\verb@            var plot = getCanvas("chart");@\\
\mbox{}\verb@            var px1 = scaling[1] + (scaling[2] * (d));@\\
\mbox{}\verb@            var py1 = scaling[3] - Math.floor(((tfrom - scaling[4]) * scaling[5]) / scaling[6]);@\\
\mbox{}\verb@            var px2 = scaling[1] + (scaling[2] * (d + 1));@\\
\mbox{}\verb@            var py2 = scaling[3] - Math.floor(((tto - scaling[4]) * scaling[5]) / scaling[6]);@\\
\mbox{}\verb@            plot.setColor("#FFFF00");@\\
\mbox{}\verb@            plot.drawLine(px1, py1, px2, py2);@\\
\mbox{}\verb@            plot.paint();@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@****** */@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb493a}{493a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@floor@\nobreak\ \NWlink{nuweb446b}{446b}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Plot weight on chart image}

Using the chart scale information supplied in the hidden ``{\tt sc}'' field,
compute the pixel co-ordinates of the weight just entered in the canvas which
overlays the monthly chart image and plot the weight.  Since we're just providing
real-time feedback, and the most common case is a user entering new weights in
blank fields, we don't worry about trying to erase a previous weight entry.
We could handle that by embedding hidden fields with the old value, but I'm
not going to go to all that trouble unless this proves to be a genuine annoyance.

Weights which are off-scale high or low are not plotted on the chart, and
blank weights or those which fail to parse are likewise ignored.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap667}\raggedright\small
\NWtarget{nuweb495}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {495}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function plotWeightOnChart(day, unit) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Extract scaling information for chart}\nobreak\ {\footnotesize \NWlink{nuweb496}{496}}$\,\rangle$}\verb@@\\
\mbox{}\verb@        var dweight = parseWeight(document.getElementById("w" + day).value, unit);@\\
\mbox{}\verb@        if ((dweight >= scaling[4]) && (dweight <= (scaling[4] + scaling[6]))) {@\\
\mbox{}\verb@            var plot = getCanvas("chart");@\\
\mbox{}\verb@            var px = scaling[1] + (scaling[2] * (day - 1));@\\
\mbox{}\verb@            var py = scaling[3] - Math.floor(((dweight - scaling[4]) * scaling[5]) / scaling[6]);@\\
\mbox{}\verb@@\\
\mbox{}\verb@            var sinkerSize = 4;@\\
\mbox{}\verb@@\\
\mbox{}\verb@            //  Fill float/sinker with white or yellow, if it's flagged.@\\
\mbox{}\verb@@\\
\mbox{}\verb@            plot.setColor(document.getElementById("f" + day).checked ? "#FFFF00" : "#FFFFFF");@\\
\mbox{}\verb@            for (var j = -sinkerSize; j <= sinkerSize; j++) {@\\
\mbox{}\verb@                var dx = Math.abs(j) - sinkerSize;@\\
\mbox{}\verb@@\\
\mbox{}\verb@                plot.drawLine(px - dx, py + j, px + dx, py + j);@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@@\\
\mbox{}\verb@            //  Trace the outline of the float/sinker in blue@\\
\mbox{}\verb@@\\
\mbox{}\verb@            plot.setColor("#0000FF");@\\
\mbox{}\verb@            plot.drawLine(px - sinkerSize, py, px, py - sinkerSize);@\\
\mbox{}\verb@            plot.drawLine(px, py - sinkerSize, px + sinkerSize, py);@\\
\mbox{}\verb@            plot.drawLine(px + sinkerSize, py, px, py + sinkerSize);@\\
\mbox{}\verb@            plot.drawLine(px, py + sinkerSize, px - sinkerSize, py);@\\
\mbox{}\verb@@\\
\mbox{}\verb@            plot.paint();@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsUsed\nobreak\  \verb@floor@\nobreak\ \NWlink{nuweb446b}{446b}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@parseWeight@\nobreak\ \NWlink{nuweb401}{401}\NWlink{nuweb485b}{, 485b}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Extract scaling information for chart}

The scaling of day numbers, weight, and exercise rungs to the chart is
given by the values passed in the hidden ``{\tt sc}'' field.  Extract
these values and convert them to numbers in an array for use in
subsequent plotting operations.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap668}\raggedright\small
\NWtarget{nuweb496}{} $\langle\,${\itshape Extract scaling information for chart}\nobreak\ {\footnotesize {496}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    var scaling = document.getElementById("sc").getAttribute("value").@\\
\mbox{}\verb@            match(/^([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+),([^,]+)$/);@\\
\mbox{}\verb@    for (var i = 1; i <= 7; i++) {@\\
\mbox{}\verb@        scaling[i] = Number(scaling[i]);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb495}{495}\NWlink{nuweb503}{, 503}.
\item \NWtxtIdentsUsed\nobreak\  \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Find most recent trend value before this day}

In order to update the trend of the day in which the new weight has
been entered and that of subsequent days up to the last weight
specified in the log, we need to find the most recent known trend
value.  This will be the value given with the most recent previous
weight, or the trend carry-forward if this is the first day of the
month.  If this is the first day and there is no trend carry-forward,
the trend is started at the entered weight.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap669}\raggedright\small
\NWtarget{nuweb497}{} $\langle\,${\itshape Find most recent trend value before this day}\nobreak\ {\footnotesize {497}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    /* Find the last non-blank weight entry in the log. */@\\
\mbox{}\verb@    var nd = n;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    while ((nd > 0) && (!document.getElementById("w" + nd).value.match(/^\d/))) {@\\
\mbox{}\verb@        nd--;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    nd = Math.max(nd, day);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    /* If this is not the first day of the month, get the trend from@\\
\mbox{}\verb@       the previous day's entry. */@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (day > 1) {@\\
\mbox{}\verb@        var lt = document.getElementById("t" + (day - 1)).firstChild.data;@\\
\mbox{}\verb@        if (lt.match(/^\d/)) {@\\
\mbox{}\verb@            t = parseWeight(lt, unit);@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            var jt = "", j, k;@\\
\mbox{}\verb@            for (j = day - 2; j >= 1; j--) {@\\
\mbox{}\verb@                jt = document.getElementById("t" + j).firstChild.data;@\\
\mbox{}\verb@                if (jt.match(/^\d/)) {@\\
\mbox{}\verb@                    break;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            if (j == 0) {@\\
\mbox{}\verb@                jt = document.getElementById("t0").getAttribute("value");@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            if (jt != "" && jt != 0) {@\\
\mbox{}\verb@                t = parseWeight(jt, unit);@\\
\mbox{}\verb@                for (k = j + 1; k < day; k++) {@\\
\mbox{}\verb@                    replaceText("t" + k, editWeight(t, unit));@\\
\mbox{}\verb@                    document.getElementById("T" + k).setAttribute("value", t.toFixed(4));@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    /* If this is the first day of the month, use the trend@\\
\mbox{}\verb@       carry-forward as the previous trend value.  If no trend@\\
\mbox{}\verb@       carry-forward is specified, simply use the current weight@\\
\mbox{}\verb@       to start the trend. */@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if (t == 0) {@\\
\mbox{}\verb@        t = parseWeight(document.getElementById("w" + day).value, unit);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb493a}{493a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@editWeight@\nobreak\ \NWlink{nuweb41a}{41a}\NWlink{nuweb485a}{, 485a}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@max@\nobreak\ \NWlink{nuweb405}{405}, \verb@parseWeight@\nobreak\ \NWlink{nuweb401}{401}\NWlink{nuweb485b}{, 485b}, \verb@replaceText@\nobreak\ \NWlink{nuweb523}{523}, \verb@start@\nobreak\ \NWlink{nuweb19b}{19b}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Update the trend and variance for this and subsequent days}

Starting with the weight which was changed and proceeding to the end
of the monthly log, update the trend and variance columns to reflect
the newly entered weight.  If no previous trend was defined, we blank
out trend and variance fields until we encounter the first specified
weight, then use it as the starting point for the trend.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap670}\raggedright\small
\NWtarget{nuweb498}{} $\langle\,${\itshape Update the trend and variance for this and subsequent days}\nobreak\ {\footnotesize {498}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@//alert("Change weight " + day + " " + t + "  (" + document.getElementById("w" + day).value + ") t = " + t);@\\
\mbox{}\verb@    for (var i = day; i <= n; i++) {@\\
\mbox{}\verb@        var w = document.getElementById("w" + i).value;@\\
\mbox{}\verb@        if (w.match(/^\d/)) {@\\
\mbox{}\verb@            if (t < 0) {@\\
\mbox{}\verb@                t = parseWeight(w, unit);@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                t = t + ((parseWeight(w, unit) - t) / 10);@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            replaceText("t" + i, editWeight(t, unit));@\\
\mbox{}\verb@            updateVariance("v" + i, parseWeight(w, unit) - t);@\\
\mbox{}\verb@            document.getElementById("T" + i).setAttribute("value", t.toFixed(4));@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            replaceText("v" + i, "");@\\
\mbox{}\verb@            if ((i <= nd) && (t > 0)) {@\\
\mbox{}\verb@                replaceText("t" + i, editWeight(t, unit));@\\
\mbox{}\verb@                document.getElementById("T" + i).setAttribute("value", t.toFixed(4));@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                replaceText("t" + i, "");@\\
\mbox{}\verb@                document.getElementById("T" + i).setAttribute("value", "");@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Plot the updated trend}\nobreak\ {\footnotesize \NWlink{nuweb499}{499}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb493a}{493a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@editWeight@\nobreak\ \NWlink{nuweb41a}{41a}\NWlink{nuweb485a}{, 485a}, \verb@parseWeight@\nobreak\ \NWlink{nuweb401}{401}\NWlink{nuweb485b}{, 485b}, \verb@replaceText@\nobreak\ \NWlink{nuweb523}{523}, \verb@updateVariance@\nobreak\ \NWlink{nuweb524a}{524a}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Plot the updated trend}


\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap671}\raggedright\small
\NWtarget{nuweb499}{} $\langle\,${\itshape Plot the updated trend}\nobreak\ {\footnotesize {499}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@/* ******@\\
\mbox{}\verb@@\\
\mbox{}\verb@    for (var d = day; d < (n - 1); d++) {@\\
\mbox{}\verb@        var tfrom = document.getElementById("T" + (d + 1)).getAttribute("value"),@\\
\mbox{}\verb@            tto = document.getElementById("T" + (d + 2)).getAttribute("value");@\\
\mbox{}\verb@        if (tfrom.match(/^\d/) && tto.match(/^\d/)) {@\\
\mbox{}\verb@            tfrom = Number(tfrom);@\\
\mbox{}\verb@            tto = Number(tto);@\\
\mbox{}\verb@            var plot = getCanvas("chart");@\\
\mbox{}\verb@            var px1 = scaling[1] + (scaling[2] * (d));@\\
\mbox{}\verb@            var py1 = scaling[3] - Math.floor(((tfrom - scaling[4]) * scaling[5]) / scaling[6]);@\\
\mbox{}\verb@            var px2 = scaling[1] + (scaling[2] * (d + 1));@\\
\mbox{}\verb@            var py2 = scaling[3] - Math.floor(((tto - scaling[4]) * scaling[5]) / scaling[6]);@\\
\mbox{}\verb@            plot.setColor("#FF0000");@\\
\mbox{}\verb@            plot.drawLine(px1, py1, px2, py2);@\\
\mbox{}\verb@            plot.paint();@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@****** */@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb498}{498}.
\item \NWtxtIdentsUsed\nobreak\  \verb@floor@\nobreak\ \NWlink{nuweb446b}{446b}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Fit a linear trend and update weight and energy balance}

If the log contains two or more entries, fit a linear trend to it and
update the weekly gain/loss and calorie balance.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap672}\raggedright\small
\NWtarget{nuweb500}{} $\langle\,${\itshape Fit a linear trend and update weight and energy balance}\nobreak\ {\footnotesize {500}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    if (nd > 1) {@\\
\mbox{}\verb@        var np = 0;@\\
\mbox{}\verb@        fitStart();@\\
\mbox{}\verb@        for (var i = 1; i <= nd; i++) {@\\
\mbox{}\verb@            var w = document.getElementById("t" + i).firstChild.data;@\\
\mbox{}\verb@            if (w.match(/^\d/)) {@\\
\mbox{}\verb@                var nw = parseWeight(w, unit);@\\
\mbox{}\verb@                if (nw > 0) {@\\
\mbox{}\verb@                    fitAddPoint(nw);@\\
\mbox{}\verb@                    np++;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        var tslope = fitSlope();@\\
\mbox{}\verb@        if (np < 2) {@\\
\mbox{}\verb@            tslope = 0;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        replaceText("delta_sign", tslope > 0 ? "gain" : "loss");@\\
\mbox{}\verb@        replaceText("weekly_delta", Math.abs(tslope * 7).toFixed(2).replace(/\./, decimalCharacter));@\\
\mbox{}\verb@@\\
\mbox{}\verb@        replaceText("calorie_sign", tslope > 0 ? "excess" : "deficit");@\\
\mbox{}\verb@        replaceText("daily_calories", Math.round(Math.abs(tslope) * CALORIES_PER_WEIGHT_UNIT[unit]));@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb493a}{493a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@CALORIES_PER_WEIGHT_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@fitAddPoint@\nobreak\ \NWlink{nuweb487b}{487b}, \verb@fitSlope@\nobreak\ \NWlink{nuweb20b}{20b}\NWlink{nuweb488a}{, 488a}, \verb@fitStart@\nobreak\ \NWlink{nuweb487a}{487a}, \verb@parseWeight@\nobreak\ \NWlink{nuweb401}{401}\NWlink{nuweb485b}{, 485b}, \verb@replaceText@\nobreak\ \NWlink{nuweb523}{523}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Update the mean and most recent body mass index}

The pseudoscientific ``body mass index'' is computed from the mean and
final trend value in the log and the user's height in centimetres.
Using the trend rather than the weight minimises psychologically
jarring jitter.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap673}\raggedright\small
\NWtarget{nuweb501}{} $\langle\,${\itshape Update the mean and most recent body mass index}\nobreak\ {\footnotesize {501}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    var tweight = 0, lweight = 0, nw = 0;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    for (var i = 1; i <= n; i++) {@\\
\mbox{}\verb@        var w = document.getElementById("w" + i).value;@\\
\mbox{}\verb@        if (w.match(/^\d/)) {@\\
\mbox{}\verb@            lweight = parseWeight(document.getElementById("t" + i).firstChild.data, unit);@\\
\mbox{}\verb@            tweight += lweight;@\\
\mbox{}\verb@            nw++;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ((nw > 0) && (height > 0)) {@\\
\mbox{}\verb@        tweight /= nw;@\\
\mbox{}\verb@        tweight *= WEIGHT_CONVERSION[unit][WEIGHT_KILOGRAM];@\\
\mbox{}\verb@        lweight *= WEIGHT_CONVERSION[unit][WEIGHT_KILOGRAM];@\\
\mbox{}\verb@        height /= 100;@\\
\mbox{}\verb@        height *= height;@\\
\mbox{}\verb@        replaceText("mean_bmi", (tweight / height).toFixed(1).replace(/\./, decimalCharacter));@\\
\mbox{}\verb@        replaceText("last_bmi", (lweight / height).toFixed(1).replace(/\./, decimalCharacter));@\\
\mbox{}\verb@        document.getElementById("bmi").style.display = "inline";@\\
\mbox{}\verb@    } else {@\\
\mbox{}\verb@        document.getElementById("bmi").style.display = "none";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb493a}{493a}.
\item \NWtxtIdentsUsed\nobreak\  \verb@parseWeight@\nobreak\ \NWlink{nuweb401}{401}\NWlink{nuweb485b}{, 485b}, \verb@replaceText@\nobreak\ \NWlink{nuweb523}{523}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}, \verb@WEIGHT_KILOGRAM@\nobreak\ \NWlink{nuweb24}{24}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Change exercise rung field}

Check whether the user entered just a period in the exercise rung field.
If so, copy the most recently specified exercise rung, if any.  The
period may be preceded and/or followed by white space.  The rung value
is syntax and range checked, and any fractional part is discarded.  The
cleaned-up value is placed in the rung field.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap674}\raggedright\small
\NWtarget{nuweb502}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {502}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function changeRung(day) {@\\
\mbox{}\verb@        if (document.getElementById("r" + day).value.match(/^\s*[\.,\+\-]\s*$/)) {@\\
\mbox{}\verb@            var r = 0;@\\
\mbox{}\verb@            for (var i = day - 1; i >= 1; i--) {@\\
\mbox{}\verb@                r = document.getElementById("r" + i).value;@\\
\mbox{}\verb@                if (r.match(/^\d/)) {@\\
\mbox{}\verb@                    break;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@                r = Number(r);@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            if (r <= 0) {@\\
\mbox{}\verb@                alert("Cannot copy rung.  No previous rung in this month's log.");@\\
\mbox{}\verb@                document.getElementById("r" + day).value = "";@\\
\mbox{}\verb@                return;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            if (document.getElementById("r" + day).value.match(/^\s*[\+]\s*$/)) {@\\
\mbox{}\verb@                r++;@\\
\mbox{}\verb@            } else if (document.getElementById("r" + day).value.match(/^\s*[\-]\s*$/)) {@\\
\mbox{}\verb@                r--;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            document.getElementById("r" + day).value = r;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if (document.getElementById("r" + day).value.match(/^\s*$/)) {@\\
\mbox{}\verb@            document.getElementById("r" + day).value = "";@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            var r = Math.floor(Number(document.getElementById("r" + day).value));@\\
\mbox{}\verb@            if (isNaN(r) || (r < 1) || (r > 48)) {@\\
\mbox{}\verb@                alert("Rung value invalid.  Must be integer between 1 and 48.");@\\
\mbox{}\verb@                resetFocus("r", day);@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                document.getElementById("r" + day).value = r;@\\
\mbox{}\verb@                @\hbox{$\langle\,${\itshape Plot exercise rung on chart image}\nobreak\ {\footnotesize \NWlink{nuweb503}{503}}$\,\rangle$}\verb@@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        countChange();@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@changeRung@\nobreak\ \NWlink{nuweb39a}{39a}.\item \NWtxtIdentsUsed\nobreak\  \verb@countChange@\nobreak\ \NWlink{nuweb484a}{484a}, \verb@floor@\nobreak\ \NWlink{nuweb446b}{446b}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@resetFocus@\nobreak\ \NWlink{nuweb516b}{516b}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Plot exercise rung on chart image}

Using the chart scale information supplied in the hidden ``{\tt sc}'' field,
compute the pixel co-ordinates of the weight just entered in the canvas which
overlays the monthly chart image and plot the rung.  We simply plot the
rung as a horizontal line from the current to the next day.  For the most
common case of no daily change in rung this is what is expected.  Entry of
several different rungs in one session will produce disconnected lines
(which are still strictly correct) that will be connected when the changes
are saved and the chart is regenerated.

This code is based on a bob-tailed version of the algorithm for plotting
sparse data detailed in section \ref{Plotting sparse data}.  Here, we
know that today's point is defined---we wouldn't be here plotting it
otherwise---so the only question is whether yesterday's and tomorrow's
points are defined.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap675}\raggedright\small
\NWtarget{nuweb503}{} $\langle\,${\itshape Plot exercise rung on chart image}\nobreak\ {\footnotesize {503}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    @\hbox{$\langle\,${\itshape Extract scaling information for chart}\nobreak\ {\footnotesize \NWlink{nuweb496}{496}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    if ((r >= 1) && (r <= scaling[7])) {@\\
\mbox{}\verb@        var n = Number(document.getElementById("md").getAttribute("value")); // Days in month@\\
\mbox{}\verb@@\\
\mbox{}\verb@        var plot = getCanvas("chart");@\\
\mbox{}\verb@        plot.setColor("#0000FF");@\\
\mbox{}\verb@@\\
\mbox{}\verb@        var cx = scaling[1] + (scaling[2] * (day - 1)),@\\
\mbox{}\verb@            cy = scaling[3] - Math.floor(((r - 1) * scaling[5]) / scaling[7]);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (day == n) {@\\
\mbox{}\verb@            var lx = scaling[1] + (scaling[2] * (day - 2));@\\
\mbox{}\verb@            if (document.getElementById("r" + (day - 1)).value != "") {@\\
\mbox{}\verb@                //  Yesterday defined--plot from yesterday to today@\\
\mbox{}\verb@                var ly = scaling[3] - Math.floor(((Number(document.getElementById("r" + (day - 1)).value) - 1) * scaling[5]) / scaling[7]);@\\
\mbox{}\verb@                plot.drawLine(lx, ly, cx, cy);@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                //  Yesterday not defined--plot a flat line from yesterday to today@\\
\mbox{}\verb@                plot.drawLine(lx, cy, cx, cy);@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            if ((day > 1) && (document.getElementById("r" + (day - 1)).value != "")) {@\\
\mbox{}\verb@                //  Yesterday defined--plot from yesterday to today@\\
\mbox{}\verb@                var lx = scaling[1] + (scaling[2] * (day - 2)),@\\
\mbox{}\verb@                    ly = scaling[3] - Math.floor(((Number(document.getElementById("r" + (day - 1)).value) - 1) * scaling[5]) / scaling[7]);@\\
\mbox{}\verb@                plot.drawLine(lx, ly, cx, cy);@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                if (document.getElementById("r" + (day + 1)).value != "") {@\\
\mbox{}\verb@                    //  Tomorrow defined--plot from today to tomorrow@\\
\mbox{}\verb@                    var nx = scaling[1] + (scaling[2] * day),@\\
\mbox{}\verb@                        ny = scaling[3] - Math.floor(((Number(document.getElementById("r" + (day + 1)).value) - 1) * scaling[5]) / scaling[7]);@\\
\mbox{}\verb@                    plot.drawLine(cx, cy, nx, ny);@\\
\mbox{}\verb@                } else {@\\
\mbox{}\verb@                    //  Tomorrow not defined--plot a flat line from today to tomorrow@\\
\mbox{}\verb@                    var nx = scaling[1] + (scaling[2] * day);@\\
\mbox{}\verb@                    plot.drawLine(cx, cy, nx, cy);@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        plot.paint();@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb502}{502}.
\item \NWtxtIdentsUsed\nobreak\  \verb@floor@\nobreak\ \NWlink{nuweb446b}{446b}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Change comment field}

If the user enters just a period in a comment field, the most most recently entered
comment will be copied into the field.  The period must be the only character in
the comment field.  To enter a comment which is just a single period, enter a space
after the period.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap676}\raggedright\small
\NWtarget{nuweb504}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {504}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function changeComment(day) {@\\
\mbox{}\verb@        if ((document.getElementById("c" + day).value == ".") ||@\\
\mbox{}\verb@            (document.getElementById("c" + day).value == ",")) {@\\
\mbox{}\verb@            var r = "";@\\
\mbox{}\verb@            for (var i = day - 1; i >= 1; i--) {@\\
\mbox{}\verb@                r = document.getElementById("c" + i).value;@\\
\mbox{}\verb@                if (!r.match(/^\s*$/)) {@\\
\mbox{}\verb@                    break;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            if (r == "") {@\\
\mbox{}\verb@                alert("Cannot copy comment.  No previous comment in this month's log.");@\\
\mbox{}\verb@                document.getElementById("c" + day).value = "";@\\
\mbox{}\verb@                return;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            document.getElementById("c" + day).value = r;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        countChange();@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@changeComment@\nobreak\ \NWlink{nuweb40a}{40a}.\item \NWtxtIdentsUsed\nobreak\  \verb@countChange@\nobreak\ \NWlink{nuweb484a}{484a}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Diet calculator support}

Functions in this section support the interactive diet calculator.
We begin by defining the variables which represent the
active fields in the diet calculator.  They are loaded from
the form fields by {\tt loadDietCalcFields()} below whenever
the user changes a field and we need to reflect the change
in the other fields.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap677}\raggedright\small
\NWtarget{nuweb505}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {505}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    var calc_calorie_balance, calc_energy_unit,@\\
\mbox{}\verb@        calc_start_weight, calc_weight_unit,@\\
\mbox{}\verb@        calc_goal_weight, calc_weight_change,@\\
\mbox{}\verb@        calc_weight_week, calc_weeks, calc_months,@\\
\mbox{}\verb@        calc_start_date, calc_end_date;@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb120}{120}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb139}{, 139}\NWlink{nuweb142}{, 142}\NWlink{nuweb255}{, 255}\NWlink{nuweb275}{, 275}\NWlink{nuweb278b}{, 278b}\NWlink{nuweb284}{, 284}\NWlink{nuweb285}{, 285}\NWlink{nuweb287a}{, 287a}\NWlink{nuweb287b}{b}\NWlink{nuweb290a}{, 290a}\NWlink{nuweb290b}{b}\NWlink{nuweb291a}{, 291a}\NWlink{nuweb292}{, 292}\NWlink{nuweb293}{, 293}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb514b}{, 514b}, \verb@calc_end_date@\nobreak\ \NWlink{nuweb275}{275}\NWlink{nuweb277a}{, 277a}\NWlink{nuweb277b}{b}\NWlink{nuweb284}{, 284}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb514b}{, 514b}, \verb@calc_energy_unit,@\nobreak\ \NWtxtIdentsNotUsed, \verb@calc_goal_weight@\nobreak\ \NWlink{nuweb120}{120}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb139}{, 139}\NWlink{nuweb142}{, 142}\NWlink{nuweb255}{, 255}\NWlink{nuweb274}{, 274}\NWlink{nuweb275}{, 275}\NWlink{nuweb279b}{, 279b}\NWlink{nuweb284}{, 284}\NWlink{nuweb285}{, 285}\NWlink{nuweb288a}{, 288a}\NWlink{nuweb289a}{, 289a}\NWlink{nuweb289b}{b}\NWlink{nuweb293}{, 293}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb510b}{, 510b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}, \verb@calc_months,@\nobreak\ \NWlink{nuweb275}{275}, \verb@calc_start_date@\nobreak\ \NWlink{nuweb120}{120}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb139}{, 139}\NWlink{nuweb142}{, 142}\NWlink{nuweb255}{, 255}\NWlink{nuweb275}{, 275}\NWlink{nuweb277a}{, 277a}\NWlink{nuweb277b}{b}\NWlink{nuweb284}{, 284}\NWlink{nuweb285}{, 285}\NWlink{nuweb291b}{, 291b}\NWlink{nuweb292}{, 292}\NWlink{nuweb293}{, 293}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb513b}{, 513b}\NWlink{nuweb514b}{, 514b}, \verb@calc_start_weight@\nobreak\ \NWlink{nuweb120}{120}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb139}{, 139}\NWlink{nuweb142}{, 142}\NWlink{nuweb255}{, 255}\NWlink{nuweb274}{, 274}\NWlink{nuweb275}{, 275}\NWlink{nuweb279a}{, 279a}\NWlink{nuweb284}{, 284}\NWlink{nuweb285}{, 285}\NWlink{nuweb288a}{, 288a}\NWlink{nuweb288b}{b}\NWlink{nuweb289b}{, 289b}\NWlink{nuweb293}{, 293}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511b}{, 511b}, \verb@calc_weeks@\nobreak\ \NWlink{nuweb275}{275}\NWlink{nuweb281}{, 281}\NWlink{nuweb284}{, 284}\NWlink{nuweb290b}{, 290b}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb512b}{, 512b}, \verb@calc_weight_change,@\nobreak\ \NWlink{nuweb274}{274}\NWlink{nuweb275}{, 275}\NWlink{nuweb507}{, 507}, \verb@calc_weight_unit,@\nobreak\ \NWlink{nuweb274}{274}\NWlink{nuweb275}{, 275}, \verb@calc_weight_week@\nobreak\ \NWlink{nuweb274}{274}\NWlink{nuweb275}{, 275}\NWlink{nuweb280b}{, 280b}\NWlink{nuweb284}{, 284}\NWlink{nuweb290a}{, 290a}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb512a}{, 512a}.\item \NWtxtIdentsUsed\nobreak\  \verb@calc_months@\nobreak\ \NWlink{nuweb513a}{513a}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Load diet calculator values}

Load the current values from the diet calculator fields into
our working variables.  The fact that we convert these values
to and from the symbolic representation shown to the user in the
form fields every time guarantees they are always in canonical
form.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap678}\raggedright\small
\NWtarget{nuweb506}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {506}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function loadDietCalcFields() {@\\
\mbox{}\verb@        decimalCharacter = document.getElementById("dc").getAttribute("value");@\\
\mbox{}\verb@        calc_energy_unit = document.getElementById("calc_energy_unit").selectedIndex;@\\
\mbox{}\verb@        calc_calorie_balance = Number(document.getElementById("calc_calorie_balance").value.replace(/,/g, ".")) *@\\
\mbox{}\verb@            CALORIES_PER_ENERGY_UNIT[calc_energy_unit];@\\
\mbox{}\verb@        calc_weight_unit = document.getElementById("calc_weight_unit").selectedIndex;@\\
\mbox{}\verb@        calc_start_weight =@\\
\mbox{}\verb@            parseWeight(document.getElementById("calc_start_weight").value, calc_weight_unit);@\\
\mbox{}\verb@        calc_goal_weight =@\\
\mbox{}\verb@            parseWeight(document.getElementById("calc_goal_weight").value, calc_weight_unit);@\\
\mbox{}\verb@        calc_weight_change = parseSignedWeight(document.getElementById("calc_weight_change").value, calc_weight_unit);@\\
\mbox{}\verb@        calc_weight_week =@\\
\mbox{}\verb@            parseSignedWeight(document.getElementById("calc_weight_week").value, calc_weight_unit);@\\
\mbox{}\verb@        calc_weeks = Number(document.getElementById("calc_weeks").value);@\\
\mbox{}\verb@        calc_months = Number(document.getElementById("calc_months").value);@\\
\mbox{}\verb@        calc_start_date = get_selected_date("from");@\\
\mbox{}\verb@        calc_end_date = get_selected_date("to");@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@loadDietCalcFields@\nobreak\ \NWlink{nuweb274}{274}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}.\item \NWtxtIdentsUsed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_end_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_goal_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_months@\nobreak\ \NWlink{nuweb513a}{513a}, \verb@calc_start_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_weeks@\nobreak\ \NWlink{nuweb505}{505}\NWlink{nuweb512b}{, 512b}, \verb@calc_weight_week@\nobreak\ \NWlink{nuweb505}{505}, \verb@CALORIES_PER_ENERGY_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@get_selected_date@\nobreak\ \NWlink{nuweb514a}{514a}, \verb@parseSignedWeight@\nobreak\ \NWlink{nuweb402}{402}\NWlink{nuweb486}{, 486}, \verb@parseWeight@\nobreak\ \NWlink{nuweb401}{401}\NWlink{nuweb485b}{, 485b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Recalculate diet calculator values}

Recalculate derived quantities from primary quantities and update
the fields in the diet calculator.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap679}\raggedright\small
\NWtarget{nuweb507}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {507}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function dietCalcRecalculate() {@\\
\mbox{}\verb@        calc_weight_change = calc_goal_weight - calc_start_weight;@\\
\mbox{}\verb@        calc_weight_week = (calc_calorie_balance * 7) / CALORIES_PER_WEIGHT_UNIT[calc_weight_unit];@\\
\mbox{}\verb@        calc_weeks = Math.round(calc_weight_change / calc_weight_week);@\\
\mbox{}\verb@        calc_months = Math.round(((calc_weight_change / calc_weight_week) * 7.0) / 30.44);@\\
\mbox{}\verb@        calc_end_date = calc_start_date + (calc_weeks * 7 * 24 * 60 * 60 * 1000);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        //  Update the form fields with the new values@\\
\mbox{}\verb@@\\
\mbox{}\verb@        document.getElementById("calc_calorie_balance").value = Math.round(calc_calorie_balance /@\\
\mbox{}\verb@            CALORIES_PER_ENERGY_UNIT[document.getElementById("calc_energy_unit").selectedIndex]);@\\
\mbox{}\verb@        document.getElementById("calc_start_weight").value =@\\
\mbox{}\verb@            editWeight(calc_start_weight, calc_weight_unit);@\\
\mbox{}\verb@        document.getElementById("calc_goal_weight").value =@\\
\mbox{}\verb@            editWeight(calc_goal_weight, calc_weight_unit);@\\
\mbox{}\verb@        document.getElementById("calc_weight_change").value =@\\
\mbox{}\verb@            editWeight(calc_weight_change, calc_weight_unit);@\\
\mbox{}\verb@        document.getElementById("calc_weight_week").value =@\\
\mbox{}\verb@            editWeight(calc_weight_week, calc_weight_unit);@\\
\mbox{}\verb@        document.getElementById("calc_weeks").value = calc_weeks;@\\
\mbox{}\verb@        document.getElementById("calc_months").value = calc_months;@\\
\mbox{}\verb@        set_date_selection("from", calc_start_date);@\\
\mbox{}\verb@        set_date_selection("to", calc_end_date);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (calc_end_date <= calc_start_date) {@\\
\mbox{}\verb@            document.getElementById("end_date").style.display = "none";@\\
\mbox{}\verb@            document.getElementById("endless_date").style.display = "inline";@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            document.getElementById("end_date").style.display = "inline";@\\
\mbox{}\verb@            document.getElementById("endless_date").style.display = "none";@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@@\\
\mbox{}\verb@        countChange();@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@dietCalcRecalculate@\nobreak\ \NWlink{nuweb509a}{509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514b}{, 514b}.\item \NWtxtIdentsUsed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_end_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_goal_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_months@\nobreak\ \NWlink{nuweb513a}{513a}, \verb@calc_start_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_weeks@\nobreak\ \NWlink{nuweb505}{505}\NWlink{nuweb512b}{, 512b}, \verb@calc_weight_change,@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_weight_week@\nobreak\ \NWlink{nuweb505}{505}, \verb@CALORIES_PER_ENERGY_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@CALORIES_PER_WEIGHT_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@countChange@\nobreak\ \NWlink{nuweb484a}{484a}, \verb@editWeight@\nobreak\ \NWlink{nuweb41a}{41a}\NWlink{nuweb485a}{, 485a}, \verb@set_date_selection@\nobreak\ \NWlink{nuweb508}{508}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Set date selection}

Set the components of a calendar date in the group of selection
fields with ID {\tt which} to represent the JavaScript
millisecond UTC date {\tt ms}.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap680}\raggedright\small
\NWtarget{nuweb508}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {508}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function set_date_selection(which, ms) {@\\
\mbox{}\verb@        var date = new Date(ms);@\\
\mbox{}\verb@        var year = date.getUTCFullYear(),@\\
\mbox{}\verb@            month = date.getUTCMonth(),@\\
\mbox{}\verb@            day = date.getUTCDate();@\\
\mbox{}\verb@@\\
\mbox{}\verb@        var i;@\\
\mbox{}\verb@        for (i = 0; i < document.getElementById(which + "_y").length; i++) {@\\
\mbox{}\verb@            if (year == Number(document.getElementById(which + "_y").options[i].value)) {@\\
\mbox{}\verb@                document.getElementById(which + "_y").selectedIndex = i;@\\
\mbox{}\verb@                i = -1;@\\
\mbox{}\verb@                break;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        if (i != -1) {@\\
\mbox{}\verb@//alert("Added year " + year + " to " + which + " selection");@\\
\mbox{}\verb@            document.getElementById(which + "_y").options[document.getElementById(which + "_y").length] =@\\
\mbox{}\verb@                new Option(year, year);@\\
\mbox{}\verb@            document.getElementById(which + "_y").selectedIndex = document.getElementById(which + "_y").length - 1;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        document.getElementById(which + "_m").selectedIndex = month;@\\
\mbox{}\verb@        document.getElementById(which + "_d").selectedIndex = day - 1;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@set_date_selection@\nobreak\ \NWlink{nuweb507}{507}.\item \NWtxtIdentsUsed\nobreak\  \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Change energy balance}

Handle a change in the energy balance.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap681}\raggedright\small
\NWtarget{nuweb509a}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {509a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function change_calc_calorie_balance() {@\\
\mbox{}\verb@        loadDietCalcFields();@\\
\mbox{}\verb@//alert("cccb " + calc_calorie_balance);@\\
\mbox{}\verb@        dietCalcRecalculate();@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@change_calc_calorie_balance@\nobreak\ \NWlink{nuweb278b}{278b}.\item \NWtxtIdentsUsed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}, \verb@dietCalcRecalculate@\nobreak\ \NWlink{nuweb507}{507}, \verb@loadDietCalcFields@\nobreak\ \NWlink{nuweb506}{506}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Change energy unit}

Handle a change in the energy unit.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap682}\raggedright\small
\NWtarget{nuweb509b}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {509b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function change_calc_energy_unit() {@\\
\mbox{}\verb@        var old_calc_energy_unit = calc_energy_unit;@\\
\mbox{}\verb@        loadDietCalcFields();@\\
\mbox{}\verb@        calc_calorie_balance *= ENERGY_CONVERSION[old_calc_energy_unit][calc_energy_unit];@\\
\mbox{}\verb@        dietCalcRecalculate();@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@change_calc_energy_unit@\nobreak\ \NWlink{nuweb278b}{278b}.\item \NWtxtIdentsUsed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}, \verb@dietCalcRecalculate@\nobreak\ \NWlink{nuweb507}{507}, \verb@ENERGY_CONVERSION@\nobreak\ \NWlink{nuweb24}{24}, \verb@loadDietCalcFields@\nobreak\ \NWlink{nuweb506}{506}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Change starting weight}

Handle a change in the starting weight.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap683}\raggedright\small
\NWtarget{nuweb510a}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {510a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function change_calc_start_weight() {@\\
\mbox{}\verb@        loadDietCalcFields();@\\
\mbox{}\verb@        if (calc_start_weight > 0) {@\\
\mbox{}\verb@            dietCalcRecalculate();@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            alert("Invalid initial weight.");@\\
\mbox{}\verb@            resetFocus("calc_start_weight");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@change_calc_start_weight@\nobreak\ \NWlink{nuweb279a}{279a}.\item \NWtxtIdentsUsed\nobreak\  \verb@calc_start_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@dietCalcRecalculate@\nobreak\ \NWlink{nuweb507}{507}, \verb@loadDietCalcFields@\nobreak\ \NWlink{nuweb506}{506}, \verb@resetFocus@\nobreak\ \NWlink{nuweb516b}{516b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Change weight unit}

Handle a change in the weight unit.  There is some fancy footwork
below due to our parsing stones and pounds differently from sane units
like kilograms or pounds.  If the user has changed the units from
another unit to stones, the primary weight fields will have been
parsed incorrectly as a number of stones.  We temporarily reinstate
the former unit, re-parse the primary weight fields, convert them to
stones (actually pounds), and then we're finally ready to edit them in
stones and pounds format into the form fields.  The lengths we'll do
to get stoned!

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap684}\raggedright\small
\NWtarget{nuweb510b}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {510b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function change_calc_weight_unit() {@\\
\mbox{}\verb@        var old_calc_weight_unit = calc_weight_unit;@\\
\mbox{}\verb@        loadDietCalcFields();@\\
\mbox{}\verb@        var new_calc_weight_unit = calc_weight_unit;@\\
\mbox{}\verb@        calc_weight_unit = old_calc_weight_unit;@\\
\mbox{}\verb@        calc_start_weight =@\\
\mbox{}\verb@            parseWeight(document.getElementById("calc_start_weight").value, calc_weight_unit);@\\
\mbox{}\verb@        calc_goal_weight =@\\
\mbox{}\verb@            parseWeight(document.getElementById("calc_goal_weight").value, calc_weight_unit);@\\
\mbox{}\verb@        calc_weight_unit = new_calc_weight_unit;@\\
\mbox{}\verb@        calc_start_weight *= WEIGHT_CONVERSION[old_calc_weight_unit][calc_weight_unit];@\\
\mbox{}\verb@        calc_goal_weight *= WEIGHT_CONVERSION[old_calc_weight_unit][calc_weight_unit];@\\
\mbox{}\verb@        dietCalcRecalculate();@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@change_calc_weight_unit@\nobreak\ \NWlink{nuweb279a}{279a}.\item \NWtxtIdentsUsed\nobreak\  \verb@calc_goal_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@dietCalcRecalculate@\nobreak\ \NWlink{nuweb507}{507}, \verb@loadDietCalcFields@\nobreak\ \NWlink{nuweb506}{506}, \verb@parseWeight@\nobreak\ \NWlink{nuweb401}{401}\NWlink{nuweb485b}{, 485b}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Change goal weight}

Handle a change in the goal weight.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap685}\raggedright\small
\NWtarget{nuweb511a}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {511a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function change_calc_goal_weight() {@\\
\mbox{}\verb@        loadDietCalcFields();@\\
\mbox{}\verb@        if (calc_goal_weight > 0) {@\\
\mbox{}\verb@            dietCalcRecalculate();@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            alert("Invalid goal weight.");@\\
\mbox{}\verb@            resetFocus("calc_goal_weight");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@change_calc_goal_weight@\nobreak\ \NWlink{nuweb279b}{279b}.\item \NWtxtIdentsUsed\nobreak\  \verb@calc_goal_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@dietCalcRecalculate@\nobreak\ \NWlink{nuweb507}{507}, \verb@loadDietCalcFields@\nobreak\ \NWlink{nuweb506}{506}, \verb@resetFocus@\nobreak\ \NWlink{nuweb516b}{516b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Change desired weight gain/loss}

Handle a change in the desired weight gain or loss.
Changing this derivative field modifies the goal weight
to result in the specified delta weight.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap686}\raggedright\small
\NWtarget{nuweb511b}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {511b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function change_calc_weight_change() {@\\
\mbox{}\verb@        loadDietCalcFields();@\\
\mbox{}\verb@        calc_goal_weight = calc_start_weight + calc_weight_change;@\\
\mbox{}\verb@        dietCalcRecalculate();@\\
\mbox{}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@change_calc_weight_change@\nobreak\ \NWlink{nuweb280a}{280a}.\item \NWtxtIdentsUsed\nobreak\  \verb@calc_goal_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_weight@\nobreak\ \NWlink{nuweb505}{505}, \verb@dietCalcRecalculate@\nobreak\ \NWlink{nuweb507}{507}, \verb@loadDietCalcFields@\nobreak\ \NWlink{nuweb506}{506}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Change weekly weight gain/loss}

Handle a change in the weekly weight gain/loss.
Changing this derivative field adjusts the energy
balance to achieve the desired weekly change.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap687}\raggedright\small
\NWtarget{nuweb512a}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {512a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function change_calc_weight_week() {@\\
\mbox{}\verb@        loadDietCalcFields();@\\
\mbox{}\verb@        calc_calorie_balance = calc_weight_week * (CALORIES_PER_WEIGHT_UNIT[calc_weight_unit] / 7);@\\
\mbox{}\verb@//alert(calc_calorie_balance);@\\
\mbox{}\verb@        dietCalcRecalculate();@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@change_calc_weight_week@\nobreak\ \NWlink{nuweb280b}{280b}.\item \NWtxtIdentsUsed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_weight_week@\nobreak\ \NWlink{nuweb505}{505}, \verb@CALORIES_PER_WEIGHT_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@dietCalcRecalculate@\nobreak\ \NWlink{nuweb507}{507}, \verb@loadDietCalcFields@\nobreak\ \NWlink{nuweb506}{506}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Change weeks duration}

Changing the weeks to go field adjusts the energy balance to achieve
the specified weight delta in the given number of weeks.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap688}\raggedright\small
\NWtarget{nuweb512b}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {512b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function change_calc_weeks() {@\\
\mbox{}\verb@        loadDietCalcFields();@\\
\mbox{}\verb@        if (calc_weeks > 0) {@\\
\mbox{}\verb@            calc_calorie_balance = Math.round(((calc_weight_change / calc_weeks) *@\\
\mbox{}\verb@                (CALORIES_PER_WEIGHT_UNIT[calc_weight_unit] / 7)));@\\
\mbox{}\verb@            dietCalcRecalculate();@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            alert("Weeks duration must be greater than zero.");@\\
\mbox{}\verb@            resetFocus("calc_weeks");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@calc_weeks@\nobreak\ \NWlink{nuweb275}{275}\NWlink{nuweb281}{, 281}\NWlink{nuweb284}{, 284}\NWlink{nuweb290b}{, 290b}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}.\item \NWtxtIdentsUsed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}, \verb@CALORIES_PER_WEIGHT_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@dietCalcRecalculate@\nobreak\ \NWlink{nuweb507}{507}, \verb@loadDietCalcFields@\nobreak\ \NWlink{nuweb506}{506}, \verb@resetFocus@\nobreak\ \NWlink{nuweb516b}{516b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Change months duration}

Changing the months to go field triggers recomputation of the calorie
balance needed to accomplish the current weight change in the
specified number of months.  We take the number of days in a month as
the mean for the Gregorian calendar.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap689}\raggedright\small
\NWtarget{nuweb513a}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {513a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function change_calc_months() {@\\
\mbox{}\verb@        loadDietCalcFields();@\\
\mbox{}\verb@        if (calc_months > 0) {@\\
\mbox{}\verb@            calc_calorie_balance = Math.round(((calc_weight_change / calc_months) *@\\
\mbox{}\verb@                (CALORIES_PER_WEIGHT_UNIT[calc_weight_unit] / 30.44)));@\\
\mbox{}\verb@            dietCalcRecalculate();@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            alert("Months duration must be greater than zero.");@\\
\mbox{}\verb@            resetFocus("calc_months");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@calc_months@\nobreak\ \NWlink{nuweb275}{275}\NWlink{nuweb281}{, 281}\NWlink{nuweb284}{, 284}\NWlink{nuweb291a}{, 291a}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}.\item \NWtxtIdentsUsed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}, \verb@CALORIES_PER_WEIGHT_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@dietCalcRecalculate@\nobreak\ \NWlink{nuweb507}{507}, \verb@loadDietCalcFields@\nobreak\ \NWlink{nuweb506}{506}, \verb@resetFocus@\nobreak\ \NWlink{nuweb516b}{516b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Change start date}

The starting date is a primary field.  When changed, the ending date
is adjusted to reflect the current duration.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap690}\raggedright\small
\NWtarget{nuweb513b}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {513b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function change_from_date() {@\\
\mbox{}\verb@        calc_start_date = get_selected_date("from");@\\
\mbox{}\verb@        dietCalcRecalculate();@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    function change_from_y() {@\\
\mbox{}\verb@        change_from_date();@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    function change_from_m() {@\\
\mbox{}\verb@        change_from_date();@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    function change_from_d() {@\\
\mbox{}\verb@        change_from_date();@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@change_from_d@\nobreak\ \NWlink{nuweb272}{272}, \verb@change_from_date@\nobreak\ \NWtxtIdentsNotUsed, \verb@change_from_m@\nobreak\ \NWlink{nuweb272}{272}, \verb@change_from_y@\nobreak\ \NWlink{nuweb272}{272}.\item \NWtxtIdentsUsed\nobreak\  \verb@calc_start_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@dietCalcRecalculate@\nobreak\ \NWlink{nuweb507}{507}, \verb@get_selected_date@\nobreak\ \NWlink{nuweb514a}{514a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsubsection{Get selected date}

Extract the components of a calendar date from the group of selection
fields with ID {\tt which} and return a JavaScript millisecond UTC
time quantity for that date.  No range checking is done; the selection
field is presumed to have worried about that, and there's no serious
damage a user can do by dummying up ridiculous values, since this is
only used in the diet calculator.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap691}\raggedright\small
\NWtarget{nuweb514a}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {514a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function get_selected_date(which) {@\\
\mbox{}\verb@        var year = document.getElementById(which + "_y").options[document.getElementById(which + "_y").selectedIndex].text,@\\
\mbox{}\verb@            month = document.getElementById(which + "_m").selectedIndex,@\\
\mbox{}\verb@            day = document.getElementById(which + "_d").selectedIndex + 1;@\\
\mbox{}\verb@        return Date.UTC(year, month, day);@\\
\mbox{}\verb@@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@get_selected_date@\nobreak\ \NWlink{nuweb506}{506}\NWlink{nuweb513b}{, 513b}\NWlink{nuweb514b}{, 514b}.\item \NWtxtIdentsUsed\nobreak\  \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Change end date}

When the ending date is changed, we adjust the energy balance to
achieve the desired weight change in the interval between the
start and end dates.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap692}\raggedright\small
\NWtarget{nuweb514b}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {514b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function change_to_date() {@\\
\mbox{}\verb@        calc_end_date = get_selected_date("to");@\\
\mbox{}\verb@        if (calc_end_date > calc_start_date) {@\\
\mbox{}\verb@            calc_calorie_balance = Math.round((calc_weight_change /@\\
\mbox{}\verb@                ((calc_end_date - calc_start_date) / (24 * 60 * 60 * 1000))) *@\\
\mbox{}\verb@                CALORIES_PER_WEIGHT_UNIT[calc_weight_unit]);@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            alert("End date must be after start date.");@\\
\mbox{}\verb@            resetFocus("to_y");@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        dietCalcRecalculate();@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    function change_to_y() {@\\
\mbox{}\verb@        change_to_date();@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    function change_to_m() {@\\
\mbox{}\verb@        change_to_date();@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    function change_to_d() {@\\
\mbox{}\verb@        change_to_date();@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@change_to_d@\nobreak\ \NWlink{nuweb273}{273}, \verb@change_to_date@\nobreak\ \NWtxtIdentsNotUsed, \verb@change_to_m@\nobreak\ \NWlink{nuweb273}{273}, \verb@change_to_y@\nobreak\ \NWlink{nuweb273}{273}.\item \NWtxtIdentsUsed\nobreak\  \verb@calc_calorie_balance@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_end_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@calc_start_date@\nobreak\ \NWlink{nuweb505}{505}, \verb@CALORIES_PER_WEIGHT_UNIT@\nobreak\ \NWlink{nuweb24}{24}, \verb@dietCalcRecalculate@\nobreak\ \NWlink{nuweb507}{507}, \verb@get_selected_date@\nobreak\ \NWlink{nuweb514a}{514a}, \verb@resetFocus@\nobreak\ \NWlink{nuweb516b}{516b}, \verb@start@\nobreak\ \NWlink{nuweb19b}{19b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Change plot diet plan in chart}

Note when the user changes the state of the ``Plot plan in chart''
checkbox.  The only reason we care about this is to note that
something has changed which will trigger a warning if the user is
about to quit the page without saving the changes.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap693}\raggedright\small
\NWtarget{nuweb515}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {515}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function change_calc_plot_plan() {@\\
\mbox{}\verb@        countChange();@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@change_calc_plot_plan@\nobreak\ \NWlink{nuweb283}{283}.\item \NWtxtIdentsUsed\nobreak\  \verb@countChange@\nobreak\ \NWlink{nuweb484a}{484a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Validate feedback form}


\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap694}\raggedright\small
\NWtarget{nuweb516a}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {516a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function validateFeedback() {@\\
\mbox{}\verb@        if (document.getElementById("category").selectedIndex <= 0) {@\\
\mbox{}\verb@            alert("Please choose a category for your feedback message.");@\\
\mbox{}\verb@            return false;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return true;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@validateFeedback@\nobreak\ \NWlink{nuweb366}{366}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Reset keyboard focus}

This function resets the keyboard focus to the field with ID
consisting of the {\tt fieldname} concatenated with the optional {\tt
day} number.  We make this a function because a crappy work-around is
required for Firefox, and in case it breaks some other browser or
eventually may be retired, it only needs to be fixed here.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap695}\raggedright\small
\NWtarget{nuweb516b}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {516b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function resetFocus(fieldname, day) {@\\
\mbox{}\verb@        if (arguments.length < 2) {@\\
\mbox{}\verb@            day = "";@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        setTimeout("document.getElementById(\"" + fieldname + day + "\").focus()", 1);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@resetFocus@\nobreak\ \NWlink{nuweb493a}{493a}\NWlink{nuweb493b}{b}\NWlink{nuweb502}{, 502}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb512b}{, 512b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb514b}{, 514b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{External link window management}

In Strict XHTML 1.0, the ``{\tt target=}'' attribute of the
\verb+<a>+ tag is forbidden, having been deemed a matter
of ``presentation''\ldots {\em hrrrmph}\/!  So, we run this
little JavaScript hack after loading every page, which riffles
through the links, checking for ``{\tt rel=}'' attributes,
which {\em are} permitted, looking for those with a prefix
of ``{\tt Target:}''.  For each of these, we extract the balance
of the relation specification and set it as the DOM target property
of the link.  The things we do to comply with that standard!

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap696}\raggedright\small
\NWtarget{nuweb517}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {517}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    /*@\\
\mbox{}\verb@        externalLinks  --  Emulate "target=" in XHTML 1.0 Strict <a> tags@\\
\mbox{}\verb@@\\
\mbox{}\verb@        http://www.sitepoint.com/article/standards-compliant-world@\\
\mbox{}\verb@@\\
\mbox{}\verb@        Modified by John Walker to only extract and modify links with@\\
\mbox{}\verb@        rel="Target:<frame>" and extract the frame name from that@\\
\mbox{}\verb@        specification. */@\\
\mbox{}\verb@@\\
\mbox{}\verb@    function externalLinks() {@\\
\mbox{}\verb@        if (!document.getElementsByTagName) {@\\
\mbox{}\verb@            return;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        var anchors = document.getElementsByTagName("a");@\\
\mbox{}\verb@        for (var i = 0; i < anchors.length; i++) {@\\
\mbox{}\verb@            var anchor = anchors[i], target;@\\
\mbox{}\verb@            if (anchor.getAttribute("href") &&@\\
\mbox{}\verb@                anchor.getAttribute("rel") &&@\\
\mbox{}\verb@                anchor.getAttribute("rel").match(/^Target:/)) {@\\
\mbox{}\verb@                target = anchor.getAttribute("rel").match(/(^Target:)(\w+$)/);@\\
\mbox{}\verb@                anchor.target = target[2];@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@externalLinks@\nobreak\ \NWlink{nuweb483a}{483a}.\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Determine local time zone offset}

On the server we express all times in UTC, but the user may be accessing
from any time zone, and the local time zone may vary as the user
travels.  If JavaScript is enabled, we determine the current offset
between UTC and the local time zone (taking into account summer time),
and fill this into a hidden form element named ``{\tt tzoffset}'' if
such exists.  This allows request handlers to behave intelligently
based on the user's time zone (for example, forbidding the entry of
precognitive log entries from the future).  If JavaScript is disabled,
the hidden {\tt tzoffset} field will be sent with its default
value of ``{\tt unknown}''.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap697}\raggedright\small
\NWtarget{nuweb518}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {518}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function determineTimeZoneOffset() {@\\
\mbox{}\verb@        if (document.getElementById && document.getElementById("tzoffset")) {@\\
\mbox{}\verb@            document.getElementById("tzoffset").value = (new Date()).getTimezoneOffset();@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@determineTimeZoneOffset@\nobreak\ \NWlink{nuweb483a}{483a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Express number in canonical form}

Convert a the number given by the first argument to canonical form by
expressing it to the number of decimal places given by the second
argument and then removing trailing zeroes after the decimal point
and, if the number is an integer, the decimal point as well.  The
optional third argument specifies the user's preferred decimal
separator character; if unspecified, a period is used.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap698}\raggedright\small
\NWtarget{nuweb519a}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {519a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function canonicalNumber(value, places, decimal) {@\\
\mbox{}\verb@        var v = value.toFixed(places);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        if (arguments.length < 3) {@\\
\mbox{}\verb@            decimal = '.';@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        v = v.replace(/0+$/, "");@\\
\mbox{}\verb@        v = v.replace(/\.$/, "");@\\
\mbox{}\verb@        v = v.replace(/\./, decimal);@\\
\mbox{}\verb@        return v;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@canonicalNumber@\nobreak\ \NWlink{nuweb128}{128}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb147}{, 147}\NWlink{nuweb519b}{, 519b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}.\item \NWtxtIdentsUsed\nobreak\  \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Height specification unit conversion}

We invite the user to specify their height in order that we might compute
the Body Mass Index.  We allow the height to be entered either in centimetres
or as feet an inches (or inches alone).  The following JavaScript code is
triggered when the user changes the value in one of these fields, and
propagates the change to the other fields accordingly.  If JavaScript
is not enabled on the client side, no harm will be done: the server will
independently validate the specifications and reject nonsense.
}

\vbox{
\subsection{Centimetres}

The user has modified the centimetres field.  Sanity check the entry
and update the feet and inches fields to correspond.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap699}\raggedright\small
\NWtarget{nuweb519b}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {519b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function height_changed_cm() {@\\
\mbox{}\verb@        var thisform = document.getElementById("Hdiet_newacct");@\\
\mbox{}\verb@        var cm = thisform.HDiet_height_cm.value;@\\
\mbox{}\verb@        cm = cm.replace(/,/, ".");@\\
\mbox{}\verb@        if (cm > 244) {@\\
\mbox{}\verb@            if (!confirm("That's awfully tall (" + cm + " centimetres).  Are you sure?")) {@\\
\mbox{}\verb@                thisform.HDiet_height_cm.focus();@\\
\mbox{}\verb@                thisform.HDiet_height_cm.select();@\\
\mbox{}\verb@                return false;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@         if (cm < 122) {@\\
\mbox{}\verb@            if (!confirm("That's awfully short (" + cm + " centimetres).  Are you sure?")) {@\\
\mbox{}\verb@                thisform.HDiet_height_cm.focus();@\\
\mbox{}\verb@                thisform.HDiet_height_cm.select();@\\
\mbox{}\verb@                return false;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@       }@\\
\mbox{}\verb@        var inches = cm / 2.54;@\\
\mbox{}\verb@        thisform.HDiet_height_ft.value = Math.floor(inches / 12);@\\
\mbox{}\verb@        thisform.HDiet_height_in.value =@\\
\mbox{}\verb@            canonicalNumber(inches % 12, 1, thisform.decimal_character.value);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@height_changed_cm@\nobreak\ \NWlink{nuweb132}{132}.\item \NWtxtIdentsUsed\nobreak\  \verb@canonicalNumber@\nobreak\ \NWlink{nuweb146a}{146a}\NWlink{nuweb519a}{, 519a}, \verb@floor@\nobreak\ \NWlink{nuweb446b}{446b}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Feet}

The user has modified the feet field.  Check the value for reasonableness
and update the centimetres field.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap700}\raggedright\small
\NWtarget{nuweb520}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {520}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function height_changed_ft() {@\\
\mbox{}\verb@        var thisform = document.getElementById("Hdiet_newacct");@\\
\mbox{}\verb@        var ft = thisform.HDiet_height_ft.value;@\\
\mbox{}\verb@        if (ft > 7) {@\\
\mbox{}\verb@            if (!confirm("That's awfully tall (" + ft + " feet).  Are you sure?")) {@\\
\mbox{}\verb@                thisform.HDiet_height_ft.focus();@\\
\mbox{}\verb@                thisform.HDiet_height_ft.select();@\\
\mbox{}\verb@                return false;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@         if (ft < 4) {@\\
\mbox{}\verb@            if (!confirm("That's awfully short (" + ft + " feet).  Are you sure?")) {@\\
\mbox{}\verb@                thisform.HDiet_height_ft.focus();@\\
\mbox{}\verb@                thisform.HDiet_height_ft.select();@\\
\mbox{}\verb@                return false;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        var cm = ft * 2.54 * 12;@\\
\mbox{}\verb@        if (thisform.HDiet_height_in.value != '') {@\\
\mbox{}\verb@            cm += thisform.HDiet_height_in.value * 2.54;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        thisform.HDiet_height_cm.value =@\\
\mbox{}\verb@            canonicalNumber(cm, 1, thisform.decimal_character.value);;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@height_changed_ft@\nobreak\ \NWlink{nuweb132}{132}.\item \NWtxtIdentsUsed\nobreak\  \verb@canonicalNumber@\nobreak\ \NWlink{nuweb146a}{146a}\NWlink{nuweb519a}{, 519a}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Inches}

The user has modified the inches field.  If the value entered is
greater than 12, we assume it is intended as a complete
specification of height, so we update the feet and inches
fields accordingly.  The centimetres field is updated to
agree with the specification given.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap701}\raggedright\small
\NWtarget{nuweb521}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {521}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function height_changed_in() {@\\
\mbox{}\verb@        var thisform = document.getElementById("Hdiet_newacct");@\\
\mbox{}\verb@        var inches = thisform.HDiet_height_in.value;@\\
\mbox{}\verb@        inches = inches.replace(/,/, ".");@\\
\mbox{}\verb@        if (inches > 12) {@\\
\mbox{}\verb@            if (inches > 7 * 12) {@\\
\mbox{}\verb@                if (!confirm("That's awfully tall (" + inches + " inches).  Are you sure?")) {@\\
\mbox{}\verb@                    thisform.HDiet_height_in.focus();@\\
\mbox{}\verb@                    thisform.HDiet_height_in.select();@\\
\mbox{}\verb@                    return false;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@             if (inches < 4 * 12) {@\\
\mbox{}\verb@                if (!confirm("That's awfully short (" + inches + " inches).  Are you sure?")) {@\\
\mbox{}\verb@                    thisform.HDiet_height_in.focus();@\\
\mbox{}\verb@                    thisform.HDiet_height_in.select();@\\
\mbox{}\verb@                    return false;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@           }@\\
\mbox{}\verb@@\\
\mbox{}\verb@            var feet = Math.floor(inches / 12);@\\
\mbox{}\verb@            thisform.HDiet_height_ft.value = feet;@\\
\mbox{}\verb@            inches -= feet * 12;@\\
\mbox{}\verb@            thisform.HDiet_height_in.value = inches;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        var cm = inches * 2.54;@\\
\mbox{}\verb@        if (thisform.HDiet_height_ft.value != '') {@\\
\mbox{}\verb@            cm += thisform.HDiet_height_ft.value * 2.54 * 12;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        thisform.HDiet_height_cm.value =@\\
\mbox{}\verb@            canonicalNumber(cm, 1, thisform.decimal_character.value);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@height_changed_in@\nobreak\ \NWlink{nuweb132}{132}.\item \NWtxtIdentsUsed\nobreak\  \verb@canonicalNumber@\nobreak\ \NWlink{nuweb146a}{146a}\NWlink{nuweb519a}{, 519a}, \verb@floor@\nobreak\ \NWlink{nuweb446b}{446b}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Handle change to weight unit in new account creation}

When creating a new account (but not when editing the settings
for an existing account), these functions are called from the
``{\tt onclick}'' event handlers of the radio buttons which
select the log and display weight units.  New users who
do not understand the distinction between these units
may accidentally set them differently simply by checking
one and forgetting the other.  Since almost all new accounts
will want these units to be the same, if a radio button in one
group is clicked and no button in the other group has been
clicked, we preset it to be the same as the first one
clicked.  Afterward, the user is free to change either
unit without it affecting the other.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap702}\raggedright\small
\NWtarget{nuweb522}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {522}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    var logunit_spec = -1, dispunit_spec = -1;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    function set_logunit(t) {@\\
\mbox{}\verb@        if (dispunit_spec < 0) {@\\
\mbox{}\verb@            var newu = t.value;@\\
\mbox{}\verb@            document.getElementById("HDiet_dunit_" +@\\
\mbox{}\verb@                WEIGHT_ABBREVIATIONS[newu]).checked = true;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        logunit_spec = newu;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    function set_dispunit(t) {@\\
\mbox{}\verb@        if (logunit_spec < 0) {@\\
\mbox{}\verb@            var newu = t.value;@\\
\mbox{}\verb@            document.getElementById("HDiet_wunit_" +@\\
\mbox{}\verb@                WEIGHT_ABBREVIATIONS[newu]).checked = true;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        dispunit_spec = newu;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@set_dispunit@\nobreak\ \NWlink{nuweb127}{127}, \verb@set_logunit@\nobreak\ \NWlink{nuweb127}{127}.\item \NWtxtIdentsUsed\nobreak\  \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Replace a text node in an HTML document}

The {\tt replaceText} function replaces the first child
of the node with the specified {\tt id} with {\tt newtext}.
This is used to modify table items and other text fields
in the monthly log, providing a spreadsheet-style dynamic
update when the user modifies editable fields.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap703}\raggedright\small
\NWtarget{nuweb523}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {523}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function replaceText(id, newtext) {@\\
\mbox{}\verb@        var n = document.getElementById(id);@\\
\mbox{}\verb@        n.replaceChild(document.createTextNode(newtext), n.firstChild);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@replaceText@\nobreak\ \NWlink{nuweb497}{497}\NWlink{nuweb498}{, 498}\NWlink{nuweb500}{, 500}\NWlink{nuweb501}{, 501}\NWlink{nuweb524b}{, 524b}.\item \NWtxtIdentsUsed\nobreak\  \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Update a variance field}

The value {\tt newvar} is placed in the variance field
with {\tt id}.  The variance is formatted with a leading
plus or Unicode minus sign, and the class of the
enclosing container is set so that the text is displayed
in red or green according to the sign.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap704}\raggedright\small
\NWtarget{nuweb524a}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {524a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function updateVariance(id, newvar) {@\\
\mbox{}\verb@        var n = document.getElementById(id);@\\
\mbox{}\verb@        var fn = Math.abs(newvar).toFixed(1).replace(/\./, decimalCharacter);@\\
\mbox{}\verb@        var svar = ((fn == 0) ? "" :@\\
\mbox{}\verb@            ((newvar > 0) ? "+" : U_MINUS_SIGN)) + fn;@\\
\mbox{}\verb@        n.replaceChild(document.createTextNode(svar), n.firstChild);@\\
\mbox{}\verb@        n.setAttribute('class', (fn == 0) ? "bk" :@\\
\mbox{}\verb@            (newvar < 0) ? 'g' : 'r');@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@updateVariance@\nobreak\ \NWlink{nuweb498}{498}.\item \NWtxtIdentsUsed\nobreak\  \verb@U_MINUS_SIGN@\nobreak\ \NWlink{nuweb482}{482}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Recompute flagged fraction}

When the user checks or unchecks a flag box, this function is
invoked to recompute the fraction of days flagged.  If there is a
weight entered for the day, we repaint it to reflect the status
of the flag.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap705}\raggedright\small
\NWtarget{nuweb524b}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {524b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function updateFlag(day) {@\\
\mbox{}\verb@        var unit = Number(document.getElementById("du").getAttribute("value"));@\\
\mbox{}\verb@        plotWeightOnChart(day, unit);@\\
\mbox{}\verb@@\\
\mbox{}\verb@        var ndays = document.getElementById("md").getAttribute("value");@\\
\mbox{}\verb@        var i, nflagged = 0;@\\
\mbox{}\verb@        for (i = 1; i <= ndays; i++) {@\\
\mbox{}\verb@            if (document.getElementById("f" + i).checked) {@\\
\mbox{}\verb@                nflagged++;@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        var fracflagged = Math.round((nflagged * 100) / ndays);@\\
\mbox{}\verb@        if (fracflagged > 0) {@\\
\mbox{}\verb@            replaceText("percent_flagged", fracflagged + "%");@\\
\mbox{}\verb@            document.getElementById("fracf").style.display = "inline";@\\
\mbox{}\verb@        } else {@\\
\mbox{}\verb@            document.getElementById("fracf").style.display = "none";@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        countChange();@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@updateFlag@\nobreak\ \NWlink{nuweb39b}{39b}.\item \NWtxtIdentsUsed\nobreak\  \verb@countChange@\nobreak\ \NWlink{nuweb484a}{484a}, \verb@replaceText@\nobreak\ \NWlink{nuweb523}{523}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Password strength estimation}

As the user enters a password, we provide a subjective indication of its
strength in a read-only text field to its right.  The strength is given as
a number from 0 to 10, 0 indicating no password at all, and 10 a password
of excellent security for an application of this kind.  We compute the
strength by estimating the probability of guessing the password by random
assembly of characters with the frequencies present in a large corpus of
text.  Note that we {\em do not} test for common words, idiot passwords, or
those easily guessed from information available about the user.  That would
be nice, but we're just a humble client-side utility and can't afford large
databases or extensive computation.

For Unicode characters with code points above the Latin-1 range, for which
we lack statistics, we make a kludge estimate of the probability of the
character's being guessed as $(1/2^{16})(((\log_2 n) - 8)/16)$ where $n$ is
the Unicode code point for the character.

We return the inverse probability of (or, in other words, the expected number
of guesses needed to determine) the password.  This is expressed to the user by
taking the $\log_{10}$ of the value, subtracting 9, and scoring the result as
between 1 and 10.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap706}\raggedright\small
\NWtarget{nuweb525}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {525}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function passwordStrength(s) {@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Character frequency table}\nobreak\ {\footnotesize \NWlink{nuweb527}{527}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        var pprob = 1.0;@\\
\mbox{}\verb@@\\
\mbox{}\verb@        @\hbox{$\langle\,${\itshape Ad hoc tests for bad passwords}\nobreak\ {\footnotesize \NWlink{nuweb526}{526}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@        for (i = 0; i < s.length; i++) {@\\
\mbox{}\verb@            var c = s.charCodeAt(i), p;@\\
\mbox{}\verb@            if (c > 0xFF) {@\\
\mbox{}\verb@                p = (1.0 / 65536.0) * ((psLog2(c) - 8) / 16);@\\
\mbox{}\verb@            } else {@\\
\mbox{}\verb@                p = characterFrequency[(c < 128) ? (c - 32) : (c - 65)];@\\
\mbox{}\verb@                if (p == 0) {@\\
\mbox{}\verb@                    p = 1.0e-7;@\\
\mbox{}\verb@                }@\\
\mbox{}\verb@            }@\\
\mbox{}\verb@            pprob *= p;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        return 1 / pprob;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    function showPasswordStrength() {@\\
\mbox{}\verb@        var thisform = document.getElementById("Hdiet_newacct");@\\
\mbox{}\verb@        var ps = passwordStrength(thisform.HDiet_password.value);@\\
\mbox{}\verb@        thisform.HDiet_password_strength.value =@\\
\mbox{}\verb@            (thisform.HDiet_password.value.length < 6) ? 0 :@\\
\mbox{}\verb@        Math.round(Math.min(Math.max(psLog10(ps) - 9, 1), 10));@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@passwordStrength@\nobreak\ \NWtxtIdentsNotUsed, \verb@showPasswordStrength@\nobreak\ \NWlink{nuweb130}{130}.\item \NWtxtIdentsUsed\nobreak\  \verb@characterFrequency@\nobreak\ \NWlink{nuweb527}{527}, \verb@max@\nobreak\ \NWlink{nuweb405}{405}, \verb@min@\nobreak\ \NWlink{nuweb405}{405}, \verb@psLog10@\nobreak\ \NWlink{nuweb529a}{529a}, \verb@psLog2@\nobreak\ \NWlink{nuweb529a}{529a}, \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{{\em Ad hoc} tests for bad passwords}

Here we check for some common cases of ``idiot passwords'' which
na\"\i vely might appear far more secure than they are, in fact.  We
handle these by deleting the characters which contribute little to
the password's security and scoring it as if it were a shorter
string without them.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap707}\raggedright\small
\NWtarget{nuweb526}{} $\langle\,${\itshape Ad hoc tests for bad passwords}\nobreak\ {\footnotesize {526}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    //  The string "password" and other bozo classics@\\
\mbox{}\verb@    s = s.replace(/password|secret|qwerty|cookie|loveyou|/ig, "");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    //  Consecutive identical characters@\\
\mbox{}\verb@    s = s.replace(/(.)\1+/g, "$1");@\\
\mbox{}\verb@@\\
\mbox{}\verb@    //  Three or more characters in code point order or decending order@\\
\mbox{}\verb@    for (i = 0; i < s.length - 2; i++) {@\\
\mbox{}\verb@        if (((s.charCodeAt(i) == (s.charCodeAt(i + 1) - 1)) &&@\\
\mbox{}\verb@             (s.charCodeAt(i + 1) == (s.charCodeAt(i + 2) - 1))) ||@\\
\mbox{}\verb@             ((s.charCodeAt(i) == (s.charCodeAt(i + 1) + 1)) &&@\\
\mbox{}\verb@             (s.charCodeAt(i + 1) == (s.charCodeAt(i + 2) + 1)))@\\
\mbox{}\verb@            ) {@\\
\mbox{}\verb@            s = s.substring(0, i) + s.substring(i + 1);@\\
\mbox{}\verb@            i = 0;@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb525}{525}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\subsection{Character frequency table}

This table, which is indexed rather curiously with the first 95
entries representing the ASCII character between space (32) and
tilde (127) inclusive, and the following 96 the Latin-1 graphics
between nonbreaking space (160) and ``\"y'' inclusive, gives the
empirical fraction that each character made up of a large corpus of
text in a variety of human and programming languages.  This is used
to estimate the entropy of characters in order to determine the
cryptographic strength of a password.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap708}\raggedright\small
\NWtarget{nuweb527}{} $\langle\,${\itshape Character frequency table}\nobreak\ {\footnotesize {527}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    var characterFrequency = new Array (@\\
\mbox{}\verb@        0.10696, 0.00081822, 0.0023291, 4.3716e-05, 0.00015954, 1.8698e-05,@\\
\mbox{}\verb@        8.4113e-05, 0.0030053, 0.00047366, 0.00047334, 5.0773e-05, 4.7613e-05,@\\
\mbox{}\verb@        0.0074841, 0.003832, 0.0073566, 0.0022768, 0.0006086, 0.0010785,@\\
\mbox{}\verb@        0.00065979, 0.00050631, 0.00045059, 0.00044005, 0.00038765,@\\
\mbox{}\verb@        0.00035741, 0.00034319, 0.00035236, 0.00050331, 0.0013616, 0.005661,@\\
\mbox{}\verb@        0.0012761, 0.0055853, 0.00077171, 0.00013994, 0.0035894, 0.0013236,@\\
\mbox{}\verb@        0.0019242, 0.0014263, 0.003019, 0.00099098, 0.0010051, 0.001466,@\\
\mbox{}\verb@        0.0034202, 0.00031154, 0.00053323, 0.0018927, 0.0016076, 0.0019353,@\\
\mbox{}\verb@        0.0020567, 0.0012778, 0.00019367, 0.0018611, 0.0029033, 0.0026777,@\\
\mbox{}\verb@        0.0010777, 0.00044205, 0.0012584, 7.0946e-05, 0.00058568, 0.00012246,@\\
\mbox{}\verb@        0.00020457, 0.00019619, 0.00020383, 7.005e-06, 0.00018455, 2.4702e-05,@\\
\mbox{}\verb@        0.065786, 0.014786, 0.027696, 0.029905, 0.097183, 0.011098, 0.016708,@\\
\mbox{}\verb@        0.027406, 0.062681, 0.0013139, 0.0057647, 0.04161, 0.023039, 0.058548,@\\
\mbox{}\verb@        0.056328, 0.020771, 0.0023996, 0.054953, 0.057549, 0.055857, 0.031333,@\\
\mbox{}\verb@        0.008424, 0.0082229, 0.0021771, 0.014088, 0.0025955, 0.00022901,@\\
\mbox{}\verb@        9.1645e-05, 0.00022885, 5.7936e-06, 0, 0.00014447, 0, 0, 0, 0, 0, 0,@\\
\mbox{}\verb@        0, 0, 0, 0.00022864, 0, 0, 0, 0, 6.1623e-06, 0, 0, 0, 0, 0, 0, 0, 0,@\\
\mbox{}\verb@        5.2669e-08, 0, 0.00022595, 0, 0, 0, 5.2406e-05, 1.4747e-06,@\\
\mbox{}\verb@        2.1068e-07, 1.5801e-07, 0, 1.0007e-06, 0, 0, 5.2669e-07, 8.9538e-07,@\\
\mbox{}\verb@        5.7568e-05, 6.847e-07, 1.5801e-07, 5.2669e-07, 1.5801e-07, 4.2136e-07,@\\
\mbox{}\verb@        1.5801e-07, 0, 0, 1.5801e-07, 1.5801e-07, 1.9172e-05, 0, 4.2136e-07,@\\
\mbox{}\verb@        0, 0, 8.9538e-07, 1.5801e-07, 1.5801e-07, 5.7936e-06, 0, 0,@\\
\mbox{}\verb@        0.00014258, 0.0004153, 0.00039244, 6.3467e-05, 0, 0.00017786, 0, 0,@\\
\mbox{}\verb@        3.5815e-05, 0.00024918, 0.0017644, 0.00013225, 3.3708e-06, 1.5801e-07,@\\
\mbox{}\verb@        0.0001953, 4.7455e-05, 1.4905e-05, 0, 7.5107e-05, 1.3641e-05,@\\
\mbox{}\verb@        0.00011571, 2.2279e-05, 0, 0.00010207, 0, 0, 3.0127e-05, 3.039e-05,@\\
\mbox{}\verb@        4.282e-05, 0.00026688, 0, 0, 0@\\
\mbox{}\verb@    );@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb525}{525}.
\item \NWtxtIdentsDefed\nobreak\  \verb@characterFrequency@\nobreak\ \NWlink{nuweb525}{525}.\item \NWtxtIdentsUsed\nobreak\  \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Password match indication}

Since the user enters and confirms their password in a field whose contents
are not displayed by the browser, we provide a little read-only check box to
the right of the ``Retype password'' field which indicates whether it and the
``Password'' field are actually the same.  The will prevent, in most cases,
the need for bouncing the entire form in the case of a mismatch, which forces
the user (due to brower password caching security rules) to re-enter both the
password and the confirmation.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap709}\raggedright\small
\NWtarget{nuweb528}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {528}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function checkPasswordMatch() {@\\
\mbox{}\verb@        var thisform = document.getElementById("Hdiet_newacct");@\\
\mbox{}\verb@        thisform.HDiet_password_match.checked =@\\
\mbox{}\verb@            thisform.HDiet_password.value == thisform.HDiet_rpassword.value;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@checkPasswordMatch@\nobreak\ \NWlink{nuweb130}{130}.\item \NWtxtIdentsUsed\nobreak\  \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Mathematical functions}

The following functions provide useful mathematical functions absent
in JavaScript such as $\log_{2}$ and $\log_{10}$.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap710}\raggedright\small
\NWtarget{nuweb529a}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {529a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    function psLog2(x) {@\\
\mbox{}\verb@        return Math.LOG2E * Math.log(x);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    function psLog10(x) {@\\
\mbox{}\verb@        return Math.LOG10E * Math.log(x);@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsDefed\nobreak\  \verb@psLog10@\nobreak\ \NWlink{nuweb525}{525}, \verb@psLog2@\nobreak\ \NWlink{nuweb525}{525}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Debugging console support}

The {\tt dump} function allows easy access to the JavaScript debugging console
embedded in pages under development.  It is called with pairs of arguments which
give the name and values to be displayed on the console.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap711}\raggedright\small
\NWtarget{nuweb529b}{} \verb@"hdiet.js"@\nobreak\ {\footnotesize {529b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@function dump()@\\
\mbox{}\verb@{@\\
\mbox{}\verb@    var t = "", i;@\\
\mbox{}\verb@@\\
\mbox{}\verb@    for (i = 0; i < arguments.length; i += 2) {@\\
\mbox{}\verb@        if (t.length > 0) {@\\
\mbox{}\verb@            t += ", ";@\\
\mbox{}\verb@        }@\\
\mbox{}\verb@        t += arguments[i] + " = " + arguments[i + 1];@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@    document.getElementById("debugging_console").log.value += t + "\n";@\\
\mbox{}\verb@}@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
\item \NWtxtIdentsUsed\nobreak\  \verb@var@\nobreak\ \NWlink{nuweb44b}{44b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

%   __  ____  __ _       ____ _____ ____
%   \ \/ /  \/  | |     |  _ \_   _|  _ \
%    \  /| |\/| | |     | | | || | | | | |
%    /  \| |  | | |___  | |_| || | | |_| |
%   /_/\_\_|  |_|_____| |____/ |_| |____/

\clearpage
\vbox{
\chapter{XML Database Export Document Type Definition}

The {\tt hackersdiet.dtd} file contains the Document Type Definition
(DTD) for the XML export files generated from the database.  The DTD
exists purely to document the format of a compliant document and
permit validation; nothing in it is required to parse an XML export
file (which uses non non-standard entities), which is logically, if
not officially ``{\tt standalone}''.

}

\vbox{
\section{Overall document structure}

The {\tt hackersdiet} element is the unique container which
serves as the root of the document tree.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap712}\raggedright\small
\NWtarget{nuweb530}{} \verb@"hackersdiet.dtd"@\nobreak\ {\footnotesize {530}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@<!--              The Hacker's Diet Online@\\
\mbox{}\verb@            http://www.fourmilab.ch/hackdiet/online/@\\
\mbox{}\verb@@\\
\mbox{}\verb@             XML Database Document Type Definition@\\
\mbox{}\verb@@\\
\mbox{}\verb@    This definition is cited with a:@\\
\mbox{}\verb@        <!DOCTYPE hackersdiet SYSTEM@\\
\mbox{}\verb@            "http://www.fourmilab.ch/hackdiet/online/hackersdiet.dtd">@\\
\mbox{}\verb@    declaration in compliant XML files.@\\
\mbox{}\verb@@\\
\mbox{}\verb@-->@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!-- Root element -->@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!ELEMENT hackersdiet@\\
\mbox{}\verb@        (epoch?, account?, monthlogs?)@\\
\mbox{}\verb@    >@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!ATTLIST hackersdiet@\\
\mbox{}\verb@        version     CDATA   #REQUIRED@\\
\mbox{}\verb@    >@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!ELEMENT epoch                 (#PCDATA)>@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!ELEMENT account@\\
\mbox{}\verb@        (user?, preferences?, diet-plan?)@\\
\mbox{}\verb@    >@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!ATTLIST account@\\
\mbox{}\verb@        version     CDATA   #REQUIRED@\\
\mbox{}\verb@    >@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!ELEMENT monthlogs@\\
\mbox{}\verb@        (monthlog*)@\\
\mbox{}\verb@    >@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!ATTLIST monthlogs@\\
\mbox{}\verb@        version     CDATA   #REQUIRED@\\
\mbox{}\verb@    >@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb530}{530}\NWlink{nuweb532}{, 532}\NWlink{nuweb533}{, 533}\NWlink{nuweb534}{, 534}\NWlink{nuweb535}{, 535}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{User information}

User information is encoded within the {\tt user} element.
The distinction between user information and preferences
(see below) is a bit fuzzy, and both are kept in the {\tt user}
object in the application, but in general the {\tt user}
elements describes invariant properties of the user, while
{\tt preferences} are whims changeable at the will.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap713}\raggedright\small
\NWtarget{nuweb532}{} \verb@"hackersdiet.dtd"@\nobreak\ {\footnotesize {532}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    <!-- User information.  This element is optional but,@\\
\mbox{}\verb@         if present, must be first in the file. -->@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!ELEMENT user@\\
\mbox{}\verb@        (login-name?,@\\
\mbox{}\verb@         first-name?,@\\
\mbox{}\verb@         middle-name?,@\\
\mbox{}\verb@         last-name?,@\\
\mbox{}\verb@         e-mail?,@\\
\mbox{}\verb@         height?,@\\
\mbox{}\verb@         account-created?)@\\
\mbox{}\verb@    >@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!ATTLIST user@\\
\mbox{}\verb@        version     CDATA   #REQUIRED@\\
\mbox{}\verb@    >@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!ELEMENT login-name            (#PCDATA)>@\\
\mbox{}\verb@    <!ELEMENT first-name            (#PCDATA)>@\\
\mbox{}\verb@    <!ELEMENT middle-name           (#PCDATA)>@\\
\mbox{}\verb@    <!ELEMENT last-name             (#PCDATA)>@\\
\mbox{}\verb@    <!ELEMENT e-mail                (#PCDATA)>@\\
\mbox{}\verb@    <!ELEMENT height                (#PCDATA)>@\\
\mbox{}\verb@    <!ELEMENT account-created       (#PCDATA)>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb530}{530}\NWlink{nuweb532}{, 532}\NWlink{nuweb533}{, 533}\NWlink{nuweb534}{, 534}\NWlink{nuweb535}{, 535}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@login@\nobreak\ \NWlink{nuweb121}{121}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Preferences}

The {\tt preferences} element contains the user's choice
of units and other items which can be changed at will.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap714}\raggedright\small
\NWtarget{nuweb533}{} \verb@"hackersdiet.dtd"@\nobreak\ {\footnotesize {533}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    <!-- Preferences.  This element is optional but,@\\
\mbox{}\verb@         if present, must be after the user information,@\\
\mbox{}\verb@         if present.  -->@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!ELEMENT preferences@\\
\mbox{}\verb@        (log-unit?,@\\
\mbox{}\verb@         display-unit?,@\\
\mbox{}\verb@         energy-unit?,@\\
\mbox{}\verb@         current-rung?,@\\
\mbox{}\verb@         decimal-character?)@\\
\mbox{}\verb@    >@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!ATTLIST preferences@\\
\mbox{}\verb@        version     CDATA   #REQUIRED@\\
\mbox{}\verb@    >@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!ELEMENT log-unit              (#PCDATA)>@\\
\mbox{}\verb@    <!ELEMENT display-unit          (#PCDATA)>@\\
\mbox{}\verb@    <!ELEMENT energy-unit           (#PCDATA)>@\\
\mbox{}\verb@    <!ELEMENT current-rung          (#PCDATA)>@\\
\mbox{}\verb@    <!ELEMENT decimal-character     (#PCDATA)>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb530}{530}\NWlink{nuweb532}{, 532}\NWlink{nuweb533}{, 533}\NWlink{nuweb534}{, 534}\NWlink{nuweb535}{, 535}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Diet Plan}

The {\tt diet-plan} element contains the quantities
established by the user in the diet calculator, and
controls whether the plan is plotted in charts.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap715}\raggedright\small
\NWtarget{nuweb534}{} \verb@"hackersdiet.dtd"@\nobreak\ {\footnotesize {534}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    <!-- Diet plan.  This element is optional but,@\\
\mbox{}\verb@         if present, must be after the preferences,@\\
\mbox{}\verb@         if present.  -->@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!ELEMENT diet-plan@\\
\mbox{}\verb@        (calorie-balance?,@\\
\mbox{}\verb@         start-weight?,@\\
\mbox{}\verb@         goal-weight?,@\\
\mbox{}\verb@         start-date?,@\\
\mbox{}\verb@         show-plan?)@\\
\mbox{}\verb@    >@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!ATTLIST diet-plan@\\
\mbox{}\verb@        version     CDATA   #REQUIRED@\\
\mbox{}\verb@    >@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!ELEMENT calorie-balance       (#PCDATA)>@\\
\mbox{}\verb@    <!ELEMENT start-weight          (#PCDATA)>@\\
\mbox{}\verb@    <!ELEMENT goal-weight           (#PCDATA)>@\\
\mbox{}\verb@    <!ELEMENT start-date            (#PCDATA)>@\\
\mbox{}\verb@    <!ELEMENT show-plan             (#PCDATA)>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb530}{530}\NWlink{nuweb532}{, 532}\NWlink{nuweb533}{, 533}\NWlink{nuweb534}{, 534}\NWlink{nuweb535}{, 535}.
\item \NWtxtIdentsUsed\nobreak\  \verb@start@\nobreak\ \NWlink{nuweb19b}{19b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Monthly Log}

A {\tt monthlog} container will be present for each
month of the database present in the export file.  This
is composed of a header followed by a {\tt day} element
for each day of the month which gives the log entries for
that day.  All days are present, even if all of the fields
for that day are empty.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap716}\raggedright\small
\NWtarget{nuweb535}{} \verb@"hackersdiet.dtd"@\nobreak\ {\footnotesize {535}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    <!-- Monthly log.  Any number of monthly logs may@\\
\mbox{}\verb@         appear, in any order. -->@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!ELEMENT monthlog@\\
\mbox{}\verb@        (properties, days)@\\
\mbox{}\verb@    >@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!ATTLIST monthlog@\\
\mbox{}\verb@        version     CDATA   #REQUIRED@\\
\mbox{}\verb@    >@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!ELEMENT properties@\\
\mbox{}\verb@        (year,@\\
\mbox{}\verb@         month,@\\
\mbox{}\verb@         weight-unit,@\\
\mbox{}\verb@         trend-carry-forward?,@\\
\mbox{}\verb@         last-modified?)@\\
\mbox{}\verb@    >@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!ELEMENT year                  (#PCDATA)>@\\
\mbox{}\verb@    <!ELEMENT month                 (#PCDATA)>@\\
\mbox{}\verb@    <!ELEMENT weight-unit           (#PCDATA)>@\\
\mbox{}\verb@    <!ELEMENT trend-carry-forward   (#PCDATA)>@\\
\mbox{}\verb@    <!ELEMENT last-modified         (#PCDATA)>@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!ELEMENT days@\\
\mbox{}\verb@        (day+)@\\
\mbox{}\verb@    >@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!ATTLIST days@\\
\mbox{}\verb@        ndays       CDATA   #REQUIRED@\\
\mbox{}\verb@    >@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!ELEMENT day@\\
\mbox{}\verb@        (date,@\\
\mbox{}\verb@         weight,@\\
\mbox{}\verb@         rung,@\\
\mbox{}\verb@         flag,@\\
\mbox{}\verb@         comment)@\\
\mbox{}\verb@    >@\\
\mbox{}\verb@@\\
\mbox{}\verb@    <!ELEMENT date                  (#PCDATA)>@\\
\mbox{}\verb@    <!ELEMENT weight                (#PCDATA)>@\\
\mbox{}\verb@    <!ELEMENT rung                  (#PCDATA)>@\\
\mbox{}\verb@    <!ELEMENT flag                  (#PCDATA)>@\\
\mbox{}\verb@    <!ELEMENT comment               (#PCDATA)>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb530}{530}\NWlink{nuweb532}{, 532}\NWlink{nuweb533}{, 533}\NWlink{nuweb534}{, 534}\NWlink{nuweb535}{, 535}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

%   __  ____  __ _        ____ ____ ____
%   \ \/ /  \/  | |      / ___/ ___/ ___|
%    \  /| |\/| | |     | |   \___ \___ \
%    /  \| |  | | |___  | |___ ___) |__) |
%   /_/\_\_|  |_|_____|  \____|____/____/

\clearpage
\vbox{
\chapter{XML Database Export Style Sheet}

The {\tt hackdiet\_db.css} file provides a style sheet which
renders XML database export files in a more or less primate-readable
format.  This is not intended for presentation, but simply to make
examination of databases easier than digging into raw XML.

}

\vbox{
\section{Overall document structure}

The {\tt hackersdiet} element is the unique container which
serves as the root of the document tree.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap717}\raggedright\small
\NWtarget{nuweb536}{} \verb@"hackdiet_db.css"@\nobreak\ {\footnotesize {536}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    hackersdiet {@\\
\mbox{}\verb@        display: block;@\\
\mbox{}\verb@        text-align: center;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    hackersdiet:before {@\\
\mbox{}\verb@        content: "Hacker's Diet Online Database Export";@\\
\mbox{}\verb@        font-size: xx-large;@\\
\mbox{}\verb@        font-family: sans-serif;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    hackersdiet * {@\\
\mbox{}\verb@        padding-left: 8%;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb536}{536}\NWlink{nuweb537}{, 537}\NWlink{nuweb538a}{, 538a}\NWlink{nuweb538b}{b}\NWlink{nuweb539}{, 539}\NWlink{nuweb540}{, 540}\NWlink{nuweb541}{, 541}\NWlink{nuweb542}{, 542}\NWlink{nuweb543}{, 543}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Epoch of export}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap718}\raggedright\small
\NWtarget{nuweb537}{} \verb@"hackdiet_db.css"@\nobreak\ {\footnotesize {537}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    epoch {@\\
\mbox{}\verb@        display: block;@\\
\mbox{}\verb@        margin-top: 1em;@\\
\mbox{}\verb@        text-align: center;@\\
\mbox{}\verb@        font-family: sans-serif;@\\
\mbox{}\verb@        font-weight: bolder;@\\
\mbox{}\verb@        font-size: larger;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    epoch:before {@\\
\mbox{}\verb@        display: inline;@\\
\mbox{}\verb@        content: "Epoch: ";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb536}{536}\NWlink{nuweb537}{, 537}\NWlink{nuweb538a}{, 538a}\NWlink{nuweb538b}{b}\NWlink{nuweb539}{, 539}\NWlink{nuweb540}{, 540}\NWlink{nuweb541}{, 541}\NWlink{nuweb542}{, 542}\NWlink{nuweb543}{, 543}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Account information}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap719}\raggedright\small
\NWtarget{nuweb538a}{} \verb@"hackdiet_db.css"@\nobreak\ {\footnotesize {538a}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    account {@\\
\mbox{}\verb@        display: block;@\\
\mbox{}\verb@        margin-top: 1em;@\\
\mbox{}\verb@        text-align: center;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    account:before {@\\
\mbox{}\verb@        content: "Account Information";@\\
\mbox{}\verb@        font-family: sans-serif;@\\
\mbox{}\verb@        font-weight: bolder;@\\
\mbox{}\verb@        font-size: large;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb536}{536}\NWlink{nuweb537}{, 537}\NWlink{nuweb538a}{, 538a}\NWlink{nuweb538b}{b}\NWlink{nuweb539}{, 539}\NWlink{nuweb540}{, 540}\NWlink{nuweb541}{, 541}\NWlink{nuweb542}{, 542}\NWlink{nuweb543}{, 543}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{User identification}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap720}\raggedright\small
\NWtarget{nuweb538b}{} \verb@"hackdiet_db.css"@\nobreak\ {\footnotesize {538b}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    user {@\\
\mbox{}\verb@        display: block;@\\
\mbox{}\verb@        margin-top: 1em;@\\
\mbox{}\verb@        text-align: left;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    user:before {@\\
\mbox{}\verb@        display: block;@\\
\mbox{}\verb@        content: "User:";@\\
\mbox{}\verb@        font-family: sans-serif;@\\
\mbox{}\verb@        font-weight: bolder;@\\
\mbox{}\verb@        font-size: larger;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    user * {@\\
\mbox{}\verb@        display: block;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    user *:before {@\\
\mbox{}\verb@        font-weight: bolder;@\\
\mbox{}\verb@        margin-right: 1em;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    user login-name:before {@\\
\mbox{}\verb@        content: "Account name:";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    user first-name:before {@\\
\mbox{}\verb@        content: "First name:";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    user middle-name:before {@\\
\mbox{}\verb@        content: "Middle name:";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    user last-name:before {@\\
\mbox{}\verb@        content: "Last name:";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    user e-mail:before {@\\
\mbox{}\verb@        content: "E-mail address:";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    user height:before {@\\
\mbox{}\verb@        content: "Height:";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    user height:after {@\\
\mbox{}\verb@        content: " cm";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    user account-created:before {@\\
\mbox{}\verb@        content: "Account created:";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb536}{536}\NWlink{nuweb537}{, 537}\NWlink{nuweb538a}{, 538a}\NWlink{nuweb538b}{b}\NWlink{nuweb539}{, 539}\NWlink{nuweb540}{, 540}\NWlink{nuweb541}{, 541}\NWlink{nuweb542}{, 542}\NWlink{nuweb543}{, 543}.
\item \NWtxtIdentsUsed\nobreak\  \verb@login@\nobreak\ \NWlink{nuweb121}{121}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}


\vbox{
\section{Preferences}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap721}\raggedright\small
\NWtarget{nuweb539}{} \verb@"hackdiet_db.css"@\nobreak\ {\footnotesize {539}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    preferences {@\\
\mbox{}\verb@        display: block;@\\
\mbox{}\verb@        margin-top: 1em;@\\
\mbox{}\verb@        text-align: left;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    preferences:before {@\\
\mbox{}\verb@        display: block;@\\
\mbox{}\verb@        content: "Preferences:";@\\
\mbox{}\verb@        font-family: sans-serif;@\\
\mbox{}\verb@        font-weight: bolder;@\\
\mbox{}\verb@        font-size: larger;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    preferences * {@\\
\mbox{}\verb@        display: block;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    preferences *:before {@\\
\mbox{}\verb@        font-weight: bolder;@\\
\mbox{}\verb@        margin-right: 1em;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    preferences log-unit:before {@\\
\mbox{}\verb@        content: "Log weight unit:";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    preferences display-unit:before {@\\
\mbox{}\verb@        content: "Display weight unit:";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    preferences energy-unit:before {@\\
\mbox{}\verb@        content: "Energy unit:";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    preferences current-rung:before {@\\
\mbox{}\verb@        content: "Current rung:";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    preferences decimal-character:before {@\\
\mbox{}\verb@        content: "Decimal character:";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb536}{536}\NWlink{nuweb537}{, 537}\NWlink{nuweb538a}{, 538a}\NWlink{nuweb538b}{b}\NWlink{nuweb539}{, 539}\NWlink{nuweb540}{, 540}\NWlink{nuweb541}{, 541}\NWlink{nuweb542}{, 542}\NWlink{nuweb543}{, 543}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}


\vbox{
\section{Diet plan}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap722}\raggedright\small
\NWtarget{nuweb540}{} \verb@"hackdiet_db.css"@\nobreak\ {\footnotesize {540}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    diet-plan {@\\
\mbox{}\verb@        display: block;@\\
\mbox{}\verb@        margin-top: 1em;@\\
\mbox{}\verb@        text-align: left;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    diet-plan:before {@\\
\mbox{}\verb@        display: block;@\\
\mbox{}\verb@        content: "Diet Plan:";@\\
\mbox{}\verb@        font-family: sans-serif;@\\
\mbox{}\verb@        font-weight: bolder;@\\
\mbox{}\verb@        font-size: larger;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    diet-plan * {@\\
\mbox{}\verb@        display: block;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    diet-plan *:before {@\\
\mbox{}\verb@        font-weight: bolder;@\\
\mbox{}\verb@        margin-right: 1em;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    diet-plan calorie-balance:before {@\\
\mbox{}\verb@        content: "Calorie balance:";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    diet-plan start-weight:before {@\\
\mbox{}\verb@        content: "Starting weight:";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    diet-plan goal-weight:before {@\\
\mbox{}\verb@        content: "Goal weight:";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    diet-plan start-date:before {@\\
\mbox{}\verb@        content: "Start date:";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    diet-plan show-plan:before {@\\
\mbox{}\verb@        content: "Show plan in charts:";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb536}{536}\NWlink{nuweb537}{, 537}\NWlink{nuweb538a}{, 538a}\NWlink{nuweb538b}{b}\NWlink{nuweb539}{, 539}\NWlink{nuweb540}{, 540}\NWlink{nuweb541}{, 541}\NWlink{nuweb542}{, 542}\NWlink{nuweb543}{, 543}.
\item \NWtxtIdentsUsed\nobreak\  \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@start@\nobreak\ \NWlink{nuweb19b}{19b}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}


\vbox{
\section{Monthly logs}

The monthly logs receive the fanciest formatting---the
equivalent of a table in XHTML, defined entirely in CSS.
We start by generating a header for the logs from the
{\tt monthlogs} container in which they are enclosed.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap723}\raggedright\small
\NWtarget{nuweb541}{} \verb@"hackdiet_db.css"@\nobreak\ {\footnotesize {541}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    monthlogs {@\\
\mbox{}\verb@        display: block;@\\
\mbox{}\verb@        margin-top: 1em;@\\
\mbox{}\verb@        text-align: center;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    monthlogs:before {@\\
\mbox{}\verb@        content: "Monthly Logs";@\\
\mbox{}\verb@        font-family: sans-serif;@\\
\mbox{}\verb@        font-weight: bolder;@\\
\mbox{}\verb@        font-size: large;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb536}{536}\NWlink{nuweb537}{, 537}\NWlink{nuweb538a}{, 538a}\NWlink{nuweb538b}{b}\NWlink{nuweb539}{, 539}\NWlink{nuweb540}{, 540}\NWlink{nuweb541}{, 541}\NWlink{nuweb542}{, 542}\NWlink{nuweb543}{, 543}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
Then, for each individual log we generate a header with a
light grey background with the properties of the log
labeled on separate lines.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap724}\raggedright\small
\NWtarget{nuweb542}{} \verb@"hackdiet_db.css"@\nobreak\ {\footnotesize {542}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    monthlog {@\\
\mbox{}\verb@        display: block;@\\
\mbox{}\verb@        margin-top: 1em;@\\
\mbox{}\verb@        text-align: left;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    monthlog * {@\\
\mbox{}\verb@        display: block;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    monthlog *:before {@\\
\mbox{}\verb@        font-weight: bolder;@\\
\mbox{}\verb@        margin-right: 1em;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    monthlog properties {@\\
\mbox{}\verb@        display: block;@\\
\mbox{}\verb@        background-color: #E0E0E0;@\\
\mbox{}\verb@        width: 75%;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    monthlog year:before {@\\
\mbox{}\verb@        content: "Year:";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    monthlog month:before {@\\
\mbox{}\verb@        content: "Month:";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    monthlog weight-unit:before {@\\
\mbox{}\verb@        content: "Weight unit:";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    monthlog trend-carry-forward:before {@\\
\mbox{}\verb@        content: "Trend carry-forward:";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    monthlog last-modified:before {@\\
\mbox{}\verb@        content: "Last modified:";@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@    monthlog last-modified {@\\
\mbox{}\verb@        margin-bottom: 1ex;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb536}{536}\NWlink{nuweb537}{, 537}\NWlink{nuweb538a}{, 538a}\NWlink{nuweb538b}{b}\NWlink{nuweb539}{, 539}\NWlink{nuweb540}{, 540}\NWlink{nuweb541}{, 541}\NWlink{nuweb542}{, 542}\NWlink{nuweb543}{, 543}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
The entries for days of the month are enclosed in a
{\tt days} container, with each day defined in a
{\tt day} container within it.  We format the items
for each day in columns.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap725}\raggedright\small
\NWtarget{nuweb543}{} \verb@"hackdiet_db.css"@\nobreak\ {\footnotesize {543}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@    monthlog days {@\\
\mbox{}\verb@        display: table;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    monthlog day {@\\
\mbox{}\verb@        display: table-row;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    monthlog day * {@\\
\mbox{}\verb@        display: table-cell;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    monthlog day date {@\\
\mbox{}\verb@        text-align: right;@\\
\mbox{}\verb@        width: 2em;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    monthlog day weight {@\\
\mbox{}\verb@        text-align: right;@\\
\mbox{}\verb@        width: 4em;@\\
\mbox{}\verb@   }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    monthlog day rung {@\\
\mbox{}\verb@        text-align: right;@\\
\mbox{}\verb@        width: 4em;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    monthlog day flag {@\\
\mbox{}\verb@        text-align: right;@\\
\mbox{}\verb@        width: 1em;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@\\
\mbox{}\verb@    monthlog day comment {@\\
\mbox{}\verb@        text-align: left;@\\
\mbox{}\verb@        padding-left: 48px;@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtFileDefBy\ \NWlink{nuweb536}{536}\NWlink{nuweb537}{, 537}\NWlink{nuweb538a}{, 538a}\NWlink{nuweb538b}{b}\NWlink{nuweb539}{, 539}\NWlink{nuweb540}{, 540}\NWlink{nuweb541}{, 541}\NWlink{nuweb542}{, 542}\NWlink{nuweb543}{, 543}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\clearpage
\vbox{
\chapter{{\tt webapp.html}: Main Web Page}

This is the main Web page for The Hacker's Diet Online.  It contains the
user documentation and the initial request form.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap726}\raggedright\small
\NWtarget{nuweb544}{} \verb@"webapp.html"@\nobreak\ {\footnotesize {544}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape HTML header section}\nobreak\ {\footnotesize \NWlink{nuweb545}{545}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@<body bgcolor="#FFFFFF" onload="initialiseDocument();">@\\
\mbox{}\verb@@\\
\mbox{}\verb@&nbsp;<p>@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@<div class="bodycopy">@\\
\mbox{}\verb@@\\
\mbox{}\verb@<p>@\\
\mbox{}\verb@<hr>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<h3><a href="/">Fourmilab Home Page</a></h3>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<address>@\\
\mbox{}\verb@by <a href="/">John Walker</a><br />@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Release Date}\nobreak\ {\footnotesize \NWlink{nuweb3b}{3b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@</address>@\\
\mbox{}\verb@<center>@\\
\mbox{}\verb@<em>This document is in the public domain.</em>@\\
\mbox{}\verb@<br />&nbsp;@\\
\mbox{}\verb@</center>@\\
\mbox{}\verb@@\\
\mbox{}\verb@</div>@\\
\mbox{}\verb@@\\
\mbox{}\verb@</body>@\\
\mbox{}\verb@</html>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtIdentsUsed\nobreak\  \verb@html@\nobreak\ \NWlink{nuweb431}{431}, \verb@in@\nobreak\ \NWlink{nuweb413b}{413b}, \verb@initialiseDocument@\nobreak\ \NWlink{nuweb483a}{483a}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{HTML Header Section}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap727}\raggedright\small
\NWtarget{nuweb545}{} $\langle\,${\itshape HTML header section}\nobreak\ {\footnotesize {545}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">@\\
\mbox{}\verb@<html lang="en">@\\
\mbox{}\verb@<head>@\\
\mbox{}\verb@<title>The Hacker's Diet Online</title>@\\
\mbox{}\verb@<style type="text/css">@\\
\mbox{}\verb@    div.bodycopy {@\\
\mbox{}\verb@        margin-left: 10%;@\\
\mbox{}\verb@        margin-right: 10%@\\
\mbox{}\verb@    }@\\
\mbox{}\verb@</style>@\\
\mbox{}\verb@@\\
\mbox{}\verb@<meta name="keywords" content="hacker, hacker's, diet, online, john, walker" />@\\
\mbox{}\verb@<meta name="description" content="The Hacker's Diet Online" />@\\
\mbox{}\verb@<meta name="author" content="John Walker" />@\\
\mbox{}\verb@<meta name="robots" content="index" />@\\
\mbox{}\verb@@\\
\mbox{}\verb@</head>@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb544}{544}.
\item \NWtxtIdentsUsed\nobreak\  \verb@html@\nobreak\ \NWlink{nuweb431}{431}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

%    __  __       _         __ _ _
%   |  \/  | __ _| | _____ / _(_) | ___
%   | |\/| |/ _` | |/ / _ \ |_| | |/ _ \
%   | |  | | (_| |   <  __/  _| | |  __/
%   |_|  |_|\__,_|_|\_\___|_| |_|_|\___|

\clearpage
\vbox{
\chapter{{\tt Makefile}}

This is the {\tt Makefile} for Hdiet.  Of
course, generating the {\tt Makefile} from the Nuweb invites
infinite regress, since it's the {\tt Makefile} which invokes
{\tt nuweb} to create\ldots.  But as long as we include the
generated {\tt Makefile} in the source distribution, all will
be well, and we do that below, in the definition of the
{\tt Makefile} in the Nuweb.  {\bf Slap!}  Thanks---I needed
that.

Since, in the interest of preserving formatting in the
\LaTeX\ code documentation, we edit this file with hardware
tabs disabled, we must cope with the regrettable detail
that {\tt make} uses tabs as a significant character.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap728}\raggedright\small
\NWtarget{nuweb546}{} \verb@"Makefile.mkf"@\nobreak\ {\footnotesize {546}}$\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@WEBDIR = @\hbox{$\langle\,${\itshape Web Directory}\nobreak\ {\footnotesize \NWlink{nuweb6a}{6a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@CGIDIR = @\hbox{$\langle\,${\itshape CGI Installation Directory}\nobreak\ {\footnotesize \NWlink{nuweb6c}{6c}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@EXEDIR = @\hbox{$\langle\,${\itshape Executable Installation Directory}\nobreak\ {\footnotesize \NWlink{nuweb7b}{7b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@WEBDIR_PRODUCTION = @\hbox{$\langle\,${\itshape Production Web Directory}\nobreak\ {\footnotesize \NWlink{nuweb6b}{6b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@CGIDIR_PRODUCTION = @\hbox{$\langle\,${\itshape Production CGI Installation Directory}\nobreak\ {\footnotesize \NWlink{nuweb6d}{6d}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@EXEDIR_PRODUCTION = @\hbox{$\langle\,${\itshape Production Executable Installation Directory}\nobreak\ {\footnotesize \NWlink{nuweb7c}{7c}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@PROGRAMS = jig.pl bump@\\
\mbox{}\verb@@\\
\mbox{}\verb@PERL = perl -I.@\\
\mbox{}\verb@@\\
\mbox{}\verb@duh:@\\
\mbox{}\verb@        @{\tt @}\verb@echo "Please choose: check dist publish test weblint"@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Extract source code from Nuweb}\nobreak\ {\footnotesize \NWlink{nuweb548}{548}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Source distribution}\nobreak\ {\footnotesize \NWlink{nuweb549}{549}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Fourmilab production version}\nobreak\ {\footnotesize \NWlink{nuweb550}{550}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Documentation}\nobreak\ {\footnotesize \NWlink{nuweb551}{551}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Testing}\nobreak\ {\footnotesize \NWlink{nuweb552a}{552a}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@@\hbox{$\langle\,${\itshape Clean-up}\nobreak\ {\footnotesize \NWlink{nuweb552b}{552b}}$\,\rangle$}\verb@@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Extract source code from Nuweb}

All of the source code for Hdiet, its support files, documentation,
and the tools used to build it are defined in the Nuweb file
{\tt hdiet.w}.  Processing this file with {\tt nuweb} suffices
to extract all the contents, so we can use the Perl source code
{\tt jig.pl} as a proxy for all the files generated from the
Nuweb program.  Any {\tt Makefile} target which requires a file
from the Nuweb can simply specify {\tt jig.pl} as a dependency
and be sure everything is up to date.

One little detail\ldots since the {\tt Makefile} itself is defined
here, when you make a change you must first do something that
processes the Nuweb (``{\tt make~check}'' is a good choice) before
the {\tt Makefile} will contain the changes you made.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap729}\raggedright\small
\NWtarget{nuweb548}{} $\langle\,${\itshape Extract source code from Nuweb}\nobreak\ {\footnotesize {548}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@jig.pl:    hdiet.w@\\
\mbox{}\verb@        @{\tt @}\verb@echo -n 'Build '@\\
\mbox{}\verb@        @{\tt @}\verb@./bump buildno.txt@\\
\mbox{}\verb@        @{\tt @}\verb@date -u '+%F %R %Z' >buildtime.txt@\\
\mbox{}\verb@        nuweb hdiet@\\
\mbox{}\verb@        chmod 755 $(PROGRAMS)@\\
\mbox{}\verb@        unexpand -a <Makefile.mkf >Makefile@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb546}{546}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Source distribution}

Build a source distribution archive for the current version.  The
distribution is built and the archive placed in an {\tt Sdist}
subdirectory which is created from scratch, with any previous
directory deleted.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap730}\raggedright\small
\NWtarget{nuweb549}{} $\langle\,${\itshape Source distribution}\nobreak\ {\footnotesize {549}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@dist:@\\
\mbox{}\verb@        rm -f hdiet.tar hdiet-*.tar.gz@\\
\mbox{}\verb@        tar cfv hdiet.tar hdiet.w Makefile bump HDiet buildno.txt buildtime.txt wz_jsgraphics.js@\\
\mbox{}\verb@        rm -rf Sdist@\\
\mbox{}\verb@        mkdir Sdist@\\
\mbox{}\verb@        ( cd Sdist ; tar xfv ../hdiet.tar )@\\
\mbox{}\verb@        ( cd Sdist ; make clean )@\\
\mbox{}\verb@        ( cd Sdist ; make check )@\\
\mbox{}\verb@        ( cd Sdist ; make pdf )@\\
\mbox{}\verb@        ( cd Sdist ; tar cfvz hdiet-@\hbox{$\langle\,${\itshape Version}\nobreak\ {\footnotesize \NWlink{nuweb3a}{3a}}$\,\rangle$}\verb@.tar.gz hdiet.w jig.pl \@\\
\mbox{}\verb@                HackDiet.pl HackDietBadge.pl Makefile \@\\
\mbox{}\verb@                bump buildno.txt buildtime.txt \@\\
\mbox{}\verb@                webapp.html hdiet.tex hdiet.pdf \@\\
\mbox{}\verb@                HDiet \@\\
\mbox{}\verb@                hdiet.css hdiet_handheld.css hdiet.js wz_jsgraphics.js \@\\
\mbox{}\verb@                hackdiet_db.css hackersdiet.dtd )@\\
\mbox{}\verb@        rm -f hdiet.tar@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb546}{546}.
\item \NWtxtIdentsUsed\nobreak\  \verb@html@\nobreak\ \NWlink{nuweb431}{431}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Fourmilab production version generation}

Build a source distribution archive for the current version.  The
distribution is built and the archive placed in an {\tt Sdist}
subdirectory which is created from scratch, with any previous
directory deleted.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap731}\raggedright\small
\NWtarget{nuweb550}{} $\langle\,${\itshape Fourmilab production version}\nobreak\ {\footnotesize {550}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@fourmilab:@\\
\mbox{}\verb@        rm -f fourmilab.tar fourmilab-*.tar.gz@\\
\mbox{}\verb@        tar cfv fourmilab.tar hdiet.w Makefile bump HDiet buildno.txt buildtime.txt wz_jsgraphics.js@\\
\mbox{}\verb@        rm -rf Fourmilab@\\
\mbox{}\verb@        mkdir Fourmilab@\\
\mbox{}\verb@        ( cd Fourmilab ; tar xfv ../fourmilab.tar )@\\
\mbox{}\verb@        ( cd Fourmilab ; $(PERL) ../Fourmilate.pl hdiet.w >hdiet.w1 ; mv hdiet.w1 hdiet.w )@\\
\mbox{}\verb@        ( cd Fourmilab ; make clean )@\\
\mbox{}\verb@        ( cd Fourmilab ; make check )@\\
\mbox{}\verb@        ( cd Fourmilab ; make pdf )@\\
\mbox{}\verb@        ( cd Fourmilab ; tar cfvz hdiet-@\hbox{$\langle\,${\itshape Version}\nobreak\ {\footnotesize \NWlink{nuweb3a}{3a}}$\,\rangle$}\verb@.tar.gz hdiet.w jig.pl \@\\
\mbox{}\verb@            HackDiet.pl HackDietBadge.pl Makefile \@\\
\mbox{}\verb@            bump buildno.txt buildtime.txt \@\\
\mbox{}\verb@            webapp.html hdiet.tex hdiet.pdf \@\\
\mbox{}\verb@            HDiet \@\\
\mbox{}\verb@            hdiet.css hdiet_handheld.css hdiet.js wz_jsgraphics.js \@\\
\mbox{}\verb@            hackdiet_db.css hackersdiet.dtd )@\\
\mbox{}\verb@        rm -f fourmilab.tar@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb546}{546}.
\item \NWtxtIdentsUsed\nobreak\  \verb@html@\nobreak\ \NWlink{nuweb431}{431}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Documentation}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap732}\raggedright\small
\NWtarget{nuweb551}{} $\langle\,${\itshape Documentation}\nobreak\ {\footnotesize {551}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@@\\
\mbox{}\verb@viewman: jig.pl@\\
\mbox{}\verb@        pod2man hdiet.pl >ZZhdiet.1@\\
\mbox{}\verb@        groff -X -man ZZhdiet.1@\\
\mbox{}\verb@        rm -f ZZhdiet.1@\\
\mbox{}\verb@@\\
\mbox{}\verb@pdf:@\\
\mbox{}\verb@        nuweb -r hdiet@\\
\mbox{}\verb@        xelatex hdiet@\\
\mbox{}\verb@        nuweb -r hdiet@\\
\mbox{}\verb@        xelatex hdiet@\\
\mbox{}\verb@        xelatex hdiet@\\
\mbox{}\verb@@\\
\mbox{}\verb@viewpdf:@\\
\mbox{}\verb@        evince hdiet.pdf@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb546}{546}.

\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Testing}

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap733}\raggedright\small
\NWtarget{nuweb552a}{} $\langle\,${\itshape Testing}\nobreak\ {\footnotesize {552a}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@check:  $(PROGRAMS)@\\
\mbox{}\verb@        $(PERL) -c HackDiet.pl@\\
\mbox{}\verb@        $(PERL) -c HDiet/Aggregator.pm@\\
\mbox{}\verb@        $(PERL) -c HDiet/Cluster.pm@\\
\mbox{}\verb@        $(PERL) -c HDiet/ClusterSync.pl@\\
\mbox{}\verb@        $(PERL) -c HDiet/cookie.pm@\\
\mbox{}\verb@        $(PERL) -c HDiet/hdCSV.pm@\\
\mbox{}\verb@        $(PERL) -c HDiet/history.pm@\\
\mbox{}\verb@        $(PERL) -c HDiet/html.pm@\\
\mbox{}\verb@        $(PERL) -c HDiet/Julian.pm@\\
\mbox{}\verb@        $(PERL) -c HDiet/monthlog.pm@\\
\mbox{}\verb@        $(PERL) -c HDiet/pubname.pm@\\
\mbox{}\verb@        $(PERL) -c HDiet/session.pm@\\
\mbox{}\verb@        $(PERL) -c HDiet/trendfit.pm@\\
\mbox{}\verb@        $(PERL) -c HDiet/user.pm@\\
\mbox{}\verb@        $(PERL) -c HDiet/xml.pm@\\
\mbox{}\verb@        $(PERL) -c HackDietBadge.pl@\\
\mbox{}\verb@        $(PERL) -c jig.pl@\\
\mbox{}\verb@        weblint webapp.html@\\
\mbox{}\verb@@\\
\mbox{}\verb@test:   $(PROGRAMS)@\\
\mbox{}\verb@        $(PERL) jig.pl --verbose --test@\\
\mbox{}\verb@@\\
\mbox{}\verb@weblint:    jig.pl@\\
\mbox{}\verb@        weblint webapp.html@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb546}{546}.
\item \NWtxtIdentsUsed\nobreak\  \verb@html@\nobreak\ \NWlink{nuweb431}{431}, \verb@Julian@\nobreak\ \NWlink{nuweb445}{445}, \verb@verbose@\nobreak\ \NWlink{nuweb71}{71}, \verb@xml@\nobreak\ \NWlink{nuweb440}{440}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\vbox{
\section{Clean-up}

The {\tt clean} target deletes intermediate files but
preserves files which are present in the distribution and
Web page documentation.
The {\tt cvsclean} target deletes everything except for the
Nuweb program definition and the Makefile which permits
building everything which it defines.

\begin{flushleft} \small
\begin{minipage}{\linewidth}\label{scrap734}\raggedright\small
\NWtarget{nuweb552b}{} $\langle\,${\itshape Clean-up}\nobreak\ {\footnotesize {552b}}$\,\rangle\equiv$
\vspace{-1ex}
\begin{list}{}{} \item
\mbox{}\verb@@\\
\mbox{}\verb@clean:@\\
\mbox{}\verb@        rm -f hdiet.dvi hdiet.toc hdiet.aux hdiet.log Makefile.mkf hdiet.pdf HDiet/*.pm jig.pl@\\
\mbox{}\verb@@\\
\mbox{}\verb@cvsclean:  clean@\\
\mbox{}\verb@        rm -f hdiet.pdf jig.pl *.pm hdiet.tex webapp.html@\\
\mbox{}\verb@@{\NWsep}
\end{list}
\vspace{-1.5ex}
\footnotesize
\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \NWtxtMacroRefIn\ \NWlink{nuweb546}{546}.
\item \NWtxtIdentsUsed\nobreak\  \verb@html@\nobreak\ \NWlink{nuweb431}{431}.
\item{}
\end{list}
\end{minipage}\vspace{4ex}
\end{flushleft}
}

\clearpage
\vbox{
\chapter{Indices} \label{indices}

Three indices are created automatically: an index of file
names, an index of macro names, and an index of user-specified
identifiers. An index entry includes the name of the entry, where it
was defined, and where it was referenced.
}

\section{Files}


{\small\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \verb@"bump"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb462}{462}.}
\item \verb@"HackDiet.pl"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb173}{173}.}
\item \verb@"HackDietBadge.pl"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb459}{459}.}
\item \verb@"hackdiet_db.css"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb536}{536}\NWlink{nuweb537}{, 537}\NWlink{nuweb538a}{, 538a}\NWlink{nuweb538b}{b}\NWlink{nuweb539}{, 539}\NWlink{nuweb540}{, 540}\NWlink{nuweb541}{, 541}\NWlink{nuweb542}{, 542}\NWlink{nuweb543}{, 543}.
}
\item \verb@"hackersdiet.dtd"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb530}{530}\NWlink{nuweb532}{, 532}\NWlink{nuweb533}{, 533}\NWlink{nuweb534}{, 534}\NWlink{nuweb535}{, 535}.
}
\item \verb@"hdiet.css"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb463}{463}\NWlink{nuweb464}{, 464}\NWlink{nuweb465}{, 465}\NWlink{nuweb466}{, 466}\NWlink{nuweb467a}{, 467a}\NWlink{nuweb467b}{b}\NWlink{nuweb468}{, 468}\NWlink{nuweb469}{, 469}\NWlink{nuweb470a}{, 470a}\NWlink{nuweb470b}{b}\NWlink{nuweb471a}{, 471a}\NWlink{nuweb471b}{b}\NWlink{nuweb472}{, 472}.
}
\item \verb@"hdiet.js"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb481}{481}\NWlink{nuweb482}{, 482}\NWlink{nuweb483a}{, 483a}\NWlink{nuweb483b}{b}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb484b}{b}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb487b}{b}\NWlink{nuweb488a}{, 488a}\NWlink{nuweb488b}{b}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb508}{, 508}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb514b}{b}\NWlink{nuweb515}{, 515}\NWlink{nuweb516a}{, 516a}\NWlink{nuweb516b}{b}\NWlink{nuweb517}{, 517}\NWlink{nuweb518}{, 518}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb528}{, 528}\NWlink{nuweb529a}{, 529a}\NWlink{nuweb529b}{b}.
}
\item \verb@"HDiet/Aggregator.pm"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb114}{114}\NWlink{nuweb115}{, 115}\NWlink{nuweb116}{, 116}.
}
\item \verb@"HDiet/Cluster.pm"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb415}{415}\NWlink{nuweb416}{, 416}\NWlink{nuweb418}{, 418}\NWlink{nuweb419a}{, 419a}\NWlink{nuweb419b}{b}\NWlink{nuweb419c}{c}\NWlink{nuweb420a}{, 420a}\NWlink{nuweb420b}{b}.
}
\item \verb@"HDiet/ClusterSync.pl"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb421a}{421a}\NWlink{nuweb428}{, 428}\NWlink{nuweb429b}{, 429b}\NWlink{nuweb430a}{, 430a}\NWlink{nuweb430b}{b}.
}
\item \verb@"HDiet/cookie.pm"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb154}{154}\NWlink{nuweb155}{, 155}\NWlink{nuweb156a}{, 156a}\NWlink{nuweb156b}{b}\NWlink{nuweb157a}{, 157a}\NWlink{nuweb157c}{c}\NWlink{nuweb158a}{, 158a}\NWlink{nuweb158b}{b}\NWlink{nuweb159}{, 159}\NWlink{nuweb160}{, 160}\NWlink{nuweb161}{, 161}\NWlink{nuweb162}{, 162}.
}
\item \verb@"HDiet/hdCSV.pm"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb15}{15}\NWlink{nuweb16}{, 16}\NWlink{nuweb17}{, 17}.
}
\item \verb@"HDiet/history.pm"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb75}{75}\NWlink{nuweb76}{, 76}\NWlink{nuweb77}{, 77}\NWlink{nuweb78}{, 78}\NWlink{nuweb79}{, 79}\NWlink{nuweb82}{, 82}\NWlink{nuweb83}{, 83}\NWlink{nuweb101a}{, 101a}\NWlink{nuweb101b}{b}\NWlink{nuweb102a}{, 102a}\NWlink{nuweb102b}{b}\NWlink{nuweb103a}{, 103a}\NWlink{nuweb103b}{b}\NWlink{nuweb104}{, 104}\NWlink{nuweb105}{, 105}\NWlink{nuweb108}{, 108}\NWlink{nuweb109a}{, 109a}\NWlink{nuweb111}{, 111}.
}
\item \verb@"HDiet/html.pm"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb431}{431}.}
\item \verb@"HDiet/Julian.pm"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb445}{445}.}
\item \verb@"HDiet/monthlog.pm"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb23}{23}\NWlink{nuweb25}{, 25}\NWlink{nuweb26}{, 26}\NWlink{nuweb27}{, 27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb36}{, 36}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb41b}{b}\NWlink{nuweb42a}{, 42a}\NWlink{nuweb42b}{b}\NWlink{nuweb43a}{, 43a}\NWlink{nuweb43b}{b}\NWlink{nuweb43c}{c}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb44b}{b}\NWlink{nuweb45}{, 45}\NWlink{nuweb46}{, 46}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb69}{, 69}\NWlink{nuweb70}{, 70}\NWlink{nuweb71}{, 71}\NWlink{nuweb72}{, 72}\NWlink{nuweb73}{, 73}.
}
\item \verb@"HDiet/pubname.pm"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb163}{163}\NWlink{nuweb164}{, 164}\NWlink{nuweb165}{, 165}\NWlink{nuweb166}{, 166}\NWlink{nuweb167}{, 167}\NWlink{nuweb168}{, 168}\NWlink{nuweb169a}{, 169a}\NWlink{nuweb170a}{, 170a}\NWlink{nuweb170b}{b}\NWlink{nuweb171a}{, 171a}.
}
\item \verb@"HDiet/session.pm"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb148}{148}\NWlink{nuweb149}{, 149}\NWlink{nuweb150}{, 150}\NWlink{nuweb151}{, 151}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb152c}{c}\NWlink{nuweb153a}{, 153a}\NWlink{nuweb153b}{b}.
}
\item \verb@"HDiet/trendfit.pm"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb18}{18}\NWlink{nuweb19a}{, 19a}\NWlink{nuweb19b}{b}\NWlink{nuweb20a}{, 20a}\NWlink{nuweb20b}{b}\NWlink{nuweb21}{, 21}.
}
\item \verb@"HDiet/user.pm"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb118}{118}\NWlink{nuweb120}{, 120}\NWlink{nuweb121}{, 121}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb125}{, 125}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb135a}{, 135a}\NWlink{nuweb135b}{b}\NWlink{nuweb136}{, 136}\NWlink{nuweb137}{, 137}\NWlink{nuweb138}{, 138}\NWlink{nuweb139}{, 139}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb142}{, 142}\NWlink{nuweb143}{, 143}\NWlink{nuweb145}{, 145}\NWlink{nuweb146a}{, 146a}\NWlink{nuweb146b}{b}\NWlink{nuweb147}{, 147}.
}
\item \verb@"HDiet/xml.pm"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb440}{440}\NWlink{nuweb441a}{, 441a}\NWlink{nuweb441b}{b}\NWlink{nuweb442a}{, 442a}\NWlink{nuweb442b}{b}\NWlink{nuweb443}{, 443}.
}
\item \verb@"hdiet_handheld.css"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb480}{480}.}
\item \verb@"jig.pl"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb461}{461}.}
\item \verb@"Makefile.mkf"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb546}{546}.}
\item \verb@"webapp.html"@ {\footnotesize {\NWtxtDefBy} \NWlink{nuweb544}{544}.}
\end{list}}

\section{Macros}


{\small\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item $\langle\,$Account management transactions\nobreak\ {\footnotesize \NWlink{nuweb180b}{180b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$Activate cluster synchronisation log file if configured\nobreak\ {\footnotesize \NWlink{nuweb423a}{423a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb421a}{421a}.}
\item $\langle\,$Ad hoc tests for bad passwords\nobreak\ {\footnotesize \NWlink{nuweb526}{526}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb525}{525}.}
\item $\langle\,$Add login to history database\nobreak\ {\footnotesize \NWlink{nuweb188b}{188b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb183}{183}.}
\item $\langle\,$Add standard intervals to analysis list\nobreak\ {\footnotesize \NWlink{nuweb265b}{265b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb265a}{265a}.}
\item $\langle\,$Address for feedback E-mail\nobreak\ {\footnotesize \NWlink{nuweb11f}{11f}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb371}{371}.}
\item $\langle\,$Administrator object dump selection\nobreak\ {\footnotesize \NWlink{nuweb217}{217}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb216}{216}.}
\item $\langle\,$Administrator-only functions\nobreak\ {\footnotesize \NWlink{nuweb194}{194}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb190}{190}.}
\item $\langle\,$Allocate colours for chart\nobreak\ {\footnotesize \NWlink{nuweb47}{47}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb46}{46}\NWlink{nuweb82}{, 82}\NWlink{nuweb101b}{, 101b}.
}
\item $\langle\,$Append entry to transaction history log\nobreak\ {\footnotesize \NWlink{nuweb397}{397}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb391}{391}.}
\item $\langle\,$Append summary of records imported\nobreak\ {\footnotesize \NWlink{nuweb240b}{240b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb228b}{228b}.}
\item $\langle\,$Application documentation URL\nobreak\ {\footnotesize \NWlink{nuweb14a}{14a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb434}{434}.}
\item $\langle\,$Apply changes to comment\nobreak\ {\footnotesize \NWlink{nuweb62}{62}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb56}{56}.}
\item $\langle\,$Apply changes to exercise rung\nobreak\ {\footnotesize \NWlink{nuweb60}{60}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb56}{56}.}
\item $\langle\,$Apply changes to flag\nobreak\ {\footnotesize \NWlink{nuweb61}{61}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb56}{56}.}
\item $\langle\,$Apply changes to weight\nobreak\ {\footnotesize \NWlink{nuweb57}{57}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb56}{56}.}
\item $\langle\,$Apply perturbation functions to value\nobreak\ {\footnotesize \NWlink{nuweb107}{107}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb105}{105}.}
\item $\langle\,$Assume group and user identity of cluster synchronisation process\nobreak\ {\footnotesize \NWlink{nuweb422a}{422a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb421a}{421a}.}
\item $\langle\,$Backup user account before destructive operation\nobreak\ {\footnotesize \NWlink{nuweb379a}{379a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb333}{333}\NWlink{nuweb335}{, 335}\NWlink{nuweb377}{, 377}\NWlink{nuweb382}{, 382}.
}
\item $\langle\,$Backups Directory\nobreak\ {\footnotesize \NWlink{nuweb8b}{8b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb379a}{379a}.}
\item $\langle\,$Beta test\nobreak\ {\footnotesize \NWlink{nuweb4a}{4a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb126}{126}\NWlink{nuweb127}{, 127}\NWlink{nuweb181}{, 181}\NWlink{nuweb190}{, 190}\NWlink{nuweb194}{, 194}\NWlink{nuweb195}{, 195}\NWlink{nuweb306b}{, 306b}\NWlink{nuweb307a}{, 307a}\NWlink{nuweb322}{, 322}\NWlink{nuweb323}{, 323}.
}
\item $\langle\,$Beta test backdoor\nobreak\ {\footnotesize \NWlink{nuweb4b}{4b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb306b}{306b}.}
\item $\langle\,$Beta test invitation field\nobreak\ {\footnotesize \NWlink{nuweb129b}{129b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb127}{127}.}
\item $\langle\,$Beta Test Invitations Directory\nobreak\ {\footnotesize \NWlink{nuweb8a}{8a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb306b}{306b}\NWlink{nuweb307a}{, 307a}\NWlink{nuweb324}{, 324}.
}
\item $\langle\,$Book Directory\nobreak\ {\footnotesize \NWlink{nuweb5e}{5e}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb6a}{6a}\NWlink{nuweb6c}{c}\NWlink{nuweb7b}{, 7b}.
}
\item $\langle\,$Book home URL\nobreak\ {\footnotesize \NWlink{nuweb13f}{13f}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb14a}{14a}\NWlink{nuweb434}{, 434}\NWlink{nuweb455}{, 455}.
}
\item $\langle\,$Browsing public account functions\nobreak\ {\footnotesize \NWlink{nuweb193}{193}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb190}{190}.}
\item $\langle\,$Build Number\nobreak\ {\footnotesize \NWlink{nuweb3c}{3c}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb195}{195}\NWlink{nuweb371}{, 371}.
}
\item $\langle\,$Build table of intervals and compute date span of union\nobreak\ {\footnotesize \NWlink{nuweb80}{80}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb79}{79}.}
\item $\langle\,$Build Time\nobreak\ {\footnotesize \NWlink{nuweb3d}{3d}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb195}{195}\NWlink{nuweb371}{, 371}.
}
\item $\langle\,$Calculate dependent variables from primary variables\nobreak\ {\footnotesize \NWlink{nuweb284}{284}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb274}{274}\NWlink{nuweb286}{, 286}.
}
\item $\langle\,$Calendar Navigation Tables\nobreak\ {\footnotesize \NWlink{nuweb477}{477}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb472}{472}.}
\item $\langle\,$Cancel used beta test invitation code\nobreak\ {\footnotesize \NWlink{nuweb307a}{307a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb305}{305}.}
\item $\langle\,$Categories of feedback messages\nobreak\ {\footnotesize \NWlink{nuweb12a}{12a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb388b}{388b}.}
\item $\langle\,$CGI Execution Directory\nobreak\ {\footnotesize \NWlink{nuweb6e}{6e}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb6f}{6f}.}
\item $\langle\,$CGI Installation Directory\nobreak\ {\footnotesize \NWlink{nuweb6c}{6c}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb546}{546}.}
\item $\langle\,$CGI Support Directory\nobreak\ {\footnotesize \NWlink{nuweb6f}{6f}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb6g}{6g}\NWlink{nuweb7a}{, 7a}\NWlink{nuweb387a}{, 387a}.
}
\item $\langle\,$Character frequency table\nobreak\ {\footnotesize \NWlink{nuweb527}{527}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb525}{525}.}
\item $\langle\,$Characters Permissible in File Names\nobreak\ {\footnotesize \NWlink{nuweb10d}{10d}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb145}{145}.}
\item $\langle\,$Check for errors we deem harmless to cluster synchronisation\nobreak\ {\footnotesize \NWlink{nuweb429a}{429a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb428}{428}.}
\item $\langle\,$Check for Excel CSV record\nobreak\ {\footnotesize \NWlink{nuweb234}{234}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb233}{233}.}
\item $\langle\,$Check for implausibly large change in weight\nobreak\ {\footnotesize \NWlink{nuweb493b}{493b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb493a}{493a}.}
\item $\langle\,$Check for Palm/HDREAD CSV record\nobreak\ {\footnotesize \NWlink{nuweb238}{238}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb233}{233}.}
\item $\langle\,$Check spelling in subject and message\nobreak\ {\footnotesize \NWlink{nuweb368}{368}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb367}{367}.}
\item $\langle\,$Civil time to Julian day fraction\nobreak\ {\footnotesize \NWlink{nuweb449b}{449b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb445}{445}.}
\item $\langle\,$Clean-up\nobreak\ {\footnotesize \NWlink{nuweb552b}{552b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb546}{546}.}
\item $\langle\,$Close previous session if still open\nobreak\ {\footnotesize \NWlink{nuweb186c}{186c}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb183}{183}\NWlink{nuweb199}{, 199}\NWlink{nuweb339}{, 339}.
}
\item $\langle\,$Close this user account\nobreak\ {\footnotesize \NWlink{nuweb380}{380}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb180a}{180a}.}
\item $\langle\,$Cluster Failed Transaction Maximum Retries\nobreak\ {\footnotesize \NWlink{nuweb9d}{9d}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb426}{426}.}
\item $\langle\,$Cluster Failed Transaction Retry Interval\nobreak\ {\footnotesize \NWlink{nuweb9c}{9c}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb426}{426}.}
\item $\langle\,$Cluster Member Hosts\nobreak\ {\footnotesize \NWlink{nuweb8f}{8f}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb415}{415}\NWlink{nuweb421a}{, 421a}.
}
\item $\langle\,$Cluster Synchronisation Group ID\nobreak\ {\footnotesize \NWlink{nuweb10c}{10c}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb422a}{422a}.}
\item $\langle\,$Cluster Synchronisation Log File\nobreak\ {\footnotesize \NWlink{nuweb10a}{10a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb423a}{423a}\NWlink{nuweb423b}{b}.
}
\item $\langle\,$Cluster Synchronisation Process ID File\nobreak\ {\footnotesize \NWlink{nuweb9f}{9f}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb418}{418}\NWlink{nuweb421a}{, 421a}\NWlink{nuweb422b}{, 422b}.
}
\item $\langle\,$Cluster Synchronisation Signal\nobreak\ {\footnotesize \NWlink{nuweb9e}{9e}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb418}{418}\NWlink{nuweb421a}{, 421a}.
}
\item $\langle\,$Cluster Synchronisation Time Interval\nobreak\ {\footnotesize \NWlink{nuweb9a}{9a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb421a}{421a}.}
\item $\langle\,$Cluster Synchronisation User ID\nobreak\ {\footnotesize \NWlink{nuweb10b}{10b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb422a}{422a}.}
\item $\langle\,$Cluster Transaction Directory\nobreak\ {\footnotesize \NWlink{nuweb8c}{8c}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb416}{416}\NWlink{nuweb417}{, 417}\NWlink{nuweb418}{, 418}\NWlink{nuweb424}{, 424}.
}
\item $\langle\,$Cluster Transaction Retry Time Interval\nobreak\ {\footnotesize \NWlink{nuweb9b}{9b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb428}{428}.}
\item $\langle\,$Command to check spelling\nobreak\ {\footnotesize \NWlink{nuweb12b}{12b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb368}{368}.}
\item $\langle\,$Compute diet plan extrema on chart\nobreak\ {\footnotesize \NWlink{nuweb52}{52}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb50}{50}.}
\item $\langle\,$Compute global statistics gain and loss extrema\nobreak\ {\footnotesize \NWlink{nuweb352}{352}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb348}{348}.}
\item $\langle\,$Compute global statistics trend analysis for previous user\nobreak\ {\footnotesize \NWlink{nuweb357}{357}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb355}{355}.}
\item $\langle\,$Configure Web page status badge\nobreak\ {\footnotesize \NWlink{nuweb241}{241}\NWlink{nuweb242}{, 242}\NWlink{nuweb243}{, 243}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$Confirm a persistent login is selected\nobreak\ {\footnotesize \NWlink{nuweb347}{347}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb346}{346}.}
\item $\langle\,$Confirm a session is selected\nobreak\ {\footnotesize \NWlink{nuweb341}{341}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb339}{339}.}
\item $\langle\,$Confirmation signature encoding suffix\nobreak\ {\footnotesize \NWlink{nuweb4d}{4d}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb157c}{157c}\NWlink{nuweb161}{, 161}\NWlink{nuweb376}{, 376}\NWlink{nuweb377}{, 377}\NWlink{nuweb382}{, 382}\NWlink{nuweb418}{, 418}\NWlink{nuweb425}{, 425}.
}
\item $\langle\,$Constants and conversion tables\nobreak\ {\footnotesize \NWlink{nuweb24}{24}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb23}{23}.}
\item $\langle\,$Convert characters in a string to hexadecimal\nobreak\ {\footnotesize \NWlink{nuweb407}{407}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb391}{391}.}
\item $\langle\,$Convert trend to weight unit in this log, if different\nobreak\ {\footnotesize \NWlink{nuweb395a}{395a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb394}{394}.}
\item $\langle\,$Cookie name\nobreak\ {\footnotesize \NWlink{nuweb12d}{12d}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb159}{159}\NWlink{nuweb182}{, 182}\NWlink{nuweb189}{, 189}.
}
\item $\langle\,$Create new month for synthetic data\nobreak\ {\footnotesize \NWlink{nuweb106}{106}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb105}{105}.}
\item $\langle\,$Create new user account request\nobreak\ {\footnotesize \NWlink{nuweb304a}{304a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb183}{183}.}
\item $\langle\,$Create the new user account\nobreak\ {\footnotesize \NWlink{nuweb307b}{307b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb305}{305}.}
\item $\langle\,$CSV direct upload import form\nobreak\ {\footnotesize \NWlink{nuweb226a}{226a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb224}{224}.}
\item $\langle\,$CSV file upload import form\nobreak\ {\footnotesize \NWlink{nuweb225}{225}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb224}{224}.}
\item $\langle\,$CSV Format version\nobreak\ {\footnotesize \NWlink{nuweb4c}{4c}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb64}{64}.}
\item $\langle\,$Custom start and end date selection boxes\nobreak\ {\footnotesize \NWlink{nuweb271a}{271a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb270}{270}\NWlink{nuweb296}{, 296}.
}
\item $\langle\,$Custom trend end date\nobreak\ {\footnotesize \NWlink{nuweb273}{273}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb251a}{251a}\NWlink{nuweb259a}{, 259a}\NWlink{nuweb271a}{, 271a}\NWlink{nuweb282a}{, 282a}.
}
\item $\langle\,$Custom trend start date\nobreak\ {\footnotesize \NWlink{nuweb272}{272}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb251a}{251a}\NWlink{nuweb259a}{, 259a}\NWlink{nuweb271a}{, 271a}\NWlink{nuweb282a}{, 282a}.
}
\item $\langle\,$Cycle active log file if HUP signal received\nobreak\ {\footnotesize \NWlink{nuweb423b}{423b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb421a}{421a}.}
\item $\langle\,$Database Directory\nobreak\ {\footnotesize \NWlink{nuweb7d}{7d}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb7e}{7e}\NWlink{nuweb7f}{f}\NWlink{nuweb7g}{g}\NWlink{nuweb8a}{, 8a}\NWlink{nuweb8b}{b}\NWlink{nuweb8c}{c}\NWlink{nuweb13d}{, 13d}\NWlink{nuweb173}{, 173}\NWlink{nuweb425}{, 425}.
}
\item $\langle\,$Decimal character selection\nobreak\ {\footnotesize \NWlink{nuweb134a}{134a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb127}{127}.}
\item $\langle\,$Decode encrypted user ID\nobreak\ {\footnotesize \NWlink{nuweb144}{144}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb459}{459}\NWlink{nuweb461}{, 461}.
}
\item $\langle\,$Default cookie retention time\nobreak\ {\footnotesize \NWlink{nuweb12e}{12e}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb155}{155}.}
\item $\langle\,$Default parameter settings\nobreak\ {\footnotesize \NWlink{nuweb388a}{388a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb387a}{387a}.}
\item $\langle\,$Define chart geometry\nobreak\ {\footnotesize \NWlink{nuweb48a}{48a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb45}{45}\NWlink{nuweb46}{, 46}.
}
\item $\langle\,$Define historical chart geometry\nobreak\ {\footnotesize \NWlink{nuweb87b}{87b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb82}{82}.}
\item $\langle\,$Define requests permissible whilst browsing public account\nobreak\ {\footnotesize \NWlink{nuweb174b}{174b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb173}{173}.}
\item $\langle\,$Define ``cachebuster'' argument\nobreak\ {\footnotesize \NWlink{nuweb212b}{212b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb212a}{212a}\NWlink{nuweb297}{, 297}.
}
\item $\langle\,$Delete a persistent login token\nobreak\ {\footnotesize \NWlink{nuweb346}{346}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb181}{181}.}
\item $\langle\,$Delete entire log database\nobreak\ {\footnotesize \NWlink{nuweb374}{374}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb180a}{180a}.}
\item $\langle\,$Delete existing public name\nobreak\ {\footnotesize \NWlink{nuweb169b}{169b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb167}{167}\NWlink{nuweb169a}{, 169a}.
}
\item $\langle\,$Determine first and last days in database\nobreak\ {\footnotesize \NWlink{nuweb253}{253}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb252}{252}\NWlink{nuweb265a}{, 265a}\NWlink{nuweb295}{, 295}.
}
\item $\langle\,$Determine if failed transaction should be retried\nobreak\ {\footnotesize \NWlink{nuweb427}{427}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb424}{424}.}
\item $\langle\,$Determine range of dates to plot in historical chart\nobreak\ {\footnotesize \NWlink{nuweb298}{298}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb297}{297}.}
\item $\langle\,$Determine scale for weight and trend plot\nobreak\ {\footnotesize \NWlink{nuweb50}{50}\NWlink{nuweb51}{, 51}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb45}{45}\NWlink{nuweb46}{, 46}.
}
\item $\langle\,$Determine the number of days in the historical interval\nobreak\ {\footnotesize \NWlink{nuweb84}{84}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb79}{79}\NWlink{nuweb82}{, 82}\NWlink{nuweb105}{, 105}.
}
\item $\langle\,$Determine vertical weight scaling based on extrema\nobreak\ {\footnotesize \NWlink{nuweb88a}{88a}\NWlink{nuweb88b}{b}\NWlink{nuweb89a}{, 89a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb82}{82}.}
\item $\langle\,$Determine which monthly log to display\nobreak\ {\footnotesize \NWlink{nuweb209}{209}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb208}{208}.}
\item $\langle\,$Diet calculator\nobreak\ {\footnotesize \NWlink{nuweb274}{274}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$Diet calculator form action buttons\nobreak\ {\footnotesize \NWlink{nuweb283}{283}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb274}{274}.}
\item $\langle\,$Dispatch administrator requests\nobreak\ {\footnotesize \NWlink{nuweb181}{181}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$Dispatch requests which return HTML result documents\nobreak\ {\footnotesize \NWlink{nuweb179}{179}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb173}{173}.}
\item $\langle\,$Dispatch requests which return non-HTML results\nobreak\ {\footnotesize \NWlink{nuweb178}{178}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb173}{173}.}
\item $\langle\,$Display administrator account manager\nobreak\ {\footnotesize \NWlink{nuweb325}{325}\NWlink{nuweb326}{, 326}\NWlink{nuweb327}{, 327}\NWlink{nuweb328}{, 328}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb181}{181}.}
\item $\langle\,$Display administrator global statistics\nobreak\ {\footnotesize \NWlink{nuweb348}{348}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb181}{181}.}
\item $\langle\,$Display administrator persistent login manager\nobreak\ {\footnotesize \NWlink{nuweb343}{343}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb181}{181}.}
\item $\langle\,$Display administrator session manager\nobreak\ {\footnotesize \NWlink{nuweb336}{336}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb181}{181}.}
\item $\langle\,$Display calendar navigation page\nobreak\ {\footnotesize \NWlink{nuweb221}{221}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$Display CSV import request form\nobreak\ {\footnotesize \NWlink{nuweb224}{224}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$Display global statistics gain and loss extrema\nobreak\ {\footnotesize \NWlink{nuweb353}{353}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb348}{348}.}
\item $\langle\,$Display global statistics log update frequency\nobreak\ {\footnotesize \NWlink{nuweb354}{354}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb348}{348}.}
\item $\langle\,$Display global statistics mean trend change\nobreak\ {\footnotesize \NWlink{nuweb351}{351}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb348}{348}.}
\item $\langle\,$Display monthly log\nobreak\ {\footnotesize \NWlink{nuweb208}{208}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$Display password reset request form\nobreak\ {\footnotesize \NWlink{nuweb198}{198}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb180b}{180b}.}
\item $\langle\,$Display summary of cluster transaction queue\nobreak\ {\footnotesize \NWlink{nuweb417}{417}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb416}{416}.}
\item $\langle\,$Display trend summary below monthly chart\nobreak\ {\footnotesize \NWlink{nuweb215}{215}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb208}{208}.}
\item $\langle\,$Documentation\nobreak\ {\footnotesize \NWlink{nuweb551}{551}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb546}{546}.}
\item $\langle\,$Documentation in POD format\nobreak\ {\footnotesize \NWlink{nuweb455}{455}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb173}{173}.}
\item $\langle\,$Domain for cookies\nobreak\ {\footnotesize \NWlink{nuweb13a}{13a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb158a}{158a}\NWlink{nuweb158b}{b}.
}
\item $\langle\,$Download backup copy of all logs for user\nobreak\ {\footnotesize \NWlink{nuweb262}{262}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb178}{178}.}
\item $\langle\,$Download monthly log as CSV file\nobreak\ {\footnotesize \NWlink{nuweb248b}{248b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb178}{178}.}
\item $\langle\,$Download monthly log as XML file\nobreak\ {\footnotesize \NWlink{nuweb249}{249}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb178}{178}.}
\item $\langle\,$Draw axes for chart and label date axis\nobreak\ {\footnotesize \NWlink{nuweb48b}{48b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb46}{46}.}
\item $\langle\,$Draw axes for historical chart\nobreak\ {\footnotesize \NWlink{nuweb89b}{89b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb82}{82}.}
\item $\langle\,$Draw caption with trend summary\nobreak\ {\footnotesize \NWlink{nuweb100}{100}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb95}{95}.}
\item $\langle\,$Draw text in a chart\nobreak\ {\footnotesize \NWlink{nuweb409}{409}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb391}{391}.}
\item $\langle\,$Draw title with date range\nobreak\ {\footnotesize \NWlink{nuweb99}{99}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb95}{95}.}
\item $\langle\,$Dump CGI environment and parsed arguments\nobreak\ {\footnotesize \NWlink{nuweb385b}{385b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb385a}{385a}.}
\item $\langle\,$Dump objects if requested by administrator\nobreak\ {\footnotesize \NWlink{nuweb218}{218}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb208}{208}.}
\item $\langle\,$Dump XML database file\nobreak\ {\footnotesize \NWlink{nuweb232}{232}}$\,\rangle$ {\footnotesize {\NWtxtNoRef}.}
\item $\langle\,$E-mail address text field\nobreak\ {\footnotesize \NWlink{nuweb131a}{131a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb127}{127}.}
\item $\langle\,$Edit Unix time value to ISO 8601 local date and time\nobreak\ {\footnotesize \NWlink{nuweb406b}{406b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb391}{391}.}
\item $\langle\,$Embed historical chart image in request/result page\nobreak\ {\footnotesize \NWlink{nuweb297}{297}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb295}{295}.}
\item $\langle\,$Emit diagnostic for undefined query\nobreak\ {\footnotesize \NWlink{nuweb385a}{385a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$Emit historical chart request form\nobreak\ {\footnotesize \NWlink{nuweb295}{295}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb294}{294}.}
\item $\langle\,$Emit shrill warning about what is about to transpire\nobreak\ {\footnotesize \NWlink{nuweb375a}{375a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb374}{374}.}
\item $\langle\,$Emit trend anlysis page\nobreak\ {\footnotesize \NWlink{nuweb265a}{265a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb264}{264}.}
\item $\langle\,$Empty monthly log cache\nobreak\ {\footnotesize \NWlink{nuweb113b}{113b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb82}{82}.}
\item $\langle\,$Encode international domain name\nobreak\ {\footnotesize \NWlink{nuweb410}{410}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb391}{391}.}
\item $\langle\,$Encode preset values for use in HTML\nobreak\ {\footnotesize \NWlink{nuweb128}{128}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb127}{127}.}
\item $\langle\,$Encoding for Space in File Name Characters\nobreak\ {\footnotesize \NWlink{nuweb10e}{10e}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb145}{145}.}
\item $\langle\,$Ensure month is in cache\nobreak\ {\footnotesize \NWlink{nuweb110}{110}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb108}{108}\NWlink{nuweb109a}{, 109a}.
}
\item $\langle\,$Enumerate feedback message categories\nobreak\ {\footnotesize \NWlink{nuweb369}{369}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb366}{366}.}
\item $\langle\,$Estimate local time at user site\nobreak\ {\footnotesize \NWlink{nuweb177}{177}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb173}{173}.}
\item $\langle\,$Examine dates, fitting those within intervals\nobreak\ {\footnotesize \NWlink{nuweb81}{81}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb79}{79}.}
\item $\langle\,$Executable Installation Directory\nobreak\ {\footnotesize \NWlink{nuweb7b}{7b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb546}{546}.}
\item $\langle\,$Execute cluster synchronisation transaction\nobreak\ {\footnotesize \NWlink{nuweb425}{425}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb424}{424}.}
\item $\langle\,$Execute system command\nobreak\ {\footnotesize \NWlink{nuweb406a}{406a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb391}{391}.}
\item $\langle\,$Expand abbreviated stones and pounds entry\nobreak\ {\footnotesize \NWlink{nuweb489}{489}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb488b}{488b}.}
\item $\langle\,$Expand weight entry if abbreviated\nobreak\ {\footnotesize \NWlink{nuweb58}{58}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb57}{57}.}
\item $\langle\,$Expand weight entry in stones and pounds\nobreak\ {\footnotesize \NWlink{nuweb59}{59}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb58}{58}.}
\item $\langle\,$Export database as Hacker's Diet Online CSV\nobreak\ {\footnotesize \NWlink{nuweb255}{255}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb252}{252}.}
\item $\langle\,$Export database as Legacy Excel Eat Watch CSV\nobreak\ {\footnotesize \NWlink{nuweb257}{257}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb252}{252}.}
\item $\langle\,$Export database as Palm Eat Watch CSV\nobreak\ {\footnotesize \NWlink{nuweb256}{256}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb252}{252}.}
\item $\langle\,$Export database as XML\nobreak\ {\footnotesize \NWlink{nuweb254}{254}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb252}{252}.}
\item $\langle\,$Export log database\nobreak\ {\footnotesize \NWlink{nuweb250}{250}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$Extract brain-dead Internet Exploder request field\nobreak\ {\footnotesize \NWlink{nuweb176}{176}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb173}{173}.}
\item $\langle\,$Extract scaling information for chart\nobreak\ {\footnotesize \NWlink{nuweb496}{496}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb495}{495}\NWlink{nuweb503}{, 503}.
}
\item $\langle\,$Extract source code from Nuweb\nobreak\ {\footnotesize \NWlink{nuweb548}{548}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb546}{546}.}
\item $\langle\,$Feedback message table\nobreak\ {\footnotesize \NWlink{nuweb478b}{478b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb472}{472}.}
\item $\langle\,$Fill cache with monthly logs in the date range\nobreak\ {\footnotesize \NWlink{nuweb112}{112}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb79}{79}\NWlink{nuweb105}{, 105}.
}
\item $\langle\,$Fill in trend carry-forward from most recent previous log, if required\nobreak\ {\footnotesize \NWlink{nuweb214}{214}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb210}{210}.}
\item $\langle\,$Find diet plan extrema on historical chart\nobreak\ {\footnotesize \NWlink{nuweb86}{86}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb82}{82}.}
\item $\langle\,$Find most recent trend value before this day\nobreak\ {\footnotesize \NWlink{nuweb497}{497}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb493a}{493a}.}
\item $\langle\,$Find weight and trend extrema in log entries to be plotted\nobreak\ {\footnotesize \NWlink{nuweb85}{85}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb82}{82}.}
\item $\langle\,$Fit a linear trend and update weight and energy balance\nobreak\ {\footnotesize \NWlink{nuweb500}{500}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb493a}{493a}.}
\item $\langle\,$Force re-login if session terminated or invalid\nobreak\ {\footnotesize \NWlink{nuweb197}{197}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb180a}{180a}.}
\item $\langle\,$Force termination of user session\nobreak\ {\footnotesize \NWlink{nuweb339}{339}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb181}{181}.}
\item $\langle\,$Forget all persistent logins\nobreak\ {\footnotesize \NWlink{nuweb316}{316}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb180b}{180b}.}
\item $\langle\,$Form processing action and method\nobreak\ {\footnotesize \NWlink{nuweb14c}{14c}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb125}{125}\NWlink{nuweb192}{, 192}\NWlink{nuweb193}{, 193}\NWlink{nuweb194}{, 194}\NWlink{nuweb196}{, 196}\NWlink{nuweb198}{, 198}\NWlink{nuweb203}{, 203}\NWlink{nuweb208}{, 208}\NWlink{nuweb223}{, 223}\NWlink{nuweb227}{, 227}\NWlink{nuweb241}{, 241}\NWlink{nuweb250}{, 250}\NWlink{nuweb258}{, 258}\NWlink{nuweb270}{, 270}\NWlink{nuweb274}{, 274}\NWlink{nuweb295}{, 295}\NWlink{nuweb304a}{, 304a}\NWlink{nuweb310}{, 310}\NWlink{nuweb311}{, 311}\NWlink{nuweb315}{, 315}\NWlink{nuweb317}{, 317}\NWlink{nuweb322}{, 322}\NWlink{nuweb323}{, 323}\NWlink{nuweb325}{, 325}\NWlink{nuweb336}{, 336}\NWlink{nuweb343}{, 343}\NWlink{nuweb348}{, 348}\NWlink{nuweb358}{, 358}\NWlink{nuweb366}{, 366}\NWlink{nuweb374}{, 374}\NWlink{nuweb375b}{, 375b}\NWlink{nuweb380}{, 380}.
}
\item $\langle\,$Fourmilab production version\nobreak\ {\footnotesize \NWlink{nuweb550}{550}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb546}{546}.}
\item $\langle\,$From address for mail sent to users\nobreak\ {\footnotesize \NWlink{nuweb11e}{11e}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb136}{136}\NWlink{nuweb371}{, 371}\NWlink{nuweb372}{, 372}.
}
\item $\langle\,$Generate array of years for diet calculator selection\nobreak\ {\footnotesize \NWlink{nuweb277a}{277a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb274}{274}\NWlink{nuweb286}{, 286}.
}
\item $\langle\,$Generate assumed identity notification\nobreak\ {\footnotesize \NWlink{nuweb196}{196}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb190}{190}\NWlink{nuweb208}{, 208}\NWlink{nuweb221}{, 221}\NWlink{nuweb224}{, 224}\NWlink{nuweb227}{, 227}\NWlink{nuweb241}{, 241}\NWlink{nuweb244}{, 244}\NWlink{nuweb247}{, 247}\NWlink{nuweb250}{, 250}\NWlink{nuweb252}{, 252}\NWlink{nuweb258}{, 258}\NWlink{nuweb260}{, 260}\NWlink{nuweb262}{, 262}\NWlink{nuweb264}{, 264}\NWlink{nuweb274}{, 274}\NWlink{nuweb294}{, 294}\NWlink{nuweb311}{, 311}\NWlink{nuweb312}{, 312}\NWlink{nuweb313}{, 313}\NWlink{nuweb315}{, 315}\NWlink{nuweb316}{, 316}\NWlink{nuweb317}{, 317}\NWlink{nuweb320}{, 320}\NWlink{nuweb321}{, 321}\NWlink{nuweb322}{, 322}\NWlink{nuweb323}{, 323}\NWlink{nuweb325}{, 325}\NWlink{nuweb330}{, 330}\NWlink{nuweb331}{, 331}\NWlink{nuweb332}{, 332}\NWlink{nuweb334}{, 334}\NWlink{nuweb336}{, 336}\NWlink{nuweb340}{, 340}\NWlink{nuweb341}{, 341}\NWlink{nuweb342}{, 342}\NWlink{nuweb343}{, 343}\NWlink{nuweb347}{, 347}\NWlink{nuweb348}{, 348}\NWlink{nuweb358}{, 358}\NWlink{nuweb365}{, 365}\NWlink{nuweb370}{, 370}\NWlink{nuweb374}{, 374}\NWlink{nuweb377}{, 377}\NWlink{nuweb380}{, 380}\NWlink{nuweb382}{, 382}.
}
\item $\langle\,$Generate comment column\nobreak\ {\footnotesize \NWlink{nuweb40a}{40a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb36}{36}.}
\item $\langle\,$Generate confirmation of database deletion\nobreak\ {\footnotesize \NWlink{nuweb379b}{379b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb377}{377}.}
\item $\langle\,$Generate date column\nobreak\ {\footnotesize \NWlink{nuweb37b}{37b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb36}{36}.}
\item $\langle\,$Generate destructive operation confirmation form\nobreak\ {\footnotesize \NWlink{nuweb376}{376}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb374}{374}\NWlink{nuweb380}{, 380}.
}
\item $\langle\,$Generate diet calculator form\nobreak\ {\footnotesize \NWlink{nuweb278a}{278a}\NWlink{nuweb278b}{b}\NWlink{nuweb279a}{, 279a}\NWlink{nuweb279b}{b}\NWlink{nuweb280a}{, 280a}\NWlink{nuweb280b}{b}\NWlink{nuweb281}{, 281}\NWlink{nuweb282a}{, 282a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb274}{274}.}
\item $\langle\,$Generate exercise rung column\nobreak\ {\footnotesize \NWlink{nuweb39a}{39a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb36}{36}.}
\item $\langle\,$Generate feedback message composition form\nobreak\ {\footnotesize \NWlink{nuweb366}{366}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb365}{365}.}
\item $\langle\,$Generate flag column\nobreak\ {\footnotesize \NWlink{nuweb39b}{39b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb36}{36}.}
\item $\langle\,$Generate form fields for custom chart interval\nobreak\ {\footnotesize \NWlink{nuweb296}{296}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb295}{295}.}
\item $\langle\,$Generate form fields for custom trend interval\nobreak\ {\footnotesize \NWlink{nuweb270}{270}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb265a}{265a}.}
\item $\langle\,$Generate form permitting user to back up database\nobreak\ {\footnotesize \NWlink{nuweb375b}{375b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb374}{374}.}
\item $\langle\,$Generate global statistics for open accounts\nobreak\ {\footnotesize \NWlink{nuweb350}{350}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb348}{348}.}
\item $\langle\,$Generate hidden monthly log property fields\nobreak\ {\footnotesize \NWlink{nuweb213}{213}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb208}{208}.}
\item $\langle\,$Generate historical chart\nobreak\ {\footnotesize \NWlink{nuweb303}{303}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb178}{178}.}
\item $\langle\,$Generate invitation codes\nobreak\ {\footnotesize \NWlink{nuweb323}{323}\NWlink{nuweb324}{, 324}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb181}{181}.}
\item $\langle\,$Generate monthly chart\nobreak\ {\footnotesize \NWlink{nuweb263a}{263a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb178}{178}.}
\item $\langle\,$Generate option items for chart sizes\nobreak\ {\footnotesize \NWlink{nuweb302c}{302c}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb295}{295}.}
\item $\langle\,$Generate option items for days\nobreak\ {\footnotesize \NWlink{nuweb302b}{302b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb272}{272}\NWlink{nuweb273}{, 273}\NWlink{nuweb361}{, 361}\NWlink{nuweb362}{, 362}.
}
\item $\langle\,$Generate option items for months\nobreak\ {\footnotesize \NWlink{nuweb302a}{302a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb272}{272}\NWlink{nuweb273}{, 273}\NWlink{nuweb361}{, 361}\NWlink{nuweb362}{, 362}.
}
\item $\langle\,$Generate option items for years in database\nobreak\ {\footnotesize \NWlink{nuweb301b}{301b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb272}{272}\NWlink{nuweb273}{, 273}.
}
\item $\langle\,$Generate paper log form for month\nobreak\ {\footnotesize \NWlink{nuweb261}{261}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb260}{260}.}
\item $\langle\,$Generate paper log forms\nobreak\ {\footnotesize \NWlink{nuweb260}{260}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$Generate synthetic data as specified in form\nobreak\ {\footnotesize \NWlink{nuweb359}{359}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb358}{358}.}
\item $\langle\,$Generate synthetic data for user account\nobreak\ {\footnotesize \NWlink{nuweb358}{358}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb181}{181}.}
\item $\langle\,$Generate synthetic data specification form\nobreak\ {\footnotesize \NWlink{nuweb360}{360}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb358}{358}.}
\item $\langle\,$Generate table of open sessions\nobreak\ {\footnotesize \NWlink{nuweb338}{338}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb336}{336}.}
\item $\langle\,$Generate table of persistent logins\nobreak\ {\footnotesize \NWlink{nuweb345}{345}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb343}{343}.}
\item $\langle\,$Generate table of public accounts\nobreak\ {\footnotesize \NWlink{nuweb319}{319}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb317}{317}.}
\item $\langle\,$Generate table of yearly calendars\nobreak\ {\footnotesize \NWlink{nuweb222}{222}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb221}{221}.}
\item $\langle\,$Generate test output page\nobreak\ {\footnotesize \NWlink{nuweb384b}{384b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$Generate warning if JavaScript disabled in diet calculator form\nobreak\ {\footnotesize \NWlink{nuweb276a}{276a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb274}{274}.}
\item $\langle\,$Generate weight, trend, and variance columns\nobreak\ {\footnotesize \NWlink{nuweb38}{38}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb36}{36}.}
\item $\langle\,$Generate XHTML navigation bar\nobreak\ {\footnotesize \NWlink{nuweb435}{435}\NWlink{nuweb436}{, 436}\NWlink{nuweb437}{, 437}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb431}{431}.}
\item $\langle\,$Global declarations\nobreak\ {\footnotesize \NWlink{nuweb387a}{387a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb173}{173}\NWlink{nuweb461}{, 461}.
}
\item $\langle\,$Global statistics tables\nobreak\ {\footnotesize \NWlink{nuweb479}{479}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb472}{472}.}
\item $\langle\,$Global variables\nobreak\ {\footnotesize \NWlink{nuweb388b}{388b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb387a}{387a}.}
\item $\langle\,$Gregorian date to Julian day number\nobreak\ {\footnotesize \NWlink{nuweb447b}{447b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb445}{445}.}
\item $\langle\,$Gregorian leap year computation\nobreak\ {\footnotesize \NWlink{nuweb447a}{447a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb445}{445}.}
\item $\langle\,$Height (for body mass index)\nobreak\ {\footnotesize \NWlink{nuweb132}{132}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb127}{127}.}
\item $\langle\,$HTML header section\nobreak\ {\footnotesize \NWlink{nuweb545}{545}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb544}{544}.}
\item $\langle\,$Identify log where recomputation begins\nobreak\ {\footnotesize \NWlink{nuweb393a}{393a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb392}{392}.}
\item $\langle\,$If requested, canonicalise weight entries in log\nobreak\ {\footnotesize \NWlink{nuweb396}{396}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb393b}{393b}\NWlink{nuweb394}{, 394}.
}
\item $\langle\,$Image and Icon Directory\nobreak\ {\footnotesize \NWlink{nuweb7a}{7a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb101b}{101b}\NWlink{nuweb459}{, 459}.
}
\item $\langle\,$Import log items from CSV database file\nobreak\ {\footnotesize \NWlink{nuweb233}{233}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb228b}{228b}.}
\item $\langle\,$Import log items from XML database file\nobreak\ {\footnotesize \NWlink{nuweb230}{230}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb228b}{228b}.}
\item $\langle\,$Import uploaded CSV log entries\nobreak\ {\footnotesize \NWlink{nuweb227}{227}\NWlink{nuweb228a}{, 228a}\NWlink{nuweb228b}{b}\NWlink{nuweb229}{, 229}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$JavaScript debugging console\nobreak\ {\footnotesize \NWlink{nuweb386a}{386a}}$\,\rangle$ {\footnotesize {\NWtxtNoRef}.}
\item $\langle\,$Julian date constant definitions\nobreak\ {\footnotesize \NWlink{nuweb446a}{446a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb445}{445}.}
\item $\langle\,$Julian date support functions\nobreak\ {\footnotesize \NWlink{nuweb446b}{446b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb445}{445}.}
\item $\langle\,$Julian day and fraction to old HTTP cookie time and date\nobreak\ {\footnotesize \NWlink{nuweb453}{453}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb445}{445}.}
\item $\langle\,$Julian day and fraction to RFC 3339 time and date\nobreak\ {\footnotesize \NWlink{nuweb452b}{452b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb445}{445}.}
\item $\langle\,$Julian day and fraction to RFC 822 time and date\nobreak\ {\footnotesize \NWlink{nuweb452a}{452a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb445}{445}.}
\item $\langle\,$Julian day and fraction to Unix time\nobreak\ {\footnotesize \NWlink{nuweb451a}{451a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb445}{445}.}
\item $\langle\,$Julian day fraction to civil time\nobreak\ {\footnotesize \NWlink{nuweb450a}{450a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb445}{445}.}
\item $\langle\,$Julian day to day of week\nobreak\ {\footnotesize \NWlink{nuweb449a}{449a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb445}{445}.}
\item $\langle\,$Julian day to Gregorian date\nobreak\ {\footnotesize \NWlink{nuweb448}{448}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb445}{445}.}
\item $\langle\,$Label date axis at the bottom\nobreak\ {\footnotesize \NWlink{nuweb90}{90}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb89b}{89b}.}
\item $\langle\,$Label date axis with year numbers only\nobreak\ {\footnotesize \NWlink{nuweb92}{92}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb90}{90}.}
\item $\langle\,$Label date axis with years, months, and possibly weeks\nobreak\ {\footnotesize \NWlink{nuweb91}{91}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb90}{90}.}
\item $\langle\,$Label exercise rung axis if any plotted\nobreak\ {\footnotesize \NWlink{nuweb94}{94}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb95}{95}.}
\item $\langle\,$Label trend report for custom interval\nobreak\ {\footnotesize \NWlink{nuweb269}{269}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb268}{268}.}
\item $\langle\,$Label weight axis\nobreak\ {\footnotesize \NWlink{nuweb55}{55}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb46}{46}.}
\item $\langle\,$Label weight axis at the left\nobreak\ {\footnotesize \NWlink{nuweb93}{93}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb95}{95}.}
\item $\langle\,$Left Delimiter for Quoted File Name Characters\nobreak\ {\footnotesize \NWlink{nuweb11a}{11a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb145}{145}.}
\item $\langle\,$Length of automatically generated passwords\nobreak\ {\footnotesize \NWlink{nuweb12c}{12c}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb199}{199}.}
\item $\langle\,$List publicly-visible accounts\nobreak\ {\footnotesize \NWlink{nuweb317}{317}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$Load first log into memory\nobreak\ {\footnotesize \NWlink{nuweb393b}{393b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb392}{392}.}
\item $\langle\,$Load or create monthly log containing imported record\nobreak\ {\footnotesize \NWlink{nuweb236}{236}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb231}{231}\NWlink{nuweb234}{, 234}\NWlink{nuweb238}{, 238}.
}
\item $\langle\,$Local time zone offset field\nobreak\ {\footnotesize \NWlink{nuweb390b}{390b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb125}{125}\NWlink{nuweb193}{, 193}\NWlink{nuweb198}{, 198}\NWlink{nuweb203}{, 203}\NWlink{nuweb208}{, 208}\NWlink{nuweb223}{, 223}\NWlink{nuweb225}{, 225}\NWlink{nuweb226a}{, 226a}\NWlink{nuweb227}{, 227}\NWlink{nuweb241}{, 241}\NWlink{nuweb250}{, 250}\NWlink{nuweb258}{, 258}\NWlink{nuweb270}{, 270}\NWlink{nuweb274}{, 274}\NWlink{nuweb295}{, 295}\NWlink{nuweb304a}{, 304a}\NWlink{nuweb310}{, 310}\NWlink{nuweb311}{, 311}\NWlink{nuweb315}{, 315}\NWlink{nuweb317}{, 317}\NWlink{nuweb322}{, 322}\NWlink{nuweb323}{, 323}\NWlink{nuweb325}{, 325}\NWlink{nuweb336}{, 336}\NWlink{nuweb343}{, 343}\NWlink{nuweb348}{, 348}\NWlink{nuweb358}{, 358}\NWlink{nuweb366}{, 366}\NWlink{nuweb374}{, 374}\NWlink{nuweb375b}{, 375b}\NWlink{nuweb380}{, 380}.
}
\item $\langle\,$Log changes to account settings\nobreak\ {\footnotesize \NWlink{nuweb314}{314}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb313}{313}.}
\item $\langle\,$Log failed login attempt in system log\nobreak\ {\footnotesize \NWlink{nuweb185c}{185c}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb185a}{185a}\NWlink{nuweb186a}{, 186a}.
}
\item $\langle\,$Log out user: end session\nobreak\ {\footnotesize \NWlink{nuweb204}{204}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb180a}{180a}.}
\item $\langle\,$Login-related transactions\nobreak\ {\footnotesize \NWlink{nuweb180a}{180a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$Look up public account and verify it exists\nobreak\ {\footnotesize \NWlink{nuweb321}{321}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb320}{320}.}
\item $\langle\,$Main account dispatch page\nobreak\ {\footnotesize \NWlink{nuweb190}{190}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb180b}{180b}.}
\item $\langle\,$Master encryption key\nobreak\ {\footnotesize \NWlink{nuweb5a}{5a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb143}{143}\NWlink{nuweb144}{, 144}.
}
\item $\langle\,$Maximum Expected Weight Variance\nobreak\ {\footnotesize \NWlink{nuweb492}{492}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb493b}{493b}.}
\item $\langle\,$Maximum File Length\nobreak\ {\footnotesize \NWlink{nuweb8e}{8e}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb145}{145}.}
\item $\langle\,$Maximum line length in feedback E-mail messages\nobreak\ {\footnotesize \NWlink{nuweb11g}{11g}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb368}{368}\NWlink{nuweb373}{, 373}.
}
\item $\langle\,$Maximum Text Input Field Length\nobreak\ {\footnotesize \NWlink{nuweb11c}{11c}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb40a}{40a}\NWlink{nuweb126}{, 126}\NWlink{nuweb129a}{, 129a}\NWlink{nuweb129b}{b}\NWlink{nuweb130}{, 130}\NWlink{nuweb131a}{, 131a}\NWlink{nuweb131b}{b}\NWlink{nuweb198}{, 198}\NWlink{nuweb328}{, 328}\NWlink{nuweb336}{, 336}\NWlink{nuweb343}{, 343}\NWlink{nuweb376}{, 376}.
}
\item $\langle\,$MIME Content-type specification\nobreak\ {\footnotesize \NWlink{nuweb390a}{390a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb173}{173}\NWlink{nuweb207}{, 207}\NWlink{nuweb252}{, 252}\NWlink{nuweb262}{, 262}.
}
\item $\langle\,$Minimum, Maximum, and Sign functions\nobreak\ {\footnotesize \NWlink{nuweb405}{405}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb23}{23}\NWlink{nuweb75}{, 75}\NWlink{nuweb391}{, 391}.
}
\item $\langle\,$Modify user account request\nobreak\ {\footnotesize \NWlink{nuweb311}{311}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb180b}{180b}.}
\item $\langle\,$Monthly log control panel\nobreak\ {\footnotesize \NWlink{nuweb216}{216}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb208}{208}.}
\item $\langle\,$Monthly log table\nobreak\ {\footnotesize \NWlink{nuweb474}{474}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb472}{472}.}
\item $\langle\,$Monthly log title and navigation buttons\nobreak\ {\footnotesize \NWlink{nuweb211}{211}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb208}{208}.}
\item $\langle\,$Monthly Log Weight Range in Kilograms\nobreak\ {\footnotesize \NWlink{nuweb5b}{5b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb5c}{5c}\NWlink{nuweb50}{, 50}.
}
\item $\langle\,$Monthly Log Weight Range in Pounds\nobreak\ {\footnotesize \NWlink{nuweb5c}{5c}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb50}{50}.}
\item $\langle\,$Navigation bar table\nobreak\ {\footnotesize \NWlink{nuweb476}{476}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb472}{472}.}
\item $\langle\,$New monthly log creation form\nobreak\ {\footnotesize \NWlink{nuweb223}{223}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb221}{221}.}
\item $\langle\,$Obtain list of open accounts\nobreak\ {\footnotesize \NWlink{nuweb329}{329}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb327}{327}.}
\item $\langle\,$Obtain list of open sessions\nobreak\ {\footnotesize \NWlink{nuweb337}{337}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb336}{336}\NWlink{nuweb339}{, 339}.
}
\item $\langle\,$Obtain list of persistent login tokens\nobreak\ {\footnotesize \NWlink{nuweb344}{344}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb316}{316}\NWlink{nuweb343}{, 343}\NWlink{nuweb346}{, 346}.
}
\item $\langle\,$Obtain list of public accounts\nobreak\ {\footnotesize \NWlink{nuweb318}{318}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb317}{317}.}
\item $\langle\,$Obtain list of years\nobreak\ {\footnotesize \NWlink{nuweb109b}{109b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb108}{108}\NWlink{nuweb109a}{, 109a}.
}
\item $\langle\,$Obtain trend carry-forward for Excel CSV\nobreak\ {\footnotesize \NWlink{nuweb67}{67}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb66}{66}.}
\item $\langle\,$Open new session and link to user directory\nobreak\ {\footnotesize \NWlink{nuweb187}{187}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb183}{183}.}
\item $\langle\,$Options documentation\nobreak\ {\footnotesize \NWlink{nuweb456a}{456a}\NWlink{nuweb456b}{b}\NWlink{nuweb456c}{c}\NWlink{nuweb457a}{, 457a}\NWlink{nuweb457b}{b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb455}{455}.}
\item $\langle\,$Output table rows for each interval analysed\nobreak\ {\footnotesize \NWlink{nuweb268}{268}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb267}{267}.}
\item $\langle\,$Output trend analysis report for intervals evaluated\nobreak\ {\footnotesize \NWlink{nuweb267}{267}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb265a}{265a}.}
\item $\langle\,$Override diet calculator primary fields from form fields\nobreak\ {\footnotesize \NWlink{nuweb285}{285}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb275}{275}.}
\item $\langle\,$Page title table\nobreak\ {\footnotesize \NWlink{nuweb473a}{473a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb472}{472}.}
\item $\langle\,$Parse CGI arguments\nobreak\ {\footnotesize \NWlink{nuweb412}{412}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb391}{391}.}
\item $\langle\,$Parse Excel CSV date field\nobreak\ {\footnotesize \NWlink{nuweb235}{235}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb234}{234}.}
\item $\langle\,$Parse signed weight value\nobreak\ {\footnotesize \NWlink{nuweb402}{402}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb391}{391}.}
\item $\langle\,$Parse weight value\nobreak\ {\footnotesize \NWlink{nuweb401}{401}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb391}{391}.}
\item $\langle\,$Password and password confirmation fields\nobreak\ {\footnotesize \NWlink{nuweb130}{130}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb127}{127}.}
\item $\langle\,$Path for cookies\nobreak\ {\footnotesize \NWlink{nuweb13b}{13b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb158a}{158a}\NWlink{nuweb158b}{b}.
}
\item $\langle\,$Path to Invoke Sendmail\nobreak\ {\footnotesize \NWlink{nuweb11d}{11d}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb136}{136}\NWlink{nuweb371}{, 371}\NWlink{nuweb372}{, 372}.
}
\item $\langle\,$Perform static update of diet calculator\nobreak\ {\footnotesize \NWlink{nuweb286}{286}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb274}{274}.}
\item $\langle\,$Perl directory\nobreak\ {\footnotesize \NWlink{nuweb8d}{8d}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb15}{15}\NWlink{nuweb18}{, 18}\NWlink{nuweb23}{, 23}\NWlink{nuweb75}{, 75}\NWlink{nuweb114}{, 114}\NWlink{nuweb118}{, 118}\NWlink{nuweb148}{, 148}\NWlink{nuweb154}{, 154}\NWlink{nuweb163}{, 163}\NWlink{nuweb173}{, 173}\NWlink{nuweb415}{, 415}\NWlink{nuweb421a}{, 421a}\NWlink{nuweb431}{, 431}\NWlink{nuweb440}{, 440}\NWlink{nuweb445}{, 445}\NWlink{nuweb459}{, 459}\NWlink{nuweb461}{, 461}.
}
\item $\langle\,$Perl language modes\nobreak\ {\footnotesize \NWlink{nuweb387b}{387b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb15}{15}\NWlink{nuweb18}{, 18}\NWlink{nuweb23}{, 23}\NWlink{nuweb75}{, 75}\NWlink{nuweb114}{, 114}\NWlink{nuweb118}{, 118}\NWlink{nuweb148}{, 148}\NWlink{nuweb154}{, 154}\NWlink{nuweb163}{, 163}\NWlink{nuweb387a}{, 387a}\NWlink{nuweb415}{, 415}\NWlink{nuweb421a}{, 421a}\NWlink{nuweb431}{, 431}\NWlink{nuweb440}{, 440}\NWlink{nuweb445}{, 445}\NWlink{nuweb459}{, 459}.
}
\item $\langle\,$Persistent login manager table\nobreak\ {\footnotesize \NWlink{nuweb478a}{478a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb472}{472}.}
\item $\langle\,$Plot exercise rung information\nobreak\ {\footnotesize \NWlink{nuweb49}{49}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb46}{46}.}
\item $\langle\,$Plot exercise rung on chart image\nobreak\ {\footnotesize \NWlink{nuweb503}{503}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb502}{502}.}
\item $\langle\,$Plot multiple days per pixel\nobreak\ {\footnotesize \NWlink{nuweb98}{98}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb95}{95}.}
\item $\langle\,$Plot multiple pixels per day\nobreak\ {\footnotesize \NWlink{nuweb96}{96}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb95}{95}.}
\item $\langle\,$Plot the diet plan if defined and requested\nobreak\ {\footnotesize \NWlink{nuweb53a}{53a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb46}{46}.}
\item $\langle\,$Plot the diet plan on historical chart\nobreak\ {\footnotesize \NWlink{nuweb87a}{87a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb82}{82}.}
\item $\langle\,$Plot the updated trend\nobreak\ {\footnotesize \NWlink{nuweb499}{499}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb498}{498}.}
\item $\langle\,$Plot weight and rung data on historical chart\nobreak\ {\footnotesize \NWlink{nuweb95}{95}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb82}{82}.}
\item $\langle\,$Plot weight entries as floats and sinkers\nobreak\ {\footnotesize \NWlink{nuweb54}{54}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb46}{46}.}
\item $\langle\,$Plot weight entry as float or sinker\nobreak\ {\footnotesize \NWlink{nuweb97}{97}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb96}{96}.}
\item $\langle\,$Plot weight trend line on chart\nobreak\ {\footnotesize \NWlink{nuweb53b}{53b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb46}{46}.}
\item $\langle\,$Preset diet calculator start and end dates\nobreak\ {\footnotesize \NWlink{nuweb277b}{277b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb274}{274}.}
\item $\langle\,$Print command line help information\nobreak\ {\footnotesize \NWlink{nuweb404}{404}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb391}{391}.}
\item $\langle\,$Process administrator account delete\nobreak\ {\footnotesize \NWlink{nuweb334}{334}\NWlink{nuweb335}{, 335}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb181}{181}.}
\item $\langle\,$Process administrator database purge\nobreak\ {\footnotesize \NWlink{nuweb332}{332}\NWlink{nuweb333}{, 333}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb181}{181}.}
\item $\langle\,$Process command line options\nobreak\ {\footnotesize \NWlink{nuweb389a}{389a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb173}{173}.}
\item $\langle\,$Process custom interval specification, if any\nobreak\ {\footnotesize \NWlink{nuweb266}{266}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb252}{252}\NWlink{nuweb265a}{, 265a}\NWlink{nuweb295}{, 295}.
}
\item $\langle\,$Process database delete\nobreak\ {\footnotesize \NWlink{nuweb377}{377}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb180a}{180a}.}
\item $\langle\,$Process database export\nobreak\ {\footnotesize \NWlink{nuweb252}{252}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb178}{178}.}
\item $\langle\,$Process new user account request\nobreak\ {\footnotesize \NWlink{nuweb305}{305}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb180b}{180b}.}
\item $\langle\,$Process queued cluster synchronisation transactions\nobreak\ {\footnotesize \NWlink{nuweb424}{424}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb421a}{421a}.}
\item $\langle\,$Process user account close\nobreak\ {\footnotesize \NWlink{nuweb382}{382}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb180a}{180a}.}
\item $\langle\,$Process user account modification\nobreak\ {\footnotesize \NWlink{nuweb313}{313}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb180b}{180b}.}
\item $\langle\,$Process XML daily log entry\nobreak\ {\footnotesize \NWlink{nuweb231}{231}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb230}{230}.}
\item $\langle\,$Production Book Directory\nobreak\ {\footnotesize \NWlink{nuweb5f}{5f}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb6b}{6b}\NWlink{nuweb6d}{d}\NWlink{nuweb7c}{, 7c}.
}
\item $\langle\,$Production CGI Installation Directory\nobreak\ {\footnotesize \NWlink{nuweb6d}{6d}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb546}{546}.}
\item $\langle\,$Production Executable Installation Directory\nobreak\ {\footnotesize \NWlink{nuweb7c}{7c}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb546}{546}.}
\item $\langle\,$Production Web Directory\nobreak\ {\footnotesize \NWlink{nuweb6b}{6b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb546}{546}.}
\item $\langle\,$Prohibit password reset on read-only account\nobreak\ {\footnotesize \NWlink{nuweb201}{201}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb199}{199}.}
\item $\langle\,$Propagate handheld setting to subsequent forms\nobreak\ {\footnotesize \NWlink{nuweb304b}{304b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb198}{198}\NWlink{nuweb203}{, 203}\NWlink{nuweb304a}{, 304a}\NWlink{nuweb310}{, 310}.
}
\item $\langle\,$Propagate trend through user's monthly logs\nobreak\ {\footnotesize \NWlink{nuweb392}{392}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb391}{391}.}
\item $\langle\,$Propagate trend to next log\nobreak\ {\footnotesize \NWlink{nuweb394}{394}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb392}{392}.}
\item $\langle\,$Provide administrator access to user account\nobreak\ {\footnotesize \NWlink{nuweb330}{330}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb181}{181}.}
\item $\langle\,$Provide browse access to public account\nobreak\ {\footnotesize \NWlink{nuweb320}{320}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$Public Name Directory\nobreak\ {\footnotesize \NWlink{nuweb7g}{7g}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb165}{165}\NWlink{nuweb166}{, 166}\NWlink{nuweb167}{, 167}\NWlink{nuweb168}{, 168}\NWlink{nuweb169b}{, 169b}\NWlink{nuweb318}{, 318}.
}
\item $\langle\,$Public name settings\nobreak\ {\footnotesize \NWlink{nuweb134b}{134b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb127}{127}.}
\item $\langle\,$Quit browsing another account\nobreak\ {\footnotesize \NWlink{nuweb248a}{248a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$Quote text for inclusion in HTML\nobreak\ {\footnotesize \NWlink{nuweb439}{439}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb431}{431}.}
\item $\langle\,$Read line from persistent object file\nobreak\ {\footnotesize \NWlink{nuweb413b}{413b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb35a}{35a}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb157a}{, 157a}\NWlink{nuweb171a}{, 171a}\NWlink{nuweb399a}{, 399a}\NWlink{nuweb421a}{, 421a}.
}
\item $\langle\,$Read log if in database or create blank log if it's not\nobreak\ {\footnotesize \NWlink{nuweb210}{210}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb208}{208}\NWlink{nuweb219}{, 219}\NWlink{nuweb248b}{, 248b}\NWlink{nuweb249}{, 249}\NWlink{nuweb263a}{, 263a}.
}
\item $\langle\,$Recalculate trend carry-forward for all logs for a user\nobreak\ {\footnotesize \NWlink{nuweb247}{247}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$Receive log records from the aggregator for global statistics\nobreak\ {\footnotesize \NWlink{nuweb355}{355}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb348}{348}.}
\item $\langle\,$Recover from failure of a cluster synchronisation transaction\nobreak\ {\footnotesize \NWlink{nuweb426}{426}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb424}{424}.}
\item $\langle\,$Reject account close for confirmation code mismatch\nobreak\ {\footnotesize \NWlink{nuweb383b}{383b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb382}{382}.}
\item $\langle\,$Reject account close for user name or password mismatch\nobreak\ {\footnotesize \NWlink{nuweb383a}{383a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb382}{382}.}
\item $\langle\,$Reject account close if logs remain in the database\nobreak\ {\footnotesize \NWlink{nuweb384a}{384a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb382}{382}.}
\item $\langle\,$Reject deletion request when confirmation code fails to match\nobreak\ {\footnotesize \NWlink{nuweb378b}{378b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb377}{377}.}
\item $\langle\,$Reject deletion request when user name and password fail to match\nobreak\ {\footnotesize \NWlink{nuweb378a}{378a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb377}{377}.}
\item $\langle\,$Reject login: Incorrect password\nobreak\ {\footnotesize \NWlink{nuweb186a}{186a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb184}{184}.}
\item $\langle\,$Reject login: Unknown user name\nobreak\ {\footnotesize \NWlink{nuweb185a}{185a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb183}{183}\NWlink{nuweb184}{, 184}\NWlink{nuweb199}{, 199}.
}
\item $\langle\,$Reject request if logs remain in database\nobreak\ {\footnotesize \NWlink{nuweb381a}{381a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb380}{380}.}
\item $\langle\,$Reject setting query or change from cookie-based login\nobreak\ {\footnotesize \NWlink{nuweb312}{312}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb311}{311}.}
\item $\langle\,$Release Date\nobreak\ {\footnotesize \NWlink{nuweb3b}{3b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb389a}{389a}\NWlink{nuweb404}{, 404}\NWlink{nuweb455}{, 455}\NWlink{nuweb544}{, 544}.
}
\item $\langle\,$Remember Me Directory\nobreak\ {\footnotesize \NWlink{nuweb13d}{13d}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb159}{159}\NWlink{nuweb160}{, 160}\NWlink{nuweb316}{, 316}\NWlink{nuweb344}{, 344}\NWlink{nuweb346}{, 346}.
}
\item $\langle\,$Report errors in account modification request and re-issue form\nobreak\ {\footnotesize \NWlink{nuweb315}{315}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb313}{313}.}
\item $\langle\,$Report errors in new account request and re-issue form\nobreak\ {\footnotesize \NWlink{nuweb310}{310}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb305}{305}\NWlink{nuweb307b}{, 307b}.
}
\item $\langle\,$Report warnings from static diet calculator update\nobreak\ {\footnotesize \NWlink{nuweb276b}{276b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb274}{274}.}
\item $\langle\,$Request historical chart\nobreak\ {\footnotesize \NWlink{nuweb294}{294}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$Request invitation codes\nobreak\ {\footnotesize \NWlink{nuweb322}{322}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb181}{181}.}
\item $\langle\,$Request log records from the aggregator and compute global statistics\nobreak\ {\footnotesize \NWlink{nuweb349}{349}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb348}{348}.}
\item $\langle\,$Request paper log forms\nobreak\ {\footnotesize \NWlink{nuweb258}{258}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$Reset a user's password\nobreak\ {\footnotesize \NWlink{nuweb199}{199}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb180b}{180b}.}
\item $\langle\,$Retrieve active session information\nobreak\ {\footnotesize \NWlink{nuweb205}{205}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb190}{190}\NWlink{nuweb204}{, 204}\NWlink{nuweb208}{, 208}\NWlink{nuweb219}{, 219}\NWlink{nuweb221}{, 221}\NWlink{nuweb224}{, 224}\NWlink{nuweb227}{, 227}\NWlink{nuweb241}{, 241}\NWlink{nuweb244}{, 244}\NWlink{nuweb247}{, 247}\NWlink{nuweb248a}{, 248a}\NWlink{nuweb248b}{b}\NWlink{nuweb249}{, 249}\NWlink{nuweb250}{, 250}\NWlink{nuweb252}{, 252}\NWlink{nuweb254}{, 254}\NWlink{nuweb255}{, 255}\NWlink{nuweb256}{, 256}\NWlink{nuweb257}{, 257}\NWlink{nuweb258}{, 258}\NWlink{nuweb260}{, 260}\NWlink{nuweb262}{, 262}\NWlink{nuweb263a}{, 263a}\NWlink{nuweb264}{, 264}\NWlink{nuweb274}{, 274}\NWlink{nuweb293}{, 293}\NWlink{nuweb294}{, 294}\NWlink{nuweb303}{, 303}\NWlink{nuweb311}{, 311}\NWlink{nuweb313}{, 313}\NWlink{nuweb316}{, 316}\NWlink{nuweb317}{, 317}\NWlink{nuweb320}{, 320}\NWlink{nuweb322}{, 322}\NWlink{nuweb323}{, 323}\NWlink{nuweb325}{, 325}\NWlink{nuweb330}{, 330}\NWlink{nuweb332}{, 332}\NWlink{nuweb334}{, 334}\NWlink{nuweb336}{, 336}\NWlink{nuweb339}{, 339}\NWlink{nuweb343}{, 343}\NWlink{nuweb346}{, 346}\NWlink{nuweb348}{, 348}\NWlink{nuweb358}{, 358}\NWlink{nuweb365}{, 365}\NWlink{nuweb370}{, 370}\NWlink{nuweb374}{, 374}\NWlink{nuweb377}{, 377}\NWlink{nuweb380}{, 380}\NWlink{nuweb382}{, 382}\NWlink{nuweb385a}{, 385a}.
}
\item $\langle\,$Retrieve user account information\nobreak\ {\footnotesize \NWlink{nuweb206}{206}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb190}{190}\NWlink{nuweb208}{, 208}\NWlink{nuweb219}{, 219}\NWlink{nuweb221}{, 221}\NWlink{nuweb224}{, 224}\NWlink{nuweb227}{, 227}\NWlink{nuweb241}{, 241}\NWlink{nuweb244}{, 244}\NWlink{nuweb247}{, 247}\NWlink{nuweb248a}{, 248a}\NWlink{nuweb248b}{b}\NWlink{nuweb249}{, 249}\NWlink{nuweb250}{, 250}\NWlink{nuweb252}{, 252}\NWlink{nuweb254}{, 254}\NWlink{nuweb255}{, 255}\NWlink{nuweb256}{, 256}\NWlink{nuweb257}{, 257}\NWlink{nuweb258}{, 258}\NWlink{nuweb260}{, 260}\NWlink{nuweb262}{, 262}\NWlink{nuweb263a}{, 263a}\NWlink{nuweb264}{, 264}\NWlink{nuweb274}{, 274}\NWlink{nuweb293}{, 293}\NWlink{nuweb294}{, 294}\NWlink{nuweb303}{, 303}\NWlink{nuweb311}{, 311}\NWlink{nuweb313}{, 313}\NWlink{nuweb316}{, 316}\NWlink{nuweb317}{, 317}\NWlink{nuweb320}{, 320}\NWlink{nuweb322}{, 322}\NWlink{nuweb323}{, 323}\NWlink{nuweb325}{, 325}\NWlink{nuweb330}{, 330}\NWlink{nuweb332}{, 332}\NWlink{nuweb334}{, 334}\NWlink{nuweb336}{, 336}\NWlink{nuweb339}{, 339}\NWlink{nuweb343}{, 343}\NWlink{nuweb346}{, 346}\NWlink{nuweb348}{, 348}\NWlink{nuweb358}{, 358}\NWlink{nuweb365}{, 365}\NWlink{nuweb370}{, 370}\NWlink{nuweb374}{, 374}\NWlink{nuweb377}{, 377}\NWlink{nuweb380}{, 380}\NWlink{nuweb382}{, 382}.
}
\item $\langle\,$Return log items for aggregation from this user\nobreak\ {\footnotesize \NWlink{nuweb117}{117}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb116}{116}.}
\item $\langle\,$Return login request form\nobreak\ {\footnotesize \NWlink{nuweb182}{182}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb180a}{180a}.}
\item $\langle\,$Return password reset confirmation page\nobreak\ {\footnotesize \NWlink{nuweb203}{203}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb199}{199}.}
\item $\langle\,$Return time of user's last transaction\nobreak\ {\footnotesize \NWlink{nuweb399a}{399a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb391}{391}.}
\item $\langle\,$Right Delimiter for Quoted File Name Characters\nobreak\ {\footnotesize \NWlink{nuweb11b}{11b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb145}{145}.}
\item $\langle\,$Sanity check year and month specification\nobreak\ {\footnotesize \NWlink{nuweb207}{207}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb210}{210}\NWlink{nuweb247}{, 247}\NWlink{nuweb263a}{, 263a}.
}
\item $\langle\,$Save diet calculator settings\nobreak\ {\footnotesize \NWlink{nuweb293}{293}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$Save process ID of cluster synchronisation job\nobreak\ {\footnotesize \NWlink{nuweb422b}{422b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb421a}{421a}.}
\item $\langle\,$Selection of months for paper logs\nobreak\ {\footnotesize \NWlink{nuweb259a}{259a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb258}{258}.}
\item $\langle\,$Selection of months to export from database\nobreak\ {\footnotesize \NWlink{nuweb251a}{251a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb250}{250}.}
\item $\langle\,$Send a feedback message\nobreak\ {\footnotesize \NWlink{nuweb365}{365}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$Send a message from the feedback form\nobreak\ {\footnotesize \NWlink{nuweb370}{370}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$Send copy to the submitter\nobreak\ {\footnotesize \NWlink{nuweb372}{372}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb370}{370}.}
\item $\langle\,$Send E-mail confirming password reset\nobreak\ {\footnotesize \NWlink{nuweb202}{202}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb199}{199}.}
\item $\langle\,$Send mail to feedback address\nobreak\ {\footnotesize \NWlink{nuweb371}{371}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb370}{370}.}
\item $\langle\,$Session Directory\nobreak\ {\footnotesize \NWlink{nuweb7e}{7e}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb186c}{186c}\NWlink{nuweb187}{, 187}\NWlink{nuweb204}{, 204}\NWlink{nuweb205}{, 205}\NWlink{nuweb248a}{, 248a}\NWlink{nuweb320}{, 320}\NWlink{nuweb330}{, 330}\NWlink{nuweb337}{, 337}\NWlink{nuweb338}{, 338}\NWlink{nuweb339}{, 339}\NWlink{nuweb342}{, 342}\NWlink{nuweb382}{, 382}\NWlink{nuweb400}{, 400}.
}
\item $\langle\,$Set cookies with JavaScript\nobreak\ {\footnotesize \NWlink{nuweb13c}{13c}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb189}{189}.}
\item $\langle\,$Set handler for termination signals\nobreak\ {\footnotesize \NWlink{nuweb174a}{174a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb173}{173}.}
\item $\langle\,$Set monthly log entry from Excel CSV record\nobreak\ {\footnotesize \NWlink{nuweb237}{237}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb234}{234}.}
\item $\langle\,$Set monthly log entry from Palm CSV record\nobreak\ {\footnotesize \NWlink{nuweb239}{239}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb238}{238}.}
\item $\langle\,$Set monthly log property variables\nobreak\ {\footnotesize \NWlink{nuweb212a}{212a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb208}{208}.}
\item $\langle\,$Set primary diet calculator fields from user object\nobreak\ {\footnotesize \NWlink{nuweb275}{275}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb274}{274}.}
\item $\langle\,$Set variables to default to previous request settings\nobreak\ {\footnotesize \NWlink{nuweb299}{299}\NWlink{nuweb300}{, 300}\NWlink{nuweb301a}{, 301a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb250}{250}\NWlink{nuweb258}{, 258}\NWlink{nuweb260}{, 260}\NWlink{nuweb265a}{, 265a}\NWlink{nuweb274}{, 274}\NWlink{nuweb295}{, 295}.
}
\item $\langle\,$Show build number and date\nobreak\ {\footnotesize \NWlink{nuweb195}{195}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb190}{190}.}
\item $\langle\,$Show feedback message in reply page\nobreak\ {\footnotesize \NWlink{nuweb373}{373}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb367}{367}\NWlink{nuweb370}{, 370}.
}
\item $\langle\,$Show preview of message being composed\nobreak\ {\footnotesize \NWlink{nuweb367}{367}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb365}{365}.}
\item $\langle\,$Show user name and account being browsed\nobreak\ {\footnotesize \NWlink{nuweb191a}{191a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb190}{190}.}
\item $\langle\,$Sign in and account management tables\nobreak\ {\footnotesize \NWlink{nuweb473b}{473b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb472}{472}.}
\item $\langle\,$Site home URL\nobreak\ {\footnotesize \NWlink{nuweb13e}{13e}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb13f}{13f}\NWlink{nuweb202}{, 202}\NWlink{nuweb246}{, 246}\NWlink{nuweb434}{, 434}\NWlink{nuweb455}{, 455}.
}
\item $\langle\,$Source distribution\nobreak\ {\footnotesize \NWlink{nuweb549}{549}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb546}{546}.}
\item $\langle\,$Specify Content-type for PNG image\nobreak\ {\footnotesize \NWlink{nuweb263b}{263b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb263a}{263a}\NWlink{nuweb303}{, 303}.
}
\item $\langle\,$Standard navigation bar functions\nobreak\ {\footnotesize \NWlink{nuweb191b}{191b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb190}{190}.}
\item $\langle\,$Static change to daily balance\nobreak\ {\footnotesize \NWlink{nuweb287b}{287b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb286}{286}.}
\item $\langle\,$Static change to desired weight change\nobreak\ {\footnotesize \NWlink{nuweb289b}{289b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb286}{286}.}
\item $\langle\,$Static change to diet duration in months\nobreak\ {\footnotesize \NWlink{nuweb291a}{291a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb286}{286}.}
\item $\langle\,$Static change to diet duration in weeks\nobreak\ {\footnotesize \NWlink{nuweb290b}{290b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb286}{286}.}
\item $\langle\,$Static change to end date\nobreak\ {\footnotesize \NWlink{nuweb292}{292}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb286}{286}.}
\item $\langle\,$Static change to energy unit\nobreak\ {\footnotesize \NWlink{nuweb287a}{287a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb286}{286}.}
\item $\langle\,$Static change to goal weight\nobreak\ {\footnotesize \NWlink{nuweb289a}{289a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb286}{286}.}
\item $\langle\,$Static change to initial weight\nobreak\ {\footnotesize \NWlink{nuweb288b}{288b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb286}{286}.}
\item $\langle\,$Static change to start date\nobreak\ {\footnotesize \NWlink{nuweb291b}{291b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb286}{286}.}
\item $\langle\,$Static change to weight change per week\nobreak\ {\footnotesize \NWlink{nuweb290a}{290a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb286}{286}.}
\item $\langle\,$Static change to weight unit\nobreak\ {\footnotesize \NWlink{nuweb288a}{288a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb286}{286}.}
\item $\langle\,$Store settings for user account\nobreak\ {\footnotesize \NWlink{nuweb308}{308}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb307b}{307b}\NWlink{nuweb313}{, 313}.
}
\item $\langle\,$Supply default values for undefined variables\nobreak\ {\footnotesize \NWlink{nuweb413a}{413a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb391}{391}.}
\item $\langle\,$Synthetic data end date\nobreak\ {\footnotesize \NWlink{nuweb362}{362}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb360}{360}.}
\item $\langle\,$Synthetic data field selection\nobreak\ {\footnotesize \NWlink{nuweb363a}{363a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb360}{360}.}
\item $\langle\,$Synthetic data start and end values\nobreak\ {\footnotesize \NWlink{nuweb363b}{363b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb360}{360}.}
\item $\langle\,$Synthetic data start date\nobreak\ {\footnotesize \NWlink{nuweb361}{361}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb360}{360}.}
\item $\langle\,$Table of perturbation functions\nobreak\ {\footnotesize \NWlink{nuweb364}{364}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb360}{360}.}
\item $\langle\,$Template\nobreak\ {\footnotesize \NWlink{nuweb386b}{386b}}$\,\rangle$ {\footnotesize {\NWtxtNoRef}.}
\item $\langle\,$Test domain valid for E-mail\nobreak\ {\footnotesize \NWlink{nuweb411}{411}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb391}{391}.}
\item $\langle\,$Test if month is the current month\nobreak\ {\footnotesize \NWlink{nuweb408}{408}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb391}{391}.}
\item $\langle\,$Test whether user has a session active\nobreak\ {\footnotesize \NWlink{nuweb400}{400}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb391}{391}.}
\item $\langle\,$Testing\nobreak\ {\footnotesize \NWlink{nuweb552a}{552a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb546}{546}.}
\item $\langle\,$Trend analysis\nobreak\ {\footnotesize \NWlink{nuweb264}{264}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$Trend analysis table\nobreak\ {\footnotesize \NWlink{nuweb475}{475}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb472}{472}.}
\item $\langle\,$TrueType Font Directory\nobreak\ {\footnotesize \NWlink{nuweb6g}{6g}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb90}{90}\NWlink{nuweb409}{, 409}.
}
\item $\langle\,$Undraw trend values starting at this day\nobreak\ {\footnotesize \NWlink{nuweb494}{494}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb493a}{493a}.}
\item $\langle\,$Unix time to civil date and time\nobreak\ {\footnotesize \NWlink{nuweb451b}{451b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb445}{445}.}
\item $\langle\,$Unix time to Julian day and fraction\nobreak\ {\footnotesize \NWlink{nuweb450b}{450b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb445}{445}.}
\item $\langle\,$Update global statistics overall trend analysis\nobreak\ {\footnotesize \NWlink{nuweb356}{356}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb355}{355}.}
\item $\langle\,$Update last login and transaction time\nobreak\ {\footnotesize \NWlink{nuweb188a}{188a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb183}{183}.}
\item $\langle\,$Update monthly log\nobreak\ {\footnotesize \NWlink{nuweb219}{219}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$Update persistent login state\nobreak\ {\footnotesize \NWlink{nuweb189}{189}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb183}{183}.}
\item $\langle\,$Update the mean and most recent body mass index\nobreak\ {\footnotesize \NWlink{nuweb501}{501}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb493a}{493a}.}
\item $\langle\,$Update the trend and variance for this and subsequent days\nobreak\ {\footnotesize \NWlink{nuweb498}{498}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb493a}{493a}.}
\item $\langle\,$Update time of user's last transaction\nobreak\ {\footnotesize \NWlink{nuweb398}{398}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb391}{391}.}
\item $\langle\,$Update user account information\nobreak\ {\footnotesize \NWlink{nuweb309}{309}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb199}{199}\NWlink{nuweb244}{, 244}\NWlink{nuweb293}{, 293}\NWlink{nuweb307b}{, 307b}\NWlink{nuweb313}{, 313}.
}
\item $\langle\,$Update Web page badge\nobreak\ {\footnotesize \NWlink{nuweb220b}{220b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb220a}{220a}\NWlink{nuweb244}{, 244}.
}
\item $\langle\,$Update Web page status badge\nobreak\ {\footnotesize \NWlink{nuweb244}{244}\NWlink{nuweb245}{, 245}\NWlink{nuweb246}{, 246}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb179}{179}.}
\item $\langle\,$URL to invoke this program\nobreak\ {\footnotesize \NWlink{nuweb14b}{14b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb14c}{14c}\NWlink{nuweb126}{, 126}\NWlink{nuweb190}{, 190}\NWlink{nuweb191b}{, 191b}\NWlink{nuweb192}{, 192}\NWlink{nuweb193}{, 193}\NWlink{nuweb194}{, 194}\NWlink{nuweb200}{, 200}\NWlink{nuweb201}{, 201}\NWlink{nuweb202}{, 202}\NWlink{nuweb207}{, 207}\NWlink{nuweb208}{, 208}\NWlink{nuweb211}{, 211}\NWlink{nuweb222}{, 222}\NWlink{nuweb224}{, 224}\NWlink{nuweb225}{, 225}\NWlink{nuweb226a}{, 226a}\NWlink{nuweb246}{, 246}\NWlink{nuweb247}{, 247}\NWlink{nuweb252}{, 252}\NWlink{nuweb262}{, 262}\NWlink{nuweb264}{, 264}\NWlink{nuweb297}{, 297}\NWlink{nuweb313}{, 313}\NWlink{nuweb315}{, 315}\NWlink{nuweb320}{, 320}\NWlink{nuweb321}{, 321}\NWlink{nuweb330}{, 330}\NWlink{nuweb331}{, 331}\NWlink{nuweb332}{, 332}\NWlink{nuweb333}{, 333}\NWlink{nuweb334}{, 334}\NWlink{nuweb335}{, 335}\NWlink{nuweb340}{, 340}\NWlink{nuweb341}{, 341}\NWlink{nuweb342}{, 342}\NWlink{nuweb347}{, 347}\NWlink{nuweb370}{, 370}\NWlink{nuweb377}{, 377}\NWlink{nuweb378a}{, 378a}\NWlink{nuweb378b}{b}\NWlink{nuweb379b}{, 379b}\NWlink{nuweb381a}{, 381a}\NWlink{nuweb382}{, 382}\NWlink{nuweb383a}{, 383a}\NWlink{nuweb383b}{b}\NWlink{nuweb384a}{, 384a}\NWlink{nuweb385a}{, 385a}\NWlink{nuweb435}{, 435}\NWlink{nuweb483b}{, 483b}.
}
\item $\langle\,$User login name text field\nobreak\ {\footnotesize \NWlink{nuweb129a}{129a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb127}{127}.}
\item $\langle\,$User's full name optional text fields\nobreak\ {\footnotesize \NWlink{nuweb131b}{131b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb127}{127}.}
\item $\langle\,$Users Directory\nobreak\ {\footnotesize \NWlink{nuweb7f}{7f}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb85}{85}\NWlink{nuweb110}{, 110}\NWlink{nuweb112}{, 112}\NWlink{nuweb113a}{, 113a}\NWlink{nuweb116}{, 116}\NWlink{nuweb117}{, 117}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb183}{, 183}\NWlink{nuweb184}{, 184}\NWlink{nuweb186c}{, 186c}\NWlink{nuweb187}{, 187}\NWlink{nuweb188a}{, 188a}\NWlink{nuweb199}{, 199}\NWlink{nuweb204}{, 204}\NWlink{nuweb206}{, 206}\NWlink{nuweb210}{, 210}\NWlink{nuweb214}{, 214}\NWlink{nuweb220a}{, 220a}\NWlink{nuweb220b}{b}\NWlink{nuweb236}{, 236}\NWlink{nuweb240a}{, 240a}\NWlink{nuweb244}{, 244}\NWlink{nuweb254}{, 254}\NWlink{nuweb255}{, 255}\NWlink{nuweb256}{, 256}\NWlink{nuweb257}{, 257}\NWlink{nuweb262}{, 262}\NWlink{nuweb306a}{, 306a}\NWlink{nuweb307b}{, 307b}\NWlink{nuweb309}{, 309}\NWlink{nuweb319}{, 319}\NWlink{nuweb327}{, 327}\NWlink{nuweb329}{, 329}\NWlink{nuweb330}{, 330}\NWlink{nuweb333}{, 333}\NWlink{nuweb335}{, 335}\NWlink{nuweb368}{, 368}\NWlink{nuweb377}{, 377}\NWlink{nuweb382}{, 382}\NWlink{nuweb392}{, 392}\NWlink{nuweb393b}{, 393b}\NWlink{nuweb394}{, 394}\NWlink{nuweb395b}{, 395b}\NWlink{nuweb397}{, 397}\NWlink{nuweb398}{, 398}\NWlink{nuweb399a}{, 399a}\NWlink{nuweb400}{, 400}\NWlink{nuweb459}{, 459}\NWlink{nuweb461}{, 461}.
}
\item $\langle\,$Utility functions\nobreak\ {\footnotesize \NWlink{nuweb391}{391}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb173}{173}\NWlink{nuweb461}{, 461}.
}
\item $\langle\,$Utility functions for regular session\nobreak\ {\footnotesize \NWlink{nuweb192}{192}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb190}{190}.}
\item $\langle\,$Validate administrator password\nobreak\ {\footnotesize \NWlink{nuweb340}{340}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb332}{332}\NWlink{nuweb334}{, 334}\NWlink{nuweb339}{, 339}\NWlink{nuweb346}{, 346}.
}
\item $\langle\,$Validate beta test invitation code\nobreak\ {\footnotesize \NWlink{nuweb306b}{306b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb305}{305}.}
\item $\langle\,$Validate E-mail address agrees with specification in reset request\nobreak\ {\footnotesize \NWlink{nuweb200}{200}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb199}{199}.}
\item $\langle\,$Validate option specifications\nobreak\ {\footnotesize \NWlink{nuweb389b}{389b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb173}{173}.}
\item $\langle\,$Validate specified session\nobreak\ {\footnotesize \NWlink{nuweb342}{342}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb339}{339}.}
\item $\langle\,$Validate user login request\nobreak\ {\footnotesize \NWlink{nuweb183}{183}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb180a}{180a}.}
\item $\langle\,$Validate user name and password\nobreak\ {\footnotesize \NWlink{nuweb184}{184}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb183}{183}.}
\item $\langle\,$Validate user name for new account\nobreak\ {\footnotesize \NWlink{nuweb306a}{306a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb305}{305}.}
\item $\langle\,$Verify that user has administrator privilege\nobreak\ {\footnotesize \NWlink{nuweb331}{331}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb322}{322}\NWlink{nuweb323}{, 323}\NWlink{nuweb325}{, 325}\NWlink{nuweb330}{, 330}\NWlink{nuweb332}{, 332}\NWlink{nuweb334}{, 334}\NWlink{nuweb336}{, 336}\NWlink{nuweb339}{, 339}\NWlink{nuweb343}{, 343}\NWlink{nuweb346}{, 346}\NWlink{nuweb348}{, 348}\NWlink{nuweb358}{, 358}.
}
\item $\langle\,$Version\nobreak\ {\footnotesize \NWlink{nuweb3a}{3a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb389a}{389a}\NWlink{nuweb404}{, 404}\NWlink{nuweb455}{, 455}\NWlink{nuweb549}{, 549}\NWlink{nuweb550}{, 550}.
}
\item $\langle\,$Warn user about consequences of closing account\nobreak\ {\footnotesize \NWlink{nuweb381b}{381b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb380}{380}.}
\item $\langle\,$Web Directory\nobreak\ {\footnotesize \NWlink{nuweb6a}{6a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb546}{546}.}
\item $\langle\,$Web Document Home\nobreak\ {\footnotesize \NWlink{nuweb5d}{5d}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb173}{173}\NWlink{nuweb208}{, 208}\NWlink{nuweb246}{, 246}\NWlink{nuweb467b}{, 467b}.
}
\item $\langle\,$Weight and energy unit radio buttons\nobreak\ {\footnotesize \NWlink{nuweb133}{133}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb127}{127}.}
\item $\langle\,$Wrap long lines onto multiple lines\nobreak\ {\footnotesize \NWlink{nuweb403}{403}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb391}{391}.}
\item $\langle\,$Write back all items in the cache\nobreak\ {\footnotesize \NWlink{nuweb113a}{113a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb105}{105}.}
\item $\langle\,$Write back logs modified by database import\nobreak\ {\footnotesize \NWlink{nuweb240a}{240a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb228b}{228b}.}
\item $\langle\,$Write HTML table footer\nobreak\ {\footnotesize \NWlink{nuweb40b}{40b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb36}{36}.}
\item $\langle\,$Write HTML table header\nobreak\ {\footnotesize \NWlink{nuweb37a}{37a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb36}{36}.}
\item $\langle\,$Write modified log back to database\nobreak\ {\footnotesize \NWlink{nuweb395b}{395b}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb393b}{393b}\NWlink{nuweb394}{, 394}.
}
\item $\langle\,$Write updated log item back to database\nobreak\ {\footnotesize \NWlink{nuweb220a}{220a}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb219}{219}.}
\item $\langle\,$Write XHTML epilogue\nobreak\ {\footnotesize \NWlink{nuweb438}{438}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb431}{431}.}
\item $\langle\,$Write XHTML prologue\nobreak\ {\footnotesize \NWlink{nuweb432}{432}\NWlink{nuweb433}{, 433}\NWlink{nuweb434}{, 434}}$\,\rangle$ {\footnotesize {\NWtxtRefIn} \NWlink{nuweb431}{431}.}
\end{list}}

\section{Identifiers}

Sections which define identifiers are underlined.


{\small\begin{list}{}{\setlength{\itemsep}{-\parsep}\setlength{\itemindent}{-\leftmargin}}
\item \verb@$chartSizes@: \NWlink{nuweb301a}{301a}\NWlink{nuweb302c}{, 302c}, \underline{\NWlink{nuweb388b}{388b}}.
\item \verb@$feedback_categories@: \NWlink{nuweb367}{367}\NWlink{nuweb370}{, 370}, \underline{\NWlink{nuweb388b}{388b}}.
\item \verb@$monthNames@: \NWlink{nuweb208}{208}\NWlink{nuweb211}{, 211}\NWlink{nuweb222}{, 222}, \underline{\NWlink{nuweb388b}{388b}}.
\item \verb@$testmode@: \underline{\NWlink{nuweb388b}{388b}}\NWlink{nuweb389a}{, 389a}.
\item \verb@$verbose@: \underline{\NWlink{nuweb388b}{388b}}\NWlink{nuweb389a}{, 389a}\NWlink{nuweb406a}{, 406a}\NWlink{nuweb421a}{, 421a}\NWlink{nuweb423b}{, 423b}\NWlink{nuweb425}{, 425}\NWlink{nuweb426}{, 426}\NWlink{nuweb429b}{, 429b}.
\item \verb@addPoint@: \NWlink{nuweb18}{18}, \underline{\NWlink{nuweb20a}{20a}}\NWlink{nuweb28}{, 28}\NWlink{nuweb77}{, 77}\NWlink{nuweb81}{, 81}\NWlink{nuweb351}{, 351}\NWlink{nuweb356}{, 356}.
\item \verb@analyseTrend@: \underline{\NWlink{nuweb79}{79}}\NWlink{nuweb80}{, 80}\NWlink{nuweb100}{, 100}\NWlink{nuweb102b}{, 102b}\NWlink{nuweb215}{, 215}\NWlink{nuweb267}{, 267}.
\item \verb@append_history@: \NWlink{nuweb186a}{186a}\NWlink{nuweb186c}{c}\NWlink{nuweb188b}{, 188b}\NWlink{nuweb199}{, 199}\NWlink{nuweb200}{, 200}\NWlink{nuweb204}{, 204}\NWlink{nuweb220a}{, 220a}\NWlink{nuweb229}{, 229}\NWlink{nuweb246}{, 246}\NWlink{nuweb247}{, 247}\NWlink{nuweb293}{, 293}\NWlink{nuweb314}{, 314}\NWlink{nuweb316}{, 316}\NWlink{nuweb331}{, 331}\NWlink{nuweb333}{, 333}\NWlink{nuweb339}{, 339}\NWlink{nuweb340}{, 340}\NWlink{nuweb346}{, 346}\NWlink{nuweb370}{, 370}\NWlink{nuweb377}{, 377}, \underline{\NWlink{nuweb397}{397}}.
\item \verb@assignPublicName@: \underline{\NWlink{nuweb167}{167}}\NWlink{nuweb308}{, 308}.
\item \verb@bnd@: \NWlink{nuweb39a}{39a}, \underline{\NWlink{nuweb43a}{43a}}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}.
\item \verb@bodyMassIndex@: \underline{\NWlink{nuweb29}{29}}\NWlink{nuweb212a}{, 212a}.
\item \verb@calc_calorie_balance@: \NWlink{nuweb120}{120}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb139}{, 139}\NWlink{nuweb142}{, 142}\NWlink{nuweb255}{, 255}\NWlink{nuweb275}{, 275}\NWlink{nuweb278b}{, 278b}\NWlink{nuweb284}{, 284}\NWlink{nuweb285}{, 285}\NWlink{nuweb287a}{, 287a}\NWlink{nuweb287b}{b}\NWlink{nuweb290a}{, 290a}\NWlink{nuweb290b}{b}\NWlink{nuweb291a}{, 291a}\NWlink{nuweb292}{, 292}\NWlink{nuweb293}{, 293}, \underline{\NWlink{nuweb505}{505}}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb514b}{, 514b}.
\item \verb@calc_end_date@: \NWlink{nuweb275}{275}\NWlink{nuweb277a}{, 277a}\NWlink{nuweb277b}{b}\NWlink{nuweb284}{, 284}, \underline{\NWlink{nuweb505}{505}}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb514b}{, 514b}.
\item \verb@calc_energy_unit,@: \underline{\NWlink{nuweb505}{505}}.
\item \verb@calc_goal_weight@: \NWlink{nuweb120}{120}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb139}{, 139}\NWlink{nuweb142}{, 142}\NWlink{nuweb255}{, 255}\NWlink{nuweb274}{, 274}\NWlink{nuweb275}{, 275}\NWlink{nuweb279b}{, 279b}\NWlink{nuweb284}{, 284}\NWlink{nuweb285}{, 285}\NWlink{nuweb288a}{, 288a}\NWlink{nuweb289a}{, 289a}\NWlink{nuweb289b}{b}\NWlink{nuweb293}{, 293}, \underline{\NWlink{nuweb505}{505}}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb510b}{, 510b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}.
\item \verb@calc_months@: \NWlink{nuweb275}{275}\NWlink{nuweb281}{, 281}\NWlink{nuweb284}{, 284}\NWlink{nuweb291a}{, 291a}\NWlink{nuweb505}{, 505}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}, \underline{\NWlink{nuweb513a}{513a}}.
\item \verb@calc_months,@: \NWlink{nuweb275}{275}, \underline{\NWlink{nuweb505}{505}}.
\item \verb@calc_start_date@: \NWlink{nuweb120}{120}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb139}{, 139}\NWlink{nuweb142}{, 142}\NWlink{nuweb255}{, 255}\NWlink{nuweb275}{, 275}\NWlink{nuweb277a}{, 277a}\NWlink{nuweb277b}{b}\NWlink{nuweb284}{, 284}\NWlink{nuweb285}{, 285}\NWlink{nuweb291b}{, 291b}\NWlink{nuweb292}{, 292}\NWlink{nuweb293}{, 293}, \underline{\NWlink{nuweb505}{505}}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb513b}{, 513b}\NWlink{nuweb514b}{, 514b}.
\item \verb@calc_start_weight@: \NWlink{nuweb120}{120}\NWlink{nuweb122}{, 122}\NWlink{nuweb123}{, 123}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb139}{, 139}\NWlink{nuweb142}{, 142}\NWlink{nuweb255}{, 255}\NWlink{nuweb274}{, 274}\NWlink{nuweb275}{, 275}\NWlink{nuweb279a}{, 279a}\NWlink{nuweb284}{, 284}\NWlink{nuweb285}{, 285}\NWlink{nuweb288a}{, 288a}\NWlink{nuweb288b}{b}\NWlink{nuweb289b}{, 289b}\NWlink{nuweb293}{, 293}, \underline{\NWlink{nuweb505}{505}}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511b}{, 511b}.
\item \verb@calc_weeks@: \NWlink{nuweb275}{275}\NWlink{nuweb281}{, 281}\NWlink{nuweb284}{, 284}\NWlink{nuweb290b}{, 290b}, \underline{\NWlink{nuweb505}{505}}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}, \underline{\NWlink{nuweb512b}{512b}}.
\item \verb@calc_weight_change,@: \NWlink{nuweb274}{274}\NWlink{nuweb275}{, 275}, \underline{\NWlink{nuweb505}{505}}\NWlink{nuweb507}{, 507}.
\item \verb@calc_weight_unit,@: \NWlink{nuweb274}{274}\NWlink{nuweb275}{, 275}, \underline{\NWlink{nuweb505}{505}}.
\item \verb@calc_weight_week@: \NWlink{nuweb274}{274}\NWlink{nuweb275}{, 275}\NWlink{nuweb280b}{, 280b}\NWlink{nuweb284}{, 284}\NWlink{nuweb290a}{, 290a}, \underline{\NWlink{nuweb505}{505}}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}\NWlink{nuweb512a}{, 512a}.
\item \verb@CALORIES_PER_ENERGY_UNIT@: \underline{\NWlink{nuweb24}{24}}\NWlink{nuweb100}{, 100}\NWlink{nuweb102b}{, 102b}\NWlink{nuweb215}{, 215}\NWlink{nuweb268}{, 268}\NWlink{nuweb351}{, 351}\NWlink{nuweb352}{, 352}\NWlink{nuweb481}{, 481}\NWlink{nuweb506}{, 506}\NWlink{nuweb507}{, 507}.
\item \verb@CALORIES_PER_WEIGHT_UNIT@: \NWlink{nuweb23}{23}, \underline{\NWlink{nuweb24}{24}}\NWlink{nuweb100}{, 100}\NWlink{nuweb102b}{, 102b}\NWlink{nuweb142}{, 142}\NWlink{nuweb215}{, 215}\NWlink{nuweb268}{, 268}\NWlink{nuweb284}{, 284}\NWlink{nuweb290a}{, 290a}\NWlink{nuweb290b}{b}\NWlink{nuweb291a}{, 291a}\NWlink{nuweb292}{, 292}\NWlink{nuweb351}{, 351}\NWlink{nuweb352}{, 352}\NWlink{nuweb481}{, 481}\NWlink{nuweb500}{, 500}\NWlink{nuweb507}{, 507}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb514b}{, 514b}.
\item \verb@canonicalNumber@: \NWlink{nuweb128}{128}, \underline{\NWlink{nuweb146a}{146a}}\NWlink{nuweb147}{, 147}, \underline{\NWlink{nuweb519a}{519a}}\NWlink{nuweb519b}{, 519b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}.
\item \verb@canonicalWeight@: \NWlink{nuweb41b}{41b}, \underline{\NWlink{nuweb42a}{42a}}\NWlink{nuweb396}{, 396}.
\item \verb@changeComment@: \NWlink{nuweb40a}{40a}, \underline{\NWlink{nuweb504}{504}}.
\item \verb@changeRung@: \NWlink{nuweb39a}{39a}, \underline{\NWlink{nuweb502}{502}}.
\item \verb@changeWeight@: \NWlink{nuweb38}{38}, \underline{\NWlink{nuweb493a}{493a}}.
\item \verb@change_calc_calorie_balance@: \NWlink{nuweb278b}{278b}, \underline{\NWlink{nuweb509a}{509a}}.
\item \verb@change_calc_energy_unit@: \NWlink{nuweb278b}{278b}, \underline{\NWlink{nuweb509b}{509b}}.
\item \verb@change_calc_goal_weight@: \NWlink{nuweb279b}{279b}, \underline{\NWlink{nuweb511a}{511a}}.
\item \verb@change_calc_plot_plan@: \NWlink{nuweb283}{283}, \underline{\NWlink{nuweb515}{515}}.
\item \verb@change_calc_start_weight@: \NWlink{nuweb279a}{279a}, \underline{\NWlink{nuweb510a}{510a}}.
\item \verb@change_calc_weight_change@: \NWlink{nuweb280a}{280a}, \underline{\NWlink{nuweb511b}{511b}}.
\item \verb@change_calc_weight_unit@: \NWlink{nuweb279a}{279a}, \underline{\NWlink{nuweb510b}{510b}}.
\item \verb@change_calc_weight_week@: \NWlink{nuweb280b}{280b}, \underline{\NWlink{nuweb512a}{512a}}.
\item \verb@change_from_d@: \NWlink{nuweb272}{272}, \underline{\NWlink{nuweb513b}{513b}}.
\item \verb@change_from_date@: \underline{\NWlink{nuweb513b}{513b}}.
\item \verb@change_from_m@: \NWlink{nuweb272}{272}, \underline{\NWlink{nuweb513b}{513b}}.
\item \verb@change_from_y@: \NWlink{nuweb272}{272}, \underline{\NWlink{nuweb513b}{513b}}.
\item \verb@change_to_d@: \NWlink{nuweb273}{273}, \underline{\NWlink{nuweb514b}{514b}}.
\item \verb@change_to_date@: \underline{\NWlink{nuweb514b}{514b}}.
\item \verb@change_to_m@: \NWlink{nuweb273}{273}, \underline{\NWlink{nuweb514b}{514b}}.
\item \verb@change_to_y@: \NWlink{nuweb273}{273}, \underline{\NWlink{nuweb514b}{514b}}.
\item \verb@characterFrequency@: \NWlink{nuweb525}{525}, \underline{\NWlink{nuweb527}{527}}.
\item \verb@checkCookieSignature@: \NWlink{nuweb154}{154}\NWlink{nuweb160}{, 160}, \underline{\NWlink{nuweb161}{161}}.
\item \verb@checkPasswordMatch@: \NWlink{nuweb130}{130}, \underline{\NWlink{nuweb528}{528}}.
\item \verb@checkSecure@: \NWlink{nuweb182}{182}\NWlink{nuweb185a}{, 185a}\NWlink{nuweb186a}{, 186a}\NWlink{nuweb197}{, 197}, \underline{\NWlink{nuweb483b}{483b}}.
\item \verb@civil_time_to_jd@: \NWlink{nuweb445}{445}, \underline{\NWlink{nuweb449b}{449b}}.
\item \verb@computeChartScale@: \underline{\NWlink{nuweb45}{45}}\NWlink{nuweb212a}{, 212a}.
\item \verb@computeTrend@: \underline{\NWlink{nuweb28}{28}}\NWlink{nuweb33b}{, 33b}\NWlink{nuweb215}{, 215}\NWlink{nuweb394}{, 394}.
\item \verb@convertWeight@: \underline{\NWlink{nuweb41b}{41b}}\NWlink{nuweb57}{, 57}.
\item \verb@countChange@: \underline{\NWlink{nuweb484a}{484a}}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb502}{, 502}\NWlink{nuweb504}{, 504}\NWlink{nuweb507}{, 507}\NWlink{nuweb515}{, 515}\NWlink{nuweb524b}{, 524b}.
\item \verb@decodeComments@: \NWlink{nuweb35a}{35a}, \underline{\NWlink{nuweb73}{73}}.
\item \verb@decodeEncryptedUserID@: \underline{\NWlink{nuweb144}{144}}\NWlink{nuweb459}{, 459}\NWlink{nuweb461}{, 461}.
\item \verb@deletePublicName@: \underline{\NWlink{nuweb169a}{169a}}\NWlink{nuweb308}{, 308}.
\item \verb@describe@: \underline{\NWlink{nuweb27}{27}}\NWlink{nuweb105}{, 105}, \underline{\NWlink{nuweb122}{122}}, \underline{\NWlink{nuweb150}{150}}, \underline{\NWlink{nuweb156a}{156a}}\NWlink{nuweb170a}{, 170a}\NWlink{nuweb218}{, 218}\NWlink{nuweb316}{, 316}\NWlink{nuweb461}{, 461}.
\item \verb@determineTimeZoneOffset@: \NWlink{nuweb483a}{483a}, \underline{\NWlink{nuweb518}{518}}.
\item \verb@dietCalcRecalculate@: \underline{\NWlink{nuweb507}{507}}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb513b}{b}\NWlink{nuweb514b}{, 514b}.
\item \verb@dietPlanLimits@: \underline{\NWlink{nuweb142}{142}}\NWlink{nuweb212a}{, 212a}\NWlink{nuweb263a}{, 263a}\NWlink{nuweb303}{, 303}.
\item \verb@dnz@: \NWlink{nuweb31}{31}, \underline{\NWlink{nuweb42b}{42b}}\NWlink{nuweb46}{, 46}\NWlink{nuweb49}{, 49}\NWlink{nuweb50}{, 50}\NWlink{nuweb54}{, 54}.
\item \verb@do_command@: \NWlink{nuweb113a}{113a}\NWlink{nuweb220b}{, 220b}\NWlink{nuweb335}{, 335}\NWlink{nuweb379a}{, 379a}\NWlink{nuweb382}{, 382}\NWlink{nuweb392}{, 392}, \underline{\NWlink{nuweb406a}{406a}}.
\item \verb@drawBadgeImage@: \underline{\NWlink{nuweb101a}{101a}}\NWlink{nuweb113a}{, 113a}\NWlink{nuweb220b}{, 220b}\NWlink{nuweb392}{, 392}\NWlink{nuweb461}{, 461}.
\item \verb@drawChart@: \NWlink{nuweb80}{80}, \underline{\NWlink{nuweb82}{82}}\NWlink{nuweb84}{, 84}\NWlink{nuweb303}{, 303}.
\item \verb@drawText@: \NWlink{nuweb48b}{48b}\NWlink{nuweb49}{, 49}\NWlink{nuweb55}{, 55}\NWlink{nuweb91}{, 91}\NWlink{nuweb92}{, 92}\NWlink{nuweb93}{, 93}\NWlink{nuweb94}{, 94}\NWlink{nuweb99}{, 99}\NWlink{nuweb100}{, 100}\NWlink{nuweb103a}{, 103a}\NWlink{nuweb103b}{b}\NWlink{nuweb104}{, 104}, \underline{\NWlink{nuweb409}{409}}.
\item \verb@editWeight@: \underline{\NWlink{nuweb41a}{41a}}\NWlink{nuweb44a}{, 44a}\NWlink{nuweb55}{, 55}\NWlink{nuweb93}{, 93}\NWlink{nuweb103b}{, 103b}\NWlink{nuweb268}{, 268}\NWlink{nuweb274}{, 274}, \underline{\NWlink{nuweb485a}{485a}}\NWlink{nuweb488b}{, 488b}\NWlink{nuweb489}{, 489}\NWlink{nuweb497}{, 497}\NWlink{nuweb498}{, 498}\NWlink{nuweb507}{, 507}.
\item \verb@encodeComments@: \NWlink{nuweb31}{31}, \underline{\NWlink{nuweb72}{72}}.
\item \verb@encodeCSV@: \NWlink{nuweb15}{15}, \underline{\NWlink{nuweb17}{17}}\NWlink{nuweb64}{, 64}\NWlink{nuweb255}{, 255}.
\item \verb@encodeDomainName@: \NWlink{nuweb305}{305}\NWlink{nuweb313}{, 313}, \underline{\NWlink{nuweb410}{410}}.
\item \verb@ENERGY_CALORIE@: \NWlink{nuweb23}{23}, \underline{\NWlink{nuweb24}{24}}\NWlink{nuweb120}{, 120}\NWlink{nuweb275}{, 275}\NWlink{nuweb284}{, 284}\NWlink{nuweb290a}{, 290a}\NWlink{nuweb292}{, 292}\NWlink{nuweb293}{, 293}.
\item \verb@ENERGY_CONVERSION@: \NWlink{nuweb23}{23}, \underline{\NWlink{nuweb24}{24}}\NWlink{nuweb275}{, 275}\NWlink{nuweb284}{, 284}\NWlink{nuweb287a}{, 287a}\NWlink{nuweb290a}{, 290a}\NWlink{nuweb292}{, 292}\NWlink{nuweb293}{, 293}\NWlink{nuweb481}{, 481}\NWlink{nuweb509b}{, 509b}.
\item \verb@ENERGY_KILOJOULE@: \NWlink{nuweb23}{23}, \underline{\NWlink{nuweb24}{24}}.
\item \verb@ENERGY_UNITS@: \underline{\NWlink{nuweb24}{24}}\NWlink{nuweb100}{, 100}\NWlink{nuweb122}{, 122}\NWlink{nuweb138}{, 138}\NWlink{nuweb215}{, 215}\NWlink{nuweb255}{, 255}\NWlink{nuweb267}{, 267}.
\item \verb@enumerateMonths@: \NWlink{nuweb108}{108}\NWlink{nuweb109a}{, 109a}, \underline{\NWlink{nuweb140}{140}}\NWlink{nuweb214}{, 214}\NWlink{nuweb222}{, 222}\NWlink{nuweb251a}{, 251a}\NWlink{nuweb254}{, 254}\NWlink{nuweb255}{, 255}\NWlink{nuweb256}{, 256}\NWlink{nuweb257}{, 257}\NWlink{nuweb271a}{, 271a}\NWlink{nuweb319}{, 319}\NWlink{nuweb327}{, 327}\NWlink{nuweb333}{, 333}\NWlink{nuweb335}{, 335}\NWlink{nuweb374}{, 374}\NWlink{nuweb377}{, 377}\NWlink{nuweb380}{, 380}\NWlink{nuweb382}{, 382}\NWlink{nuweb392}{, 392}.
\item \verb@enumerateYears@: \NWlink{nuweb109b}{109b}, \underline{\NWlink{nuweb141}{141}}\NWlink{nuweb221}{, 221}\NWlink{nuweb250}{, 250}\NWlink{nuweb264}{, 264}\NWlink{nuweb277a}{, 277a}\NWlink{nuweb294}{, 294}.
\item \verb@etime@: \underline{\NWlink{nuweb406b}{406b}}.
\item \verb@expandAbbreviatedWeight@: \underline{\NWlink{nuweb488b}{488b}}\NWlink{nuweb493a}{, 493a}.
\item \verb@expireCookie@: \underline{\NWlink{nuweb158b}{158b}}\NWlink{nuweb189}{, 189}.
\item \verb@exportCSV@: \underline{\NWlink{nuweb64}{64}}\NWlink{nuweb248b}{, 248b}\NWlink{nuweb255}{, 255}.
\item \verb@exportDietPlanXML@: \underline{\NWlink{nuweb139}{139}}\NWlink{nuweb254}{, 254}.
\item \verb@exportExcelCSV@: \underline{\NWlink{nuweb66}{66}}\NWlink{nuweb257}{, 257}.
\item \verb@exportHDReadCSV@: \underline{\NWlink{nuweb65}{65}}\NWlink{nuweb256}{, 256}.
\item \verb@exportPreferencesXML@: \underline{\NWlink{nuweb138}{138}}\NWlink{nuweb254}{, 254}.
\item \verb@exportUserInformationXML@: \underline{\NWlink{nuweb137}{137}}\NWlink{nuweb254}{, 254}.
\item \verb@exportXML@: \underline{\NWlink{nuweb68}{68}}\NWlink{nuweb249}{, 249}\NWlink{nuweb254}{, 254}.
\item \verb@externalLinks@: \NWlink{nuweb483a}{483a}, \underline{\NWlink{nuweb517}{517}}.
\item \verb@findPublicName@: \underline{\NWlink{nuweb168}{168}}\NWlink{nuweb206}{, 206}\NWlink{nuweb321}{, 321}.
\item \verb@firstDay@: \NWlink{nuweb102a}{102a}, \underline{\NWlink{nuweb109a}{109a}}\NWlink{nuweb215}{, 215}\NWlink{nuweb253}{, 253}.
\item \verb@firstDayOfInterval@: \NWlink{nuweb102b}{102b}, \underline{\NWlink{nuweb111}{111}}\NWlink{nuweb215}{, 215}\NWlink{nuweb265b}{, 265b}\NWlink{nuweb269}{, 269}\NWlink{nuweb298}{, 298}.
\item \verb@fitAddPoint@: \underline{\NWlink{nuweb487b}{487b}}\NWlink{nuweb500}{, 500}.
\item \verb@fitSlope@: \NWlink{nuweb18}{18}, \underline{\NWlink{nuweb20b}{20b}}\NWlink{nuweb28}{, 28}\NWlink{nuweb79}{, 79}\NWlink{nuweb351}{, 351}\NWlink{nuweb357}{, 357}, \underline{\NWlink{nuweb488a}{488a}}\NWlink{nuweb500}{, 500}.
\item \verb@fitStart@: \underline{\NWlink{nuweb487a}{487a}}\NWlink{nuweb500}{, 500}.
\item \verb@fit_n@: \underline{\NWlink{nuweb487a}{487a}}\NWlink{nuweb487b}{, 487b}\NWlink{nuweb488a}{, 488a}.
\item \verb@fit_s1@: \underline{\NWlink{nuweb487a}{487a}}\NWlink{nuweb487b}{, 487b}\NWlink{nuweb488a}{, 488a}.
\item \verb@fit_s2@: \underline{\NWlink{nuweb487a}{487a}}\NWlink{nuweb487b}{, 487b}\NWlink{nuweb488a}{, 488a}.
\item \verb@fit_s3@: \underline{\NWlink{nuweb487a}{487a}}\NWlink{nuweb487b}{, 487b}\NWlink{nuweb488a}{, 488a}.
\item \verb@fit_s4@: \underline{\NWlink{nuweb487a}{487a}}\NWlink{nuweb487b}{, 487b}\NWlink{nuweb488a}{, 488a}.
\item \verb@fixo@: \NWlink{nuweb38}{38}, \underline{\NWlink{nuweb43c}{43c}}.
\item \verb@floor@: \underline{\NWlink{nuweb446b}{446b}}\NWlink{nuweb447b}{, 447b}\NWlink{nuweb448}{, 448}\NWlink{nuweb450a}{, 450a}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb488b}{, 488b}\NWlink{nuweb489}{, 489}\NWlink{nuweb494}{, 494}\NWlink{nuweb495}{, 495}\NWlink{nuweb499}{, 499}\NWlink{nuweb502}{, 502}\NWlink{nuweb503}{, 503}\NWlink{nuweb519b}{, 519b}\NWlink{nuweb521}{, 521}.
\item \verb@fractionFlagged@: \underline{\NWlink{nuweb30}{30}}\NWlink{nuweb212a}{, 212a}.
\item \verb@generateCookie@: \underline{\NWlink{nuweb158a}{158a}}\NWlink{nuweb159}{, 159}.
\item \verb@generateCookieID@: \NWlink{nuweb155}{155}, \underline{\NWlink{nuweb162}{162}}.
\item \verb@generateEncryptedUserID@: \underline{\NWlink{nuweb143}{143}}\NWlink{nuweb245}{, 245}\NWlink{nuweb461}{, 461}.
\item \verb@generateRandomName@: \underline{\NWlink{nuweb165}{165}}\NWlink{nuweb166}{, 166}\NWlink{nuweb167}{, 167}.
\item \verb@generateSessionID@: \NWlink{nuweb149}{149}, \underline{\NWlink{nuweb153b}{153b}}.
\item \verb@generateUniqueName@: \NWlink{nuweb165}{165}, \underline{\NWlink{nuweb166}{166}}.
\item \verb@generateXMLepilogue@: \NWlink{nuweb249}{249}\NWlink{nuweb254}{, 254}\NWlink{nuweb440}{, 440}, \underline{\NWlink{nuweb441b}{441b}}.
\item \verb@generateXMLprologue@: \NWlink{nuweb249}{249}\NWlink{nuweb254}{, 254}\NWlink{nuweb440}{, 440}, \underline{\NWlink{nuweb441a}{441a}}.
\item \verb@generate_XHTML_navigation_bar@: \NWlink{nuweb190}{190}\NWlink{nuweb208}{, 208}\NWlink{nuweb221}{, 221}\NWlink{nuweb224}{, 224}\NWlink{nuweb227}{, 227}\NWlink{nuweb241}{, 241}\NWlink{nuweb244}{, 244}\NWlink{nuweb247}{, 247}\NWlink{nuweb250}{, 250}\NWlink{nuweb252}{, 252}\NWlink{nuweb258}{, 258}\NWlink{nuweb262}{, 262}\NWlink{nuweb264}{, 264}\NWlink{nuweb274}{, 274}\NWlink{nuweb294}{, 294}\NWlink{nuweb311}{, 311}\NWlink{nuweb312}{, 312}\NWlink{nuweb313}{, 313}\NWlink{nuweb315}{, 315}\NWlink{nuweb316}{, 316}\NWlink{nuweb317}{, 317}\NWlink{nuweb320}{, 320}\NWlink{nuweb321}{, 321}\NWlink{nuweb322}{, 322}\NWlink{nuweb323}{, 323}\NWlink{nuweb325}{, 325}\NWlink{nuweb330}{, 330}\NWlink{nuweb331}{, 331}\NWlink{nuweb332}{, 332}\NWlink{nuweb334}{, 334}\NWlink{nuweb336}{, 336}\NWlink{nuweb340}{, 340}\NWlink{nuweb341}{, 341}\NWlink{nuweb342}{, 342}\NWlink{nuweb343}{, 343}\NWlink{nuweb347}{, 347}\NWlink{nuweb348}{, 348}\NWlink{nuweb358}{, 358}\NWlink{nuweb365}{, 365}\NWlink{nuweb370}{, 370}\NWlink{nuweb374}{, 374}\NWlink{nuweb377}{, 377}\NWlink{nuweb380}{, 380}\NWlink{nuweb382}{, 382}\NWlink{nuweb431}{, 431}, \underline{\NWlink{nuweb435}{435}}.
\item \verb@getDays@: \underline{\NWlink{nuweb77}{77}}\NWlink{nuweb81}{, 81}\NWlink{nuweb96}{, 96}\NWlink{nuweb98}{, 98}.
\item \verb@get_selected_date@: \NWlink{nuweb506}{506}\NWlink{nuweb513b}{, 513b}, \underline{\NWlink{nuweb514a}{514a}}\NWlink{nuweb514b}{, 514b}.
\item \verb@GREGORIAN_EPOCH@: \underline{\NWlink{nuweb445}{445}}\NWlink{nuweb446a}{, 446a}\NWlink{nuweb447b}{, 447b}\NWlink{nuweb448}{, 448}.
\item \verb@gregorian_to_jd@: \NWlink{nuweb36}{36}\NWlink{nuweb52}{, 52}\NWlink{nuweb66}{, 66}\NWlink{nuweb80}{, 80}\NWlink{nuweb84}{, 84}\NWlink{nuweb90}{, 90}\NWlink{nuweb91}{, 91}\NWlink{nuweb92}{, 92}\NWlink{nuweb102a}{, 102a}\NWlink{nuweb102b}{b}\NWlink{nuweb111}{, 111}\NWlink{nuweb117}{, 117}\NWlink{nuweb158b}{, 158b}\NWlink{nuweb215}{, 215}\NWlink{nuweb253}{, 253}\NWlink{nuweb260}{, 260}\NWlink{nuweb261}{, 261}\NWlink{nuweb265b}{, 265b}\NWlink{nuweb266}{, 266}\NWlink{nuweb269}{, 269}\NWlink{nuweb291b}{, 291b}\NWlink{nuweb292}{, 292}\NWlink{nuweb293}{, 293}\NWlink{nuweb298}{, 298}\NWlink{nuweb349}{, 349}\NWlink{nuweb408}{, 408}\NWlink{nuweb445}{, 445}, \underline{\NWlink{nuweb447b}{447b}}\NWlink{nuweb448}{, 448}.
\item \verb@height_changed_cm@: \NWlink{nuweb132}{132}, \underline{\NWlink{nuweb519b}{519b}}.
\item \verb@height_changed_ft@: \NWlink{nuweb132}{132}, \underline{\NWlink{nuweb520}{520}}.
\item \verb@height_changed_in@: \NWlink{nuweb132}{132}, \underline{\NWlink{nuweb521}{521}}.
\item \verb@html@: \NWlink{nuweb14a}{14a}\NWlink{nuweb23}{, 23}\NWlink{nuweb118}{, 118}\NWlink{nuweb387a}{, 387a}\NWlink{nuweb390a}{, 390a}, \underline{\NWlink{nuweb431}{431}}\NWlink{nuweb433}{, 433}\NWlink{nuweb438}{, 438}\NWlink{nuweb544}{, 544}\NWlink{nuweb545}{, 545}\NWlink{nuweb549}{, 549}\NWlink{nuweb550}{, 550}\NWlink{nuweb552a}{, 552a}\NWlink{nuweb552b}{b}.
\item \verb@importCSV@: \underline{\NWlink{nuweb63}{63}}\NWlink{nuweb239}{, 239}.
\item \verb@in@: \NWlink{nuweb16}{16}\NWlink{nuweb17}{, 17}\NWlink{nuweb24}{, 24}\NWlink{nuweb27}{, 27}\NWlink{nuweb32a}{, 32a}\NWlink{nuweb32b}{b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb35a}{, 35a}\NWlink{nuweb54}{, 54}\NWlink{nuweb75}{, 75}\NWlink{nuweb85}{, 85}\NWlink{nuweb94}{, 94}\NWlink{nuweb95}{, 95}\NWlink{nuweb97}{, 97}\NWlink{nuweb124a}{, 124a}\NWlink{nuweb152a}{, 152a}\NWlink{nuweb153a}{, 153a}\NWlink{nuweb157a}{, 157a}\NWlink{nuweb168}{, 168}\NWlink{nuweb171a}{, 171a}\NWlink{nuweb173}{, 173}\NWlink{nuweb198}{, 198}\NWlink{nuweb201}{, 201}\NWlink{nuweb209}{, 209}\NWlink{nuweb224}{, 224}\NWlink{nuweb226a}{, 226a}\NWlink{nuweb245}{, 245}\NWlink{nuweb261}{, 261}\NWlink{nuweb276b}{, 276b}\NWlink{nuweb277a}{, 277a}\NWlink{nuweb283}{, 283}\NWlink{nuweb286}{, 286}\NWlink{nuweb290b}{, 290b}\NWlink{nuweb291a}{, 291a}\NWlink{nuweb305}{, 305}\NWlink{nuweb310}{, 310}\NWlink{nuweb311}{, 311}\NWlink{nuweb312}{, 312}\NWlink{nuweb313}{, 313}\NWlink{nuweb315}{, 315}\NWlink{nuweb316}{, 316}\NWlink{nuweb317}{, 317}\NWlink{nuweb325}{, 325}\NWlink{nuweb335}{, 335}\NWlink{nuweb339}{, 339}\NWlink{nuweb348}{, 348}\NWlink{nuweb350}{, 350}\NWlink{nuweb351}{, 351}\NWlink{nuweb374}{, 374}\NWlink{nuweb376}{, 376}\NWlink{nuweb378b}{, 378b}\NWlink{nuweb380}{, 380}\NWlink{nuweb381a}{, 381a}\NWlink{nuweb381b}{b}\NWlink{nuweb383b}{, 383b}\NWlink{nuweb384a}{, 384a}\NWlink{nuweb389a}{, 389a}\NWlink{nuweb399a}{, 399a}\NWlink{nuweb412}{, 412}, \underline{\NWlink{nuweb413b}{413b}}\NWlink{nuweb415}{, 415}\NWlink{nuweb425}{, 425}\NWlink{nuweb430a}{, 430a}\NWlink{nuweb455}{, 455}\NWlink{nuweb462}{, 462}\NWlink{nuweb481}{, 481}\NWlink{nuweb488b}{, 488b}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb495}{, 495}\NWlink{nuweb497}{, 497}\NWlink{nuweb502}{, 502}\NWlink{nuweb503}{, 503}\NWlink{nuweb504}{, 504}\NWlink{nuweb517}{, 517}\NWlink{nuweb526}{, 526}\NWlink{nuweb530}{, 530}\NWlink{nuweb532}{, 532}\NWlink{nuweb535}{, 535}\NWlink{nuweb540}{, 540}\NWlink{nuweb544}{, 544}.
\item \verb@initialiseDocument@: \NWlink{nuweb434}{434}, \underline{\NWlink{nuweb483a}{483a}}\NWlink{nuweb544}{, 544}.
\item \verb@isCurrentMonth@: \underline{\NWlink{nuweb408}{408}}.
\item \verb@is_user_session_open@: \NWlink{nuweb333}{333}\NWlink{nuweb335}{, 335}, \underline{\NWlink{nuweb400}{400}}.
\item \verb@J1970@: \underline{\NWlink{nuweb445}{445}}\NWlink{nuweb446a}{, 446a}\NWlink{nuweb450b}{, 450b}\NWlink{nuweb451a}{, 451a}.
\item \verb@jd_to_civil_time@: \NWlink{nuweb445}{445}, \underline{\NWlink{nuweb450a}{450a}}\NWlink{nuweb451b}{, 451b}\NWlink{nuweb452a}{, 452a}\NWlink{nuweb452b}{b}\NWlink{nuweb453}{, 453}.
\item \verb@jd_to_gregorian@: \NWlink{nuweb52}{52}\NWlink{nuweb77}{, 77}\NWlink{nuweb84}{, 84}\NWlink{nuweb105}{, 105}\NWlink{nuweb111}{, 111}\NWlink{nuweb116}{, 116}\NWlink{nuweb259a}{, 259a}\NWlink{nuweb277a}{, 277a}\NWlink{nuweb277b}{b}\NWlink{nuweb349}{, 349}\NWlink{nuweb445}{, 445}, \underline{\NWlink{nuweb448}{448}}\NWlink{nuweb451b}{, 451b}\NWlink{nuweb452a}{, 452a}\NWlink{nuweb452b}{b}\NWlink{nuweb453}{, 453}.
\item \verb@jd_to_old_cookie_date@: \NWlink{nuweb158a}{158a}\NWlink{nuweb158b}{b}\NWlink{nuweb445}{, 445}, \underline{\NWlink{nuweb453}{453}}.
\item \verb@jd_to_RFC_3339_date@: \NWlink{nuweb355}{355}\NWlink{nuweb445}{, 445}, \underline{\NWlink{nuweb452b}{452b}}.
\item \verb@jd_to_RFC_822_date@: \NWlink{nuweb445}{445}, \underline{\NWlink{nuweb452a}{452a}}.
\item \verb@jd_to_unix_time@: \NWlink{nuweb285}{285}\NWlink{nuweb291b}{, 291b}\NWlink{nuweb292}{, 292}\NWlink{nuweb293}{, 293}\NWlink{nuweb445}{, 445}, \underline{\NWlink{nuweb451a}{451a}}.
\item \verb@jd_to_weekday@: \NWlink{nuweb36}{36}\NWlink{nuweb66}{, 66}\NWlink{nuweb261}{, 261}\NWlink{nuweb445}{, 445}, \underline{\NWlink{nuweb449a}{449a}}\NWlink{nuweb453}{, 453}.
\item \verb@Julian@: \NWlink{nuweb23}{23}\NWlink{nuweb52}{, 52}\NWlink{nuweb75}{, 75}\NWlink{nuweb114}{, 114}\NWlink{nuweb118}{, 118}\NWlink{nuweb154}{, 154}\NWlink{nuweb261}{, 261}\NWlink{nuweb387a}{, 387a}\NWlink{nuweb408}{, 408}, \underline{\NWlink{nuweb445}{445}}\NWlink{nuweb446a}{, 446a}\NWlink{nuweb552a}{, 552a}.
\item \verb@lastDay@: \NWlink{nuweb102a}{102a}, \underline{\NWlink{nuweb108}{108}}\NWlink{nuweb215}{, 215}\NWlink{nuweb253}{, 253}\NWlink{nuweb275}{, 275}.
\item \verb@last_transaction_time@: \NWlink{nuweb319}{319}\NWlink{nuweb329}{, 329}, \underline{\NWlink{nuweb399a}{399a}}.
\item \verb@leap_gregorian@: \NWlink{nuweb445}{445}, \underline{\NWlink{nuweb447a}{447a}}\NWlink{nuweb447b}{, 447b}\NWlink{nuweb448}{, 448}.
\item \verb@leaveDocument@: \NWlink{nuweb208}{208}\NWlink{nuweb211}{, 211}\NWlink{nuweb274}{, 274}, \underline{\NWlink{nuweb484b}{484b}}.
\item \verb@load@: \underline{\NWlink{nuweb32a}{32a}}\NWlink{nuweb32b}{, 32b}\NWlink{nuweb33a}{, 33a}\NWlink{nuweb33b}{b}\NWlink{nuweb34a}{, 34a}\NWlink{nuweb34b}{b}\NWlink{nuweb85}{, 85}\NWlink{nuweb101b}{, 101b}\NWlink{nuweb110}{, 110}\NWlink{nuweb112}{, 112}\NWlink{nuweb117}{, 117}, \underline{\NWlink{nuweb124a}{124a}}, \underline{\NWlink{nuweb152a}{152a}}, \underline{\NWlink{nuweb157a}{157a}}\NWlink{nuweb160}{, 160}\NWlink{nuweb168}{, 168}\NWlink{nuweb171a}{, 171a}\NWlink{nuweb183}{, 183}\NWlink{nuweb184}{, 184}\NWlink{nuweb199}{, 199}\NWlink{nuweb205}{, 205}\NWlink{nuweb206}{, 206}\NWlink{nuweb210}{, 210}\NWlink{nuweb214}{, 214}\NWlink{nuweb236}{, 236}\NWlink{nuweb254}{, 254}\NWlink{nuweb255}{, 255}\NWlink{nuweb256}{, 256}\NWlink{nuweb257}{, 257}\NWlink{nuweb318}{, 318}\NWlink{nuweb319}{, 319}\NWlink{nuweb327}{, 327}\NWlink{nuweb329}{, 329}\NWlink{nuweb333}{, 333}\NWlink{nuweb335}{, 335}\NWlink{nuweb337}{, 337}\NWlink{nuweb338}{, 338}\NWlink{nuweb344}{, 344}\NWlink{nuweb393b}{, 393b}\NWlink{nuweb394}{, 394}\NWlink{nuweb461}{, 461}.
\item \verb@loadDietCalcFields@: \NWlink{nuweb274}{274}, \underline{\NWlink{nuweb506}{506}}\NWlink{nuweb509a}{, 509a}\NWlink{nuweb509b}{b}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb510b}{b}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb511b}{b}\NWlink{nuweb512a}{, 512a}\NWlink{nuweb512b}{b}\NWlink{nuweb513a}{, 513a}.
\item \verb@load_active_session@: \NWlink{nuweb148}{148}, \underline{\NWlink{nuweb153a}{153a}}\NWlink{nuweb186c}{, 186c}\NWlink{nuweb400}{, 400}.
\item \verb@localiseDecimal@: \NWlink{nuweb100}{100}, \underline{\NWlink{nuweb146b}{146b}}\NWlink{nuweb147}{, 147}\NWlink{nuweb215}{, 215}.
\item \verb@localiseNumber@: \NWlink{nuweb128}{128}, \underline{\NWlink{nuweb147}{147}}.
\item \verb@login@: \underline{\NWlink{nuweb121}{121}}\NWlink{nuweb122}{, 122}\NWlink{nuweb126}{, 126}\NWlink{nuweb127}{, 127}\NWlink{nuweb137}{, 137}\NWlink{nuweb150}{, 150}\NWlink{nuweb151}{, 151}\NWlink{nuweb153b}{, 153b}\NWlink{nuweb159}{, 159}\NWlink{nuweb162}{, 162}\NWlink{nuweb170a}{, 170a}\NWlink{nuweb180a}{, 180a}\NWlink{nuweb183}{, 183}\NWlink{nuweb188a}{, 188a}\NWlink{nuweb198}{, 198}\NWlink{nuweb199}{, 199}\NWlink{nuweb200}{, 200}\NWlink{nuweb201}{, 201}\NWlink{nuweb203}{, 203}\NWlink{nuweb204}{, 204}\NWlink{nuweb278a}{, 278a}\NWlink{nuweb304a}{, 304a}\NWlink{nuweb307b}{, 307b}\NWlink{nuweb310}{, 310}\NWlink{nuweb344}{, 344}\NWlink{nuweb347}{, 347}\NWlink{nuweb376}{, 376}\NWlink{nuweb473b}{, 473b}\NWlink{nuweb480}{, 480}\NWlink{nuweb532}{, 532}\NWlink{nuweb538b}{, 538b}.
\item \verb@login_form@: \underline{\NWlink{nuweb125}{125}}\NWlink{nuweb182}{, 182}\NWlink{nuweb185a}{, 185a}\NWlink{nuweb186a}{, 186a}\NWlink{nuweb197}{, 197}.
\item \verb@max@: \NWlink{nuweb19b}{19b}\NWlink{nuweb20a}{, 20a}\NWlink{nuweb21}{, 21}\NWlink{nuweb50}{, 50}\NWlink{nuweb52}{, 52}\NWlink{nuweb85}{, 85}\NWlink{nuweb86}{, 86}\NWlink{nuweb277a}{, 277a}\NWlink{nuweb297}{, 297}\NWlink{nuweb323}{, 323}, \underline{\NWlink{nuweb405}{405}}\NWlink{nuweb497}{, 497}\NWlink{nuweb525}{, 525}.
\item \verb@min@: \NWlink{nuweb19b}{19b}\NWlink{nuweb20a}{, 20a}\NWlink{nuweb21}{, 21}\NWlink{nuweb50}{, 50}\NWlink{nuweb52}{, 52}\NWlink{nuweb85}{, 85}\NWlink{nuweb86}{, 86}\NWlink{nuweb91}{, 91}\NWlink{nuweb209}{, 209}\NWlink{nuweb223}{, 223}\NWlink{nuweb262}{, 262}\NWlink{nuweb297}{, 297}\NWlink{nuweb323}{, 323}, \underline{\NWlink{nuweb405}{405}}\NWlink{nuweb406b}{, 406b}\NWlink{nuweb425}{, 425}\NWlink{nuweb426}{, 426}\NWlink{nuweb449b}{, 449b}\NWlink{nuweb525}{, 525}.
\item \verb@minMaxMean@: \underline{\NWlink{nuweb21}{21}}\NWlink{nuweb79}{, 79}.
\item \verb@mod@: \underline{\NWlink{nuweb446b}{446b}}\NWlink{nuweb448}{, 448}.
\item \verb@monthdays@: \NWlink{nuweb27}{27}\NWlink{nuweb28}{, 28}\NWlink{nuweb29}{, 29}\NWlink{nuweb30}{, 30}\NWlink{nuweb31}{, 31}\NWlink{nuweb33b}{, 33b}\NWlink{nuweb36}{, 36}\NWlink{nuweb46}{, 46}\NWlink{nuweb48a}{, 48a}\NWlink{nuweb48b}{b}\NWlink{nuweb49}{, 49}\NWlink{nuweb50}{, 50}\NWlink{nuweb52}{, 52}\NWlink{nuweb53a}{, 53a}\NWlink{nuweb54}{, 54}\NWlink{nuweb56}{, 56}\NWlink{nuweb63}{, 63}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb67}{, 67}\NWlink{nuweb68}{, 68}, \underline{\NWlink{nuweb69}{69}}\NWlink{nuweb72}{, 72}\NWlink{nuweb85}{, 85}\NWlink{nuweb108}{, 108}\NWlink{nuweb109a}{, 109a}\NWlink{nuweb111}{, 111}\NWlink{nuweb117}{, 117}\NWlink{nuweb212a}{, 212a}\NWlink{nuweb214}{, 214}\NWlink{nuweb261}{, 261}\NWlink{nuweb393b}{, 393b}\NWlink{nuweb394}{, 394}\NWlink{nuweb396}{, 396}.
\item \verb@ndb@: \underline{\NWlink{nuweb413a}{413a}}.
\item \verb@ndz@: \underline{\NWlink{nuweb413a}{413a}}.
\item \verb@new_account_form@: \underline{\NWlink{nuweb127}{127}}\NWlink{nuweb304a}{, 304a}\NWlink{nuweb310}{, 310}\NWlink{nuweb311}{, 311}\NWlink{nuweb315}{, 315}.
\item \verb@nextMonth@: \underline{\NWlink{nuweb70}{70}}\NWlink{nuweb85}{, 85}\NWlink{nuweb112}{, 112}\NWlink{nuweb211}{, 211}.
\item \verb@parseCSV@: \NWlink{nuweb15}{15}, \underline{\NWlink{nuweb16}{16}}\NWlink{nuweb63}{, 63}.
\item \verb@parseSignedWeight@: \NWlink{nuweb289b}{289b}\NWlink{nuweb290a}{, 290a}, \underline{\NWlink{nuweb402}{402}}, \underline{\NWlink{nuweb486}{486}}\NWlink{nuweb506}{, 506}.
\item \verb@parseWeight@: \NWlink{nuweb288b}{288b}\NWlink{nuweb289a}{, 289a}, \underline{\NWlink{nuweb401}{401}}\NWlink{nuweb402}{, 402}, \underline{\NWlink{nuweb485b}{485b}}\NWlink{nuweb486}{, 486}\NWlink{nuweb488b}{, 488b}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb493b}{b}\NWlink{nuweb495}{, 495}\NWlink{nuweb497}{, 497}\NWlink{nuweb498}{, 498}\NWlink{nuweb500}{, 500}\NWlink{nuweb501}{, 501}\NWlink{nuweb506}{, 506}\NWlink{nuweb510b}{, 510b}.
\item \verb@parse_cgi_arguments@: \NWlink{nuweb173}{173}, \underline{\NWlink{nuweb412}{412}}.
\item \verb@passwordStrength@: \underline{\NWlink{nuweb525}{525}}.
\item \verb@plotChart@: \underline{\NWlink{nuweb46}{46}}\NWlink{nuweb263a}{, 263a}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}.
\item \verb@previousMonth@: \underline{\NWlink{nuweb70}{70}}\NWlink{nuweb111}{, 111}\NWlink{nuweb211}{, 211}.
\item \verb@print_command_line_help@: \NWlink{nuweb173}{173}\NWlink{nuweb389a}{, 389a}, \underline{\NWlink{nuweb404}{404}}.
\item \verb@propagate_trend@: \NWlink{nuweb220a}{220a}\NWlink{nuweb247}{, 247}\NWlink{nuweb359}{, 359}, \underline{\NWlink{nuweb392}{392}}.
\item \verb@psLog10@: \NWlink{nuweb525}{525}, \underline{\NWlink{nuweb529a}{529a}}.
\item \verb@psLog2@: \NWlink{nuweb525}{525}, \underline{\NWlink{nuweb529a}{529a}}.
\item \verb@quoteHTML@: \NWlink{nuweb40a}{40a}\NWlink{nuweb125}{, 125}\NWlink{nuweb128}{, 128}\NWlink{nuweb134b}{, 134b}\NWlink{nuweb190}{, 190}\NWlink{nuweb191a}{, 191a}\NWlink{nuweb196}{, 196}\NWlink{nuweb198}{, 198}\NWlink{nuweb200}{, 200}\NWlink{nuweb201}{, 201}\NWlink{nuweb203}{, 203}\NWlink{nuweb207}{, 207}\NWlink{nuweb212a}{, 212a}\NWlink{nuweb218}{, 218}\NWlink{nuweb221}{, 221}\NWlink{nuweb231}{, 231}\NWlink{nuweb233}{, 233}\NWlink{nuweb305}{, 305}\NWlink{nuweb313}{, 313}\NWlink{nuweb319}{, 319}\NWlink{nuweb321}{, 321}\NWlink{nuweb324}{, 324}\NWlink{nuweb327}{, 327}\NWlink{nuweb330}{, 330}\NWlink{nuweb333}{, 333}\NWlink{nuweb335}{, 335}\NWlink{nuweb338}{, 338}\NWlink{nuweb339}{, 339}\NWlink{nuweb345}{, 345}\NWlink{nuweb352}{, 352}\NWlink{nuweb366}{, 366}\NWlink{nuweb368}{, 368}\NWlink{nuweb373}{, 373}\NWlink{nuweb380}{, 380}\NWlink{nuweb431}{, 431}, \underline{\NWlink{nuweb439}{439}}.
\item \verb@quoteHTMLFile@: \NWlink{nuweb218}{218}\NWlink{nuweb431}{, 431}, \underline{\NWlink{nuweb439}{439}}.
\item \verb@quoteUserName@: \NWlink{nuweb116}{116}\NWlink{nuweb118}{, 118}\NWlink{nuweb140}{, 140}\NWlink{nuweb141}{, 141}\NWlink{nuweb143}{, 143}, \underline{\NWlink{nuweb145}{145}}\NWlink{nuweb166}{, 166}\NWlink{nuweb167}{, 167}\NWlink{nuweb168}{, 168}\NWlink{nuweb169b}{, 169b}\NWlink{nuweb183}{, 183}\NWlink{nuweb184}{, 184}\NWlink{nuweb199}{, 199}\NWlink{nuweb205}{, 205}\NWlink{nuweb206}{, 206}\NWlink{nuweb306a}{, 306a}\NWlink{nuweb317}{, 317}\NWlink{nuweb319}{, 319}\NWlink{nuweb320}{, 320}\NWlink{nuweb330}{, 330}\NWlink{nuweb333}{, 333}\NWlink{nuweb335}{, 335}\NWlink{nuweb339}{, 339}\NWlink{nuweb346}{, 346}\NWlink{nuweb392}{, 392}\NWlink{nuweb400}{, 400}\NWlink{nuweb461}{, 461}.
\item \verb@quoteXML@: \NWlink{nuweb137}{137}\NWlink{nuweb138}{, 138}\NWlink{nuweb440}{, 440}, \underline{\NWlink{nuweb442a}{442a}}\NWlink{nuweb442b}{, 442b}.
\item \verb@replaceText@: \NWlink{nuweb497}{497}\NWlink{nuweb498}{, 498}\NWlink{nuweb500}{, 500}\NWlink{nuweb501}{, 501}, \underline{\NWlink{nuweb523}{523}}\NWlink{nuweb524b}{, 524b}.
\item \verb@resetFocus@: \NWlink{nuweb493a}{493a}\NWlink{nuweb493b}{b}\NWlink{nuweb502}{, 502}\NWlink{nuweb510a}{, 510a}\NWlink{nuweb511a}{, 511a}\NWlink{nuweb512b}{, 512b}\NWlink{nuweb513a}{, 513a}\NWlink{nuweb514b}{, 514b}, \underline{\NWlink{nuweb516b}{516b}}.
\item \verb@resetPassword@: \underline{\NWlink{nuweb135a}{135a}}, \underline{\NWlink{nuweb135b}{135b}}\NWlink{nuweb199}{, 199}.
\item \verb@retrieve@: \underline{\NWlink{nuweb116}{116}}\NWlink{nuweb349}{, 349}.
\item \verb@Round@: \NWlink{nuweb51}{51}, \underline{\NWlink{nuweb405}{405}}\NWlink{nuweb446b}{, 446b}.
\item \verb@RUNG_MAX@: \underline{\NWlink{nuweb24}{24}}\NWlink{nuweb45}{, 45}\NWlink{nuweb49}{, 49}\NWlink{nuweb60}{, 60}\NWlink{nuweb83}{, 83}.
\item \verb@save@: \underline{\NWlink{nuweb31}{31}}\NWlink{nuweb113a}{, 113a}, \underline{\NWlink{nuweb123}{123}}, \underline{\NWlink{nuweb151}{151}}, \underline{\NWlink{nuweb156b}{156b}}\NWlink{nuweb159}{, 159}\NWlink{nuweb167}{, 167}\NWlink{nuweb170b}{, 170b}\NWlink{nuweb187}{, 187}\NWlink{nuweb220a}{, 220a}\NWlink{nuweb240a}{, 240a}\NWlink{nuweb248a}{, 248a}\NWlink{nuweb309}{, 309}\NWlink{nuweb320}{, 320}\NWlink{nuweb330}{, 330}\NWlink{nuweb395b}{, 395b}\NWlink{nuweb484b}{, 484b}.
\item \verb@save_active_session@: \underline{\NWlink{nuweb152c}{152c}}\NWlink{nuweb187}{, 187}.
\item \verb@sendMail@: \underline{\NWlink{nuweb136}{136}}\NWlink{nuweb202}{, 202}.
\item \verb@set_date_selection@: \NWlink{nuweb507}{507}, \underline{\NWlink{nuweb508}{508}}.
\item \verb@set_dispunit@: \NWlink{nuweb127}{127}, \underline{\NWlink{nuweb522}{522}}.
\item \verb@set_logunit@: \NWlink{nuweb127}{127}, \underline{\NWlink{nuweb522}{522}}.
\item \verb@sgn@: \NWlink{nuweb41a}{41a}\NWlink{nuweb54}{, 54}\NWlink{nuweb97}{, 97}\NWlink{nuweb142}{, 142}\NWlink{nuweb402}{, 402}, \underline{\NWlink{nuweb405}{405}}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb486}{, 486}.
\item \verb@showPasswordStrength@: \NWlink{nuweb130}{130}, \underline{\NWlink{nuweb525}{525}}.
\item \verb@signCookie@: \underline{\NWlink{nuweb157c}{157c}}\NWlink{nuweb158a}{, 158a}.
\item \verb@start@: \NWlink{nuweb18}{18}\NWlink{nuweb19a}{, 19a}, \underline{\NWlink{nuweb19b}{19b}}\NWlink{nuweb52}{, 52}\NWlink{nuweb80}{, 80}\NWlink{nuweb84}{, 84}\NWlink{nuweb86}{, 86}\NWlink{nuweb139}{, 139}\NWlink{nuweb260}{, 260}\NWlink{nuweb266}{, 266}\NWlink{nuweb275}{, 275}\NWlink{nuweb277b}{, 277b}\NWlink{nuweb292}{, 292}\NWlink{nuweb297}{, 297}\NWlink{nuweb303}{, 303}\NWlink{nuweb408}{, 408}\NWlink{nuweb497}{, 497}\NWlink{nuweb514b}{, 514b}\NWlink{nuweb534}{, 534}\NWlink{nuweb540}{, 540}.
\item \verb@storeCookie@: \NWlink{nuweb154}{154}, \underline{\NWlink{nuweb159}{159}}\NWlink{nuweb189}{, 189}.
\item \verb@syntheticData@: \underline{\NWlink{nuweb105}{105}}\NWlink{nuweb107}{, 107}\NWlink{nuweb359}{, 359}.
\item \verb@testCookiePresent@: \NWlink{nuweb154}{154}, \underline{\NWlink{nuweb160}{160}}\NWlink{nuweb182}{, 182}\NWlink{nuweb189}{, 189}.
\item \verb@textXML@: \NWlink{nuweb68}{68}\NWlink{nuweb440}{, 440}, \underline{\NWlink{nuweb442b}{442b}}.
\item \verb@timeXML@: \NWlink{nuweb68}{68}\NWlink{nuweb137}{, 137}\NWlink{nuweb139}{, 139}\NWlink{nuweb254}{, 254}\NWlink{nuweb255}{, 255}\NWlink{nuweb379a}{, 379a}\NWlink{nuweb440}{, 440}, \underline{\NWlink{nuweb443}{443}}.
\item \verb@toHex@: \underline{\NWlink{nuweb407}{407}}.
\item \verb@toHTML@: \underline{\NWlink{nuweb36}{36}}\NWlink{nuweb208}{, 208}.
\item \verb@unix_time_to_civil_date_time@: \NWlink{nuweb177}{177}\NWlink{nuweb207}{, 207}\NWlink{nuweb209}{, 209}\NWlink{nuweb223}{, 223}\NWlink{nuweb231}{, 231}\NWlink{nuweb234}{, 234}\NWlink{nuweb238}{, 238}\NWlink{nuweb262}{, 262}\NWlink{nuweb445}{, 445}, \underline{\NWlink{nuweb451b}{451b}}.
\item \verb@unix_time_to_jd@: \NWlink{nuweb142}{142}\NWlink{nuweb158a}{, 158a}\NWlink{nuweb259a}{, 259a}\NWlink{nuweb277a}{, 277a}\NWlink{nuweb277b}{b}\NWlink{nuweb349}{, 349}\NWlink{nuweb408}{, 408}\NWlink{nuweb445}{, 445}, \underline{\NWlink{nuweb450b}{450b}}\NWlink{nuweb451b}{, 451b}.
\item \verb@unsavedChanges@: \NWlink{nuweb216}{216}\NWlink{nuweb283}{, 283}, \underline{\NWlink{nuweb484a}{484a}}\NWlink{nuweb484b}{, 484b}.
\item \verb@updateFlag@: \NWlink{nuweb39b}{39b}, \underline{\NWlink{nuweb524b}{524b}}.
\item \verb@updateFromCGI@: \underline{\NWlink{nuweb56}{56}}\NWlink{nuweb219}{, 219}.
\item \verb@updateVariance@: \NWlink{nuweb498}{498}, \underline{\NWlink{nuweb524a}{524a}}.
\item \verb@update_last_transaction@: \NWlink{nuweb188a}{188a}\NWlink{nuweb220a}{, 220a}\NWlink{nuweb221}{, 221}\NWlink{nuweb224}{, 224}\NWlink{nuweb229}{, 229}\NWlink{nuweb246}{, 246}\NWlink{nuweb247}{, 247}\NWlink{nuweb262}{, 262}\NWlink{nuweb263a}{, 263a}\NWlink{nuweb264}{, 264}\NWlink{nuweb274}{, 274}\NWlink{nuweb293}{, 293}\NWlink{nuweb294}{, 294}\NWlink{nuweb303}{, 303}\NWlink{nuweb311}{, 311}\NWlink{nuweb312}{, 312}\NWlink{nuweb313}{, 313}\NWlink{nuweb316}{, 316}, \underline{\NWlink{nuweb398}{398}}.
\item \verb@U_MINUS_SIGN@: \underline{\NWlink{nuweb482}{482}}\NWlink{nuweb524a}{, 524a}.
\item \verb@validateFeedback@: \NWlink{nuweb366}{366}, \underline{\NWlink{nuweb516a}{516a}}.
\item \verb@validMailDomain@: \NWlink{nuweb305}{305}\NWlink{nuweb313}{, 313}, \underline{\NWlink{nuweb411}{411}}.
\item \verb@var@: \NWlink{nuweb38}{38}, \underline{\NWlink{nuweb44b}{44b}}\NWlink{nuweb430b}{, 430b}\NWlink{nuweb481}{, 481}\NWlink{nuweb482}{, 482}\NWlink{nuweb484a}{, 484a}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb486}{, 486}\NWlink{nuweb487a}{, 487a}\NWlink{nuweb488b}{, 488b}\NWlink{nuweb489}{, 489}\NWlink{nuweb490}{, 490}\NWlink{nuweb491}{, 491}\NWlink{nuweb493a}{, 493a}\NWlink{nuweb493b}{b}\NWlink{nuweb494}{, 494}\NWlink{nuweb495}{, 495}\NWlink{nuweb496}{, 496}\NWlink{nuweb497}{, 497}\NWlink{nuweb498}{, 498}\NWlink{nuweb499}{, 499}\NWlink{nuweb500}{, 500}\NWlink{nuweb501}{, 501}\NWlink{nuweb502}{, 502}\NWlink{nuweb503}{, 503}\NWlink{nuweb504}{, 504}\NWlink{nuweb505}{, 505}\NWlink{nuweb508}{, 508}\NWlink{nuweb509b}{, 509b}\NWlink{nuweb510b}{, 510b}\NWlink{nuweb514a}{, 514a}\NWlink{nuweb517}{, 517}\NWlink{nuweb519a}{, 519a}\NWlink{nuweb519b}{b}\NWlink{nuweb520}{, 520}\NWlink{nuweb521}{, 521}\NWlink{nuweb522}{, 522}\NWlink{nuweb523}{, 523}\NWlink{nuweb524a}{, 524a}\NWlink{nuweb524b}{b}\NWlink{nuweb525}{, 525}\NWlink{nuweb527}{, 527}\NWlink{nuweb528}{, 528}\NWlink{nuweb529b}{, 529b}.
\item \verb@verbose@: \NWlink{nuweb25}{25}\NWlink{nuweb26}{, 26}, \underline{\NWlink{nuweb71}{71}}\NWlink{nuweb388b}{, 388b}\NWlink{nuweb389a}{, 389a}\NWlink{nuweb404}{, 404}\NWlink{nuweb406a}{, 406a}\NWlink{nuweb421a}{, 421a}\NWlink{nuweb423b}{, 423b}\NWlink{nuweb425}{, 425}\NWlink{nuweb426}{, 426}\NWlink{nuweb429b}{, 429b}\NWlink{nuweb457a}{, 457a}\NWlink{nuweb552a}{, 552a}.
\item \verb@WEEKDAY_NAMES@: \NWlink{nuweb23}{23}\NWlink{nuweb37b}{, 37b}\NWlink{nuweb66}{, 66}\NWlink{nuweb75}{, 75}\NWlink{nuweb261}{, 261}, \underline{\NWlink{nuweb445}{445}}\NWlink{nuweb446a}{, 446a}\NWlink{nuweb453}{, 453}.
\item \verb@WEIGHT_KILOGRAM@: \NWlink{nuweb23}{23}, \underline{\NWlink{nuweb24}{24}}\NWlink{nuweb25}{, 25}\NWlink{nuweb29}{, 29}\NWlink{nuweb50}{, 50}\NWlink{nuweb52}{, 52}\NWlink{nuweb85}{, 85}\NWlink{nuweb86}{, 86}\NWlink{nuweb120}{, 120}\NWlink{nuweb142}{, 142}\NWlink{nuweb230}{, 230}\NWlink{nuweb234}{, 234}\NWlink{nuweb238}{, 238}\NWlink{nuweb275}{, 275}\NWlink{nuweb293}{, 293}\NWlink{nuweb481}{, 481}\NWlink{nuweb501}{, 501}.
\item \verb@WEIGHT_POUND@: \NWlink{nuweb23}{23}, \underline{\NWlink{nuweb24}{24}}\NWlink{nuweb103b}{, 103b}\NWlink{nuweb230}{, 230}\NWlink{nuweb234}{, 234}.
\item \verb@WEIGHT_STONE@: \NWlink{nuweb23}{23}, \underline{\NWlink{nuweb24}{24}}\NWlink{nuweb41a}{, 41a}\NWlink{nuweb48a}{, 48a}\NWlink{nuweb51}{, 51}\NWlink{nuweb57}{, 57}\NWlink{nuweb58}{, 58}\NWlink{nuweb87b}{, 87b}\NWlink{nuweb103b}{, 103b}\NWlink{nuweb230}{, 230}\NWlink{nuweb234}{, 234}\NWlink{nuweb238}{, 238}\NWlink{nuweb285}{, 285}\NWlink{nuweb293}{, 293}\NWlink{nuweb401}{, 401}\NWlink{nuweb481}{, 481}\NWlink{nuweb485a}{, 485a}\NWlink{nuweb485b}{b}\NWlink{nuweb488b}{, 488b}.
\item \verb@WEIGHT_UNITS@: \underline{\NWlink{nuweb24}{24}}\NWlink{nuweb27}{, 27}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb68}{, 68}\NWlink{nuweb122}{, 122}\NWlink{nuweb138}{, 138}\NWlink{nuweb255}{, 255}.
\item \verb@wgt@: \NWlink{nuweb38}{38}, \underline{\NWlink{nuweb44a}{44a}}.
\item \verb@wrapText@: \NWlink{nuweb368}{368}\NWlink{nuweb373}{, 373}, \underline{\NWlink{nuweb403}{403}}.
\item \verb@write_XHTML_epilogue@: \NWlink{nuweb182}{182}\NWlink{nuweb185a}{, 185a}\NWlink{nuweb186a}{, 186a}\NWlink{nuweb190}{, 190}\NWlink{nuweb197}{, 197}\NWlink{nuweb198}{, 198}\NWlink{nuweb200}{, 200}\NWlink{nuweb201}{, 201}\NWlink{nuweb203}{, 203}\NWlink{nuweb207}{, 207}\NWlink{nuweb208}{, 208}\NWlink{nuweb221}{, 221}\NWlink{nuweb224}{, 224}\NWlink{nuweb228b}{, 228b}\NWlink{nuweb243}{, 243}\NWlink{nuweb246}{, 246}\NWlink{nuweb247}{, 247}\NWlink{nuweb250}{, 250}\NWlink{nuweb252}{, 252}\NWlink{nuweb258}{, 258}\NWlink{nuweb260}{, 260}\NWlink{nuweb262}{, 262}\NWlink{nuweb264}{, 264}\NWlink{nuweb274}{, 274}\NWlink{nuweb294}{, 294}\NWlink{nuweb304a}{, 304a}\NWlink{nuweb310}{, 310}\NWlink{nuweb311}{, 311}\NWlink{nuweb312}{, 312}\NWlink{nuweb313}{, 313}\NWlink{nuweb315}{, 315}\NWlink{nuweb316}{, 316}\NWlink{nuweb317}{, 317}\NWlink{nuweb320}{, 320}\NWlink{nuweb321}{, 321}\NWlink{nuweb322}{, 322}\NWlink{nuweb324}{, 324}\NWlink{nuweb328}{, 328}\NWlink{nuweb330}{, 330}\NWlink{nuweb331}{, 331}\NWlink{nuweb332}{, 332}\NWlink{nuweb333}{, 333}\NWlink{nuweb334}{, 334}\NWlink{nuweb335}{, 335}\NWlink{nuweb336}{, 336}\NWlink{nuweb340}{, 340}\NWlink{nuweb341}{, 341}\NWlink{nuweb342}{, 342}\NWlink{nuweb343}{, 343}\NWlink{nuweb347}{, 347}\NWlink{nuweb348}{, 348}\NWlink{nuweb358}{, 358}\NWlink{nuweb365}{, 365}\NWlink{nuweb370}{, 370}\NWlink{nuweb374}{, 374}\NWlink{nuweb377}{, 377}\NWlink{nuweb380}{, 380}\NWlink{nuweb382}{, 382}\NWlink{nuweb385a}{, 385a}\NWlink{nuweb431}{, 431}, \underline{\NWlink{nuweb438}{438}}.
\item \verb@write_XHTML_prologue@: \NWlink{nuweb182}{182}\NWlink{nuweb185a}{, 185a}\NWlink{nuweb186a}{, 186a}\NWlink{nuweb190}{, 190}\NWlink{nuweb197}{, 197}\NWlink{nuweb198}{, 198}\NWlink{nuweb200}{, 200}\NWlink{nuweb201}{, 201}\NWlink{nuweb203}{, 203}\NWlink{nuweb207}{, 207}\NWlink{nuweb208}{, 208}\NWlink{nuweb221}{, 221}\NWlink{nuweb224}{, 224}\NWlink{nuweb227}{, 227}\NWlink{nuweb241}{, 241}\NWlink{nuweb244}{, 244}\NWlink{nuweb247}{, 247}\NWlink{nuweb250}{, 250}\NWlink{nuweb252}{, 252}\NWlink{nuweb258}{, 258}\NWlink{nuweb260}{, 260}\NWlink{nuweb262}{, 262}\NWlink{nuweb264}{, 264}\NWlink{nuweb274}{, 274}\NWlink{nuweb294}{, 294}\NWlink{nuweb304a}{, 304a}\NWlink{nuweb310}{, 310}\NWlink{nuweb311}{, 311}\NWlink{nuweb312}{, 312}\NWlink{nuweb313}{, 313}\NWlink{nuweb315}{, 315}\NWlink{nuweb316}{, 316}\NWlink{nuweb317}{, 317}\NWlink{nuweb320}{, 320}\NWlink{nuweb321}{, 321}\NWlink{nuweb322}{, 322}\NWlink{nuweb323}{, 323}\NWlink{nuweb325}{, 325}\NWlink{nuweb330}{, 330}\NWlink{nuweb331}{, 331}\NWlink{nuweb332}{, 332}\NWlink{nuweb334}{, 334}\NWlink{nuweb336}{, 336}\NWlink{nuweb340}{, 340}\NWlink{nuweb341}{, 341}\NWlink{nuweb342}{, 342}\NWlink{nuweb343}{, 343}\NWlink{nuweb347}{, 347}\NWlink{nuweb348}{, 348}\NWlink{nuweb358}{, 358}\NWlink{nuweb365}{, 365}\NWlink{nuweb370}{, 370}\NWlink{nuweb374}{, 374}\NWlink{nuweb377}{, 377}\NWlink{nuweb380}{, 380}\NWlink{nuweb382}{, 382}\NWlink{nuweb385a}{, 385a}\NWlink{nuweb431}{, 431}, \underline{\NWlink{nuweb432}{432}}.
\item \verb@xml@: \NWlink{nuweb23}{23}\NWlink{nuweb118}{, 118}\NWlink{nuweb228b}{, 228b}\NWlink{nuweb249}{, 249}\NWlink{nuweb250}{, 250}\NWlink{nuweb252}{, 252}\NWlink{nuweb254}{, 254}\NWlink{nuweb375b}{, 375b}\NWlink{nuweb387a}{, 387a}\NWlink{nuweb433}{, 433}, \underline{\NWlink{nuweb440}{440}}\NWlink{nuweb441a}{, 441a}\NWlink{nuweb552a}{, 552a}.
\item \verb@znd@: \NWlink{nuweb36}{36}\NWlink{nuweb38}{, 38}, \underline{\NWlink{nuweb43b}{43b}}\NWlink{nuweb57}{, 57}\NWlink{nuweb60}{, 60}\NWlink{nuweb61}{, 61}\NWlink{nuweb64}{, 64}\NWlink{nuweb65}{, 65}\NWlink{nuweb66}{, 66}\NWlink{nuweb67}{, 67}.
\end{list}}

\font\df=cmbx12
\def\date#1{{\medskip\noindent\df #1\medskip}}
\parskip=1ex
\parindent=0pt

\clearpage
\chapter{Feature Requests} \label{featreq}

\date{2007 April 30}

Add items to the Diet Calculator to display the ``band'' and the ``brick wall'' limits
around the goal weight.  (Suggested by Rob Campbell.)

\date{2007 May 2}

Custom colour selection for chart components.  (Suggested by Bruce Lokeinsky.)

\date{2007 May 4}

In the current day's log, only display days up to and including the
current day. (Suggested by Bruce Lokeinsky.)

\date{2007 May 19}

Check boxes in the Chart Workshop to select which components are charted.

Perhaps it would make sense (in particular in conjunction with the
cookies for ``remember me'') to define an alias on the HTTP server
so that the application could be accessed with a URL like
{\tt http://www.fourmilab.ch/hdo} instead of all of the {\tt cgi-bin}
rigmarole.

Option to suppress monthly header records in CSV data exports.
(Suggested by Robert Ewing.)

Ability to configure user-defined numeric and string fields to be
added to the monthly log form.  These fields will be exported, and
numeric fields may be plotted in charts.

\clearpage
\chapter{Development Log} \label{log}

\date{2006 January 21}

Created Nuweb {\tt hdiet.w}.

\date{2006 March 19}

Added a {\tt hdiet.js} target for the common JavaScript support and
included the {\tt externalLinks()} function to handle window targets
in XHTML 1.0 Strict compliant documents.

Implemented a {\tt trendfit} module to perform linear regression trend fitting
and used it within the {\tt monthlog::computeTrend} method, which now
returns the slope of the fit trend.

Added a {\tt monthlog::fractionFlagged} method which returns the
fraction (between 0 and 1) of days in a month which are flagged.

Added a line above the log summarising the weekly gain/loss, daily calorie
excess/deficit, and percent of days flagged.  The latter is shown only if
at least one day is flagged.

Added a title showing the month and year of the log, nicely styled
as in the {\tt hdread} output.

\date{2006 April 4}

Completed the first cut implementation of chart generation
from monthly logs with the {\tt monthlog::plotChart} method.

\date{2006 April 5}

Cleaned up the {\tt monthlog::toHTML} method, breaking the monolithic
per-day loop up into scraps which generate each column (or column group)
of the table.

\date{2006 April 6}

Implemented the {\tt monthlog::save} method, which saves a monthly log
item in a compact format that preserves all archival information.

Implemented the {\tt monthlog::load} method, which loads a log in the
format written by {\tt save}.

Implemented the initial version of the {\tt user} module, which manages
user accounts.  The {\tt quoteUserName} function handles the problem of
turning arbitrary UTF-8 user login names into file names acceptable for
a Unix file system.  We assume the underlying file system distinguishes
upper and lower case letters, but do not require it to handle Latin-1
or Unicode characters.  The user name transformation is reversible, but we
do not presently rely on this.

\date{2006 April 7}

Implemented the initial version of the {\tt session} object.  This object
contains information for an active session (logged-in user).  The
{\tt generateSessionID} function creates a unique session ID from
a UTF-8 login name by appending 16 pseudorandom bytes and then forming
the SHA1 signature of the value.  The session ID is embedded in documents
sent back and forth to the user over the course of the session.

\date{2006 May 21}

Changed the code which writes the {\tt test.html} document to create a
UTF-8 document.  This will permit arbitrary Unicode in text fields.  The
{\tt charset} declaration in the document header was changed accordingly.

If the monthly log contains editable fields, {\tt monthlog::toHTML} now
wraps the log in a form and generates ``Update'' and ``Reset'' buttons
at the end of the table which allow submitting the form to the server
or resetting all fields to their original values.

\date{2006 May 22}

Added code to the test jig to bulk convert all the CSV month databases in
a directory created with {\tt hdread} into {\tt monthlog::save} files
in another directory (both hard-coded for the moment---this {\em is} the
test jig!).  The log unit, last modification time, and trend carry-forward
are parsed from the ``{\tt StartTrend}'' line in the CSV files.  Something
like this may eventually find its way into the online application, but for
the nonce it's a handy way to populate test databases prior to any data
import facility's existing in the online edition.

Added a new ``{\tt administrator}'' field to the {\tt user} object which
indicates whether the user has administrative privileges.  At the moment
this is a simple 1 or 0 Boolean, but it could be extended to a numeric
privilege level should the need arise.

\date{2006 May 23}

Added {\tt save} and {\tt load} methods to the {\tt session} object to save
and restore sessions to the active session database directory.

Added fields to support the diet calculator, current exercise rung persistence,
and energy unit selection to the {\tt user} object.  Removed the last login
field, as we'll keep this in a separate file in the user directory to
avoid the risk of rewriting the {\tt user} database item for every
session.

\date{2006 May 26}

Integrated the new uniform HTML title into a subroutine that all HTML
generation may now call: \verb+write_XHTML_prologue+.  This routine
takes arguments which specify the file handle to which the prologue
should be written, the base URL for links back to the site, and the
specific page subtitle to be included in the page title.

Modified the test CGI log generator to use the new prologue generator
in order to test it.

To make things symmetrical, added a \verb+write_XHTML_epilogue+, taking
file handle and base URL arguments, which generates the standard
HTML file epilogue.

\date{2006 May 27}

Created a new package, {\tt html} to contain common subroutines used to
generate HTML in other packages.  The first member function is
{\tt quoteHTML}. formerly in {\tt monthlog}.

Added a new {\tt new\_account\_form} method to the {\tt user} object.  This
generates the form the user fills in to create a new account.  Fields are
filled in with values stored in the parent {\tt user} object, permitting
defaults to be pre-specified simply by setting the appropriate fields.

Moved the {\tt write\_XHTML\_prologue} and {\tt write\_XHTML\_epilogue}
to the {\tt html} object so other packages can use them, should that
eventually make sense.  They were already entirely free of references to
context in the main program.

\date{2006 May 28}

Modified {\tt quoteUserName} in the {\tt user} object to handle user
names which, when quoted, exceed the host system's maximum file name length.
If the quoted name is too long, it is truncated to the maximum length less
40 characters and the 40 hexadecimal character SHA1 digest of the entire name is
appended to the end.

Added {\tt save} and {\tt load} methods to the {\tt user} object which save
and restore user information in an already open text file.

\date{2006 May 29}

Added {\tt save\_active\_session} and {\tt load\_active\_session}
methods to the {\tt session} object to save and restore the active
session file which, kept in the user directory, provides a back-link
to the current session when a user is logged in.  Note that while {\tt
save\_active\_session} is a method of {\tt session}, {\tt
load\_active\_session} is simply a subroutine which reads an active
session file and returns its ID.

\date{2006 June 2}

Moved the current test page generation in the CGI request processing to
a separate section to clean up the main loop for addition of the
actual query dispatching logic.

\date{2006 June 3}

Added logic to create the session, back-link from the user directory
to the session, last login indication, and last transaction time when
a new login is validated.  If a session is already open for this user,
it is automatically closed.

Added a corresponding logout mechanism which cleans up all the active
session information.

\date{2006 June 4}

Added a ``chart'' query to generate a monthly chart.  This involved shuffling
some code in the main loop, since the chart must be generated before we send
the usual ``{\tt Content-type:~text/html} and set {\tt STDOUT} to UTF-8.

Added an image tag to the monthly log output to embed the chart for that
month into the log document.  Fixed a few XHTML validation nits introduced
in yesterday's additions to the log document.

Swatted another swarm of bugs in {\tt parse\_cgi\_arguments}, which I shall
surely still be fixing when the protons in my body are rent asunder by the
Big Rip.  This time it had to do with UTF-8 arguments which are bytewise
encoded with ``\verb+%XX+'' escapes, which must be decoded back to the
binary codes, and the resulting string then converted to the native wide
character encoding with {\tt Encode::decode\_utf8}.  Failure to do this broke
the new code to apply user changes in UTF-8 comment fields.  I modified the
code so that it should support UTF-8 in both argument names and values, but
anybody who indulges in UTF-8 argument names entirely deserves whatever
surprises may lurk there.  I also fixed an eccentric and ill-considered attempt
to escape quotes in CGI arguments.  This shouldn't be necessary, as they
should already be encoded as hex.

Completed the initial implementation of the {\tt monthlog::updateFromCGI} method,
which applies changes made by a user in a form containing a monthly log table
in the format written by {\tt monthlog::toHTML}.  The handling of omitted fields,
canonical value comparison, and deletion of existing fields is rather
intricate, and I'm sure some problems remain to be discovered, but detailed
testing will remain difficult until we actually apply the changes to the
log, which will be implemented in the near future.  The code {\em does not}
presently handle unit conversion when the log and display units are
different; this isn't a big thing, but I'll defer it until enough of the
related infrastructure is in place that it isn't hideously painful to test.

Broke up the CSS definition into logical pieces.  Documentation is still
sketchy, and all the table styles are still in one big messy box.

\date{2006 June 5}

Implemented proper handling for the case where the user submits an invalid
session ID (usually due to a session having timed out or the user's having logged
out from another window).  The login page is re-issued along with a diagnostic
indicating that the session has been terminated.  This is complicated by the
fact that the code which validates the session ID may be called from request
handlers such as those which generate charts, which are invoked before we've
output the ``{\tt Content-type}'' for an HTML result, as the login page
expects.  A little state variable directs traffic to avoid collision in this
circumstance.

Added {\tt convertWeight} and {\tt canonicalWeight} functions in the
{\tt monthlog} object to transform weight values from one unit to another
and express weight values in canonical form.

Implemented a {\tt propagate\_trend} function which propagates the trend
carry-forward from a specified month's log (or throughout the database if
no month is specified), and a new ``update\_trend'' request which uses this
function to recompute all the trend carry-forwards in the database for a user.

\date{2006 June 6}

Modified {\tt propagate\_trend} to correctly handle the case where
logs in the database use different weight units.  The trend is now
properly converted to the weight unit used in each log before
being saved in the log.

Added the ability to re-canonicalise weight entries in logs when
processing them with {\tt propagate\_trend}.  Note that the first
log processed, which is not usually modified by trend propagation,
will be updated if weight canonicalisation is requested.

Added the ability to specify the first month of the logs for
trend propagation with an ``m'' argument in the ``update\_trend''
request and force re-canonicalisation of weight entries with a
``canon'' argument.

Fixed the ``log'' request to force the ``m'' argument to ``now'' if
no such argument is specified.  Since the case of returning to the
current month's log is so common, this allows abbreviating the request
in URLs for this destination.

Replaced the code scattered all over the place which appended records
to the user history log with calls to a new subroutine, {\tt append\_history},
which permits the caller to append optional fields to the standard
contents of the log item.  This provides a handy place to document the
format of the log items.

Made {\tt update\_last\_transaction}, which updates the time of the last
transaction processed for a user, into a subroutine which can be called
from any code which knows the file name encoded user name.

Completed the initial implementation of the ``update\_log'' transaction.
This now writes the modified log back to the database if any changes
were made, appends a history item recording the month changes and the
number of changes made by column, updates the last transaction time, and, if
any weight entries were changed and this is not the current month, propagates
trend changes to subsequent months.  The user is returned to the log page
following the updates so that they can be reviewed.

\date{2006 June 7}

Laid in infrastructure for new account creation: handling of the ``new\_account''
request, validation of the request arguments, and re-issuing of the request form
with valid arguments pre-specified in case of error.  We currently validate that
the account name does not already exist, but do not actually create the new
account; this will be deferred until we decide on how account creation will be
validated.

Integrated the CPAN {\tt IDNA::Punycode} module (version 0.03) in our
{\tt HDiet} library, redesignating the module {\tt
HDiet::Util::IDNA::Punycode}.  This module is sufficiently obscure
that few potential users of this code will have it installed, and it's
hard to justify the bother of installing it server-wide for a single,
rather obscure, application.

\date{2006 June 8}

Added a new {\tt encodeDomainName} function which transforms a fully
qualified domain name piecewise to its RFC~3490 ``punycode'' representation
(if the argument is a numeric IP address or pure ASCII name, no
change is made and no harm is done).  This is now used in verification
of the domain name specified in the user's E-mail address, permitting
the use of international domain names in this field.

Cleaned up {\tt user:quoteUserName} to make all the testing for
permissible characters, special case quoting of spaces, and delimiters
for characters quoted as hexadecimal global macros defined at the
start of the program.  This allows the administrator to make their own
trade-off between easy-to-type user directory names versus those which
resemble what the user actually types to log in.

Broke up the {\tt user::new\_account\_form} method, which had grown to
unwieldy length by literate programming standards, into functional
chunks.  It is really cool to be able to specify pieces of a
Perl ``here'' document with Nuweb!

\date{2006 June 9}

Added fields to the new account creation form ({\tt user::new\_account\_form})
which invite the user to specify their height (in either centimetres, feet and
inches, or just inches).  This will be used for Body Mass Index computations.
JavaScript validation of the fields propagates changes in one set of units
to another, but ultimately it's up to the server to deal with whatever nonsense
is entered.

Added a {\tt monthlog::bodyMassIndex} method to compute the notorious
BMI value.  It called with an argument from the {\tt user} object which gives
the user's height in centimetres and an optional second argument which selects
either the mean for the month (zero, or omitted), the most recent value
(negative), or a specific day given by number.

\date{2006 June 10}

Changed the name of the user account information ({\tt .hdu}) file from that
of the file name encoded user name to the constant {\tt UserAccount.hdu}.  Since
these files exist with the user's directory, there is no need for their names
to also encode the user name, and it's just one more fussy thing to enter when
the administrator wants to poke around in the file structure.

Implemented the ``backup'' request, which allows the user to download a Zipped
archive containing all their monthly logs.  This is done by invoking the
``{\tt zip}'' program via the {\tt system} function, directing the output to
standard output.  The default file name is
``{\tt hackdiet\_log\_backup\_}{\em YYYY}{\tt -}{\em MM}{\tt -}{\em DD}{\tt .zip}'',
based on the current date in UTC.

Fixed a bug where the generation of a monthly chart by the ``chart'' request
erroneously had the HTML for an undefined request appended to the end of
the PNG file.  All binary result handlers should {\tt exit(0)} upon
successful completion to avoid falling into the regular HTML request
dispatcher.

Added a {\tt monthlog::exportCSV} method to export a monthly log in a
format essentially compatible with {\tt hdread} (the only difference is that
Unicode characters, which {\tt hdread} doesn't handle, are encoded as Perl-like
escapes as defined by our {\tt hdCSV} package).  This is used by a new
``csvout'' request which replies with the monthly log given by the
``m'' CGI argument encoded as CSV.  Note that the CSV is log is returned
with a {\tt charset} of ``{\tt iso-8859-1}'', as Latin-1 graphics characters
are not quoted in our CSV output, but all characters not present in Latin-1
are quoted.

\date{2006 June 11}

Added code to create a new account when everything validates in the new
account request form.  This drops the user back to the login form for
the newly-created account, which I twiddled so the user name for the new
account is pre-entered in the field in the login form.  The password must,
of course, be re-specified.

Implemented the {\tt user::sendMail} method which will be used to send mail
to users for validation, confirmation, and password recovery.

Added a password strength indicator to the new account creation form.  If
JavaScript is enabled, the user will be given a sense of how difficult their
password is to guess on a scale of 1 to 10.

Added a read-only checkbox on the new account creation form which shows,
keystroke by keystroke, whether the password and password confirmation fields
agree.

Integrated support for the JavaScript debugging console.  The master JavaScript
file now supports the {\tt dump} function, and the console can be included in
any HTML document by a reference to the ``{\tt JavaScript debugging console}'' macro.

\date{2006 June 14}

Amazing, how the days are devoured by locusts, isn't it?  Well, I'm
back for a few minutes at least until the next exogenous interrupt for
some triviality born of incompetence, to report the implementation of
a new {\tt determineTimeZoneOffset} function in the client-side
JavaScript which figures out the current offset between the client's
time zone and UTC (taking into account summer time and other
collectivist horrors, as long as the client machine is apprised of
them), and plugs the result, in minutes, into a hidden ``{\tt
tzoffset}'' form field, if present.  This will allow server-side code
to behave intelligently based upon the user's local time (for example,
not allowing entry into fields in the future, or displaying logs in
the user's future light cone).  This function is invoked from a new
{\tt initialiseDocument} function, which is now executed by the
``{\tt onload}'' event handler in our standard HTML prologue.  The
{\tt externalLinks} function, which patches the target of links
designated external in their ``{\tt rel=}'' attribute, is also
invoked by this function.

\date{2006 June 15}

Implemented the infrastructure for password expiration.  There is now a
new {\tt password\_expires} field in the {\tt user} object which
specifies the \UNIX/ {\tt time} after which the user's password
must be changed in the next login transaction.  If zero, the password
is immortal and need never be changed.  The expiration time is saved
and restored in the account information record, but is never actually
set nonzero, nor does any code enforce it at present.

\date{2007 February 9}

Added a {\tt resetPassword} method to the {\tt user} object.  It
generates a new password of the number of characters specified by the
argument, stores it in the user structure and returns it to the caller.
The password expiration date is not changed.

\date{2007 February 10}

Added a ``Welcome'' page displayed when the user logs in from
all of the major account functions are linked.

Implemented a rough cut of password reset to test the underlying
mechanisms.  Error reporting is still needed, as well as
validation of the E-mail address before performing the reset.

Added a task to the welcome page which permits downloading a
zipped backup of a user's database.

Added an ``Edit account settings'' task; this is presently
just a skeleton which does not actually modify the account settings.

\date{2007 February 11}

Changed all references to the URL used to invoke the CGI program to
references to a new ``{\tt URL to invoke this program}'' macro.

Rewrote {\tt parse\_cgi\_arguments} to use the {\tt CGI} Perl module,
which allows us to support file uploads for CSV import.  If a file
is uploaded using the special field name ``{\tt file\_upload}'',
the resulting temporary file is loaded into a ``{\tt file}''
key in the CGI argument hash.

\date{2007 February 13}

Integrated a pure Perl Text::CSV module into the build, installing the module
in HDiet/Text/CSV.pm.  I made several changes to the version 0.01 module I
downloaded from CPAN.  Mechanically, I modified it to run from our private
module subdirectory.  Substantively, I changed it so that ISO graphic characters
are acceptable within text fields; this is required for compatibility with CSV
files written by Excel and Palm files exported by HDREAD.  At the moment the module
remains named {\tt HDiet::Text::CSV}; I intend to change it to something like
{\tt CSV\_Hdiet} to avoid confusion if somebody has the standard module installed
earlier on their path.

Added debug code to the CSV import request handler which simply lists the
input lines and the fields parsed from them.  This will be an option for an
import in any case.

\date{2007 February 14}

Created a custom version of the CGI.pm module which is included
using:
\begin{verbatim}
    use lib "/server/bin/httpd/cgi-bin/HDiet/Cgi";
    use CGI;
\end{verbatim}
This version wraps a {\tt use bytes;} around the writing of uploaded
file data to a temporary file to avoid warnings due to the presence of
what appear to be UTF-8 characters in the uploaded data.

\date{2007 February 15}

Implemented a first cut of CSV import of Excel files.  The XHTML
output is ratty; there isn't any way to control listing options; and I
haven't tested it in numerous cases of overwriting the online
database, but it works in the basic import case.  The code needs
to be broken out into functional sections, but I'll defer this until I
integrate Palm CSV import, which will share substantial parts of this
code.

\date{2007 March 2}

Defined a ``{\tt CSV Format version}'' macro, initially set to ``{\tt 1.0}'',
which defines the format version of CSV files we export.  This is appended
as the last field of the ``{\tt StartTrend}'' record in a CSV monthly
log export.  The presence of this field can be used to distinguish a
CSV log we have exported from one generated by {\tt hdread} when importing
CSV records.

\date{2007 March 3}

Added import of HDREAD and CSV database dumped from this application.  We
automatically detect if it's our own export by the presence of the
CSV version number on the ``{\tt StartTrend}'' record .  If the record
is one of ours, the {\tt importCSV} method in the monthly log is
used to import the record.  Otherwise, it is parsed with the Excel
quoting syntax used by HDREAD.

\date{2007 March 4}

Implemented a {\tt replaceText} function in {\tt hdiet.js} which
replaces the text wrapped in a container specified by ID with

Modified the {\tt var} function to generate an HTML \verb+&minus;+ entity
for negative variances.

Added an {\tt updateVariance} function which fills in a new value in a variance
field specified by its ID.  The variance is formatted with a leading plus or
minus sign and the class is set so the variance displays in the colour corresponding
to its sign.

Wrapped ``{\tt span}'' tags around the statistics at the top of the monthly
log.  This will allow the values to be replaced when the monthly log
is recomputed locally after a change to a field.

\date{2007 March 5}

Added an {\tt updateFlag} function which is called from the {\tt onclick}
event of the flag checkboxes.  It scans all of the flag boxes and updates
the percent checked text item in the summary at the top of the log form.

Implemented a ``{\tt leaveDocument}'' function which is invoked from the
{\tt onclick} handler of any link in the Monthly Log form which departs for
another page.  The function checks whether there are any unsaved changes
in the form and if so gives the user a chance to cancel the departure and
save the changes.  Any user input field should call ``{\tt countChange()}''
in its {\tt onchange} or {\tt onclick} handler to indicate an unsaved
change has been made.

\date{2007 March 6}

Added an optional second argument to the \verb+user::new_account_form+
method which selects a form suitable for editing an existing account.
The user name, which cannot be changed in an editing operation, appears
as a static table field instead of a text input box.

The {\tt var} function, used to generate a variance item in a monthly
log form, referenced an undefined variable if called for a day with no
weight specified---fixed.

Added an optional third argument to the {\tt wgt} function which, if
nonzero, generates an \verb+&nbsp;+ place-holder for blank values.
This is used when generating blank trend fields in monthly logs to
permit them to be filled in when a weight is entered.

When a monthly log does not contain a trend carry-forward and the
JavaScript update code uses the first nonblank weight in the log
as the start trend, the code which retrieves the trend failed to
convert the text field into a number---fixed.

Variance fields in the monthly log used a class specification to set
the colour of the text, but this also affected the colour of the
borders of the table cell.  I moved the class to a {\tt span} item
which encloses the variance, and moved the {\tt id} of the field
so that the JavaScript code will reference the {\tt span} as the
enclosing container.

Added a type 7 history record for CSV importation which includes the
overwrite flag, a summary of lines imported, skipped as not log items,
skipped to avoid overwriting, rejected due to parse errors and, for
each month modified, the year and month and number of entries imported
into it.

Added a ``Cancel'' button to the Edit Account form which takes the
user back to the main account page without applying the changes in the form.

Added a ``Back to account page'' link to the Undefined Query diagnostic
page.  This is just a convenience for use in development work, as
this page should never be displayed in production.

Implemented the ``Modify Account Settings'' transaction handler.  Most
of the code is re-used from the ``Create New Account'' transaction.  I
removed some legacy kludge code which kept changes to the height field
from being applied properly.

Added {\tt enumerateMonths} and {\tt enumerateYears} methods to the
{\tt user} object.  The former returns the months and years in a user's
database, or just the year specified if called with a year argument.  The
latter returns the years in the user's database as a list of numbers.
These will be used to implement the calendar navigation page which
provides random access to monthly logs.

\date{2007 March 7}

The code in {\tt changeWeight} which used the first weight in the log
as the start trend if none was specified didn't work when first weight
had been specified in this editing session because it looked at the
value attribute instead of the dynamically updated value field representing
the contents of the text field.

Implemented the {\tt calendar} transaction which generates a page
with calendar-style links to all monthly logs in the database.  This
page should be extended so that missing months are linked to a query which
invites the user to create a new log for the month, and include a
form which permits creation of a log for an arbitrary month outside
the bounds of the database.

\date{2007 March 8}

Because the year and month specification passed to many transactions
with the ``{\tt m}'' argument is used directly as a file name, it must
be sanity checked to prevent abuse.  I added code to do this, which
validates not only the syntax but semantics of the year and month
specified.

Added code to the password reset transaction which confirms that the
E-mail address specified in the reset request matches that registered
for the account.  The E-mail address is used as an additional credential
for the user to avoid malicious password resets.

Since the login mechanism seems to be behaving reasonably well, I
changed the handlers for invalid user name and password over to
production mode, in which we do not indicate whether the user name
or password failed for an invalid login attempt, but rather issue
an identical message for failure of either.

Added calls to \verb+update_last_transaction+ for all the transactions
added in the last few days.  This will need to be reviewed for completeness
when the transaction set is finally complete.

Added a history record of type 10 to record login attempts with an
invalid password.

Added a little form at the bottom of the calendar navigation page which
allows the user to create (or display, if it already exists) a log for
any year and month from 1985 to the present.  This allows the user
to enter historical data in logs not linked to the calendars without
the need to start from an existing log and navigate forward or backward
to the desired new month.

Added a ``Back to account page'' link to the CSV Import form.  I also
corrected a duplicate and unnecessary {\tt id} specification in
this page.

Added a new {\tt histchart.pm} module to all the requisite places.  This
module will generate historical charts for a given user and date span.

\date{2007 March 10}

Our {\tt max()} amd {\tt min()} functions were flawed because they used the
truth value of a {\tt shift()} of the argument list to detect the end of
arguments, and thus stopped before processing an argument which was
numerically zero.  I changed the loop to test whether the argument was
defined.  This fixed the scaling problem in monthly charts where the
first weight or scale could fall outside the plotted range.

\date{2007 March 12}

Implemented a {\tt drawText()} function in the main program which uses
the {\tt GD::stringFT} method to draw text in a TrueType font with
arbitrary alignment within an open image.  The font files are kept in a
{\tt HDiet/Fonts} directory in the CGI installation tree.

Converted plotting of weight and exercise rung scales to use the new
{\tt drawText()} function, adjusting the right margin to compensate
for the change in width of the rungs in the ``Times'' proportional
font we're using at the moment.

Plotting of historical charts with a display unit different from the
log unit of one or more months in the database failed because while
weight and data were transformed to the display unit before plotting,
computation of extrema for scaling neglected to do this; fixed.

Updated HTML page and chart generation in {\tt monthlog} to support
the display unit specification in the user account and to use
{\tt drawText()} to plot axis labels in a proportional font, properly
aligned.  I changed the default display for stones and pounds display
units to include tenths of pounds, which were omitted on the Palm for
lack of display space.  Here, we can afford it.

Added an automatic adjustment of the left margin size when the display unit
is stones to allow the longer stones and pounds to fit.  The same fix was
applied to the scaling of historical charts.

Fixed several errors in the handling of pounds and stones in monthly
chart generation.  I'm sure that more remain, but at least it doesn't
obviously fall on its face when you select that display unit.

\date{2007 March 14}

Pretty much finished the first cut of the historical charting module
({\tt histchart.pm}).  A great deal of clean-up, limit testing, and
\ae sthetic refinements remain to be done, but I'll defer that until
I've implemented the ``Historical Chart Workshop'' request page which
generates requests for these images, as it's much easier to test when you
don't have to hard-code the chart arguments into the program!

Fixed a number of section hierarchy problems which had crept in due
to code being indiscriminately moved around without adjusting the
hierarchy level of the documentation.

\date{2007 March 15}

Trend carry-forward re-calculation in \verb+propagate_trend()+ was messed
up.  First of all, the code which is supposed to handle changes in the
log unit from month to month accidentally and unconditionally clobbered
the carry-forward from the previous month and, in addition forgot to
update the unit in the last log processed.

Modified \verb+propagate_trend()+ to use the {\tt user::enumerateMonths} method
to prepare the list of months instead of doing it itself by scanning
the directory.

Replaced the hard-coded path name on the ``{\tt use lib}'' declaration
at the top of the main program with a reference to the ``{\tt CGI
Support Directory}'' macro.

Added a ``Trend Recalculation Complete'' confirmation message and
link back to the account page on the trend repropagation results
page, which was previously blank.

Reorganised the account menu into sections, separated by a new
``{\tt skip}'' class for list items.

The {\tt monthlog::computeTrend} method miscomputed the first trend
entry for a month, just plugging in the trend carry-forward rather
than adjusting it based on the the first day's weight entry as for
all other days; fixed.

\date{2007 March 16}

Implemented a rudimentary ``Historical Chart Workshop'' to drive historical
chart generation.  At the moment it only supports custom date requests, has
a crudely thrown-together format for the request form, and minimal error checking.
But it's enough to exercise the custom chart plotting code without hard-coded
request arguments, and it can be incrementally matured into the real thing.

Modified the ``Historical charts'' item on the account page to go to the new
charting workshop instead of a hard-coded PNG graphic request.

Eliminated unused definitions of weight and energy unit in \verb+user::login_form()+.

Included our time zone offset field in all forms by means of a new
``Local time zone offset field'' macro, guaranteeing that it's uniformly
specified everywhere.

Added computation of trend slope and flagged percentage to {\tt trendfit} and
included a caption at the bottom of historical charts with the resulting analysis.
This required increasing the bottom margin by a line and a half to fit.

The decision as to whether display months as single letters or drop months
entirely in favour of just years was too coarse because the label increment was
forced to an integer.  I changed the test to use the original floating point value
before truncating it for pixel positioning.

The decision whether to plot years in year-only historical chart date axes was
broken because the code failed to reset the \verb+$single+ flag which had been
set earlier trying to fit in month labels---fixed.

Added a title to historical charts giving the date range plotted.

Added a separate pair of radio buttons in the New/Modify Account Settings
form so that the log and display units can be set independently.  This capability
was present from the outset on the Palm version but missing so far here, although
we did support monthly logs with a different unit than the current display unit.
The code needs to be reviewed to make sure that new logs are always created
with the current log unit from the user account properties.

Well, yes\ldots there were a few places where we could create a new log and fail
to set the log unit from the use preferences.  I think I've found them all now,
but this deserves another look when we get closer to production.

CSV import was not converting from units in the CSV file to log units.  This
was a known problem---I just got around to adding the logic for this.  It has
yet to be tested.

Added two new fields to the {\tt user} object to handle public accounts.
The \verb+public_name+ field is a string giving the name under which the user
account appears to the public, and \verb+public_since+ is the \UNIX/ time
at which the account was made public.  Since this will become a matter of
prestige, and gets reset if a user makes the account private and then
sets it public again, this is an incentive for users to make their data
public early and keep it so.

Added an indication to the ``Modify Account Settings'' form if the account has
administrator privilege: the text ``(Administrator)'' in green type follows the
account name in the static ``User Name'' field if the account is privileged.

\date{2007 March 17}

Renamed the ``{\tt histchart}'' module and object ``{\tt history}'' to reflect its
broadening of scope to handle trend analysis as well as chart plotting.

Modified {\tt history::drawChart} so that it reinitialises and cleans up after itself
so that it can be called any number of times from a given instantiation of a
{\tt history} object.

Changed the {\tt history} object so that the user object whose history is being
analysed and the name of the directory containing that user's logs are supplied
as arguments to the constructor rather than to the {\tt drawChart} method.  This
makes more sense as we add methods for other kinds of historical analysis such
as long-term trend computation.

Eliminated great snowdrifts of commented-out, disabled, or otherwise obsolete
code from the test jig.  Most of these were module tests which would no longer
work due to changes made of late, and kept popping up annoyingly in searches for
references to method invocations.

Added proper navigation buttons to the monthly log form, at either side of the year
and month in the title; removed the obsolete previous and next month links at the
bottom.

Removed a redundant ``{\tt tzoffset}'' field in the monthly log form.

Added {\tt previousMonth} and {\tt nextMonth} methods to {\tt monthlog}
which return the previous and next month as a list of year and month.
If the caller cares about whether such a log exists in the user's database,
that must be determined separately.  These methods can also be called as
functions from the package with two arguments giving the month and year
independent of any {\tt monthlog} object.

Tuned the decision as to whether plot daily weights with floats and sinkers
in historical charts empirically to plot them if pixels per day are greater
then 1.5 times the \verb+$sinkerSize+.

Added {\tt firstDay} and {\tt lastDay} methods to the {\tt history} object.
These return a list containing the year, month, and day of the first and
last entries in the database with a non-void weight entry.

\date{2007 March 18}

Added cross-reference symbol definitions for functions and key variables
in the JavaScript code.

Implemented a more or less working Trend Analysis page which uses the
{\tt history} object to produce standard analyses for five intervals
between one week and one year ending with the most recent log entry, and
allows the user to specify a custom interval for trend analysis.

\date{2007 March 19}

Added support for the standard historical chart intervals specified by the
radio buttons, and set the historical chart to default to the last quarter
if no duration is specified.

Ported the code which handles out-of-range and backwards custom interval
specifications from the trend analysis handler to the historical chart
generator.  Note that the actual PNG chart graphics generator currently
accepts whatever ``{\tt start}'' and does little or no format or range
checking on them.  If somebody makes up a URL with idiotic arguments, it is
quite likely they'll crash the program and get a 500 for their effort, but
since chart generation is read-only with respect to the database, they
can't damage anything.  Still, this should be bulletproofed as a matter
of general principle, but I'll defer this until I'm happy with the code
for the same purpose in the main request form processing, at which point
I can simply use it in the graphic generation argument processing as well.

Changed the default page after sign in back to the current monthly log.
Now that we're improving navigation, that's the logical starting point
for most people.

Changed the left margin of the default body page in the CSS to 10\%.  Since
most of our presentations are tabular, this makes more sense and leaves more
space for lengthy comments in monthly logs.

Fixed several XHTML validation errors which had crept into the monthly
log page.

Implemented the random-access navigation bar and added it to all of
the pages displayed while a session is active.

Reworked outbound links to the site home and book home pages, defining
macros for both URLs.  These are now fully qualified URLs including the
HTTP protocol, which will ``break out'' of HTTPS when leaving the
application, avoiding unnecessary encryption of static content on
the site.

Removed page bottom links made obsolete by the navigation bar.

When a monthly log was displayed in a display unit different from the
log unit, the ``{\tt t0}'' trend carry-forward value was still given
in the log unit.  I added conversion to the display unit.

Added abbreviated weight entry to the JavaScript code.  In the
process, I discovered a whole swarm of bugs in {\tt editWeight}---almost
one per line of code.  I think they're all fixed now.

Added support for pounds and stones in the {\tt changeWeight} JavaScript
function.  It now uses a new {\tt parseWeight} function to extract numerical
values in pounds or kilograms from weight and trend fields, automatically
converting stones and pounds into pounds.  In addition, I fixed the completely
bogus way it chose trend from which to update from the change to the end
of the log.  It will now start with the previous day's entry unless the change
was to the first day in the log, in which case it uses the trend carry-forward
or, if that is not known, the new weight itself.

Added copying of the most recent rung and comment fields in a monthly
log by entering a period in a blank field.  Weight, rung, and comment copying
all display an alert if the user enters a period and the monthly log contains
no nonblank previous field to copy.

\date{2007 March 20}

Added the framework for ``administrator-only'' transactions.  The
account page now has a section which is generated only for users with
administrative privilege.  A separate section in the transaction
dispatcher is reserved for such requests, and a macro, ``{\tt Verify
that user has administrator privilege}'', which may be called any time
after the session and user information are obtained, handles
everything associated with checking for administrator privilege and
blowing away a user without it who dares to make a forbidden request.
All such events are logged in the user's history file.

Added administrative transactions to generate invitation codes for the beta
test period.  These codes are random passwords kept as files in an
``{\tt Invitations}'' directory within the database tree.

Implemented invitation codes for user account creation.  The invitation code
is deleted only after the new user account has been successfully created.

Removed a large number of exported functions from our object-oriented modules
which were never called as unqualified functions from elsewhere.  As long
as a function is used exclusively as a method to an instantiated object,
there is no reason it need be exported.

Automatic weight axis scaling for historical charts was messed up due to
a typo in the definition of the ``factors'' array---fixed.

Completed the initial implementation of public names, including the
ability to request a public name at account creation time or thereafter
from the settings page, and for a user to either cancel the public
name or request a new pseudonym.  All of these operations are logged
in the account history.

\date{2007 March 21}

CGI arguments passed through the environment with {\tt GET} were not being
decoded from UTF-8 and were consequently garbled.  What I think is going
on is that when using {\tt POST}. our setting the discipline of {\tt STDIN} to
``{\tt :utf8}'' suffices to guarantee that the strings are properly
decoded.  When they are passed through the environment, however, this does
not happen.  I hammered a loop into \verb+parse_cgi_arguments+ to manually
call \verb+decode_utf8+ on each argument value.  This may break POST by causing
double decoding---I have not yet tried this.  It may suffice to do this in one
whack on the \verb+%ENV{QUERY_STRING}+ after it is decoded from HTTP encoding.
(This would permit UTF8 in argument names as well, but we won't do this
in any case.)  This would have to be put into the {\tt CGI} module, as
I don't think there's a way to splice the decoding in the middle.

The so-called ``\verb+first_login+'' field in the {\tt user} object was never
being set.  I changed it to \verb+account_created+ and added code to set it to
the time the new account was added, which is more significant than the first
login anyway.  If the user never logs in, this will be apparent from the
{\tt LastLogin.hdl} file in the user directory anyway.

Added a very rudimentary {\tt monthlog::exportXML} with a line to link
to it from the monthly log.  This will allow pilot testing XML encoding
before we dig it deeper into the program.  The export method takes an argument
in addition to the file handle which determines whether it emits characters
with code points of 128 and above as UTF-8 or encodes them as XML numeric
(hexadecimal) entities.  If the latter is chosen, the file will be bigger
if it contains non-ASCII characters, but can be edited without a
UTF-8 aware editor.  Note that non-ASCII characters can occur only in
comment fields of logs.

Consolidated the various XML generation utilities in a new {\tt xml.pm}
package which is used by the other packages which have need of XML
escaping, etc.

Integrated the XML Document Type Definition ({\tt hackdiet.dtd}) into the
main program web and added it to the {\tt publish} target in the Makefile
so it's automatically installed in the static Web directory whence exported
XML databases reference it.

Added account menu items for deleting all logs in the database
and deleting the user account.  Neither of these are implemented
yet.  Both of these items will require the user to enter their
user name and password to confirm the operation.  In addition, the
account cannot be deleted unless the database is first cleared.

Implemented the first cut of the database export form.  This will eventually
allow you to specify a range of months to export and the export format.
At the moment it always exports the entire database in XML.

\date{2007 March 22}

Added methods to the {\tt user} object to export user information,
preferences, and the diet plan parameters to a complete database
dump in XML format.

I was a little too enthusiastic about removing module exports of
object methods: \verb+:session::load_active_session+ is called as
a function at login time without reference to a {\tt session}
object, and hence must be exported.

Added logic to the trend analysis and database export forms which presets
the year and month of the from and to dates to the first and last month
in the database respectively.  In the case of the trend analysis, this
presetting is done only when the form is first displayed.  If it is
being displayed pursuant to the ``Update'' button being pressed on an
earlier Trend Analysis form, the custom start and end dates of that form
will be preserved.

Hammered on {\tt changeWeight} in the JavaScript code until it seems to
behave properly in all the cases of entering data after one or more skipped
days.  The trend is propagated down without change from the last known
day (or the carry-forward if this is the first non-blank entry in the log),
but blank entries from the last non-blank to the end of the month are not
given a trend value.

Implemented month range output in the ``Export Log Database'' transaction.  This
reuses the range definition code from the trend analysis transaction, rather
messily and inefficiently---I'll clean it up once all the range processing
transactions are in place and it's possible to review what can be factored out
without lots of wires hanging loose..

\date{2007 March 23}

Implemented database export (including ranges) in our extended CSV format.
Multiple months are simply concantenated in the CSV file, which allows the
import code to note changes in the log unit from the header lines before
each month's log entries.

Integrated the skeleton {\tt XML::LibXML} parser and added code to the
import handle to automatically distinguish XML from CSV imports.  At the
moment the XML file is simply dumped to the CSV listing stream, but it
does demonstrate that all is well with detection and parsing.

If the user wished to export a single month from the ``Export Log Database''
transaction, nothing would be exported because having the same start
and end month and year was considered a null interval.  I set the (otherwise
ignored) start and end days to 1 and 31 respectively so that specifying
the same start and end month would not be considered a null request.

After further reflection, induced by trying to develop a CSS style sheet which
would render an XML database export in some reasonable fashion, I introduced
some more hierarchical structure in the XML export format.  The will provide
opportunities for the CSS to intervene as the output is being rendered into
primate-readable form.

Added a ``{\tt Z}'' to the UTC date and time items generated for XML
database exports to comply fully with RFC 3339.

Integrated the {\tt hackdiet\_db.css} style sheet into the main program
Web.

\date{2007 March 24}

Added code to obtain the last trend value from the most recent previous
log in the database and fill it in to the trend carry-forward when creating
a new log or loading a log which, for whatever reason, has a trend carry-forward
of zero.

Changed the display of trend values in the monthly log to omit trends
for days after the last specified weight to the end of the log.  This is
consistent with the behaviour of the JavaScript code for live updates to
the log.

Installed Walter Zorn's \verb+wz_jsgraphics.js+ package in the main
directory and added code to the Makefile to install it in the production
directory.

Added a {\tt canvas} division to the monthly log XHTML and code to the
JavaScript module to position and size the canvas to overlap
the chart and create a plot object to draw into it.

Added a resize event handler to the monthly log document which repositions
the canvas over the new location of the monthly chart.

Added records to the full database CSV export format which encode all
of the fields from the {\tt user} object which are included in the
{\tt account} element of an XML export.  This will permit the full restoration
of an account, including user preferences, from a CSV export as well
as one in XML format.

\date{2007 March 25}

Automatic scaling of monthly and historical charts did not include the
trend carry-forward in the computation of weight scale extrema, with the
result that if the starting trend was the extreme value for the month,
it would be off-scale.  I added the starting trend to the computation, and
also fixed a bug in historical chart scaling which failed to include the
trend maximum in the maximum weight calculation.

Trend plotting on historical charts with multiple pixels per day did
not handle missing weight entries.  I changed it to plot the trend
from the first entered weight to the end of the chart.  I may add plotting of
the imputed trend from the first specified day to the first entered weight.

Implemented the ``Delete All Logs'' and ``Delete User Account'' transactions.
Both of these transactions back up the user account (if ``Backup Directory'' is
non-null) before destroying user information.

\date{2007 March 26}

Installed a back-door password which allows creation of new accounts in beta
test mode without using up an invitation.  Naturally, I'll remember to disable
this before putting the beta test version into production.

Added an ``{\tt epoch}'' item to XML and CSV full database backups which
gives (in {\tt xmlTIME} syntax), the date at time at which the backup
was made.  I added appropriate language to the XML DTD and style sheet
to support this new field.

Added a {\tt toHex()} utility function which converts an arbitrary Unicode
string argument to space-separated hexadecimal character codes.  This is
handy when debugging problems with non-printing characters.

When a user pastes exported CSV values in the direct import box, the
browser is sometimes confused by the DOS end of line sequences and sees
extra blank lines.  I added code to keep these lines from confusing CSV
import---they are now simply discarded as ``parsing errors''.

Re-worded the database import page to handle both CSV and XML import
formats.

Implemented XML format import.  A listing of synthetic records parsed from
the XML is output if listing is enabled.

Added a field to the history record for import which indicates the
format: Excel, HDRead, or XML.

Added a {\tt monthlog::computeChartScale} method which replicates the
process by which {\tt plotChart} auto-scales the chart and returns a
string containing all the relevant scale factors which can be
embedded in the monthly log document whence the JavaScript code can
use it to plot new log entries on the chart.  The items in the
string correspond to the following variables in the program:

\begin{verbatim}
    $bX
    $pixelsPerDay
    $bY
    $weightMin
    ($extentY - ($bottomMargin + $topMargin))
    ($weightMax - $weightMin)
    48
\end{verbatim}

The ``{\tt 48}'' value is the maximum rung, and included so the plotting
code need not hard-code it.

Implemented the first installment of the administrator user account manager.  At
the moment, it simply lists the accounts and selected properties from their
{\tt user} objects and monthly log database collection.  Eventually buttons
for each account will permit purging databases, deleting accounts, or assuming
an account's identity for poking around.  Dangerous commands will require
confirmation by entering the administrator password in a field at the bottom
of the page.

Added support for assumed identities by the administrator.  The account administration
page contains a radio button for each account.  By choosing the account and
pressing the ``Access'' button (which does not require password confirmation), the
chosen account is set as the \verb+effective_name+ of the administrator's session.
Afterward, accesses from the session will go to the chosen user's database, until
the administrator clicks the ``Exit'' button in the ``Administrator accessing''
notification shown on all pages while access to another account is underway.

\date{2007 March 27}

Added the initial implementation of real-time display of entered weights in
the chart.  Weights are plotted as usual, with the colour indicating the state
of the flag, and are updated if the flag is checked or unchecked.

Checking flags in a log in which no days were previously flagged encountered
a JavaScript error because the fraction flagged text was not generated.  I
changed the log document generation to always include the fraction flagged
text but disable its being displayed if no days are flagged.  The {\tt updateFlag()}
function sets the text visible if one or more flags is checked.

Added a test to the password strength estimator for bozo passwords of
``{\tt password}'' and the like (case-insensitive).

Implemented export of logs in Palm {\tt hdread} and legacy Excel CSV formats.
Both of these export styles encode any Unicode characters present in comments
as XML/XHTML hexadecimal character entities to prevent losing information.
This transformation is {\em not} reversed on import---these formats are
intended only for transmitting data to these pre-existing applications.  If
the user is concerned with preserving everything, they should use our native
CSV or XML export formats.

\date{2007 March 28}

Hacked in the crudest rough approximation to user browse access to public accounts.
At the moment this just fake up unrestricted administrator alias access---all of
the logic for genuinely restricted access has yet to be implemented.

Added a restrictive sanity check for the syntax of session identifiers to
prevent attempts to escape from our file tree.

Modified the character set used to generate reset passwords and dangerous operation
confirmation codes to exclude easily-confused characters such as ``{\tt 0O1li}''.

Added logic to the Utilities page to eliminate items from the menu which aren't
permitted when browsing a public account.  The heading is modified to indicate
the user's real identity and that of the public account they're browsing, and
extra menu items are included to quit browsing or select a different account
to browse.

Added an optional argument to the navigation bar which allows disabling the
``Settings'' item whilst browsing a public account.  The user isn't permitted
to change the settings, so there's no reason to provide a link to something
which won't work.  This is presently specified on all references to the
navigation bar, but may be removed eventually on those which can never be
accessed while browsing a public account.

Added ``{\tt title}'' attributes to the items in the navigation bar to explain
in more detail what they do.

Implemented a new argument to the {\tt monthlog::toHTML} method which informs
it we're generating a log for somebody browsing a public account.  The log
entries are all set to static regardless of the editable days specified and
the comment field is excluded from the table.

Implemented the restriction on transactions available when browsing a public
account.  There is an explicit list of permitted transactions in a hash
which is checked when the session parameters are loaded and the request
aborted immediately (killing the program) if the user is marked as browsing
and the transaction is not permitted.  We might defer this check until the user
information is retrieved, which would allow logging it in the user's history,
but the message in the HTTP error log is probably sufficient to see if
somebody is probing our defences.

Live updating of monthly charts was imprecise because it used the displayed
weight and trend values, which are rounded to one decimal place, while
the CGI-generated chart uses the full precision value.  I added hidden
fields named ``{\tt T}{\em n}'' and ``{\tt W}{\em n}'' which provide these
values to four decimal places for use by the live update code.  I will
change the CGI chart generation code to also round to four decimals before
plotting so that the values should agree.

\date{2007 March 29}

Implemented the beginnings of a session manager.  At the moment it just displays
information from the session file.  It includes a button to select a session to,
for example, force close it, but the button presently generates an unimplemented
transaction.

Shuffled the order of the code in the historical chart request form generator
so that the ``Custom'' date fields are preset to the first and last dates in
the database if not previously set, as already done by the trend analysis page.
In addition, I was able to re-use some of the form generation code for the
trend analysis page and eliminate code specific to the chart page.

Made the commonly-used code which determines the first and last days in the
database into a macro which is used in database export, trend analysis, and
historical chart generation.

Added \verb+<label>+ tags to the account creation/modification form to assist
in navigation by non-graphical browsers and text to speech programs.

Added label and tabindex items to the sign in form to improve navigation.

When plotting a chart for which we have no information whatsoever about the
scale (no trend carry-forward and no monthly log entries---as is the case
for a brand new user), we now set the scale to encompass the 5th through
95th percentile of adult human weight including both males and females.  A
scale showing this range is plotted even if the chart contains no weight
entries.  This provides a first-cut framework for live plotting of the initial
chart entries by a user.

Added syntax and sanity checking of exercise rung values.  The value is checked
regardless of whether it was entered explicitly or copied from the previous
value.

Added ``{\tt +}'' and ``{\tt -}'' short-cuts for the rung field which enter a
value one greater or less than the previously non-blank rung.

Added sanity checking for weight entries.  If a newly entered weight differs by more
than 6\% from the current trend, pop up a confirmation box which alerts the user
to the possible error and provides an option to return to the field to
correct it.  An analysis of more than 18 years of my own data shows a
maximum daily variance of 4.6\%, so the threshold of 6\% is quite conservative
and unlikely to generate false alarms.

There is a bug in Mozilla Firefox which breaks setting of the keyboard focus
to an input field.  A known work-around is to execute the {\tt focus()} method
after a one millisecond delay.  I implemented this, wrapping it in a new
{\tt resetFocus} function so it can be made browser-dependent and tweaks as
further discoveries may require.  This doesn't seem to bother Opera, but I
have not yet tested it with Exploder.

\date{2007 March 30}

Hammered in a little gimmick which provides the administrator a box at the bottom
of the monthly log form which, if checked, dumps the log database record with
the {\tt monthlog::describe} record.  This is just intended to help debug live
update, where it's really nice to be able see what actually came from the
database.  It is {\em not} safe in the general case, since the {\tt describe}
method does not perform XHTML quoting on comment fields, etc.  If it proves
sufficiently useful to leave around, I'll have to add an argument which causes
it to do that.

Changed the ``{\tt darwin}'' style for buttons that do hazardous things to use
a ``{\tt background}'' style instead of the more appropriate
``{\tt background-image}''.  Why?  Because brain-dead Exploder (both 6 and 7)
blithely ignores the latter if in ``Windows XP Style'' (whatever that is).
See Microsoft Krap Bulletin 322240 for details.

Implemented logic in transaction processing to detect when no ``{\tt q}''
CGI argument is specified and, if that be the case, to parse any argument
whose name field contains an equal sign into a name and value pair, which
are stored in \verb+%CGIargs}+.  This allows us to work around the idiot
Exploder bug in which the {\em content} of a \verb+<button>+ tag is sent,
as opposed to its {\tt value}.  By using an \verb+<input type="submit">+
tag instead, and specifying the transaction in the {\tt name} field as,
for example, ``{\tt q=account}'' we can dodge that bullet.

\date{2007 March 31}

Converted all the \verb+<button>+ tags to use the work-around described
above.  Until more complete testing is completed, especially on Exploder
6 and 7, I've left the original button tags in, commented out.

\date{2007 April 1}

Roughed in the beginnings of the diet calculator.  The basic form and the
code which initialises the fields from the {\tt user} structure is present, but
calculation of most derivative quantities and all of the update handling code
have yet to be done.

I wish this were an April Fool's joke, but for some reason uploading large
CSV files takes absolutely forever and the CSV process runs afoul of the Apache
timeout.  This has nothing to do with this application---I can reproduce it
sending the upload to {\tt EchoCGI}, and it has nothing to do with the firewall
since I can reproduce it from Lynx running directly on Server0.  A 161 Kb text
file times out even after I increased the timeout on Server0 to 300 seconds.
At the moment I have no idea whatsoever what's going on.  Until this is resolved,
we'll simply have to warn people to upload bulk CSV jobs in smaller chunks.
The problem occurs regardless of whether the information is sent via a file
upload or pasted into a \verb+<textbox>+, so it appears absolutely generic
to the HTTP transfer.

\date{2007 April 2}

Added calculation of all derivative quantities from the primary
parameters (those saved in the {\tt user} object) for the diet
calculator.

Further investigation of the problem importing large CSV files led me down
a well-lit blind alley when I discovered that a CGI program which
reads and echoes its POST input on standard input will hang up
precisely as my testing with {\tt EchoCGI} revealed.  However, even
when we're echoing CGI input, we don't do this---we read the entire
imported input and then process it.  Turning off the echo of the
CGI input (which I made a checkbox option, as it was always intended
to be) didn't help: the result was nothing imported and an undefined
variable reference, which turned out to be the CGI {\tt file} parameter.
Remember back on March 21 when I put in that fix to \verb+decode_utf8+
the GET arguments and worried that it might break POST?  Well, it did,
and the full CSV export I was testing was the first case which ran
into that particular trap.  If the file imported includes characters
with the high bit set which look like UTF-sequences but aren't, the
decode process returns {\tt undef}, which results in the null import.
For the moment, I put in a special case to skip the decoding of the
{\tt file} argument.  This is all going to have to be reviewed when we
go to POST submission for all forms, which should probably be done
sooner rather than later.

Removed the ``Download monthly log'' in CSV and XML links from the
bottom of the monthly log page.  This is a sufficiently rare operation
that the user doesn't need to see it on every update to the log, and
that and more can be done from the export page when required.

Added {\tt onchange=} items to all fields of the diet calculator to
allow the JavaScript to update dependent fields.  I added a second macro
argument to the ``Custom trend start date'' and ``Custom trend end date''
macros which cause them to include {\tt onchange=} attributes for each
of the date component selection fields they generate.

\date{2007 April 3}

Implemented the administrative function to force close a user session,
which automatically cleans up the case where, for some reason, an active
session points to a user whose {\tt ActiveSession.hda} file points
back to a different session.  This is the first full-fledged administrative
command requiring password confirmation, so it involved putting in place
much of the infrastructure which other session and user administrative
commands will use.

Restored plotting of weight in multiple day per pixel historical charts.
The weight is plotted in dark grey, before the trend is plotted in red,
so it acts as an envelope for the trend.

Similarly, added plotting of weight to multiple pixel per day historical
charts which are too dense to plot weight as floats and sinkers.  This
provides a smooth transition from multiple days per pixel to multiple
pixels per day without the former ``format speed bump''.

Implemented administrator deletion of a user account in the Account
Manager.  As with a user-requested close of an account, the administrator
cannot delete an account unless any active session has been closed
and all logs have been purged.

Made the ``salt'' for encoding the confirmation codes for destructive
operations a macro, permitting it to be easily changed to a non-public value
when putting the code into production.

Added a check to the close user account transaction to confirm that there
are no user logs {\em at the time of the actual close}.  This protects
against a user manufacturing a confirmed close transaction, bypassing
the usual request form, or saving a confirmed close transaction and
replaying it after new logs have been created.

\date{2007 April 4}

Implement administrator log purge.  The logs are backed up before being
purged and a type 14 history record is appended indicating the number
of monthly logs deleted.

Added a new \verb+is_user_session_open+ utility function which administrative
operations call to determine whether an active session should prevent them
from proceeding.  The function not only checks for the presence of an
active session file in the user directory, but validates that a session
file in the {\tt Sessions} directory with the same ID points to the user.
If the session is orphaned (active in the user directory, but no session in
the {\tt Sessions} directory), it is automatically cleaned up and reported
as closed.

\date{2007 April 4}

Added JavaScript parsing for all of the fields in the diet calculator except
for the start and end dates.  A new {\tt parseSignedWeight} function is used to
handle weights which may have a sign prefix.

\date{2007 April 6}

Memo to file: JavaScript (at least on Mozilla Firefox 2.0) does not detect
duplicate definitions of a function.  No error message will be issued, and
only one will be called; you can make changes to the other until you're
blue in the face and have no idea why they don't affect the result.

Added diet calculator update from all primary fields, and handling of
retrieval of dates from selection fields and setting selection fields
from JavaScript UTC millisecond time values.  Back-calculation from
modifications of dependent fields has yet to be added, and the whole
thing needs extensive testing.  Note that we have no code as yet to save
the primary values in the {\tt user} object.

Moved the hidden ``{\tt du}'' and ``{\tt eu}'' (display and energy
unit) fields in the diet calculator down into the paragraph with the
buttons to avoid a validation error and fixed a bad ID specification
for ``{\tt eu}''.

Added the ``No JavaScript'' warning to the diet calculator page, along
with an ``Update'' button to submit the form for recalculation.  Both of
these items are displayed only if JavaScript is absent or disabled.

Added label tags to fields in the diet calculator form for which they
make sense.  I'm not sure how to handle labelling a composite field
such as the start and end dates which consists of multiple input fields.
At the moment, I simply made the labels point to the first field in the
sequence, and hope the user can figure out to tab to the subsequent
controls.

Changed the background colour of the sign in, account management, and
diet calculator tables to conform with our general blue theme.

Added the ability to specify a buffer zone around the weight extrema when
auto-scaling a monthly log chart so as to leave room for new entries
plotted live.  At the moment this is set to 1 kg / 2 lb; we'll adjust it
based on experience.  The size of the zone is set by the ``Monthly Log
Weight Range'' configuration parameters.

Implemented the {\tt countChange()} mechanism to keep track of changes
in the diet calculator and warn if the user is about to navigate
away from the page with unsaved changes.  The ``Reset'' button clears
the change count as well as restoring all fields to their original
values.

Added an alternative {\tt span} to the ``End date'' field which displays
``{\em Never}'' if the end date is computed to be before the start date.
This indicates that the user has the daily balance set in the wrong
direction with regard to the initial and goal weights.

\date{2007 April 7}

Implemented saving diet calculator values in the {\tt user} object.  The ``Save''
button updates the user account record and re-displays the diet calculator
with the updated values.

Converted form processing action from ``get'' to ``post'' to wring out any
UTF-8 or other bugs in that mode.

Implemented a well-defined algorithm for plotting sparse data as line
graphs, as defined in section \ref{Plotting sparse data}.  Used this
algorithm initially to plot exercise rungs in monthly log charts, which
should improve consistency with live plotting of data being entered.

Used the new sparse data plotting algorithm for live plotting of exercise
rung inputs.  The algorithm translates into code a little differently
since we know the current day is defined (otherwise we wouldn't be
plotting it), but the effect is the same.  Entering rung data out of
order may result in a messy plot, but all will be cleaned up when the
log page is updated.

Monthly log charts displayed for months not yet in the database defaulted
to the human species range rather than scaling around the trend carry-forward
because the chart plotting code free-lanced its own log reading routine
rather than using the ``Read log if in database or create blank log if it's not''
macro which fills in the trend carry-forward from the most recent previous log
in the database---fixed.

\date{2007 April 8}

Modified changing energy and weight units in the diet calculator to work
in a much more sensible fashion.  When you change units, the affected fields
are converted to the equivalent values in the new units, resulting in no
changes other than those due to round-off in the calculator solution.  The
whole idea of changing units in the calculator is somewhat dubious, but
implemented because a user may want to try out solutions in comfortable units
from childhood and those learned as an adult.  In any case, this feature smoked
out a number of bugs in the handling of stones, including totally bogus editing
of negative values in stones.

Added column headings to the ``Browse Public Accounts'' form.  The fields in this
form should mostly be centred, but I deferred that for the moment until we're
sure the current set is complete.

The {\tt monthlog::editWeight} function mis-handled negative weights in stones
and pounds mode.  I fixed this, and changed the output in all units to use
the XHTML \verb+&minus;+ entity for the minus sign on negative quantities.

Fixed a zero-based/one-based bug in saving the diet calculator settings which
caused the start and end dates to walk forward one month and one day every
time they were saved.

Calculation of the rate of weight change failed on initial display of the diet
calculator when the energy unit was set to kJ---fixed.

After further reflection, I decided to modify the diet calculator to always keep
the primary quantities saved in the {\tt user} structure in terms of calories
and kilograms, and convert to whatever energy and display weight unit the user
has set when they are loaded, converting back when they are updated.  This
requires care to prevent rounding problems, but avoids all difficulties with
the user changing units which make the saved diet calculator settings
meaningless.

\date{2007 April 9}

Implemented plotting the diet plan in monthly charts.  The plan is plotted
as a dashed yellow line.

Implemented plotting the diet plan in historical charts.  Verified that it plots
correctly with units set to kilograms, pounds, and stones.

\date{2007 April 10}

Backed out the gimmick in {\tt monthlog::editWeight} which replaced ``{\tt -}'' with
``\verb+&minus;+''.  The latter looks nice, but JavaScript doesn't understand how
to parse numbers with a leading Unicode minus sign.

\date{2007 April 12}

Legacy Excel CSV exports were missing the carriage return line terminator
on the column heading lines---fixed.

\date{2007 April 13}

Added logic to the ``Update'' button handler to detect if more than one field has
been changed and issue a warning that this may result in infelicitous results.

\date{2007 April 15}

More whacking away at handling static updates to the diet calculator.  Fixed a
number of lost-through-distraction problems with weight and energy unit
storage in the {\tt user} object vs.\ their display values in the diet calculator
form.  Many bugs have been fixed, but much remains to be done.

\date{2007 April 16}

Fixed a rounding error when parsing the diet duration in weeks in a static update
to the diet calculator---it no longer ``creeps'' upward.

Parsing of the existing start date in a static update of the diet calculator was
completely bogus---fixed.

At this point I am now ready to assert that diet calculator static (no
JavaScript) updates are correct.  Much more testing is required to
justify this triumph of confidence over confirmation but, hey, I
haven't found any bugs in my five or ten minutes of testing so far!

Turned off, for the nonce, debugging output from static diet calculator
updates.  It'd still all in the code, commented out, and can be re-enabled
as required when arthropods exsquiggle from the cracks in our crystalline
code.

\date{2007 April 17}

Added code to log failed login attempts with {\tt Sys::Syslog} in a format
which will cause Gardol to treat them like failed FTP logins and eventually
block the sending IP address after too many consecutive failures.

\date{2007 April 18}

Implemented static dittoing of rung and comment fields in monthly logs
and dittoing and abbreviated entry for weight fields for user without
JavaScript.  All of the logic is implemented in the
{\tt monthlog::updateFromCGI} method and simply ignores the
entry if no previous entry can be found.

Bashed in a rough but usable feedback page so beta testers can send feedback
without running the gauntlet of the regular feedback form.  I may not be
able to resist the temptation to spiff this up with JavaScript, a
preview button, etc. but on the other hand I may.

\date{2007 April 20}

The {\tt quoteHTML} function did not work on arguments which contained more
than one line of text---fixed.

Added an echo of the message sent to the feedback confirmation page.

\date{2007 April 21}

Added a checkbox to the Send Feedback form which causes a copy to be
sent to the user who submitted it.

Corrected a validation error in the feedback form due to an extraneous
table row tag.

Dern tootin' I couldn't resist putting in a preview feature for the
feedback form.  I can hardly gripe about badly composed messages if I
don't let folks see how they're going to look.  I also put in a little
JavaScript validator which natters if the user has not chosen a message
category before pressing the ``Preview'' or ``Send Feedback'' buttons.
The categories have been moved up from being embedded in the feedback
form to the feedback configuration section so it's easy to find them
when the time comes to revise them.

Added a type 16 history log item for the sending of a feedback message,
including the category as text.

\date{2007 April 22}

Added a ``{\tt production} target to the {\tt Makefile} to install the
application in the production server directory.  This uses variants of the
various directory definitions with a ``Production'' prefix.

Fixed unequal separation between the previous and next month buttons and
the month and year heading in the monthly log form.

Deleted all of the commented out ``button, button'' tags remaining from
the fix for the Exploder button problem.  See the third paragraph
under March 30th above for details.

Added a {\tt Bowdler.pl} program to bowdlerise the source code
before publication and distribution.  All sensitive information
(for example passwords, ``salt'' for encryption, etc.) are changed
to innocuous strings.  The program is, of course, able to bowdlerise
itself, becoming the identity transform.

Implemented the {\tt history::syntheticData} method, which fills a
field in a specified date range with synthetic data specified by
exquisiteky subtle arguments.  This is presently crudely invoked from
a no-parameters item in the administrator account page; this will be
replaced by a form with all parameters variable in due course.

\date{2007 April 23}

Implemented a ``{\tt checkSecure}'' JavaScript function which validates
that the current page has been invoked with an ``{\tt https:}'' URL and,
if not, pops up an alert warning the user of the possible security risk.
This is currently used only on the login pages; it may be extended to
other pages if a justification for such paranoia can be ginned up.  The
check is brutally suppressed when testing development versions on
Server0.

\date{2007 April 24}

Removed the explicit ``{\tt http:}'' on the URLs used to reference
the logo images in the heading of CGI result pages.  When the application
is invoked from an ``{\tt https:}'' URL, Exploder complains about ``mixed
secure and insecure data'' if any content on the page is included
with a non-HTTPS URL.

A nonzero variance less than 0.1 units would display as ``$0.0$'' or
``$-0.0$'' in red or green.  I modified it so that any variance
which shows as 0.0 will always appear in blank.  Further, variances
were not right justified in the monthly log column, so variances
without a sign did not line up properly; they're right justified now.

The synthetic data generator fell flat on its face when attempting to
generate data for a month not already present in the database.  I added
logic to create new months not present in the cache as data generation
proceeds.

\date{2007 April 25}

Implemented read-only logins to demonstration accounts.  An account must be
marked as read-only in the {\tt user} object to be accessed this way.  If
so marked, users can log in with a blank password, creating a non-exclusive
read-only session.  All operations which modify the database are silently
ignored when logged in read-only, allowing the visitor to go through the
motions without actually changing anything.

Added column headings to the administrator account manager table.

Brain damaged Exploder does not understand a link wrapped around an
input button---it lets you press the button but does precisely nothing.
I converted the ``Exit'' buttons in the administrator and public user
browse notifications to little forms wrapped around input items which
Exploder appears able to comprehend.

The XML DTD and stylesheet specifications require an absolute URL, which
was broken by our going to relative URLs in the interest of transparent
support for HTTPS\@.  I added explicit, fully qualified, URLs for these
items.

\date{2007 April 26}

The trend analysis form labeled both the starting and ending
custom dates as ``From''---fixed.

\date{2007 April 29}

The exercise rung field was missing from Excel CSV export files---fixed.

Added display of the user's real name to the ``Send Feedback'' form.  It is
displayed in the form used by most E-mail clients, with the full name
first and the E-mail address in angle brackets.

Added body mass calculation and display to historical charts.  As with
monthly charts, the body mass index is calculated only if the height is
specified.

The diet calculator could not be displayed when browsing a public account
because I forgot to explicitly allow the transaction in
\verb+%browsing_user_requests+.  I added it, along with logic to
remove the action buttons from the diet calculator when displayed by
a browsing user.  (They wouldn't do any harm due to the transaction
filtering, but there's no reason to confuse the user by showing them.)

Announced the opening of the
\href{http://www.fourmilab.ch/fourmilog/archives/2007-04/000833.html}{
beta test
}
program.

\date{2007 April 30}

An undefined variable warning was issued the first time the feedback
form was displayed due to a typo in the test for whether a category was
already specified---fixed.

Added a ``Browser'' header line to feedback E-mail sent to the
feedback address (but not the copy sent back to the user, to
avoid confusion).  Since we're likely to get reports of browser-specific
problems, this identifies the browser (from the ``\verb+HTTP_USER_AGENT+''
environment variable, if present) in case the sender omits this detail.

Plotting of a ``flat-line'' diet plan in a monthly log failed to convert
the kilogram quantity from the {\tt user} object into the display unit
for the chart---fixed.   (Reported by Rob Campbell.)

Further, when the log and display unit differed, the trend carry-forward
(which is kept in the log unit) was not converted to the display unit,
resulting in a vertical scale which squashed the actual data into a
small part of the vertical extent---fixed.

Changed the link on ``The Hacker's Diet {\em Online}'' in the centre
of the title to point to the Online documentation, not the main page
for the book, which is already linked to the title page logo in the
right part of the title.  (Reported by Rob Campbell.)

When displaying a log for other than the current month, the ``Log'' item
in the navigation bar was highlighted and disabled, which prevented it
from being clicked to display the current month.  I added logic to
test whether the current month is displayed (this, as the handling of
the ``{\tt now}'' month specification, is presently based on UTC and
needs to be reviewed with regard to {\tt tzoffset}).  If the month
displayed is not the current month, the ``Log'' item may now be
clicked to jump to the current month.  (Reported by Rob Campbell.)

\date{2007 May 1}

Added display of both the log and display weight unit to the Account Manager
form.  The ``Weight'' column now shows ``{\em log}/{\em display}''.

Added a little JavaScript glue to make it less likely new users will accidentally
set the log and display units to different values.  When setting the log or
display weight unit in the new account form (but not the edit settings form
for an existing account), checking a radio button in either group will set
the corresponding button in the other group unless it has already been
explicitly set.

Added a dynamically updated build number and build time and date to the
{\tt Makefile}, which is included in the ``Utilities'' page in Beta Test
mode and always in feedback messages.  This identified the version to the
tester and the version which sent a feedback report.

\date{2007 May 2}

The \verb+get_selected_date+ JavaScript function ran afoul of another
eccentricity of ``Internet Exploder'' (both 6 and 7).  All reasonable
browsers interpret the {\tt value} field of an {\tt Option} object
within a selection field as the value which will be sent to the
server when the value is selected, regardless of whether it was
specified as the text within the {\tt option} tag or as a
{\tt value=} attribute within the tag itself.  But not Exploder---if
you specify the value by the text within the tags, the {\tt value} property
is blank; you have to use the {\tt text} property to obtain the
value.  This resulted in changes to the diet calculator causing the
year within the start and end dates to warp back to 1900.  I
modified the function to use the {\tt text} property (which, thankfully,
also works in Firefox and Opera.  (Reported by Robert Ewing.)

Changed the background of the monthly and historical charts to
``{\tt rgb(160, 160, 160)}'' to make the green float/sinker lines
stand out better against the background.  (Reported by Bruce Lokeinsky.)

The check for whether the domain name in an E-mail address was valid
tested whether the domain could be resolved to an A record, which
caused mail-relay-only domains, which have one or more MX record but
no A records, to fail.  I created a new {\tt validMailDomain} function
which uses {\tt dig} to query the domain for MX records, filters the
result, and returns Boolean {\tt true} if the domain has one or more valid MX
records.  The validation of E-mail addresses in both new account
creation and modification of an existing account now call this
function to verify domain in the E-mail address.  (Reported by Joshua
Carpoff.)

If a transaction request which assumes an active session was sent with
no session identifier at all, a harmless ``uninitialised variable'' warning
was issued.  I fixed it to set the session ID to the null string in
this case.  The invalid session warning will continue to appear
in the HTTP error log, but the Perl warnings which preceded it
have now been banished.

The state of the ``Send me a copy of the feedback message'' check box
was lost when a preview of a feedback message in progress was displayed.
I fixed it to preserve the state and check the button if it was
checked in the sending transaction.  (Reported by Robert Ewing.)

Added the user's full name (if entered) to the feedback message sent
to the designated feedback address.  This allows giving credit for
feedback message without looking up the user's full name in the
Account Manager page.

\date{2007 May 3}

Added a message to the sign in page, conditional on ``Beta Test'', that provides a
link to the development Web log.

Fixed an error in displaying the user name in a feedback message which
caused it to be concatenated with the ``From'' line.

The Opera browser and some intermediate Web cache servers appear to
ignore our specification of an HTTP header item of ``{\tt
Cache-Control: private}'' for all dynamically-generated documents.  In
particular the ``stateless'' chart images embedded in the monthly log
and chart workshop pages, purely on the basis that the
URL is identical, are served an obsolete image from the cache rather than
requesting an image from the server which would reflect changes to the
database made of late.  OK, you want a different URL?  Here's a different
URL!  On all of the embedded image URLs, I have added a ``cachebuster''
argument which is a pseudorandom value with no function other than
ensuring each image request URL is unique.  This definitely fixes the
cache problem with Opera, which was consistently reproducible; we'll
have to see it if is equally successful with other rogue caches which
ignore the {\tt Cache-Control} directive.  (Reported by Robert Ewing.)

\date{2007 May 4}

If the calorie balance and desired weight change in the diet calculator
page had different signs, the ``{\bf End date}'' in the form would
display ``{\em Never}'' in the JavaScript code, but if the user pressed
the ``Save'' button, it would inanely show an end date before the
start date.  I added code to the diet calculator form generation to
preset the display modes of the ``{\bf End date}'' based on whether it
is before or after the start date.  Moving the mouse over a ``{\em Never}''
end date will open a date entry field---you still should be able to adjust
the calorie balance to achieve a goal date even if the previous
specification went in the wrong direction.  (Reported by Robert Ewing.)

The initial chart displayed by the Chart Workshop was $800\times 600$
pixels but the default selection for the ``Chart size'' item was
$640\times 480$, so if you just pressed the ``Update'' button without
changing any of the selections, the chart displayed would shrink.
Even more jarring, in a $800\times 600$ chart with the default interval of
one quarter, daily weights can be plotted as floats and sinkers, but at
$640\times 480$ they don't fit, so the grey line format is used.  I
changed the initial selection to $800\times 600$ to agree with the
default on initial display of the page.

If a user entered a weight entry on a monthly log in which there was
no trend-carry forward (i.e. the first log in the database), which
thus defined the trend as starting with the first weight entered,
then entered subsequent weights, and finally went back and deleted
the first weight in the log, the trend was not redefined as starting with
what has then become the first weight in the log.  This problem refers
exclusively to the JavaScript live update code---once the log was saved
in the database, the trend would be computed and displayed correctly.
I modified the trend re-propagation code in the {\tt changeWeight}
function to ``propagate'' a blank trend downward until the first
nonblank weight is encountered, then define the trend as starting at
that value.  (Reported by Robert Ewing.)

When importing Excel CSV records, records which were not imported because
they would overwrite records already in the database (when the ``Overwrite''
box is not checked) were handled as if they didn't parse and were passed
down the chain to the Palm and native CSV import parsers.  I added a flag to
indicate a record was rejected due to a conflict with preexisting
data which prevents this from happening.

\date{2007 May 5}

Excel CSV records with a blank or zero specification for the Flag
field resulted in an ``{\tt Argument "" isn't numeric}'' warning
because missing values were set to the null string instead of {\tt
undef}---fixed.

Unified the cached log retrieval code in Excel CSV, Palm/{\tt hdread} CSV, and XML
import.

Commented out the ``{\tt Barfel}'' and ``{\tt Garfel}'' debug code in CSV
and XML import parsers.

Uploading of CSV files with embedded ISO 8859-1 characters failed because
standard input was put into UTF-8 mode prior to reading the POST data
for the transaction request.  I modified the CGI argument processor to
check for the string ``{\tt enc=raw}'' in the \verb+QUERY_STRING+
argument.  If present, the POST arguments are read in ``{\tt raw}''
mode, bypassing the UTF-8 input decoder.  Note that one can specify
a query string on a URL even if it is a form submission with multipart
arguments in POST format.

Integrated the {\tt bump} utility, used to increment the build number
each time {\tt hdiet.w} is extracted, into the main program web.

\date{2007 May 6}

Fixed a misplaced colon in the ``Read only'' item in the
{\tt session::describe} method.

Added check boxes to the bottom of the monthly log in administrator
mode to dump the {\tt user} and {\tt session} objects as well
as the {\tt monthlog} object.

Added the ability for the administrator to dump objects from the monthly
log form when accessing another user's account as well as within
the administrator's own account.

Performed HTML quoting on the object dumps performed from the monthly
log form.  Added a ``{\tt unicode-bidi: bidi-override;}'' CSS
style specification to the \verb+<pre>+ block which encloses the
object dumps so that right to left text does not befuddle the browser's
layout of the object dump.  A new {\tt html::quoteHTMLFile} function
is used to quote the object dumps, which are written to intermediate
temporary files.

Improved formatting of the {\tt describe} method output for the
{\tt monthlog} and {\tt user} objects.  These previously had some long
lines which are now wrapped.

\date{2007 May 7}

A user who entered monthly log data infrequently could receive a
warning from the JavaScript code, which considered a difference of
$\pm 6$\% between the weight entry and the current trend value
indicative of a possible error in the weight.  With infrequently
entered weights, the trend update falls behind, which can lead to
warnings for legitimate weight entries.  Now, the first thing to note
here is that this is just a warning---the user can accept the entered
weight value simply by clicking ``OK''.  Secondly, {\em The Hacker's
Diet} encourages readers to record their weight daily if possible, not
at infrequent intervals, because the more frequent the weight
measurements, the more closely the trend will reflect the actual
smoothed weight.  I modified the plausibility check for weight entries
in {\tt hdiet.js} to first test for a discrepancy between the entry
and the trend as before.  If this indicates a possible error, we now
look for a previous weight entry in this month and, if one is present,
use that instead of the trend to compute the variance (since a
previous weight entry can be presumed to either be in range or to have
been previously confirmed as correct by the user).  If no previous
entry has been made for this month, we extrapolate the trend as having
been evolved by a linear change from the trend at the start of the
month to the weight entered, then compare the weight entered against
that simulated trend value.  (Reported by Lorenzo Emilitri.)

\date{2007 May 8}

If the diet plan was outside the date range plotted in an historical
chart and consequently reported $-1$ for the plan weight, it was
still used to scale the weight axis in historical charts, squashing
all of the weight entries toward the top of the chart.  I modified the
automatic scaling in {\tt history::drawChart} to ignore these out of
domain values and only include diet calculator values in the scale
computation if they actually contribute data to be plotted in the
chart.  (Reported by Lorenzo Emilitri.)

\date{2007 May 9}

Deleted numerous long-commented-out diagnostic messages to {\tt STDERR}.

Calculation of trend analysis for the caption of historical charts
was incorrect for periods with sparse weight entries.  Instead of
replicating the trend for days without weight entries as
{\tt history::analyseTrend} does, the chart generator only released
trend values to {\tt addPoint} for days which had weight entries.
Since the trend fitter assumes continuous data points, this
resulted in a gross overestimate of the slope of the data, resulting
in inflated weight and energy balance values in the chart caption.
I modified the {\tt history::getDays} function to fill in trend values
for days with no weight entry as {\tt analyseTrend} does.  Values
in chart captions now agree with those calculated by the trend
analysis page for equivalent intervals.  (Reported by Lorenzo Emilitri.)

Added code to process the \verb+HDiet_tzoffset+ variable set by
the JavaScript code to the user's local timezone offset with
GMT.  This code sets variables at the transaction global level which
contain the local time (in Unix time format), and the civil wall
clock time at the user's site.  All direct links between pages now
propagate this variable along with the session ID, so that any
page which requires it should have access to this value.  Note that
if the user does not have JavaScript enabled or the has a ridiculous
time zone setting, \verb+HDiet_tzoffset+ will be set to ``{\tt unknown}''
and the local time variables will be set to UTC.

Changed all instances in which a UTC date was used to decide what to
display (for example, the current month's log immediately after a sign
in) to use the date in the user's time zone as determined above. This
fixes the problem where, for example, a log is displayed for the the
first day of a  month while, in the user's time zone, it is still the
last day of the previous month.  (Reported by Robert Ewing.)

\date{2007 May 10}

The {\tt countChange()} and {\tt leaveDocument()} functions in the
JavaScript code which warn a user about to navigate away from a
monthly log page with unsaved changes continued to issue the warning
if the user had reversed all the changes with the ``Reset'' button.
I added an ``{\tt onclick}'' event handler to the reset button which
resets the {\tt unsavedChanges} count to zero.

Created an icon for the dynamically generated pages in a new
{\tt winicon} directory and added a {\tt link} reference to it
in the standard XHTML header.

Changed the main Fourmilab logo in the page title from a GIF
image to the PNG used on the site home page.

\date{2007 May 11}

Added computation of the trend minimum, maximum, and mean values to
the {\tt trendfit} object, and display of these quantities for each of
the intervals in the Trend Analysis page.  (Suggested by Rob Campbell.)

The selection fields for custom intervals in the Trend Analysis and
Chart Workshop pages were preset to the first and last month in the
database, but the day in these items was always set to 1.  I modified
them to show the first and last days in the respective months.  I also
unified the code which generates these fields for the trend and chart
pages; it was almost identical before and is now common.

\date{2007 May 12}

The JavaScript {\tt updateVariance} function, which updates the
variance field when a weight entry is changed, had two problems.
First, it did not round the variance to the usual one decimal place
before deciding whether it was positive, negative, or zero;
consequently, it could consider a value which displayed as ``0.0'' as
signed and prefix a sign to the number.  Second, if the variance was
zero, it was displayed in red as opposed to black, as the CGI form
generation does.  Live variance updates from the JavaScript code are
supposed to display in colour according to their sign.  This works in
competently implemented browsers such as Firefox and Opera, but not in
Exploder. So far, I have not found any work-around to fix this, so, at
the moment, live updates to the variance will always display in black
in that regrettable browser.

A blank (as opposed to null) flag field in an Excel-format CSV import
resulted in an ``Argument isn't numeric'' warning.  I modified the
Excel CSV import code to treat all-blank flag fields as if they were
explicitly set to zero.

\date{2007 May 18}

Signs on variance items updated by the JavaScript code were always positive
for nonzero numbers because the sign editing code tested the absolute
value of the variance instead of the original signed quantity---fixed.
(Reported by Robert Ewing.)

\date{2007 May 23}

Integrated the CPAN {\tt Digest::Crc32} module as {\tt HDiet:::Digest::Crc32},
providing access to it without the need to install it on the host server.  This
will be used for validity checking of cookies.

\date{2007 May 30}

Added a summary line to the administrator account manager page which shows
the total number of accounts, how many of those accounts grant public
access, and what percent of accounts allow public access.

\date{2007 May 31}

The {\tt expandAbbreviatedWeight} JavaScript function failed with entries containing
leading or trailing spaces because the pattern matches which were intended
to elide them never stored the result back into the string variable---fixed.

Added logic to the JavaScript code to accept either a comma or period as the
decimal character in all contexts where decimal numbers are permitted: weight
entries in monthly logs, height in centimetres or inches in the account settings
page, and weight items in the diet calculator.

Modified {\tt monthlog::updateFromCGI} to accept either comma or period as
the decimal character in monthly log weight entries.

Modified the {\tt parseWeight} subroutine to accept either comma or period as
the decimal character.  This allows either decimal character to be used in
static updates to the diet calculator when JavaScript is disabled.

Added code to the parsing of height in centimetres and inches in CGI
account settings to accept either a comma or period as the decimal point
character.  This handles account setting changes when JavaScript is
disabled.

\date{2007 June 1}

Replaced the four separate instances of the {\tt in} function in the
persistent objects with calls on a new ``Read line from persistent object file''
macro, which generates a custom {\tt in} function for the object, taking
its name as a macro argument (for error messages).  The new {\tt in} function
has an optional second argument which supplies the default value to be
returned if end of file is encountered when attempting to read the field
from the stored object.  If no second argument is given, the function will
abort on end of file, as before.

Added a \verb+decimal_character+ field to the {\tt user} object.  This is
set to ``{\tt .}'' or ``{\tt ,}'' as the user's preference for the decimal
separator character.  A new {\tt localiseNumber} method within the {\tt user}
object edits a number in the same fashion as the {\tt canonicalNumber}
function, but uses the user's preferred decimal character if the value
contains decimal digits.

Modified the {\tt canonicalNumber} function in the JavaScript code to accept
an optional third argument which specifies the user's preferred decimal
separator character.  The separator is passed to the JavaScript code by a new
\verb+decimal_character+ hidden field in the account settings form, and used
by the dynamic update code for the centimetre and inch fields in the Height
settings item to display decimal values with the configured separator.

Modified the JavaScript {\tt expandAbbreviatedWeight} function to
handle abbreviated entries with commas as well as periods as decimal
characters.  A comma can be used in any context where a period was
used before, including by itself to copy the previous entry.

Added a hidden {\tt decimalCharacter} argument to the JavaScript {\tt editWeight}
and {\tt updateVariance} functions.  The variable is set from a hidden form
field ``{\tt dc}'', which is passed to forms which need to edit decimal
numbers (presently the Monthly Log and Diet Calculator pages).

When JavaScript was disabled, using more than one exercise rung abbreviation
in a row caused all but the first to be set to 1 because the abbreviation
was not stored back into the CGI arguments hash---fixed.

The exercise rung increment and decrement shortcuts (entering a plus or minus
sign in the rung field to specify a rung one greater or less than the
most recent entry) did not work when JavaScript was disabled---fixed.

Copying more than one previous comment in a monthly log when JavaScript was
disabled failed for all but the first copied item---fixed.

Added a test to {\tt validMailDomain} to handle domains with no {\tt MX} record
but which have a valid {\tt A} record.  This copes with ill-configured sites
which run a mail exchanger but do not have an {\tt MX} record pointing to
itself.

At this point, comma should be accepted as an alternative decimal separator
character to period in all contexts in which numbers with decimal places
are entered, and the ``Decimal character'' setting should affect the editing
of all numbers displayed on user pages.  The closes the feature request by
Jens Peter Bork for this item.  Note that numbers in exported CSV and XML
files always use period as decimal separator, and files imported must be
in this format.

\date{2007 June 5}

Added a new {\tt handheld} field to the session object.  This will be
set if the user specifies that the session is being conducted from a
handheld device such as a PDA or mobile telephone.

Added columns to the Session Manager form to indicate whether a session
is read-only or from a handheld device.

\date{2007 June 10}

Importing Excel CSV records with four-digit year fields failed because
the test for two-digit years greater than 88 failed to also verify
that the year was less than 100.  Consequently a year of, say, 2006
would be deemed a specification of year 3906, which would be rejected
by the sanity check.  I rewrote the test for two-digit years and, in
the process, simplified the code.  I also made the Excel CSV
diagnostic code, which previously had to be commented on or off,
conditional on a new \verb+$excelCSVdebug+ variable, so simply
changing this variable enables or disables all of the diagnostic
output.  (Reported by Jennie Koffman.)

\date{2007 June 11}

Added a ``Handheld device'' check box to the login form which, if checked,
opens a session with the {\tt handheld} attribute in the session object
set.  The state of this box is not in any way persistent across failed
login attempt or other misadventures---this can be tweaked as the handheld
support matures.  It should be integrated with our ``{\tt handheld=y}''
query string plans for direct access to a special handheld login form.

If handheld mode is set, the chart in the monthly log defaults to $320\times 240$
pixels as opposed to twice that in each dimension for a regular desktop display.

\date{2007 June 12}

Implemented a ``handheld=y'' query string option on the login page.  If
this is set, the ``Handheld device'' checkbox is preset and the login
form will be reformatted for a small handheld screen.  Either this special
string (intended to be set in a stored URL) or the \verb+HDiet_handheld+
form variable will trigger this mode, so it will persist on subsequent
forms for failed login attempts.

Added a \verb+$handheld+ argument to \verb+write_XHTML_prologue+ which
generates a streamlined prologue and links to the lightweight
\verb+hdiet_handheld.css+ style sheet instead of the massive
style sheet for regular screen presentation.

\date{2007 June 13}

If the historical chart size was set to $320\times 200$ the actual chart
would be $320\times 320$ due to an incorrect test in the chart size
sanity check---fixed.

When the width of an historical chart was set to less than 480 pixels,
the first line of the caption was truncated.  I added an abbreviated
caption which is generated in this case.  The body mass index caption
barely fits, but there's no reason to abbreviate further unless we allow
charts less than 320 pixels wide.

Changed the smallest historical chart size to $320\times 240$.  With the
caption at the bottom, this leaves more room for the actual chart.

\date{2007 June 15}

Added a ``Remember me'' checkbox to the login form.  This is persistent
across failed login attempts.

Fixed permissions on {\tt HDiet/Digest/Crc32.pm} which caused it not
to be found when installed on the server.

Added a {\tt cookie} field to the {\tt session} object to record if
this session was initiated by a cookie login.  The status of this
field is shown in a new column in the Session Manager.

Added a \verb+jd_to_old_cookie_date+ function to the {\tt Julian}
package which converts a Julian day to the eccentric date and time
format used in old-style HTTP cookies.  I also added an export for
the \verb+jd_to_RFC_3339_date+ function which has been accidentally
omitted.

\date{2007 June 16}

Added an option to the Monthly Log form when viewed with administrative
privilege to dump the CGI arguments and environment string used to invoke
the form.

\date{2007 June 18}

Added fields to the login history record to indicate whether the session
is on a handheld device and if the login was done via a cookie.

The initial implementation of ``Remember me'' is now in place.  The
sign in form now includes a checkbox which selects ``Remember me'' mode, which
(unless the user is logging into a read-only account), drops a cookie
in the user's browser and stores a corresponding token in the
``{\tt RememberMe}'' directory which records the user name, time of
creation, and time of expiry.  When about to display the sign in form, we
check whether the browser sent a persistent login cookie.  If so, and
a token is stored with its code, we automatically sign in the user and
proceed to the monthly log page without the need to enter a user name
or password.  When a sign in via cookie is performed, the cookie used
is revoked and a new cookie is assigned.  Thus, only the most recently
cookie is valid; a previously intercepted and stored cookie is useless.

A sign out takes the user to a sign in page via a special ``{\tt newlogin}''
transaction which bypasses the automatic cookie login.  This allows the
user to uncheck ``Remember me'' and revoke the cookie (for this browser).

When logged in via a cookie, the ``Settings'' page is inaccessible.  This
keeps a user who somehow manages to hijack a cookie from changing the user's
password or disclosing identity information.  A user who has logged in with a
cookie can log out, log back in with their user name and password, and then
access the settings page.

A new ``Forget persistent logins'' item in the Utilities page permits
a user to delete all stored ``Remember me'' tokens.  This will invalidate
all cookies stored in browsers for this user.

A new administrator ``Manage persistent logins'' page shows all
persistent login tokens.  The administrator can delete any persistent
login token by checking it and pressing the ``Delete'' button,
specifying the administrator's password.

\date{2007 June 20}

Revised the {\tt dist} target in the {\tt Makefile} to Bowdlerise
the source distribution and rebuild all derivative files from it.
The PDF is now properly generated after running \LaTeX\ to build
the cross-references for the Bowdlerisied edition.  We still need
to verify that the complete application can be rebuilt in all
circumstances from the files in the source distribution.

\date{2007 June 21}

Made display of the build number not conditional upon beta test mode.
The item is sufficiently unobtrusive at the bottom of the utilities
menu page and useful to knowledgeable folks checking for changes
that it's worth leaving on in production.

\date{2007 June 22}

The {\tt monthlog::updateFromCGI} method referenced undefined rung
CGI variables when called from a form in which some or all of the rung
fields were non-edit fields (as in a read-only or printer-friendly
log page)---fixed.

Added ``Printer friendly'' and ``Monochrome'' checkboxes to the monthly
log page.  These set ``{\tt print}'' and ``{\tt mono}'' CGI arguments
which are propagated to navigation links and the embedded chart.  These
choose CSS classes which re-format the monthly log for a printer and, if set,
monochrome output.  In printer friendly mode, the monthly log table is
a non-editable static table with collapsed borders.

\date{2007 June 23}

Modified sorting of items in the administrator account, session, and persistent
login manager forms to be case-insensitive (or at least follow the order which
the Perl {\tt lc()} function produces).

The {\tt monthlog::updateFromCGI} method would clear existing flag and comment
items when processing a log in which the edit fields were not defined
(for example, one with protected days or a printer-friendly table).  I
modified the code to skip all updates if the day's rung or comment field
was not defined in the CGI arguments.

Added ``Printer friendly'' and ``Monochrome'' checkboxes to the Chart
Workshop and passed them on to {\tt history::drawChart} to apply those
modes to the historical chart.

Wrapped the ``Custom'' radio button in the Chart Workshop and Trend
Analysis pages in a \verb+<label>+ tag with its label.  This allows
clicking the label as well as the button and assists non-visual
browsers in identifying the control.

Added \verb+<label>+ tags to the radio buttons in the Export Log Database
form.

Added \verb+<label>+ wrappers to the administrator object dump checkboxes
at the bottom of the Monthly Log form.

\date{2007 June 25}

Replaced the two separate instances of generation of the ``cachebuster''
argument for embedded monthly log and historical charts with a common
macro and added documentation as to why it is needed.

\date{2007 June 28}

Made the feedback form not conditional upon beta test (but left
the test in the code, commented out).  We'll leave the feedback form in
for the nonce as we transition from beta to production.

Built a test version with beta test set to zero.

Changed working version number to 1.0 for production release.

\date{2007 June 30}

A Palm Eat Watch CSV record which included leading or trailing spaces
in the Date, Weight, Rung, or Flag fields would be ignored or, in the
case of the Flag field, interpreted incorrectly.  I added code to discard
all white space in these fields, as none should be present.  (Reported by
Reed Lipman.)

\date{2007 July 1}

Added code to disallow browsing of publicly-visible account by users logged
into read-only demonstration accounts.  This restricts access to public accounts
to those users who have gone to the trouble of creating an account of their own.
This is enforced not only by removing the ``Browse public user accounts'' item
from the Utilities menu for read-only accounts, but also aborting transactions
ginned up from a read-only login with the transaction codes for public account
access.

\date{2007 July 2}

When creating a new monthly log, the code which fills in the trend
carry-forward from the last trend value in the most recent existing
log failed to convert the trend value from the log unit of that log
to the log unit of the new one.  This resulted in wild variances if
a user changed the log unit and then entered data in a new log.  I
added unit conversion for this case, which was already handled
correctly for the case of complete recalculation of trend carry-forwards
(and hence can be used to correct any existing problems due to this
bug).  (Reported by Eric Carr.)

History records for CSV/XML import transactions were not being generated
because the test for a read-only session was backwards---fixed.

\date{2007 July 21}

Completed implementation and began production test of cluster file
system synchronisation support for server farm architectures such as
Fourmilab's.  Cluster support is implemented in the new {\tt Cluster}
module, through functions such as {\tt clusterCopy},
{\tt clusterDelete}, {\tt clusterMkdir}, etc.  When a database file
or directory is modified, immediately after the modification is made,
(for example, after the {\tt close()} when writing back a file),
the corresponding cluster function is called with the full path
name of the modified file.  This then calls {\tt enqueueClusterTransaction}
with the specified operation and path name, which creates one or more
synchronisation transaction files in the {\tt ClusterSync}
directory, within subdirectories bearing the names of the servers
defined in ``Cluster Member Hosts''.  (Transactions are never queued
for the server executing the transaction, nor for servers named as
cluster members for which no server subdirectory exists.  This allows
you to have identical directory structures on all servers, or to
exercise fine-grained control over which servers are updated
automaticallly [for example, if you wish to reserve one server
for testing new releases and not have changes made on it propagated
back to the production server]).

Synchronisation transaction files are named with the current date and
time to the microsecond, a journal sequence number which is incremented
for each transaction generated during a given execution of the CGI
application (to preserve transaction order in case the time does not
advance between two consecutive transactions), and for easy examination
of the synchronisation directory, the operation and path name, the latter
with slashes translated to underscores.  The contents of the transaction
file is a version number, the operation, and the full path name.

Actual synchronisation is accomplished by a separate, stand-alone
program, {\tt ClusterSync.pl}, which runs under group and user
{\tt apache}, which is the owner of the {\tt ClusterSync}
transaction directory and its contents.  This program is started
automatically from the {\tt init} script and runs as a daemon,
saving its process ID in a {\tt ClusterSync.pid} file in the
{\tt ClusterSync} directory.

When a synchronisation transaction is queued, the CGI program
sends a {\tt SIGUSR1} signal to the {\tt ClusterSync.pl}
process, which then traverses the server subdirectories, sorting
the transactions into time and journal number order, and
attempts to perform the operations they request.  Synchronisation
operations are performed by executing {\tt scp} and {\tt ssh}
commands directed at the designated cluster host, which must
be configured to permit public key access by user {\tt apache}
without a password.  If the synchronisation operation fails
with a status indicating that the destination host is down or
unreachable, the host is placed in a \verb+%failed_hosts+
hash with a timeout value of ten minutes from the time
of failure.  Synchronisation operations for that host will
not be attempted until the timeout has expired, which prevents
flailing away in vain trying to contact a down host over and
over, possibly delaying synchronisation of other cluster
members which are accessible.  In the absence of a signal
indicating newly-queued transactions, {\tt ClusterSync.pl}
sweeps the transaction directory every five minutes to check
for transactions queued for failed hosts which should now be
retried due to expiry of the timeout.

All of the directory names, signal, and timeout values given
above are specified by items in the ``Host System Properties''
section of the configuration; I have given the default settings,
which should be suitable in most circumstances.

You can check whether two cluster hosts are synchronised
by logging into one host, say {\tt server1}, and then running
a command like:

\begin{verbatim}
    rdist -overify -P /usr/bin/ssh -c /server/pub/hackdiet \
        server0:/server/pub/hackdiet
\end{verbatim}

This will report any discrepancies between the database directory
trees on the two servers.  If the servers are synchronised, you
should see only a ``need to update'' message for the
{\tt ClusterSync/ClusterSync.pid}, plus any synchronisation
transactions queued for failed servers awaiting retry.  This
operation is non-destructive and requires only read access to
the database directory.

\date{2007 July 22}

Added date and time to the first line of the log items written to
standard output by {\tt ClusterSync.pl} when \verb+$verbose+ is
set and set standard output to ``autoflush'' mode so log items
are written immediately regardless of redirection.

Added configuration parameters which allow {\tt ClusterSync.pl},
if started as super-user, to change to a designated group and user
identity.  Running a Perl program under an assumed identity turns on
the ``taint'' mechanism, so input from the transaction directory
and the files within it is sanitised before being used in potentially
dangerous ways (even though it should, in fact, only be coming from
the CGI application, never the ``outside'').

\date{2007 July 23}

Added much more stringent validation to {\tt ClusterSync.pl}
transaction processing.  Every file name submitted must begin
with the ``Database Directory'' path name, and may not contain
abusive (shell-interpreted) characters or sequences such as
``{\tt ..}''.  In addition, all input from transaction files is
single quoted when used on {\tt system()} commands to prevent
attack by overlooked shell escapes.  Finally, an invalid transaction
type in a transaction file causes an immediate abort.  Now, since
we're basically using the transaction directory as an interprocess
communication channel, this might be deemed paranoia, but
``you can't be too careful''.  Besides, one can imagine an attack
where somebody manages to hijack another CGI application and
trick it into adding bogus transactions to the directory
which cause {\tt ClusterSync} to do its dirty work for it.

Added an SHA1 signature as an additional line in cluster
synchronisation transaction files.  This signature incorporates the
content of the transaction as well as our site-secret ``Confirmation
signature encoding suffix'', without which it is unlikely in the
extreme an attacker will be able to spoof transactions.  Signature
failure crashes {\tt ClusterSync}, alerting the administrator that
something untoward is underway and thwarting an attacker who
contemplates a brute-force search for the suffix.

\date{2007 July 24}

If a log had an unspecified trend carry-forward and the previous
log in the database was present but had no weight entries
whatsoever, ``Fill in trend carry-forward from most recent
previous log, if required'' would hang in a CPU loop due to a
backwards-coded loop termination test.  If there were any log
entries, the loop would bail out due to a {\tt last}, but for
an empty log the termination when the beginning of the log was
reached would never occur and the program would crash when the CGI
time limit expired.  I corrected the loop termination test and
verified that the hang no longer occurs for a blank previous
log.  (Reported by Andres Kievsky.)

Added a handler for the {\tt INT} signal which, when received,
prints a stack trace to {\tt STDERR} (which will thus appear in the
HTTP server error log) and terminates.  This simplifies the task
of debugging CPU hang or other problems which lead to a CGI program
timeout and the resulting 500 response to the requester.

The ``Julian date constant definitions'' macro had an incorrect
name.  Its name had accidentally been left the same as the
support functions macro, which worked fine since the references
to the two macros are consecutive.  I corrected the name to get rid
of a harmless warning message.

Modified the {\tt Makefile} {\tt publish} and {\tt production} targets
to install the cluster synchronisation program as an executable
named {\tt ClusterSync} in the {\tt server}{\em n}{\tt /bin/hackdiet}
directory.  This allows it to work without modification with our
standard {\tt /server/init} mechanism, in particular a new
{\tt /server/init/hackdiet} script which starts and stops the
cluster synchronisation process.

Moved the process ID file for the cluster synchronisation process to
{\tt /server/run/ClusterSync/ClusterSync.pid} to conform with our
standard structure in the {\tt /server} partition.

Implemented a proper log file for {\tt ClusterSync.pl}.  The full
path name for the log file is configured with ``Cluster Synchronisation Log File''.
If the null string, logging is disabled.  Otherwise, the specified file is
opened for appending, and items are appended for each transaction.  When
logging is active, the program listens for the {\tt HUP} signal and,
upon receiving it, closes and re-opens the log file to permit it to be
rotated by renaming it and then sending the signal.  The format of the
log file identical to the information written to {\tt STDOUT} when
\verb+$verbose+ is nonzero.  The default location for the log file is
{\tt /server/log/hackdiet/ClusterSync.log}.

\date{2007 July 25}

Replaced all of the parallel calls in {\tt ClusterSync.pl} to write
output to standard output in verbose mode and to the log file when
logging with calls on a new {\tt logmsg} function which writes its
arguments to the appropriate destinations according to the global
option variables.

If the start or end date of a diet plan in the diet calculator were
outside the union of the range of years in the database and the
current year plus one, the start and/or end year of the diet plan
would not be included in the start and end date selection boxes,
resulting in an incorrect date appearing in the form.  This most often
manifested itself when a long-term diet extends past the end of the
year after the present.  I added logic to make sure that the range of
years included in the start and end date boxes includes
the least of the current year and the first year of the diet plan
minus one and the greatest of the next year and the last year of the
diet plan plus one.  (Reported by Jim Hollcraft.)

\date{2007 July 27}

Commented out the {\tt etime()} utility function which is presently
used nowhere.

Wrapped the checkboxes and labels for the ``Allow overwrite'' and
``List imported records'' options in the Import CSV/XML page and the
``Plot plan in chart'' item in the Diet Calculator with \verb+<label>+
containers so that the labels as well as the checkboxes can be
clicked.

{\em Arghhh!}  Perl 5.8 relies upon the underlying C library's {\tt
gmtime} function for the Perl {\tt gmtime} function.  This means that
on a 32-bit platform the Perl function is limited to dates between the
start of 1970 and ``doomsday'', 2038-01-19. (I understand that this
problem does not exist on native 64-bit platforms and will be fixed in
Perl 6.)  Even though we have some time to go until the tick of doom,
it is easily possible to generate dates beyond 2038 by entering small
calorie balance values in the diet calculator.  I added a new
\verb+Julian::unix_time_to_civil_date_time+ function which uses the
Julian day functions to convert a Unix {\tt time()} value to a list of
year, month, day of month, hour, minute, seconds (actual values, not
the crazy offsets returned by {\tt gmtime}, so this is not a drop-in
replacement).  I replaced all references to {\tt gmtime} in the
program to calls on \verb+unix_time_to_civil_date_time+, which
corrects the  original problem reported in the diet calculator.  There
are a few calls on {\tt localtime} left in the code, but these are all
in {\tt describe} methods for various objects (used only for
administrator debugging output, and all representing times close to
the present) and in the generation of log entries, which are also
obviously in the present.  Since these won't break for more than
thirty years, it's likely we'll be on a version of Perl with the
truncation fixed before then or, failing that, there's plenty of time
to fix them before the dawn of the dreaded day.  (Reported by Jim
Hollcraft.)

The JavaScript live update for the diet calculator rounded the diet
duration in weeks differently from the Perl code: JavaScript truncated
to the next lower integer, while Perl rounded to the nearest integer.
This could result in a one-week discrepancy in diet duration between the
value shown immediately and that which appeared after the user
saved the diet calculator results.  I modified the JavaScript code to
round the same way as the Perl code does.  (Reported by Jim Hollcraft.)

\date{2007 July 28}

Import of an XML database set the weight unit of the log only from the
{\tt log-unit} in the preferences, and did not allow the {\tt weight-unit}
in an individual monthly log (which might be different) to override the
default.  I added code to set the unit for a given month from its
own {\tt weight-unit}.  Note that logs created in the process of importing
CSV or XML data are always created using the user's current log unit
setting; the log unit in the data imported is used to convert weight
values (if necessary) from the unit in the imported log.

The synthetic listing generated for log items imported from an XML
file did not show decimal places due to an incorrect format code in
the {\tt sprintf} which generated the output.  (The records were
imported correctly; only the listing was affected.)  I fixed the
format code.

Added a new \verb+<decimal-character>+ container to the preferences
section of the XML output format whose content is the user's choice
for decimal separator character (period or comma).  Note that regardless
of this setting, decimal numbers within the XML file itself always
use period as the decimal separator.  Appropriate declarations for
this item were added to the XML Document Type Definition and CSS style
sheet of this {\tt DOCTYPE}.

Added a sixth field at the end of the ``{\tt Preferences}'' header
item in our native CSV export for the decimal character.  Natually,
this field will be quoted if the decimal character is set to comma.

When parsing the first (``{\tt Epoch}'') line of a native CSV database
import, two warning messages would be generated because this record
contains only two fields, while the code which deletes embedded blanks
for log entry records assumed all records to have four fields or
more.  I made each of these statements conditional upon the field's
being defined.

\date{2007 August 11}

Completed the initial implementation of the {\tt Aggregator} object, which
allows retrieval of log items in a specified date range across all
accounts, public accounts only, or a list of specific accounts.  This
will be used for application-wide statistics of various sorts.

\date{2007 August 14}

Added a ``Global Statistics'' report available for administrator
logins. The report summarises, for all accounts and public accounts
only, the number of open accounts, active and inactive accounts (with
an active account defined as one in a weight log entry has been made
in the last 30 days), the mean weight gain or loss across all active
accounts, users with the fastest rate of weight loss and gain, and a
histogram of the frequency with which users update their weight logs.

\date{2007 August 16}

The {\tt monthlog::updateFromCGI} method failed to clear flag fields
which the user had once checked and then subsequently unchecked.  This
was because the browser does not send CGI arguments for {\tt checkbox} fields
which are not checked, and the code was assuming these fields would be
sent, but with a null value.  I added code which tests, if a
flag field is not defined in the CGI arguments, whether the database
field for the flag is set and, if so, turns it off.  (Reported by
Michael Kiesel.)

\date{2007 August 17}

The diet calculator update code invoked when the user presses the
``Save'' button did not handle values in the Initial and Goal
weight fields with comma as the decimal character---fixed.

The diet calculator update code failed to round decimal values
specified in the Daily balance field to integral values of
calories or kilojoules, and also did not accept comma as the
decimal character---fixed.

Although daily energy balance figures in the diet calculator are intended
to be integral values of calories or kilojoules, we do, in fact, allow
the user to specify decimal values, which are rounded to integers when
displayed.  The JavaScript live update code accepted decimal values
in this field but did not accept entries with a comma as the decimal
character, parsing them as a NaN and wrecking all of the derived
values.  I added code to accept energy balance values with comma as
the decimal character.

The diet calculator static update performed when JavaScript is
disabled did not regenerate the table of years used in the selection
boxes for Start and End dates.  As a consequence, if the user adjusted
the calorie balance or other parameters which caused the end date to
extend to a year beyond the previous end year plus one, no year would
be selected in the End date box, defaulting to the first year in the
list.  I added a call to ``Generate array of years for diet calculator
selection'' at the completion of a static update in which one or more
fields were changed.

\date{2007 August 19}

Updated documentation for {\tt history::analyseTrend} to reflect the
addition of minimum, maximum, and mean values to the list of slopes
returned.

\date{2007 August 21}

Completed implementation of ``Web badges'', which allow users to display
their most recent weight log entry and the energy balance and rate of
gain/loss for a specified trend interval.  A new badge configuration page,
accessible from the main utility menu, allows enabling the badge and
selecting the trend interval, which is kept in a new \verb+badge_trend+
field in the {\tt user} object.  When this field is nonzero, any operation
which modifies a log entry calls {\tt history::drawBadgeImage} to update
the {\tt BadgeImage.png} file in the user's directory.  (This file is
swapped into place with a {\tt mv} command to avoid race conditions if
it is being retrieved at the time an update is in progress.)

The badge configuration page takes the user to a confirmation
page which, if badge generation is enabled, shows XHTML code the
user can copy and paste into a Web page to display the badge.  This
code invokes a new stand-alone lightweight CGI program named
{\tt HackDietBadge}, which is called with an opaque argument which
is the user file name of the owner of the badge salted and encrypted
with the application's master key using AES in CBC mode.  The
{\tt HackDietBadge} program is separate so as to avoid having to
load the full application and all of the modules it requires just
to display a badge image on a Web page which may be hit far more
frequently than full-fledged application transactions.  The
{\tt HackDietBadge} program decrypts and validates the
argument and, if all is well, copies the badge image for
the specified user to standard output hacing specified a
{\tt Content-type} of {\tt image/png}.  If the argument is
in error, or the specified user has disabled badge generation,
a canned ``Invalid request'' image is returned instead.

Badge generation mis-handled the case where the log unit and
display unit were set differently---fixed.

Eliminated a redundant ampersand in the URL submitted when the
``Configure Web page badge image'' item is clicked in the
Utilities menu.

Deleted a redundant definition of the array of labels for trend
analysis durations in the \verb+update_badge+ transaction
handler.

Added validation of term duration specifications in the
\verb+update_badge+ transaction handler.  If a user cobbles up a
URL with a bogus \verb+badge_term+ argument, it will be silently
converted into a disable badge selection.

Added newly-referenced CPAN modules to the list of library
modules we require in the documentation.  Each is linked
to its documentation on the CPAN site.

Modified the {\tt publish} and {\tt production} targets in
the {\tt Makefile} to install the executable Perl components
({\tt HackDiet}, {\tt HackDietBadge}, and {\tt ClusterSync})
by copying them to the destination directories with an
extension of {\tt .NEW} and then renaming them to the
destination name.  This avoids the possible race condition
when a request arrives while the file is being copied to the
server and the CGI process attempts to read the Perl program
before it has been entirely copied.  Note that we still have
a potential race condition for the modules in {\tt HDiet}, but
as these files are much smaller, the odds of encountering it
are much less than with the large main program.  I will eventually
change these to install with a copy and move strategy as well,
but that will require more work since they are installed with
a recursive copy rather than a simple file copy.

\date{2007 August 31}

If a user makes log entries in a month in the future (for example,
to add ``to do'' items in the comment field), the future month
would be assigned a trend carry-forward at the time it was created,
but the carry-forward would not be updated when weight entries
were made in the current month because trend propagation was
triggered only for entries in months prior to the ``current month''
in the user's time zone.  This was an example of the sinfulness
of premature optimisation---compared to the cost of updating the
chart for an entry in a monthly log, checking the user directory
for subsequent months, even if in the future, to which the trend
should be propagated is negligible.  I removed the unwarranted
``optimisation'' from ``Write updated log item back to database'',
causing a check for trend propagation to be performed for all
weight changes in monthly logs.  (Reported by Anna E. Sage.)

\date{2007 September 4}

The {\tt ClusterSync.pl} program could go into an infinite loop
if given a transaction which requested the deletion of a file
which was not present on the destination cluster host.  This
situation could occur due to race conditions in which a RememberMe
file was created and replaced almost instantaneously.  I added
code which detects this case and considers the deletion
transaction as having been completed successfully if the file
is found not to exist on the destination host.  The error handling
has been restructured to allow other such special cases to be handled
should they arise.

Corrected the description of the global statistics table section in
the {\tt hdiet.css} style sheet and removed a reference to a
nonexistent macro for synthetic data generation style definitions.

\date{2007 September 5}

Added a line to the Open Accounts summary in the Global Statistics
page which shows the number of accounts which have Web badge
generation enabled.

Propagation from an initial month in the database with no weight
entries to subsequent months would reference an undefined trend value
for the month.  I added code to set the trend carry-forward to zero in
this case, as a trend of zero is our indication that no trend
carry-forward exists.  Since the undefined trend value would be
treated as zero, this caused no problems but produced a warning
message in the error log.

Global statistics computation became confused when presented with
a user account which had a database entry for the first month in
the statistics computation interval (currently 30 days), but in
which the first weight entry was after the start of the interval.
The code which computes the user's trend slope would pass undefined
trend items to the fitter, generating a snowdrift of (otherwise
harmless) warning messages.  I added a test for undefined trend
values returned by the aggregator, which causes the coverage of
such users' logs to be deemed incomplete and thus excluded from the
summary trend analysis.

\date{2007 September 17}

Cluster synchronisation transaction files were written in UTF-8, but
{\tt ClusterSync.pl} failed to open them in this mode.  This caused
file names which contained ISO-8859 characters above the 7 bit ASCII
range which we do not escape to be misinterpreted when the transaction
was read, resulting in a signature verification failure for the
transaction.  I added a ``{\tt :utf8}'' specification to the open of
the transaction file so it will be read correctly.  I also set
{\tt STDOUT} to UTF-8 mode so that error messages are printed in
that mode.  The log file remains in ISO-8859 mode, as that will
handle all characters which we do not escape.

Cluster synchronisation could loop with a failed copy transaction
when, while processing a backlog of synchronisation transactions,
a copy transaction for a session ({\tt .hds}), active session
({\tt .hda}), or remember me ({\tt .hdr}) file was executed
after the file in question had been deleted at the close of the
session.  I added code, similar to the September 4 fix for deletion
transactions, which considers copy transactions which fail due to
nonexistence of the source file as having completed normally.

\date{2007 November 13}

If a user created one or more non-void monthly logs with no weight
entries (for example, containing only exercise rung and/or comment fields),
the administrator global statistics report would fail with a
division by zero when it attempted to compute the ``coverage'' of
the time period by weight log entries.  I modified
\verb+receive_aggregated_statistics_records+ to ignore returned
records with undefined weight fields, as only such records are relevant
to the global statistics.

\date{2007 November 17}

If an Excel-format CSV record contained a space before a single-digit
exercise rung field, the record would be skipped as not parsable. I
modified the test pattern to allow leading (but not trailing) spaces.
Records of this type are created by the Palm {\tt HDread} program when
a day has an exercise rung between 1 and 9 and the {\tt -o} option is
used to generate Excel-format CSV.  (Reported by \"Omer Ay.)

Historical chart generation with multiple days per pixel could report
different values for the trend analysis and flag fraction in the caption
depending upon the chart size (and hence the number of days aggregated
into each horizontal pixel).  This was because {\tt getDays} is not
guaranteed to examine every day in the interval, particularly in the case
of long intervals and small charts.  I added code to {\tt drawChart} in
{\tt history.pm} to call {\tt analyseTrend} for the entire interval to
perform the analysis and use the values it computes for the caption,
instead of those computed on the fly by {\tt getDays} which may depend
upon the chart scale.  (Reported by Jim Hollcraft.)

\date{2008 January 10}

Completed the implementation of a facility for generating and printing
paper log forms for people who wish to log offline and then transcribe
the data to the application later.  A new ``Print paper log forms''
item on the Utilities menu displays a form which allows the user to
select the first and last month and year (the form is preset to the
default of all months in the current year).  The current, previous, and
next years may be selected.  (If the user sets the end date before the
start date, they are silently swapped.)  When the ``Generate'' button
is pressed, a new window opens with the log document in it, and after
a one second delay to allow the page to render, a print command is
queued (these features require JavaScript to function; if it is absent,
the log document opens in the same window as the request form and the
user must print it manually and return to the application with the
``Back'' button).  A paged media style sheet is used to insert page breaks
so that each monthly log prints on its own page.

\date{2008 March 9}

Added code to set automatic buffer flush for the ClusterSync log file
when it is initially opened and cycled after receipt of the {\tt HUP}
signal.  This allows those who monitor the log file with, for example,
{\tt tail~-f} to see the complete log item for a transaction without
waiting for the buffer to be flushed.

When the cluster synchronisation log file was cycled after receipt of
a {\tt HUP} signal, the cycling was erroneously performed both in the
signal processing code and in the main loop code which responds to
the signal.  I removed the file cycling from the signal handler,
where it is vulnerable to race conditions within Perl and the underlying
C library.

Implemented recovery from transient and permanent cluster synchronisation
transaction failures.  Previously, if any error occurred reading, verifying, or
executing a cluster synchronisation transaction, the {\tt ClusterSync.pl}
program would crash, suspending cluster synchronisation until it was
restarted.  Unfortunately, there were a number of circumstances in which
such errors could occur, the most common being cases where a race condition
between queueing the transaction and {\tt ClusterSync}'s processing of it
caused an incomplete file to be read (transient), and those where a crash
of the process queueing the transaction caused an incomplete file to be
written to the transaction directory (persistent).

When a cluster sync transaction fails, for whatever reason, it is placed
into a failed transaction hash whose key is the transaction file name
and whose value is an array containing the number of times the
transaction has been tried and the next time the transaction
should be retried.  On subsequent passes through the transaction
directory, failed transactions are skipped unless their retry time
has arrived, whereupon they are retried and, if they fail, their
try count is incremented and the next attempt count updated.

If the transaction eventually succeeds, it is closed out normally
and removed from the failed transaction hash.  If the transaction
fails again, its try count is increment and if it has reached
the limit, the transaction is deleted from the transaction
directory and the failed transaction hash.  Failure to delete
the transaction from the transaction directory remains fatal to the
{\tt ClusterSync} program.

The intervals between retries of a failed transaction and the number of
failures which cause a transaction to be abandoned are set by configuration
parameters.

\date{2008 March 10}

Modified the cluster synchronisation log file generation to skip
the ``Results:'' line if the command produced no output.

\date{2008 June 3}

It was possible by using quoted fields to import a native mode CSV
file whose exercise rung field included embedded spaces.  This would
cause a native database file to be written which, when {\tt monthlog::load}
attempted to load it, would cause the parser to abort.  I added code to
{\tt monthlog::importCSV} to delete any spaces in an exercise rung
field.

To cope with existing database entries with spaces in exercise rung
fields, I added code to {\tt monthlog::load} to delete all spaces
from the record.  An entire database can be cleaned up by performing
a trend recalculation.  (Reported by Tom Gunter.)

\date{2009 January 15}

Updated configuration to accommodate the switch from Server1 to Server0
as the primary production server.  We now install test versions on Server1
and production versions on Server0, and permit non-{\tt https} logins to
Server1 without the security warning.

A change in the handling of the \verb+decode_utf8+ function between
Perl 5.8.5 and 5.8.8 broke decoding of CGI arguments containing
ISO-8859 and Unicode characters when received as POST arguments.
Whereas before we needed to read POST arguments with
``{\tt :utf8}'', now it appears we need to use ``{\tt :raw}''
unconditionally.  How much would you like to bet we'll be changing
this back somewhere down the road?

Added a ``Month'' option for Web badge generation.  This is
something intended from the start, but omitted due to
scatterbrained developer.  (Reported by Kees Huyser.)

\date{2009 February 8}

Due to race conditions (for example, processing cluster
synchronisation transactions while a global server synchronisation is
underway), it is possible for an {\tt mkdir} or {\tt rmdir}
transaction to fail because the directory in question already exists
or has already been removed.  To avoid a possible loop retrying such
transactions, I added tests for these cases which deem the transaction
successful if its intended effect has already taken place.

\date{2009 March 7}

When displaying the current (or most recent) monthly log, the trend
analysis displayed beneath the chart was based on the data plotted
in the chart.  At the start of a month, when there were only a few data
points, this could result in day-to-day instability in the trend
analysis.  I added code to test whether the most recent log is being
displayed and, if so, a trend for the last seven days is computed
using a {\tt history} object, even if that requires retrieving days from
the previous month.  This also ensures that the trend reported on
the monthly log page will always be identical to that shown for
the last week in the Trend Analysis page.

If only one weight was present in the most recent log and no entries
existed in the previous month's log for the preceding week, the
{\tt trendfit::fitSlope()} method would divide by zero because there
were insufficient points to fit a linear trend.  I added code to the
method which reports a zero trend slope when insufficient points are
available to fit a slope.  Note that while this was discovered testing
the new method of computing the trend for the current month, the bug
was present prior to the change.

\date{2009 April 18}

Added Server2 to the list of cluster member hosts.

\date{2009 August 8}

With more than 2500 public accounts, it takes almost forever for the
list of public accounts to load.  This is very irritating to people
who regularly check on their friends' progress.  What I'd like to do
is add the ability, when viewing a public account, to check a box to
make it (or remove it from being) a ``friend''.  In the Utilities page,
a drop-down list of friends will be displayed, from which you can select
a public account to access with a single click.  To address the immediate
problem, until I manage to put all of this machinery in place, I've added
a simple text box and ``View'' button below the ``Browse public user
accounts'' item in the Utilities menu.  The user can simply enter the name
of the public account in the text field and press the button to go directly
to the account.  This isn't as convenient as a list of friends, but it's a
lot better than waiting for the monster form to load.  The direct name access
form is also included in the Utilities page displayed when viewing a
public account, allowing direct transfer from one public account to
another.

\date{2010 March 31}

The error messages generated when the administrator attempts to purge the
logs or delete a nonexistent account name were missing a space before
the name of the account---fixed.

If the administrator attempted to access (view) a nonexistent account,
the application would exit with an error and yield a blank screen.
With the original account manager, this could happen only if the user
deleted the account between the time the list was displayed and when
the administrator attempted access, but with the direct access
facility, the error would occur whenever the administrator entered an
invalid account.  I added an explicit error message for this
circumstance which includes the invalid account name.

To expedite display of public accounts, I added a drop-down box to the
``Browse public user accounts'' item on the Utilities page which allows
the user to select active, inactive, or all accounts with active the
default.  An active account is defined as one with a transaction within
the last 30 days.  In addition, the user can switch between the display
of active, inactive, or all public accounts on the Browse Public Accounts
page.

Under Administrator Functions on the Utilities page, the administrator
may choose, when managing user accounts, to display active, inactive, or
all user accounts (as for public accounts, active means a transaction
within the last 30 days), and may switch selections from the Account
Manager page.  In addition, the administrator can access a user account
directly by name to view, purge logs, or delete.  For the latter two
functions, the administrator password must be entered as a confirmation
before the button is pressed.

When enumerating public accounts for the browse public accounts page, or
all user accounts, open sessions, or persistent login tokens for the
administrator, we unnecessarily sorted the names of the files in the
respective directories before retrieving them into the hash used to
build the displayed table.  Since the table generation code sorts the
hash keys, there is no need to sort the file names, which can be very
time consuming when these directories get large.  If these directories
get very much larger, it may make sense to read them serially and
perform the {\tt grep()} on them within the loop rather than bringing
the directory into memory and using the {\tt grep()} function as presently
done.

The {\tt cookie::storeCookie} and {\tt cookie:testCookiePresent} methods
failed to set UTF-8 mode when reading and writing the cookie token
file for persistent logins.  This caused warning messages when sorting
cookie user names in the administrator Persistent Login Manager page.
This change will force all users with non-ASCII login names to log back
in, as their cookies will not match those stored with the incorrect file
encoding.  As it happens, there were only two such and both were inactive
accounts, so I just purged the persistent logins for them myself.

\date{2011 July 27}

When generating a ``printer friendly'' monthly log display,
values in the ``Flag'' column were not encoded as {\tt hidden} items
in the result page.  If the user then did an update from this page,
all checked flags would be lost.  I added code to embed {\tt hidden}
items for checked flags, which will propagate them back on an update.
Note that due to the way we integrate the rung and flag fields on updates
there is no need to embed their values as hidden fields.  It's only due
to the odd design of HTML/CGI which doesn't allow you distinguish the
absence of an editable field from a check box not checked that we
require this work-around.  (Reported by user ``rhittom''.)

\date{2013 September 11}

If a user managed to create a diet plan in the Diet Calculator with
an energy balance of zero, {\tt user::dietPlanLimits} would divide by
zero when attempting to calculate the end date of the diet plan.
I modified the code to allow an energy balance of zero, permitting
specification of a maintenance weight with a start date and an
indeterminate end date.  (Reported by user ``obrienjay''.)

\date{2017 October 5}

Now that we're hosted on AWS, it isn't possible to directly install
development and production versions on local server farm directories
mounted with NFS.  I changed the definitions of ``Book Directory'',
``CGI Installation Directory'', and ``Executable Installation Directory''
to point to directories within a {\tt DEVELOPMENT} directory within
our build tree.  The ``{\tt publish}'' target in the {\tt Makefile}
will place files there.

Updated the definition of ``Cluster Member Hosts'' to be void, since
we no longer run ClusterSync on the AWS hosts and don't want to
clutter up the file system with an ever-growing cluster transaction
file.  This had already been applied as a patch to {\tt Cluster.pm}
on the AWS server, so this change brings the code generated from
{\tt hdiet.w} into sync with the production version.

In {\tt HDiet/Cgi/CGI.pm}, removed a test of {\tt defined()} on an
array which generates warnings on recent versions of Perl.  This had
already been patched on the AWS server, and is now integrated into
our build directory.

Fixed a regular expression in {\tt hdCSV.pm} which was generating
warnings whenever it was included.  In the latest versions of Perl,
braces within regular expressions must be escaped with a backslash.

Rebuilt everything with Nuweb 1.58, the current release.  No changes
were required to {\tt hdiet.w}.

Added a new {\tt Collect\_Hackdiet} shell script which, when run on
the AWS server, collects all of the components of the program
installed in various places into an {\tt INSTALLED.tar.xz} archive
which can be downloaded and unpacked for comparison with a new build.
The structure of the archive is identical to that created by a
{\tt make publish} to the {\tt DEVELOPMENT} directory.

Creation of the PDF file of the primate-readable version of the
program failed because the {\tt usepackage} of {\tt hyperref}
included the {\tt pdftex} option, which has now been removed.
I removed the option and the PDF now builds properly.

\date{2017 October 6}

The {\tt pubsrc} and {\tt prodsrc} targets in the {\tt Makefile} would
fail if the {\tt download} directory didn't exist in the target directory
or the subdirectory for the version number didn't exist.  I changed
the {\tt mkdir} to use the {\tt \-p} option to automatically create the
parent directories if they didn't already exist.

\date{2018 June 22}

Starting with Google Chrome version 65, the ability to set
cookies by using the HTML
``{\tt \verb+<+meta http-equiv="Set-Cookie}'' mechanism no longer
works---it is ignored and results in a deprecation warning and
``Blocked setting \ldots\ cookie'' error message on the debug
console.  I have no idea what motivated the pointy-heads to do
this, but given the present market share of this browser there's
no alternative but to bend to the will of our Silicon Valley
overlords.  (Reported by Sebastian Krause.)

I added a new configuration parameter, ``Set cookies with JavaScript''
which, if set, causes the ``{\tt HDiet}'' cookie for persistent
logins to be set by a Javascript ``{\tt document.cookie~=}''
assignment rather than the HTML {\tt meta} tag.  In
``Update persistent login state'', which is called when generating
the header of HTML result documents, if this parameter is true,
a JavaScript function definition, {\tt setCookie}, is pushed
onto a new array, {\tt @headerScripts}, instead of pushing
the {\tt meta} tag onto the {\tt @HTTP\_header} array.

In ``Write XHTML prologue'', if any lines have been pushed onto
{\tt @headerScripts}, they are transcribed into the document header
wrapped by an in-line \verb+<script>+ container.

In {\tt hdiet.js} function {\tt initialiseDocument()}, if the
{\tt setCookie()} function is defined, it is called to set
{\tt document.cookie}.  If the function is not defined, no harm
is done and no error or warning message is issued (this not only
handles the case where ``Remember me'' is not set, but also allows
the new version of the JavaScript file to be used with existing
code that uses the {\tt meta} tag).

\date{2018 June 23}

Confirmed that the {\tt INSTALLED} subdirectory in the
development tree is identical to the version in production on
the AWS server.

Note: if you do a ``{\tt make clean}'' and then run ``{\tt make
pdf}'' without ever having run ``{\tt make view}'', most of the
cross-references in the PDF file will be question marks.  I
think this is because the {\tt pdf} target fails to re-run
``{\tt nuweb hdiet}'' after the first run of {\tt latex}.  For
the moment, I'll just remember to view before building the PDF.

Backed up the following in-production files with a suffix of
{\tt \_2018-06-23}.

\begin{verbatim}
    ~/cgi/HackDiet
    ~/cgi/HDiet/html.pm
    ~/web/hackdiet/online/hdiet.js
\end{verbatim}

Validated the XHTML with the new JavaScript cookie setting code.  It
passed.

Installed the new code into production.  After flushing the
browser cache so the new JavaScript will be used, it seems to
work.

\date{2022 April 4}

The code that generates paper log files did not handle the case where
the request spans a year boundary.  I modified the code so the loop
correctly iterates through all months from the start to end in this
case.

\date{2022 April 5}

Modified {\tt Makefile.mkf} and \LaTeX\ code to build the
documentation with XeTeX, on which Fourmilab is standardising.
We do not presently use any of its Unicode functionality, but
moving to PDF-only output allows getting rid of all of the
complexity associated with generating both DVI and PDF and the
``\verb+%%%PDF%%%+'' kludge we used to handle hyperlinks.

Migration to XeTeX allowed using the ``{\tt -r}'' option on
{\tt nuweb} to automatically hyperlink page cross-references in the
document.

Added an explicit path specification to Perl command lines for the
``{\tt check}'' target, allowing it to be run in a development
directory without fiddling with the Perl search path.

Removed the {\tt publish} and {\tt production} targets from {\tt
Makefile.mkf}.  Now that we develop in a local environment with a
public repository on GitHub and deploy on cloud servers, targets that
directly install onto NFS-mounted server file systems are
anachronistic.  It's best to be rid of them lest they confuse the
uninitiated.

\end{document}
